(function(b){b.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",191:"/",224:"meta"},shiftNums:{"`":"~","1":"!","2":"@","3":"#","4":"$","5":"%","6":"^","7":"&","8":"*","9":"(","0":")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"}};function a(d){if(typeof d.data!=="string"){return}var c=d.handler,e=d.data.toLowerCase().split(" ");d.handler=function(n){if(this!==n.target&&(/textarea|select/i.test(n.target.nodeName)||n.target.type==="text")){return}var h=n.type!=="keypress"&&b.hotkeys.specialKeys[n.which],o=String.fromCharCode(n.which).toLowerCase(),k,m="",g={};if(n.altKey&&h!=="alt"){m+="alt+"}if(n.ctrlKey&&h!=="ctrl"){m+="ctrl+"}if(n.metaKey&&!n.ctrlKey&&h!=="meta"){m+="meta+"}if(n.shiftKey&&h!=="shift"){m+="shift+"}if(h){g[m+h]=true}else{g[m+o]=true;g[m+b.hotkeys.shiftNums[o]]=true;if(m==="shift+"){g[b.hotkeys.shiftNums[o]]=true}}for(var j=0,f=e.length;j<f;j++){if(g[e[j]]){return c.apply(this,arguments)}}}}b.each(["keydown","keyup","keypress"],function(){b.event.special[this]={add:a}})})(jQuery);if(typeof eventManager!='undefined'){eventManager.fire('scriptLoaded','vle/node/draw/svg-edit/js-hotkeys/jquery.hotkeys.min.js');};;(function(){var ns={svg:'http://www.w3.org/2000/svg',xlink:'http://www.w3.org/1999/xlink'};if(!window.console){window.console=new function(){this.log=function(str){};this.dir=function(str){};};}
$.cloneNode=function(el){if(!window.opera)return el.cloneNode(true);opera.postError(ns.svg,el.nodeName);var new_el=document.createElementNS(ns.svg,el.nodeName);$.each(el.attributes,function(i,attr){new_el.setAttributeNS(ns.svg,attr.nodeName,attr.nodeValue);});$.each(el.childNodes,function(i,child){if(child.nodeType==1){new_el.appendChild($.cloneNode(child));}});return new_el;}
$.jGraduate={Paint:function(opt){var options=opt||{};this.alpha=options.alpha||100;if(options.copy){this.type=options.copy.type;this.alpha=options.copy.alpha;this.solidColor=null;this.linearGradient=null;this.radialGradient=null;switch(this.type){case"none":break;case"solidColor":this.solidColor=options.copy.solidColor;break;case"linearGradient":this.linearGradient=$.cloneNode(options.copy.linearGradient);break;case"radialGradient":this.radialGradient=$.cloneNode(options.copy.radialGradient);break;}}
else if(options.linearGradient){this.type="linearGradient";this.solidColor=null;this.radialGradient=null;this.linearGradient=$.cloneNode(options.linearGradient);}
else if(options.radialGradient){this.type="radialGradient";this.solidColor=null;this.linearGradient=null;this.radialGradient=$.cloneNode(options.radialGradient);}
else if(options.solidColor){this.type="solidColor";this.solidColor=options.solidColor;}
else{this.type="none";this.solidColor=null;this.linearGradient=null;this.radialGradient=null;}}};jQuery.fn.jGraduateDefaults={paint:new $.jGraduate.Paint(),window:{pickerTitle:"Drag markers to pick a paint"},images:{clientPath:"images/"}};jQuery.fn.jGraduate=function(options){var $arguments=arguments;return this.each(function(){var $this=$(this),$settings=$.extend(true,{},jQuery.fn.jGraduateDefaults,options),id=$this.attr('id'),idref='#'+$this.attr('id')+' ';if(!idref)
{alert('Container element must have an id attribute to maintain unique id strings for sub-elements.');return;}
var okClicked=function(){if($this.paint.type=="radialGradient"){$this.paint.linearGradient=null;}else if($this.paint.type=="linearGradient"){$this.paint.radialGradient=null;}else if($this.paint.type=="solidColor"){$this.paint.linearGradient=null;$this.paint.radialGradient=null;}
$.isFunction($this.okCallback)&&$this.okCallback($this.paint);$this.hide();},cancelClicked=function(){$.isFunction($this.cancelCallback)&&$this.cancelCallback();$this.hide();};$.extend(true,$this,{paint:new $.jGraduate.Paint({copy:$settings.paint}),okCallback:$.isFunction($arguments[1])&&$arguments[1]||null,cancelCallback:$.isFunction($arguments[2])&&$arguments[2]||null});var pos=$this.position(),color=null;if($this.paint.type=="none"){$this.paint=$.jGraduate.Paint({solidColor:'ffffff'});}
$this.addClass('jGraduate_Picker');$this.html('<ul class="jGraduate_tabs">'+'<li class="jGraduate_tab_color jGraduate_tab_current" data-type="col">Solid Color</li>'+'<li class="jGraduate_tab_lingrad" data-type="lg">Linear Gradient</li>'+'<li class="jGraduate_tab_radgrad" data-type="rg">Radial Gradient</li>'+'</ul>'+'<div class="jGraduate_colPick"></div>'+'<div class="jGraduate_lgPick"></div>'+'<div class="jGraduate_rgPick"></div>');var colPicker=$(idref+'> .jGraduate_colPick');var lgPicker=$(idref+'> .jGraduate_lgPick');var rgPicker=$(idref+'> .jGraduate_rgPick');lgPicker.html('<div id="'+id+'_jGraduate_Swatch" class="jGraduate_Swatch">'+'<h2 class="jGraduate_Title">'+$settings.window.pickerTitle+'</h2>'+'<div id="'+id+'_lg_jGraduate_GradContainer" class="jGraduate_GradContainer"></div>'+'<div id="'+id+'_lg_jGraduate_Opacity" class="jGraduate_Opacity" title="Click to set overall opacity of the gradient paint">'+'<img id="'+id+'_lg_jGraduate_AlphaArrows" class="jGraduate_AlphaArrows" src="'+$settings.images.clientPath+'rangearrows2.gif"></img>'+'</div>'+'</div>'+'<div class="jGraduate_Form">'+'<div class="jGraduate_StopSection">'+'<label class="jGraduate_Form_Heading">Begin Stop</label>'+'<div class="jGraduate_Form_Section">'+'<label>x:</label>'+'<input type="text" id="'+id+'_jGraduate_x1" size="3" title="Enter starting x value between 0.0 and 1.0"/>'+'<label> y:</label>'+'<input type="text" id="'+id+'_jGraduate_y1" size="3" title="Enter starting y value between 0.0 and 1.0"/>'+'<div id="'+id+'_jGraduate_colorBoxBegin" class="colorBox"></div>'+'<label id="'+id+'_jGraduate_beginOpacity"> 100%</label>'+'</div>'+'</div>'+'<div class="jGraduate_StopSection">'+'<label class="jGraduate_Form_Heading">End Stop</label>'+'<div class="jGraduate_Form_Section">'+'<label>x:</label>'+'<input type="text" id="'+id+'_jGraduate_x2" size="3" title="Enter ending x value between 0.0 and 1.0"/>'+'<label> y:</label>'+'<input type="text" id="'+id+'_jGraduate_y2" size="3" title="Enter ending y value between 0.0 and 1.0"/>'+'<div id="'+id+'_jGraduate_colorBoxEnd" class="colorBox"></div>'+'<label id="'+id+'_jGraduate_endOpacity">100%</label>'+'</div>'+'</div>'+'<div class="lg_jGraduate_OpacityField">'+'<label class="lg_jGraduate_OpacityLabel">A: </label>'+'<input type="text" id="'+id+'_lg_jGraduate_OpacityInput" class="jGraduate_OpacityInput" size="3" value="100"/>%'+'</div>'+'</div>'+'<div class="jGraduate_OkCancel">'+'<input type="button" id="'+id+'_lg_jGraduate_Ok" class="jGraduate_Ok" value="OK"/>'+'<input type="button" id="'+id+'_lg_jGraduate_Cancel" class="jGraduate_Cancel" value="Cancel"/>'+'</div>'+'<div class="jGraduate_LightBox"></div>'+'<div id="'+id+'_jGraduate_stopPicker" class="jGraduate_stopPicker"></div>');rgPicker.html('<div class="jGraduate_Swatch">'+'<h2 class="jGraduate_Title">'+$settings.window.pickerTitle+'</h2>'+'<div id="'+id+'_rg_jGraduate_GradContainer" class="jGraduate_GradContainer"></div>'+'<div id="'+id+'_rg_jGraduate_Opacity" class="jGraduate_Opacity" title="Click to set overall opacity of the gradient paint">'+'<img id="'+id+'_rg_jGraduate_AlphaArrows" class="jGraduate_AlphaArrows" src="'+$settings.images.clientPath+'rangearrows2.gif"></img>'+'</div>'+'</div>'+'<div id="jGraduate_radColors" class="jGraduate_StopSection">'+'<label class="jGraduate_Form_Heading">Colors</label>'+'<div class="jGraduate_Form_Section jGraduate_Colorblocks">'+'<div class="jGraduate_colorblock"><span>Center:</span>'+'<div id="'+id+'_jGraduate_colorBoxCenter" class="colorBox"></div>'+'<label id="'+id+'_rg_jGraduate_centerOpacity"> 100%</label></div>'+'<div class="jGraduate_colorblock"><span>Outer:</span>'+'<div id="'+id+'_jGraduate_colorBoxOuter" class="colorBox"></div>'+'<label id="'+id+'_jGraduate_outerOpacity"> 100%</label></div>'+'</div>'+'</div>'+'<div class="jGraduate_StopSection">'+'</div>'+'<div class="jGraduate_Form">'+'<div class="jGraduate_StopSection">'+'<label class="jGraduate_Form_Heading">Center Point</label>'+'<div class="jGraduate_Form_Section">'+'<label>x:</label>'+'<input type="text" id="'+id+'_jGraduate_cx" size="3" title="Enter x value between 0.0 and 1.0"/>'+'<label> y:</label>'+'<input type="text" id="'+id+'_jGraduate_cy" size="3" title="Enter y value between 0.0 and 1.0"/>'+'</div>'+'</div>'+'<div class="jGraduate_StopSection">'+'<label class="jGraduate_Form_Heading">Focal Point</label>'+'<div class="jGraduate_Form_Section">'+'<label>Match center: <input type="checkbox" checked="checked" id="'+id+'_jGraduate_match_ctr"/></label><br/>'+'<label>x:</label>'+'<input type="text" id="'+id+'_jGraduate_fx" size="3" title="Enter x value between 0.0 and 1.0"/>'+'<label> y:</label>'+'<input type="text" id="'+id+'_jGraduate_fy" size="3" title="Enter y value between 0.0 and 1.0"/>'+'</div>'+'</div>'+'<div class="jGraduate_RadiusField">'+'<label class="jGraduate_Form_Heading">Radius</label>'+'<div class="jGraduate_Form_Section">'+'<div id="'+id+'_jGraduate_RadiusContainer" class="jGraduate_RadiusContainer"></div>'+'<input type="text" id="'+id+'_jGraduate_RadiusInput" size="3" value="100"/>%'+'<div id="'+id+'_jGraduate_Radius" class="jGraduate_Radius" title="Click to set radius">'+'<img id="'+id+'_jGraduate_RadiusArrows" class="jGraduate_RadiusArrows" src="'+$settings.images.clientPath+'rangearrows2.gif"></img>'+'</div>'+'</div>'+'</div>'+'</div>'+'<div class="rg_jGraduate_OpacityField">'+'<label class="rg_jGraduate_OpacityLabel">A: </label>'+'<input type="text" id="'+id+'_rg_jGraduate_OpacityInput" class="jGraduate_OpacityInput" size="3" value="100"/>%'+'</div>'+'<div class="jGraduate_OkCancel">'+'<input type="button" id="'+id+'_rg_jGraduate_Ok" class="jGraduate_Ok" value="OK"/>'+'<input type="button" id="'+id+'_rg_jGraduate_Cancel" class="jGraduate_Cancel" value="Cancel"/>'+'</div>'+'<div class="jGraduate_LightBox"></div>'+'<div id="'+id+'_rg_jGraduate_stopPicker" class="jGraduate_stopPicker"></div>');var MAX=256,MARGINX=0,MARGINY=0,STOP_RADIUS=15/2,SIZEX=MAX-2*MARGINX,SIZEY=MAX-2*MARGINY;$.each(['lg','rg'],function(i){var grad_id=id+'_'+this;var container=document.getElementById(grad_id+'_jGraduate_GradContainer');var svg=container.appendChild(document.createElementNS(ns.svg,'svg'));svg.id=grad_id+'_jgraduate_svg';svg.setAttribute('width',MAX);svg.setAttribute('height',MAX);svg.setAttribute("xmlns",ns.svg);});(function(){var svg=document.getElementById(id+'_lg_jgraduate_svg');if($this.paint.type=="linearGradient"){$this.paint.linearGradient.id=id+'_jgraduate_grad';$this.paint.linearGradient=svg.appendChild($.cloneNode($this.paint.linearGradient));}else{var grad=svg.appendChild(document.createElementNS(ns.svg,'linearGradient'));grad.id=id+'_jgraduate_grad';grad.setAttribute('x1','0.0');grad.setAttribute('y1','0.0');grad.setAttribute('x2','1.0');grad.setAttribute('y2','1.0');var begin=grad.appendChild(document.createElementNS(ns.svg,'stop'));begin.setAttribute('offset','0.0');begin.setAttribute('stop-color','#ff0000');var end=grad.appendChild(document.createElementNS(ns.svg,'stop'));end.setAttribute('offset','1.0');end.setAttribute('stop-color','#ffff00');$this.paint.linearGradient=grad;}
var gradalpha=$this.paint.alpha;$('#'+id+'_lg_jGraduate_OpacityInput').val(gradalpha);var posx=parseInt(255*(gradalpha/100))-4.5;$('#'+id+'_lg_jGraduate_AlphaArrows').css({'margin-left':posx});var x1=parseFloat($this.paint.linearGradient.getAttribute('x1')||0.0),y1=parseFloat($this.paint.linearGradient.getAttribute('y1')||0.0),x2=parseFloat($this.paint.linearGradient.getAttribute('x2')||1.0),y2=parseFloat($this.paint.linearGradient.getAttribute('y2')||0.0);var rect=document.createElementNS(ns.svg,'rect');rect.id=id+'_lg_jgraduate_rect';rect.setAttribute('x',MARGINX);rect.setAttribute('y',MARGINY);rect.setAttribute('width',SIZEY);rect.setAttribute('height',SIZEY);rect.setAttribute('fill','url(#'+id+'_jgraduate_grad)');rect.setAttribute('fill-opacity','1.0');rect=svg.appendChild(rect);$('#'+id+'_lg_jgraduate_rect').attr('fill-opacity',gradalpha/100);var beginStop=document.createElementNS(ns.svg,'image');beginStop.id=id+"_stop1";beginStop.setAttribute('class','stop');beginStop.setAttributeNS(ns.xlink,'href',$settings.images.clientPath+'mappoint.gif');beginStop.setAttributeNS(ns.xlink,"title","Begin Stop");beginStop.appendChild(document.createElementNS(ns.svg,'title')).appendChild(document.createTextNode("Begin Stop"));beginStop.setAttribute('width',18);beginStop.setAttribute('height',18);beginStop.setAttribute('x',MARGINX+SIZEX*x1-STOP_RADIUS);beginStop.setAttribute('y',MARGINY+SIZEY*y1-STOP_RADIUS);beginStop.setAttribute('cursor','move');beginStop=svg.appendChild(beginStop);var endStop=document.createElementNS(ns.svg,'image');endStop.id=id+"_stop2";endStop.setAttribute('class','stop');endStop.setAttributeNS(ns.xlink,'href',$settings.images.clientPath+'mappoint.gif');endStop.setAttributeNS(ns.xlink,"title","End Stop");endStop.appendChild(document.createElementNS(ns.svg,'title')).appendChild(document.createTextNode("End Stop"));endStop.setAttribute('width',18);endStop.setAttribute('height',18);endStop.setAttribute('x',MARGINX+SIZEX*x2-STOP_RADIUS);endStop.setAttribute('y',MARGINY+SIZEY*y2-STOP_RADIUS);endStop.setAttribute('cursor','move');endStop=svg.appendChild(endStop);$('#'+id+'_lg_jGraduate_Ok').bind('click',function(){$this.paint.type="linearGradient";$this.paint.solidColor=null;okClicked();});$('#'+id+'_lg_jGraduate_Cancel').bind('click',function(paint){cancelClicked();});var x1=$this.paint.linearGradient.getAttribute('x1');if(!x1)x1="0.0";var x1Input=$('#'+id+'_jGraduate_x1');x1Input.val(x1);x1Input.change(function(){if(isNaN(parseFloat(this.value))||this.value<0.0||this.value>1.0){this.value=0.0;}
$this.paint.linearGradient.setAttribute('x1',this.value);beginStop.setAttribute('x',MARGINX+SIZEX*this.value-STOP_RADIUS);});var y1=$this.paint.linearGradient.getAttribute('y1');if(!y1)y1="0.0";var y1Input=$('#'+id+'_jGraduate_y1');y1Input.val(y1);y1Input.change(function(){if(isNaN(parseFloat(this.value))||this.value<0.0||this.value>1.0){this.value=0.0;}
$this.paint.linearGradient.setAttribute('y1',this.value);beginStop.setAttribute('y',MARGINY+SIZEY*this.value-STOP_RADIUS);});var x2=$this.paint.linearGradient.getAttribute('x2');if(!x2)x2="1.0";var x2Input=$('#'+id+'_jGraduate_x2');x2Input.val(x2);x2Input.change(function(){if(isNaN(parseFloat(this.value))||this.value<0.0||this.value>1.0){this.value=1.0;}
$this.paint.linearGradient.setAttribute('x2',this.value);endStop.setAttribute('x',MARGINX+SIZEX*this.value-STOP_RADIUS);});var y2=$this.paint.linearGradient.getAttribute('y2');if(!y2)y2="0.0";y2Input=$('#'+id+'_jGraduate_y2');y2Input.val(y2);y2Input.change(function(){if(isNaN(parseFloat(this.value))||this.value<0.0||this.value>1.0){this.value=0.0;}
$this.paint.linearGradient.setAttribute('y2',this.value);endStop.setAttribute('y',MARGINY+SIZEY*this.value-STOP_RADIUS);});var stops=$this.paint.linearGradient.getElementsByTagNameNS(ns.svg,'stop');var numstops=stops.length;if(numstops<2){while(numstops<2){$this.paint.linearGradient.appendChild(document.createElementNS(ns.svg,'stop'));++numstops;}
stops=$this.paint.linearGradient.getElementsByTagNameNS(ns.svg,'stop');}
var setLgOpacitySlider=function(e,div){var offset=div.offset();var x=(e.pageX-offset.left-parseInt(div.css('border-left-width')));if(x>255)x=255;if(x<0)x=0;var posx=x-4.5;x/=255;$('#'+id+'_lg_jGraduate_AlphaArrows').css({'margin-left':posx});$('#'+id+'_lg_jgraduate_rect').attr('fill-opacity',x);x=parseInt(x*100);$('#'+id+'_lg_jGraduate_OpacityInput').val(x);$this.paint.alpha=x;};var bSlidingOpacity=false;$('#'+id+'_lg_jGraduate_Opacity').mousedown(function(evt){setLgOpacitySlider(evt,$(this));bSlidingOpacity=true;evt.preventDefault();}).mousemove(function(evt){if(bSlidingOpacity){setLgOpacitySlider(evt,$(this));evt.preventDefault();}}).mouseup(function(evt){setLgOpacitySlider(evt,$(this));bSlidingOpacity=false;evt.preventDefault();});var draggingStop=null;var startx=-1,starty=-1;$('.stop, #color_picker_lg_jGraduate_GradContainer image').mousedown(function(evt){draggingStop=this;startx=evt.clientX;starty=evt.clientY;evt.preventDefault();});$('#'+id+'_lg_jgraduate_svg').mousemove(function(evt){if(null!=draggingStop){var dx=evt.clientX-startx;var dy=evt.clientY-starty;startx+=dx;starty+=dy;var x=parseFloat(draggingStop.getAttribute('x'))+dx;var y=parseFloat(draggingStop.getAttribute('y'))+dy;if(x<MARGINX-STOP_RADIUS)x=MARGINX-STOP_RADIUS;if(y<MARGINY-STOP_RADIUS)y=MARGINY-STOP_RADIUS;if(x>MARGINX+SIZEX-STOP_RADIUS)x=MARGINX+SIZEX-STOP_RADIUS;if(y>MARGINY+SIZEY-STOP_RADIUS)y=MARGINY+SIZEY-STOP_RADIUS;draggingStop.setAttribute('x',x);draggingStop.setAttribute('y',y);var fracx=(x-MARGINX+STOP_RADIUS)/SIZEX;var fracy=(y-MARGINY+STOP_RADIUS)/SIZEY;if(draggingStop.id==(id+'_stop1')){x1Input.val(fracx);y1Input.val(fracy);$this.paint.linearGradient.setAttribute('x1',fracx);$this.paint.linearGradient.setAttribute('y1',fracy);}
else{x2Input.val(fracx);y2Input.val(fracy);$this.paint.linearGradient.setAttribute('x2',fracx);$this.paint.linearGradient.setAttribute('y2',fracy);}
evt.preventDefault();}});$('#'+id+'_lg_jgraduate_svg').mouseup(function(evt){draggingStop=null;});var beginColor=stops[0].getAttribute('stop-color');if(!beginColor)beginColor='#000';beginColorBox=$('#'+id+'_jGraduate_colorBoxBegin');beginColorBox.css({'background-color':beginColor});var beginOpacity=stops[0].getAttribute('stop-opacity');if(!beginOpacity)beginOpacity='1.0';$('#'+id+'lg_jGraduate_beginOpacity').html((beginOpacity*100)+'%');var endColor=stops[stops.length-1].getAttribute('stop-color');if(!endColor)endColor='#000';endColorBox=$('#'+id+'_jGraduate_colorBoxEnd');endColorBox.css({'background-color':endColor});var endOpacity=stops[stops.length-1].getAttribute('stop-opacity');if(!endOpacity)endOpacity='1.0';$('#'+id+'jGraduate_endOpacity').html((endOpacity*100)+'%');$('#'+id+'_jGraduate_colorBoxBegin').click(function(){$('div.jGraduate_LightBox').show();var colorbox=$(this);var thisAlpha=(parseFloat(beginOpacity)*255).toString(16);while(thisAlpha.length<2){thisAlpha="0"+thisAlpha;}
color=beginColor.substr(1)+thisAlpha;$('#'+id+'_jGraduate_stopPicker').css({'left':100,'bottom':15}).jPicker({window:{title:"Pick the start color and opacity for the gradient"},images:{clientPath:$settings.images.clientPath},color:{active:color,alphaSupport:true}},function(color){beginColor=color.get_Hex()?('#'+color.get_Hex()):"none";beginOpacity=color.get_A()?color.get_A()/100:1;colorbox.css('background',beginColor);$('#'+id+'_jGraduate_beginOpacity').html(parseInt(beginOpacity*100)+'%');stops[0].setAttribute('stop-color',beginColor);stops[0].setAttribute('stop-opacity',beginOpacity);$('div.jGraduate_LightBox').hide();$('#'+id+'_jGraduate_stopPicker').hide();},null,function(){$('div.jGraduate_LightBox').hide();$('#'+id+'_jGraduate_stopPicker').hide();});});$('#'+id+'_jGraduate_colorBoxEnd').click(function(){$('div.jGraduate_LightBox').show();var colorbox=$(this);var thisAlpha=(parseFloat(endOpacity)*255).toString(16);while(thisAlpha.length<2){thisAlpha="0"+thisAlpha;}
color=endColor.substr(1)+thisAlpha;$('#'+id+'_jGraduate_stopPicker').css({'left':100,'top':15}).jPicker({window:{title:"Pick the end color and opacity for the gradient"},images:{clientPath:$settings.images.clientPath},color:{active:color,alphaSupport:true}},function(color){endColor=color.get_Hex()?('#'+color.get_Hex()):"none";endOpacity=color.get_A()?color.get_A()/100:1;colorbox.css('background',endColor);$('#'+id+'_jGraduate_endOpacity').html(parseInt(endOpacity*100)+'%');stops[1].setAttribute('stop-color',endColor);stops[1].setAttribute('stop-opacity',endOpacity);$('div.jGraduate_LightBox').hide();$('#'+id+'_jGraduate_stopPicker').hide();},null,function(){$('div.jGraduate_LightBox').hide();$('#'+id+'_jGraduate_stopPicker').hide();});});var thisAlpha=($this.paint.alpha*255/100).toString(16);while(thisAlpha.length<2){thisAlpha="0"+thisAlpha;}
color=$this.paint.solidColor=="none"?"":$this.paint.solidColor+thisAlpha;colPicker.jPicker({window:{title:$settings.window.pickerTitle},images:{clientPath:$settings.images.clientPath},color:{active:color,alphaSupport:true}},function(color){$this.paint.type="solidColor";$this.paint.alpha=color.get_A()?color.get_A():100;$this.paint.solidColor=color.get_Hex()?color.get_Hex():"none";$this.paint.linearGradient=null;okClicked();},null,function(){cancelClicked();});}());(function(){var svg=document.getElementById(id+'_rg_jgraduate_svg');if($this.paint.type=="radialGradient"){$this.paint.radialGradient.id=id+'_rg_jgraduate_grad';$this.paint.radialGradient=svg.appendChild($.cloneNode($this.paint.radialGradient));}else{var grad=svg.appendChild(document.createElementNS(ns.svg,'radialGradient'));grad.id=id+'_rg_jgraduate_grad';grad.setAttribute('cx','0.5');grad.setAttribute('cy','0.5');grad.setAttribute('r','0.5');var begin=grad.appendChild(document.createElementNS(ns.svg,'stop'));begin.setAttribute('offset','0.0');begin.setAttribute('stop-color','#ff0000');var end=grad.appendChild(document.createElementNS(ns.svg,'stop'));end.setAttribute('offset','1.0');end.setAttribute('stop-color','#ffff00');$this.paint.radialGradient=grad;}
var gradalpha=$this.paint.alpha;$('#'+id+'_rg_jGraduate_OpacityInput').val(gradalpha);var posx=parseInt(255*(gradalpha/100))-4.5;$('#'+id+'_rg_jGraduate_AlphaArrows').css({'margin-left':posx});var grad=$this.paint.radialGradient;var cx=parseFloat(grad.getAttribute('cx')||0.5),cy=parseFloat(grad.getAttribute('cy')||0.5),fx=parseFloat(grad.getAttribute('fx')||0.5),fy=parseFloat(grad.getAttribute('fy')||0.5);var showFocus=grad.getAttribute('fx')!=null&&!(cx==fx&&cy==fy);var rect=document.createElementNS(ns.svg,'rect');rect.id=id+'_rg_jgraduate_rect';rect.setAttribute('x',MARGINX);rect.setAttribute('y',MARGINY);rect.setAttribute('width',SIZEY);rect.setAttribute('height',SIZEY);rect.setAttribute('fill','url(#'+id+'_rg_jgraduate_grad)');rect.setAttribute('fill-opacity','1.0');rect=svg.appendChild(rect);$('#'+id+'_rg_jgraduate_rect').attr('fill-opacity',gradalpha/100);var centerPoint=document.createElementNS(ns.svg,'image');centerPoint.id=id+"_center_pt";centerPoint.setAttribute('class','stop');centerPoint.setAttributeNS(ns.xlink,'href',$settings.images.clientPath+'mappoint_c.png');centerPoint.setAttributeNS(ns.xlink,"title","Center Point");centerPoint.appendChild(document.createElementNS(ns.svg,'title')).appendChild(document.createTextNode("Center Point"));centerPoint.setAttribute('width',18);centerPoint.setAttribute('height',18);centerPoint.setAttribute('x',MARGINX+SIZEX*cx-STOP_RADIUS);centerPoint.setAttribute('y',MARGINY+SIZEY*cy-STOP_RADIUS);centerPoint.setAttribute('cursor','move');var focusPoint=document.createElementNS(ns.svg,'image');focusPoint.id=id+"_focus_pt";focusPoint.setAttribute('class','stop');focusPoint.setAttributeNS(ns.xlink,'href',$settings.images.clientPath+'mappoint_f.png');focusPoint.setAttributeNS(ns.xlink,"title","Focus Point");focusPoint.appendChild(document.createElementNS(ns.svg,'title')).appendChild(document.createTextNode("Focus Point"));focusPoint.setAttribute('width',18);focusPoint.setAttribute('height',18);focusPoint.setAttribute('x',MARGINX+SIZEX*fx-STOP_RADIUS);focusPoint.setAttribute('y',MARGINY+SIZEY*fy-STOP_RADIUS);focusPoint.setAttribute('cursor','move');focusPoint=svg.appendChild(focusPoint);centerPoint=svg.appendChild(centerPoint);$('#'+id+'_rg_jGraduate_Ok').bind('click',function(){$this.paint.type="radialGradient";$this.paint.solidColor=null;okClicked();});$('#'+id+'_rg_jGraduate_Cancel').bind('click',function(paint){cancelClicked();});var cx=$this.paint.radialGradient.getAttribute('cx');if(!cx)cx="0.0";var cxInput=$('#'+id+'_jGraduate_cx');cxInput.val(cx);cxInput.change(function(){if(isNaN(parseFloat(this.value))||this.value<0.0||this.value>1.0){this.value=0.0;}
$this.paint.radialGradient.setAttribute('cx',this.value);centerPoint.setAttribute('x',MARGINX+SIZEX*this.value-STOP_RADIUS);});var cy=$this.paint.radialGradient.getAttribute('cy');if(!cy)cy="0.0";var cyInput=$('#'+id+'_jGraduate_cy');cyInput.val(cy);cyInput.change(function(){if(isNaN(parseFloat(this.value))||this.value<0.0||this.value>1.0){this.value=0.0;}
$this.paint.radialGradient.setAttribute('cy',this.value);centerPoint.setAttribute('y',MARGINY+SIZEY*this.value-STOP_RADIUS);});var fx=$this.paint.radialGradient.getAttribute('fx');if(!fx)fx="1.0";var fxInput=$('#'+id+'_jGraduate_fx');fxInput.val(fx);fxInput.change(function(){if(isNaN(parseFloat(this.value))||this.value<0.0||this.value>1.0){this.value=1.0;}
$this.paint.radialGradient.setAttribute('fx',this.value);focusPoint.setAttribute('x',MARGINX+SIZEX*this.value-STOP_RADIUS);});var fy=$this.paint.radialGradient.getAttribute('fy');if(!fy)fy="0.0";var fyInput=$('#'+id+'_jGraduate_fy');fyInput.val(fy);fyInput.change(function(){if(isNaN(parseFloat(this.value))||this.value<0.0||this.value>1.0){this.value=0.0;}
$this.paint.radialGradient.setAttribute('fy',this.value);focusPoint.setAttribute('y',MARGINY+SIZEY*this.value-STOP_RADIUS);});if(!showFocus){focusPoint.setAttribute('display','none');fxInput.val("");fyInput.val("");}
$("#"+id+"_jGraduate_match_ctr")[0].checked=!showFocus;var lastfx,lastfy;$("#"+id+"_jGraduate_match_ctr").change(function(){showFocus=!this.checked;focusPoint.setAttribute('display',showFocus?'inline':'none');fxInput.val("");fyInput.val("");var grad=$this.paint.radialGradient;if(!showFocus){lastfx=grad.getAttribute('fx');lastfy=grad.getAttribute('fy');grad.removeAttribute('fx');grad.removeAttribute('fy');}else{var fx=lastfx||.5;var fy=lastfy||.5;grad.setAttribute('fx',fx);grad.setAttribute('fy',fy);fxInput.val(fx);fyInput.val(fy);}});var stops=$this.paint.radialGradient.getElementsByTagNameNS(ns.svg,'stop');var numstops=stops.length;if(numstops<2){while(numstops<2){$this.paint.radialGradient.appendChild(document.createElementNS(ns.svg,'stop'));++numstops;}
stops=$this.paint.radialGradient.getElementsByTagNameNS(ns.svg,'stop');}
var radius=$this.paint.radialGradient.getAttribute('r')-0;var radiusx=parseInt((245/2)*(radius))-4.5;$('#'+id+'_jGraduate_RadiusArrows').css({'margin-left':radiusx});$('#'+id+'_jGraduate_RadiusInput').val(parseInt(radius*100)).change(function(e){var x=this.value/100;if(x<0.01){x=0.01;}
$this.paint.radialGradient.setAttribute('r',x);if(x>2)x=2;var posx=parseInt((245/2)*x)-4.5;$('#'+id+'_jGraduate_RadiusArrows').css({'margin-left':posx});});var setRgOpacitySlider=function(e,div){var offset=div.offset();var x=(e.pageX-offset.left-parseInt(div.css('border-left-width')));if(x>255)x=255;if(x<0)x=0;var posx=x-4.5;x/=255;$('#'+id+'_rg_jGraduate_AlphaArrows').css({'margin-left':posx});$('#'+id+'_rg_jgraduate_rect').attr('fill-opacity',x);x=parseInt(x*100);$('#'+id+'_rg_jGraduate_OpacityInput').val(x);$this.paint.alpha=x;};var bSlidingOpacity=false;$('#'+id+'_rg_jGraduate_Opacity').mousedown(function(evt){setRgOpacitySlider(evt,$(this));bSlidingOpacity=true;evt.preventDefault();}).mousemove(function(evt){if(bSlidingOpacity){setRgOpacitySlider(evt,$(this));evt.preventDefault();}}).mouseup(function(evt){setRgOpacitySlider(evt,$(this));bSlidingOpacity=false;evt.preventDefault();});var setRadiusSlider=function(e,div){var offset=div.offset();var x=(e.pageX-offset.left-parseInt(div.css('border-left-width')));if(x>245)x=245;if(x<=1)x=1;var posx=x-5;x/=(245/2);$('#'+id+'_jGraduate_RadiusArrows').css({'margin-left':posx});$this.paint.radialGradient.setAttribute('r',x);x=parseInt(x*100);$('#'+id+'_jGraduate_RadiusInput').val(x);};var bSlidingRadius=false;$('#'+id+'_jGraduate_Radius').mousedown(function(evt){setRadiusSlider(evt,$(this));bSlidingRadius=true;evt.preventDefault();}).mousemove(function(evt){if(bSlidingRadius){setRadiusSlider(evt,$(this));evt.preventDefault();}}).mouseup(function(evt){setRadiusSlider(evt,$(this));bSlidingRadius=false;evt.preventDefault();});var draggingStop=null;var startx=-1,starty=-1;$('.stop, #color_picker_rg_jGraduate_GradContainer image').mousedown(function(evt){draggingStop=this;startx=evt.clientX;starty=evt.clientY;evt.preventDefault();});$('#'+id+'_rg_jgraduate_svg').mousemove(function(evt){if(null!=draggingStop){var dx=evt.clientX-startx;var dy=evt.clientY-starty;startx+=dx;starty+=dy;var x=parseFloat(draggingStop.getAttribute('x'))+dx;var y=parseFloat(draggingStop.getAttribute('y'))+dy;if(x<MARGINX-STOP_RADIUS)x=MARGINX-STOP_RADIUS;if(y<MARGINY-STOP_RADIUS)y=MARGINY-STOP_RADIUS;if(x>MARGINX+SIZEX-STOP_RADIUS)x=MARGINX+SIZEX-STOP_RADIUS;if(y>MARGINY+SIZEY-STOP_RADIUS)y=MARGINY+SIZEY-STOP_RADIUS;draggingStop.setAttribute('x',x);draggingStop.setAttribute('y',y);var fracx=(x-MARGINX+STOP_RADIUS)/SIZEX;var fracy=(y-MARGINY+STOP_RADIUS)/SIZEY;if(draggingStop.id==(id+'_center_pt')){cxInput.val(fracx);cyInput.val(fracy);$this.paint.radialGradient.setAttribute('cx',fracx);$this.paint.radialGradient.setAttribute('cy',fracy);if(!showFocus){$this.paint.radialGradient.setAttribute('fx',fracx);$this.paint.radialGradient.setAttribute('fy',fracy);}}
else{fxInput.val(fracx);fyInput.val(fracy);$this.paint.radialGradient.setAttribute('fx',fracx);$this.paint.radialGradient.setAttribute('fy',fracy);}
evt.preventDefault();}});$('#'+id+'_rg_jgraduate_svg').mouseup(function(evt){draggingStop=null;});var centerColor=stops[0].getAttribute('stop-color');if(!centerColor)centerColor='#000';centerColorBox=$('#'+id+'_jGraduate_colorBoxCenter');centerColorBox.css({'background-color':centerColor});var centerOpacity=stops[0].getAttribute('stop-opacity');if(!centerOpacity)centerOpacity='1.0';$('#'+id+'jGraduate_centerOpacity').html((centerOpacity*100)+'%');var outerColor=stops[stops.length-1].getAttribute('stop-color');if(!outerColor)outerColor='#000';outerColorBox=$('#'+id+'_jGraduate_colorBoxOuter');outerColorBox.css({'background-color':outerColor});var outerOpacity=stops[stops.length-1].getAttribute('stop-opacity');if(!outerOpacity)outerOpacity='1.0';$('#'+id+'rg_jGraduate_outerOpacity').html((outerOpacity*100)+'%');$('#'+id+'_jGraduate_colorBoxCenter').click(function(){$('div.jGraduate_LightBox').show();var colorbox=$(this);var thisAlpha=(parseFloat(centerOpacity)*255).toString(16);while(thisAlpha.length<2){thisAlpha="0"+thisAlpha;}
color=centerColor.substr(1)+thisAlpha;$('#'+id+'_rg_jGraduate_stopPicker').css({'left':100,'bottom':15}).jPicker({window:{title:"Pick the center color and opacity for the gradient"},images:{clientPath:$settings.images.clientPath},color:{active:color,alphaSupport:true}},function(color){centerColor=color.get_Hex()?('#'+color.get_Hex()):"none";centerOpacity=color.get_A()?color.get_A()/100:1;colorbox.css('background',centerColor);$('#'+id+'_rg_jGraduate_centerOpacity').html(parseInt(centerOpacity*100)+'%');stops[0].setAttribute('stop-color',centerColor);stops[0].setAttribute('stop-opacity',centerOpacity);$('div.jGraduate_LightBox').hide();$('#'+id+'_rg_jGraduate_stopPicker').hide();},null,function(){$('div.jGraduate_LightBox').hide();$('#'+id+'_rg_jGraduate_stopPicker').hide();});});$('#'+id+'_jGraduate_colorBoxOuter').click(function(){$('div.jGraduate_LightBox').show();var colorbox=$(this);var thisAlpha=(parseFloat(outerOpacity)*255).toString(16);while(thisAlpha.length<2){thisAlpha="0"+thisAlpha;}
color=outerColor.substr(1)+thisAlpha;$('#'+id+'_rg_jGraduate_stopPicker').css({'left':100,'top':15}).jPicker({window:{title:"Pick the outer color and opacity for the gradient"},images:{clientPath:$settings.images.clientPath},color:{active:color,alphaSupport:true}},function(color){outerColor=color.get_Hex()?('#'+color.get_Hex()):"none";outerOpacity=color.get_A()?color.get_A()/100:1;colorbox.css('background',outerColor);$('#'+id+'_jGraduate_outerOpacity').html(parseInt(outerOpacity*100)+'%');stops[1].setAttribute('stop-color',outerColor);stops[1].setAttribute('stop-opacity',outerOpacity);$('div.jGraduate_LightBox').hide();$('#'+id+'_rg_jGraduate_stopPicker').hide();},null,function(){$('div.jGraduate_LightBox').hide();$('#'+id+'_rg_jGraduate_stopPicker').hide();});});var thisAlpha=($this.paint.alpha*255/100).toString(16);while(thisAlpha.length<2){thisAlpha="0"+thisAlpha;}
color=$this.paint.solidColor=="none"?"":$this.paint.solidColor+thisAlpha;colPicker.jPicker({window:{title:$settings.window.pickerTitle},images:{clientPath:$settings.images.clientPath},color:{active:color,alphaSupport:true}},function(color){$this.paint.type="solidColor";$this.paint.alpha=color.get_A()?color.get_A():100;$this.paint.solidColor=color.get_Hex()?color.get_Hex():"none";$this.paint.radialGradient=null;okClicked();},null,function(){cancelClicked();});}());var tabs=$(idref+' .jGraduate_tabs li');tabs.click(function(){tabs.removeClass('jGraduate_tab_current');$(this).addClass('jGraduate_tab_current');$(idref+" > div").hide();$(idref+' .jGraduate_'+$(this).attr('data-type')+'Pick').show();});$(idref+" > div").hide();tabs.removeClass('jGraduate_tab_current');var tab;switch($this.paint.type){case'linearGradient':tab=$(idref+' .jGraduate_tab_lingrad');break;case'radialGradient':tab=$(idref+' .jGraduate_tab_radgrad');break;default:tab=$(idref+' .jGraduate_tab_color');break;}
tab.addClass('jGraduate_tab_current').click();$this.show();});};})();if(typeof eventManager!='undefined'){eventManager.fire('scriptLoaded','vle/node/draw/svg-edit/jgraduate/jquery.jgraduate.js');};;(function($){var svg_icons={};$.svgIcons=function(file,opts){var svgns="http://www.w3.org/2000/svg",xlinkns="http://www.w3.org/1999/xlink",icon_w=opts.w?opts.w:24,icon_h=opts.h?opts.h:24,elems,svgdoc,testImg,icons_made=false,data_loaded=false,load_attempts=0,ua=navigator.userAgent,isOpera=!!window.opera,isSafari=(ua.indexOf('Safari/')>-1&&ua.indexOf('Chrome/')==-1),data_pre='data:image/svg+xml;charset=utf-8;base64,';if(opts.svgz){var data_el=$('<object data="'+file+'" type=image/svg+xml>').appendTo('body').hide();try{svgdoc=data_el[0].contentDocument;data_el.load(getIcons);getIcons(0,true);}catch(err1){useFallback();}}else{$.ajax({url:file,dataType:'xml',success:function(data){svgdoc=data;getIcons('ajax');},error:function(err){if(window.opera){useFallback();}else{if(err.responseXML){svgdoc=err.responseXML;getIcons('ajax');}}}});}
function getIcons(evt,no_wait){if(evt!=='ajax'){if(data_loaded)return;svgdoc=data_el[0].contentDocument;var isReady=(svgdoc&&svgdoc.getElementById('svg_eof'));if(!isReady&&!(no_wait&&isReady)){load_attempts++;if(load_attempts<50){setTimeout(getIcons,20);}else{useFallback();data_loaded=true;}
return;}
data_loaded=true;}
$(svgdoc).find('metadata').remove().end().find('*').each(function(i,el){if(el.nodeName.indexOf(':')!=-1){$(el).remove();}
var attrs=$.extend(false,el.attributes,{});for(i in attrs){var attr=attrs[i];var fullattr=attr.prefix?attr.prefix+':'+attr.localName:'';if(attr.prefix){el.removeAttribute(attr.localName);el.removeAttribute(fullattr);}
if(fullattr=='xlink:href'){el.setAttribute('xlink:href',attr.nodeValue);}}});elems=$(svgdoc.firstChild).children();var testSrc=data_pre+'PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNzUiIGhlaWdodD0iMjc1Ij48L3N2Zz4%3D';testImg=$(new Image()).attr({src:testSrc,width:0,height:0}).appendTo('body').load(function(){makeIcons(!isSafari);}).error(function(){makeIcons();});}
function makeIcons(toImage,fallback){if(icons_made)return;if(opts.no_img)toImage=false;var holder;var setIcon=function(target,icon,id,setID){if(isOpera)icon.css('visibility','hidden');if(opts.replace){if(setID)icon.attr('id',id);var cl=target.attr('class');if(cl)icon.attr('class','svg_icon '+cl);target.replaceWith(icon);}else{target.append(icon);}
if(isOpera){setTimeout(function(){icon.attr('style','visibility:visible;');},1);}}
var addIcon=function(icon,id){if(opts.id_match===undefined||opts.id_match!==false){setIcon(holder,icon,id,true);}
svg_icons[id]=icon;}
if(toImage){var temp_holder=$(document.createElement('div'));temp_holder.hide().appendTo('body');}
if(fallback){var path=opts.fallback_path?opts.fallback_path:'';$.each(fallback,function(id,imgsrc){holder=$('#'+id);var icon=$(new Image()).attr({'class':'svg_icon',src:path+imgsrc,'width':icon_w,'height':icon_h,'alt':'icon'});addIcon(icon,id);});}else{$.each(elems,function(i,elem){var id=elem.getAttribute('id');if(id=='svg_eof')return;holder=$('#'+id);var svg=elem.getElementsByTagNameNS(svgns,'svg')[0];var svgroot=svgdoc.createElementNS(svgns,"svg");svgroot.setAttributeNS(svgns,'viewBox',[0,0,icon_w,icon_h].join(' '));var w=svg.getAttribute('width');var h=svg.getAttribute('height');svg.removeAttribute('width');svg.removeAttribute('height');var vb=svg.getAttribute('viewBox');if(!vb){svg.setAttribute('viewBox',[0,0,w,h].join(' '));}
$(svgroot).attr({"xmlns":svgns,"width":icon_w,"height":icon_h,"xmlns:xlink":xlinkns,"class":'svg_icon'});if(!isOpera)svg=svg.cloneNode(true);svgroot.appendChild(svg);if(toImage){var svgcontent=isOpera?svgroot:svgroot.cloneNode(true);temp_holder.empty().append(svgroot);var str=data_pre+encode64(temp_holder.html());var icon=$(new Image()).attr({'class':'svg_icon',src:str});}else{var icon=fixIDs($(svgroot),i);}
addIcon(icon,id);});}
if(opts.placement){$.each(opts.placement,function(sel,id){if(!svg_icons[id])return;$(sel).each(function(i){var copy=svg_icons[id].clone();if(i>0&&!toImage)copy=fixIDs(copy,i,true);setIcon($(this),copy,id);})});}
if(!fallback){if(toImage)temp_holder.remove();if(data_el)data_el.remove();testImg.remove();}
if(opts.resize)$.resizeSvgIcons(opts.resize);icons_made=true;if(opts.callback)opts.callback(svg_icons);}
function fixIDs(svg_el,svg_num,force){var defs=svg_el.find('defs');if(!defs.length)return svg_el;var urlBase=parent.location.href;defs.find('[id]').each(function(i){var id=this.id;var no_dupes=($(svgdoc).find('#'+id).length<=1);if(isOpera)no_dupes=false;var new_id='x'+id+svg_num+i;$(this).attr('id',new_id);svg_el.find('[fill="url(#'+id+')"]').each(function(){$(this).attr('fill','url('+urlBase+'#'+new_id+')');}).end().find('[stroke="url(#'+id+')"]').each(function(){$(this).attr('fill','url('+urlBase+'#'+new_id+')');}).end().find('use').each(function(){if(this.getAttribute('xlink:href')=='#'+id){this.setAttributeNS(xlinkns,'href','#'+new_id);}}).end().find('[filter="url(#'+id+')"]').each(function(){$(this).attr('filter','url(#'+new_id+')');});});return svg_el;}
function useFallback(){if(file.indexOf('.svgz')!=-1){var reg_file=file.replace('.svgz','.svg');if(window.console){console.log('.svgz failed, trying with .svg');}
$.svgIcons(reg_file,opts);}else if(opts.fallback){makeIcons(false,opts.fallback);}}
function encode64(input){if(window.btoa)return window.btoa(input);var _keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var output=new Array(Math.floor((input.length+2)/3)*4);var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0,p=0;do{chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=((chr1&3)<<4)|(chr2>>4);enc3=((chr2&15)<<2)|(chr3>>6);enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64;}else if(isNaN(chr3)){enc4=64;}
output[p++]=_keyStr.charAt(enc1);output[p++]=_keyStr.charAt(enc2);output[p++]=_keyStr.charAt(enc3);output[p++]=_keyStr.charAt(enc4);}while(i<input.length);return output.join('');}}
$.getSvgIcon=function(id){return svg_icons[id];}
$.resizeSvgIcons=function(obj){var change_sel=!$('.svg_icon:first').length;$.each(obj,function(sel,size){var arr=$.isArray(size);var w=arr?size[0]:size,h=arr?size[1]:size;if(change_sel){sel=sel.replace(/\.svg_icon/g,'svg');}
$(sel).each(function(){this.setAttribute('width',w);this.setAttribute('height',h);if(window.opera&&window.widget){this.parentNode.style.width=w+'px';this.parentNode.style.height=h+'px';}});});}})(jQuery);if(typeof eventManager!='undefined'){eventManager.fire('scriptLoaded','vle/node/draw/svg-edit/svgicons/jquery.svgicons.js');};;(function($,p){var i,m=Array.prototype.slice,r=decodeURIComponent,a=$.param,c,l,v,b=$.bbq=$.bbq||{},q,u,j,e=$.event.special,d="hashchange",A="querystring",D="fragment",y="elemUrlAttr",g="location",k="href",t="src",x=/^.*\?|#.*$/g,w=/^.*\#/,h,C={};function E(F){return typeof F==="string"}function B(G){var F=m.call(arguments,1);return function(){return G.apply(this,F.concat(m.call(arguments)))}}function n(F){return F.replace(/^[^#]*#?(.*)$/,"$1")}function o(F){return F.replace(/(?:^[^?#]*\?([^#]*).*$)?.*/,"$1")}function f(H,M,F,I,G){var O,L,K,N,J;if(I!==i){K=F.match(H?/^([^#]*)\#?(.*)$/:/^([^#?]*)\??([^#]*)(#?.*)/);J=K[3]||"";if(G===2&&E(I)){L=I.replace(H?w:x,"")}else{N=l(K[2]);I=E(I)?l[H?D:A](I):I;L=G===2?I:G===1?$.extend({},I,N):$.extend({},N,I);L=a(L);if(H){L=L.replace(h,r)}}O=K[1]+(H?"#":L||!K[1]?"?":"")+L+J}else{O=M(F!==i?F:p[g][k])}return O}a[A]=B(f,0,o);a[D]=c=B(f,1,n);c.noEscape=function(G){G=G||"";var F=$.map(G.split(""),encodeURIComponent);h=new RegExp(F.join("|"),"g")};c.noEscape(",/");$.deparam=l=function(I,F){var H={},G={"true":!0,"false":!1,"null":null};$.each(I.replace(/\+/g," ").split("&"),function(L,Q){var K=Q.split("="),P=r(K[0]),J,O=H,M=0,R=P.split("]["),N=R.length-1;if(/\[/.test(R[0])&&/\]$/.test(R[N])){R[N]=R[N].replace(/\]$/,"");R=R.shift().split("[").concat(R);N=R.length-1}else{N=0}if(K.length===2){J=r(K[1]);if(F){J=J&&!isNaN(J)?+J:J==="undefined"?i:G[J]!==i?G[J]:J}if(N){for(;M<=N;M++){P=R[M]===""?O.length:R[M];O=O[P]=M<N?O[P]||(R[M+1]&&isNaN(R[M+1])?{}:[]):J}}else{if($.isArray(H[P])){H[P].push(J)}else{if(H[P]!==i){H[P]=[H[P],J]}else{H[P]=J}}}}else{if(P){H[P]=F?i:""}}});return H};function z(H,F,G){if(F===i||typeof F==="boolean"){G=F;F=a[H?D:A]()}else{F=E(F)?F.replace(H?w:x,""):F}return l(F,G)}l[A]=B(z,0);l[D]=v=B(z,1);$[y]||($[y]=function(F){return $.extend(C,F)})({a:k,base:k,iframe:t,img:t,input:t,form:"action",link:k,script:t});j=$[y];function s(I,G,H,F){if(!E(H)&&typeof H!=="object"){F=H;H=G;G=i}return this.each(function(){var L=$(this),J=G||j()[(this.nodeName||"").toLowerCase()]||"",K=J&&L.attr(J)||"";L.attr(J,a[I](K,H,F))})}$.fn[A]=B(s,A);$.fn[D]=B(s,D);b.pushState=q=function(I,F){if(E(I)&&/^#/.test(I)&&F===i){F=2}var H=I!==i,G=c(p[g][k],H?I:{},H?F:2);p[g][k]=G+(/#/.test(G)?"":"#")};b.getState=u=function(F,G){return F===i||typeof F==="boolean"?v(F):v(G)[F]};b.removeState=function(F){var G={};if(F!==i){G=u();$.each($.isArray(F)?F:arguments,function(I,H){delete G[H]})}q(G,2)};e[d]=$.extend(e[d],{add:function(F){var H;function G(J){var I=J[D]=c();J.getState=function(K,L){return K===i||typeof K==="boolean"?l(I,K):l(I,L)[K]};H.apply(this,arguments)}if($.isFunction(F)){H=F;return G}else{H=F.handler;F.handler=G}}})})(jQuery,this);(function($,i,b){var j,k=$.event.special,c="location",d="hashchange",l="href",f=$.browser,g=document.documentMode,h=f.msie&&(g===b||g<8),e="on"+d in i&&!h;function a(m){m=m||i[c][l];return m.replace(/^[^#]*#?(.*)$/,"$1")}$[d+"Delay"]=100;k[d]=$.extend(k[d],{setup:function(){if(e){return false}$(j.start)},teardown:function(){if(e){return false}$(j.stop)}});j=(function(){var m={},r,n,o,q;function p(){o=q=function(s){return s};if(h){n=$('<iframe src="javascript:0"/>').hide().insertAfter("body")[0].contentWindow;q=function(){return a(n.document[c][l])};o=function(u,s){if(u!==s){var t=n.document;t.open().close();t[c].hash="#"+u}};o(a())}}m.start=function(){if(r){return}var t=a();o||p();(function s(){var v=a(),u=q(t);if(v!==t){o(t=v,u);$(i).trigger(d)}else{if(u!==t){i[c][l]=i[c][l].replace(/#.*/,"")+"#"+u}}r=setTimeout(s,$[d+"Delay"])})()};m.stop=function(){if(!n){r&&clearTimeout(r);r=0}};return m})()})(jQuery,this);if(typeof eventManager!='undefined'){eventManager.fire('scriptLoaded','vle/node/draw/svg-edit/jquerybbq/jquery.bbq.min.js');};;$.fn.SpinButton=function(cfg){return this.each(function(){this.repeating=false;this.spinCfg={min:cfg&&!isNaN(parseFloat(cfg.min))?Number(cfg.min):null,max:cfg&&!isNaN(parseFloat(cfg.max))?Number(cfg.max):null,step:cfg&&cfg.step?Number(cfg.step):1,stepfunc:cfg&&cfg.stepfunc?cfg.stepfunc:false,page:cfg&&cfg.page?Number(cfg.page):10,upClass:cfg&&cfg.upClass?cfg.upClass:'up',downClass:cfg&&cfg.downClass?cfg.downClass:'down',reset:cfg&&cfg.reset?cfg.reset:this.value,delay:cfg&&cfg.delay?Number(cfg.delay):500,interval:cfg&&cfg.interval?Number(cfg.interval):100,_btn_width:20,_direction:null,_delay:null,_repeat:null,callback:cfg&&cfg.callback?cfg.callback:null};this.spinCfg.smallStep=cfg&&cfg.smallStep?cfg.smallStep:this.spinCfg.step/2;this.adjustValue=function(i){var v;if(isNaN(this.value)){v=this.spinCfg.reset;}else if($.isFunction(this.spinCfg.stepfunc)){v=this.spinCfg.stepfunc(this,i);}else{v=Number((Number(this.value)+Number(i)).toFixed(5));}
if(this.spinCfg.min!==null)v=Math.max(v,this.spinCfg.min);if(this.spinCfg.max!==null)v=Math.min(v,this.spinCfg.max);this.value=v;if($.isFunction(this.spinCfg.callback))this.spinCfg.callback(this);};$(this).addClass(cfg&&cfg.spinClass?cfg.spinClass:'spin-button').mousemove(function(e){var x=e.pageX||e.x;var y=e.pageY||e.y;var el=e.target||e.srcElement;var height=$(el).outerHeight()/2;var direction=(x>coord(el,'offsetLeft')+el.offsetWidth-this.spinCfg._btn_width)?((y<coord(el,'offsetTop')+height)?1:-1):0;if(direction!==this.spinCfg._direction){switch(direction){case 1:$(this).removeClass(this.spinCfg.downClass).addClass(this.spinCfg.upClass);break;case-1:$(this).removeClass(this.spinCfg.upClass).addClass(this.spinCfg.downClass);break;default:$(this).removeClass(this.spinCfg.upClass).removeClass(this.spinCfg.downClass);}
this.spinCfg._direction=direction;}}).mouseout(function(){$(this).removeClass(this.spinCfg.upClass).removeClass(this.spinCfg.downClass);this.spinCfg._direction=null;window.clearInterval(this.spinCfg._repeat);window.clearTimeout(this.spinCfg._delay);}).mousedown(function(e){if(e.button===0&&this.spinCfg._direction!=0){var self=this;var stepSize=e.shiftKey?self.spinCfg.smallStep:self.spinCfg.step
var adjust=function(){self.adjustValue(self.spinCfg._direction*stepSize);};adjust();self.spinCfg._delay=window.setTimeout(function(){adjust();self.spinCfg._repeat=window.setInterval(adjust,self.spinCfg.interval);},self.spinCfg.delay);}}).mouseup(function(e){window.clearInterval(this.spinCfg._repeat);window.clearTimeout(this.spinCfg._delay);}).dblclick(function(e){if($.browser.msie)
this.adjustValue(this.spinCfg._direction*this.spinCfg.step);}).keydown(function(e){switch(e.keyCode){case 38:this.adjustValue(this.spinCfg.step);break;case 40:this.adjustValue(-this.spinCfg.step);break;case 33:this.adjustValue(this.spinCfg.page);break;case 34:this.adjustValue(-this.spinCfg.page);break;}}).keypress(function(e){if(this.repeating){switch(e.keyCode){case 38:this.adjustValue(this.spinCfg.step);break;case 40:this.adjustValue(-this.spinCfg.step);break;case 33:this.adjustValue(this.spinCfg.page);break;case 34:this.adjustValue(-this.spinCfg.page);break;}}
else{this.repeating=true;}}).keyup(function(e){this.repeating=false;switch(e.keyCode){case 38:case 40:case 33:case 34:case 13:this.adjustValue(0);break;}}).bind("mousewheel",function(e){if(e.wheelDelta>=120)
this.adjustValue(this.spinCfg.step);else if(e.wheelDelta<=-120)
this.adjustValue(-this.spinCfg.step);e.preventDefault();}).change(function(e){this.adjustValue(0);});if(this.addEventListener){this.addEventListener('DOMMouseScroll',function(e){if(e.detail>0)
this.adjustValue(-this.spinCfg.step);else if(e.detail<0)
this.adjustValue(this.spinCfg.step);e.preventDefault();},false);}});function coord(el,prop){var c=el[prop],b=document.body;while((el=el.offsetParent)&&(el!=b)){if(!$.browser.msie||(el.currentStyle.position!='relative'))
c+=el[prop];}
return c;}};if(typeof eventManager!='undefined'){eventManager.fire('scriptLoaded','vle/node/draw/svg-edit/spinbtn/JQuerySpinBtn.js');};;if(!window.console){window.console={};window.console.log=function(str){};window.console.dir=function(str){};}
if(window.opera){window.console.log=function(str){opera.postError(str);};window.console.dir=function(str){};}
(function(){var proxied=jQuery.fn.attr,svgns="http://www.w3.org/2000/svg";jQuery.fn.attr=function(key,value){var len=this.length;if(!len)return this;for(var i=0;i<len;i++){var elem=this[i];if(elem.namespaceURI===svgns){if(value!==undefined){elem.setAttribute(key,value);}else if($.isArray(key)){var j=key.length,obj={};while(j--){var aname=key[j];var attr=elem.getAttribute(aname);if(attr||attr==="0"){attr=isNaN(attr)?attr:attr-0;}
obj[aname]=attr;}
return obj;}else if(typeof key==="object"){for(var v in key){elem.setAttribute(v,key[v]);}}else{var attr=elem.getAttribute(key);if(attr||attr==="0"){attr=isNaN(attr)?attr:attr-0;}
return attr;}}else{return proxied.apply(this,arguments);}}
return this;};}());$.SvgCanvas=function(container,config)
{var isOpera=!!window.opera,isWebkit=navigator.userAgent.indexOf("AppleWebKit")!=-1,support={},svgWhiteList={"a":["class","clip-path","clip-rule","fill","fill-opacity","fill-rule","filter","id","mask","opacity","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","transform","xlink:href","xlink:title"],"circle":["class","clip-path","clip-rule","cx","cy","fill","fill-opacity","fill-rule","filter","id","mask","opacity","r","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","transform"],"clipPath":["class","clipPathUnits","id"],"defs":[],"desc":[],"ellipse":["class","clip-path","clip-rule","cx","cy","fill","fill-opacity","fill-rule","filter","id","mask","opacity","requiredFeatures","rx","ry","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","transform"],"feGaussianBlur":["class","color-interpolation-filters","id","requiredFeatures","stdDeviation"],"filter":["class","color-interpolation-filters","filterRes","filterUnits","height","id","primitiveUnits","requiredFeatures","width","x","xlink:href","y"],"foreignObject":["class","font-size","height","id","opacity","requiredFeatures","style","transform","width","x","y"],"g":["class","clip-path","clip-rule","id","display","fill","fill-opacity","fill-rule","filter","mask","opacity","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","transform"],"image":["class","clip-path","clip-rule","filter","height","id","mask","opacity","requiredFeatures","style","systemLanguage","transform","width","x","xlink:href","xlink:title","y"],"line":["class","clip-path","clip-rule","fill","fill-opacity","fill-rule","filter","id","marker-end","marker-mid","marker-start","mask","opacity","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","transform","x1","x2","y1","y2"],"linearGradient":["class","id","gradientTransform","gradientUnits","requiredFeatures","spreadMethod","systemLanguage","x1","x2","xlink:href","y1","y2"],"marker":["id","class","markerHeight","markerUnits","markerWidth","orient","preserveAspectRatio","refX","refY","systemLanguage","viewBox"],"mask":["class","height","id","maskContentUnits","maskUnits","width","x","y"],"metadata":["class","id"],"path":["class","clip-path","clip-rule","d","fill","fill-opacity","fill-rule","filter","id","marker-end","marker-mid","marker-start","mask","opacity","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","transform"],"pattern":["class","height","id","patternContentUnits","patternTransform","patternUnits","requiredFeatures","style","systemLanguage","width","x","xlink:href","y"],"polygon":["class","clip-path","clip-rule","id","fill","fill-opacity","fill-rule","filter","id","class","marker-end","marker-mid","marker-start","mask","opacity","points","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","transform"],"polyline":["class","clip-path","clip-rule","id","fill","fill-opacity","fill-rule","filter","marker-end","marker-mid","marker-start","mask","opacity","points","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","transform"],"radialGradient":["class","cx","cy","fx","fy","gradientTransform","gradientUnits","id","r","requiredFeatures","spreadMethod","systemLanguage","xlink:href"],"rect":["class","clip-path","clip-rule","fill","fill-opacity","fill-rule","filter","height","id","mask","opacity","requiredFeatures","rx","ry","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","transform","width","x","y"],"stop":["class","id","offset","requiredFeatures","stop-color","stop-opacity","style","systemLanguage"],"svg":["class","clip-path","clip-rule","filter","id","height","mask","preserveAspectRatio","requiredFeatures","style","systemLanguage","viewBox","width","x","xmlns","xmlns:se","xmlns:xlink","y"],"switch":["class","id","requiredFeatures","systemLanguage"],"symbol":["class","fill","fill-opacity","fill-rule","filter","font-family","font-size","font-style","font-weight","id","opacity","preserveAspectRatio","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","transform","viewBox"],"text":["class","clip-path","clip-rule","fill","fill-opacity","fill-rule","filter","font-family","font-size","font-style","font-weight","id","mask","opacity","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","text-anchor","transform","x","xml:space","y"],"textPath":["class","id","method","requiredFeatures","spacing","startOffset","style","systemLanguage","transform","xlink:href"],"title":[],"tspan":["class","clip-path","clip-rule","dx","dy","fill","fill-opacity","fill-rule","filter","font-family","font-size","font-style","font-weight","id","mask","opacity","requiredFeatures","rotate","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","text-anchor","textLength","transform","x","xml:space","y"],"use":["class","clip-path","clip-rule","fill","fill-opacity","fill-rule","filter","height","id","mask","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","transform","width","x","xlink:href","y"],"annotation":["encoding"],"annotation-xml":["encoding"],"maction":["actiontype","other","selection"],"math":["class","id","display","xmlns"],"merror":[],"mfrac":["linethickness"],"mi":["mathvariant"],"mmultiscripts":[],"mn":[],"mo":["fence","lspace","maxsize","minsize","rspace","stretchy"],"mover":[],"mpadded":["lspace","width"],"mphantom":[],"mprescripts":[],"mroot":[],"mrow":["xlink:href","xlink:type","xmlns:xlink"],"mspace":["depth","height","width"],"msqrt":[],"mstyle":["displaystyle","mathbackground","mathcolor","mathvariant","scriptlevel"],"msub":[],"msubsup":[],"msup":[],"mtable":["align","columnalign","columnlines","columnspacing","displaystyle","equalcolumns","equalrows","frame","rowalign","rowlines","rowspacing","width"],"mtd":["columnalign","columnspan","rowalign","rowspan"],"mtext":[],"mtr":["columnalign","rowalign"],"munder":[],"munderover":[],"none":[],"semantics":[]},uiStrings={"pathNodeTooltip":"Drag node to move it. Double-click node to change segment type","pathCtrlPtTooltip":"Drag control point to adjust curve properties","exportNoBlur":"Blurred elements will appear as un-blurred","exportNoImage":"Image elements will not appear","exportNoforeignObject":"foreignObject elements will not appear","exportNoDashArray":"Strokes will appear filled","exportNoText":"Text may not appear as expected"},curConfig={show_outside_canvas:true,dimensions:[640,480]},toXml=function(str){return $('<p/>').text(str).html();},fromXml=function(str){return $('<p/>').html(str).text();};if(config){$.extend(curConfig,config);}
var unit_types={'em':0,'ex':0,'px':1,'cm':35.43307,'mm':3.543307,'in':90,'pt':1.25,'pc':15,'%':0};function ChangeElementCommand(elem,attrs,text){this.elem=elem;this.text=text?("Change "+elem.tagName+" "+text):("Change "+elem.tagName);this.newValues={};this.oldValues=attrs;for(var attr in attrs){if(attr=="#text")this.newValues[attr]=elem.textContent;else if(attr=="#href")this.newValues[attr]=elem.getAttributeNS(xlinkns,"href");else this.newValues[attr]=elem.getAttribute(attr);}
this.apply=function(){var bChangedTransform=false;for(var attr in this.newValues){if(this.newValues[attr]){if(attr=="#text")this.elem.textContent=this.newValues[attr];else if(attr=="#href")this.elem.setAttributeNS(xlinkns,"xlink:href",this.newValues[attr])
else this.elem.setAttribute(attr,this.newValues[attr]);}
else{if(attr=="#text")this.elem.textContent="";else{this.elem.setAttribute(attr,"");this.elem.removeAttribute(attr);}}
if(attr=="transform"){bChangedTransform=true;}
else if(attr=="stdDeviation"){canvas.setBlurOffsets(this.elem.parentNode,this.newValues[attr]);}}
if(!bChangedTransform){var angle=canvas.getRotationAngle(elem);if(angle){var bbox=elem.getBBox();var cx=bbox.x+bbox.width/2,cy=bbox.y+bbox.height/2;var rotate=["rotate(",angle," ",cx,",",cy,")"].join('');if(rotate!=elem.getAttribute("transform")){elem.setAttribute("transform",rotate);}}}
if(this.elem.tagName=="title"&&this.elem.parentNode.parentNode==svgcontent){identifyLayers();}
return true;};this.unapply=function(){var bChangedTransform=false;for(var attr in this.oldValues){if(this.oldValues[attr]){if(attr=="#text")this.elem.textContent=this.oldValues[attr];else if(attr=="#href")this.elem.setAttributeNS(xlinkns,"xlink:href",this.oldValues[attr]);else this.elem.setAttribute(attr,this.oldValues[attr]);if(attr=="stdDeviation")canvas.setBlurOffsets(this.elem.parentNode,this.oldValues[attr]);}
else{if(attr=="#text")this.elem.textContent="";else this.elem.removeAttribute(attr);}
if(attr=="transform"){bChangedTransform=true;}}
if(!bChangedTransform){var angle=canvas.getRotationAngle(elem);if(angle){var bbox=elem.getBBox();var cx=bbox.x+bbox.width/2,cy=bbox.y+bbox.height/2;var rotate=["rotate(",angle," ",cx,",",cy,")"].join('');if(rotate!=elem.getAttribute("transform")){elem.setAttribute("transform",rotate);}}}
if(this.elem.tagName=="title"&&this.elem.parentNode.parentNode==svgcontent){identifyLayers();}
if(svgTransformLists[this.elem.id]){delete svgTransformLists[this.elem.id];}
return true;};this.elements=function(){return[this.elem];}}
function InsertElementCommand(elem,text){this.elem=elem;this.text=text||("Create "+elem.tagName);this.parent=elem.parentNode;this.apply=function(){this.elem=this.parent.insertBefore(this.elem,this.elem.nextSibling);if(this.parent==svgcontent){identifyLayers();}};this.unapply=function(){this.parent=this.elem.parentNode;this.elem=this.elem.parentNode.removeChild(this.elem);if(this.parent==svgcontent){identifyLayers();}};this.elements=function(){return[this.elem];};}
function RemoveElementCommand(elem,parent,text){this.elem=elem;this.text=text||("Delete "+elem.tagName);this.parent=parent;this.apply=function(){if(svgTransformLists[this.elem.id]){delete svgTransformLists[this.elem.id];}
this.parent=this.elem.parentNode;this.elem=this.parent.removeChild(this.elem);if(this.parent==svgcontent){identifyLayers();}};this.unapply=function(){if(svgTransformLists[this.elem.id]){delete svgTransformLists[this.elem.id];}
this.elem=this.parent.insertBefore(this.elem,this.elem.nextSibling);if(this.parent==svgcontent){identifyLayers();}};this.elements=function(){return[this.elem];};if(svgTransformLists[elem.id]){delete svgTransformLists[elem.id];}}
function MoveElementCommand(elem,oldNextSibling,oldParent,text){this.elem=elem;this.text=text?("Move "+elem.tagName+" to "+text):("Move "+elem.tagName);this.oldNextSibling=oldNextSibling;this.oldParent=oldParent;this.newNextSibling=elem.nextSibling;this.newParent=elem.parentNode;this.apply=function(){this.elem=this.newParent.insertBefore(this.elem,this.newNextSibling);if(this.newParent==svgcontent){identifyLayers();}};this.unapply=function(){this.elem=this.oldParent.insertBefore(this.elem,this.oldNextSibling);if(this.oldParent==svgcontent){identifyLayers();}};this.elements=function(){return[this.elem];};}
function BatchCommand(text){this.text=text||"Batch Command";this.stack=[];this.apply=function(){var len=this.stack.length;for(var i=0;i<len;++i){this.stack[i].apply();}};this.unapply=function(){for(var i=this.stack.length-1;i>=0;i--){this.stack[i].unapply();}};this.elements=function(){var elems=[];var cmd=this.stack.length;while(cmd--){var thisElems=this.stack[cmd].elements();var elem=thisElems.length;while(elem--){if(elems.indexOf(thisElems[elem])==-1)elems.push(thisElems[elem]);}}
return elems;};this.addSubCommand=function(cmd){this.stack.push(cmd);};this.isEmpty=function(){return this.stack.length==0;};}
function Selector(id,elem){this.id=id;this.selectedElement=elem;this.locked=true;this.reset=function(e,update){this.locked=true;this.selectedElement=e;this.resize();this.selectorGroup.setAttribute("display","inline");};this.selectorGroup=addSvgElementFromJson({"element":"g","attr":{"id":("selectorGroup"+this.id)}});this.selectorRect=this.selectorGroup.appendChild(addSvgElementFromJson({"element":"path","attr":{"id":("selectedBox"+this.id),"fill":"none","stroke":"#22C","stroke-width":"1","stroke-dasharray":"5,5","style":"pointer-events:none"}}));this.selectorGrips={"nw":null,"n":null,"ne":null,"e":null,"se":null,"s":null,"sw":null,"w":null};this.rotateGripConnector=this.selectorGroup.appendChild(addSvgElementFromJson({"element":"line","attr":{"id":("selectorGrip_rotateconnector_"+this.id),"stroke":"#22C","stroke-width":"1"}}));this.rotateGrip=this.selectorGroup.appendChild(addSvgElementFromJson({"element":"circle","attr":{"id":("selectorGrip_rotate_"+this.id),"fill":"lime","r":4,"stroke":"#22C","stroke-width":2,"style":"cursor:url("+curConfig.imgPath+"rotate.png) 12 12, auto;"}}));for(var dir in this.selectorGrips){this.selectorGrips[dir]=this.selectorGroup.appendChild(addSvgElementFromJson({"element":"circle","attr":{"id":("selectorGrip_resize_"+dir+"_"+this.id),"fill":"#22C","r":4,"style":("cursor:"+dir+"-resize"),"stroke-width":2,"pointer-events":"all","display":"none"}}));}
this.showGrips=function(show){var bShow=show?"inline":"none";this.rotateGrip.setAttribute("display",bShow);this.rotateGripConnector.setAttribute("display",bShow);var elem=this.selectedElement;for(var dir in this.selectorGrips){this.selectorGrips[dir].setAttribute("display",bShow);}
if(elem)this.updateGripCursors(canvas.getRotationAngle(elem));};this.updateGripCursors=function(angle){var dir_arr=[];var steps=Math.round(angle/45);if(steps<0)steps+=8;for(var dir in this.selectorGrips){dir_arr.push(dir);}
while(steps>0){dir_arr.push(dir_arr.shift());steps--;}
var i=0;for(var dir in this.selectorGrips){this.selectorGrips[dir].setAttribute('style',("cursor:"+dir_arr[i]+"-resize"));i++;};};this.resize=function(){var selectedBox=this.selectorRect,selectedGrips=this.selectorGrips,selected=this.selectedElement,sw=selected.getAttribute("stroke-width");var offset=1/current_zoom;if(selected.getAttribute("stroke")!="none"&&!isNaN(sw)){offset+=(sw/2);}
if(selected.tagName=="text"){offset+=2/current_zoom;}
var bbox=canvas.getBBox(selected);if(selected.tagName=='g'){var stroked_bbox=canvas.getStrokedBBox(selected.childNodes);$.each(bbox,function(key,val){bbox[key]=stroked_bbox[key];});}
var m=getMatrix(selected);m.e*=current_zoom;m.f*=current_zoom;var l=bbox.x-offset,t=bbox.y-offset,w=bbox.width+(offset*2),h=bbox.height+(offset*2),bbox={x:l,y:t,width:w,height:h};var nbox=transformBox(l*current_zoom,t*current_zoom,w*current_zoom,h*current_zoom,m),nbax=nbox.aabox.x,nbay=nbox.aabox.y,nbaw=nbox.aabox.width,nbah=nbox.aabox.height;var cx=nbax+nbaw/2,cy=nbay+nbah/2;var angle=canvas.getRotationAngle(selected);if(angle){var rot=svgroot.createSVGTransform();rot.setRotate(-angle,cx,cy);var rotm=rot.matrix;nbox.tl=transformPoint(nbox.tl.x,nbox.tl.y,rotm);nbox.tr=transformPoint(nbox.tr.x,nbox.tr.y,rotm);nbox.bl=transformPoint(nbox.bl.x,nbox.bl.y,rotm);nbox.br=transformPoint(nbox.br.x,nbox.br.y,rotm);var minx=nbox.tl.x,miny=nbox.tl.y,maxx=nbox.tl.x,maxy=nbox.tl.y;minx=Math.min(minx,Math.min(nbox.tr.x,Math.min(nbox.bl.x,nbox.br.x)));miny=Math.min(miny,Math.min(nbox.tr.y,Math.min(nbox.bl.y,nbox.br.y)));maxx=Math.max(maxx,Math.max(nbox.tr.x,Math.max(nbox.bl.x,nbox.br.x)));maxy=Math.max(maxy,Math.max(nbox.tr.y,Math.max(nbox.bl.y,nbox.br.y)));nbax=minx;nbay=miny;nbaw=(maxx-minx);nbah=(maxy-miny);}
var sr_handle=svgroot.suspendRedraw(100);var dstr="M"+nbax+","+nbay
+" L"+(nbax+nbaw)+","+nbay
+" "+(nbax+nbaw)+","+(nbay+nbah)
+" "+nbax+","+(nbay+nbah)+"z";assignAttributes(selectedBox,{'d':dstr});var gripCoords={nw:[nbax,nbay],ne:[nbax+nbaw,nbay],sw:[nbax,nbay+nbah],se:[nbax+nbaw,nbay+nbah],n:[nbax+(nbaw)/2,nbay],w:[nbax,nbay+(nbah)/2],e:[nbax+nbaw,nbay+(nbah)/2],s:[nbax+(nbaw)/2,nbay+nbah]};if(selected==selectedElements[0]){for(var dir in gripCoords){var coords=gripCoords[dir];assignAttributes(selectedGrips[dir],{cx:coords[0],cy:coords[1]});};}
if(angle){this.selectorGroup.setAttribute("transform","rotate("+[angle,cx,cy].join(",")+")");}
else{this.selectorGroup.setAttribute("transform","");}
assignAttributes(this.rotateGripConnector,{x1:nbax+(nbaw)/2,y1:nbay,x2:nbax+(nbaw)/2,y2:nbay-20});assignAttributes(this.rotateGrip,{cx:nbax+(nbaw)/2,cy:nbay-20});svgroot.unsuspendRedraw(sr_handle);};this.reset(elem);};function SelectorManager(){this.selectorParentGroup=null;this.rubberBandBox=null;this.selectors=[];this.selectorMap={};var mgr=this;this.initGroup=function(){if(mgr.selectorParentGroup&&mgr.selectorParentGroup.parentNode){mgr.selectorParentGroup.parentNode.removeChild(mgr.selectorParentGroup);}
mgr.selectorParentGroup=svgdoc.createElementNS(svgns,"g");mgr.selectorParentGroup.setAttribute("id","selectorParentGroup");svgroot.appendChild(mgr.selectorParentGroup);mgr.selectorMap={};mgr.selectors=[];mgr.rubberBandBox=null;if($("#canvasBackground").length)return;var canvasbg=svgdoc.createElementNS(svgns,"svg");var dims=curConfig.dimensions;assignAttributes(canvasbg,{'id':'canvasBackground','width':dims[0],'height':dims[1],'x':0,'y':0,'overflow':'visible','style':'pointer-events:none'});var rect=svgdoc.createElementNS(svgns,"rect");assignAttributes(rect,{'width':'100%','height':'100%','x':0,'y':0,'stroke-width':1,'stroke':'#000','fill':'#FFF','style':'pointer-events:none'});canvasbg.appendChild(rect);svgroot.insertBefore(canvasbg,svgcontent);};this.requestSelector=function(elem){if(elem==null)return null;var N=this.selectors.length;if(typeof(this.selectorMap[elem.id])=="object"){this.selectorMap[elem.id].locked=true;return this.selectorMap[elem.id];}
for(var i=0;i<N;++i){if(this.selectors[i]&&!this.selectors[i].locked){this.selectors[i].locked=true;this.selectors[i].reset(elem);this.selectorMap[elem.id]=this.selectors[i];return this.selectors[i];}}
this.selectors[N]=new Selector(N,elem);this.selectorParentGroup.appendChild(this.selectors[N].selectorGroup);this.selectorMap[elem.id]=this.selectors[N];return this.selectors[N];};this.releaseSelector=function(elem){if(elem==null)return;var N=this.selectors.length,sel=this.selectorMap[elem.id];for(var i=0;i<N;++i){if(this.selectors[i]&&this.selectors[i]==sel){if(sel.locked==false){console.log("WARNING! selector was released but was already unlocked");}
delete this.selectorMap[elem.id];sel.locked=false;sel.selectedElement=null;sel.showGrips(false);try{sel.selectorGroup.setAttribute("display","none");}catch(e){}
break;}}};this.getRubberBandBox=function(){if(this.rubberBandBox==null){this.rubberBandBox=this.selectorParentGroup.appendChild(addSvgElementFromJson({"element":"rect","attr":{"id":"selectorRubberBand","fill":"#22C","fill-opacity":0.15,"stroke":"#22C","stroke-width":0.5,"display":"none","style":"pointer-events:none"}}));}
return this.rubberBandBox;};this.initGroup();}
var svgTransformLists={};var SVGEditTransformList=function(elem){this._elem=elem||null;this._xforms=[];this._update=function(){var tstr="";var concatMatrix=svgroot.createSVGMatrix();for(var i=0;i<this.numberOfItems;++i){var xform=this._list.getItem(i);tstr+=transformToObj(xform).text+" ";}
this._elem.setAttribute("transform",tstr);};this._list=this;this._init=function(){var str=this._elem.getAttribute("transform");if(!str)return;var re=/\s*((scale|matrix|rotate|translate)\s*\(.*?\))\s*,?\s*/;var arr=[];var m=true;while(m){m=str.match(re);str=str.replace(re,'');if(m&&m[1]){var x=m[1];var bits=x.split(/\s*\(/);var name=bits[0];var val_bits=bits[1].match(/\s*(.*?)\s*\)/);var val_arr=val_bits[1].split(/[, ]+/);var letters='abcdef'.split('');var mtx=svgroot.createSVGMatrix();$.each(val_arr,function(i,item){val_arr[i]=parseFloat(item);if(name=='matrix'){mtx[letters[i]]=val_arr[i];}});var xform=svgroot.createSVGTransform();var fname='set'+name.charAt(0).toUpperCase()+name.slice(1);var values=name=='matrix'?[mtx]:val_arr;xform[fname].apply(xform,values);this._list.appendItem(xform);}}}
this.numberOfItems=0;this.clear=function(){this.numberOfItems=0;this._xforms=[];};this.initialize=function(newItem){this.numberOfItems=1;this._xforms=[newItem];};this.getItem=function(index){if(index<this.numberOfItems&&index>=0){return this._xforms[index];}
return null;};this.insertItemBefore=function(newItem,index){var retValue=null;if(index>=0){if(index<this.numberOfItems){var newxforms=new Array(this.numberOfItems+1);for(var i=0;i<index;++i){newxforms[i]=this._xforms[i];}
newxforms[i]=newItem;for(var j=i+1;i<this.numberOfItems;++j,++i){newxforms[j]=this._xforms[i];}
this.numberOfItems++;this._xforms=newxforms;retValue=newItem;this._list._update();}
else{retValue=this._list.appendItem(newItem);}}
return retValue;};this.replaceItem=function(newItem,index){var retValue=null;if(index<this.numberOfItems&&index>=0){this._xforms[index]=newItem;retValue=newItem;this._list._update();}
return retValue;};this.removeItem=function(index){var retValue=null;if(index<this.numberOfItems&&index>=0){var retValue=this._xforms[index];var newxforms=new Array(this.numberOfItems-1);for(var i=0;i<index;++i){newxforms[i]=this._xforms[i];}
for(var j=i;j<this.numberOfItems-1;++j,++i){newxforms[j]=this._xforms[i+1];}
this.numberOfItems--;this._xforms=newxforms;this._list._update();}
return retValue;};this.appendItem=function(newItem){this._xforms.push(newItem);this.numberOfItems++;this._list._update();return newItem;};};var addSvgElementFromJson=function(data){return canvas.updateElementFromJson(data)};var canvas=this,svgns="http://www.w3.org/2000/svg",xlinkns="http://www.w3.org/1999/xlink",xmlns="http://www.w3.org/XML/1998/namespace",xmlnsns="http://www.w3.org/2000/xmlns/",se_ns="http://svg-edit.googlecode.com",htmlns="http://www.w3.org/1999/xhtml",mathns="http://www.w3.org/1998/Math/MathML",idprefix="svg_",svgdoc=container.ownerDocument,dimensions=curConfig.dimensions,svgroot=svgdoc.importNode(Utils.text2xml('<svg id="svgroot" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" '+'width="'+dimensions[0]+'" height="'+dimensions[1]+'" x="'+dimensions[0]+'" y="'+dimensions[1]+'" overflow="visible">'+'<defs>'+'<filter id="canvashadow" filterUnits="objectBoundingBox">'+'<feGaussianBlur in="SourceAlpha" stdDeviation="4" result="blur"/>'+'<feOffset in="blur" dx="5" dy="5" result="offsetBlur"/>'+'<feMerge>'+'<feMergeNode in="offsetBlur"/>'+'<feMergeNode in="SourceGraphic"/>'+'</feMerge>'+'</filter>'+'</defs>'+'</svg>').documentElement,true);$(svgroot).appendTo(container);var opac_ani=document.createElementNS(svgns,'animate');$(opac_ani).attr({attributeName:'opacity',begin:'indefinite',dur:1,fill:'freeze'}).appendTo(svgroot);var nonce=Math.floor(Math.random()*100001);var randomize_ids=false;var nsMap={};nsMap[xlinkns]='xlink';nsMap[xmlns]='xml';nsMap[xmlnsns]='xmlns';nsMap[se_ns]='se';nsMap[htmlns]='xhtml';nsMap[mathns]='mathml';var nsRevMap={};$.each(nsMap,function(key,value){nsRevMap[value]=key;});var svgWhiteListNS={};$.each(svgWhiteList,function(elt,atts){var attNS={};$.each(atts,function(i,att){if(att.indexOf(':')!=-1){var v=att.split(':');attNS[v[1]]=nsRevMap[v[0]];}else{attNS[att]=att=='xmlns'?xmlnsns:null;}});svgWhiteListNS[elt]=attNS;});var svgcontent=svgdoc.createElementNS(svgns,"svg");$(svgcontent).attr({id:'svgcontent',width:dimensions[0],height:dimensions[1],x:dimensions[0],y:dimensions[1],overflow:curConfig.show_outside_canvas?'visible':'hidden',xmlns:svgns,"xmlns:se":se_ns,"xmlns:xlink":xlinkns}).appendTo(svgroot);if(randomize_ids)svgcontent.setAttributeNS(se_ns,'se:nonce',nonce);var convertToNum,convertToUnit,setUnitAttr;(function(){var w_attrs=['x','x1','cx','rx','width'];var h_attrs=['y','y1','cy','ry','height'];var unit_attrs=$.merge(['r','radius'],w_attrs);$.merge(unit_attrs,h_attrs);convertToNum=function(attr,val){if(!isNaN(val))return val-0;if(val.substr(-1)==='%'){var num=val.substr(0,val.length-1)/100;var res=canvas.getResolution();if($.inArray(attr,w_attrs)!==-1){return num*res.w;}else if($.inArray(attr,h_attrs)!==-1){return num*res.h;}else{return num*Math.sqrt((res.w*res.w)+(res.h*res.h))/Math.sqrt(2);}}else{var unit=val.substr(-2);var num=val.substr(0,val.length-2);return num*unit_types[unit];}};setUnitAttr=function(elem,attr,val){if(!isNaN(val)){var old_val=elem.getAttribute(attr);if(old_val!==null&&isNaN(old_val)){var unit;if(old_val.substr(-1)==='%'){var res=canvas.getResolution();unit='%';val*=100;if($.inArray(attr,w_attrs)!==-1){val=val/res.w;}else if($.inArray(attr,h_attrs)!==-1){val=val/res.h;}else{return val/Math.sqrt((res.w*res.w)+(res.h*res.h))/Math.sqrt(2);}}else{unit=old_val.substr(-2);val=val/unit_types[unit];}
val+=unit;}}
elem.setAttribute(attr,val);}
canvas.isValidUnit=function(attr,val){var valid=false;if($.inArray(attr,unit_attrs)!=-1){if(!isNaN(val)){valid=true;}else{val=val.toLowerCase();$.each(unit_types,function(unit){if(valid)return;var re=new RegExp('^-?[\\d\\.]+'+unit+'$');if(re.test(val))valid=true;});}}else if(attr=="id"){var result=false;try{var elem=getElem(val);result=(elem==null);}catch(e){}
return result;}else valid=true;return valid;}})();var assignAttributes=function(node,attrs,suspendLength,unitCheck){if(!suspendLength)suspendLength=0;var handle=null;if(!window.opera)svgroot.suspendRedraw(suspendLength);for(var i in attrs){var ns=(i.substr(0,4)=="xml:"?xmlns:i.substr(0,6)=="xlink:"?xlinkns:null);if(ns||!unitCheck){node.setAttributeNS(ns,i,attrs[i]);}else{setUnitAttr(node,i,attrs[i]);}}
if(!window.opera)svgroot.unsuspendRedraw(handle);};var cleanupElement=function(element){var handle=svgroot.suspendRedraw(60);var defaults={'fill-opacity':1,'stop-opacity':1,'opacity':1,'stroke':'none','stroke-dasharray':'none','stroke-linejoin':'miter','stroke-linecap':'butt','stroke-opacity':1,'stroke-width':1,'rx':0,'ry':0}
for(var attr in defaults){var val=defaults[attr];if(element.getAttribute(attr)==val){element.removeAttribute(attr);}}
svgroot.unsuspendRedraw(handle);};this.updateElementFromJson=function(data){var shape=getElem(data.attr.id);if(shape&&data.element!=shape.tagName){current_layer.removeChild(shape);shape=null;}
if(!shape){shape=svgdoc.createElementNS(svgns,data.element);if(current_layer){current_layer.appendChild(shape);}}
if(data.curStyles){assignAttributes(shape,{"fill":cur_shape.fill,"stroke":cur_shape.stroke,"stroke-width":cur_shape.stroke_width,"stroke-dasharray":cur_shape.stroke_dasharray,"stroke-linejoin":cur_shape.stroke_linejoin,"stroke-linecap":cur_shape.stroke_linecap,"stroke-opacity":cur_shape.stroke_opacity,"fill-opacity":cur_shape.fill_opacity,"opacity":cur_shape.opacity/2,"style":"pointer-events:inherit"},100);}
assignAttributes(shape,data.attr,100);cleanupElement(shape);return shape;};(function(){var comment=svgdoc.createComment(" Created with SVG-edit - http://svg-edit.googlecode.com/ ");svgcontent.appendChild(comment);})();var all_layers=[],encodableImages={},last_good_img_url=curConfig.imgPath+'logo.png',current_layer=null,save_options={round_digits:5},started=false,obj_num=1,start_transform=null,current_mode="select",current_resize_mode="none",all_properties={shape:{fill:"#"+curConfig.initFill.color,fill_paint:null,fill_opacity:curConfig.initFill.opacity,stroke:"#"+curConfig.initStroke.color,stroke_paint:null,stroke_opacity:curConfig.initStroke.opacity,stroke_width:curConfig.initStroke.width,stroke_dasharray:'none',stroke_linejoin:'miter',stroke_linecap:'butt',opacity:curConfig.initOpacity}};all_properties.text=$.extend(true,{},all_properties.shape);$.extend(all_properties.text,{fill:"#000000",stroke_width:0,font_size:24,font_family:'serif'});var cur_shape=all_properties.shape,cur_text=all_properties.text,cur_properties=cur_shape,current_zoom=1,selectedElements=new Array(1),selectedBBoxes=new Array(1),justSelected=null,selectorManager=new SelectorManager(),rubberBox=null,events={},undoStackPointer=0,undoStack=[],curBBoxes=[],extensions={};var runExtensions=this.runExtensions=function(action,vars,returnArray){var result=false;if(returnArray)result=[];$.each(extensions,function(name,opts){if(action in opts){if(returnArray){result.push(opts[action](vars))}else{result=opts[action](vars);}}});return result;}
var round=function(val){return parseInt(val*current_zoom)/current_zoom;};var getIntersectionList=function(rect){if(rubberBox==null){return null;}
if(!curBBoxes.length){curBBoxes=canvas.getVisibleElements(current_layer,true);}
var resultList=null;try{resultList=current_layer.getIntersectionList(rect,null);}catch(e){}
if(resultList==null||typeof(resultList.item)!="function"){resultList=[];var rubberBBox=rubberBox.getBBox();$.each(rubberBBox,function(key,val){rubberBBox[key]=val/current_zoom;});var i=curBBoxes.length;while(i--){if(!rubberBBox.width||!rubberBBox.width)continue;if(Utils.rectsIntersect(rubberBBox,curBBoxes[i].bbox)){resultList.push(curBBoxes[i].elem);}}}
return resultList;};var addCommandToHistory=function(cmd){if(undoStackPointer<undoStack.length&&undoStack.length>0){undoStack=undoStack.splice(0,undoStackPointer);}
undoStack.push(cmd);undoStackPointer=undoStack.length;};this.getHistoryPosition=function(){return undoStackPointer;};var getId=function(){if(events["getid"])return call("getid",obj_num);if(randomize_ids){return idprefix+nonce+'_'+obj_num;}else{return idprefix+obj_num;}};var getNextId=function(){var id=getId();while(getElem(id)){obj_num++;id=getId();}
return id;};var call=function(event,arg){if(events[event]){return events[event](this,arg);}};var sanitizeSvg=function(node){if(node.nodeType==3){node.nodeValue=node.nodeValue.replace(/^\s+|\s+$/g,"");if(!node.nodeValue.length)node.parentNode.removeChild(node);}
if(node.nodeType!=1)return;var doc=node.ownerDocument;var parent=node.parentNode;if(!doc||!parent)return;var allowedAttrs=svgWhiteList[node.nodeName];var allowedAttrsNS=svgWhiteListNS[node.nodeName];if(allowedAttrs!=undefined){var se_attrs=[];var i=node.attributes.length;while(i--){var attr=node.attributes.item(i);var attrName=attr.nodeName;var attrLocalName=attr.localName;var attrNsURI=attr.namespaceURI;if(!(allowedAttrsNS.hasOwnProperty(attrLocalName)&&attrNsURI==allowedAttrsNS[attrLocalName]&&attrNsURI!=xmlnsns)&&!(attrNsURI==xmlnsns&&nsMap[attr.nodeValue]))
{if(attrName.indexOf('se:')==0){se_attrs.push([attrName,attr.nodeValue]);}
node.removeAttributeNS(attrNsURI,attrLocalName);}
if(node.nodeName=='path'&&attrName=='d'){node.setAttribute('d',pathActions.convertPath(node));pathActions.fixEnd(node);}
if(attrName=="style"){var props=attr.nodeValue.split(";"),p=props.length;while(p--){var nv=props[p].split(":");if(allowedAttrs.indexOf(nv[0])!=-1){node.setAttribute(nv[0],nv[1]);}}
node.removeAttribute('style');}}
$.each(se_attrs,function(i,attr){node.setAttributeNS(se_ns,attr[0],attr[1]);});var href=node.getAttributeNS(xlinkns,"href");if(href&&$.inArray(node.nodeName,["filter","linearGradient","pattern","radialGradient","textPath","use"])!=-1)
{if(href[0]!="#"){node.setAttributeNS(xlinkns,"xlink:href","");node.removeAttributeNS(xlinkns,"href");}}
if(node.nodeName=="use"&&!node.getAttributeNS(xlinkns,"href")){parent.removeChild(node);return;}
$.each(["clip-path","fill","filter","mask","stroke"],function(i,attr){var val=node.getAttribute(attr);if(val){val=getUrlFromAttr(val);if(val&&val[0]!="#"){node.setAttribute(attr,"");node.removeAttribute(attr);}}});i=node.childNodes.length;while(i--){sanitizeSvg(node.childNodes.item(i));}}
else{var children=[];while(node.hasChildNodes()){children.push(parent.insertBefore(node.firstChild,node));}
parent.removeChild(node);var i=children.length;while(i--){sanitizeSvg(children[i]);}}};this.getUrlFromAttr=function(attrVal){if(attrVal){if(attrVal.indexOf('url("')==0){return attrVal.substring(5,attrVal.indexOf('"',6));}
else if(attrVal.indexOf("url('")==0){return attrVal.substring(5,attrVal.indexOf("'",6));}
else if(attrVal.indexOf("url(")==0){return attrVal.substring(4,attrVal.indexOf(')'));}}
return null;};var getUrlFromAttr=this.getUrlFromAttr;var removeUnusedDefElems=function(){var defs=svgcontent.getElementsByTagNameNS(svgns,"defs");if(!defs||!defs.length)return 0;var defelem_uses=[],numRemoved=0;var attrs=['fill','stroke','filter','marker-start','marker-mid','marker-end'];var alen=attrs.length;var all_els=svgcontent.getElementsByTagNameNS(svgns,'*');var all_len=all_els.length;for(var i=0;i<all_len;i++){var el=all_els[i];for(var j=0;j<alen;j++){var ref=getUrlFromAttr(el.getAttribute(attrs[j]));if(ref){var strippedRef=ref.match(/^http.*(#.*)/i);if(strippedRef){ref=strippedRef[1];}}
if(ref)defelem_uses.push(ref.substr(1));}
var href=el.getAttributeNS(xlinkns,"href");if(href&&href.indexOf('#')==0){defelem_uses.push(href.substr(1));}};var defelems=$(svgcontent).find("linearGradient, radialGradient, filter, marker");defelem_ids=[],i=defelems.length;while(i--){var defelem=defelems[i];var id=defelem.id;if($.inArray(id,defelem_uses)==-1){defelem.parentNode.removeChild(defelem);numRemoved++;}}
var i=defs.length;while(i--){var def=defs[i];if(!def.getElementsByTagNameNS(svgns,'*').length){def.parentNode.removeChild(def);}}
return numRemoved;}
var svgCanvasToString=function(){while(removeUnusedDefElems()>0){};pathActions.clear(true);$.each(svgcontent.childNodes,function(i,node){if(i&&node.nodeType==8&&node.data.indexOf('Created with')!=-1){svgcontent.insertBefore(node,svgcontent.firstChild);}});var output=svgToString(svgcontent,0);return output;}
var svgToString=function(elem,indent){var out=new Array();if(elem){cleanupElement(elem);var attrs=elem.attributes,attr,i,childs=elem.childNodes;for(var i=0;i<indent;i++)out.push(" ");out.push("<");out.push(elem.nodeName);if(elem.id=='svgcontent'){var res=canvas.getResolution();out.push(' width="'+res.w+'" height="'+res.h+'" xmlns="'+svgns+'"');var nsuris={};$(elem).find('*').andSelf().each(function(){var el=this;$.each(this.attributes,function(i,attr){var uri=attr.namespaceURI;if(uri&&!nsuris[uri]&&nsMap[uri]!=='xmlns'&&nsMap[uri]!=='xml'){nsuris[uri]=true;out.push(" xmlns:"+nsMap[uri]+'="'+uri+'"');}});});var i=attrs.length;while(i--){attr=attrs.item(i);var attrVal=toXml(attr.nodeValue);if(attr.nodeName.indexOf('xmlns:')===0)continue;if(attrVal!=""&&$.inArray(attr.localName,['width','height','xmlns','x','y','viewBox','id','overflow'])==-1)
{if(!attr.namespaceURI||nsMap[attr.namespaceURI]){out.push(' ');out.push(attr.nodeName);out.push("=\"");out.push(attrVal);out.push("\"");}}}}else{for(var i=attrs.length-1;i>=0;i--){attr=attrs.item(i);var attrVal=toXml(attr.nodeValue);if($.inArray(attr.localName,['-moz-math-font-style','_moz-math-font-style'])!==-1)continue;if(attrVal!=""){if(attrVal.indexOf('pointer-events')==0)continue;if(attr.localName=="class"&&attrVal.indexOf('se_')==0)continue;out.push(" ");if(attr.localName=='d')attrVal=pathActions.convertPath(elem,true);if(!isNaN(attrVal)){attrVal=shortFloat(attrVal);}
if(save_options.apply&&elem.nodeName=='image'&&attr.localName=='href'&&save_options.images&&save_options.images=='embed')
{var img=encodableImages[attrVal];if(img)attrVal=img;}
if(!attr.namespaceURI||attr.namespaceURI==svgns||nsMap[attr.namespaceURI]){out.push(attr.nodeName);out.push("=\"");out.push(attrVal);out.push("\"");}}}}
if(elem.hasChildNodes()){out.push(">");indent++;var bOneLine=false;for(var i=0;i<childs.length;i++)
{var child=childs.item(i);switch(child.nodeType){case 1:out.push("\n");out.push(svgToString(childs.item(i),indent));break;case 3:var str=child.nodeValue.replace(/^\s+|\s+$/g,"");if(str!=""){bOneLine=true;out.push(toXml(str)+"");}
break;case 8:out.push("\n");out.push(new Array(indent+1).join(" "));out.push("<!--");out.push(child.data);out.push("-->");break;}}
indent--;if(!bOneLine){out.push("\n");for(var i=0;i<indent;i++)out.push(" ");}
out.push("</");out.push(elem.nodeName);out.push(">");}else{out.push("/>");}}
return out.join('');};this.embedImage=function(val,callback){$(new Image()).load(function(){var canvas=document.createElement("canvas");canvas.width=this.width;canvas.height=this.height;canvas.getContext("2d").drawImage(this,0,0);try{var urldata=';svgedit_url='+encodeURIComponent(val);urldata=canvas.toDataURL().replace(';base64',urldata+';base64');encodableImages[val]=urldata;}catch(e){encodableImages[val]=false;}
last_good_img_url=val;if(callback)callback(encodableImages[val]);}).attr('src',val);}
this.fixOperaXML=function(elem,orig_el){var x_attrs=elem.attributes;$.each(x_attrs,function(i,attr){if(attr.nodeValue.indexOf(',')==-1)return;var ns=attr.prefix=='xlink'?xlinkns:attr.prefix=="xml"?xmlns:null;var good_attrval=orig_el.getAttribute(attr.localName);if(ns){elem.setAttributeNS(ns,attr.nodeName,good_attrval);}else{elem.setAttribute(attr.nodeName,good_attrval);}});var childs=elem.childNodes;var o_childs=orig_el.childNodes;$.each(childs,function(i,child){if(child.nodeType==1){canvas.fixOperaXML(child,o_childs[i]);}});}
var recalculateAllSelectedDimensions=function(){var text=(current_resize_mode=="none"?"position":"size");var batchCmd=new BatchCommand(text);var i=selectedElements.length;while(i--){var elem=selectedElements[i];var cmd=recalculateDimensions(elem);if(cmd){batchCmd.addSubCommand(cmd);}}
if(!batchCmd.isEmpty()){addCommandToHistory(batchCmd);call("changed",selectedElements);}};var pathMap=[0,'z','M','m','L','l','C','c','Q','q','A','a','H','h','V','v','S','s','T','t'];var logMatrix=function(m){console.log([m.a,m.b,m.c,m.d,m.e,m.f]);};var remapElement=function(selected,changes,m){var remap=function(x,y){return transformPoint(x,y,m);},scalew=function(w){return m.a*w;},scaleh=function(h){return m.d*h;},box=canvas.getBBox(selected);switch(selected.tagName)
{case"line":var pt1=remap(changes["x1"],changes["y1"]),pt2=remap(changes["x2"],changes["y2"]);changes["x1"]=pt1.x;changes["y1"]=pt1.y;changes["x2"]=pt2.x;changes["y2"]=pt2.y;break;case"circle":var c=remap(changes["cx"],changes["cy"]);changes["cx"]=c.x;changes["cy"]=c.y;var tbox=transformBox(box.x,box.y,box.width,box.height,m);var w=tbox.tr.x-tbox.tl.x,h=tbox.bl.y-tbox.tl.y;changes["r"]=Math.min(w/2,h/2);break;case"ellipse":var c=remap(changes["cx"],changes["cy"]);changes["cx"]=c.x;changes["cy"]=c.y;changes["rx"]=scalew(changes["rx"]);changes["ry"]=scaleh(changes["ry"]);break;case"foreignObject":case"rect":case"image":var pt1=remap(changes["x"],changes["y"]);changes["x"]=pt1.x;changes["y"]=pt1.y;changes["width"]=scalew(changes["width"]);changes["height"]=scaleh(changes["height"]);break;case"use":var pt1=remap(changes["x"],changes["y"]);changes["x"]=pt1.x;changes["y"]=pt1.y;break;case"text":if(m.a==1&&m.b==0&&m.c==0&&m.d==1&&(m.e!=0||m.f!=0))
{var existing=transformListToTransform(selected).matrix,t_new=matrixMultiply(existing.inverse(),m,existing);changes["x"]=parseFloat(changes["x"])+t_new.e;changes["y"]=parseFloat(changes["y"])+t_new.f;}
else{var chlist=canvas.getTransformList(selected);var mt=svgroot.createSVGTransform();mt.setMatrix(matrixMultiply(transformListToTransform(chlist).matrix,m));chlist.clear();chlist.appendItem(mt);}
break;case"polygon":case"polyline":var len=changes["points"].length;for(var i=0;i<len;++i){var pt=changes["points"][i];pt=remap(pt.x,pt.y);changes["points"][i].x=pt.x;changes["points"][i].y=pt.y;}
break;case"path":var segList=selected.pathSegList;var len=segList.numberOfItems;changes.d=new Array(len);for(var i=0;i<len;++i){var seg=segList.getItem(i);changes.d[i]={type:seg.pathSegType,x:seg.x,y:seg.y,x1:seg.x1,y1:seg.y1,x2:seg.x2,y2:seg.y2,r1:seg.r1,r2:seg.r2,angle:seg.angle,largeArcFlag:seg.largeArcFlag,sweepFlag:seg.sweepFlag};}
var len=changes["d"].length,firstseg=changes["d"][0],currentpt=remap(firstseg.x,firstseg.y);changes["d"][0].x=currentpt.x;changes["d"][0].y=currentpt.y;for(var i=1;i<len;++i){var seg=changes["d"][i];var type=seg.type;if(type%2==0){var thisx=(seg.x!=undefined)?seg.x:currentpt.x,thisy=(seg.y!=undefined)?seg.y:currentpt.y,pt=remap(thisx,thisy),pt1=remap(seg.x1,seg.y1),pt2=remap(seg.x2,seg.y2);seg.x=pt.x;seg.y=pt.y;seg.x1=pt1.x;seg.y1=pt1.y;seg.x2=pt2.x;seg.y2=pt2.y;seg.r1=scalew(seg.r1),seg.r2=scaleh(seg.r2);}
else{seg.x=scalew(seg.x);seg.y=scaleh(seg.y);seg.x1=scalew(seg.x1);seg.y1=scaleh(seg.y1);seg.x2=scalew(seg.x2);seg.y2=scaleh(seg.y2);seg.r1=scalew(seg.r1),seg.r2=scaleh(seg.r2);}
if(seg.x)currentpt.x=seg.x;if(seg.y)currentpt.y=seg.y;}
break;}
switch(selected.tagName)
{case"foreignObject":case"rect":case"image":changes.x=changes.x-0+Math.min(0,changes.width);changes.y=changes.y-0+Math.min(0,changes.height);changes.width=Math.abs(changes.width);changes.height=Math.abs(changes.height);assignAttributes(selected,changes,1000,true);break;case"use":assignAttributes(selected,changes,1000,true);break;case"ellipse":changes.rx=Math.abs(changes.rx);changes.ry=Math.abs(changes.ry);case"circle":if(changes.r)changes.r=Math.abs(changes.r);case"line":case"text":assignAttributes(selected,changes,1000,true);break;case"polyline":case"polygon":var len=changes["points"].length;var pstr="";for(var i=0;i<len;++i){var pt=changes["points"][i];pstr+=pt.x+","+pt.y+" ";}
selected.setAttribute("points",pstr);break;case"path":var dstr="";var len=changes["d"].length;for(var i=0;i<len;++i){var seg=changes["d"][i];var type=seg.type;dstr+=pathMap[type];switch(type){case 13:case 12:dstr+=seg.x+" ";break;case 15:case 14:dstr+=seg.y+" ";break;case 3:case 5:case 19:case 2:case 4:case 18:dstr+=seg.x+","+seg.y+" ";break;case 7:case 6:dstr+=seg.x1+","+seg.y1+" "+seg.x2+","+seg.y2+" "+
seg.x+","+seg.y+" ";break;case 9:case 8:dstr+=seg.x1+","+seg.y1+" "+seg.x+","+seg.y+" ";break;case 11:case 10:dstr+=seg.r1+","+seg.r2+" "+seg.angle+" "+Number(seg.largeArcFlag)+" "+Number(seg.sweepFlag)+" "+seg.x+","+seg.y+" ";break;case 17:case 16:dstr+=seg.x2+","+seg.y2+" "+seg.x+","+seg.y+" ";break;}}
selected.setAttribute("d",dstr);break;}};var recalculateDimensions=function(selected){if(selected==null)return null;var tlist=canvas.getTransformList(selected);if(tlist&&tlist.numberOfItems>0){var k=tlist.numberOfItems;while(k--){var xform=tlist.getItem(k);if(xform.type==0){tlist.removeItem(k);}
else if(xform.type==1){if(isIdentity(xform.matrix)){tlist.removeItem(k);}}
else if(xform.type==4){if(xform.angle==0){tlist.removeItem(k);}}}
if(tlist.numberOfItems==1&&canvas.getRotationAngle(selected))return null;}
if(!tlist||tlist.numberOfItems==0){selected.removeAttribute("transform");return null;}
var batchCmd=new BatchCommand("Transform");var changes={},initial=null,attrs=[];switch(selected.tagName)
{case"line":attrs=["x1","y1","x2","y2"];break;case"circle":attrs=["cx","cy","r"];break;case"ellipse":attrs=["cx","cy","rx","ry"];break;case"foreignObject":case"rect":case"image":attrs=["width","height","x","y"];break;case"use":attrs=["x","y"];break;case"text":attrs=["x","y"];break;case"polygon":case"polyline":initial={};initial["points"]=selected.getAttribute("points");var list=selected.points;var len=list.numberOfItems;changes["points"]=new Array(len);for(var i=0;i<len;++i){var pt=list.getItem(i);changes["points"][i]={x:pt.x,y:pt.y};}
break;case"path":initial={};initial["d"]=selected.getAttribute("d");changes["d"]=selected.getAttribute("d");break;}
if(attrs.length){changes=$(selected).attr(attrs);$.each(changes,function(attr,val){changes[attr]=convertToNum(attr,val);});}
if(initial==null){initial=$.extend(true,{},changes);$.each(initial,function(attr,val){initial[attr]=convertToNum(attr,val);});}
initial["transform"]=start_transform?start_transform:"";if(selected.tagName=="g"||selected.tagName=="a"){var box=canvas.getBBox(selected),oldcenter={x:box.x+box.width/2,y:box.y+box.height/2},newcenter=transformPoint(box.x+box.width/2,box.y+box.height/2,transformListToTransform(tlist).matrix),m=svgroot.createSVGMatrix();var gangle=canvas.getRotationAngle(selected);if(gangle){var a=gangle*Math.PI/180;if(Math.abs(a)>(1.0e-10)){var s=Math.sin(a)/(1-Math.cos(a));}else{var s=2/a;}
for(var i=0;i<tlist.numberOfItems;++i){var xform=tlist.getItem(i);if(xform.type==4){var rm=xform.matrix;oldcenter.y=(s*rm.e+rm.f)/2;oldcenter.x=(rm.e-s*rm.f)/2;tlist.removeItem(i);break;}}}
var tx=0,ty=0,operation=0,N=tlist.numberOfItems;if(N){var first_m=tlist.getItem(0).matrix;}
if(N>=3&&tlist.getItem(N-2).type==3&&tlist.getItem(N-3).type==2&&tlist.getItem(N-1).type==2)
{operation=3;var tm=tlist.getItem(N-3).matrix,sm=tlist.getItem(N-2).matrix,tmn=tlist.getItem(N-1).matrix;var children=selected.childNodes;var c=children.length;while(c--){var child=children.item(c);tx=0;ty=0;if(child.nodeType==1){var childTlist=canvas.getTransformList(child);if(!childTlist)continue;var m=transformListToTransform(childTlist).matrix;var angle=canvas.getRotationAngle(child);var old_start_transform=start_transform;var childxforms=[];start_transform=child.getAttribute("transform");if(angle||hasMatrixTransform(childTlist)){var e2t=svgroot.createSVGTransform();e2t.setMatrix(matrixMultiply(tm,sm,tmn,m));childTlist.clear();childTlist.appendItem(e2t);childxforms.push(e2t);}
else{var t2n=matrixMultiply(m.inverse(),tmn,m);var t2=svgroot.createSVGMatrix();t2.e=-t2n.e;t2.f=-t2n.f;var s2=matrixMultiply(t2.inverse(),m.inverse(),tm,sm,tmn,m,t2n.inverse());var translateOrigin=svgroot.createSVGTransform(),scale=svgroot.createSVGTransform(),translateBack=svgroot.createSVGTransform();translateOrigin.setTranslate(t2n.e,t2n.f);scale.setScale(s2.a,s2.d);translateBack.setTranslate(t2.e,t2.f);childTlist.appendItem(translateBack);childTlist.appendItem(scale);childTlist.appendItem(translateOrigin);childxforms.push(translateBack);childxforms.push(scale);childxforms.push(translateOrigin);logMatrix(translateBack.matrix);logMatrix(scale.matrix);}
batchCmd.addSubCommand(recalculateDimensions(child));start_transform=old_start_transform;}}
tlist.removeItem(N-1);tlist.removeItem(N-2);tlist.removeItem(N-3);}
else if(N>=3&&tlist.getItem(N-1).type==1)
{operation=3;m=transformListToTransform(tlist).matrix;var e2t=svgroot.createSVGTransform();e2t.setMatrix(m);tlist.clear();tlist.appendItem(e2t);}
else if((N==1||(N>1&&tlist.getItem(1).type!=3))&&tlist.getItem(0).type==2)
{operation=2;var T_M=transformListToTransform(tlist).matrix;tlist.removeItem(0);var M_inv=transformListToTransform(tlist).matrix.inverse();var M2=matrixMultiply(M_inv,T_M);tx=M2.e;ty=M2.f;if(tx!=0||ty!=0){var children=selected.childNodes;var c=children.length;while(c--){var child=children.item(c);if(child.nodeType==1){var old_start_transform=start_transform;start_transform=child.getAttribute("transform");var childTlist=canvas.getTransformList(child);if(childTlist){var newxlate=svgroot.createSVGTransform();newxlate.setTranslate(tx,ty);childTlist.insertItemBefore(newxlate,0);batchCmd.addSubCommand(recalculateDimensions(child));var uses=selected.getElementsByTagNameNS(svgns,"use");var href="#"+child.id;var u=uses.length;while(u--){var useElem=uses.item(u);if(href==useElem.getAttributeNS(xlinkns,"href")){var usexlate=svgroot.createSVGTransform();usexlate.setTranslate(-tx,-ty);canvas.getTransformList(useElem).insertItemBefore(usexlate,0);batchCmd.addSubCommand(recalculateDimensions(useElem));}}
start_transform=old_start_transform;}}}
start_transform=old_start_transform;}}
else if(N==1&&tlist.getItem(0).type==1&&!gangle){operation=1;var m=tlist.getItem(0).matrix,children=selected.childNodes,c=children.length;while(c--){var child=children.item(c);if(child.nodeType==1){var old_start_transform=start_transform;start_transform=child.getAttribute("transform");var childTlist=canvas.getTransformList(child);var em=matrixMultiply(m,transformListToTransform(childTlist).matrix);var e2m=svgroot.createSVGTransform();e2m.setMatrix(em);childTlist.clear();childTlist.appendItem(e2m,0);batchCmd.addSubCommand(recalculateDimensions(child));start_transform=old_start_transform;}}
tlist.clear();}
else{if(gangle){var newRot=svgroot.createSVGTransform();newRot.setRotate(gangle,newcenter.x,newcenter.y);tlist.insertItemBefore(newRot,0);}
if(tlist.numberOfItems==0){selected.removeAttribute("transform");}
return null;}
if(operation==2){if(gangle){newcenter={x:oldcenter.x+first_m.e,y:oldcenter.y+first_m.f};var newRot=svgroot.createSVGTransform();newRot.setRotate(gangle,newcenter.x,newcenter.y);tlist.insertItemBefore(newRot,0);}}
else if(operation==3){var m=transformListToTransform(tlist).matrix;var roldt=svgroot.createSVGTransform();roldt.setRotate(gangle,oldcenter.x,oldcenter.y);var rold=roldt.matrix;var rnew=svgroot.createSVGTransform();rnew.setRotate(gangle,newcenter.x,newcenter.y);var rnew_inv=rnew.matrix.inverse(),m_inv=m.inverse(),extrat=matrixMultiply(m_inv,rnew_inv,rold,m);tx=extrat.e;ty=extrat.f;if(tx!=0||ty!=0){var children=selected.childNodes;var c=children.length;while(c--){var child=children.item(c);if(child.nodeType==1){var old_start_transform=start_transform;start_transform=child.getAttribute("transform");var childTlist=canvas.getTransformList(child);var newxlate=svgroot.createSVGTransform();newxlate.setTranslate(tx,ty);childTlist.insertItemBefore(newxlate,0);batchCmd.addSubCommand(recalculateDimensions(child));start_transform=old_start_transform;}}}
if(gangle){tlist.insertItemBefore(rnew,0);}}}
else{var box=canvas.getBBox(selected);if(!box)return null;var oldcenter={x:box.x+box.width/2,y:box.y+box.height/2},newcenter=transformPoint(box.x+box.width/2,box.y+box.height/2,transformListToTransform(tlist).matrix),m=svgroot.createSVGMatrix(),angle=canvas.getRotationAngle(selected);if(angle){var a=angle*Math.PI/180;if(Math.abs(a)>(1.0e-10)){var s=Math.sin(a)/(1-Math.cos(a));}else{var s=2/a;}
for(var i=0;i<tlist.numberOfItems;++i){var xform=tlist.getItem(i);if(xform.type==4){var rm=xform.matrix;oldcenter.y=(s*rm.e+rm.f)/2;oldcenter.x=(rm.e-s*rm.f)/2;tlist.removeItem(i);break;}}}
var operation=0;var N=tlist.numberOfItems;if(!isWebkit){var fill=selected.getAttribute('fill');if(fill&&fill.indexOf('url(')===0){var grad=getElem(getUrlFromAttr(fill).substr(1));if(grad.getAttribute('gradientUnits')==='userSpaceOnUse'){var grad=$(grad);m=transformListToTransform(tlist).matrix;var gtlist=canvas.getTransformList(grad[0]);var gmatrix=transformListToTransform(gtlist).matrix;m=matrixMultiply(m,gmatrix);var m_str="matrix("+[m.a,m.b,m.c,m.d,m.e,m.f].join(",")+")";grad.attr('gradientTransform',m_str);}}}
if(N>=3&&tlist.getItem(N-2).type==3&&tlist.getItem(N-3).type==2&&tlist.getItem(N-1).type==2&&selected.nodeName!="use")
{operation=3;m=transformListToTransform(tlist,N-3,N-1).matrix;tlist.removeItem(N-1);tlist.removeItem(N-2);tlist.removeItem(N-3);}
else if(N==4&&tlist.getItem(N-1).type==1){operation=3;m=transformListToTransform(tlist).matrix;var e2t=svgroot.createSVGTransform();e2t.setMatrix(m);tlist.clear();tlist.appendItem(e2t);m=svgroot.createSVGMatrix();}
else if((N==1||(N>1&&tlist.getItem(1).type!=3))&&tlist.getItem(0).type==2)
{operation=2;var oldxlate=tlist.getItem(0).matrix,meq=transformListToTransform(tlist,1).matrix,meq_inv=meq.inverse();m=matrixMultiply(meq_inv,oldxlate,meq);tlist.removeItem(0);}
else if(N==1&&tlist.getItem(0).type==1&&!angle){m=transformListToTransform(tlist).matrix;switch(selected.tagName){case'line':changes=$(selected).attr(["x1","y1","x2","y2"]);case'polyline':case'polygon':changes.points=selected.getAttribute("points");if(changes.points){var list=selected.points;var len=list.numberOfItems;changes.points=new Array(len);for(var i=0;i<len;++i){var pt=list.getItem(i);changes.points[i]={x:pt.x,y:pt.y};}}
case'path':changes.d=selected.getAttribute("d");operation=1;tlist.clear();break;default:break;}}
else{operation=4;if(angle){var newRot=svgroot.createSVGTransform();newRot.setRotate(angle,newcenter.x,newcenter.y);tlist.insertItemBefore(newRot,0);}
if(tlist.numberOfItems==0){selected.removeAttribute("transform");}
return null;}
if(operation==1||operation==2||operation==3){remapElement(selected,changes,m);}
if(operation==2){if(angle){newcenter={x:oldcenter.x+m.e,y:oldcenter.y+m.f};var newRot=svgroot.createSVGTransform();newRot.setRotate(angle,newcenter.x,newcenter.y);tlist.insertItemBefore(newRot,0);}}
else if(operation==3){var m=transformListToTransform(tlist).matrix;var roldt=svgroot.createSVGTransform();roldt.setRotate(angle,oldcenter.x,oldcenter.y);var rold=roldt.matrix;var rnew=svgroot.createSVGTransform();rnew.setRotate(angle,newcenter.x,newcenter.y);var rnew_inv=rnew.matrix.inverse();var m_inv=m.inverse();var extrat=matrixMultiply(m_inv,rnew_inv,rold,m);remapElement(selected,changes,extrat);if(angle){tlist.insertItemBefore(rnew,0);}}}
if(tlist.numberOfItems==0){selected.removeAttribute("transform");}
batchCmd.addSubCommand(new ChangeElementCommand(selected,initial));return batchCmd;};this.clearSelection=function(noCall){if(selectedElements[0]!=null){var len=selectedElements.length;for(var i=0;i<len;++i){var elem=selectedElements[i];if(elem==null)break;selectorManager.releaseSelector(elem);selectedElements[i]=null;}
selectedBBoxes[0]=null;}
if(!noCall)call("selected",selectedElements);};this.addToSelection=function(elemsToAdd,showGrips){if(elemsToAdd.length==0){return;}
var j=0;while(j<selectedElements.length){if(selectedElements[j]==null){break;}
++j;}
var i=elemsToAdd.length;while(i--){var elem=elemsToAdd[i];if(!elem||!this.getBBox(elem))continue;if(selectedElements.indexOf(elem)==-1){selectedElements[j]=elem;if(j==0)selectedBBoxes[j]=this.getBBox(elem);j++;var sel=selectorManager.requestSelector(elem);if(selectedElements.length>1){sel.showGrips(false);}}}
if(selectedElements[0]&&selectedElements.length===1&&selectedElements[0].tagName=='a'){selectedElements[0]=selectedElements[0].firstChild;}
call("selected",selectedElements);if(showGrips||selectedElements.length==1){selectorManager.requestSelector(selectedElements[0]).showGrips(true);}
else{selectorManager.requestSelector(selectedElements[0]).showGrips(false);}
selectedElements.sort(function(a,b){if(a&&b&&a.compareDocumentPosition){return 3-(b.compareDocumentPosition(a)&6);}else if(a==null){return 1;}});while(selectedElements[0]==null)selectedElements.shift(0);};this.removeFromSelection=function(elemsToRemove){if(selectedElements[0]==null){return;}
if(elemsToRemove.length==0){return;}
var newSelectedItems=new Array(selectedElements.length),newSelectedBBoxes=new Array(selectedBBoxes.length),j=0,len=selectedElements.length;for(var i=0;i<len;++i){var elem=selectedElements[i];if(elem){if(elemsToRemove.indexOf(elem)==-1){newSelectedItems[j]=elem;if(j==0)newSelectedBBoxes[j]=selectedBBoxes[i];j++;}
else{selectorManager.releaseSelector(elem);}}}
selectedElements=newSelectedItems;selectedBBoxes=newSelectedBBoxes;};var root_sctm=null;var transformPoint=function(x,y,m){return{x:m.a*x+m.c*y+m.e,y:m.b*x+m.d*y+m.f};};var isIdentity=function(m){return(m.a==1&&m.b==0&&m.c==0&&m.d==1&&m.e==0&&m.f==0);}
this.smoothControlPoints=function(ct1,ct2,pt){var x1=ct1.x-pt.x,y1=ct1.y-pt.y,x2=ct2.x-pt.x,y2=ct2.y-pt.y;if((x1!=0||y1!=0)&&(x2!=0||y2!=0)){var anglea=Math.atan2(y1,x1),angleb=Math.atan2(y2,x2),r1=Math.sqrt(x1*x1+y1*y1),r2=Math.sqrt(x2*x2+y2*y2),nct1=svgroot.createSVGPoint(),nct2=svgroot.createSVGPoint();if(anglea<0){anglea+=2*Math.PI;}
if(angleb<0){angleb+=2*Math.PI;}
var angleBetween=Math.abs(anglea-angleb),angleDiff=Math.abs(Math.PI-angleBetween)/2;var new_anglea,new_angleb;if(anglea-angleb>0){new_anglea=angleBetween<Math.PI?(anglea+angleDiff):(anglea-angleDiff);new_angleb=angleBetween<Math.PI?(angleb-angleDiff):(angleb+angleDiff);}
else{new_anglea=angleBetween<Math.PI?(anglea-angleDiff):(anglea+angleDiff);new_angleb=angleBetween<Math.PI?(angleb+angleDiff):(angleb-angleDiff);}
nct1.x=r1*Math.cos(new_anglea)+pt.x;nct1.y=r1*Math.sin(new_anglea)+pt.y;nct2.x=r2*Math.cos(new_angleb)+pt.x;nct2.y=r2*Math.sin(new_angleb)+pt.y;return[nct1,nct2];}
return undefined;};var smoothControlPoints=this.smoothControlPoints;this.matrixMultiply=function(){var NEAR_ZERO=1e-14,multi2=function(m1,m2){var m=svgroot.createSVGMatrix();m.a=m1.a*m2.a+m1.c*m2.b;m.b=m1.b*m2.a+m1.d*m2.b,m.c=m1.a*m2.c+m1.c*m2.d,m.d=m1.b*m2.c+m1.d*m2.d,m.e=m1.a*m2.e+m1.c*m2.f+m1.e,m.f=m1.b*m2.e+m1.d*m2.f+m1.f;return m;},args=arguments,i=args.length,m=args[i-1];while(i-->1){var m1=args[i-1];m=multi2(m1,m);}
if(Math.abs(m.a)<NEAR_ZERO)m.a=0;if(Math.abs(m.b)<NEAR_ZERO)m.b=0;if(Math.abs(m.c)<NEAR_ZERO)m.c=0;if(Math.abs(m.d)<NEAR_ZERO)m.d=0;if(Math.abs(m.e)<NEAR_ZERO)m.e=0;if(Math.abs(m.f)<NEAR_ZERO)m.f=0;return m;}
var matrixMultiply=this.matrixMultiply;var transformListToTransform=function(tlist,min,max){var min=min==undefined?0:min;var max=max==undefined?(tlist.numberOfItems-1):max;min=parseInt(min);max=parseInt(max);if(min>max){var temp=max;max=min;min=temp;}
var m=svgroot.createSVGMatrix();for(var i=min;i<=max;++i){var mtom=(i>=0&&i<tlist.numberOfItems?tlist.getItem(i).matrix:svgroot.createSVGMatrix());m=matrixMultiply(m,mtom);}
return svgroot.createSVGTransformFromMatrix(m);};var hasMatrixTransform=function(tlist){if(!tlist)return false;var num=tlist.numberOfItems;while(num--){var xform=tlist.getItem(num);if(xform.type==1&&!isIdentity(xform.matrix))return true;}
return false;}
var getMatrix=function(elem){var tlist=canvas.getTransformList(elem);return transformListToTransform(tlist).matrix;}
var transformToObj=function(xform,mZoom){var m=xform.matrix,tobj={tx:0,ty:0,sx:1,sy:1,angle:0,cx:0,cy:0,text:""},z=mZoom?current_zoom:1;switch(xform.type){case 1:tobj.text="matrix("+[m.a,m.b,m.c,m.d,m.e,m.f].join(",")+")";break;case 2:tobj.tx=m.e;tobj.ty=m.f;tobj.text="translate("+m.e*z+","+m.f*z+")";break;case 3:tobj.sx=m.a;tobj.sy=m.d;if(m.a==m.d)tobj.text="scale("+m.a+")";else tobj.text="scale("+m.a+","+m.d+")";break;case 4:tobj.angle=xform.angle;if(xform.angle!=0){var K=1-m.a;tobj.cy=(K*m.f+m.b*m.e)/(K*K+m.b*m.b);tobj.cx=(m.e-m.b*tobj.cy)/K;}
tobj.text="rotate("+xform.angle+" "+tobj.cx*z+","+tobj.cy*z+")";break;}
return tobj;};var transformBox=function(l,t,w,h,m){var topleft={x:l,y:t},topright={x:(l+w),y:t},botright={x:(l+w),y:(t+h)},botleft={x:l,y:(t+h)};topleft=transformPoint(topleft.x,topleft.y,m);var minx=topleft.x,maxx=topleft.x,miny=topleft.y,maxy=topleft.y;topright=transformPoint(topright.x,topright.y,m);minx=Math.min(minx,topright.x);maxx=Math.max(maxx,topright.x);miny=Math.min(miny,topright.y);maxy=Math.max(maxy,topright.y);botleft=transformPoint(botleft.x,botleft.y,m);minx=Math.min(minx,botleft.x);maxx=Math.max(maxx,botleft.x);miny=Math.min(miny,botleft.y);maxy=Math.max(maxy,botleft.y);botright=transformPoint(botright.x,botright.y,m);minx=Math.min(minx,botright.x);maxx=Math.max(maxx,botright.x);miny=Math.min(miny,botright.y);maxy=Math.max(maxy,botright.y);return{tl:topleft,tr:topright,bl:botleft,br:botright,aabox:{x:minx,y:miny,width:(maxx-minx),height:(maxy-miny)}};};var getMouseTarget=function(evt){if(evt==null){return null;}
var mouse_target=evt.target;if(mouse_target.correspondingUseElement)
mouse_target=mouse_target.correspondingUseElement;if($.inArray(mouse_target.namespaceURI,[mathns,htmlns])!=-1&&mouse_target.id!="svgcanvas")
{while(mouse_target.nodeName!="foreignObject"){mouse_target=mouse_target.parentNode;if(mouse_target.id=="svg_editor"){mouse_target=svgroot;return mouse_target;}}}
while(mouse_target.parentNode.parentNode.tagName=="g"){mouse_target=mouse_target.parentNode;}
if(mouse_target.nodeName.toLowerCase()=="div"){mouse_target=svgroot;}
return mouse_target;};(function(){var d_attr=null,start_x=null,start_y=null,init_bbox={},freehand={minx:null,miny:null,maxx:null,maxy:null};var mouseDown=function(evt)
{if(evt.button===1||canvas.spaceKey)return;root_sctm=svgcontent.getScreenCTM().inverse();var pt=transformPoint(evt.pageX,evt.pageY,root_sctm),mouse_x=pt.x*current_zoom,mouse_y=pt.y*current_zoom;evt.preventDefault();if($.inArray(current_mode,['select','resize'])==-1){addGradient();}
var x=mouse_x/current_zoom,y=mouse_y/current_zoom,mouse_target=getMouseTarget(evt);start_x=x;start_y=y;if(mouse_target.parentNode==selectorManager.selectorParentGroup&&selectedElements[0]!=null){var gripid=evt.target.id,griptype=gripid.substr(0,20);if(griptype=="selectorGrip_rotate_"){current_mode="rotate";}
else if(griptype=="selectorGrip_resize_"){current_mode="resize";current_resize_mode=gripid.substr(20,gripid.indexOf("_",20)-20);}
mouse_target=selectedElements[0];}
start_transform=mouse_target.getAttribute("transform");var tlist=canvas.getTransformList(mouse_target);switch(current_mode){case"select":started=true;current_resize_mode="none";if(mouse_target!=svgroot){if(selectedElements.indexOf(mouse_target)==-1){if(!evt.shiftKey){canvas.clearSelection(true);}
canvas.addToSelection([mouse_target]);justSelected=mouse_target;pathActions.clear();}
for(var i=0;i<selectedElements.length;++i){if(selectedElements[i]==null)continue;var slist=canvas.getTransformList(selectedElements[i]);slist.insertItemBefore(svgroot.createSVGTransform(),0);}}
else{canvas.clearSelection();current_mode="multiselect";if(rubberBox==null){rubberBox=selectorManager.getRubberBandBox();}
start_x*=current_zoom;start_y*=current_zoom;assignAttributes(rubberBox,{'x':start_x,'y':start_y,'width':0,'height':0,'display':'inline'},100);}
break;case"zoom":started=true;start_x=x;start_y=y;if(rubberBox==null){rubberBox=selectorManager.getRubberBandBox();}
assignAttributes(rubberBox,{'x':start_x*current_zoom,'y':start_y*current_zoom,'width':0,'height':0,'display':'inline'},100);break;case"resize":started=true;start_x=x;start_y=y;init_bbox=canvas.getBBox($('#selectedBox0')[0]);$.each(init_bbox,function(key,val){init_bbox[key]=val/current_zoom;});var pos=canvas.getRotationAngle(mouse_target)?1:0;if(hasMatrixTransform(tlist)){tlist.insertItemBefore(svgroot.createSVGTransform(),pos);tlist.insertItemBefore(svgroot.createSVGTransform(),pos);tlist.insertItemBefore(svgroot.createSVGTransform(),pos);}else{tlist.appendItem(svgroot.createSVGTransform());tlist.appendItem(svgroot.createSVGTransform());tlist.appendItem(svgroot.createSVGTransform());}
break;case"fhellipse":case"fhrect":case"fhpath":started=true;start_x=x;start_y=y;d_attr=x+","+y+" ";var stroke_w=cur_shape.stroke_width==0?1:cur_shape.stroke_width;addSvgElementFromJson({"element":"polyline","curStyles":true,"attr":{"points":d_attr,"id":getNextId(),"fill":"none","opacity":cur_shape.opacity/2,"stroke-linecap":"round","style":"pointer-events:none"}});freehand.minx=x;freehand.maxx=x;freehand.miny=y;freehand.maxy=y;break;case"image":started=true;start_x=x;start_y=y;var newImage=addSvgElementFromJson({"element":"image","attr":{"x":x,"y":y,"width":0,"height":0,"id":getNextId(),"opacity":cur_shape.opacity/2,"style":"pointer-events:inherit"}});newImage.setAttributeNS(xlinkns,"xlink:href",last_good_img_url);preventClickDefault(newImage);break;case"square":case"rect":started=true;start_x=x;start_y=y;addSvgElementFromJson({"element":"rect","curStyles":true,"attr":{"x":x,"y":y,"width":0,"height":0,"id":getNextId(),"opacity":cur_shape.opacity/2}});break;case"line":started=true;var stroke_w=cur_shape.stroke_width==0?1:cur_shape.stroke_width;addSvgElementFromJson({"element":"line","curStyles":true,"attr":{"x1":x,"y1":y,"x2":x,"y2":y,"id":getNextId(),"stroke":cur_shape.stroke,"stroke-width":stroke_w,"stroke-dasharray":cur_shape.stroke_dasharray,"stroke-linejoin":cur_shape.stroke_linejoin,"stroke-linecap":cur_shape.stroke_linecap,"stroke-opacity":cur_shape.stroke_opacity,"fill":"none","opacity":cur_shape.opacity/2,"style":"pointer-events:none"}});break;case"circle":started=true;addSvgElementFromJson({"element":"circle","curStyles":true,"attr":{"cx":x,"cy":y,"r":0,"id":getNextId(),"opacity":cur_shape.opacity/2}});break;case"ellipse":started=true;addSvgElementFromJson({"element":"ellipse","curStyles":true,"attr":{"cx":x,"cy":y,"rx":0,"ry":0,"id":getNextId(),"opacity":cur_shape.opacity/2}});break;case"text":started=true;var newText=addSvgElementFromJson({"element":"text","curStyles":true,"attr":{"x":x,"y":y,"id":getNextId(),"fill":cur_text.fill,"stroke-width":cur_text.stroke_width,"font-size":cur_text.font_size,"font-family":cur_text.font_family,"text-anchor":"middle","xml:space":"preserve"}});break;case"path":case"pathedit":start_x*=current_zoom;start_y*=current_zoom;pathActions.mouseDown(evt,mouse_target,start_x,start_y);started=true;break;case"textedit":start_x*=current_zoom;start_y*=current_zoom;textActions.mouseDown(evt,mouse_target,start_x,start_y);started=true;break;case"rotate":started=true;canvas.beginUndoableChange("transform",selectedElements);break;default:break;}
var ext_result=runExtensions("mouseDown",{event:evt,start_x:start_x,start_y:start_y,selectedElements:selectedElements},true);$.each(ext_result,function(i,r){if(r&&r.started){started=true;}});};var mouseMove=function(evt)
{if(!started)return;if(evt.button===1||canvas.spaceKey)return;var selected=selectedElements[0],pt=transformPoint(evt.pageX,evt.pageY,root_sctm),mouse_x=pt.x*current_zoom,mouse_y=pt.y*current_zoom,shape=getElem(getId());x=mouse_x/current_zoom;y=mouse_y/current_zoom;evt.preventDefault();switch(current_mode)
{case"select":if(selectedElements[0]!=null){var dx=x-start_x;var dy=y-start_y;if(evt.shiftKey){var xya=Utils.snapToAngle(start_x,start_y,x,y);x=xya.x;y=xya.y;}
if(dx!=0||dy!=0){var len=selectedElements.length;for(var i=0;i<len;++i){var selected=selectedElements[i];if(selected==null)break;if(i==0){var box=canvas.getBBox(selected);}
var xform=svgroot.createSVGTransform();var tlist=canvas.getTransformList(selected);xform.setTranslate(dx,dy);if(tlist.numberOfItems){tlist.replaceItem(xform,0);}else{tlist.appendItem(xform);}
selectorManager.requestSelector(selected).resize();}}}
break;case"multiselect":x*=current_zoom;y*=current_zoom;assignAttributes(rubberBox,{'x':Math.min(start_x,x),'y':Math.min(start_y,y),'width':Math.abs(x-start_x),'height':Math.abs(y-start_y)},100);var elemsToRemove=[],elemsToAdd=[],newList=getIntersectionList(),len=selectedElements.length;for(var i=0;i<len;++i){var ind=newList.indexOf(selectedElements[i]);if(ind==-1){elemsToRemove.push(selectedElements[i]);}
else{newList[ind]=null;}}
len=newList.length;for(i=0;i<len;++i){if(newList[i])elemsToAdd.push(newList[i]);}
if(elemsToRemove.length>0)
canvas.removeFromSelection(elemsToRemove);if(elemsToAdd.length>0)
canvas.addToSelection(elemsToAdd);break;case"resize":var tlist=canvas.getTransformList(selected),hasMatrix=hasMatrixTransform(tlist),box=hasMatrix?init_bbox:canvas.getBBox(selected),left=box.x,top=box.y,width=box.width,height=box.height,dx=(x-start_x),dy=(y-start_y);var angle=canvas.getRotationAngle(selected);if(angle){var r=Math.sqrt(dx*dx+dy*dy),theta=Math.atan2(dy,dx)-angle*Math.PI/180.0;dx=r*Math.cos(theta);dy=r*Math.sin(theta);}
if(current_resize_mode.indexOf("n")==-1&&current_resize_mode.indexOf("s")==-1){dy=0;}
if(current_resize_mode.indexOf("e")==-1&&current_resize_mode.indexOf("w")==-1){dx=0;}
var ts=null,tx=0,ty=0,sy=height?(height+dy)/height:1,sx=width?(width+dx)/width:1;if(current_resize_mode.indexOf("n")!=-1){sy=height?(height-dy)/height:1;ty=height;}
if(current_resize_mode.indexOf("w")!=-1){sx=width?(width-dx)/width:1;tx=width;}
var translateOrigin=svgroot.createSVGTransform(),scale=svgroot.createSVGTransform(),translateBack=svgroot.createSVGTransform();translateOrigin.setTranslate(-(left+tx),-(top+ty));if(evt.shiftKey){if(sx==1)sx=sy
else sy=sx;}
scale.setScale(sx,sy);translateBack.setTranslate(left+tx,top+ty);if(hasMatrix){var diff=angle?1:0;tlist.replaceItem(translateOrigin,2+diff);tlist.replaceItem(scale,1+diff);tlist.replaceItem(translateBack,0+diff);}else{var N=tlist.numberOfItems;tlist.replaceItem(translateBack,N-3);tlist.replaceItem(scale,N-2);tlist.replaceItem(translateOrigin,N-1);}
var selectedBBox=selectedBBoxes[0];selectedBBox.x=left;selectedBBox.y=top;if(tx){selectedBBox.x+=dx;}
if(ty){selectedBBox.y+=dy;}
selectorManager.requestSelector(selected).resize();break;case"zoom":x*=current_zoom;y*=current_zoom;assignAttributes(rubberBox,{'x':Math.min(start_x*current_zoom,x),'y':Math.min(start_y*current_zoom,y),'width':Math.abs(x-start_x*current_zoom),'height':Math.abs(y-start_y*current_zoom)},100);break;case"text":assignAttributes(shape,{'x':x,'y':y},1000);break;case"line":var handle=null;if(!window.opera)svgroot.suspendRedraw(1000);var x2=x;var y2=y;if(evt.shiftKey){var xya=Utils.snapToAngle(start_x,start_y,x2,y2);x2=xya.x;y2=xya.y;}
shape.setAttributeNS(null,"x2",x2);shape.setAttributeNS(null,"y2",y2);if(!window.opera)svgroot.unsuspendRedraw(handle);break;case"foreignObject":case"square":case"rect":case"image":var square=(current_mode=='square')||evt.shiftKey,w=Math.abs(x-start_x),h=Math.abs(y-start_y),new_x,new_y;if(square){w=h=Math.max(w,h);new_x=start_x<x?start_x:start_x-w;new_y=start_y<y?start_y:start_y-h;}else{new_x=Math.min(start_x,x);new_y=Math.min(start_y,y);}
assignAttributes(shape,{'width':w,'height':h,'x':new_x,'y':new_y},1000);break;case"circle":var c=$(shape).attr(["cx","cy"]);var cx=c.cx,cy=c.cy,rad=Math.sqrt((x-cx)*(x-cx)+(y-cy)*(y-cy));shape.setAttributeNS(null,"r",rad);break;case"ellipse":var c=$(shape).attr(["cx","cy"]);var cx=c.cx,cy=c.cy;handle=null;if(!window.opera)svgroot.suspendRedraw(1000);shape.setAttributeNS(null,"rx",Math.abs(x-cx));var ry=Math.abs(evt.shiftKey?(x-cx):(y-cy));shape.setAttributeNS(null,"ry",ry);if(!window.opera)svgroot.unsuspendRedraw(handle);break;case"fhellipse":case"fhrect":freehand.minx=Math.min(x,freehand.minx);freehand.maxx=Math.max(x,freehand.maxx);freehand.miny=Math.min(y,freehand.miny);freehand.maxy=Math.max(y,freehand.maxy);case"fhpath":start_x=x;start_y=y;d_attr+=+x+","+y+" ";shape.setAttributeNS(null,"points",d_attr);break;case"path":case"pathedit":x*=current_zoom;y*=current_zoom;if(evt.shiftKey){var x1=path.dragging?path.dragging[0]:start_x;var y1=path.dragging?path.dragging[1]:start_y;var xya=Utils.snapToAngle(x1,y1,x,y);x=xya.x;y=xya.y;}
if(rubberBox&&rubberBox.getAttribute('display')!='none'){assignAttributes(rubberBox,{'x':Math.min(start_x,x),'y':Math.min(start_y,y),'width':Math.abs(x-start_x),'height':Math.abs(y-start_y)},100);}
pathActions.mouseMove(x,y);break;case"textedit":x*=current_zoom;y*=current_zoom;textActions.mouseMove(mouse_x,mouse_y);break;case"rotate":var box=canvas.getBBox(selected),cx=box.x+box.width/2,cy=box.y+box.height/2,m=getMatrix(selected),center=transformPoint(cx,cy,m);cx=center.x;cy=center.y;var angle=((Math.atan2(cy-y,cx-x)*(180/Math.PI))-90)%360;if(evt.shiftKey){var snap=45;angle=Math.round(angle/snap)*snap;}
canvas.setRotationAngle(angle<-180?(360+angle):angle,true);call("changed",selectedElements);break;default:break;}
runExtensions("mouseMove",{event:evt,mouse_x:mouse_x,mouse_y:mouse_y,selected:selected});};var mouseUp=function(evt)
{if(evt.button===1)return;var tempJustSelected=justSelected;justSelected=null;if(!started)return;var pt=transformPoint(evt.pageX,evt.pageY,root_sctm),mouse_x=pt.x*current_zoom,mouse_y=pt.y*current_zoom,x=mouse_x/current_zoom,y=mouse_y/current_zoom,element=getElem(getId()),keep=false;started=false;switch(current_mode)
{case"resize":case"multiselect":if(rubberBox!=null){rubberBox.setAttribute("display","none");curBBoxes=[];}
current_mode="select";case"select":if(selectedElements[0]!=null){if(selectedElements[1]==null){var selected=selectedElements[0];if(selected.tagName!="g"&&selected.tagName!="image"&&selected.tagName!="foreignObject"){cur_properties.fill=selected.getAttribute("fill");cur_properties.fill_opacity=selected.getAttribute("fill-opacity");cur_properties.stroke=selected.getAttribute("stroke");cur_properties.stroke_opacity=selected.getAttribute("stroke-opacity");cur_properties.stroke_width=selected.getAttribute("stroke-width");cur_properties.stroke_dasharray=selected.getAttribute("stroke-dasharray");cur_properties.stroke_linejoin=selected.getAttribute("stroke-linejoin");cur_properties.stroke_linecap=selected.getAttribute("stroke-linecap");}
if(selected.tagName=="text"){cur_text.font_size=selected.getAttribute("font-size");cur_text.font_family=selected.getAttribute("font-family");}
selectorManager.requestSelector(selected).showGrips(true);}
recalculateAllSelectedDimensions();if(x!=start_x||y!=start_y){var len=selectedElements.length;for(var i=0;i<len;++i){if(selectedElements[i]==null)break;if(selectedElements[i].tagName!='g'){selectorManager.requestSelector(selectedElements[i]).resize();}}}
else{var t=evt.target;if(selectedElements[0].nodeName=="path"&&selectedElements[1]==null){pathActions.select(t);}
else if(selectedElements[0].nodeName=="text"&&selectedElements[1]==null){textActions.select(t,x,y);}
else if(evt.shiftKey){if(tempJustSelected!=t){canvas.removeFromSelection([t]);}}}}
return;break;case"zoom":if(rubberBox!=null){rubberBox.setAttribute("display","none");}
var factor=evt.shiftKey?.5:2;call("zoomed",{'x':Math.min(start_x,x),'y':Math.min(start_y,y),'width':Math.abs(x-start_x),'height':Math.abs(y-start_y),'factor':factor});return;case"fhpath":var coords=element.getAttribute('points');var commaIndex=coords.indexOf(',');if(commaIndex>=0){keep=coords.indexOf(',',commaIndex+1)>=0;}else{keep=coords.indexOf(' ',coords.indexOf(' ')+1)>=0;}
if(keep){element=pathActions.smoothPolylineIntoPath(element);}
break;case"line":var attrs=$(element).attr(["x1","x2","y1","y2"]);keep=(attrs.x1!=attrs.x2||attrs.y1!=attrs.y2);break;case"foreignObject":case"square":case"rect":case"image":var attrs=$(element).attr(["width","height"]);keep=(attrs.width!=0||attrs.height!=0)||current_mode==="image";break;case"circle":keep=(element.getAttribute('r')!=0);break;case"ellipse":var attrs=$(element).attr(["rx","ry"]);keep=(attrs.rx!=null||attrs.ry!=null);break;case"fhellipse":if((freehand.maxx-freehand.minx)>0&&(freehand.maxy-freehand.miny)>0){element=addSvgElementFromJson({"element":"ellipse","curStyles":true,"attr":{"cx":(freehand.minx+freehand.maxx)/2,"cy":(freehand.miny+freehand.maxy)/2,"rx":(freehand.maxx-freehand.minx)/2,"ry":(freehand.maxy-freehand.miny)/2,"id":getId()}});call("changed",[element]);keep=true;}
break;case"fhrect":if((freehand.maxx-freehand.minx)>0&&(freehand.maxy-freehand.miny)>0){element=addSvgElementFromJson({"element":"rect","curStyles":true,"attr":{"x":freehand.minx,"y":freehand.miny,"width":(freehand.maxx-freehand.minx),"height":(freehand.maxy-freehand.miny),"id":getId()}});call("changed",[element]);keep=true;}
break;case"text":keep=true;canvas.addToSelection([element]);textActions.start(element);break;case"path":element=null;started=true;var res=pathActions.mouseUp(evt,element,mouse_x,mouse_y);element=res.element
keep=res.keep;break;case"pathedit":keep=true;element=null;pathActions.mouseUp(evt);break;case"textedit":keep=false;element=null;textActions.mouseUp(evt,mouse_x,mouse_y);break;case"rotate":keep=true;element=null;current_mode="select";var batchCmd=canvas.finishUndoableChange();if(!batchCmd.isEmpty()){addCommandToHistory(batchCmd);}
recalculateAllSelectedDimensions();break;default:break;}
var ext_result=runExtensions("mouseUp",{event:evt,mouse_x:mouse_x,mouse_y:mouse_y},true);$.each(ext_result,function(i,r){if(r){keep=r.keep||keep;element=r.element;started=r.started||started;}});if(!keep&&element!=null){element.parentNode.removeChild(element);element=null;var t=evt.target;while(t.parentNode.parentNode.tagName=="g"){t=t.parentNode;}
if((current_mode!="path"||current_path_pts.length==0)&&t.parentNode.id!="selectorParentGroup"&&t.id!="svgcanvas"&&t.id!="svgroot")
{canvas.addToSelection([t],true);canvas.setMode("select");}}else if(element!=null){canvas.addedNew=true;var ani_dur=.2,c_ani;if(opac_ani.beginElement&&element.getAttribute('opacity')!=cur_shape.opacity){c_ani=$(opac_ani).clone().attr({to:cur_shape.opacity,dur:ani_dur}).appendTo(element);c_ani[0].beginElement();}else{ani_dur=0;}
setTimeout(function(){if(c_ani)c_ani.remove();element.setAttribute("opacity",cur_shape.opacity);element.setAttribute("style","pointer-events:inherit");cleanupElement(element);if(current_mode=="path"){pathActions.toEditMode(element);}else if(current_mode=="text"||current_mode=="image"||current_mode=="foreignObject"){canvas.addToSelection([element],true);}
addCommandToHistory(new InsertElementCommand(element));call("changed",[element]);},ani_dur*1000);}
start_transform=null;};var handleLinkInCanvas=function(e){e.preventDefault();return false;};$(container).mousedown(mouseDown).mousemove(mouseMove).click(handleLinkInCanvas);$(window).mouseup(mouseUp);$(container).bind("mousewheel DOMMouseScroll",function(e){if(!e.shiftKey)return;e.preventDefault();root_sctm=svgcontent.getScreenCTM().inverse();var pt=transformPoint(e.pageX,e.pageY,root_sctm);var bbox={'x':pt.x,'y':pt.y,'width':0,'height':0};if(e.wheelDelta){if(e.wheelDelta>=120){bbox.factor=2;}else if(e.wheelDelta<=-120){bbox.factor=.5;}}else if(e.detail){if(e.detail>0){bbox.factor=.5;}else if(e.detail<0){bbox.factor=2;}}
if(!bbox.factor)return;call("zoomed",bbox);});}());var textActions=canvas.textActions=function(){var curtext,current_text;var textinput;var cursor;var selblock;var blinker;var chardata=[];var textbb,transbb;var matrix;var last_x,last_y;var allow_dbl;function setCursor(index){var empty=(textinput.value==="");if(!arguments.length){if(empty){index=0;}else{if(textinput.selectionEnd!==textinput.selectionStart)return;index=textinput.selectionEnd;}}
var charbb;charbb=chardata[index];if(!empty){textinput.setSelectionRange(index,index);}
cursor=getElem("text_cursor");if(!cursor){cursor=document.createElementNS(svgns,"line");assignAttributes(cursor,{'id':"text_cursor",'stroke':"#333",'stroke-width':1});cursor=getElem("selectorParentGroup").appendChild(cursor);}
if(!blinker){blinker=setInterval(function(){var show=(cursor.getAttribute('display')==='none');cursor.setAttribute('display',show?'inline':'none');},600);}
var start_pt=ptToScreen(charbb.x,textbb.y);var end_pt=ptToScreen(charbb.x,(textbb.y+textbb.height));assignAttributes(cursor,{x1:start_pt.x,y1:start_pt.y,x2:end_pt.x,y2:end_pt.y,visibility:'visible',display:'inline'});if(selblock)selblock.setAttribute('d','');}
function setSelection(start,end,skipInput){if(start===end){setCursor(end);return;}
if(!skipInput){textinput.setSelectionRange(start,end);}
selblock=getElem("text_selectblock");if(!selblock){selblock=document.createElementNS(svgns,"path");assignAttributes(selblock,{'id':"text_selectblock",'fill':"green",'opacity':.5,'style':"pointer-events:none"});getElem("selectorParentGroup").appendChild(selblock);}
var startbb=chardata[start];var endbb=chardata[end];cursor.setAttribute('visibility','hidden');var tl=ptToScreen(startbb.x,textbb.y),tr=ptToScreen(startbb.x+(endbb.x-startbb.x),textbb.y),bl=ptToScreen(startbb.x,textbb.y+textbb.height),br=ptToScreen(startbb.x+(endbb.x-startbb.x),textbb.y+textbb.height);var dstr="M"+tl.x+","+tl.y
+" L"+tr.x+","+tr.y
+" "+br.x+","+br.y
+" "+bl.x+","+bl.y+"z";assignAttributes(selblock,{d:dstr,'display':'inline'});}
function getIndexFromPoint(mouse_x,mouse_y){var pt=svgroot.createSVGPoint();pt.x=mouse_x;pt.y=mouse_y;if(chardata.length==1)return 0;var charpos=curtext.getCharNumAtPosition(pt);if(charpos<0){charpos=chardata.length-2;if(mouse_x<=chardata[0].x){charpos=0;}}else if(charpos>=chardata.length-2){charpos=chardata.length-2;}
var charbb=chardata[charpos];var mid=charbb.x+(charbb.width/2);if(mouse_x>mid){charpos++;}
return charpos;}
function setCursorFromPoint(mouse_x,mouse_y){setCursor(getIndexFromPoint(mouse_x,mouse_y));}
function setEndSelectionFromPoint(x,y,apply){var i1=textinput.selectionStart;var i2=getIndexFromPoint(x,y);var start=Math.min(i1,i2);var end=Math.max(i1,i2);setSelection(start,end,!apply);}
function screenToPt(x_in,y_in){var out={x:x_in,y:y_in}
out.x/=current_zoom;out.y/=current_zoom;if(matrix){var pt=transformPoint(out.x,out.y,matrix.inverse());out.x=pt.x;out.y=pt.y;}
return out;}
function ptToScreen(x_in,y_in){var out={x:x_in,y:y_in}
if(matrix){var pt=transformPoint(out.x,out.y,matrix);out.x=pt.x;out.y=pt.y;}
out.x*=current_zoom;out.y*=current_zoom;return out;}
function hideCursor(){if(cursor){cursor.setAttribute('visibility','hidden');}}
function selectAll(evt){setSelection(0,curtext.textContent.length);$(this).unbind(evt);}
function selectWord(evt){if(!allow_dbl)return;var ept=transformPoint(evt.pageX,evt.pageY,root_sctm),mouse_x=ept.x*current_zoom,mouse_y=ept.y*current_zoom;var pt=screenToPt(mouse_x,mouse_y);var index=getIndexFromPoint(pt.x,pt.y);var str=curtext.textContent;var first=str.substr(0,index).replace(/[a-z0-9]+$/i,'').length;var m=str.substr(index).match(/^[a-z0-9]+/i);var last=(m?m[0].length:0)+index;setSelection(first,last);$(evt.target).click(selectAll);setTimeout(function(){$(evt.target).unbind('click',selectAll);},300);}
return{select:function(target,x,y){if(current_text==target){curtext=target;textActions.toEditMode(x,y);}
else{current_text=target;}},start:function(elem){curtext=elem;textActions.toEditMode();},mouseDown:function(evt,mouse_target,start_x,start_y){var pt=screenToPt(start_x,start_y);textinput.focus();setCursorFromPoint(pt.x,pt.y);last_x=start_x;last_y=start_y;},mouseMove:function(mouse_x,mouse_y){var pt=screenToPt(mouse_x,mouse_y);setEndSelectionFromPoint(pt.x,pt.y);},mouseUp:function(evt,mouse_x,mouse_y){var pt=screenToPt(mouse_x,mouse_y);setEndSelectionFromPoint(pt.x,pt.y,true);if(last_x===mouse_x&&last_y===mouse_y&&evt.target!==curtext){textActions.toSelectMode(true);}},setCursor:setCursor,toEditMode:function(x,y){allow_dbl=false;current_mode="textedit";selectorManager.requestSelector(curtext).showGrips(false);textActions.init();$(curtext).css('cursor','text');if(!arguments.length){setCursor();}else{var pt=screenToPt(x,y);setCursorFromPoint(pt.x,pt.y);}
setTimeout(function(){allow_dbl=true;},300);},toSelectMode:function(selectElem){current_mode="select";clearInterval(blinker);blinker=null;if(selblock)$(selblock).attr('display','none');if(cursor)$(cursor).attr('visibility','hidden');$(curtext).css('cursor','move');if(selectElem){canvas.clearSelection();$(curtext).css('cursor','move');call("selected",[curtext]);canvas.addToSelection([curtext],true);}
if(curtext&&!curtext.textContent.length){canvas.deleteSelectedElements();}
$(textinput).blur();curtext=false;},setInputElem:function(elem){textinput=elem;$(textinput).blur(hideCursor);},clear:function(){current_text=null;if(current_mode=="textedit"){textActions.toSelectMode();}},init:function(inputElem){if(!curtext)return;if(!curtext.parentNode){curtext=selectedElements[0];selectorManager.requestSelector(curtext).showGrips(false);}
var str=curtext.textContent;var len=str.length;var xform=curtext.getAttribute('transform');textbb=canvas.getBBox(curtext);matrix=xform?getMatrix(curtext):null;chardata=Array(len);textinput.focus();$(curtext).unbind('dblclick',selectWord).dblclick(selectWord);if(!len){var end={x:textbb.x+(textbb.width/2),width:0};}
for(var i=0;i<len;i++){var start=curtext.getStartPositionOfChar(i);var end=curtext.getEndPositionOfChar(i);chardata[i]={x:start.x,y:textbb.y,width:end.x-start.x,height:textbb.height};}
chardata.push({x:end.x,width:0});setSelection(textinput.selectionStart,textinput.selectionEnd,true);}}}();var pathActions=function(){var subpath=false;var pathData={};var current_path;var path;var segData={2:['x','y'],4:['x','y'],6:['x','y','x1','y1','x2','y2'],8:['x','y','x1','y1'],10:['x','y','r1','r2','angle','largeArcFlag','sweepFlag'],12:['x'],14:['y']};function retPath(){return path;}
function resetD(p){p.setAttribute("d",pathActions.convertPath(p));}
function insertItemBefore(elem,newseg,index){var list=elem.pathSegList;if(support.pathInsertItemBefore){list.insertItemBefore(newseg,index);return;}
var len=list.numberOfItems;var arr=[];for(var i=0;i<len;i++){var cur_seg=list.getItem(i);arr.push(cur_seg)}
list.clear();for(var i=0;i<len;i++){if(i==index){list.appendItem(newseg);}
list.appendItem(arr[i]);}}
function ptObjToArr(type,seg_item){var arr=segData[type],len=arr.length;var out=Array(len);for(var i=0;i<len;i++){out[i]=seg_item[arr[i]];}
return out;}
function getGripContainer(){var c=getElem("pathpointgrip_container");if(!c){var parent=getElem("selectorParentGroup");c=parent.appendChild(document.createElementNS(svgns,"g"));c.id="pathpointgrip_container";}
return c;}
var addPointGrip=function(index,x,y){var pointGripContainer=getGripContainer();var pointGrip=getElem("pathpointgrip_"+index);if(!pointGrip){pointGrip=document.createElementNS(svgns,"circle");assignAttributes(pointGrip,{'id':"pathpointgrip_"+index,'display':"none",'r':4,'fill':"#0FF",'stroke':"#00F",'stroke-width':2,'cursor':'move','style':'pointer-events:all','xlink:title':uiStrings.pathNodeTooltip});pointGrip=pointGripContainer.appendChild(pointGrip);var grip=$('#pathpointgrip_'+index);grip.dblclick(function(){if(path)path.setSegType();});}
if(x&&y){assignAttributes(pointGrip,{'cx':x,'cy':y,'display':"inline"});}
return pointGrip;};var getPointGrip=function(seg,update){var index=seg.index;var pointGrip=addPointGrip(index);if(update){var pt=getGripPt(seg);assignAttributes(pointGrip,{'cx':pt.x,'cy':pt.y,'display':"inline"});}
return pointGrip;}
var getSegSelector=function(seg,update){var index=seg.index;var segLine=getElem("segline_"+index);if(!segLine){var pointGripContainer=getGripContainer();segLine=document.createElementNS(svgns,"path");assignAttributes(segLine,{'id':"segline_"+index,'display':'none','fill':"none",'stroke':"#0FF",'stroke-width':2,'style':'pointer-events:none','d':'M0,0 0,0'});pointGripContainer.appendChild(segLine);}
if(update){var prev=seg.prev;if(!prev){segLine.setAttribute("display","none");return segLine;}
var pt=getGripPt(prev);replacePathSeg(2,0,[pt.x,pt.y],segLine);var pts=ptObjToArr(seg.type,seg.item,true);for(var i=0;i<pts.length;i+=2){var pt=getGripPt(seg,{x:pts[i],y:pts[i+1]});pts[i]=pt.x;pts[i+1]=pt.y;}
replacePathSeg(seg.type,1,pts,segLine);}
return segLine;}
var getControlPoints=function(seg){var item=seg.item;var index=seg.index;if(!("x1"in item)||!("x2"in item))return null;var cpt={};var pointGripContainer=getGripContainer();var prev=path.segs[index-1].item;var seg_items=[prev,item];for(var i=1;i<3;i++){var id=index+'c'+i;var ctrlLine=cpt['c'+i+'_line']=getElem("ctrlLine_"+id);if(!ctrlLine){ctrlLine=document.createElementNS(svgns,"line");assignAttributes(ctrlLine,{'id':"ctrlLine_"+id,'stroke':"#555",'stroke-width':1,"style":"pointer-events:none"});pointGripContainer.appendChild(ctrlLine);}
var pt=getGripPt(seg,{x:item['x'+i],y:item['y'+i]});var gpt=getGripPt(seg,{x:seg_items[i-1].x,y:seg_items[i-1].y});assignAttributes(ctrlLine,{'x1':pt.x,'y1':pt.y,'x2':gpt.x,'y2':gpt.y,'display':"inline"});cpt['c'+i+'_line']=ctrlLine;var pointGrip=cpt['c'+i]=getElem("ctrlpointgrip_"+id);if(!pointGrip){pointGrip=document.createElementNS(svgns,"circle");assignAttributes(pointGrip,{'id':"ctrlpointgrip_"+id,'display':"none",'r':4,'fill':"#0FF",'stroke':"#55F",'stroke-width':1,'cursor':'move','style':'pointer-events:all','xlink:title':uiStrings.pathCtrlPtTooltip});pointGripContainer.appendChild(pointGrip);}
assignAttributes(pointGrip,{'cx':pt.x,'cy':pt.y,'display':"inline"});cpt['c'+i]=pointGrip;}
return cpt;}
function getGripPt(seg,alt_pt){var out={x:alt_pt?alt_pt.x:seg.item.x,y:alt_pt?alt_pt.y:seg.item.y},path=seg.path;if(path.matrix){var pt=transformPoint(out.x,out.y,path.matrix);out=pt;}
out.x*=current_zoom;out.y*=current_zoom;return out;}
function getPointFromGrip(pt,path){var out={x:pt.x,y:pt.y}
if(path.matrix){var pt=transformPoint(out.x,out.y,path.imatrix);out.x=pt.x;out.y=pt.y;}
out.x/=current_zoom;out.y/=current_zoom;return out;}
function Segment(index,item){var s=this;s.index=index;s.selected=false;s.type=item.pathSegType;var grip;s.addGrip=function(){grip=s.ptgrip=getPointGrip(s,true);s.ctrlpts=getControlPoints(s,true);s.segsel=getSegSelector(s,true);}
s.item=item;s.show=function(y){if(grip){grip.setAttribute("display",y?"inline":"none");s.segsel.setAttribute("display",y?"inline":"none");s.showCtrlPts(y);}}
s.select=function(y){if(grip){grip.setAttribute("stroke",y?"#0FF":"#00F");s.segsel.setAttribute("display",y?"inline":"none");if(s.ctrlpts){s.selectCtrls(y);}
s.selected=y;}}
s.selectCtrls=function(y){$('#ctrlpointgrip_'+s.index+'c1, #ctrlpointgrip_'+s.index+'c2').attr('fill',y?'#0FF':'#EEE');}
s.update=function(full){item=s.item;if(grip){var pt=getGripPt(s);assignAttributes(grip,{'cx':pt.x,'cy':pt.y});getSegSelector(s,true);if(s.ctrlpts){if(full){s.item=path.elem.pathSegList.getItem(s.index);s.type=s.item.pathSegType;}
getControlPoints(s);}}}
s.move=function(dx,dy){var item=s.item;var cur=s;if(cur.ctrlpts){var cur_pts=[item.x+=dx,item.y+=dy,item.x1,item.y1,item.x2+=dx,item.y2+=dy];}else{var cur_pts=[item.x+=dx,item.y+=dy];}
replacePathSeg(cur.type,cur.index,cur_pts);if(s.next&&s.next.ctrlpts){var next=s.next.item;var next_pts=[next.x,next.y,next.x1+=dx,next.y1+=dy,next.x2,next.y2];replacePathSeg(s.next.type,s.next.index,next_pts);}
if(s.mate){var item=s.mate.item;var pts=[item.x+=dx,item.y+=dy];replacePathSeg(s.mate.type,s.mate.index,pts);}
s.update(true);if(s.next)s.next.update(true);}
s.setLinked=function(num){var seg,anum,pt;if(num==2){anum=1;seg=s.next;if(!seg)return;pt=s.item;}else{anum=2;seg=s.prev;if(!seg)return;pt=seg.item;}
var item=seg.item;item['x'+anum]=pt.x+(pt.x-s.item['x'+num]);item['y'+anum]=pt.y+(pt.y-s.item['y'+num]);var pts=[item.x,item.y,item.x1,item.y1,item.x2,item.y2];replacePathSeg(seg.type,seg.index,pts);seg.update(true);}
s.moveCtrl=function(num,dx,dy){var item=s.item;item['x'+num]+=dx;item['y'+num]+=dy;var pts=[item.x,item.y,item.x1,item.y1,item.x2,item.y2];replacePathSeg(s.type,s.index,pts);s.update(true);}
s.setType=function(new_type,pts){replacePathSeg(new_type,index,pts);s.type=new_type;s.item=path.elem.pathSegList.getItem(index);s.showCtrlPts(new_type===6);s.ctrlpts=getControlPoints(s);s.update(true);}
s.showCtrlPts=function(y){if(s.ctrlpts){for(var o in s.ctrlpts){s.ctrlpts[o].setAttribute("display",y?"inline":"none");}}}}
function Path(elem){if(!elem||elem.tagName!=="path")return false;var p=path=this;this.elem=elem;this.segs=[];this.selected_pts=[];this.init=function(){$(getGripContainer()).find("*").attr("display","none");var segList=elem.pathSegList;var len=segList.numberOfItems;p.segs=[];p.selected_pts=[];p.first_seg=null;for(var i=0;i<len;i++){var item=segList.getItem(i);var segment=new Segment(i,item);segment.path=p;p.segs.push(segment);}
var segs=p.segs;var start_i=null;for(var i=0;i<len;i++){var seg=segs[i];var next_seg=(i+1)>=len?null:segs[i+1];var prev_seg=(i-1)<0?null:segs[i-1];if(seg.type===2){if(prev_seg&&prev_seg.type!==1){var start_seg=segs[start_i];start_seg.next=segs[start_i+1];start_seg.next.prev=start_seg;start_seg.addGrip();}
start_i=i;}else if(next_seg&&next_seg.type===1){seg.next=segs[start_i+1];seg.next.prev=seg;seg.mate=segs[start_i];seg.addGrip();if(p.first_seg==null){p.first_seg=seg;}}else if(!next_seg){if(seg.type!==1){var start_seg=segs[start_i];start_seg.next=segs[start_i+1];start_seg.next.prev=start_seg;start_seg.addGrip();seg.addGrip();if(!p.first_seg){p.first_seg=segs[start_i];}}}else if(seg.type!==1){seg.addGrip();if(next_seg&&next_seg.type!==2){seg.next=next_seg;seg.next.prev=seg;}}}
return p;}
this.init();this.update=function(){if(canvas.getRotationAngle(p.elem)){p.matrix=getMatrix(path.elem);p.imatrix=p.matrix.inverse();}
p.eachSeg(function(i){this.item=elem.pathSegList.getItem(i);this.update();});return p;}
this.eachSeg=function(fn){var len=p.segs.length
for(var i=0;i<len;i++){var ret=fn.call(p.segs[i],i);if(ret===false)break;}}
this.addSeg=function(index){var seg=p.segs[index];if(!seg.prev)return;var prev=seg.prev;var newseg;switch(seg.item.pathSegType){case 4:var new_x=(seg.item.x+prev.item.x)/2;var new_y=(seg.item.y+prev.item.y)/2;newseg=elem.createSVGPathSegLinetoAbs(new_x,new_y);break;case 6:var p0_x=(prev.item.x+seg.item.x1)/2;var p1_x=(seg.item.x1+seg.item.x2)/2;var p2_x=(seg.item.x2+seg.item.x)/2;var p01_x=(p0_x+p1_x)/2;var p12_x=(p1_x+p2_x)/2;var new_x=(p01_x+p12_x)/2;var p0_y=(prev.item.y+seg.item.y1)/2;var p1_y=(seg.item.y1+seg.item.y2)/2;var p2_y=(seg.item.y2+seg.item.y)/2;var p01_y=(p0_y+p1_y)/2;var p12_y=(p1_y+p2_y)/2;var new_y=(p01_y+p12_y)/2;newseg=elem.createSVGPathSegCurvetoCubicAbs(new_x,new_y,p0_x,p0_y,p01_x,p01_y);var pts=[seg.item.x,seg.item.y,p12_x,p12_y,p2_x,p2_y];replacePathSeg(seg.type,index,pts);break;}
insertItemBefore(elem,newseg,index);}
this.deleteSeg=function(index){var seg=p.segs[index];var list=elem.pathSegList;seg.show(false);var next=seg.next;if(seg.mate){var pt=[next.item.x,next.item.y];replacePathSeg(2,next.index,pt);replacePathSeg(4,seg.index,pt);list.removeItem(seg.mate.index);}else if(!seg.prev){var item=seg.item;var pt=[next.item.x,next.item.y];replacePathSeg(2,seg.next.index,pt);list.removeItem(index);}else{list.removeItem(index);}}
this.endChanges=function(text){if(isWebkit)resetD(p.elem);var cmd=new ChangeElementCommand(elem,{d:p.last_d},text);addCommandToHistory(cmd);call("changed",[elem]);}
this.subpathIsClosed=function(index){var closed=false;path.eachSeg(function(i){if(i<=index)return true;if(this.type===2){return false;}else if(this.type===1){closed=true;return false;}});return closed;}
this.addPtsToSelection=function(indexes){if(!$.isArray(indexes))indexes=[indexes];for(var i=0;i<indexes.length;i++){var index=indexes[i];var seg=p.segs[index];if(seg.ptgrip){if($.inArray(index,p.selected_pts)==-1&&index>=0){p.selected_pts.push(index);}}};p.selected_pts.sort();var i=p.selected_pts.length,grips=new Array(i);while(i--){var pt=p.selected_pts[i];var seg=p.segs[pt];seg.select(true);grips[i]=seg.ptgrip;}
pathActions.canDeleteNodes=true;pathActions.closed_subpath=p.subpathIsClosed(p.selected_pts[0]);call("selected",grips);}
this.removePtFromSelection=function(index){var pos=$.inArray(index,p.selected_pts);if(pos==-1){return;}
p.segs[index].select(false);p.selected_pts.splice(pos,1);}
this.clearSelection=function(){p.eachSeg(function(i){this.select(false);});p.selected_pts=[];}
this.selectPt=function(pt,ctrl_num){p.clearSelection();if(pt==null){p.eachSeg(function(i){if(this.prev){pt=i;}});}
p.addPtsToSelection(pt);if(ctrl_num){p.dragctrl=ctrl_num;if(link_control_pts){p.segs[pt].setLinked(ctrl_num);}}}
this.storeD=function(){this.last_d=elem.getAttribute('d');}
this.show=function(y){p.eachSeg(function(){this.show(y);});if(y){p.selectPt(p.first_seg.index);}
return p;}
this.movePts=function(d_x,d_y){var i=p.selected_pts.length;while(i--){var seg=p.segs[p.selected_pts[i]];seg.move(d_x,d_y);}}
this.moveCtrl=function(d_x,d_y){var seg=p.segs[p.selected_pts[0]];seg.moveCtrl(p.dragctrl,d_x,d_y);if(link_control_pts){seg.setLinked(p.dragctrl);}}
this.setSegType=function(new_type){p.storeD();var i=p.selected_pts.length;var text;while(i--){var sel_pt=p.selected_pts[i];var cur=p.segs[sel_pt];var prev=cur.prev;if(!prev)continue;if(!new_type){text="Toggle Path Segment Type";var old_type=cur.type;new_type=(old_type==6)?4:6;}
new_type=new_type-0;var cur_x=cur.item.x;var cur_y=cur.item.y;var prev_x=prev.item.x;var prev_y=prev.item.y;var points;switch(new_type){case 6:if(cur.olditem){var old=cur.olditem;points=[cur_x,cur_y,old.x1,old.y1,old.x2,old.y2];}else{var diff_x=cur_x-prev_x;var diff_y=cur_y-prev_y;var ct1_x=(prev_x+(diff_x/3));var ct1_y=(prev_y+(diff_y/3));var ct2_x=(cur_x-(diff_x/3));var ct2_y=(cur_y-(diff_y/3));points=[cur_x,cur_y,ct1_x,ct1_y,ct2_x,ct2_y];}
break;case 4:points=[cur_x,cur_y];cur.olditem=cur.item;break;}
cur.setType(new_type,points);}
path.endChanges(text);return;}}
function getPath(elem){var p=pathData[elem.id];if(!p)p=pathData[elem.id]=new Path(elem);return p;}
var pathFuncs=[],current_path=null,current_path_pts=[],link_control_pts=false,hasMoved=false;var smoothPolylineIntoPath=function(element){var points=element.points;var N=points.numberOfItems;if(N>=4){var curpos=points.getItem(0),prevCtlPt=null;var d=[];d.push(["M",curpos.x,",",curpos.y," C"].join(""));for(var i=1;i<=(N-4);i+=3){var ct1=points.getItem(i);var ct2=points.getItem(i+1);var end=points.getItem(i+2);if(prevCtlPt){var newpts=smoothControlPoints(prevCtlPt,ct1,curpos);if(newpts&&newpts.length==2){var prevArr=d[d.length-1].split(',');prevArr[2]=newpts[0].x;prevArr[3]=newpts[0].y;d[d.length-1]=prevArr.join(',');ct1=newpts[1];}}
d.push([ct1.x,ct1.y,ct2.x,ct2.y,end.x,end.y].join(','));curpos=end;prevCtlPt=ct2;}
d.push("L");for(;i<N;++i){var pt=points.getItem(i);d.push([pt.x,pt.y].join(","));}
d=d.join(" ");element=addSvgElementFromJson({"element":"path","curStyles":true,"attr":{"id":getId(),"d":d,"fill":"none"}});call("changed",[element]);}
return element;};var replacePathSeg=function(type,index,pts,elem){var path=elem||retPath().elem;var func='createSVGPathSeg'+pathFuncs[type];var seg=path[func].apply(path,pts);if(support.pathReplaceItem){path.pathSegList.replaceItem(seg,index);}else{var segList=path.pathSegList;var len=segList.numberOfItems;var arr=[];for(var i=0;i<len;i++){var cur_seg=segList.getItem(i);arr.push(cur_seg)}
segList.clear();for(var i=0;i<len;i++){if(i==index){segList.appendItem(seg);}else{segList.appendItem(arr[i]);}}}}
var recalcRotatedPath=function(){var current_path=path.elem;var angle=canvas.getRotationAngle(current_path,true);if(!angle)return;selectedBBoxes[0]=path.oldbbox;var box=canvas.getBBox(current_path),oldbox=selectedBBoxes[0],oldcx=oldbox.x+oldbox.width/2,oldcy=oldbox.y+oldbox.height/2,newcx=box.x+box.width/2,newcy=box.y+box.height/2,dx=newcx-oldcx,dy=newcy-oldcy,r=Math.sqrt(dx*dx+dy*dy),theta=Math.atan2(dy,dx)+angle;newcx=r*Math.cos(theta)+oldcx;newcy=r*Math.sin(theta)+oldcy;var getRotVals=function(x,y){dx=x-oldcx;dy=y-oldcy;r=Math.sqrt(dx*dx+dy*dy);theta=Math.atan2(dy,dx)+angle;dx=r*Math.cos(theta)+oldcx;dy=r*Math.sin(theta)+oldcy;dx-=newcx;dy-=newcy;r=Math.sqrt(dx*dx+dy*dy);theta=Math.atan2(dy,dx)-angle;return{'x':(r*Math.cos(theta)+newcx)/1,'y':(r*Math.sin(theta)+newcy)/1};}
var list=current_path.pathSegList,i=list.numberOfItems;while(i){i-=1;var seg=list.getItem(i),type=seg.pathSegType;if(type==1)continue;var rvals=getRotVals(seg.x,seg.y),points=[rvals.x,rvals.y];if(seg.x1!=null&&seg.x2!=null){c_vals1=getRotVals(seg.x1,seg.y1);c_vals2=getRotVals(seg.x2,seg.y2);points.splice(points.length,0,c_vals1.x,c_vals1.y,c_vals2.x,c_vals2.y);}
replacePathSeg(type,i,points);}
box=canvas.getBBox(current_path);selectedBBoxes[0].x=box.x;selectedBBoxes[0].y=box.y;selectedBBoxes[0].width=box.width;selectedBBoxes[0].height=box.height;var R_nc=svgroot.createSVGTransform(),tlist=canvas.getTransformList(current_path);R_nc.setRotate((angle*180.0/Math.PI),newcx,newcy);tlist.replaceItem(R_nc,0);}
return{init:function(){pathFuncs=[0,'ClosePath'];var pathFuncsStrs=['Moveto','Lineto','CurvetoCubic','CurvetoQuadratic','Arc','LinetoHorizontal','LinetoVertical','CurvetoCubicSmooth','CurvetoQuadraticSmooth'];$.each(pathFuncsStrs,function(i,s){pathFuncs.push(s+'Abs');pathFuncs.push(s+'Rel');});},getPath:function(){return path;},mouseDown:function(evt,mouse_target,start_x,start_y){if(current_mode=="path")return;if(!path)return;path.storeD();var id=evt.target.id;if(id.substr(0,14)=="pathpointgrip_"){var cur_pt=path.cur_pt=parseInt(id.substr(14));path.dragging=[start_x,start_y];var seg=path.segs[cur_pt];if(!evt.shiftKey){if(path.selected_pts.length<=1||!seg.selected){path.clearSelection();}
path.addPtsToSelection(cur_pt);}else if(seg.selected){path.removePtFromSelection(cur_pt);}else{path.addPtsToSelection(cur_pt);}}else if(id.indexOf("ctrlpointgrip_")==0){path.dragging=[start_x,start_y];var parts=id.split('_')[1].split('c');var cur_pt=parts[0]-0;var ctrl_num=parts[1]-0;path.selectPt(cur_pt,ctrl_num);}
if(!path.dragging){if(rubberBox==null){rubberBox=selectorManager.getRubberBandBox();}
assignAttributes(rubberBox,{'x':start_x*current_zoom,'y':start_y*current_zoom,'width':0,'height':0,'display':'inline'},100);}},mouseMove:function(mouse_x,mouse_y){hasMoved=true;if(current_mode=="path"){var line=getElem("path_stretch_line");if(line){line.setAttribute("x2",mouse_x);line.setAttribute("y2",mouse_y);}
return;}
if(path.dragging){var pt=getPointFromGrip({x:path.dragging[0],y:path.dragging[1]},path);var mpt=getPointFromGrip({x:mouse_x,y:mouse_y},path);var diff_x=mpt.x-pt.x;var diff_y=mpt.y-pt.y;path.dragging=[mouse_x,mouse_y];if(path.dragctrl){path.moveCtrl(diff_x,diff_y);}else{path.movePts(diff_x,diff_y);}}else{path.selected_pts=[];path.eachSeg(function(i){var seg=this;if(!seg.next&&!seg.prev)return;var item=seg.item;var rbb=rubberBox.getBBox();var pt=getGripPt(seg);var pt_bb={x:pt.x,y:pt.y,width:0,height:0};var sel=Utils.rectsIntersect(rbb,pt_bb);this.select(sel);if(sel)path.selected_pts.push(seg.index);});}},mouseUp:function(evt,element,mouse_x,mouse_y){if(current_mode=="path"){var x=mouse_x/current_zoom,y=mouse_y/current_zoom,stretchy=getElem("path_stretch_line");if(!stretchy){stretchy=document.createElementNS(svgns,"line");assignAttributes(stretchy,{'id':"path_stretch_line",'stroke':"#22C",'stroke-width':"0.5"});stretchy=getElem("selectorParentGroup").appendChild(stretchy);}
stretchy.setAttribute("display","inline");var keep=null;if(current_path_pts.length==0){current_path_pts.push(x);current_path_pts.push(y);d_attr="M"+x+","+y+" ";addSvgElementFromJson({"element":"path","curStyles":true,"attr":{"d":d_attr,"id":getNextId(),"opacity":cur_shape.opacity/2,}});assignAttributes(stretchy,{'x1':mouse_x,'y1':mouse_y,'x2':mouse_x,'y2':mouse_y});var index=subpath?path.segs.length:0;addPointGrip(index,mouse_x,mouse_y);}
else{var i=current_path_pts.length;var FUZZ=6/current_zoom;var clickOnPoint=false;while(i){i-=2;var px=current_path_pts[i],py=current_path_pts[i+1];if(x>=(px-FUZZ)&&x<=(px+FUZZ)&&y>=(py-FUZZ)&&y<=(py+FUZZ)){clickOnPoint=true;break;}}
var id=getId();if(id in pathData)delete pathData[id];var newpath=getElem(id);var len=current_path_pts.length;if(clickOnPoint){if(i==0&&len>=6){var abs_x=current_path_pts[0];var abs_y=current_path_pts[1];d_attr+=['L',abs_x,',',abs_y,'z'].join('');newpath.setAttribute("d",d_attr);}else if(len<3){keep=false;return keep;}
$(stretchy).remove();element=newpath;current_path_pts=[];started=false;if(subpath){if(path.matrix){remapElement(newpath,{},path.matrix.inverse());}
var new_d=newpath.getAttribute("d");var orig_d=$(path.elem).attr("d");$(path.elem).attr("d",orig_d+new_d);$(newpath).remove();if(path.matrix){recalcRotatedPath();}
path.init();pathActions.toEditMode(path.elem);path.selectPt();return false;}}
else{if(!$.contains(container,getMouseTarget(evt))){console.log("Clicked outside canvas");return false;}
var lastx=current_path_pts[len-2],lasty=current_path_pts[len-1];if(evt.shiftKey){var xya=Utils.snapToAngle(lastx,lasty,x,y);x=xya.x;y=xya.y;}
current_path_pts.push(x);current_path_pts.push(y);d_attr+="L"+round(x)+","+round(y)+" ";newpath.setAttribute("d",d_attr);assignAttributes(stretchy,{'x1':mouse_x,'y1':mouse_y,'x2':mouse_x,'y2':mouse_y});var index=(current_path_pts.length/2-1);if(subpath)index+=path.segs.length;addPointGrip(index,mouse_x,mouse_y);}
keep=true;}
return{keep:keep,element:element}}
if(path.dragging){var last_pt=path.cur_pt;path.dragging=false;path.dragctrl=false;path.update();if(hasMoved){path.endChanges("Move path point(s)");}
if(!evt.shiftKey&&!hasMoved){path.selectPt(last_pt);}}
else if(rubberBox&&rubberBox.getAttribute('display')!='none'){rubberBox.setAttribute("display","none");if(rubberBox.getAttribute('width')<=2&&rubberBox.getAttribute('height')<=2){pathActions.toSelectMode(evt.target);}}else{pathActions.toSelectMode(evt.target);}
hasMoved=false;},clearData:function(){pathData={};},toEditMode:function(element){path=getPath(element);current_mode="pathedit";canvas.clearSelection();path.show(true).update();path.oldbbox=canvas.getBBox(path.elem);subpath=false;},toSelectMode:function(elem){var selPath=(elem==path.elem);current_mode="select";path.show(false);current_path=false;canvas.clearSelection();if(path.matrix){recalcRotatedPath();}
if(selPath){call("selected",[elem]);canvas.addToSelection([elem],true);}},addSubPath:function(on){if(on){current_mode="path";subpath=true;}else{pathActions.clear(true);pathActions.toEditMode(path.elem);}},select:function(target){if(current_path==target){pathActions.toEditMode(target);current_mode="pathedit";}
else{current_path=target;}},reorient:function(){var elem=selectedElements[0];if(!elem)return;var angle=canvas.getRotationAngle(elem);if(angle==0)return;var batchCmd=new BatchCommand("Reorient path");var changes={d:elem.getAttribute('d'),transform:elem.getAttribute('transform')};batchCmd.addSubCommand(new ChangeElementCommand(elem,changes));canvas.clearSelection();this.resetOrientation(elem);addCommandToHistory(batchCmd);getPath(elem).show(false).matrix=null;this.clear();canvas.addToSelection([elem],true);call("changed",selectedElements);},clear:function(remove){current_path=null;if(current_mode=="path"&&current_path_pts.length>0){var elem=getElem(getId());$(getElem("path_stretch_line")).remove();$(elem).remove();$(getElem("pathpointgrip_container")).find('*').attr('display','none');current_path_pts=[];started=false;}else if(current_mode=="pathedit"){this.toSelectMode();}
if(path)path.init().show(false);},resetOrientation:function(path){if(path==null||path.nodeName!='path')return false;var tlist=canvas.getTransformList(path);var m=transformListToTransform(tlist).matrix;tlist.clear();path.removeAttribute("transform");var segList=path.pathSegList;try{var len=segList.numberOfItems;}catch(err){var fixed_d=pathActions.convertPath(path);path.setAttribute('d',fixed_d);segList=path.pathSegList;var len=segList.numberOfItems;}
for(var i=0;i<len;++i){var seg=segList.getItem(i);var type=seg.pathSegType;if(type==1)continue;var pts=[];$.each(['',1,2],function(j,n){var x=seg['x'+n],y=seg['y'+n];if(x&&y){var pt=transformPoint(x,y,m);pts.splice(pts.length,0,pt.x,pt.y);}});replacePathSeg(type,i,pts,path);}},zoomChange:function(){if(current_mode=="pathedit"){path.update();}},getNodePoint:function(){var sel_pt=path.selected_pts.length?path.selected_pts[0]:1;var seg=path.segs[sel_pt];return{x:seg.item.x,y:seg.item.y,type:seg.type};},linkControlPoints:function(linkPoints){link_control_pts=linkPoints;},clonePathNode:function(){path.storeD();var sel_pts=path.selected_pts;var segs=path.segs;var i=sel_pts.length;var nums=[];while(i--){var pt=sel_pts[i];path.addSeg(pt);nums.push(pt+i);nums.push(pt+i+1);}
path.init().addPtsToSelection(nums);path.endChanges("Clone path node(s)");},opencloseSubPath:function(){var sel_pts=path.selected_pts;if(sel_pts.length!==1)return;var elem=path.elem;var list=elem.pathSegList;var len=list.numberOfItems;var index=sel_pts[0];var open_pt=null;var start_item=null;path.eachSeg(function(i){if(this.type===2&&i<=index){start_item=this.item;}
if(i<=index)return true;if(this.type===2){open_pt=i;return false;}else if(this.type===1){open_pt=false;return false;}});if(open_pt==null){open_pt=path.segs.length-1;}
if(open_pt!==false){var newseg=elem.createSVGPathSegLinetoAbs(start_item.x,start_item.y);var closer=elem.createSVGPathSegClosePath();if(open_pt==path.segs.length-1){list.appendItem(newseg);list.appendItem(closer);}else{insertItemBefore(elem,closer,open_pt);insertItemBefore(elem,newseg,open_pt);}
path.init().selectPt(open_pt+1);return;}
var seg=path.segs[index];if(seg.mate){list.removeItem(index);list.removeItem(index);path.init().selectPt(index-1);return;}
var last_m,z_seg;for(var i=0;i<list.numberOfItems;i++){var item=list.getItem(i);if(item.pathSegType===2){last_m=i;}else if(i===index){list.removeItem(last_m);}else if(item.pathSegType===1&&index<i){z_seg=i-1;list.removeItem(i);break;}}
var num=(index-last_m)-1;while(num--){insertItemBefore(elem,list.getItem(last_m),z_seg);}
var pt=list.getItem(last_m);replacePathSeg(2,last_m,[pt.x,pt.y]);var i=index
path.init().selectPt(0);},deletePathNode:function(){if(!pathActions.canDeleteNodes)return;path.storeD();var sel_pts=path.selected_pts;var i=sel_pts.length;while(i--){var pt=sel_pts[i];path.deleteSeg(pt);}
var cleanup=function(){var segList=path.elem.pathSegList;var len=segList.numberOfItems;var remItems=function(pos,count){while(count--){segList.removeItem(pos);}}
if(len<=1)return true;while(len--){var item=segList.getItem(len);if(item.pathSegType===1){var prev=segList.getItem(len-1);var nprev=segList.getItem(len-2);if(prev.pathSegType===2){remItems(len-1,2);cleanup();break;}else if(nprev.pathSegType===2){remItems(len-2,3);cleanup();break;}}else if(item.pathSegType===2){if(len>0){var prev_type=segList.getItem(len-1).pathSegType;if(prev_type===2){remItems(len-1,1);cleanup();break;}else if(prev_type===1&&segList.numberOfItems-1===len){remItems(len,1);cleanup();break;}}}}
return false;}
cleanup();if(path.elem.pathSegList.numberOfItems<=1){pathActions.toSelectMode(path.elem);canvas.deleteSelectedElements();return;}
path.init();path.clearSelection();if(window.opera){var cp=$(path.elem);cp.attr('d',cp.attr('d'));}
path.endChanges("Delete path node(s)");},smoothPolylineIntoPath:smoothPolylineIntoPath,setSegType:function(v){path.setSegType(v);},moveNode:function(attr,newValue){var sel_pts=path.selected_pts;if(!sel_pts.length)return;path.storeD();var seg=path.segs[sel_pts[0]];var diff={x:0,y:0};diff[attr]=newValue-seg.item[attr];seg.move(diff.x,diff.y);path.endChanges("Move path point");},fixEnd:function(elem){var segList=elem.pathSegList;var len=segList.numberOfItems;var last_m;for(var i=0;i<len;++i){var item=segList.getItem(i);if(item.pathSegType===2){last_m=item;}
if(item.pathSegType===1){var prev=segList.getItem(i-1);if(prev.x!=last_m.x||prev.y!=last_m.y){var newseg=elem.createSVGPathSegLinetoAbs(last_m.x,last_m.y);insertItemBefore(elem,newseg,i);pathActions.fixEnd(elem);break;}}}
if(isWebkit)resetD(elem);},convertPath:function(path,toRel){var segList=path.pathSegList;var len=segList.numberOfItems;var curx=0,cury=0;var d="";var last_m=null;for(var i=0;i<len;++i){var seg=segList.getItem(i);var x=seg.x||0,y=seg.y||0,x1=seg.x1||0,y1=seg.y1||0,x2=seg.x2||0,y2=seg.y2||0;var type=seg.pathSegType;var letter=pathMap[type]['to'+(toRel?'Lower':'Upper')+'Case']();var addToD=function(pnts,more,last){var str='';var more=more?' '+more.join(' '):'';var last=last?shortFloat(last):'';$.each(pnts,function(i,pnt){pnts[i]=shortFloat(pnt);});d+=letter+pnts.join(' ')+more+last;}
switch(type){case 1:d+="z";break;case 12:x-=curx;case 13:if(toRel){curx+=x;}else{x+=curx;curx=x;}
addToD([[x]]);break;case 14:y-=cury;case 15:if(toRel){cury+=y;}else{y+=cury;cury=y;}
addToD([[y]]);break;case 2:case 4:case 18:x-=curx;y-=cury;case 5:case 3:if(last_m&&segList.getItem(i-1).pathSegType===1&&!toRel){curx=last_m[0];cury=last_m[1];}
case 19:if(toRel){curx+=x;cury+=y;}else{x+=curx;y+=cury;curx=x;cury=y;}
if(type===3)last_m=[curx,cury];addToD([[x,y]]);break;case 6:x-=curx;x1-=curx;x2-=curx;y-=cury;y1-=cury;y2-=cury;case 7:if(toRel){curx+=x;cury+=y;}else{x+=curx;x1+=curx;x2+=curx;y+=cury;y1+=cury;y2+=cury;curx=x;cury=y;}
addToD([[x1,y1],[x2,y2],[x,y]]);break;case 8:x-=curx;x1-=curx;y-=cury;y1-=cury;case 9:if(toRel){curx+=x;cury+=y;}else{x+=curx;x1+=curx;y+=cury;y1+=cury;curx=x;cury=y;}
addToD([[x1,y1],[x,y]]);break;case 10:x-=curx;y-=cury;case 11:if(toRel){curx+=x;cury+=y;}else{x+=curx;y+=cury;curx=x;cury=y;}
addToD([[seg.r1,seg.r2]],[seg.angle,(seg.largeArcFlag?1:0),(seg.sweepFlag?1:0)],[x,y]);break;case 16:x-=curx;x2-=curx;y-=cury;y2-=cury;case 17:if(toRel){curx+=x;cury+=y;}else{x+=curx;x2+=curx;y+=cury;y2+=cury;curx=x;cury=y;}
addToD([[x2,y2],[x,y]]);break;}}
return d;}}}();pathActions.init();this.pathActions=pathActions;var shortFloat=function(val){var digits=save_options.round_digits;if(!isNaN(val)){return Number(Number(val).toFixed(digits));}else if($.isArray(val)){return shortFloat(val[0])+','+shortFloat(val[1]);}}
this.convertToPath=function(elem,getBBox,angle){if(elem==null){var elems=selectedElements;$.each(selectedElements,function(i,elem){if(elem)canvas.convertToPath(elem);});return;}
if(!getBBox){var batchCmd=new BatchCommand("Convert element to Path");}
var attrs=getBBox?{}:{"fill":cur_shape.fill,"fill-opacity":cur_shape.fill_opacity,"stroke":cur_shape.stroke,"stroke-width":cur_shape.stroke_width,"stroke-dasharray":cur_shape.stroke_dasharray,"stroke-linejoin":cur_shape.stroke_linejoin,"stroke-linecap":cur_shape.stroke_linecap,"stroke-opacity":cur_shape.stroke_opacity,"opacity":cur_shape.opacity,"visibility":"hidden"};$.each(['marker-start','marker-end','marker-mid','filter','clip-path'],function(){if(elem.getAttribute(this)){attrs[this]=elem.getAttribute(this);}});var path=addSvgElementFromJson({"element":"path","attr":attrs});var eltrans=elem.getAttribute("transform");if(eltrans){path.setAttribute("transform",eltrans);}
var id=elem.id;var parent=elem.parentNode;if(elem.nextSibling){parent.insertBefore(path,elem);}else{parent.appendChild(path);}
var d='';var joinSegs=function(segs){$.each(segs,function(j,seg){var l=seg[0],pts=seg[1];d+=l;for(var i=0;i<pts.length;i+=2){d+=(pts[i]+','+pts[i+1])+' ';}});}
var num=1.81;switch(elem.tagName){case'ellipse':case'circle':var a=$(elem).attr(['rx','ry','cx','cy']);var cx=a.cx,cy=a.cy,rx=a.rx,ry=a.ry;if(elem.tagName=='circle'){rx=ry=$(elem).attr('r');}
joinSegs([['M',[(cx-rx),(cy)]],['C',[(cx-rx),(cy-ry/num),(cx-rx/num),(cy-ry),(cx),(cy-ry)]],['C',[(cx+rx/num),(cy-ry),(cx+rx),(cy-ry/num),(cx+rx),(cy)]],['C',[(cx+rx),(cy+ry/num),(cx+rx/num),(cy+ry),(cx),(cy+ry)]],['C',[(cx-rx/num),(cy+ry),(cx-rx),(cy+ry/num),(cx-rx),(cy)]],['Z',[]]]);break;case'path':d=elem.getAttribute('d');break;case'line':var a=$(elem).attr(["x1","y1","x2","y2"]);d="M"+a.x1+","+a.y1+"L"+a.x2+","+a.y2;break;case'polyline':case'polygon':d="M"+elem.getAttribute('points');break;case'rect':var r=$(elem).attr(['rx','ry']);var rx=r.rx,ry=r.ry;var b=elem.getBBox();var x=b.x,y=b.y,w=b.width,h=b.height;var num=4-num;if(!rx&&!ry){joinSegs([['M',[x,y]],['L',[x+w,y]],['L',[x+w,y+h]],['L',[x,y+h]],['L',[x,y]],['Z',[]]]);}else{joinSegs([['M',[x,y+ry]],['C',[x,y+ry/num,x+rx/num,y,x+rx,y]],['L',[x+w-rx,y]],['C',[x+w-rx/num,y,x+w,y+ry/num,x+w,y+ry]],['L',[x+w,y+h-ry]],['C',[x+w,y+h-ry/num,x+w-rx/num,y+h,x+w-rx,y+h]],['L',[x+rx,y+h]],['C',[x+rx/num,y+h,x,y+h-ry/num,x,y+h-ry]],['L',[x,y+ry]],['Z',[]]]);}
break;default:path.parentNode.removeChild(path);break;}
if(d){path.setAttribute('d',d);}
if(!getBBox){if(eltrans){var tlist=canvas.getTransformList(path);if(hasMatrixTransform(tlist)){pathActions.resetOrientation(path);}}
batchCmd.addSubCommand(new RemoveElementCommand(elem,parent));batchCmd.addSubCommand(new InsertElementCommand(path));canvas.clearSelection();elem.parentNode.removeChild(elem)
path.setAttribute('id',id);path.removeAttribute("visibility");canvas.addToSelection([path],true);addCommandToHistory(batchCmd);}else{pathActions.resetOrientation(path);var bb=false;try{bb=path.getBBox();}catch(e){}
path.parentNode.removeChild(path);return bb;}}
this.open=function(){};this.save=function(opts){this.clearSelection();if(opts)$.extend(save_options,opts);save_options.apply=true;var str=svgCanvasToString();call("saved",str);};this.rasterExport=function(){this.clearSelection();var issues=[];var issue_list={'feGaussianBlur':uiStrings.exportNoBlur,'image':uiStrings.exportNoImage,'foreignObject':uiStrings.exportNoforeignObject,'[stroke-dasharray]':uiStrings.exportNoDashArray};var content=$(svgcontent);if(!("font"in $('<canvas>')[0].getContext('2d'))){issue_list['text']=uiStrings.exportNoText;}
$.each(issue_list,function(sel,descr){if(content.find(sel).length){issues.push(descr);}});var str=svgCanvasToString();call("exported",{svg:str,issues:issues});};var walkTree=function(elem,cbFn){if(elem&&elem.nodeType==1){cbFn(elem);var i=elem.childNodes.length;while(i--){walkTree(elem.childNodes.item(i),cbFn);}}};var walkTreePost=function(elem,cbFn){if(elem&&elem.nodeType==1){var i=elem.childNodes.length;while(i--){walkTree(elem.childNodes.item(i),cbFn);}
cbFn(elem);}};this.getSvgString=function(){save_options.apply=false;return svgCanvasToString();};this.randomizeIds=function(){if(arguments.length>0&&arguments[0]==false){randomize_ids=false;if(extensions["Arrows"])call("unsetarrownonce");}else{randomize_ids=true;if(!svgcontent.getAttributeNS(se_ns,'nonce')){svgcontent.setAttributeNS(se_ns,'se:nonce',nonce);if(extensions["Arrows"])call("setarrownonce",nonce);}}}
this.setSvgString=function(xmlString){try{var newDoc=Utils.text2xml(xmlString);sanitizeSvg(newDoc.documentElement);var batchCmd=new BatchCommand("Change Source");var oldzoom=svgroot.removeChild(svgcontent);batchCmd.addSubCommand(new RemoveElementCommand(oldzoom,svgroot));svgcontent=svgroot.appendChild(svgdoc.importNode(newDoc.documentElement,true));n=svgcontent.getAttributeNS(se_ns,'nonce');if(n){randomize_ids=true;nonce=n;if(extensions["Arrows"])call("setarrownonce",n);}else if(randomize_ids){svgcontent.setAttributeNS(xmlnsns,'xmlns:se',se_ns);svgcontent.setAttributeNS(se_ns,'se:nonce',nonce);if(extensions["Arrows"])call("setarrownonce",nonce);}
$(svgcontent).find('image').each(function(){var image=this;preventClickDefault(image);var val=this.getAttributeNS(xlinkns,"href");if(val.indexOf('data:')===0){var m=val.match(/svgedit_url=(.*?);/);if(m){var url=decodeURIComponent(m[1]);$(new Image()).load(function(){image.setAttributeNS(xlinkns,'xlink:href',url);}).attr('src',url);}}
canvas.embedImage(val);});$(svgcontent).find('linearGradient, radialGradient').each(function(){var grad=this;if($(grad).attr('gradientUnits')==='userSpaceOnUse'){var elems=$(svgcontent).find('[fill=url(#'+grad.id+')],[stroke=url(#'+grad.id+')]');if(!elems.length)return;var bb=elems[0].getBBox();if(grad.tagName==='linearGradient'){var g_coords=$(grad).attr(['x1','y1','x2','y2']);$(grad).attr({x1:(g_coords.x1-bb.x)/bb.width,y1:(g_coords.y1-bb.y)/bb.height,x2:(g_coords.x2-bb.x)/bb.width,y2:(g_coords.y1-bb.y)/bb.height});grad.removeAttribute('gradientUnits');}else{}}});if(!support.goodDecimals){canvas.fixOperaXML(svgcontent,newDoc.documentElement);}
walkTreePost(svgcontent,function(n){try{recalculateDimensions(n)}catch(e){console.log(e)}});var content=$(svgcontent);var attrs={id:'svgcontent',overflow:curConfig.show_outside_canvas?'visible':'hidden'};if(content.attr("viewBox")){var vb=content.attr("viewBox").split(' ');attrs.width=vb[2];attrs.height=vb[3];}
else{$.each(['width','height'],function(i,dim){var val=content.attr(dim)||100;if((val+'').substr(-1)==="%"){attrs[dim]=parseInt(val);}else{attrs[dim]=convertToNum(dim,val);}});}
content.attr(attrs);this.contentW=attrs['width'];this.contentH=attrs['height'];batchCmd.addSubCommand(new InsertElementCommand(svgcontent));var changes=content.attr(["width","height"]);batchCmd.addSubCommand(new ChangeElementCommand(svgroot,changes));current_zoom=1;identifyLayers();svgTransformLists={};canvas.clearSelection();pathActions.clearData();svgroot.appendChild(selectorManager.selectorParentGroup);addCommandToHistory(batchCmd);call("changed",[svgcontent]);}catch(e){console.log(e);return false;}
return true;};this.importSvgString=function(xmlString){try{var newDoc=Utils.text2xml(xmlString);sanitizeSvg(newDoc.documentElement);var batchCmd=new BatchCommand("Change Source");var importedNode=svgdoc.importNode(newDoc.documentElement,true);if(current_layer){var innerw=importedNode.getAttribute("width"),innerh=importedNode.getAttribute("height"),innervb=importedNode.getAttribute("viewBox"),vb=innervb?innervb.split(" "):[0,0,innerw,innerh];for(var j=0;j<4;++j)
vb[j]=Number(vb[j]);var canvasw=Number(svgcontent.getAttribute("width")),canvash=Number(svgcontent.getAttribute("height"));if(innerh>innerw){var ts="scale("+(canvash/3)/vb[3]+")";}
else{var ts="scale("+(canvash/3)/vb[2]+")";}
ts="translate(0) "+ts+" translate(0)";var g=svgdoc.createElementNS(svgns,"g");while(importedNode.hasChildNodes())
g.appendChild(importedNode.firstChild);if(ts)
g.setAttribute("transform",ts);var ids={};walkTree(g,function(n){if(n.nodeType==1){if(n.id){if(!(n.id in ids)){ids[n.id]={elem:null,attrs:[],hrefs:[]};}
ids[n.id]["elem"]=n;}
$.each(["clip-path","fill","filter","marker-end","marker-mid","marker-start","mask","stroke"],function(i,attr){var attrnode=n.getAttributeNode(attr);if(attrnode){var url=getUrlFromAttr(attrnode.value),refid=url?url.substr(1):null;if(refid){if(!(refid in ids)){ids[refid]={elem:null,attrs:[],hrefs:[]};}
ids[refid]["attrs"].push(attrnode);}}});var href=n.getAttributeNS(xlinkns,"href");if(href&&$.inArray(n.nodeName,["filter","linearGradient","pattern","radialGradient","textPath","use"])!=-1)
{var refid=href.substr(1);if(!(refid in ids)){ids[refid]={elem:null,attrs:[],hrefs:[]};}
ids[refid]["hrefs"].push(n);}}});for(var oldid in ids){var elem=ids[oldid]["elem"];if(elem){var newid=getNextId();obj_num++;elem.id=newid;var attrs=ids[oldid]["attrs"];var j=attrs.length;while(j--){var attr=attrs[j];attr.ownerElement.setAttribute(attr.name,"url(#"+newid+")");}
var hreffers=ids[oldid]["hrefs"];var k=hreffers.length;while(k--){var hreffer=hreffers[k];hreffer.setAttributeNS(xlinkns,"xlink:href","#"+newid);}}}
g.id=getNextId();obj_num++;current_layer.appendChild(g);}
if(!support.goodDecimals){canvas.fixOperaXML(svgcontent,importedNode);}
walkTreePost(svgcontent,function(n){try{recalculateDimensions(n)}catch(e){console.log(e)}});batchCmd.addSubCommand(new InsertElementCommand(svgcontent));svgTransformLists={};canvas.clearSelection();addCommandToHistory(batchCmd);call("changed",[svgcontent]);}catch(e){console.log(e);return false;}
return true;};var identifyLayers=function(){all_layers=[];var numchildren=svgcontent.childNodes.length;var orphans=[],layernames=[];for(var i=0;i<numchildren;++i){var child=svgcontent.childNodes.item(i);if(child&&child.nodeType==1){if(child.tagName=="g"){var name=$("title",child).text();if(name){layernames.push(name);all_layers.push([name,child]);current_layer=child;walkTree(child,function(e){e.setAttribute("style","pointer-events:inherit");});current_layer.setAttribute("style","pointer-events:none");}
else{orphans.push(child);}}
else if(canvas.getBBox(child)&&child.nodeName!='defs'){var bb=canvas.getBBox(child);orphans.push(child);}}}
if(orphans.length>0){var i=1;while($.inArray(("Layer "+i),layernames)!=-1){i++;}
var newname="Layer "+i;current_layer=svgdoc.createElementNS(svgns,"g");var layer_title=svgdoc.createElementNS(svgns,"title");layer_title.textContent=newname;current_layer.appendChild(layer_title);for(var j=0;j<orphans.length;++j){current_layer.appendChild(orphans[j]);}
current_layer=svgcontent.appendChild(current_layer);all_layers.push([newname,current_layer]);}
walkTree(current_layer,function(e){e.setAttribute("style","pointer-events:inherit");});current_layer.setAttribute("style","pointer-events:all");};this.createLayer=function(name){var batchCmd=new BatchCommand("Create Layer");var new_layer=svgdoc.createElementNS(svgns,"g");var layer_title=svgdoc.createElementNS(svgns,"title");layer_title.textContent=name;new_layer.appendChild(layer_title);new_layer=svgcontent.appendChild(new_layer);batchCmd.addSubCommand(new InsertElementCommand(new_layer));addCommandToHistory(batchCmd);canvas.clearSelection();identifyLayers();canvas.setCurrentLayer(name);call("changed",[new_layer]);};this.deleteCurrentLayer=function(){if(current_layer&&all_layers.length>1){var batchCmd=new BatchCommand("Delete Layer");var parent=current_layer.parentNode;batchCmd.addSubCommand(new RemoveElementCommand(current_layer,parent));parent.removeChild(current_layer);addCommandToHistory(batchCmd);canvas.clearSelection();identifyLayers();canvas.setCurrentLayer(all_layers[all_layers.length-1][0]);call("changed",[svgcontent]);return true;}
return false;};this.getNumLayers=function(){return all_layers.length;};this.getLayer=function(i){if(i>=0&&i<canvas.getNumLayers()){return all_layers[i][0];}
return"";};this.getCurrentLayer=function(){for(var i=0;i<all_layers.length;++i){if(all_layers[i][1]==current_layer){return all_layers[i][0];}}
return"";};this.setCurrentLayer=function(name){name=toXml(name);for(var i=0;i<all_layers.length;++i){if(name==all_layers[i][0]){if(current_layer!=all_layers[i][1]){canvas.clearSelection();current_layer.setAttribute("style","pointer-events:none");current_layer=all_layers[i][1];current_layer.setAttribute("style","pointer-events:all");}
return true;}}
return false;};this.renameCurrentLayer=function(newname){if(current_layer){var oldLayer=current_layer;if(!canvas.setCurrentLayer(newname)){var batchCmd=new BatchCommand("Rename Layer");for(var i=0;i<all_layers.length;++i){if(all_layers[i][1]==oldLayer)break;}
var oldname=all_layers[i][0];all_layers[i][0]=toXml(newname);var len=oldLayer.childNodes.length;for(var i=0;i<len;++i){var child=oldLayer.childNodes.item(i);if(child&&child.tagName=="title"){while(child.firstChild){child.removeChild(child.firstChild);}
child.textContent=newname;batchCmd.addSubCommand(new ChangeElementCommand(child,{"#text":oldname}));addCommandToHistory(batchCmd);call("changed",[oldLayer]);return true;}}}
current_layer=oldLayer;}
return false;};this.setCurrentLayerPosition=function(newpos){if(current_layer&&newpos>=0&&newpos<all_layers.length){for(var oldpos=0;oldpos<all_layers.length;++oldpos){if(all_layers[oldpos][1]==current_layer)break;}
if(oldpos==all_layers.length){return false;}
if(oldpos!=newpos){var refLayer=null;var oldNextSibling=current_layer.nextSibling;if(newpos>oldpos){if(newpos<all_layers.length-1){refLayer=all_layers[newpos+1][1];}}
else{refLayer=all_layers[newpos][1];}
svgcontent.insertBefore(current_layer,refLayer);addCommandToHistory(new MoveElementCommand(current_layer,oldNextSibling,svgcontent));identifyLayers();canvas.setCurrentLayer(all_layers[newpos][0]);return true;}}
return false;};this.getLayerVisibility=function(layername){var layer=null;for(var i=0;i<all_layers.length;++i){if(all_layers[i][0]==layername){layer=all_layers[i][1];break;}}
if(!layer)return false;return(layer.getAttribute("display")!="none");};this.setLayerVisibility=function(layername,bVisible){var layer=null;for(var i=0;i<all_layers.length;++i){if(all_layers[i][0]==layername){layer=all_layers[i][1];break;}}
if(!layer)return false;var oldDisplay=layer.getAttribute("display");if(!oldDisplay)oldDisplay="inline";layer.setAttribute("display",bVisible?"inline":"none");addCommandToHistory(new ChangeElementCommand(layer,{"display":oldDisplay},"Layer Visibility"));if(layer==current_layer){canvas.clearSelection();pathActions.clear();}
return true;};this.moveSelectedToLayer=function(layername){var layer=null;for(var i=0;i<all_layers.length;++i){if(all_layers[i][0]==layername){layer=all_layers[i][1];break;}}
if(!layer)return false;var batchCmd=new BatchCommand("Move Elements to Layer");var selElems=selectedElements;var i=selElems.length;while(i--){var elem=selElems[i];if(!elem)continue;var oldNextSibling=elem.nextSibling;var oldLayer=elem.parentNode;layer.appendChild(elem);batchCmd.addSubCommand(new MoveElementCommand(elem,oldNextSibling,oldLayer));}
addCommandToHistory(batchCmd);return true;};this.getLayerOpacity=function(layername){for(var i=0;i<all_layers.length;++i){if(all_layers[i][0]==layername){var g=all_layers[i][1];var opacity=g.getAttribute("opacity");if(!opacity){opacity="1.0";}
return parseFloat(opacity);}}
return null;};this.setLayerOpacity=function(layername,opacity){if(opacity<0.0||opacity>1.0)return;for(var i=0;i<all_layers.length;++i){if(all_layers[i][0]==layername){var g=all_layers[i][1];g.setAttribute("opacity",opacity);break;}}};this.selectAllInCurrentLayer=function(){if(current_layer){canvas.clearSelection();canvas.addToSelection($(current_layer).children());current_mode="select";call("selected",selectedElements);}};this.clear=function(){pathActions.clear();var nodes=svgcontent.childNodes;var len=svgcontent.childNodes.length;var i=0;this.clearSelection();for(var rep=0;rep<len;rep++){if(nodes[i].nodeType==1){svgcontent.removeChild(nodes[i]);}else{i++;}}
all_layers=[];canvas.createLayer("Layer 1");resetUndoStack();selectorManager.initGroup();rubberBox=selectorManager.getRubberBandBox();call("cleared");};this.linkControlPoints=function(linkPoints){pathActions.linkControlPoints(linkPoints);}
this.getContentElem=function(){return svgcontent;};this.getRootElem=function(){return svgroot;};this.getSelectedElems=function(){return selectedElements;};this.getResolution=function(){return{'w':svgcontent.getAttribute("width")/current_zoom,'h':svgcontent.getAttribute("height")/current_zoom,'zoom':current_zoom};};this.getDocumentTitle=function(){var childs=svgcontent.childNodes;for(var i=0;i<childs.length;i++){if(childs[i].nodeName=='title'){return childs[i].textContent;}}
return'';}
this.setDocumentTitle=function(newtitle){var childs=svgcontent.childNodes,doc_title=false,old_title='';var batchCmd=new BatchCommand("Change Image Title");for(var i=0;i<childs.length;i++){if(childs[i].nodeName=='title'){doc_title=childs[i];old_title=doc_title.textContent;break;}}
if(!doc_title){doc_title=svgdoc.createElementNS(svgns,"title");svgcontent.insertBefore(doc_title,svgcontent.firstChild);}
if(newtitle.length){doc_title.textContent=newtitle;}else{doc_title.parentNode.removeChild(doc_title);}
batchCmd.addSubCommand(new ChangeElementCommand(doc_title,{'#text':old_title}));addCommandToHistory(batchCmd);}
this.getEditorNS=function(add){if(add){svgcontent.setAttribute('xmlns:se',se_ns);}
return se_ns;}
this.setResolution=function(x,y){var res=canvas.getResolution();var w=res.w,h=res.h;var batchCmd;if(x=='fit'){var bbox=canvas.getStrokedBBox();if(bbox){batchCmd=new BatchCommand("Fit Canvas to Content");var visEls=canvas.getVisibleElements();canvas.addToSelection(visEls);var dx=[],dy=[];$.each(visEls,function(i,item){dx.push(bbox.x*-1);dy.push(bbox.y*-1);});var cmd=canvas.moveSelectedElements(dx,dy,true);batchCmd.addSubCommand(cmd);canvas.clearSelection();x=Math.round(bbox.width);y=Math.round(bbox.height);}else{return false;}}
if(x!=w||y!=h){var handle=svgroot.suspendRedraw(1000);if(!batchCmd){batchCmd=new BatchCommand("Change Image Dimensions");}
x=convertToNum('width',x);y=convertToNum('height',y);svgcontent.setAttribute('width',x);svgcontent.setAttribute('height',y);this.contentW=x;this.contentH=y;batchCmd.addSubCommand(new ChangeElementCommand(svgcontent,{"width":w,"height":h}));svgcontent.setAttribute("viewBox",[0,0,x/current_zoom,y/current_zoom].join(' '));batchCmd.addSubCommand(new ChangeElementCommand(svgcontent,{"viewBox":["0 0",w,h].join(' ')}));addCommandToHistory(batchCmd);svgroot.unsuspendRedraw(handle);call("changed",[svgcontent]);}
return true;};this.getOffset=function(){return $(svgcontent).attr(['x','y']);}
this.setBBoxZoom=function(val,editor_w,editor_h){var spacer=.85;var bb;var calcZoom=function(bb){if(!bb)return false;var w_zoom=Math.round((editor_w/bb.width)*100*spacer)/100;var h_zoom=Math.round((editor_h/bb.height)*100*spacer)/100;var zoomlevel=Math.min(w_zoom,h_zoom);canvas.setZoom(zoomlevel);return{'zoom':zoomlevel,'bbox':bb};}
if(typeof val=='object'){bb=val;if(bb.width==0||bb.height==0){var newzoom=bb.zoom?bb.zoom:current_zoom*bb.factor;canvas.setZoom(newzoom);return{'zoom':current_zoom,'bbox':bb};}
return calcZoom(bb);}
switch(val){case'selection':if(!selectedElements[0])return;var sel_elems=$.map(selectedElements,function(n){if(n)return n;});bb=canvas.getStrokedBBox(sel_elems);break;case'canvas':var res=canvas.getResolution();spacer=.95;bb={width:res.w,height:res.h,x:0,y:0};break;case'content':bb=canvas.getStrokedBBox();break;case'layer':bb=canvas.getStrokedBBox(canvas.getVisibleElements(current_layer));break;default:return;}
return calcZoom(bb);}
this.setZoom=function(zoomlevel){var res=canvas.getResolution();svgcontent.setAttribute("viewBox","0 0 "+res.w/zoomlevel+" "+res.h/zoomlevel);current_zoom=zoomlevel;$.each(selectedElements,function(i,elem){if(!elem)return;selectorManager.requestSelector(elem).resize();});pathActions.zoomChange();runExtensions("zoomChanged",zoomlevel);}
this.getMode=function(){return current_mode;};this.setMode=function(name){pathActions.clear(true);textActions.clear();cur_properties=(selectedElements[0]&&selectedElements[0].nodeName=='text')?cur_text:cur_shape;current_mode=name;};this.getStrokeColor=function(){return cur_properties.stroke;};this.setStrokeColor=function(val,preventUndo){cur_shape.stroke=val;cur_properties.stroke_paint={type:"solidColor"};var elems=[];var i=selectedElements.length;while(i--){var elem=selectedElements[i];if(elem){if(elem.tagName=="g")
walkTree(elem,function(e){if(e.nodeName!="g")elems.push(e);});else
elems.push(elem);}}
if(elems.length>0){if(!preventUndo){this.changeSelectedAttribute("stroke",val,elems);call("changed",elems);}else
this.changeSelectedAttributeNoUndo("stroke",val,elems);}};this.getFillColor=function(){return cur_properties.fill;};this.setFillColor=function(val,preventUndo){cur_properties.fill=val;cur_properties.fill_paint={type:"solidColor"};var elems=[];var i=selectedElements.length;while(i--){var elem=selectedElements[i];if(elem){if(elem.tagName=="g")
walkTree(elem,function(e){if(e.nodeName!="g")elems.push(e);});else if(elem.tagName!="polyline"&&elem.tagName!="line")
elems.push(elem);}}
if(elems.length>0){if(!preventUndo){this.changeSelectedAttribute("fill",val,elems);call("changed",elems);}else
this.changeSelectedAttributeNoUndo("fill",val,elems);}};var findDefs=function(){var defs=svgcontent.getElementsByTagNameNS(svgns,"defs");if(defs.length>0){defs=defs[0];}
else{defs=svgcontent.insertBefore(svgdoc.createElementNS(svgns,"defs"),svgcontent.firstChild.nextSibling);}
return defs;};var addGradient=function(){$.each(['stroke','fill'],function(i,type){if(!cur_properties[type+'_paint']||cur_properties[type+'_paint'].type=="solidColor")return;var grad=canvas[type+'Grad'];var duplicate_grad=findDuplicateGradient(grad);var defs=findDefs();if(!duplicate_grad){var orig_grad=grad;grad=defs.appendChild(svgdoc.importNode(grad,true));canvas.fixOperaXML(grad,orig_grad);grad.id=getNextId();}
else{grad=duplicate_grad;}
var functype=type=='fill'?'Fill':'Stroke';canvas['set'+functype+'Color']("url(#"+grad.id+")");});}
var findDuplicateGradient=function(grad){var defs=findDefs();var existing_grads=$(defs).find("linearGradient, radialGradient");var i=existing_grads.length;var rad_attrs=['r','cx','cy','fx','fy'];while(i--){var og=existing_grads[i];if(grad.tagName=="linearGradient"){if(grad.getAttribute('x1')!=og.getAttribute('x1')||grad.getAttribute('y1')!=og.getAttribute('y1')||grad.getAttribute('x2')!=og.getAttribute('x2')||grad.getAttribute('y2')!=og.getAttribute('y2'))
{continue;}}else{var grad_attrs=$(grad).attr(rad_attrs);var og_attrs=$(og).attr(rad_attrs);var diff=false;$.each(rad_attrs,function(i,attr){if(grad_attrs[attr]!=og_attrs[attr])diff=true;});if(diff)continue;}
var stops=grad.getElementsByTagNameNS(svgns,"stop");var ostops=og.getElementsByTagNameNS(svgns,"stop");if(stops.length!=ostops.length){continue;}
var j=stops.length;while(j--){var stop=stops[j];var ostop=ostops[j];if(stop.getAttribute('offset')!=ostop.getAttribute('offset')||stop.getAttribute('stop-opacity')!=ostop.getAttribute('stop-opacity')||stop.getAttribute('stop-color')!=ostop.getAttribute('stop-color'))
{break;}}
if(j==-1){return og;}}
return null;};this.setStrokePaint=function(p,addGrad){var p=new $.jGraduate.Paint(p);this.setStrokeOpacity(p.alpha/100);cur_properties.stroke_paint=p;if(p.type=="solidColor"){this.setStrokeColor(p.solidColor!="none"?"#"+p.solidColor:"none");}
else if(p.type=="linearGradient"){canvas.strokeGrad=p.linearGradient;if(addGrad)addGradient();}
else if(p.type=="radialGradient"){canvas.strokeGrad=p.radialGradient;if(addGrad)addGradient();}
else{}};this.setFillPaint=function(p,addGrad){var p=new $.jGraduate.Paint(p);this.setFillOpacity(p.alpha/100,true);cur_properties.fill_paint=p;if(p.type=="solidColor"){this.setFillColor(p.solidColor!="none"?"#"+p.solidColor:"none");}
else if(p.type=="linearGradient"){canvas.fillGrad=p.linearGradient;if(addGrad)addGradient();}
else if(p.type=="radialGradient"){canvas.fillGrad=p.radialGradient;if(addGrad)addGradient();}
else{}};this.getStrokeWidth=function(){return cur_properties.stroke_width;};this.setStrokeWidth=function(val){if(val==0&&$.inArray(current_mode,['line','path'])!=-1){canvas.setStrokeWidth(1);return;}
cur_properties.stroke_width=val;var elems=[];var i=selectedElements.length;while(i--){var elem=selectedElements[i];if(elem){if(elem.tagName=="g")
walkTree(elem,function(e){if(e.nodeName!="g")elems.push(e);});else
elems.push(elem);}}
if(elems.length>0){this.changeSelectedAttribute("stroke-width",val,elems);call("changed",selectedElements);}};this.setStrokeAttr=function(attr,val){cur_shape[attr.replace('-','_')]=val;var elems=[];var i=selectedElements.length;while(i--){var elem=selectedElements[i];if(elem){if(elem.tagName=="g")
walkTree(elem,function(e){if(e.nodeName!="g")elems.push(e);});else
elems.push(elem);}}
if(elems.length>0){this.changeSelectedAttribute(attr,val,elems);call("changed",selectedElements);}};this.getOpacity=function(){return cur_shape.opacity;};this.setOpacity=function(val){cur_shape.opacity=val;this.changeSelectedAttribute("opacity",val);};this.getBlur=function(elem){var val=0;if(elem){var filter_url=elem.getAttribute('filter');if(filter_url){var blur=getElem(elem.id+'_blur');if(blur){val=blur.firstChild.getAttribute('stdDeviation');}}}
return val;};(function(){var cur_command=null;var filter=null;var filterHidden=false;canvas.setBlurNoUndo=function(val){if(!filter){canvas.setBlur(val);return;}
if(val===0){canvas.changeSelectedAttributeNoUndo("filter","");filterHidden=true;}else{if(filterHidden){canvas.changeSelectedAttributeNoUndo("filter",'url(#'+selectedElements[0].id+'_blur)');}
canvas.changeSelectedAttributeNoUndo("stdDeviation",val,[filter.firstChild]);canvas.setBlurOffsets(filter,val);}}
function finishChange(){var bCmd=canvas.finishUndoableChange();cur_command.addSubCommand(bCmd);addCommandToHistory(cur_command);cur_command=null;filter=null;}
canvas.setBlurOffsets=function(filter,stdDev){if(stdDev>3){assignAttributes(filter,{x:'-50%',y:'-50%',width:'200%',height:'200%',},100);}else{filter.removeAttribute('x');filter.removeAttribute('y');filter.removeAttribute('width');filter.removeAttribute('height');}}
canvas.setBlur=function(val,complete){if(cur_command){finishChange();return;}
var elem=selectedElements[0];var elem_id=elem.id;filter=getElem(elem_id+'_blur');val-=0;var batchCmd=new BatchCommand();if(filter){if(val===0){filter=null;}}else{var newblur=addSvgElementFromJson({"element":"feGaussianBlur","attr":{"in":'SourceGraphic',"stdDeviation":val}});filter=addSvgElementFromJson({"element":"filter","attr":{"id":elem_id+'_blur'}});filter.appendChild(newblur);findDefs().appendChild(filter);batchCmd.addSubCommand(new InsertElementCommand(filter));}
var changes={filter:elem.getAttribute('filter')};if(val===0){elem.removeAttribute("filter");batchCmd.addSubCommand(new ChangeElementCommand(elem,changes));return;}else{this.changeSelectedAttribute("filter",'url(#'+elem_id+'_blur)');batchCmd.addSubCommand(new ChangeElementCommand(elem,changes));canvas.setBlurOffsets(filter,val);}
cur_command=batchCmd;canvas.beginUndoableChange("stdDeviation",[filter?filter.firstChild:null]);if(complete){canvas.setBlurNoUndo(val);finishChange();}};}());this.getFillOpacity=function(){return cur_shape.fill_opacity;};this.setFillOpacity=function(val,preventUndo){cur_shape.fill_opacity=val;if(!preventUndo)
this.changeSelectedAttribute("fill-opacity",val);else
this.changeSelectedAttributeNoUndo("fill-opacity",val);};this.getStrokeOpacity=function(){return cur_shape.stroke_opacity;};this.setStrokeOpacity=function(val,preventUndo){cur_shape.stroke_opacity=val;if(!preventUndo)
this.changeSelectedAttribute("stroke-opacity",val);else
this.changeSelectedAttributeNoUndo("stroke-opacity",val);};this.getTransformList=function(elem){if(isWebkit||!support.goodDecimals){var id=elem.id;if(!id){id='temp';}
var t=svgTransformLists[id];if(!t||id=='temp'){svgTransformLists[id]=new SVGEditTransformList(elem);svgTransformLists[id]._init();t=svgTransformLists[id];}
return t;}
else if(elem.transform){return elem.transform.baseVal;}
else if(elem.gradientTransform){return elem.gradientTransform.baseVal;}
return null;};this.getBBox=function(elem){var selected=elem||selectedElements[0];if(elem.nodeType!=1)return null;var ret=null;if(elem.nodeName=='text'&&selected.textContent==''){selected.textContent='a';ret=selected.getBBox();selected.textContent='';}else if(elem.nodeName=='g'&&isOpera){ret=selected.getBBox();var newg=document.createElementNS(svgns,"g");while(selected.firstChild){newg.appendChild(selected.firstChild);}
var i=selected.attributes.length;while(i--){newg.setAttributeNode(selected.attributes.item(i).cloneNode(true));}
selected.parentNode.appendChild(newg);ret=newg.getBBox();while(newg.firstChild){selected.appendChild(newg.firstChild);}
selected.parentNode.removeChild(newg);}else if(elem.nodeName=='path'&&isWebkit){ret=getPathBBox(selected);}else if(elem.nodeName=='use'&&!isWebkit){ret=selected.getBBox();ret.x+=parseFloat(selected.getAttribute('x')||0);ret.y+=parseFloat(selected.getAttribute('y')||0);}else if(elem.nodeName=='foreignObject'){ret=selected.getBBox();ret.x+=parseFloat(selected.getAttribute('x')||0);ret.y+=parseFloat(selected.getAttribute('y')||0);}else{try{ret=selected.getBBox();}
catch(e){var fo=$(selected).closest("foreignObject");if(fo.length){try{ret=fo[0].getBBox();}catch(e){ret=null;}}else{ret=null;}}}
return ret;};this.getRotationAngle=function(elem,to_rad){var selected=elem||selectedElements[0];var tlist=canvas.getTransformList(selected);if(!tlist)return 0;var N=tlist.numberOfItems;for(var i=0;i<N;++i){var xform=tlist.getItem(i);if(xform.type==4){return to_rad?xform.angle*Math.PI/180.0:xform.angle;}}
return 0.0;};this.setRotationAngle=function(val,preventUndo){val=parseFloat(val);var elem=selectedElements[0];var oldTransform=elem.getAttribute("transform");var bbox=canvas.getBBox(elem);var cx=bbox.x+bbox.width/2,cy=bbox.y+bbox.height/2;var tlist=canvas.getTransformList(elem);if(tlist.numberOfItems>0){var xform=tlist.getItem(0);if(xform.type==4){tlist.removeItem(0);}}
if(val!=0){var center=transformPoint(cx,cy,transformListToTransform(tlist).matrix);var R_nc=svgroot.createSVGTransform();R_nc.setRotate(val,center.x,center.y);tlist.insertItemBefore(R_nc,0);}
else if(tlist.numberOfItems==0){elem.removeAttribute("transform");}
if(!preventUndo){var newTransform=elem.getAttribute("transform");elem.setAttribute("transform",oldTransform);this.changeSelectedAttribute("transform",newTransform,selectedElements);}
var pointGripContainer=getElem("pathpointgrip_container");var selector=selectorManager.requestSelector(selectedElements[0]);selector.resize();selector.updateGripCursors(val);};this.each=function(cb){$(svgroot).children().each(cb);};this.bind=function(event,f){var old=events[event];events[event]=f;return old;};this.setIdPrefix=function(p){idprefix=p;};this.getBold=function(){var selected=selectedElements[0];if(selected!=null&&selected.tagName=="text"&&selectedElements[1]==null)
{return(selected.getAttribute("font-weight")=="bold");}
return false;};this.setBold=function(b){var selected=selectedElements[0];if(selected!=null&&selected.tagName=="text"&&selectedElements[1]==null)
{this.changeSelectedAttribute("font-weight",b?"bold":"normal");}};this.getItalic=function(){var selected=selectedElements[0];if(selected!=null&&selected.tagName=="text"&&selectedElements[1]==null)
{return(selected.getAttribute("font-style")=="italic");}
return false;};this.setItalic=function(i){var selected=selectedElements[0];if(selected!=null&&selected.tagName=="text"&&selectedElements[1]==null)
{this.changeSelectedAttribute("font-style",i?"italic":"normal");}};this.getFontFamily=function(){return cur_text.font_family;};this.setFontFamily=function(val){cur_text.font_family=val;this.changeSelectedAttribute("font-family",val);};this.getFontSize=function(){return cur_text.font_size;};this.setFontSize=function(val){cur_text.font_size=val;textActions.toSelectMode();this.changeSelectedAttribute("font-size",val);};this.getText=function(){var selected=selectedElements[0];if(selected==null){return"";}
return selected.textContent;};this.setTextContent=function(val){this.changeSelectedAttribute("#text",val);textActions.init(val);textActions.setCursor();};this.setImageURL=function(val){var elem=selectedElements[0];if(!elem)return;var attrs=$(elem).attr(['width','height']);var setsize=(!attrs.width||!attrs.height);var cur_href=elem.getAttributeNS(xlinkns,"href");if(cur_href!==val){setsize=true;}else if(!setsize)return;var batchCmd=new BatchCommand("Change Image URL");elem.setAttributeNS(xlinkns,"xlink:href",val);batchCmd.addSubCommand(new ChangeElementCommand(elem,{"#href":cur_href}));if(setsize){$(new Image()).load(function(){var changes=$(elem).attr(['width','height']);$(elem).attr({width:this.width,height:this.height});selectorManager.requestSelector(elem).resize();batchCmd.addSubCommand(new ChangeElementCommand(elem,changes));addCommandToHistory(batchCmd);call("changed",elem);}).attr('src',val);}else{addCommandToHistory(batchCmd);}};this.setRectRadius=function(val){var selected=selectedElements[0];if(selected!=null&&selected.tagName=="rect"){var r=selected.getAttribute("rx");if(r!=val){selected.setAttribute("rx",val);selected.setAttribute("ry",val);addCommandToHistory(new ChangeElementCommand(selected,{"rx":r,"ry":r},"Radius"));call("changed",[selected]);}}};this.setSegType=function(new_type){pathActions.setSegType(new_type);}
var ffClone=function(elem){if(navigator.userAgent.indexOf('Gecko/')==-1)return elem;var clone=elem.cloneNode(true)
elem.parentNode.insertBefore(clone,elem);elem.parentNode.removeChild(elem);selectorManager.releaseSelector(elem);selectedElements[0]=clone;selectorManager.requestSelector(clone).showGrips(true);return clone;}
var undoChangeStackPointer=-1;var undoableChangeStack=[];this.beginUndoableChange=function(attrName,elems){var p=++undoChangeStackPointer;var i=elems.length;var oldValues=new Array(i),elements=new Array(i);while(i--){var elem=elems[i];if(elem==null)continue;elements[i]=elem;oldValues[i]=elem.getAttribute(attrName);}
undoableChangeStack[p]={'attrName':attrName,'oldValues':oldValues,'elements':elements};};this.changeSelectedAttributeNoUndo=function(attr,newValue,elems){var handle=svgroot.suspendRedraw(1000);if(current_mode=='pathedit'){pathActions.moveNode(attr,newValue);}
var elems=elems||selectedElements;var i=elems.length;while(i--){var elem=elems[i];if(elem==null)continue;if(current_mode==="textedit"&&attr!=="#text"){textActions.toSelectMode(elem);}
if((attr=='x'||attr=='y')&&$.inArray(elem.tagName,['g','polyline','path'])!=-1){var bbox=canvas.getStrokedBBox([elem]);var diff_x=attr=='x'?newValue-bbox.x:0;var diff_y=attr=='y'?newValue-bbox.y:0;canvas.moveSelectedElements(diff_x*current_zoom,diff_y*current_zoom,true);continue;}
if(elem.tagName=="g"&&$.inArray(attr,['transform','opacity','filter'])!==-1);var oldval=attr=="#text"?elem.textContent:elem.getAttribute(attr);if(oldval==null)oldval="";if(oldval!=String(newValue)){if(attr=="#text"){var old_w=canvas.getBBox(elem).width;elem.textContent=newValue;elem=ffClone(elem);}else if(attr=="#href"){elem.setAttributeNS(xlinkns,"xlink:href",newValue);}
else elem.setAttribute(attr,newValue);if(i==0)
selectedBBoxes[i]=this.getBBox(elem);if(elem.nodeName=='text'){if((newValue+'').indexOf('url')==0||$.inArray(attr,['font-size','font-family','x','y'])!=-1){elem=ffClone(elem);}}
if($.inArray(elem,selectedElements)!=-1){setTimeout(function(){if(!elem.parentNode)return;selectorManager.requestSelector(elem).resize();},0);}
var angle=canvas.getRotationAngle(elem);if(angle!=0&&attr!="transform"){var tlist=canvas.getTransformList(elem);var n=tlist.numberOfItems;while(n--){var xform=tlist.getItem(n);if(xform.type==4){tlist.removeItem(n);var box=canvas.getBBox(elem);var center=transformPoint(box.x+box.width/2,box.y+box.height/2,transformListToTransform(tlist).matrix);var cx=center.x,cy=center.y;var newrot=svgroot.createSVGTransform();newrot.setRotate(angle,cx,cy);tlist.insertItemBefore(newrot,n);break;}}}}}
svgroot.unsuspendRedraw(handle);};this.finishUndoableChange=function(){var p=undoChangeStackPointer--;var changeset=undoableChangeStack[p];var i=changeset['elements'].length;var attrName=changeset['attrName'];var batchCmd=new BatchCommand("Change "+attrName);while(i--){var elem=changeset['elements'][i];if(elem==null)continue;var changes={};changes[attrName]=changeset['oldValues'][i];if(changes[attrName]!=elem.getAttribute(attrName)){batchCmd.addSubCommand(new ChangeElementCommand(elem,changes,attrName));}}
undoableChangeStack[p]=null;return batchCmd;};this.changeSelectedAttribute=function(attr,val,elems){var elems=elems||selectedElements;canvas.beginUndoableChange(attr,elems);var i=elems.length;canvas.changeSelectedAttributeNoUndo(attr,val,elems);var batchCmd=canvas.finishUndoableChange();if(!batchCmd.isEmpty()){addCommandToHistory(batchCmd);}};this.deleteSelectedElements=function(){var batchCmd=new BatchCommand("Delete Elements");var len=selectedElements.length;var selectedCopy=[];for(var i=0;i<len;++i){var selected=selectedElements[i];if(selected==null)break;var parent=selected.parentNode;var t=selected;selectorManager.releaseSelector(t);var elem=parent.removeChild(t);selectedCopy.push(selected)
selectedElements[i]=null;batchCmd.addSubCommand(new RemoveElementCommand(elem,parent));}
if(!batchCmd.isEmpty())addCommandToHistory(batchCmd);call("changed",selectedCopy);canvas.clearSelection();};this.groupSelectedElements=function(){var batchCmd=new BatchCommand("Group Elements");var g=addSvgElementFromJson({"element":"g","attr":{"id":getNextId()}});batchCmd.addSubCommand(new InsertElementCommand(g));var i=selectedElements.length;while(i--){var elem=selectedElements[i];if(elem==null)continue;var oldNextSibling=elem.nextSibling;var oldParent=elem.parentNode;g.appendChild(elem);batchCmd.addSubCommand(new MoveElementCommand(elem,oldNextSibling,oldParent));}
if(!batchCmd.isEmpty())addCommandToHistory(batchCmd);canvas.clearSelection();canvas.addToSelection([g],true);};this.ungroupSelectedElement=function(){var g=selectedElements[0];if(g.tagName=="g"){var batchCmd=new BatchCommand("Ungroup Elements");var parent=g.parentNode;var anchor=g.previousSibling;var children=new Array(g.childNodes.length);var xform=g.getAttribute("transform");var glist=canvas.getTransformList(g);var m=transformListToTransform(glist).matrix;var i=0;var gangle=canvas.getRotationAngle(g);var gattrs=$(g).attr(['filter','opacity']);var gfilter,gblur;while(g.firstChild){var elem=g.firstChild;var oldNextSibling=elem.nextSibling;var oldParent=elem.parentNode;children[i++]=elem=parent.insertBefore(elem,anchor);batchCmd.addSubCommand(new MoveElementCommand(elem,oldNextSibling,oldParent));if(gattrs.opacity!==null&&gattrs.opacity!==1){var c_opac=elem.getAttribute('opacity')||1;var new_opac=Math.round((elem.getAttribute('opacity')||1)*gattrs.opacity*100)/100;this.changeSelectedAttribute('opacity',new_opac,[elem]);}
if(gattrs.filter){var cblur=this.getBlur(elem);var orig_cblur=cblur;if(!gblur)gblur=this.getBlur(g);if(cblur){cblur=(gblur-0)+(cblur-0);}else if(cblur===0){cblur=gblur;}
if(!orig_cblur){if(!gfilter){gfilter=getElem(getUrlFromAttr(gattrs.filter).substr(1));}else{gfilter=copyElem(gfilter);findDefs().appendChild(gfilter);}}else{gfilter=getElem(getUrlFromAttr(elem.getAttribute('filter')).substr(1));}
var suffix=(gfilter.firstChild.tagName==='feGaussianBlur')?'blur':'filter';gfilter.id=elem.id+'_'+suffix;this.changeSelectedAttribute('filter','url(#'+gfilter.id+')',[elem]);if(cblur){this.changeSelectedAttribute('stdDeviation',cblur,[gfilter.firstChild]);canvas.setBlurOffsets(gfilter,cblur);}}
var chtlist=canvas.getTransformList(elem);if(glist.numberOfItems){if(gangle&&glist.numberOfItems==1){var rgm=glist.getItem(0).matrix;var rcm=svgroot.createSVGMatrix();var cangle=canvas.getRotationAngle(elem);if(cangle){rcm=chtlist.getItem(0).matrix;}
var cbox=canvas.getBBox(elem);var ceqm=transformListToTransform(chtlist).matrix;var coldc=transformPoint(cbox.x+cbox.width/2,cbox.y+cbox.height/2,ceqm);var sangle=gangle+cangle;var r2=svgroot.createSVGTransform();r2.setRotate(sangle,coldc.x,coldc.y);var trm=matrixMultiply(rgm,rcm,r2.matrix.inverse());if(cangle){chtlist.removeItem(0);}
if(sangle){chtlist.insertItemBefore(r2,0);}
if(trm.e||trm.f){var tr=svgroot.createSVGTransform();tr.setTranslate(trm.e,trm.f);chtlist.insertItemBefore(tr,0);}}
else{var oldxform=elem.getAttribute("transform");var changes={};changes["transform"]=oldxform?oldxform:"";var newxform=svgroot.createSVGTransform();var chm=transformListToTransform(chtlist).matrix,chm_inv=chm.inverse();var gm=matrixMultiply(chm_inv,m,chm);newxform.setMatrix(gm);chtlist.appendItem(newxform);}
batchCmd.addSubCommand(recalculateDimensions(elem));}}
if(xform){var changes={};changes["transform"]=xform;g.setAttribute("transform","");g.removeAttribute("transform");batchCmd.addSubCommand(new ChangeElementCommand(g,changes));}
canvas.clearSelection();g=parent.removeChild(g);batchCmd.addSubCommand(new RemoveElementCommand(g,parent));if(!batchCmd.isEmpty())addCommandToHistory(batchCmd);canvas.addToSelection(children);}};this.moveToTopSelectedElement=function(){var selected=selectedElements[0];if(selected!=null){var t=selected;var oldParent=t.parentNode;var oldNextSibling=t.nextSibling;if(oldNextSibling==selectorManager.selectorParentGroup)oldNextSibling=null;t=t.parentNode.appendChild(t);addCommandToHistory(new MoveElementCommand(t,oldNextSibling,oldParent,"top"));}};this.moveToBottomSelectedElement=function(){var selected=selectedElements[0];if(selected!=null){var t=selected;var oldParent=t.parentNode;var oldNextSibling=t.nextSibling;if(oldNextSibling==selectorManager.selectorParentGroup)oldNextSibling=null;var firstChild=t.parentNode.firstChild;if(firstChild.tagName=='title'){firstChild=firstChild.nextSibling;}
if(firstChild.tagName=='defs'){firstChild=firstChild.nextSibling;}
t=t.parentNode.insertBefore(t,firstChild);addCommandToHistory(new MoveElementCommand(t,oldNextSibling,oldParent,"bottom"));}};this.moveSelectedElements=function(dx,dy,undoable){if(dx.constructor!=Array){dx/=current_zoom;dy/=current_zoom;}
var undoable=undoable||true;var batchCmd=new BatchCommand("position");var i=selectedElements.length;while(i--){var selected=selectedElements[i];if(selected!=null){if(i==0)
selectedBBoxes[i]=this.getBBox(selected);var xform=svgroot.createSVGTransform();var tlist=canvas.getTransformList(selected);if(dx.constructor==Array){if(i==0){selectedBBoxes[i].x+=dx[i];selectedBBoxes[i].y+=dy[i];}
xform.setTranslate(dx[i],dy[i]);}else{if(i==0){selectedBBoxes[i].x+=dx;selectedBBoxes[i].y+=dy;}
xform.setTranslate(dx,dy);}
tlist.insertItemBefore(xform,0);var cmd=recalculateDimensions(selected);if(cmd){batchCmd.addSubCommand(cmd);}
selectorManager.requestSelector(selected).resize();}}
if(!batchCmd.isEmpty()){if(undoable)
addCommandToHistory(batchCmd);call("changed",selectedElements);return batchCmd;}};var getPathBBox=function(path){var seglist=path.pathSegList;var tot=seglist.numberOfItems;var bounds=[[],[]];var start=seglist.getItem(0);var P0=[start.x,start.y];for(var i=0;i<tot;i++){var seg=seglist.getItem(i);if(!seg.x)continue;bounds[0].push(P0[0]);bounds[1].push(P0[1]);if(seg.x1){var P1=[seg.x1,seg.y1],P2=[seg.x2,seg.y2],P3=[seg.x,seg.y];for(var j=0;j<2;j++){var calc=function(t){return Math.pow(1-t,3)*P0[j]
+3*Math.pow(1-t,2)*t*P1[j]
+3*(1-t)*Math.pow(t,2)*P2[j]
+Math.pow(t,3)*P3[j];};var b=6*P0[j]-12*P1[j]+6*P2[j];var a=-3*P0[j]+9*P1[j]-9*P2[j]+3*P3[j];var c=3*P1[j]-3*P0[j];if(a==0){if(b==0){continue;}
var t=-c/b;if(0<t&&t<1){bounds[j].push(calc(t));}
continue;}
var b2ac=Math.pow(b,2)-4*c*a;if(b2ac<0)continue;var t1=(-b+Math.sqrt(b2ac))/(2*a);if(0<t1&&t1<1)bounds[j].push(calc(t1));var t2=(-b-Math.sqrt(b2ac))/(2*a);if(0<t2&&t2<1)bounds[j].push(calc(t2));}
P0=P3;}else{bounds[0].push(seg.x);bounds[1].push(seg.y);}}
var x=Math.min.apply(null,bounds[0]);var w=Math.max.apply(null,bounds[0])-x;var y=Math.min.apply(null,bounds[1]);var h=Math.max.apply(null,bounds[1])-y;return{'x':x,'y':y,'width':w,'height':h};}
this.contentW=this.getResolution().w;this.contentH=this.getResolution().h;this.updateCanvas=function(w,h,w_orig,h_orig){svgroot.setAttribute("width",w);svgroot.setAttribute("height",h);var bg=$('#canvasBackground')[0];var old_x=svgcontent.getAttribute('x');var old_y=svgcontent.getAttribute('y');var x=(w/2-this.contentW*current_zoom/2);var y=(h/2-this.contentH*current_zoom/2);assignAttributes(svgcontent,{width:this.contentW*current_zoom,height:this.contentH*current_zoom,'x':x,'y':y,"viewBox":"0 0 "+this.contentW+" "+this.contentH});assignAttributes(bg,{width:svgcontent.getAttribute('width'),height:svgcontent.getAttribute('height'),x:x,y:y});selectorManager.selectorParentGroup.setAttribute("transform","translate("+x+","+y+")");return{x:x,y:y,old_x:old_x,old_y:old_y,d_x:x-old_x,d_y:y-old_y};}
this.getStrokedBBox=function(elems){if(!elems)elems=canvas.getVisibleElements();if(!elems.length)return false;var getCheckedBBox=function(elem){try{var bb=canvas.getBBox(elem);var angle=canvas.getRotationAngle(elem);if((angle&&angle%90)||hasMatrixTransform(canvas.getTransformList(elem))){var good_bb=false;var elemNames=['ellipse','path','line','polyline','polygon'];if($.inArray(elem.tagName,elemNames)!=-1){bb=good_bb=canvas.convertToPath(elem,true,angle);}else if(elem.tagName=='rect'){var rx=elem.getAttribute('rx');var ry=elem.getAttribute('ry');if(rx||ry){bb=good_bb=canvas.convertToPath(elem,true,angle);}}
if(!good_bb){var g=document.createElementNS(svgns,"g");var parent=elem.parentNode;parent.replaceChild(g,elem);g.appendChild(elem);bb=g.getBBox();parent.insertBefore(elem,g);parent.removeChild(g);}}
return bb;}catch(e){console.log(elem,e);return null;}}
var full_bb;$.each(elems,function(){if(full_bb)return;if(!this.parentNode)return;full_bb=getCheckedBBox(this);});if(full_bb==null)return null;var max_x=full_bb.x+full_bb.width;var max_y=full_bb.y+full_bb.height;var min_x=full_bb.x;var min_y=full_bb.y;var getOffset=function(elem){var sw=elem.getAttribute("stroke-width");var offset=0;if(elem.getAttribute("stroke")!="none"&&!isNaN(sw)){offset+=sw/2;}
return offset;}
var bboxes=[];$.each(elems,function(i,elem){var cur_bb=getCheckedBBox(elem);if(cur_bb){var offset=getOffset(elem);min_x=Math.min(min_x,cur_bb.x-offset);min_y=Math.min(min_y,cur_bb.y-offset);bboxes.push(cur_bb);}});full_bb.x=min_x;full_bb.y=min_y;$.each(elems,function(i,elem){var cur_bb=bboxes[i];if(cur_bb&&elem.nodeType==1){var offset=getOffset(elem);max_x=Math.max(max_x,cur_bb.x+cur_bb.width+offset);max_y=Math.max(max_y,cur_bb.y+cur_bb.height+offset);}});full_bb.width=max_x-min_x;full_bb.height=max_y-min_y;return full_bb;}
this.getVisibleElements=function(parent,includeBBox){if(!parent)parent=$(svgcontent).children();var contentElems=[];$(parent).children().each(function(i,elem){try{var box=elem.getBBox();if(box){var item=includeBBox?{'elem':elem,'bbox':canvas.getStrokedBBox([elem])}:elem;contentElems.push(item);}}catch(e){}});return contentElems.reverse();}
this.cycleElement=function(next){var cur_elem=selectedElements[0];var elem=false;var all_elems=this.getVisibleElements(current_layer);if(cur_elem==null){var num=next?all_elems.length-1:0;elem=all_elems[num];}else{var i=all_elems.length;while(i--){if(all_elems[i]==cur_elem){var num=next?i-1:i+1;if(num>=all_elems.length){num=0;}else if(num<0){num=all_elems.length-1;}
elem=all_elems[num];break;}}}
canvas.clearSelection();canvas.addToSelection([elem],true);call("selected",selectedElements);}
var resetUndoStack=function(){undoStack=[];undoStackPointer=0;};this.getUndoStackSize=function(){return undoStackPointer;};this.getRedoStackSize=function(){return undoStack.length-undoStackPointer;};this.getNextUndoCommandText=function(){if(undoStackPointer>0)
return undoStack[undoStackPointer-1].text;return"";};this.getNextRedoCommandText=function(){if(undoStackPointer<undoStack.length)
return undoStack[undoStackPointer].text;return"";};this.undo=function(){if(undoStackPointer>0){this.clearSelection();var cmd=undoStack[--undoStackPointer];cmd.unapply();pathActions.clear();call("changed",cmd.elements());}};this.redo=function(){if(undoStackPointer<undoStack.length&&undoStack.length>0){this.clearSelection();var cmd=undoStack[undoStackPointer++];cmd.apply();pathActions.clear();call("changed",cmd.elements());}};var copyElem=function(el){var new_el=document.createElementNS(el.namespaceURI,el.nodeName);$.each(el.attributes,function(i,attr){if(attr.localName!='-moz-math-font-style'){new_el.setAttributeNS(attr.namespaceURI,attr.nodeName,attr.nodeValue);}});new_el.removeAttribute("id");new_el.id=getNextId();obj_num++;if((isWebkit||!support.goodDecimals)&&el.nodeName=='path'){var fixed_d=pathActions.convertPath(el);new_el.setAttribute('d',fixed_d);}
$.each(el.childNodes,function(i,child){switch(child.nodeType){case 1:new_el.appendChild(copyElem(child));break;case 3:new_el.textContent=child.nodeValue;break;default:break;}});if(new_el.tagName=='image'){preventClickDefault(new_el);}
return new_el;};var preventClickDefault=function(img){$(img).click(function(e){e.preventDefault()});}
this.cloneSelectedElements=function(){var batchCmd=new BatchCommand("Clone Elements");var len=selectedElements.length;for(var i=0;i<len;++i){var elem=selectedElements[i];if(elem==null)break;}
var copiedElements=selectedElements.slice(0,i);this.clearSelection();var i=copiedElements.length;while(i--){var elem=copiedElements[i]=copyElem(copiedElements[i]);current_layer.appendChild(elem);batchCmd.addSubCommand(new InsertElementCommand(elem));}
if(!batchCmd.isEmpty()){this.addToSelection(copiedElements.reverse());this.moveSelectedElements(20,20,false);addCommandToHistory(batchCmd);call("selected",selectedElements);}};this.setBackground=function(color,url){var bg=getElem('canvasBackground');var border=$(bg).find('rect')[0];var bg_img=getElem('background_image');border.setAttribute('fill',color);if(url){if(!bg_img){bg_img=svgdoc.createElementNS(svgns,"image");assignAttributes(bg_img,{'id':'background_image','width':'100%','height':'100%','preserveAspectRatio':'xMinYMin','style':'pointer-events:none'});}
bg_img.setAttributeNS(xlinkns,"xlink:href",url);bg.appendChild(bg_img);}else if(bg_img){bg_img.parentNode.removeChild(bg_img);}}
this.alignSelectedElements=function(type,relative_to){var bboxes=[],angles=[];var minx=Number.MAX_VALUE,maxx=Number.MIN_VALUE,miny=Number.MAX_VALUE,maxy=Number.MIN_VALUE;var curwidth=Number.MIN_VALUE,curheight=Number.MIN_VALUE;var len=selectedElements.length;if(!len)return;for(var i=0;i<len;++i){if(selectedElements[i]==null)break;var elem=selectedElements[i];bboxes[i]=canvas.getStrokedBBox([elem]);switch(relative_to){case'smallest':if((type=='l'||type=='c'||type=='r')&&(curwidth==Number.MIN_VALUE||curwidth>bboxes[i].width)||(type=='t'||type=='m'||type=='b')&&(curheight==Number.MIN_VALUE||curheight>bboxes[i].height)){minx=bboxes[i].x;miny=bboxes[i].y;maxx=bboxes[i].x+bboxes[i].width;maxy=bboxes[i].y+bboxes[i].height;curwidth=bboxes[i].width;curheight=bboxes[i].height;}
break;case'largest':if((type=='l'||type=='c'||type=='r')&&(curwidth==Number.MIN_VALUE||curwidth<bboxes[i].width)||(type=='t'||type=='m'||type=='b')&&(curheight==Number.MIN_VALUE||curheight<bboxes[i].height)){minx=bboxes[i].x;miny=bboxes[i].y;maxx=bboxes[i].x+bboxes[i].width;maxy=bboxes[i].y+bboxes[i].height;curwidth=bboxes[i].width;curheight=bboxes[i].height;}
break;default:if(bboxes[i].x<minx)minx=bboxes[i].x;if(bboxes[i].y<miny)miny=bboxes[i].y;if(bboxes[i].x+bboxes[i].width>maxx)maxx=bboxes[i].x+bboxes[i].width;if(bboxes[i].y+bboxes[i].height>maxy)maxy=bboxes[i].y+bboxes[i].height;break;}}
if(relative_to=='page'){minx=0;miny=0;maxx=canvas.contentW;maxy=canvas.contentH;}
var dx=new Array(len);var dy=new Array(len);for(var i=0;i<len;++i){if(selectedElements[i]==null)break;var elem=selectedElements[i];var bbox=bboxes[i];dx[i]=0;dy[i]=0;switch(type){case'l':dx[i]=minx-bbox.x;break;case'c':dx[i]=(minx+maxx)/2-(bbox.x+bbox.width/2);break;case'r':dx[i]=maxx-(bbox.x+bbox.width);break;case't':dy[i]=miny-bbox.y;break;case'm':dy[i]=(miny+maxy)/2-(bbox.y+bbox.height/2);break;case'b':dy[i]=maxy-(bbox.y+bbox.height);break;}}
this.moveSelectedElements(dx,dy);};this.getZoom=function(){return current_zoom;};this.getVersion=function(){return"svgcanvas.js ($Rev: 1600 $)";};this.setUiStrings=function(strs){$.extend(uiStrings,strs);}
this.setConfig=function(opts){$.extend(curConfig,opts);}
this.clear();function getElem(id){if(svgroot.querySelector){return svgroot.querySelector('#'+id);}else if(svgdoc.evaluate){return svgdoc.evaluate('svg:svg[@id="svgroot"]//svg:*[@id="'+id+'"]',container,function(){return"http://www.w3.org/2000/svg";},9,null).singleNodeValue;}else{return $(svgroot).find('[id='+id+']')[0];}}
this.getPrivateMethods=function(){return{addCommandToHistory:addCommandToHistory,addGradient:addGradient,addSvgElementFromJson:addSvgElementFromJson,assignAttributes:assignAttributes,BatchCommand:BatchCommand,call:call,ChangeElementCommand:ChangeElementCommand,cleanupElement:cleanupElement,copyElem:copyElem,ffClone:ffClone,findDefs:findDefs,findDuplicateGradient:findDuplicateGradient,fromXml:fromXml,getElem:getElem,getId:getId,getIntersectionList:getIntersectionList,getMouseTarget:getMouseTarget,getNextId:getNextId,getPathBBox:getPathBBox,getUrlFromAttr:getUrlFromAttr,hasMatrixTransform:hasMatrixTransform,identifyLayers:identifyLayers,InsertElementCommand:InsertElementCommand,isIdentity:isIdentity,logMatrix:logMatrix,matrixMultiply:matrixMultiply,MoveElementCommand:MoveElementCommand,preventClickDefault:preventClickDefault,recalculateAllSelectedDimensions:recalculateAllSelectedDimensions,recalculateDimensions:recalculateDimensions,remapElement:remapElement,RemoveElementCommand:RemoveElementCommand,removeUnusedDefElems:removeUnusedDefElems,resetUndoStack:resetUndoStack,round:round,runExtensions:runExtensions,sanitizeSvg:sanitizeSvg,Selector:Selector,SelectorManager:SelectorManager,shortFloat:shortFloat,svgCanvasToString:svgCanvasToString,SVGEditTransformList:SVGEditTransformList,svgToString:svgToString,toString:toString,toXml:toXml,transformBox:transformBox,transformListToTransform:transformListToTransform,transformPoint:transformPoint,transformToObj:transformToObj,walkTree:walkTree}}
this.addExtension=function(name,ext_func){if(!(name in extensions)){var ext=ext_func($.extend(canvas.getPrivateMethods(),{svgroot:svgroot,svgcontent:svgcontent,nonce:nonce,selectorManager:selectorManager}));extensions[name]=ext;call("extension_added",ext);}else{console.log('Cannot add extension "'+name+'", an extension by that name already exists"');}};(function(){var path=document.createElementNS(svgns,'path');path.setAttribute('d','M0,0 10,10');var seglist=path.pathSegList;var seg=path.createSVGPathSegLinetoAbs(5,5);try{seglist.replaceItem(seg,0);support.pathReplaceItem=true;}catch(err){support.pathReplaceItem=false;}
try{seglist.insertItemBefore(seg,0);support.pathInsertItemBefore=true;}catch(err){support.pathInsertItemBefore=false;}
support.editableText=isOpera;var rect=document.createElementNS(svgns,'rect');rect.setAttribute('x',.1);var crect=rect.cloneNode(false);support.goodDecimals=(crect.getAttribute('x').indexOf(',')==-1);var rect=document.createElementNS(svgns,'rect');rect.setAttribute('width',"1em");rect.setAttribute('height',"1ex");svgcontent.appendChild(rect);var bb=rect.getBBox();unit_types.em=bb.width;unit_types.ex=bb.height;svgcontent.removeChild(rect);}());}
var Utils={"_keyStr":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=","encode64":function(input){input=Utils.convertToXMLReferences(input);if(window.btoa)return window.btoa(input);var output=new Array(Math.floor((input.length+2)/3)*4);var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0,p=0;do{chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=((chr1&3)<<4)|(chr2>>4);enc3=((chr2&15)<<2)|(chr3>>6);enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64;}else if(isNaN(chr3)){enc4=64;}
output[p++]=this._keyStr.charAt(enc1);output[p++]=this._keyStr.charAt(enc2);output[p++]=this._keyStr.charAt(enc3);output[p++]=this._keyStr.charAt(enc4);}while(i<input.length);return output.join('');},"decode64":function(input){if(window.atob)return window.atob(input);var output="";var chr1,chr2,chr3="";var enc1,enc2,enc3,enc4="";var i=0;input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{enc1=this._keyStr.indexOf(input.charAt(i++));enc2=this._keyStr.indexOf(input.charAt(i++));enc3=this._keyStr.indexOf(input.charAt(i++));enc4=this._keyStr.indexOf(input.charAt(i++));chr1=(enc1<<2)|(enc2>>4);chr2=((enc2&15)<<4)|(enc3>>2);chr3=((enc3&3)<<6)|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2);}
if(enc4!=64){output=output+String.fromCharCode(chr3);}
chr1=chr2=chr3="";enc1=enc2=enc3=enc4="";}while(i<input.length);return unescape(output);},"encodeUTF8":function(input){var output='';for(var n=0;n<input.length;n++){var c=input.charCodeAt(n);if(c<128){output+=input[n];}
else if(c>127){if(c<2048){output+=String.fromCharCode((c>>6)|192);}
else{output+=String.fromCharCode((c>>12)|224)+String.fromCharCode((c>>6)&63|128);}
output+=String.fromCharCode((c&63)|128);}}
return output;},"convertToXMLReferences":function(input){var output='';for(var n=0;n<input.length;n++){var c=input.charCodeAt(n);if(c<128){output+=input[n];}
else if(c>127){output+=("&#"+c+";");}}
return output;},"rectsIntersect":function(r1,r2){return r2.x<(r1.x+r1.width)&&(r2.x+r2.width)>r1.x&&r2.y<(r1.y+r1.height)&&(r2.y+r2.height)>r1.y;},"snapToAngle":function(x1,y1,x2,y2){var snap=Math.PI/4;var dx=x2-x1;var dy=y2-y1;var angle=Math.atan2(dy,dx);var dist=Math.sqrt(dx*dx+dy*dy);var snapangle=Math.round(angle/snap)*snap;var x=x1+dist*Math.cos(snapangle);var y=y1+dist*Math.sin(snapangle);return{x:x,y:y,a:snapangle};},"text2xml":function(sXML){var out;try{var dXML=($.browser.msie)?new ActiveXObject("Microsoft.XMLDOM"):new DOMParser();dXML.async=false;}catch(e){throw new Error("XML Parser could not be instantiated");};try{if($.browser.msie)out=(dXML.loadXML(sXML))?dXML:false;else out=dXML.parseFromString(sXML,"text/xml");}
catch(e){throw new Error("Error parsing XML string");};return out;}};if(typeof eventManager!='undefined'){eventManager.fire('scriptLoaded','vle/node/draw/svg-edit/svgcanvas.js');};;(function(){if(!window.svgEditor)window.svgEditor=function($){var svgCanvas;var Editor={};var is_ready=false;var defaultPrefs={lang:'en',iconsize:'m',bkgd_color:'#FFF',bkgd_url:'',img_save:'embed'},curPrefs={},curConfig={canvas_expansion:0,dimensions:[600,450],initFill:{color:'FF0000',opacity:1},initStroke:{width:5,color:'000000',opacity:1},initOpacity:1,extPath:'/vlewrapper/vle/node/draw/svg-edit/extensions/',imgPath:'/vlewrapper/vle/node/draw/svg-edit/images/',langPath:'/vlewrapper/vle/node/draw/svg-edit/locale/',no_save_warning:true,show_outside_canvas:false,extensions:['ext-wise4.js','ext-prompt.js?'+Math.round(Math.random()*1000),'ext-description.js?'+Math.round(Math.random()*1000),'ext-stamps.js?'+Math.round(Math.random()*1000),'ext-snapshots.js?'+Math.round(Math.random()*1000),'ext-simple_color.js','ext-closepath.js','ext-arrows.js','ext-connector.js'],initTool:'select',wireframe:false},uiStrings={"invalidAttrValGiven":"Invalid value given","noContentToFitTo":"No content to fit to","layer":"Layer","dupeLayerName":"There is already a layer named that!","enterUniqueLayerName":"Please enter a unique layer name","enterNewLayerName":"Please enter the new layer name","layerHasThatName":"Layer already has that name","QmoveElemsToLayer":"Move selected elements to layer \"%s\"?","QwantToClear":"Do you want to clear the drawing?\nThis will also erase your undo history!","QwantToOpen":"Do you want to open a new file?\nThis will also erase your undo history!","QerrorsRevertToSource":"There were parsing errors in your SVG source.\nRevert back to original SVG source?","QignoreSourceChanges":"Ignore changes made to SVG source?","featNotSupported":"Feature not supported","enterNewImgURL":"Enter the new image URL","defsFailOnSave":"NOTE: Due to a bug in your browser, this image may appear wrong (missing gradients or elements). It will however appear correct once actually saved.","loadingImage":"Loading image, please wait...","saveFromBrowser":"Select \"Save As...\" in your browser to save this image as a %s file.","noteTheseIssues":"Also note the following issues: ","ok":"OK","cancel":"Cancel","key_up":"Up","key_down":"Down","key_backspace":"Backspace","key_del":"Del"};var curPrefs={};Editor.curConfig=curConfig;$.pref=function(key,val){if(val)curPrefs[key]=val;key='svg-edit-'+key;var host=location.hostname,onweb=host&&host.indexOf('.')!=-1,store=(val!=undefined),storage=false;try{if(window.localStorage){storage=localStorage;}}catch(e){}
try{if(window.globalStorage&&onweb){storage=globalStorage[host];}}catch(e){}
if(storage){if(store)storage.setItem(key,val);else if(storage.getItem(key))return storage.getItem(key)+'';}else if(window.widget){if(store)widget.setPreferenceForKey(val,key);else return widget.preferenceForKey(key);}else{if(store){var d=new Date();d.setTime(d.getTime()+31536000000);val=encodeURIComponent(val);document.cookie=key+'='+val+'; expires='+d.toUTCString();}else{var result=document.cookie.match(new RegExp(key+"=([^;]+)"));return result?decodeURIComponent(result[1]):'';}}}
Editor.setConfig=function(opts){$.each(opts,function(key,val){if(key in defaultPrefs){$.pref(key,val);}});$.extend(true,curConfig,opts);if(opts.extensions){curConfig.extensions=opts.extensions;}}
Editor.setCustomHandlers=function(opts){if(opts.open){$('#tool_open').show();svgCanvas.open=opts.open;}
if(opts.save){show_save_warning=false;svgCanvas.bind("saved",opts.save);}}
Editor.randomizeIds=function(){svgCanvas.randomizeIds(arguments)}
Editor.init=function(){(function(){var urldata=$.deparam.querystring(true);if(!$.isEmptyObject(urldata)){if(urldata.dimensions){urldata.dimensions=urldata.dimensions.split(',');}
if(urldata.extensions){urldata.extensions=urldata.extensions.split(',');}
if(urldata.bkgd_color){urldata.bkgd_color='#'+urldata.bkgd_color;}
if(urldata.bkgd_color){urldata.bkgd_color='#'+urldata.bkgd_color;}
svgEditor.setConfig(urldata);var src=urldata.source;var qstr=$.param.querystring();if(src){if(src.indexOf("data:")===0){src=src.replace(/ /g,"+");Editor.loadFromDataURI(src);}else{Editor.loadFromString(src);}}else if(qstr.indexOf('paramurl=')!==-1){svgEditor.loadFromURL(qstr.substr(9));}else if(urldata.url){svgEditor.loadFromURL(urldata.url);}}})();var extFunc=function(){$.each(curConfig.extensions,function(){$.getScript(curConfig.extPath+this);});}
if(window.opera&&document.location.protocol==='file:'){setTimeout(extFunc,1000);}else{extFunc();}
$.svgIcons(curConfig.imgPath+'svg_edit_icons.svg',{w:24,h:24,id_match:false,no_img:true,fallback_path:curConfig.imgPath,fallback:{'new_image':'clear.png','save':'save.png','open':'open.png','source':'source.png','docprops':'document-properties.png','wireframe':'wireframe.png','undo':'undo.png','redo':'redo.png','select':'select.png','select_node':'select_node.png','pencil':'fhpath.png','pen':'line.png','square':'square.png','rect':'rect.png','fh_rect':'freehand-square.png','circle':'circle.png','ellipse':'ellipse.png','fh_ellipse':'freehand-circle.png','path':'path.png','text':'text.png','image':'image.png','zoom':'zoom.png','clone':'copy.png','node_clone':'node_clone.png','delete':'delete.png','node_delete':'node_delete.png','group':'shape_group.png','ungroup':'shape_ungroup.png','move_top':'move_top.png','move_bottom':'move_bottom.png','to_path':'to_path.png','link_controls':'link_controls.png','reorient':'reorient.png','align_left':'align-left.png','align_center':'align-center','align_right':'align-right','align_top':'align-top','align_middle':'align-middle','align_bottom':'align-bottom','go_up':'go-up.png','go_down':'go-down.png','ok':'save.png','cancel':'cancel.png','arrow_right':'flyouth.png','arrow_down':'dropdown.gif'},placement:{'#logo':'logo','#tool_clear div,#layer_new':'new_image','#tool_save div':'save','#tool_export div':'export','#tool_open div div':'open','#tool_import div div':'import','#tool_source':'source','#tool_docprops > div':'docprops','#tool_wireframe':'wireframe','#tool_undo':'undo','#tool_redo':'redo','#tool_select':'select','#tool_fhpath':'pencil','#tool_line':'pen','#tool_rect,#tools_rect_show':'rect','#tool_square':'square','#tool_fhrect':'fh_rect','#tool_ellipse,#tools_ellipse_show':'ellipse','#tool_circle':'circle','#tool_fhellipse':'fh_ellipse','#tool_path':'path','#tool_text,#layer_rename':'text','#tool_image':'image','#tool_zoom':'zoom','#tool_clone,#tool_clone_multi':'clone','#tool_node_clone':'node_clone','#layer_delete,#tool_delete,#tool_delete_multi':'delete','#tool_node_delete':'node_delete','#tool_add_subpath':'add_subpath','#tool_openclose_path':'open_path','#tool_move_top':'move_top','#tool_move_bottom':'move_bottom','#tool_topath':'to_path','#tool_node_link':'link_controls','#tool_reorient':'reorient','#tool_group':'group','#tool_ungroup':'ungroup','#tool_alignleft, #tool_posleft':'align_left','#tool_aligncenter, #tool_poscenter':'align_center','#tool_alignright, #tool_posright':'align_right','#tool_aligntop, #tool_postop':'align_top','#tool_alignmiddle, #tool_posmiddle':'align_middle','#tool_alignbottom, #tool_posbottom':'align_bottom','#cur_position':'align','#linecap_butt,#cur_linecap':'linecap_butt','#linecap_round':'linecap_round','#linecap_square':'linecap_square','#linejoin_miter,#cur_linejoin':'linejoin_miter','#linejoin_round':'linejoin_round','#linejoin_bevel':'linejoin_bevel','#url_notice':'warning','#layer_up':'go_up','#layer_down':'go_down','#layerlist td.layervis':'eye','#tool_source_save,#tool_docprops_save':'ok','#tool_source_cancel,#tool_docprops_cancel':'cancel','#rwidthLabel, #iwidthLabel':'width','#rheightLabel, #iheightLabel':'height','#cornerRadiusLabel span':'c_radius','#angleLabel':'angle','#zoomLabel':'zoom','#tool_fill label':'fill','#tool_stroke .icon_label':'stroke','#group_opacityLabel':'opacity','#blurLabel':'blur','#font_sizeLabel':'fontsize','.flyout_arrow_horiz':'arrow_right','.dropdown button, #main_button .dropdown':'arrow_down','#palette .palette_item:first, #fill_bg, #stroke_bg':'no_color'},resize:{'#logo .svg_icon':32,'.flyout_arrow_horiz .svg_icon':5,'.layer_button .svg_icon, #layerlist td.layervis .svg_icon':14,'.dropdown button .svg_icon':7,'#main_button .dropdown .svg_icon':9,'.palette_item:first .svg_icon, #fill_bg .svg_icon, #stroke_bg .svg_icon':16,'.toolbar_button button .svg_icon':16,'.stroke_tool div div .svg_icon':20,'#tools_bottom label .svg_icon':18},callback:function(icons){$('.toolbar_button button > svg, .toolbar_button button > img').each(function(){$(this).parent().prepend(this);});var tleft=$('#tools_left');var min_height=tleft.offset().top+tleft.outerHeight();var size=$.pref('iconsize');if(size&&size!='m'){svgEditor.setIconSize(size);}else if($(window).height()<min_height){svgEditor.setIconSize('s');}
$('.tools_flyout').each(function(){var shower=$('#'+this.id+'_show');var sel=shower.attr('data-curopt');if(!shower.children('svg, img').length){var clone=$(sel).children().clone();clone[0].removeAttribute('style');shower.append(clone);}});svgEditor.runCallbacks();}});Editor.canvas=svgCanvas=new $.SvgCanvas(document.getElementById("svgcanvas"),curConfig);var palette=["#000000","#3f3f3f","#7f7f7f","#bfbfbf","#ffffff","#ff0000","#ff7f00","#ffff00","#7fff00","#00ff00","#00ff7f","#00ffff","#007fff","#0000ff","#7f00ff","#ff00ff","#ff007f","#7f0000","#7f3f00","#7f7f00","#3f7f00","#007f00","#007f3f","#007f7f","#003f7f","#00007f","#3f007f","#7f007f","#7f003f","#ffaaaa","#ffd4aa","#ffffaa","#d4ffaa","#aaffaa","#aaffd4","#aaffff","#aad4ff","#aaaaff","#d4aaff","#ffaaff","#ffaad4",];isMac=false,modKey="",path=svgCanvas.pathActions,default_img_url=curConfig.imgPath+"logo.png",workarea=$("#workarea"),show_save_warning=false,exportWindow=null;(function(){$('#dialog_container').draggable({cancel:'#dialog_content, #dialog_buttons *'});var box=$('#dialog_box'),btn_holder=$('#dialog_buttons');var dbox=function(type,msg,callback,defText){$('#dialog_content').html('<p>'+msg.replace(/\n/g,'</p><p>')+'</p>').toggleClass('prompt',(type=='prompt'));btn_holder.empty();var ok=$('<input type="button" value="'+uiStrings.ok+'">').appendTo(btn_holder);if(type!='alert'){$('<input type="button" value="'+uiStrings.cancel+'">').appendTo(btn_holder).click(function(){box.hide();callback(false)});}
if(type=='prompt'){var input=$('<input type="text">').prependTo(btn_holder);input.val(defText||'');input.bind('keydown','return',function(){ok.click();});}
box.show();ok.click(function(){box.hide();var resp=(type=='prompt')?input.val():true;if(callback)callback(resp);}).focus();if(type=='prompt')input.focus();}
$.alert=function(msg,cb){dbox('alert',msg,cb);};$.confirm=function(msg,cb){dbox('confirm',msg,cb);};$.prompt=function(msg,txt,cb){dbox('prompt',msg,cb,txt);};}());var setSelectMode=function(){$('.tool_button_current').removeClass('tool_button_current').addClass('tool_button');$('#tool_select').addClass('tool_button_current').removeClass('tool_button');$('#styleoverrides').text('#svgcanvas svg *{cursor:move;pointer-events:all} #svgcanvas svg{cursor:default}');svgCanvas.setMode('select');};var togglePathEditMode=function(editmode,elems){$('#path_node_panel').toggle(editmode);$('#tools_bottom_2,#tools_bottom_3').toggle(!editmode);if(editmode){$('.tool_button_current').removeClass('tool_button_current').addClass('tool_button');$('#tool_select').addClass('tool_button_current').removeClass('tool_button');setIcon('#tool_select','select_node');multiselected=false;if(elems.length){selectedElement=elems[0];}}else{setIcon('#tool_select','select');}}
var flyoutspeed=1250;var textBeingEntered=false;var selectedElement=null;var multiselected=false;var editingsource=false;var docprops=false;var fillPaint=new $.jGraduate.Paint({solidColor:curConfig.initFill.color});var strokePaint=new $.jGraduate.Paint({solidColor:curConfig.initStroke.color});var saveHandler=function(window,svg){show_save_warning=false;svg="<?xml version='1.0'?>\n"+svg;var win=window.open("data:image/svg+xml;base64,"+Utils.encode64(svg));var done=$.pref('save_notice_done');if(done!=="all"){var note=uiStrings.saveFromBrowser.replace('%s','SVG');if(navigator.userAgent.indexOf('Gecko/')!==-1){if(svg.indexOf('<defs')!==-1){note+="\n\n"+uiStrings.defsFailOnSave;$.pref('save_notice_done','all');done="all";}else{$.pref('save_notice_done','part');}}else{$.pref('save_notice_done','all');}
if(done!=='part'){win.alert(note);}}};var exportHandler=function(window,data){var issues=data.issues;if(!$('#export_canvas').length){$('<canvas>',{id:'export_canvas'}).hide().appendTo('body');}
var c=$('#export_canvas')[0];c.width=svgCanvas.contentW;c.height=svgCanvas.contentH;canvg(c,data.svg);var datauri=c.toDataURL('image/png');exportWindow.location.href=datauri;var note=uiStrings.saveFromBrowser.replace('%s','PNG');if(issues.length){var pre="\n \u2022 ";note+=("\n\n"+uiStrings.noteTheseIssues+pre+issues.join(pre));}
exportWindow.alert(note);};var selectedChanged=function(window,elems){var mode=svgCanvas.getMode();var is_node=(mode=="pathedit");selectedElement=(elems.length==1||elems[1]==null?elems[0]:null);multiselected=(elems.length>=2&&elems[1]!=null);if(selectedElement!=null){if(mode!="multiselect"&&!is_node){setSelectMode();updateToolbar();}}
togglePathEditMode(is_node,elems);updateContextPanel();svgCanvas.runExtensions("selectedChanged",{elems:elems,selectedElement:selectedElement,multiselected:multiselected});};var elementChanged=function(window,elems){for(var i=0;i<elems.length;++i){var elem=elems[i];if(elem&&elem.tagName=="svg"){populateLayers();updateCanvas();}
else if(elem&&selectedElement&&selectedElement.parentNode==null||elem&&elem.tagName=="path"){selectedElement=elem;}}
show_save_warning=true;updateContextPanel();svgCanvas.runExtensions("elementChanged",{elems:elems});};var zoomChanged=function(window,bbox,autoCenter){var scrbar=15,res=svgCanvas.getResolution(),w_area=workarea,canvas_pos=$('#svgcanvas').position();w_area.css('cursor','auto');var z_info=svgCanvas.setBBoxZoom(bbox,w_area.width()-scrbar,w_area.height()-scrbar);if(!z_info)return;var zoomlevel=z_info.zoom,bb=z_info.bbox;$('#zoom').val(Math.round(zoomlevel*100));if(autoCenter){updateCanvas();}else{updateCanvas(false,{x:bb.x*zoomlevel+(bb.width*zoomlevel)/2,y:bb.y*zoomlevel+(bb.height*zoomlevel)/2});}
if(svgCanvas.getMode()=='zoom'&&bb.width){setSelectMode();}
zoomDone();}
var flyout_funcs={};var setupFlyouts=function(holders){$.each(holders,function(hold_sel,btn_opts){var buttons=$(hold_sel).children();var show_sel=hold_sel+'_show';var def=false;buttons.addClass('tool_button').unbind('click mousedown mouseup').each(function(i){var opts=btn_opts[i];flyout_funcs[opts.sel]=opts.fn;if(opts.isDefault)def=i;var func=function(){if($(this).hasClass('disabled'))return false;if(toolButtonClick(show_sel)){opts.fn();}
if(opts.icon){var icon=$.getSvgIcon(opts.icon).clone();}else{var icon=$(opts.sel).children().eq(0).clone();}
var shower=$(show_sel);icon[0].setAttribute('width',shower.width());icon[0].setAttribute('height',shower.height());shower.children(':not(.flyout_arrow_horiz)').remove();shower.append(icon).attr('data-curopt',opts.sel);}
$(this).mouseup(func);if(opts.key){$(document).bind('keydown',opts.key+'',func);}});if(def){$(show_sel).attr('data-curopt',btn_opts[def].sel);}else if(!$(show_sel).attr('data-curopt')){$(show_sel).attr('data-curopt',btn_opts[0].sel);}
var timer;$(show_sel).mousedown(function(evt){if($(show_sel).hasClass('disabled'))return false;var holder=$(show_sel.replace('_show',''));var l=holder.css('left');var w=holder.width()*-1;var time=holder.data('shown_popop')?200:0;timer=setTimeout(function(){holder.css('left',w).show().animate({left:l},150);holder.data('shown_popop',false);},time);evt.preventDefault();}).mouseup(function(){clearTimeout(timer);var opt=$(this).attr('data-curopt');if(toolButtonClick(show_sel)){flyout_funcs[opt]();}});var pos=$(show_sel).position();$(hold_sel).css({'left':pos.left+34,'top':pos.top+77});});setFlyoutTitles();}
var makeFlyoutHolder=function(id,child){var div=$('<div>',{'class':'tools_flyout',id:id}).appendTo('#svg_editor').append(child);return div;}
var setFlyoutPositions=function(){$('.tools_flyout').each(function(){var shower=$('#'+this.id+'_show');var pos=shower.offset();var w=shower.outerWidth();$(this).css({left:pos.left+w,top:pos.top});});}
var setFlyoutTitles=function(){$('.tools_flyout').each(function(){var shower=$('#'+this.id+'_show');var tooltips=[];$(this).children().each(function(){tooltips.push(this.title);});shower[0].title=tooltips.join(' / ');});}
var extAdded=function(window,ext){var cb_called=false;var runCallback=function(){if(ext.callback&&!cb_called){cb_called=true;ext.callback();}}
var btn_selects=[];if(ext.context_tools){$.each(ext.context_tools,function(i,tool){var cont_id=tool.container_id?(' id="'+tool.container_id+'"'):"";var panel=$('#'+tool.panel);if(!panel.length)
panel=$('<div>',{id:tool.panel}).appendTo("#tools_top");switch(tool.type){case'tool_button':var html='<div class="tool_button">'+tool.id+'</div>';var div=$(html).appendTo(panel);if(tool.events){$.each(tool.events,function(evt,func){$(div).bind(evt,func);});}
break;case'select':var html='<label'+cont_id+'>'
+'<select id="'+tool.id+'">';$.each(tool.options,function(val,text){var sel=(val==tool.defval)?" selected":"";html+='<option value="'+val+'"'+sel+'>'+text+'</option>';});html+="</select></label>";var sel=$(html).appendTo(panel).find('select');$.each(tool.events,function(evt,func){$(sel).bind(evt,func);});break;case'button-select':var html='<div id="'+tool.id+'" class="dropdown toolset" title="'+tool.title+'">'
+'<div id="cur_'+tool.id+'" class="icon_label"></div><button></button></div>';var list=$('<ul id="'+tool.id+'_opts"></ul>').appendTo('#option_lists');if(tool.colnum){list.addClass('optcols'+tool.colnum);}
var dropdown=$(html).appendTo(panel).children();btn_selects.push({elem:('#'+tool.id),list:('#'+tool.id+'_opts'),title:tool.title,callback:tool.events.change,cur:('#cur_'+tool.id)});break;case'input':var html='<label'+cont_id+'>'
+'<span id="'+tool.id+'_label">'
+tool.label+':</span>'
+'<input id="'+tool.id+'" title="'+tool.title
+'" size="'+(tool.size||"4")+'" value="'+(tool.defval||"")+'" type="text"/></label>'
var inp=$(html).appendTo(panel).find('input');if(tool.spindata){inp.SpinButton(tool.spindata);}
if(tool.events){$.each(tool.events,function(evt,func){inp.bind(evt,func);});}
break;default:break;}});}
if(ext.buttons){var fallback_obj={},placement_obj={},svgicons=ext.svgicons;var holders={};$.each(ext.buttons,function(i,btn){var icon;var id=btn.id;var num=i;while($('#'+id).length){id=btn.id+'_'+(++num);}
if(!svgicons){icon=$('<img src="'+btn.icon+'">');}else{fallback_obj[id]=btn.icon;var svgicon=btn.svgicon?btn.svgicon:btn.id;placement_obj['#'+id]=svgicon;}
var cls,parent;switch(btn.type){case'mode':cls='tool_button';parent="#tools_left";break;case'context':cls='tool_button';parent="#"+btn.panel;if(!$(parent).length)
$('<div>',{id:btn.panel}).appendTo("#tools_top");break;}
var button=$(btn.list?'<li/>':'<div/>').attr("id",id).attr("title",btn.title).addClass(cls);if(!btn.includeWith&&!btn.list){button.appendTo(parent);}else if(btn.list){button.addClass('push_button');$('#'+btn.list+'_opts').append(button);if(btn.isDefault){$('#cur_'+btn.list).append(button.children().clone());var svgicon=btn.svgicon?btn.svgicon:btn.id;placement_obj['#cur_'+btn.list]=svgicon;}}else if(btn.includeWith){var opts=btn.includeWith;var ref_btn=$(opts.button);var flyout_holder=ref_btn.parent();if(!ref_btn.parent().hasClass('tools_flyout')){var arr_div=$('<div>',{id:'flyout_arrow_horiz'})
var tls_id=ref_btn[0].id.replace('tool_','tools_')
var show_btn=ref_btn.clone().attr('id',tls_id+'_show').append($('<div>',{'class':'flyout_arrow_horiz'}));ref_btn.before(show_btn);flyout_holder=makeFlyoutHolder(tls_id,ref_btn);}
var ref_data=Actions.getButtonData(opts.button);if(opts.isDefault){placement_obj['#'+tls_id+'_show']=btn.id;}
var cur_h=holders['#'+flyout_holder[0].id]=[{sel:'#'+id,fn:btn.events.click,icon:btn.id,key:btn.key,isDefault:btn.includeWith?btn.includeWith.isDefault:0},ref_data];var pos=("position"in opts)?opts.position:'last';var len=flyout_holder.children().length;if(!isNaN(pos)&&pos>=0&&pos<len){flyout_holder.children().eq(pos).before(button);}else{flyout_holder.append(button);cur_h.reverse();}}
if(!svgicons){button.append(icon);}
if(!btn.list){$.each(btn.events,function(name,func){if(name=="click"){if(btn.type=='mode'){if(btn.includeWith){button.bind(name,func);}else{button.bind(name,function(){if(toolButtonClick(button)){func();}});}
if(btn.key){$(document).bind('keydown',btn.key,func);if(btn.title)button.attr("title",btn.title+' ['+btn.key+']');}}else{button.bind(name,func);}}else{button.bind(name,func);}});}
setupFlyouts(holders);});$.each(btn_selects,function(){addAltDropDown(this.elem,this.list,this.callback,{seticon:true});});$.svgIcons(svgicons,{w:24,h:24,id_match:false,no_img:true,fallback:fallback_obj,placement:placement_obj,callback:function(icons){if(curPrefs.iconsize&&curPrefs.iconsize!='m'){setIconSize(curPrefs.iconsize,true);}
runCallback();}});}
runCallback();};var getPaint=function(color,opac){var opts=null;if(color.substr(0,5)=="url(#"){var grad=document.getElementById(color.substr(5,color.length-6));opts={alpha:opac};opts[grad.tagName]=grad;}
else if(color.substr(0,1)=="#"){opts={alpha:opac,solidColor:color.substr(1)};}
else{opts={alpha:opac,solidColor:'none'};}
return new $.jGraduate.Paint(opts);};var updateToolbar=function(){if(selectedElement!=null&&$.inArray(selectedElement.tagName,['image','text','foreignObject','g','a'])===-1){var fillOpacity=parseFloat(selectedElement.getAttribute("fill-opacity"));if(isNaN(fillOpacity)){fillOpacity=1.0;}
var strokeOpacity=parseFloat(selectedElement.getAttribute("stroke-opacity"));if(isNaN(strokeOpacity)){strokeOpacity=1.0;}
var fillColor=selectedElement.getAttribute("fill")||"black";svgCanvas.setFillColor(fillColor,true);svgCanvas.setFillOpacity(fillOpacity,true);var strokeColor=selectedElement.getAttribute("stroke")||"none";svgCanvas.setStrokeColor(strokeColor,true);svgCanvas.setStrokeOpacity(strokeOpacity,true);$("#stroke_color rect").attr({fill:strokeColor,opacity:strokeOpacity});$("#fill_color rect").attr({fill:fillColor,opacity:fillOpacity});fillOpacity*=100;strokeOpacity*=100;fillPaint=getPaint(fillColor,fillOpacity);strokePaint=getPaint(strokeColor,strokeOpacity);fillOpacity=fillOpacity+" %";strokeOpacity=strokeOpacity+" %";if(fillColor=="none"){fillOpacity="N/A";}
if(strokeColor==null||strokeColor==""||strokeColor=="none"){strokeColor="none";strokeOpacity="N/A";}
$('#stroke_width').val(selectedElement.getAttribute("stroke-width")||1);$('#stroke_style').val(selectedElement.getAttribute("stroke-dasharray")||"none");var attr=selectedElement.getAttribute("stroke-linejoin")||'miter';setStrokeOpt($('#linejoin_'+attr)[0]);attr=selectedElement.getAttribute("stroke-linecap")||'butt';setStrokeOpt($('#linecap_'+attr)[0]);}
if(selectedElement!=null){var opac_perc=((selectedElement.getAttribute("opacity")||1.0)*100);$('#group_opacity').val(opac_perc);$('#opac_slider').slider('option','value',opac_perc);$('#elem_id').val(selectedElement.id);}
updateToolButtonState();};var updateContextPanel=function(){var elem=selectedElement;if(elem!=null&&!elem.parentNode)elem=null;var currentLayer=svgCanvas.getCurrentLayer();var currentMode=svgCanvas.getMode();if(currentMode=='rotate'&&elem!=null){var ang=svgCanvas.getRotationAngle(elem);$('#angle').val(ang);$('#tool_reorient').toggleClass('disabled',ang==0);return;}
var is_node=currentMode=='pathedit';$('#selected_panel, #multiselected_panel, #g_panel, #rect_panel, #circle_panel,\
     #ellipse_panel, #line_panel, #text_panel, #image_panel').hide();if(elem!=null){var elname=elem.nodeName;var angle=svgCanvas.getRotationAngle(elem);$('#angle').val(angle);var blurval=svgCanvas.getBlur(elem);$('#blur').val(blurval);$('#blur_slider').slider('option','value',blurval);if(svgCanvas.addedNew){if(elname=='image'){promptImgURL();}else if(elname=='text'){}}
if(!is_node&&currentMode!='pathedit'){$('#selected_panel').show();if($.inArray(elname,['line','circle','ellipse'])!=-1){$('#xy_panel').hide();}else{var x,y;if($.inArray(elname,['g','polyline','path'])!=-1){var bb=svgCanvas.getStrokedBBox([elem]);if(bb){x=bb.x;y=bb.y;}}else{x=elem.getAttribute('x');y=elem.getAttribute('y');}
$('#selected_x').val(x||0);$('#selected_y').val(y||0);$('#xy_panel').show();}
var no_path=$.inArray(elname,['image','text','path','g','use'])==-1;$('#tool_topath').toggle(no_path);$('#tool_reorient').toggle(elname=='path');$('#tool_reorient').toggleClass('disabled',angle==0);}else{var point=path.getNodePoint();$('#tool_add_subpath').removeClass('push_button_pressed').addClass('tool_button');$('#tool_node_delete').toggleClass('disabled',!path.canDeleteNodes);setIcon('#tool_openclose_path',path.closed_subpath?'open_path':'close_path');if(point){var seg_type=$('#seg_type');$('#path_node_x').val(point.x);$('#path_node_y').val(point.y);if(point.type){seg_type.val(point.type).removeAttr('disabled');}else{seg_type.val(4).attr('disabled','disabled');}}
return;}
var panels={g:[],rect:['rx','width','height'],image:['width','height'],circle:['cx','cy','r'],ellipse:['cx','cy','rx','ry'],line:['x1','y1','x2','y2'],text:[]};var el_name=elem.tagName;if(panels[el_name]){var cur_panel=panels[el_name];$('#'+el_name+'_panel').show();$.each(cur_panel,function(i,item){$('#'+el_name+'_'+item).val(elem.getAttribute(item)||0);});if(el_name=='text'){$('#text_panel').css("display","inline");if(svgCanvas.getItalic()){$('#tool_italic').addClass('push_button_pressed').removeClass('tool_button');}
else{$('#tool_italic').removeClass('push_button_pressed').addClass('tool_button');}
if(svgCanvas.getBold()){$('#tool_bold').addClass('push_button_pressed').removeClass('tool_button');}
else{$('#tool_bold').removeClass('push_button_pressed').addClass('tool_button');}
$('#font_family').val(elem.getAttribute("font-family"));$('#font_size').val(elem.getAttribute("font-size"));$('#text').val(elem.textContent);if(svgCanvas.addedNew){$('#text').focus().select();}}
else if(el_name=='image'){var xlinkNS="http://www.w3.org/1999/xlink";var href=elem.getAttributeNS(xlinkNS,"href");setImageURL(href);}}}
else if(multiselected){$('#multiselected_panel').show();}
if(svgCanvas.getUndoStackSize()>0){$('#tool_undo').removeClass('disabled');}
else{$('#tool_undo').addClass('disabled');}
if(svgCanvas.getRedoStackSize()>0){$('#tool_redo').removeClass('disabled');}
else{$('#tool_redo').addClass('disabled');}
svgCanvas.addedNew=false;if((elem&&!is_node)||multiselected){$('#selLayerNames').removeAttr('disabled').val(currentLayer);}
else{$('#selLayerNames').attr('disabled','disabled');}};$('#text').focus(function(){textBeingEntered=true;});$('#text').blur(function(){textBeingEntered=false;});svgCanvas.bind("selected",selectedChanged);svgCanvas.bind("changed",elementChanged);svgCanvas.bind("saved",saveHandler);svgCanvas.bind("exported",exportHandler);svgCanvas.bind("zoomed",zoomChanged);svgCanvas.bind("extension_added",extAdded);svgCanvas.textActions.setInputElem($("#text")[0]);var str='<div class="palette_item" data-rgb="none"></div>'
$.each(palette,function(i,item){str+='<div class="palette_item" style="background-color: '+item+';" data-rgb="'+item+'"></div>';});$('#palette').append(str);var color_blocks=['#FFF','#888','#000'];var str='';$.each(color_blocks,function(){str+='<div class="color_block" style="background-color:'+this+';"></div>';});$('#bg_blocks').append(str);var blocks=$('#bg_blocks div');var cur_bg='cur_background';blocks.each(function(){var blk=$(this);blk.click(function(){blocks.removeClass(cur_bg);$(this).addClass(cur_bg);});});if($.pref('bkgd_color')){setBackground($.pref('bkgd_color'),$.pref('bkgd_url'));}else if($.pref('bkgd_url')){setBackground(defaultPrefs.bkgd_color,$.pref('bkgd_url'));}
if($.pref('img_save')){curPrefs.img_save=$.pref('img_save');$('#image_save_opts input').val([curPrefs.img_save]);}
var changeRectRadius=function(ctl){svgCanvas.setRectRadius(ctl.value);}
var changeFontSize=function(ctl){svgCanvas.setFontSize(ctl.value);}
var changeStrokeWidth=function(ctl){var val=ctl.value;if(val==0&&selectedElement&&$.inArray(selectedElement.nodeName,['line','polyline'])!=-1){val=ctl.value=1;}
svgCanvas.setStrokeWidth(val);}
var changeRotationAngle=function(ctl){svgCanvas.setRotationAngle(ctl.value);$('#tool_reorient').toggleClass('disabled',ctl.value==0);}
var changeZoom=function(ctl){var zoomlevel=ctl.value/100;var zoom=svgCanvas.getZoom();var w_area=workarea;zoomChanged(window,{width:0,height:0,x:(w_area[0].scrollLeft+w_area.width()/2)/zoom,y:(w_area[0].scrollTop+w_area.height()/2)/zoom,zoom:zoomlevel},true);}
var changeOpacity=function(ctl,val){if(val==null)val=ctl.value;$('#group_opacity').val(val);if(!ctl||!ctl.handle){$('#opac_slider').slider('option','value',val);}
svgCanvas.setOpacity(val/100);}
var changeBlur=function(ctl,val,noUndo){if(val==null)val=ctl.value;$('#blur').val(val);var complete=false;if(!ctl||!ctl.handle){$('#blur_slider').slider('option','value',val);complete=true;}
if(noUndo){svgCanvas.setBlurNoUndo(val);}else{svgCanvas.setBlur(val,complete);}}
var operaRepaint=function(){if(!window.opera)return;$('<p/>').hide().appendTo('body').remove();}
$('#stroke_style').change(function(){svgCanvas.setStrokeAttr('stroke-dasharray',$(this).val());operaRepaint();});$('#stroke_linejoin').change(function(){svgCanvas.setStrokeAttr('stroke-linejoin',$(this).val());operaRepaint();});$('select').change(function(){$(this).blur();});var promptMoveLayerOnce=false;$('#selLayerNames').change(function(){var destLayer=this.options[this.selectedIndex].value;var confirm_str=uiStrings.QmoveElemsToLayer.replace('%s',destLayer);var moveToLayer=function(ok){if(!ok)return;promptMoveLayerOnce=true;svgCanvas.moveSelectedToLayer(destLayer);svgCanvas.clearSelection();populateLayers();}
if(destLayer){if(promptMoveLayerOnce){moveToLayer(true);}else{$.confirm(confirm_str,moveToLayer);}}});$('#font_family').change(function(){svgCanvas.setFontFamily(this.value);});$('#seg_type').change(function(){svgCanvas.setSegType($(this).val());});$('#text').keyup(function(){svgCanvas.setTextContent(this.value);});$('#image_url').change(function(){setImageURL(this.value);});$('.attr_changer').change(function(){var attr=this.getAttribute("data-attr");var val=this.value;var valid=svgCanvas.isValidUnit(attr,val);if(!valid){$.alert(uiStrings.invalidAttrValGiven);this.value=selectedElement.getAttribute(attr);return false;}
if(attr=="id"){var elem=selectedElement;svgCanvas.clearSelection();elem.id=val;svgCanvas.addToSelection([elem],true);}
else{svgCanvas.changeSelectedAttribute(attr,val);}});$('#palette').mouseover(function(){var inp=$('<input type="hidden">');$(this).append(inp);inp.focus().remove();});$('.palette_item').click(function(evt){var picker=(evt.shiftKey?"stroke":"fill");var id=(evt.shiftKey?'#stroke_':'#fill_');var color=$(this).attr('data-rgb');var rectbox=document.getElementById("gradbox_"+picker).parentNode.firstChild;var paint=null;if(color=='transparent'||color=='initial'){color='none';$(id+"opacity").html("N/A");paint=new $.jGraduate.Paint();}
else{paint=new $.jGraduate.Paint({alpha:100,solidColor:color.substr(1)});}
rectbox.setAttribute("fill",color);rectbox.setAttribute("opacity",1);if(evt.shiftKey){strokePaint=paint;if(svgCanvas.getStrokeColor()!=color){svgCanvas.setStrokeColor(color);}
if(color!='none'&&svgCanvas.getStrokeOpacity()!=1){svgCanvas.setStrokeOpacity(1.0);}}else{fillPaint=paint;if(svgCanvas.getFillColor()!=color){svgCanvas.setFillColor(color);}
if(color!='none'&&svgCanvas.getFillOpacity()!=1){svgCanvas.setFillOpacity(1.0);}}
updateToolButtonState();});$("#toggle_stroke_tools").toggle(function(){$(".stroke_tool").css('display','table-cell');$(this).text('<<');},function(){$(".stroke_tool").css('display','none');$(this).text('>>');});var toolButtonClick=function(button,fadeFlyouts){if($(button).hasClass('disabled'))return false;if($(button).parent().hasClass('tools_flyout'))return true;var fadeFlyouts=fadeFlyouts||'normal';$('.tools_flyout').fadeOut(fadeFlyouts);$('#styleoverrides').text('');$('.tool_button_current').removeClass('tool_button_current').addClass('tool_button');$(button).addClass('tool_button_current').removeClass('tool_button');svgCanvas.clearSelection();return true;};(function(){var last_x=null,last_y=null,w_area=workarea[0],panning=false,keypan=false;$('#svgcanvas').bind('mousemove mouseup',function(evt){if(panning===false)return;w_area.scrollLeft-=(evt.clientX-last_x);w_area.scrollTop-=(evt.clientY-last_y);last_x=evt.clientX;last_y=evt.clientY;if(evt.type==='mouseup')panning=false;return false;}).mousedown(function(evt){if(evt.button===1||keypan===true){panning=true;last_x=evt.clientX;last_y=evt.clientY;return false;}});$(window).mouseup(function(){panning=false;});$(document).bind('keydown','space',function(evt){svgCanvas.spaceKey=keypan=true;evt.preventDefault();}).bind('keyup','space',function(evt){evt.preventDefault();svgCanvas.spaceKey=keypan=false;});}());function setStrokeOpt(opt,changeElem){var id=opt.id;var bits=id.split('_');var pre=bits[0];var val=bits[1];if(changeElem){svgCanvas.setStrokeAttr('stroke-'+pre,val);}
operaRepaint();setIcon('#cur_'+pre,id,20);$(opt).addClass('current').siblings().removeClass('current');}
(function(){var button=$('#main_icon');var overlay=$('#main_icon span');var list=$('#main_menu');var on_button=false;var height=0;var js_hover=true;var set_click=false;var hideMenu=function(){list.fadeOut(200);};$(window).mouseup(function(evt){if(!on_button){button.removeClass('buttondown');if(evt.target.localName!="input"){list.fadeOut(200);}else if(!set_click){set_click=true;$(evt.target).click(function(){list.css('margin-left','-9999px').show();});}}
on_button=false;}).mousedown(function(){$('.tools_flyout:visible').fadeOut();});overlay.bind('mousedown',function(){if(!button.hasClass('buttondown')){button.addClass('buttondown').removeClass('buttonup')
list.css('margin-left',0).show();if(!height){height=list.height();}
list.css('height',0).animate({'height':height},200);on_button=true;return false;}else{button.removeClass('buttondown').addClass('buttonup');list.fadeOut(200);}}).hover(function(){on_button=true;}).mouseout(function(){on_button=false;});var list_items=$('#main_menu li');list_items.mouseover(function(){js_hover=($(this).css('background-color')=='rgba(0, 0, 0, 0)');list_items.unbind('mouseover');if(js_hover){list_items.mouseover(function(){this.style.backgroundColor='#FFC';}).mouseout(function(){this.style.backgroundColor='transparent';return true;});}});}());var addDropDown=function(elem,callback,dropUp){var button=$(elem).find('button');var list=$(elem).find('ul');var on_button=false;if(dropUp){$(elem).addClass('dropup');}
$(elem).find('li').bind('mouseup',callback);$(window).mouseup(function(evt){if(!on_button){button.removeClass('down');list.hide();}
on_button=false;});button.bind('mousedown',function(){if(!button.hasClass('down')){button.addClass('down');list.show();on_button=true;}else{button.removeClass('down');list.hide();}}).hover(function(){on_button=true;}).mouseout(function(){on_button=false;});}
var addAltDropDown=function(elem,list,callback,opts){var button=$(elem);var list=$(list);var on_button=false;var dropUp=opts.dropUp;if(dropUp){$(elem).addClass('dropup');}
list.find('li').bind('mouseup',function(){if(opts.seticon){setIcon('#cur_'+button[0].id,$(this).children());$(this).addClass('current').siblings().removeClass('current');}
callback.apply(this,arguments);});$(window).mouseup(function(evt){if(!on_button){button.removeClass('down');list.hide();list.css({top:0,left:0});}
on_button=false;});var height=list.height();$(elem).bind('mousedown',function(){var off=$(elem).offset();if(dropUp){off.top-=list.height();off.left+=8;}else{off.top+=$(elem).height();}
$(list).offset(off);if(!button.hasClass('down')){button.addClass('down');list.show();on_button=true;return false;}else{button.removeClass('down');list.hide();list.css({top:0,left:0});}}).hover(function(){on_button=true;}).mouseout(function(){on_button=false;});if(opts.multiclick){list.mousedown(function(){on_button=true;});}}
addDropDown('#font_family_dropdown',function(){var fam=$(this).text();$('#font_family').val($(this).text()).change();});addDropDown('#opacity_dropdown',function(){if($(this).find('div').length)return;var perc=parseInt($(this).text().split('%')[0]);changeOpacity(false,perc);},true);$("#opac_slider").slider({start:function(){$('#opacity_dropdown li:not(.special)').hide();},stop:function(){$('#opacity_dropdown li').show();$(window).mouseup();},slide:function(evt,ui){changeOpacity(ui);}});addDropDown('#blur_dropdown',function(){});var slideStart=false;$("#blur_slider").slider({max:10,step:.1,stop:function(evt,ui){slideStart=false;changeBlur(ui);$('#blur_dropdown li').show();$(window).mouseup();},start:function(){slideStart=true;},slide:function(evt,ui){changeBlur(ui,null,slideStart);}});addDropDown('#zoom_dropdown',function(){var item=$(this);var val=item.attr('data-val');if(val){zoomChanged(window,val);}else{changeZoom({value:parseInt(item.text())});}},true);addAltDropDown('#stroke_linecap','#linecap_opts',function(){setStrokeOpt(this,true);},{dropUp:true});addAltDropDown('#stroke_linejoin','#linejoin_opts',function(){setStrokeOpt(this,true);},{dropUp:true});addAltDropDown('#tool_position','#position_opts',function(){var letter=this.id.replace('tool_pos','').charAt(0);svgCanvas.alignSelectedElements(letter,'page');},{multiclick:true});(function(){var inp;var unfocus=function(){$(inp).blur();}
$('#svg_editor input:text:not(#text)').focus(function(){inp=this;workarea.mousedown(unfocus);}).blur(function(){workarea.unbind('mousedown',unfocus);});}());var clickSelect=function(){if(toolButtonClick('#tool_select')){svgCanvas.setMode('select');workarea.css('cursor','default');}};var clickFHPath=function(){if(toolButtonClick('#tool_fhpath')){svgCanvas.setMode('fhpath');}};var clickLine=function(){if(toolButtonClick('#tool_line')){svgCanvas.setMode('line');workarea.css('cursor','crosshair');}};var clickSquare=function(){svgCanvas.setMode('square');workarea.css('cursor','crosshair');};var clickRect=function(){svgCanvas.setMode('rect');workarea.css('cursor','crosshair');};var clickFHRect=function(){svgCanvas.setMode('fhrect');};var clickCircle=function(){svgCanvas.setMode('circle');workarea.css('cursor','crosshair');};var clickEllipse=function(){svgCanvas.setMode('ellipse');workarea.css('cursor','crosshair');};var clickFHEllipse=function(){svgCanvas.setMode('fhellipse');};var clickImage=function(){if(toolButtonClick('#tool_image')){svgCanvas.setMode('image');workarea.css('cursor','crosshair');}};var clickZoom=function(){if(toolButtonClick('#tool_zoom')){workarea.css('cursor','crosshair');svgCanvas.setMode('zoom');}};var dblclickZoom=function(){if(toolButtonClick('#tool_zoom')){zoomImage();setSelectMode();}};var clickText=function(){toolButtonClick('#tool_text');svgCanvas.setMode('text');workarea.css('cursor','text');};var clickPath=function(){toolButtonClick('#tool_path');svgCanvas.setMode('path');workarea.css('cursor','crosshair');};var deleteSelected=function(){if(selectedElement!=null||multiselected){svgCanvas.deleteSelectedElements();}};var moveToTopSelected=function(){if(selectedElement!=null){svgCanvas.moveToTopSelectedElement();}};var moveToBottomSelected=function(){if(selectedElement!=null){svgCanvas.moveToBottomSelectedElement();}};var convertToPath=function(){if(selectedElement!=null){svgCanvas.convertToPath();}}
var reorientPath=function(){if(selectedElement!=null){path.reorient();}}
var moveSelected=function(dx,dy){if(selectedElement!=null||multiselected){svgCanvas.moveSelectedElements(dx,dy);}};var linkControlPoints=function(){var linked=!$('#tool_node_link').hasClass('push_button_pressed');if(linked)
$('#tool_node_link').addClass('push_button_pressed').removeClass('tool_button');else
$('#tool_node_link').removeClass('push_button_pressed').addClass('tool_button');path.linkControlPoints(linked);}
var clonePathNode=function(){if(path.getNodePoint()){path.clonePathNode();}};var deletePathNode=function(){if(path.getNodePoint()){path.deletePathNode();}};var addSubPath=function(){var button=$('#tool_add_subpath');var sp=!button.hasClass('push_button_pressed');if(sp){button.addClass('push_button_pressed').removeClass('tool_button');}else{button.removeClass('push_button_pressed').addClass('tool_button');}
path.addSubPath(sp);};var opencloseSubPath=function(){path.opencloseSubPath();}
var selectNext=function(){svgCanvas.cycleElement(1);};var selectPrev=function(){svgCanvas.cycleElement(0);};var rotateSelected=function(cw){if(selectedElement==null||multiselected)return;var step=5;if(!cw)step*=-1;var new_angle=$('#angle').val()*1+step;svgCanvas.setRotationAngle(new_angle);updateContextPanel();};var clickClear=function(){var dims=curConfig.dimensions;$.confirm(uiStrings.QwantToClear,function(ok){if(!ok)return;setSelectMode();svgCanvas.clear();svgCanvas.setResolution(dims[0],dims[1]);updateCanvas(true);zoomImage();populateLayers();updateContextPanel();});};var clickBold=function(){svgCanvas.setBold(!svgCanvas.getBold());updateContextPanel();};var clickItalic=function(){svgCanvas.setItalic(!svgCanvas.getItalic());updateContextPanel();};var clickSave=function(){var saveOpts={'images':curPrefs.img_save,'round_digits':6}
svgCanvas.save(saveOpts);};var clickExport=function(){var str=uiStrings.loadingImage;exportWindow=window.open("data:text/html;charset=utf-8,<title>"+str+"<\/title><h1>"+str+"<\/h1>");if(window.canvg){svgCanvas.rasterExport();}else{$.getScript('canvg/rgbcolor.js',function(){$.getScript('canvg/canvg.js',function(){svgCanvas.rasterExport();});});}}
var clickOpen=function(){svgCanvas.open();};var clickImport=function(){};var clickUndo=function(){if(svgCanvas.getUndoStackSize()>0){svgCanvas.undo();populateLayers();}};var clickRedo=function(){if(svgCanvas.getRedoStackSize()>0){svgCanvas.redo();populateLayers();}};var clickGroup=function(){if(multiselected){svgCanvas.groupSelectedElements();}
else if(selectedElement&&selectedElement.tagName=='g'){svgCanvas.ungroupSelectedElement();}};var clickClone=function(){svgCanvas.cloneSelectedElements();};var clickAlign=function(){var letter=this.id.replace('tool_align','').charAt(0);svgCanvas.alignSelectedElements(letter,$('#align_relative_to').val());};var zoomImage=function(multiplier){var res=svgCanvas.getResolution();multiplier=multiplier?res.zoom*multiplier:1;$('#zoom').val(multiplier*100);svgCanvas.setZoom(multiplier);zoomDone();updateCanvas(true);};var zoomDone=function(){updateWireFrame();}
var clickWireframe=function(){var wf=!$('#tool_wireframe').hasClass('push_button_pressed');if(wf)
$('#tool_wireframe').addClass('push_button_pressed').removeClass('tool_button');else
$('#tool_wireframe').removeClass('push_button_pressed').addClass('tool_button');workarea.toggleClass('wireframe');if(supportsNonSS)return;var wf_rules=$('#wireframe_rules');if(!wf_rules.length){wf_rules=$('<style id="wireframe_rules"><\/style>').appendTo('head');}else{wf_rules.empty();}
updateWireFrame();}
var updateWireFrame=function(){if(supportsNonSS)return;var rule="#workarea.wireframe #svgcontent * { stroke-width: "+1/svgCanvas.getZoom()+"px; }";$('#wireframe_rules').text(workarea.hasClass('wireframe')?rule:"");}
var showSourceEditor=function(){if(editingsource)return;editingsource=true;var str=svgCanvas.getSvgString();$('#svg_source_textarea').val(str);$('#svg_source_editor').fadeIn();properlySourceSizeTextArea();$('#svg_source_textarea').focus();};$('#svg_docprops_container').draggable({cancel:'button,fieldset'});var showDocProperties=function(){if(docprops)return;docprops=true;$('#image_save_opts input').val([curPrefs.img_save]);var res=svgCanvas.getResolution();$('#canvas_width').val(res.w);$('#canvas_height').val(res.h);$('#canvas_title').val(svgCanvas.getDocumentTitle());var blocks=$('#bg_blocks div');var cur_bg='cur_background';var canvas_bg=$.pref('bkgd_color');var url=$.pref('bkgd_url');blocks.each(function(){var blk=$(this);var is_bg=blk.css('background-color')==canvas_bg;blk.toggleClass(cur_bg,is_bg);if(is_bg)$('#canvas_bg_url').removeClass(cur_bg);});if(!canvas_bg)blocks.eq(0).addClass(cur_bg);if(url){$('#canvas_bg_url').val(url);}
$('#svg_docprops').fadeIn();};var properlySourceSizeTextArea=function(){var height=$('#svg_source_container').height()-80;$('#svg_source_textarea').css('height',height);};var saveSourceEditor=function(){if(!editingsource)return;var saveChanges=function(){svgCanvas.clearSelection();hideSourceEditor();zoomImage();populateLayers();setTitle(svgCanvas.getDocumentTitle());}
if(!svgCanvas.setSvgString($('#svg_source_textarea').val())){$.confirm(uiStrings.QerrorsRevertToSource,function(ok){if(!ok)return false;saveChanges();});}else{saveChanges();}
setSelectMode();};var setTitle=function(title){var editor_title=$('title:first').text().split(':')[0];var new_title=editor_title+(title?': '+title:'');$('title:first').text(new_title);}
var saveDocProperties=function(){var new_title=$('#canvas_title').val();setTitle(new_title);svgCanvas.setDocumentTitle(new_title);var width=$('#canvas_width'),w=width.val();var height=$('#canvas_height'),h=height.val();if(w!="fit"&&!svgCanvas.isValidUnit('width',w)){$.alert(uiStrings.invalidAttrValGiven);width.parent().addClass('error');return false;}
width.parent().removeClass('error');if(h!="fit"&&!svgCanvas.isValidUnit('height',h)){$.alert(uiStrings.invalidAttrValGiven);height.parent().addClass('error');return false;}
height.parent().removeClass('error');if(!svgCanvas.setResolution(w,h)){$.alert(uiStrings.noContentToFitTo);return false;}
curPrefs.img_save=$('#image_save_opts :checked').val();$.pref('img_save',curPrefs.img_save);var color=$('#bg_blocks div.cur_background').css('background-color')||'#FFF';setBackground(color,$('#canvas_bg_url').val());var lang=$('#lang_select').val();if(lang!=curPrefs.lang){Editor.putLocale(lang);}
setIconSize($('#iconsize').val());updateCanvas();hideDocProperties();};function setBackground(color,url){if(color==curPrefs.bkgd_color&&url==curPrefs.bkgd_url)return;$.pref('bkgd_color',color);$.pref('bkgd_url',url);svgCanvas.setBackground(color,url);}
var setIcon=Editor.setIcon=function(elem,icon_id,forcedSize){var icon=(typeof icon_id=='string')?$.getSvgIcon(icon_id).clone():icon_id.clone();$(elem).empty().append(icon);if(forcedSize){var obj={};obj[elem+' .svg_icon']=forcedSize;$.resizeSvgIcons(obj);}else{var size=curPrefs.iconsize;if(size&&size!=='m'){var icon_sizes={s:16,m:24,l:32,xl:48},obj={};obj[elem+' .svg_icon']=icon_sizes[size];$.resizeSvgIcons(obj);}}}
var setIconSize=Editor.setIconSize=function(size,force){if(size==curPrefs.size&&!force)return;$.pref('iconsize',size);$('#iconsize').val(size);var icon_sizes={s:16,m:24,l:32,xl:48};var size_num=icon_sizes[size];$('.tool_button, .push_button, .tool_button_current, .disabled, .icon_label, #url_notice, #tool_open').find('> svg, > img').each(function(){this.setAttribute('width',size_num);this.setAttribute('height',size_num);});$.resizeSvgIcons({'.flyout_arrow_horiz > svg, .flyout_arrow_horiz > img':size_num/5,'#logo > svg, #logo > img':size_num*1.3,'#tools_bottom .icon_label > *':(size_num===16?18:size_num*.75)});if(size!='s'){$.resizeSvgIcons({'#layerbuttons svg, #layerbuttons img':size_num*.6});}
var cssResizeRules={".tool_button,\
     .push_button,\
     .tool_button_current,\
     .push_button_pressed,\
     .disabled,\
     .icon_label,\
     .tools_flyout .tool_button":{'width':{s:'16px',l:'32px',xl:'48px'},'height':{s:'16px',l:'32px',xl:'48px'},'padding':{s:'1px',l:'2px',xl:'3px'}},".tool_sep":{'height':{s:'16px',l:'32px',xl:'48px'},'margin':{s:'2px 2px',l:'2px 5px',xl:'2px 8px'}},"#main_icon":{'width':{s:'31px',l:'53px',xl:'75px'},'height':{s:'22px',l:'42px',xl:'64px'}},"#tools_top":{'left':{s:'36px',l:'60px',xl:'80px'},'height':{s:'50px',l:'88px',xl:'125px'}},"#tools_left":{'width':{s:'22px',l:'30px',xl:'38px'},'top':{s:'50px',l:'87px',xl:'125px'}},"div#workarea":{'left':{s:'27px',l:'46px',xl:'65px'},'top':{s:'50px',l:'88px',xl:'125px'},'bottom':{s:'55px',l:'98px',xl:'145px'}},"#tools_bottom":{'left':{s:'27px',l:'46px',xl:'65px'},'height':{s:'58px',l:'98px',xl:'145px'}},"#color_tools":{'border-spacing':{s:'0 1px'},'margin-top':{s:'-1px'}},"#color_tools .icon_label":{'width':{l:'43px',xl:'60px'}},".color_tool":{'height':{s:'20px'}},"#tool_opacity":{'top':{s:'1px'},'height':{s:'auto',l:'auto',xl:'auto'}},"#tools_top input, #tools_bottom input":{'margin-top':{s:'2px',l:'4px',xl:'5px'},'height':{s:'auto',l:'auto',xl:'auto'},'border':{s:'1px solid #555',l:'auto',xl:'auto'},'font-size':{s:'.9em',l:'1.2em',xl:'1.4em'}},"#zoom_panel":{'margin-top':{s:'3px',l:'4px',xl:'5px'}},"#copyright, #tools_bottom .label":{'font-size':{l:'1.5em',xl:'2em'},'line-height':{s:'15px'}},"#tools_bottom_2":{'width':{l:'295px',xl:'355px'},'top':{s:'4px'}},"#tools_top > div, #tools_top":{'line-height':{s:'17px',l:'34px',xl:'50px'}},".dropdown button":{'height':{s:'18px',l:'34px',xl:'40px'},'line-height':{s:'18px',l:'34px',xl:'40px'},'margin-top':{s:'3px'}},"#tools_top label, #tools_bottom label":{'font-size':{s:'1em',l:'1.5em',xl:'2em'},'height':{s:'25px',l:'42px',xl:'64px'}},"div.toolset":{'height':{s:'25px',l:'42px',xl:'64px'}},"#tool_bold, #tool_italic":{'font-size':{s:'1.5em',l:'3em',xl:'4.5em'}},"#sidepanels":{'top':{s:'50px',l:'88px',xl:'125px'},'bottom':{s:'51px',l:'68px',xl:'65px'}},'#layerbuttons':{'width':{l:'130px',xl:'175px'},'height':{l:'24px',xl:'30px'}},'#layerlist':{'width':{l:'128px',xl:'150px'}},'.layer_button':{'width':{l:'19px',xl:'28px'},'height':{l:'19px',xl:'28px'}},"input.spin-button":{'background-image':{l:"url('images/spinbtn_updn_big.png')",xl:"url('images/spinbtn_updn_big.png')"},'background-position':{l:'100% -5px',xl:'100% -2px'},'padding-right':{l:'24px',xl:'24px'}},"input.spin-button.up":{'background-position':{l:'100% -45px',xl:'100% -42px'}},"input.spin-button.down":{'background-position':{l:'100% -85px',xl:'100% -82px'}},"#position_opts":{'width':{all:(size_num*4)+'px'}}};var rule_elem=$('#tool_size_rules');if(!rule_elem.length){rule_elem=$('<style id="tool_size_rules"><\/style>').appendTo('head');}else{rule_elem.empty();}
if(size!='m'){var style_str='';$.each(cssResizeRules,function(selector,rules){selector='#svg_editor '+selector.replace(/,/g,', #svg_editor');style_str+=selector+'{';$.each(rules,function(prop,values){if(values[size]||values.all){style_str+=(prop+':'+(values[size]||values.all)+';');}});style_str+='}';});rule_elem.text(style_str);}
setFlyoutPositions();}
var cancelOverlays=function(){$('#dialog_box').hide();if(!editingsource&&!docprops)return;if(editingsource){var oldString=svgCanvas.getSvgString();if(oldString!=$('#svg_source_textarea').val()){$.confirm(uiStrings.QignoreSourceChanges,function(ok){if(ok)hideSourceEditor();});}else{hideSourceEditor();}}
else if(docprops){hideDocProperties();}};var hideSourceEditor=function(){$('#svg_source_editor').hide();editingsource=false;$('#svg_source_textarea').blur();};var hideDocProperties=function(){$('#svg_docprops').hide();$('#canvas_width,#canvas_height').removeAttr('disabled');$('#resolution')[0].selectedIndex=0;$('#image_save_opts input').val([curPrefs.img_save]);docprops=false;};var win_wh={width:$(window).width(),height:$(window).height()};$(window).resize(function(evt){if(editingsource){properlySourceSizeTextArea();}
$.each(win_wh,function(type,val){var curval=$(window)[type]();workarea[0]['scroll'+(type==='width'?'Left':'Top')]-=(curval-val)/2;win_wh[type]=curval;});});$('#url_notice').click(function(){$.alert(this.title);});$('#change_image_url').click(promptImgURL);function promptImgURL(){$.prompt(uiStrings.enterNewImgURL,default_img_url,function(url){if(url)setImageURL(url);});}
function setImageURL(url){if(!url)url=default_img_url;svgCanvas.setImageURL(url);$('#image_url').val(url);if(url.indexOf('data:')===0){$('#image_url').hide();$('#change_image_url').show();}else{svgCanvas.embedImage(url,function(datauri){if(!datauri){$('#url_notice').show();}else{$('#url_notice').hide();}
default_img_url=url;});$('#image_url').show();$('#change_image_url').hide();}}
(function(){var toolnames=['clear','open','save','source','delete','delete_multi','paste','clone','clone_multi','move_top','move_bottom'];var all_tools='';var cur_class='tool_button_current';$.each(toolnames,function(i,item){all_tools+='#tool_'+item+(i==toolnames.length-1?',':'');});$(all_tools).mousedown(function(){$(this).addClass(cur_class);}).bind('mousedown mouseout',function(){$(this).removeClass(cur_class);});$('#tool_undo, #tool_redo').mousedown(function(){if(!$(this).hasClass('disabled'))$(this).addClass(cur_class);}).bind('mousedown mouseout',function(){$(this).removeClass(cur_class);});}());if(isMac){var shortcutButtons=["tool_clear","tool_save","tool_source","tool_undo","tool_redo","tool_clone"];var i=shortcutButtons.length;while(i--){var button=document.getElementById(shortcutButtons[i]);var title=button.title;var index=title.indexOf("Ctrl+");button.title=[title.substr(0,index),"Cmd+",title.substr(index+5)].join('');}}
var colorPicker=function(elem){var picker=elem.attr('id')=='stroke_color'?'stroke':'fill';var paint=(picker=='stroke'?strokePaint:fillPaint);var title=(picker=='stroke'?'Pick a Stroke Paint and Opacity':'Pick a Fill Paint and Opacity');var was_none=false;var pos=elem.position();$("#color_picker").draggable({cancel:'.jPicker_table,.jGraduate_lgPick,.jGraduate_rgPick'}).css({'left':pos.left,'bottom':50-pos.top}).jGraduate({paint:paint,window:{pickerTitle:title},images:{clientPath:"jgraduate/images/"}},function(p){paint=new $.jGraduate.Paint(p);var oldgrad=document.getElementById("gradbox_"+picker);var svgbox=oldgrad.parentNode;var rectbox=svgbox.firstChild;if(paint.type=="linearGradient"||paint.type=="radialGradient"){svgbox.removeChild(oldgrad);var newgrad=svgbox.appendChild(document.importNode(paint[paint.type],true));svgCanvas.fixOperaXML(newgrad,paint[paint.type])
newgrad.id="gradbox_"+picker;rectbox.setAttribute("fill","url(#gradbox_"+picker+")");rectbox.setAttribute("opacity",paint.alpha/100);}
else{rectbox.setAttribute("fill",paint.solidColor!="none"?"#"+paint.solidColor:"none");rectbox.setAttribute("opacity",paint.alpha/100);}
if(picker=='stroke'){svgCanvas.setStrokePaint(paint,true);strokePaint=paint;}
else{svgCanvas.setFillPaint(paint,true);fillPaint=paint;}
updateToolbar();$('#color_picker').hide();},function(p){$('#color_picker').hide();});};var updateToolButtonState=function(){var bNoFill=(svgCanvas.getFillColor()=='none');var bNoStroke=(svgCanvas.getStrokeColor()=='none');var buttonsNeedingStroke=['#tool_fhpath','#tool_line'];var buttonsNeedingFillAndStroke=['#tools_rect .tool_button','#tools_ellipse .tool_button','#tool_text','#tool_path'];if(bNoStroke){for(index in buttonsNeedingStroke){var button=buttonsNeedingStroke[index];if($(button).hasClass('tool_button_current')){clickSelect();}
$(button).addClass('disabled');}}
else{for(index in buttonsNeedingStroke){var button=buttonsNeedingStroke[index];$(button).removeClass('disabled');}}
if(bNoStroke&&bNoFill){for(index in buttonsNeedingFillAndStroke){var button=buttonsNeedingFillAndStroke[index];if($(button).hasClass('tool_button_current')){clickSelect();}
$(button).addClass('disabled');}}
else{for(index in buttonsNeedingFillAndStroke){var button=buttonsNeedingFillAndStroke[index];$(button).removeClass('disabled');}}
svgCanvas.runExtensions("toolButtonStateUpdate",{nofill:bNoFill,nostroke:bNoStroke});$('.tools_flyout').each(function(){var shower=$('#'+this.id+'_show');var has_enabled=false;$(this).children().each(function(){if(!$(this).hasClass('disabled')){has_enabled=true;}});shower.toggleClass('disabled',!has_enabled);});operaRepaint();};var svgdocbox=new DOMParser().parseFromString('<svg xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%"\
    fill="#'+curConfig.initFill.color+'" opacity="'+curConfig.initFill.opacity+'"/>\
    <linearGradient id="gradbox_">\
      <stop stop-color="#000" offset="0.0"/>\
      <stop stop-color="#FF0000" offset="1.0"/>\
    </linearGradient></svg>','text/xml');var boxgrad=svgdocbox.getElementById('gradbox_');boxgrad.id='gradbox_fill';svgdocbox.documentElement.setAttribute('width',16.5);$('#fill_color').append(document.importNode(svgdocbox.documentElement,true));boxgrad.id='gradbox_stroke';svgdocbox.documentElement.setAttribute('width',16.5);$('#stroke_color').append(document.importNode(svgdocbox.documentElement,true));$('#stroke_color rect').attr({'fill':'#'+curConfig.initStroke.color,'opacity':curConfig.initStroke.opacity});$('#stroke_width').val(curConfig.initStroke.width);$('#group_opacity').val(curConfig.initOpacity*100);var test_el=svgdocbox.documentElement.firstChild;test_el.setAttribute('style','vector-effect:non-scaling-stroke');var supportsNonSS=(test_el.style.vectorEffect=='non-scaling-stroke');test_el.removeAttribute('style');var blur_test=svgdocbox.createElementNS('http://www.w3.org/2000/svg','feGaussianBlur');if(typeof blur_test.stdDeviationX==="undefined"){$('#tool_blur').hide();}
$(blur_test).remove();setTimeout(function(){svgCanvas.embedImage('images/logo.png',function(datauri){if(!datauri){$('#image_save_opts [value=embed]').attr('disabled','disabled');$('#image_save_opts input').val(['ref']);curPrefs.img_save='ref';$('#image_opt_embed').css('color','#666').attr('title',uiStrings.featNotSupported);}});},1000);$('#fill_color, #tool_fill .icon_label').click(function(){colorPicker($('#fill_color'));updateToolButtonState();});$('#stroke_color, #tool_stroke .icon_label').click(function(){colorPicker($('#stroke_color'));updateToolButtonState();});$('#group_opacityLabel').click(function(){$('#opacity_dropdown button').mousedown();$(window).mouseup();});$('#zoomLabel').click(function(){$('#zoom_dropdown button').mousedown();$(window).mouseup();});$('#tool_move_top').mousedown(function(evt){$('#tools_stacking').show();evt.preventDefault();});$('.layer_button').mousedown(function(){$(this).addClass('layer_buttonpressed');}).mouseout(function(){$(this).removeClass('layer_buttonpressed');}).mouseup(function(){$(this).removeClass('layer_buttonpressed');});$('.push_button').mousedown(function(){if(!$(this).hasClass('disabled')){$(this).addClass('push_button_pressed').removeClass('push_button');}}).mouseout(function(){$(this).removeClass('push_button_pressed').addClass('push_button');}).mouseup(function(){$(this).removeClass('push_button_pressed').addClass('push_button');});$('#layer_new').click(function(){var curNames=new Array(svgCanvas.getNumLayers());for(var i=0;i<curNames.length;++i){curNames[i]=svgCanvas.getLayer(i);}
var j=(curNames.length+1);var uniqName=uiStrings.layer+" "+j;while($.inArray(uniqName,curNames)!=-1){j++;uniqName=uiStrings.layer+" "+j;}
$.prompt(uiStrings.enterUniqueLayerName,uniqName,function(newName){if(!newName)return;if($.inArray(newName,curNames)!=-1){$.alert(uiStrings.dupeLayerName);return;}
svgCanvas.createLayer(newName);updateContextPanel();populateLayers();$('#layerlist tr.layer').removeClass("layersel");$('#layerlist tr.layer:first').addClass("layersel");});});$('#layer_delete').click(function(){if(svgCanvas.deleteCurrentLayer()){updateContextPanel();populateLayers();$('#layerlist tr.layer').removeClass("layersel");$('#layerlist tr.layer:first').addClass("layersel");}});$('#layer_up').click(function(){var curIndex=$('#layerlist tr.layersel').prevAll().length;if(curIndex>0){var total=$('#layerlist tr.layer').length;curIndex--;svgCanvas.setCurrentLayerPosition(total-curIndex-1);populateLayers();$('#layerlist tr.layer').removeClass("layersel");$('#layerlist tr.layer:eq('+curIndex+')').addClass("layersel");}});$('#layer_down').click(function(){var curIndex=$('#layerlist tr.layersel').prevAll().length;var total=$('#layerlist tr.layer').length;if(curIndex<total-1){curIndex++;svgCanvas.setCurrentLayerPosition(total-curIndex-1);populateLayers();$('#layerlist tr.layer').removeClass("layersel");$('#layerlist tr.layer:eq('+curIndex+')').addClass("layersel");}});$('#layer_rename').click(function(){var curIndex=$('#layerlist tr.layersel').prevAll().length;var oldName=$('#layerlist tr.layersel td.layername').text();$.prompt(uiStrings.enterNewLayerName,"",function(newName){if(!newName)return;if(oldName==newName){$.alert(uiStrings.layerHasThatName);return;}
var curNames=new Array(svgCanvas.getNumLayers());for(var i=0;i<curNames.length;++i){curNames[i]=svgCanvas.getLayer(i);}
if($.inArray(newName,curNames)!=-1){$.alert(uiStrings.layerHasThatName);return;}
svgCanvas.renameCurrentLayer(newName);populateLayers();$('#layerlist tr.layer').removeClass("layersel");$('#layerlist tr.layer:eq('+curIndex+')').addClass("layersel");});});var SIDEPANEL_MAXWIDTH=300;var SIDEPANEL_OPENWIDTH=150;var sidedrag=-1,sidedragging=false,allowmove=false;var resizePanel=function(evt){if(!allowmove)return;if(sidedrag==-1)return;sidedragging=true;var deltax=sidedrag-evt.pageX;var sidepanels=$('#sidepanels');var sidewidth=parseInt(sidepanels.css('width'));if(sidewidth+deltax>SIDEPANEL_MAXWIDTH){deltax=SIDEPANEL_MAXWIDTH-sidewidth;sidewidth=SIDEPANEL_MAXWIDTH;}
else if(sidewidth+deltax<2){deltax=2-sidewidth;sidewidth=2;}
if(deltax==0)return;sidedrag-=deltax;var layerpanel=$('#layerpanel');workarea.css('right',parseInt(workarea.css('right'))+deltax);sidepanels.css('width',parseInt(sidepanels.css('width'))+deltax);layerpanel.css('width',parseInt(layerpanel.css('width'))+deltax);}
$('#sidepanel_handle').mousedown(function(evt){sidedrag=evt.pageX;$(window).mousemove(resizePanel);allowmove=false;setTimeout(function(){allowmove=true;},20);}).mouseup(function(evt){if(!sidedragging)toggleSidePanel();sidedrag=-1;sidedragging=false;});$(window).mouseup(function(){sidedrag=-1;sidedragging=false;$('#svg_editor').unbind('mousemove',resizePanel);});var toggleSidePanel=function(close){var w=parseInt($('#sidepanels').css('width'));var deltax=(w>2||close?2:SIDEPANEL_OPENWIDTH)-w;var sidepanels=$('#sidepanels');var layerpanel=$('#layerpanel');workarea.css('right',parseInt(workarea.css('right'))+deltax);sidepanels.css('width',parseInt(sidepanels.css('width'))+deltax);layerpanel.css('width',parseInt(layerpanel.css('width'))+deltax);};var toggleHighlightLayer=function(layerNameToHighlight){var curNames=new Array(svgCanvas.getNumLayers());for(var i=0;i<curNames.length;++i){curNames[i]=svgCanvas.getLayer(i);}
if(layerNameToHighlight){for(var i=0;i<curNames.length;++i){if(curNames[i]!=layerNameToHighlight){svgCanvas.setLayerOpacity(curNames[i],0.5);}}}
else{for(var i=0;i<curNames.length;++i){svgCanvas.setLayerOpacity(curNames[i],1.0);}}};var populateLayers=function(){var layerlist=$('#layerlist tbody');var selLayerNames=$('#selLayerNames');layerlist.empty();selLayerNames.empty();var currentlayer=svgCanvas.getCurrentLayer();var layer=svgCanvas.getNumLayers();var icon=$.getSvgIcon('eye');while(layer--){var name=svgCanvas.getLayer(layer);var appendstr="<tr class=\"layer";if(name==currentlayer){appendstr+=" layersel"}
appendstr+="\">";if(svgCanvas.getLayerVisibility(name)){appendstr+="<td class=\"layervis\"/><td class=\"layername\" >"+name+"</td></tr>";}
else{appendstr+="<td class=\"layervis layerinvis\"/><td class=\"layername\" >"+name+"</td></tr>";}
layerlist.append(appendstr);selLayerNames.append("<option value=\""+name+"\">"+name+"</option>");}
if(icon!==undefined){var copy=icon.clone();$('td.layervis',layerlist).append(icon.clone());$.resizeSvgIcons({'td.layervis .svg_icon':14});}
$('#layerlist td.layername').click(function(evt){$('#layerlist tr.layer').removeClass("layersel");var row=$(this.parentNode);row.addClass("layersel");svgCanvas.setCurrentLayer(this.textContent);evt.preventDefault();}).mouseover(function(evt){$(this).css({"font-style":"italic","color":"blue"});toggleHighlightLayer(this.textContent);}).mouseout(function(evt){$(this).css({"font-style":"normal","color":"black"});toggleHighlightLayer();});$('#layerlist td.layervis').click(function(evt){var row=$(this.parentNode).prevAll().length;var name=$('#layerlist tr.layer:eq('+row+') td.layername').text();var vis=$(this).hasClass('layerinvis');svgCanvas.setLayerVisibility(name,vis);if(vis){$(this).removeClass('layerinvis');}
else{$(this).addClass('layerinvis');}});var num=5-$('#layerlist tr.layer').size();while(num-->0){layerlist.append("<tr><td style=\"color:white\">_</td><td/></tr>");}};populateLayers();var centerCanvas=function(){workarea.css('line-height',workarea.height()+'px');};$(window).bind('load resize',centerCanvas);function stepFontSize(elem,step){var orig_val=elem.value-0;var sug_val=orig_val+step;var increasing=sug_val>=orig_val;if(step===0)return orig_val;if(orig_val>=24){if(increasing){return Math.round(orig_val*1.1);}else{return Math.round(orig_val/1.1);}}else if(orig_val<=1){if(increasing){return orig_val*2;}else{return orig_val/2;}}else{return sug_val;}}
function stepZoom(elem,step){var orig_val=elem.value-0;if(orig_val===0)return 100;var sug_val=orig_val+step;if(step===0)return orig_val;if(orig_val>=100){return sug_val;}else{if(sug_val>=orig_val){return orig_val*2;}else{return orig_val/2;}}}
$('#resolution').change(function(){var wh=$('#canvas_width,#canvas_height');if(!this.selectedIndex){if($('#canvas_width').val()=='fit'){wh.removeAttr("disabled").val(100);}}else if(this.value=='content'){wh.val('fit').attr("disabled","disabled");}else{var dims=this.value.split('x');$('#canvas_width').val(dims[0]);$('#canvas_height').val(dims[1]);wh.removeAttr("disabled");}});$('input,select').attr("autocomplete","off");var Actions=function(){var tool_buttons=[{sel:'#tool_select',fn:clickSelect,evt:'click',key:1},{sel:'#tool_fhpath',fn:clickFHPath,evt:'click',key:2},{sel:'#tool_line',fn:clickLine,evt:'click',key:3},{sel:'#tool_rect',fn:clickRect,evt:'mouseup',key:4,parent:'#tools_rect',icon:'rect'},{sel:'#tool_square',fn:clickSquare,evt:'mouseup',key:'Shift+4',parent:'#tools_rect',icon:'square'},{sel:'#tool_fhrect',fn:clickFHRect,evt:'mouseup',parent:'#tools_rect',icon:'fh_rect'},{sel:'#tool_ellipse',fn:clickEllipse,evt:'mouseup',key:5,parent:'#tools_ellipse',icon:'ellipse'},{sel:'#tool_circle',fn:clickCircle,evt:'mouseup',key:'Shift+5',parent:'#tools_ellipse',icon:'circle'},{sel:'#tool_fhellipse',fn:clickFHEllipse,evt:'mouseup',parent:'#tools_ellipse',icon:'fh_ellipse'},{sel:'#tool_path',fn:clickPath,evt:'click',key:6},{sel:'#tool_text',fn:clickText,evt:'click',key:7},{sel:'#tool_image',fn:clickImage,evt:'mouseup',key:8},{sel:'#tool_zoom',fn:clickZoom,evt:'mouseup',key:9},{sel:'#tool_clear',fn:clickClear,evt:'mouseup',key:[modKey+'N',true]},{sel:'#tool_save',fn:function(){editingsource?saveSourceEditor():clickSave()},evt:'mouseup',key:[modKey+'S',true]},{sel:'#tool_export',fn:clickExport,evt:'mouseup'},{sel:'#tool_open',fn:clickOpen,evt:'mouseup',key:[modKey+'O',true]},{sel:'#tool_import',fn:clickImport,evt:'mouseup'},{sel:'#tool_source',fn:showSourceEditor,evt:'click',key:['U',true]},{sel:'#tool_wireframe',fn:clickWireframe,evt:'click',key:['F',true]},{sel:'#tool_source_cancel,#svg_source_overlay,#tool_docprops_cancel',fn:cancelOverlays,evt:'click',key:['esc',false,false],hidekey:true},{sel:'#tool_source_save',fn:saveSourceEditor,evt:'click'},{sel:'#tool_docprops_save',fn:saveDocProperties,evt:'click'},{sel:'#tool_docprops',fn:showDocProperties,evt:'mouseup',key:[modKey+'P',true]},{sel:'#tool_delete,#tool_delete_multi',fn:deleteSelected,evt:'click',key:['del/backspace',true]},{sel:'#tool_reorient',fn:reorientPath,evt:'click'},{sel:'#tool_node_link',fn:linkControlPoints,evt:'click'},{sel:'#tool_node_clone',fn:clonePathNode,evt:'click'},{sel:'#tool_node_delete',fn:deletePathNode,evt:'click'},{sel:'#tool_openclose_path',fn:opencloseSubPath,evt:'click'},{sel:'#tool_add_subpath',fn:addSubPath,evt:'click'},{sel:'#tool_move_top',fn:moveToTopSelected,evt:'click',key:'shift+up'},{sel:'#tool_move_bottom',fn:moveToBottomSelected,evt:'click',key:'shift+down'},{sel:'#tool_topath',fn:convertToPath,evt:'click'},{sel:'#tool_undo',fn:clickUndo,evt:'click',key:[modKey+'Z',true]},{sel:'#tool_redo',fn:clickRedo,evt:'click',key:[modKey+'Y',true]},{sel:'#tool_clone,#tool_clone_multi',fn:clickClone,evt:'click',key:[modKey+'C',true]},{sel:'#tool_group',fn:clickGroup,evt:'click',key:[modKey+'G',true]},{sel:'#tool_ungroup',fn:clickGroup,evt:'click'},{sel:'[id^=tool_align]',fn:clickAlign,evt:'click'},{sel:'#tool_bold',fn:clickBold,evt:'mousedown'},{sel:'#tool_italic',fn:clickItalic,evt:'mousedown'},{sel:'#sidepanel_handle',fn:toggleSidePanel,key:[modKey+'X']},{key:'shift+left',fn:function(){rotateSelected(0)}},{key:'shift+right',fn:function(){rotateSelected(1)}},{key:'shift+O',fn:selectPrev},{key:'shift+P',fn:selectNext},{key:['ctrl+up',true],fn:function(){zoomImage(2);}},{key:['ctrl+down',true],fn:function(){zoomImage(.5);}},{key:['up',true],fn:function(){moveSelected(0,-1);}},{key:['down',true],fn:function(){moveSelected(0,1);}},{key:['left',true],fn:function(){moveSelected(-1,0);}},{key:['right',true],fn:function(){moveSelected(1,0);}},{key:'A',fn:function(){svgCanvas.selectAllInCurrentLayer();}}];var key_assocs={'4/Shift+4':'#tools_rect_show','5/Shift+5':'#tools_ellipse_show'};return{setAll:function(){var flyouts={};$.each(tool_buttons,function(i,opts){if(opts.sel){var btn=$(opts.sel);if(opts.evt){btn[opts.evt](opts.fn);}
if(opts.parent){var f_h=$(opts.parent);if(!f_h.length){f_h=makeFlyoutHolder(opts.parent.substr(1));}
f_h.append(btn);if(!$.isArray(flyouts[opts.parent])){flyouts[opts.parent]=[];}
flyouts[opts.parent].push(opts);}}
if(opts.key){var keyval,shortcut='',disInInp=true,fn=opts.fn,pd=false;if($.isArray(opts.key)){keyval=opts.key[0];if(opts.key.length>1)pd=opts.key[1];if(opts.key.length>2)disInInp=opts.key[2];}else{keyval=opts.key;}
keyval+='';$.each(keyval.split('/'),function(i,key){$(document).bind('keydown',key,function(e){fn();if(pd){e.preventDefault();}
return false;});});if(opts.sel&&!opts.hidekey){var new_title=btn.attr('title').split('[')[0]+'['+keyval+']';key_assocs[keyval]=opts.sel;if(!btn.parents('#main_menu').length){btn.attr('title',new_title);}}}});setupFlyouts(flyouts);$('.attr_changer, #image_url').bind('keydown','return',function(evt){$(this).change();evt.preventDefault();});$('#tool_zoom').dblclick(dblclickZoom);},setTitles:function(){$.each(key_assocs,function(keyval,sel){var menu=($(sel).parents('#main_menu').length);$(sel).each(function(){if(menu){var t=$(this).text().split(' [')[0];}else{var t=this.title.split(' [')[0];}
var key_str='';$.each(keyval.split('/'),function(i,key){var mod_bits=key.split('+'),mod='';if(mod_bits.length>1){mod=mod_bits[0]+'+';key=mod_bits[1];}
key_str+=(i?'/':'')+mod+(uiStrings['key_'+key]||key);});if(menu){this.lastChild.textContent=t+' ['+key_str+']';}else{this.title=t+' ['+key_str+']';}});});},getButtonData:function(sel){var b;$.each(tool_buttons,function(i,btn){if(btn.sel===sel)b=btn;});return b;}};}();Actions.setAll();Editor.ready(function(){var itool=curConfig.initTool,container=$("#tools_left, #svg_editor .tools_flyout"),pre_tool=container.find("#tool_"+itool),reg_tool=container.find("#"+itool);if(pre_tool.length){tool=pre_tool;}else if(reg_tool.length){tool=reg_tool;}else{tool=$("#tool_select");}
tool.click().mouseup();if(curConfig.wireframe){$('#tool_wireframe').click();}
if(curConfig.showlayers){toggleSidePanel();}});$('#rect_rx').SpinButton({min:0,max:1000,step:1,callback:changeRectRadius});$('#stroke_width').SpinButton({min:0,max:99,step:1,smallStep:0.1,callback:changeStrokeWidth});$('#angle').SpinButton({min:-180,max:180,step:5,callback:changeRotationAngle});$('#font_size').SpinButton({step:1,min:0.001,stepfunc:stepFontSize,callback:changeFontSize});$('#group_opacity').SpinButton({step:5,min:0,max:100,callback:changeOpacity});$('#blur').SpinButton({step:.1,min:0,max:10,callback:changeBlur});$('#zoom').SpinButton({min:0.001,max:10000,step:50,stepfunc:stepZoom,callback:changeZoom});window.onbeforeunload=function(){if(svgCanvas.getHistoryPosition()===0){show_save_warning=false;}
if(!curConfig.no_save_warning&&show_save_warning){return"There are unsaved changes.";}};if(window.FileReader){var inp=$('<input type="file">').change(function(){var f=this;var openFile=function(ok){if(!ok)return;svgCanvas.clear();if(f.files.length==1){var reader=new FileReader();reader.onloadend=function(e){svgCanvas.setSvgString(e.target.result);updateCanvas();};reader.readAsText(f.files[0]);}}
$('#main_menu').hide();if(svgCanvas.getHistoryPosition()===0){openFile(true);}else{$.confirm(uiStrings.QwantToOpen,openFile);}});$("#tool_open").show().prepend(inp);var inp2=$('<input type="file">').change(function(){$('#main_menu').hide();if(this.files.length==1){var reader=new FileReader();reader.onloadend=function(e){svgCanvas.importSvgString(e.target.result);updateCanvas();};reader.readAsText(this.files[0]);}});$("#tool_import").show().prepend(inp2);}
var updateCanvas=function(center,new_ctr){var w=workarea.width(),h=workarea.height();var w_orig=w,h_orig=h;var zoom=svgCanvas.getZoom();var w_area=workarea;var cnvs=$("#svgcanvas");var old_ctr={x:w_area[0].scrollLeft+w_orig/2,y:w_area[0].scrollTop+h_orig/2};var multi=curConfig.canvas_expansion;w=Math.max(w_orig,svgCanvas.contentW*zoom*multi);h=Math.max(h_orig,svgCanvas.contentH*zoom*multi);if(w==w_orig&&h==h_orig){workarea.css('overflow','hidden');}else{workarea.css('overflow','scroll');}
var old_can_y=cnvs.height()/2;var old_can_x=cnvs.width()/2;cnvs.width(w).height(h);var new_can_y=h/2;var new_can_x=w/2;var offset=svgCanvas.updateCanvas(w,h);var ratio=new_can_x/old_can_x;var scroll_x=w/2-w_orig/2;var scroll_y=h/2-h_orig/2;if(!new_ctr){var old_dist_x=old_ctr.x-old_can_x;var new_x=new_can_x+old_dist_x*ratio;var old_dist_y=old_ctr.y-old_can_y;var new_y=new_can_y+old_dist_y*ratio;new_ctr={x:new_x,y:new_y};}else{new_ctr.x+=offset.x,new_ctr.y+=offset.y;}
if(center){w_area[0].scrollLeft=scroll_x;w_area[0].scrollTop=scroll_y;}else{w_area[0].scrollLeft=new_ctr.x-w_orig/2;w_area[0].scrollTop=new_ctr.y-h_orig/2;}}
updateCanvas(true);try{json_encode=function(obj){if(window.JSON&&JSON.stringify)return JSON.stringify(obj);var enc=arguments.callee;if(typeof obj=="boolean"||typeof obj=="number"){return obj+''}else if(typeof obj=="string"){return'"'+
obj.replace(/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,function(a){return'\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4);})
+'"';}else if(obj.length){for(var i=0;i<obj.length;i++){obj[i]=enc(obj[i]);}
return"["+obj.join(",")+"]";}else{var pairs=[];for(var k in obj){pairs.push(enc(k)+":"+enc(obj[k]));}
return"{"+pairs.join(",")+"}"}}
window.addEventListener("message",function(e){var cbid=parseInt(e.data.substr(0,e.data.indexOf(";")));try{e.source.postMessage("SVGe"+cbid+";"+json_encode(eval(e.data)),e.origin);}catch(err){e.source.postMessage("SVGe"+cbid+";error:"+err.message,e.origin);}},false)}catch(err){window.embed_error=err;}
window.svgCanvas=svgCanvas;svgCanvas.ready=svgEditor.ready;Editor.setLang=function(lang,strings){$.pref('lang',lang);$('#lang_select').val(lang);if(strings){var oldLayerName=$('#layerlist tr.layersel td.layername').text();var rename_layer=(oldLayerName==uiStrings.layer+' 1');$.extend(uiStrings,strings);svgCanvas.setUiStrings(strings);Actions.setTitles();if(rename_layer){svgCanvas.renameCurrentLayer(uiStrings.layer+' 1');populateLayers();}
svgCanvas.runExtensions("langChanged",lang);setFlyoutTitles();var elems={'#stroke_color':'#tool_stroke .icon_label, #tool_stroke .color_block','#fill_color':'#tool_fill label, #tool_fill .color_block','#linejoin_miter':'#cur_linejoin','#linecap_butt':'#cur_linecap'}
$.each(elems,function(source,dest){$(dest).attr('title',$(source)[0].title);});$('#multiselected_panel div[id^=tool_align]').each(function(){$('#tool_pos'+this.id.substr(10))[0].title=this.title;});}};};var callbacks=[];Editor.ready=function(cb){if(!is_ready){callbacks.push(cb);}else{cb();}};Editor.runCallbacks=function(){$.each(callbacks,function(){this();});is_ready=true;};Editor.loadFromString=function(str){Editor.ready(function(){svgCanvas.setSvgString(str);});};Editor.loadFromURL=function(url){Editor.ready(function(){$.ajax({'url':url,'dataType':'text',success:svgCanvas.setSvgString,error:function(xhr,stat,err){if(xhr.responseText){svgCanvas.setSvgString(xhr.responseText);}else{$.alert("Unable to load from URL. Error: \n"+err+'');}}});});};Editor.loadFromDataURI=function(str){Editor.ready(function(){svgCanvas.setSvgString(str);var pre='data:image/svg+xml;base64,';var src=str.substring(pre.length);svgCanvas.setSvgString(Utils.decode64(src));});};Editor.addExtension=function(){var args=arguments;svgCanvas.addExtension.apply(this,args);};return Editor;}(jQuery);$(svgEditor.init());})();if(typeof eventManager!='undefined'){eventManager.fire('scriptLoaded','vle/node/draw/svg-edit/svg-editor.js');};;var svgEditor=(function($,Editor){Editor.putLocale=function(given_param,good_langs){var lang_param;if(given_param){lang_param=given_param}else{lang_param=$.pref("lang");if(!lang_param){if(navigator.userLanguage){lang_param=navigator.userLanguage}else{if(navigator.language){lang_param=navigator.language}}if(lang_param==""){return}}if($.inArray(lang_param,good_langs)==-1){lang_param="en"}if(lang_param.indexOf("en")==0){return}}var conf=Editor.curConfig;var url=conf.langPath+"lang."+lang_param+".js";var processFile=function(data){var LangData=eval(data),js_strings;var more=Editor.canvas.runExtensions("addLangData",lang_param,true);$.each(more,function(i,m){if(m.data){LangData=$.merge(LangData,m.data)}});$.each(LangData,function(i,data){if(data.id){var elem=$("#svg_editor").parent().find("#"+data.id)[0];if(elem){if(data.title){elem.title=data.title}if(data.textContent){$.each(elem.childNodes,function(j,node){if(node.nodeType==3&&$.trim(node.textContent)){node.textContent=data.textContent}})}}}else{if(data.js_strings){js_strings=data.js_strings}}});Editor.setLang(lang_param,js_strings)};$.ajax({url:url,dataType:"text",success:processFile,error:function(xhr){if(xhr.responseText){processFile(xhr.responseText)}}})};return Editor}(jQuery,svgEditor));if(typeof eventManager!='undefined'){eventManager.fire('scriptLoaded','vle/node/draw/svg-edit/locale/locale.min.js');};;(function(e,a){var d=function(t,k){var o=this,j=t.find("img"),B=0,A=100,s=100,z=0,w=100,r=100,q=0,p=0,m,n=function(x){var y=t.offset();m={left:y.left+parseInt(t.css("border-left-width")),top:y.top+parseInt(t.css("border-top-width"))};u(x);o.draw();e(document).bind("mousemove",l).bind("mouseup",h);x.stopPropagation();x.preventDefault();return false;},l=function(x){u(x);o.draw();x.stopPropagation();x.preventDefault();return false;},h=function(x){e(document).unbind("mouseup",h).unbind("mousemove",l);x.stopPropagation();x.preventDefault();return false;},u=function(E){var C=E.pageX-m.left,x=E.pageY-m.top,D=t.w,y=t.h;if(C<0){C=0;}else{if(C>D){C=D;}}if(x<0){x=0;}else{if(x>y){x=y;}}o.set_X(((C/D)*s)+B);o.set_Y(((x/y)*r)+z);e.isFunction(o.valuesChanged)&&o.valuesChanged(o);};e.extend(true,o,{settings:k,valuesChanged:e.isFunction(arguments[2])&&arguments[2]||null,get_X:function(){return q;},set_X:function(x){x=Math.floor(x);if(q==x){return;}if(x<B){x=B;}else{if(x>A){x=A;}}q=x;},get_Y:function(){return p;},set_Y:function(x){x=Math.floor(x);if(p==x){return;}if(x<z){x=z;}else{if(x>w){x=w;}}p=x;},set_RangeX:function(y,x){if(B==y&&A==x){return;}if(y>x){return;}B=y;A=x;s=A-B;},set_RangeY:function(y,x){if(z==y&&w==x){return;}if(y>x){return;}z=y;w=x;r=w-z;},draw:function(){var D=0,x=0,F=t.w,C=t.h,E=j.w,y=j.h;if(s>0){if(q==A){D=F;}else{D=Math.floor((q/s)*F);}}if(r>0){if(p==w){x=C;}else{x=Math.floor((p/r)*C);}}if(E>F){D=(F>>1)-(E>>1);}else{D-=E>>1;}if(y>C){x=(C>>1)-(y>>1);}else{x-=y>>1;}j.css({left:D+"px",top:x+"px"});},destroy:function(){e(document).unbind("mouseup",h).unbind("mousemove",l);t.unbind("mousedown",n);t=null;j=null;o.valuesChanged=null;}});var v=o.settings;j.src=v.arrow&&v.arrow.image;j.w=v.arrow&&v.arrow.width||j.width();j.h=v.arrow&&v.arrow.height||j.height();t.w=v.map&&v.map.width||t.width();t.h=v.map&&v.map.height||t.height();t.bind("mousedown",n);o.draw();e.isFunction(o.valuesChanged)&&o.valuesChanged(o);},b=function(m){var l=this,w=function(A){if(A.target.value==""){return;}if(!u.get_R()){s.red.val(0);}if(!u.get_G()){s.green.val(0);}if(!u.get_B()){s.blue.val(0);}if(!u.get_A()){s.alpha.val(100);}q(A);l.setValuesFromHsva();e.isFunction(l.valuesChanged)&&l.valuesChanged(l);},p=function(A){if(A.target.value==""){return;}if(!u.get_H()){s.hue.val(0);}if(!u.get_S()){s.saturation.val(0);}if(!u.get_V()){s.value.val(0);}if(!u.get_A()){s.alpha.val(100);}o(A);l.setValuesFromRgba();e.isFunction(l.valuesChanged)&&l.valuesChanged(l);},r=function(A){if(A.target.value==""){return;}if(!u.get_R()){s.red.val(0);}if(!u.get_G()){s.green.val(0);}if(!u.get_B()){s.blue.val(0);}if(!u.get_H()){s.hue.val(0);}if(!u.get_S()){s.saturation.val(0);}if(!u.get_V()){s.value.val(0);}y(A);l.setValuesFromRgba();e.isFunction(l.valuesChanged)&&l.valuesChanged(l);},t=function(A){if(A.target.value==""){l.setValuesFromRgba();}e.isFunction(l.valuesChanged)&&l.valuesChanged(l);},k=function(A){if(A.target.value==""){l.setValuesFromHsva();}e.isFunction(l.valuesChanged)&&l.valuesChanged(l);},x=function(A){if(A.target.value==""){s.alpha.val(100);}e.isFunction(l.valuesChanged)&&l.valuesChanged(l);},z=function(A){v(A);l.setValuesFromHex();e.isFunction(l.valuesChanged)&&l.valuesChanged(l);},j=function(A){if(A.target.value==""){l.setValuesFromHex();}},o=function(D){if(!n(D)){return D;}var C=h(s.red.val(),0,255),B=h(s.green.val(),0,255),A=h(s.blue.val(),0,255);s.red.val(C!=null?C:"");s.green.val(B!=null?B:"");s.blue.val(A!=null?A:"");},y=function(B){if(!n(B)){return B;}var A=h(s.alpha.val(),0,100);s.alpha.val(A!=null?A:"");},q=function(D){if(!n(D)){return D;}var A=h(s.hue.val(),0,360),B=h(s.saturation.val(),0,100),C=h(s.value.val(),0,100);s.hue.val(A!=null?A:"");s.saturation.val(B!=null?B:"");s.value.val(C!=null?C:"");},v=function(A){if(!n(A)){return A;}s.hex.val(s.hex.val().replace(/[^a-fA-F0-9]/g,"").toLowerCase().substring(0,8));},n=function(A){switch(A.keyCode){case 9:case 16:case 29:case 37:case 38:case 40:return false;case"c".charCodeAt():case"v".charCodeAt():if(A.ctrlKey){return false;}}return true;},h=function(C,B,A){if(C==""||isNaN(C)){return B;}if(C>A){return A;}if(C<B){return B;}return C;};e.extend(true,l,{color:new f(),fields:{hue:m.find(".jPicker_HueText"),saturation:m.find(".jPicker_SaturationText"),value:m.find(".jPicker_BrightnessText"),red:m.find(".jPicker_RedText"),green:m.find(".jPicker_GreenText"),blue:m.find(".jPicker_BlueText"),hex:m.find(".jPicker_HexText"),alpha:m.find(".jPicker_AlphaText")},valuesChanged:e.isFunction(arguments[1])&&arguments[1]||null,bindedHexKeyUp:function(A){z(A);},setValuesFromRgba:function(){u.fromRgba(s.red.val(),s.green.val(),s.blue.val(),s.alpha.val());var B=u.get_Rgba(),A=u.get_H(),C=u.get_S(),D=u.get_V(),E=u.get_A();s.hex.val(B!=null?B:"");s.hue.val(A!=null?A:"");s.saturation.val(C!=null?C:"");s.value.val(D!=null?D:"");s.alpha.val(E!=null?E:"");},setValuesFromHsva:function(){u.fromHsva(s.hue.val(),s.saturation.val(),s.value.val(),s.alpha.val());var B=u.get_Rgba(),E=u.get_R(),C=u.get_G(),A=u.get_B(),D=u.get_A();s.hex.val(B!=null?B:"");s.red.val(E!=null?E:"");s.green.val(C!=null?C:"");s.blue.val(A!=null?A:"");s.alpha.val(D!=null?D:"");},setValuesFromHex:function(){u.fromHex(s.hex.val());var C=u.get_Rgba(),H=u.get_R(),F=u.get_G(),A=u.get_B(),G=u.get_A(),B=u.get_H(),D=u.get_S(),E=u.get_V();s.red.val(H!=null?H:"");s.green.val(F!=null?F:"");s.blue.val(A!=null?A:"");s.alpha.val(G!=null?G:"");s.hue.val(B!=null?B:"");s.saturation.val(D!=null?D:"");s.value.val(E!=null?E:"");},destroy:function(){s.hue.add(s.saturation).add(s.value).unbind("keyup",events.hsvKeyUp).unbind("blur",t);s.red.add(s.green).add(s.blue).unbind("keyup",events.rgbKeyUp).unbind("blur",k);s.alpha.unbind("keyup",alphaKeyUp).unbind("blur",x);s.hex.unbind("keyup",z);s=null;u=null;l.valuesChanged=null;}});var s=l.fields,u=l.color;s.hue.add(s.saturation).add(s.value).bind("keyup",w).bind("blur",t);s.red.add(s.green).add(s.blue).bind("keyup",p).bind("blur",k);s.alpha.bind("keyup",r).bind("blur",x);s.hex.bind("keyup",z).bind("blur",j);if(s.hex.val()!=""){u.fromHex(s.hex.val());l.setValuesFromHex();}};e.jPicker={List:[],Color:function(q){var m=this,j,l,n,o,k,t,p;e.extend(true,m,{get_R:function(){return j;},get_G:function(){return l;},get_B:function(){return n;},get_A:function(){return o;},get_Rgba:function(){return j!=null&&l!=null&&n!=null&&o!=null?g.rgbaToHex({r:j,g:l,b:n,a:o}):null;},get_Hex:function(){var h=m.get_Rgba();return h&&h.substring(0,6)||null;},get_H:function(){return k;},get_S:function(){return t;},get_V:function(){return p;},get_Hsv:function(){return{h:k,s:t,v:p};},fromRgba:function(v,s,h,u){j=v;l=s;n=h;o=u;var r=g.rgbToHsv({r:v,g:s,b:h});k=r.h;t=r.s;p=r.v;},fromHsva:function(h,s,u,v){k=h;t=s;p=u;o=v;var r=g.hsvToRgb({h:h,s:s,v:u});j=r.r;l=r.g;n=r.b;},fromHex:function(s){if(s==null||s==""){j=null;l=null;n=null;o=null;k=null;t=null;p=null;return;}var r=g.hexToRgba(s);j=r.r;l=r.g;n=r.b;o=r.a;var h=g.rgbToHsv({r:r.r,g:r.g,b:r.b});k=h.h;t=h.s;p=h.v;}});if(q){if(q.hex!=null&&q.hex!=""){m.fromHex(q.hex);}else{if(!isNaN(q.r)){m.fromRgba(q.r,q.g,q.b,q.a||100);}else{if(!isNaN(q.h)){m.fromHsva(q.h,q.s,q.v,q.a||100);}}}}},ColorMethods:{hexToRgba:function(m){m=this.validateHex(m);if(m==""){return{r:null,g:null,b:null,a:null};}var l="00",k="00",h="00",j="100";if(m.length==6){m+="ff";}if(m.length>6){l=m.substring(0,2);k=m.substring(2,4);h=m.substring(4,6);j=m.substring(6,m.length);}else{if(m.length>4){l=m.substring(4,m.length);m=m.substring(0,4);}if(m.length>2){k=m.substring(2,m.length);m=m.substring(0,2);}if(m.length>0){h=m.substring(0,m.length);}}return{r:this.hexToInt(l),g:this.hexToInt(k),b:this.hexToInt(h),a:Math.floor((this.hexToInt(j)*100)/255)};},validateHex:function(h){h=h.toLowerCase().replace(/[^a-f0-9]/g,"");if(h.length>8){h=h.substring(0,8);}return h;},rgbaToHex:function(h){return this.intToHex(h.r)+this.intToHex(h.g)+this.intToHex(h.b)+this.intToHex(Math.floor((h.a*255)/100));},intToHex:function(j){var h=Math.floor(j).toString(16);if(h.length==1){h=("0"+h);}return h.toLowerCase();},hexToInt:function(h){return parseInt(h,16);},rgbToHsv:function(l){var o=l.r/255,n=l.g/255,j=l.b/255,k={h:0,s:0,v:0},m=0,h=0,p;if(o>=n&&o>=j){h=o;m=n>j?j:n;}else{if(n>=j&&n>=o){h=n;m=o>j?j:o;}else{h=j;m=n>o?o:n;}}k.v=h;k.s=h?(h-m)/h:0;if(!k.s){k.h=0;}else{p=h-m;if(o==h){k.h=(n-j)/p;}else{if(n==h){k.h=2+(j-o)/p;}else{k.h=4+(o-n)/p;}}k.h=parseInt(k.h*60);if(k.h<0){k.h+=360;}}k.s=Math.floor(k.s*100);k.v=Math.floor(k.v*100);return k;},hsvToRgb:function(n){var r={r:0,g:0,b:0,a:100},m=n.h,x=n.s,u=n.v;if(x==0){if(u==0){r.r=r.g=r.b=0;}else{r.r=r.g=r.b=Math.floor(u*255/100);}}else{if(m==360){m=0;}m/=60;x=x/100;u=u/100;var l=Math.floor(m),o=m-l,k=u*(1-x),j=u*(1-(x*o)),w=u*(1-(x*(1-o)));switch(l){case 0:r.r=u;r.g=w;r.b=k;break;case 1:r.r=j;r.g=u;r.b=k;break;case 2:r.r=k;r.g=u;r.b=w;break;case 3:r.r=k;r.g=j;r.b=u;break;case 4:r.r=w;r.g=k;r.b=u;break;case 5:r.r=u;r.g=k;r.b=j;break;}r.r=Math.floor(r.r*255);r.g=Math.floor(r.g*255);r.b=Math.floor(r.b*255);}return r;}}};var f=e.jPicker.Color,c=e.jPicker.List,g=e.jPicker.ColorMethods;e.fn.jPicker=function(j){var h=arguments;return this.each(function(){var w=e(this),y=e.extend(true,{},e.fn.jPicker.defaults,j);if(w.get(0).nodeName.toLowerCase()=="input"){e.extend(true,y,{window:{bindToInput:true,expandable:true,input:w}});if(g.validateHex(w.val())){y.color.active=new f({hex:w.val(),a:y.color.active.get_A()});y.color.current=new f({hex:w.val(),a:y.color.active.get_A()});}}if(y.window.expandable){w.after('<span class="jPicker_Picker"><span class="jPicker_Color">&nbsp;</span><span class="jPicker_Alpha">&nbsp;</span><span class="jPicker_Icon" title="Click To Open Color Picker">&nbsp;</span><span class="jPicker_Container">&nbsp;</span></span>');}else{y.window.liveUpdate=false;}var U=parseFloat(navigator.appVersion.split("MSIE")[1])<7&&document.body.filters,ay=null,av=null,au=null,T=null,S=null,R=null,Q=null,P=null,O=null,V=null,aa=null,aA=null,ak=null,am=null,ao=null,I=null,aw=null,G=null,Y=null,az=null,M=null,L=null,at=null,aq=null,A=null,l=null,J=null,ap=null,ab=null,ai=null,o=null,m=null,C=null,u=null,an=function(aE){K.active=az.color;var aF=K.active,aG=q.clientPath,aD=aF.get_Hex(),aC=function(aH){ad(aH,100);aH.css({backgroundColor:"transparent",backgroundPosition:"0px 0px",filter:""});};aC(ay);aC(av);aC(au);aC(T);aC(S);aC(R);aC(Q);aC(P);aC(O);aa.add(aA).add(ak).add(am).add(ao).add(I).removeAttr("checked");switch(aE){case"h":aa.attr({checked:true});ay.css({backgroundColor:aD&&aD.length==6?"#"+aD:"transparent"});av.css({backgroundColor:"transparent"});x(av,-256);ad(av,100);x(Q,-256);ad(O,0);break;case"s":aA.attr({checked:true});x(ay,-512);x(av,-768);z(R,aF.get_Hex());x(Q,-512);ad(O,0);break;case"v":ak.attr({checked:true});z(ay,"000000");x(av,-1024);R.css({backgroundColor:aD&&aD.length==6?"#"+aD:"transparent"});x(Q,-768);ad(O,0);break;case"r":am.attr({checked:true});x(av,-1536);x(ay,-1280);x(Q,-1024);x(R,-1280);x(S,-1536);x(T,-1792);ad(O,0);break;case"g":ao.attr({checked:true});x(av,-2048);x(ay,-1792);x(Q,-2048);x(R,-2304);x(S,-2560);x(T,-2816);ad(O,0);break;case"b":I.attr({checked:true});x(av,-2560);x(ay,-2304);x(Q,-3072);x(R,-3328);x(S,-3584);x(T,-3840);ad(O,0);break;case"a":aw.attr({checked:true});x(ay,-512);x(av,-768);ad(av,0);z(R,aF.get_Hex());ad(Q,0);ad(P,0);ad(O,100);break;default:throw("Invalid Mode");break;}switch(aE){case"h":G.set_RangeX(0,100);G.set_RangeY(0,100);Y.set_RangeY(0,360);break;case"s":case"v":case"a":G.set_RangeX(0,360);G.set_RangeY(0,100);Y.set_RangeY(0,100);break;case"r":case"g":case"b":G.set_RangeX(0,255);G.set_RangeY(0,255);Y.set_RangeY(0,255);break;}K.mode=aE;v();G.draw();Y.draw();ah();if(aj.expandable&&aj.liveUpdate){o.css({backgroundColor:aD&&aD.length==6?"#"+aD:"transparent"});ad(m,100-aF.get_A());if(aj.bindToInput){aj.input.val(aF.get_Rgba()||"").css({backgroundColor:aD&&aD.length==6?"#"+aD:"transparent",color:aF.get_V()>75?"#000000":"#ffffff"});}}e.isFunction(w.liveCallback)&&w.liveCallback(aF);},n=function(){v();G.draw();Y.draw();ah();K.active=az.color;var aD=K.active;if(aj.expandable&&aj.liveUpdate){var aC=aD.get_Hex();o.css({backgroundColor:aC&&aC.length==6?"#"+aC:"transparent"});ad(m,100-aD.get_A());if(aj.bindToInput){aj.input.val(az.fields.hex.val()||"").css({backgroundColor:aC&&aC.length==6?"#"+aC:"transparent",color:aD.get_V()>75?"#000000":"#ffffff"});}}e.isFunction(w.liveCallback)&&w.liveCallback(aD);},B=function(){if(!az||!G||!Y){return;}K.active=az.color;var aC=az.fields,aE=K.active;switch(K.mode){case"h":aC.saturation.val(G.get_X());aC.value.val(100-G.get_Y());if(aE.get_H()==null){aC.hue.val(0);}break;case"s":case"a":aC.hue.val(G.get_X());aC.value.val(100-G.get_Y());if(aE.get_S()==null){aC.saturation.val(0);}break;case"v":aC.hue.val(G.get_X());aC.saturation.val(100-G.get_Y());if(aE.get_V()==null){aC.value.val(0);}break;case"r":aC.green.val(255-G.get_Y());aC.blue.val(G.get_X());if(aE.get_R()==null){aC.red.val(0);}break;case"g":aC.red.val(255-G.get_Y());aC.blue.val(G.get_X());if(aE.get_G()==null){aC.green.val(0);}break;case"b":aC.red.val(G.get_X());aC.green.val(255-G.get_Y());if(aE.get_B()==null){aC.blue.val(0);}break;}if(aE.get_A()==null){aC.alpha.val(100);az.setValuesFromHsva();v();Y.draw();}switch(K.mode){case"h":case"s":case"v":case"a":az.setValuesFromHsva();break;case"r":case"g":case"b":az.setValuesFromRgba();break;}ah();if(aj.expandable&&aj.liveUpdate){var aD=aE.get_Hex();o.css({backgroundColor:aD&&aD.length==6?"#"+aD:"transparent"});ad(m,100-aE.get_A());if(aj.bindToInput){aj.input.val(aE.get_Rgba()||"").css({backgroundColor:aD&&aD.length==6?"#"+aD:"transparent",color:aE.get_V()>75?"#000000":"#ffffff"});}}e.isFunction(w.liveCallback)&&w.liveCallback(aE);},al=function(){if(!az||!G||!Y){return;}K.active=az.color;var aC=az.fields,aE=K.active;switch(K.mode){case"h":aC.hue.val(360-Y.get_Y());if(aE.get_S()==null){aC.saturation.val(0);}if(aE.get_V()==null){aC.value.val(0);}break;case"s":aC.saturation.val(100-Y.get_Y());if(aE.get_H()==null){aC.hue.val(0);}if(aE.get_V()==null){aC.value.val(0);}break;case"v":aC.value.val(100-Y.get_Y());if(aE.get_H()==null){aC.hue.val(0);}if(aE.get_S()==null){aC.saturation.val(0);}break;case"r":aC.red.val(255-Y.get_Y());if(aE.get_G()==null){aC.green.val(0);}if(aE.get_B()==null){aC.blue.val(0);}break;case"g":aC.green.val(255-Y.get_Y());if(aE.get_R()==null){aC.red.val(0);}if(aE.get_B()==null){aC.blue.val(0);}break;case"b":aC.blue.val(255-Y.get_Y());if(aE.get_R()==null){aC.red.val(0);}if(aE.get_G()==null){aC.green.val(0);}break;case"a":aC.alpha.val(100-Y.get_Y());if(aE.get_R()==null){aC.red.val(0);}if(aE.get_G()==null){aC.green.val(0);}if(aE.get_B()==null){aC.blue.val(0);}break;}if(aE.get_A()==null){aC.alpha.val(100);}switch(K.mode){case"h":case"s":case"v":az.setValuesFromHsva();break;case"r":case"g":case"b":case"a":az.setValuesFromRgba();break;}ah();if(aj.expandable&&aj.liveUpdate){var aD=aE.get_Hex();o.css({backgroundColor:aD&&aD.length==6?"#"+aD:"transparent"});ad(m,100-aE.get_A());if(aj.bindToInput){aj.input.val(aE.get_Rgba()||"").css({backgroundColor:aD&&aD.length==6?"#"+aD:"transparent",color:aE.get_V()>75?"#000000":"#ffffff"});}}e.isFunction(w.liveCallback)&&w.liveCallback(aE);},v=function(){K.active=az.color;var aF=0,aE=K.active;switch(w.settings.color.mode){case"h":aF=360-aE.get_H();break;case"s":aF=100-aE.get_S();break;case"v":aF=100-aE.get_V();break;case"r":aF=255-aE.get_R();break;case"g":aF=255-aE.get_G();break;case"b":aF=255-aE.get_B();break;case"a":aF=100-aE.get_A();break;}Y.set_Y(aF);var aD=0,aC=0;switch(w.settings.color.mode){case"h":aD=aE.get_S();aC=100-aE.get_V();break;case"s":case"a":aD=aE.get_H();aC=100-aE.get_V();break;case"v":aD=aE.get_H();aC=100-aE.get_S();break;case"r":aD=aE.get_B();aC=255-aE.get_G();break;case"g":aD=aE.get_B();aC=255-aE.get_R();break;case"b":aD=aE.get_R();aC=255-aE.get_G();break;}G.set_X(aD);G.set_Y(aC);},ah=function(){aB();ar();Z();},aB=function(){try{var aC=az.color.get_Hex();A.css({backgroundColor:aC&&aC.length==6?"#"+aC:"transparent"});ad(A,az.color.get_A());}catch(aD){}},ar=function(){if(!K||!az){return;}K.active=az.color;var aC=K.active;switch(K.mode){case"h":z(ay,new f({h:aC.get_H(),s:100,v:100}).get_Hex());break;case"s":case"a":ad(av,100-aC.get_S());break;case"v":ad(av,aC.get_V());break;case"r":ad(av,aC.get_R()/255*100);break;case"g":ad(av,aC.get_G()/255*100);break;case"b":ad(av,aC.get_B()/255*100);break;}ad(au,100-aC.get_A());},Z=function(){if(!K||!az){return;}K.active=az.color;var aG=K.active;switch(K.mode){case"h":ad(P,100-aG.get_A());break;case"s":var aH=new f({h:aG.get_H(),s:100,v:aG.get_V()});z(R,aH.get_Hex());ad(P,100-aG.get_A());break;case"v":var aJ=new f({h:aG.get_H(),s:aG.get_S(),v:100});z(R,aJ.get_Hex());ad(P,100-aG.get_A());break;case"r":case"g":case"b":var aI=0,aK=0;if(K.mode=="r"){aI=aG.get_B();aK=aG.get_G();}else{if(K.mode=="g"){aI=aG.get_B();aK=aG.get_R();}else{if(K.mode=="b"){aI=aG.get_R();aK=aG.get_G();}}}var aC=aI/255*100,aF=aK/255*100,aE=(255-aI)/255*100,aD=(255-aK)/255*100;ad(T,aD>aE?aE:aD);ad(S,aD>aC?aC:aD);ad(R,aF>aC?aC:aF);ad(Q,aF>aE?aE:aF);ad(P,100-aG.get_A());break;case"a":z(R,aG.get_Hex());break;}},z=function(aC,aD){aC.css({backgroundColor:aD&&aD.length==6?"#"+aD:"transparent"});},t=function(aC,aD){aC.css({backgroundImage:"url("+aD+")"});},x=function(aC,aD){aC.css({backgroundPosition:"0px "+aD+"px"});},ad=function(aD,aC){aD.css({visibility:aC>0?"visible":"hidden"});if(aC>0&&aC<100){aD.css({opacity:aC/100});}else{if(aC==0||aC==100){aD.css({opacity:""});}}},E=function(){az.fields.hex.val(K.current.get_Rgba()||"");az.setValuesFromHex();e.isFunction(az.valuesChanged)&&az.valuesChanged(az);},D=function(aC){an(aC.target.value);},ae=function(){E();},s=function(){E();aj.expandable&&w.hide();e.isFunction(w.cancelCallback)&&w.cancelCallback(K.active);},X=function(){var aD=K.active;K.current=new f({hex:aD.get_Rgba()});var aC=aD.get_Hex();l.css({backgroundColor:aC&&aC.length==6?"#"+aC:"transparent"});ad(l,az.color.get_A());if(aj.expandable){o.css({backgroundColor:aC&&aC.length==6?"#"+aC:"transparent"});ad(m,100-aD.get_A());if(aj.bindToInput){aj.input.val(aD.get_Rgba()||"").css({backgroundColor:aC&&aC.length==6?"#"+aC:"transparent",color:aD.get_V()>75?"#000000":"#ffffff"});}}e.isFunction(w.commitCallback)&&w.commitCallback(aD);},p=function(){X();aj.expandable&&w.hide();},ag=function(){w.show();},W=function(aE){var aC=aj.element,aD=aj.page;M=parseInt(V.css("left"));L=parseInt(V.css("top"));at=aE.pageX;aq=aE.pageY;e(document).bind("mousemove",k).bind("mouseup",r);aE.stopPropagation();aE.preventDefault();return false;},k=function(aC){V.css({left:M-(at-aC.pageX)+"px",top:L-(aq-aC.pageY)+"px"});aC.stopPropagation();aC.preventDefault();return false;},r=function(aC){e(document).unbind("mousemove",k).unbind("mouseup",r);aC.stopPropagation();aC.preventDefault();return false;},F=function(aC){az.fields.hex.val(w.settings.window.input.val());az.bindedHexKeyUp(aC);},H=function(aC){az.fields.hex.val(new f({hex:e(this).attr("title")}).get_Rgba()||"");az.setValuesFromHex();e.isFunction(az.valuesChanged)&&az.valuesChanged(az);};e.extend(true,w,{id:w.attr("id"),settings:y,color:null,icon:null,commitCallback:e.isFunction(h[1])&&h[1]||null,liveCallback:e.isFunction(h[2])&&h[2]||null,cancelCallback:e.isFunction(h[3])&&h[3]||null,show:function(){if(document.all){var aD=false;for(i=0;i<c.length;i++){if(aD){c[i].color.add(c[i].icon).css({display:"none"});}if(c[i].id==w.id){aD=true;}}}K.current=new f({hex:K.active.get_Rgba()});var aC=K.active.get_Hex();l.css({backgroundColor:aC&&aC.length==6?"#"+aC:"transparent"});ad(l,K.active.get_A());V.css({display:"block"});v();},hide:function(){if(document.all){var aC=false;for(i=0;i<c.length;i++){if(aC){c[i].color.add(c[i].icon).css({display:"block"});}if(c[i].id==w.id){aC=true;}}}V.css({display:"none"});},destroy:function(){if(aj.expandable){C=V.find(".jPicker_Icon").unbind("click",ag);}if(aj.bindToInput){aj.input.unbind("keyup",F).unbind("change",F);}aa.add(aA).add(ak).add(am).add(ao).add(I).unbind("click",D);l.unbind("click",ae);ab.unbind("click",s);ap.unbind("click",p);if(aj.expandable){u.unbind("mousedown",W);}V.find(".jPicker_QuickColor").unbind("click",H);aa=null;aA=null;ak=null;am=null;ao=null;I=null;aw=null;ay=null;av=null;au=null;T=null;S=null;R=null;Q=null;P=null;O=null;J=null;A=null;l=null;ap=null;ab=null;ai=null;w.color=null;w.icon=null;G.destroy();G=null;Y.destroy();Y=null;az.destroy();az=null;w.commitCallback=null;w.cancelCallback=null;w.liveCallback=null;V.html("");for(i=0;i<c.length;i++){if(c[i].id==w.id){c.splice(i,1);}}}});var q=w.settings.images,aj=w.settings.window,af=w.settings.localization,K=w.settings.color;V=aj.expandable?w.next().find(".jPicker_Container"):w;if(aj.expandable){V.css({left:aj.position.x=="left"?"-526px":aj.position.x=="center"?"-259px":aj.position.x=="right"?"0px":aj.position.x=="screenCenter"?((e(document).width()>>1)-259)-w.next().offset().left+"px":aj.position.x,position:"absolute",top:aj.position.y=="top"?"-350px":aj.position.y=="center"?"-158px":aj.position.y=="bottom"?"25px":aj.position.y});}if((typeof(K.active)).toString().toLowerCase()=="string"){K.active=new f({hex:K.active});}V.html('<table class="jPicker_table"><tbody>'+(aj.expandable?'<tr><td class="jPicker_MoveBar" colspan="6">&nbsp;</td></tr>':"")+'<tr><td rowspan="9"><h2 class="jPicker_Title">'+(aj.title||af.text.title)+'</h2><div class="jPicker_ColorMap"><span class="jPicker_ColorMap_l1">&nbsp;</span><span class="jPicker_ColorMap_l2">&nbsp;</span><span class="jPicker_ColorMap_l3">&nbsp;</span><img src="'+q.clientPath+q.colorMap.arrow.file+'" class="jPicker_ColorMap_Arrow"/></div></td><td rowspan="9"><div class="jPicker_ColorBar"><span class="jPicker_ColorBar_l1">&nbsp;</span><span class="jPicker_ColorBar_l2">&nbsp;</span><span class="jPicker_ColorBar_l3">&nbsp;</span><span class="jPicker_ColorBar_l4">&nbsp;</span><span class="jPicker_ColorBar_l5">&nbsp;</span><span class="jPicker_ColorBar_l6">&nbsp;</span><img src="'+q.clientPath+q.colorBar.arrow.file+'" class="jPicker_ColorBar_Arrow"/></div></td><td colspan="3" class="jPicker_Preview">'+af.text.newColor+'<div class="jPicker_NewCurrent"><span class="jPicker_Active" title="'+af.tooltips.colors.newColor+'">&nbsp;</span><span class="jPicker_Current" title="'+af.tooltips.colors.currentColor+'">&nbsp;</span></div>'+af.text.currentColor+'</td><td rowspan="9" class="jPicker_OkCancel"><input type="button" class="jPicker_Ok" value="'+af.text.ok+'" title="'+af.tooltips.buttons.ok+'"/><input type="button" class="jPicker_Cancel" value="'+af.text.cancel+'" title="'+af.tooltips.buttons.cancel+'"/><hr/><div class="jPicker_Grid">&nbsp;</div></td></tr><tr><td><input type="radio" class="jPicker_HueRadio" id="jPicker_Hue_'+c.length+'" name="jPicker_Mode_'+c.length+'" value="h" title="'+af.tooltips.hue.radio+'"/></td><td><label for="jPicker_Hue_'+c.length+'" title="'+af.tooltips.hue.radio+'">H:</label></td><td class="jPicker_Text"><input type="text" class="jPicker_HueText" value="'+K.active.get_H()+'" title="'+af.tooltips.hue.textbox+'"/> &deg;</td></tr><tr><td><input type="radio" class="jPicker_SaturationRadio" id="jPicker_Saturation_'+c.length+'" name="jPicker_Mode_'+c.length+'" value="s" title="'+af.tooltips.saturation.radio+'"/></td><td><label for="jPicker_Saturation_'+c.length+'" title="'+af.tooltips.saturation.radio+'">S:</label></td><td class="jPicker_Text"><input type="text" class="jPicker_SaturationText" value="'+K.active.get_S()+'" title="'+af.tooltips.saturation.textbox+'"/> %</td></tr><tr><td><input type="radio" class="jPicker_BrightnessRadio" id="jPicker_Brightness_'+c.length+'" name="jPicker_Mode_'+c.length+'" value="v" title="'+af.tooltips.brightness.radio+'"/><br/><br/></td><td><label for="jPicker_Brightness_'+c.length+'" title="'+af.tooltips.brightness.radio+'">B:</label></td><td class="jPicker_Text"><input type="text" class="jPicker_BrightnessText" value="'+K.active.get_V()+'" title="'+af.tooltips.brightness.textbox+'"/> %</td></tr><tr><td><input type="radio" class="jPicker_RedRadio" id="jPicker_Red_'+c.length+'" name="jPicker_Mode_'+c.length+'" value="r" title="'+af.tooltips.red.radio+'"/></td><td><label for="jPicker_Red_'+c.length+'" title="'+af.tooltips.red.radio+'">R:</label></td><td class="jPicker_Text"><input type="text" class="jPicker_RedText" value="'+K.active.get_R()+'" title="'+af.tooltips.red.textbox+'"/></td></tr><tr><td><input type="radio" class="jPicker_GreenRadio" id="jPicker_Green_'+c.length+'" name="jPicker_Mode_'+c.length+'" value="g" title="'+af.tooltips.green.radio+'"/></td><td><label for="jPicker_Green_'+c.length+'" title="'+af.tooltips.green.radio+'">G:</label></td><td class="jPicker_Text"><input type="text" class="jPicker_GreenText" value="'+K.active.get_G()+'" title="'+af.tooltips.green.textbox+'"/></td></tr><tr><td><input type="radio" class="jPicker_BlueRadio" id="jPicker_Blue_'+c.length+'" name="jPicker_Mode_'+c.length+'" value="b" title="'+af.tooltips.blue.radio+'"/></td><td><label for="jPicker_Blue_'+c.length+'" title="'+af.tooltips.blue.radio+'">B:</label></td><td class="jPicker_Text"><input type="text" class="jPicker_BlueText" value="'+K.active.get_B()+'" title="'+af.tooltips.blue.textbox+'"/></td></tr><tr><td><input type="radio" class="jPicker_AlphaRadio" id="jPicker_Alpha_'+c.length+'" name="jPicker_Mode_'+c.length+'" value="a" title="'+af.tooltips.alpha.radio+'"/></td><td><label for="jPicker_Alpha_'+c.length+'" title="'+af.tooltips.alpha.radio+'">A:</label></td><td class="jPicker_Text"><input type="text" class="jPicker_AlphaText" value="'+K.active.get_A()+'" title="'+af.tooltips.alpha.textbox+'"/> %</td></tr><tr><td class="jPicker_HexCol"><label for="jPicker_Hex_'+c.length+'" title="'+af.tooltips.hex.textbox+'">#:</label></td><td class="jPicker_EnterHex" colspan="2"><input type="text" class="jPicker_HexText" id="jPicker_Hex_'+c.length+'" value="'+K.active.get_Rgba()+'" title="'+af.tooltips.hex.textbox+'"/></td></tr></tbody></table>');aa=V.find(".jPicker_HueRadio");aA=V.find(".jPicker_SaturationRadio");ak=V.find(".jPicker_BrightnessRadio");am=V.find(".jPicker_RedRadio");ao=V.find(".jPicker_GreenRadio");I=V.find(".jPicker_BlueRadio");aw=V.find(".jPicker_AlphaRadio");ay=V.find(".jPicker_ColorMap_l1");av=V.find(".jPicker_ColorMap_l2");au=V.find(".jPicker_ColorMap_l3");T=V.find(".jPicker_ColorBar_l1");S=V.find(".jPicker_ColorBar_l2");R=V.find(".jPicker_ColorBar_l3");Q=V.find(".jPicker_ColorBar_l4");P=V.find(".jPicker_ColorBar_l5");O=V.find(".jPicker_ColorBar_l6");J=V.find(".jPicker_NewCurrent");var ac=K.active.get_Hex();A=V.find(".jPicker_Active").css({backgroundColor:ac&&ac.length==6?"#"+ac:"transparent"});l=V.find(".jPicker_Current").css({backgroundColor:ac&&ac.length==6?"#"+ac:"transparent"});ap=V.find(".jPicker_Ok");ab=V.find(".jPicker_Cancel");ai=V.find(".jPicker_Grid");w.color=e(".Picker_Color");w.icon=e(".jPicker_Icon");az=new b(V,n);G=new d(V.find(".jPicker_ColorMap"),{map:{width:q.colorMap.width,height:q.colorMap.height},arrow:{image:q.clientPath+q.colorMap.arrow.file,width:q.colorMap.arrow.width,height:q.colorMap.arrow.height}},B);Y=new d(V.find(".jPicker_ColorBar"),{map:{width:q.colorBar.width,height:q.colorBar.height},arrow:{image:q.clientPath+q.colorBar.arrow.file,width:q.colorBar.arrow.width,height:q.colorBar.arrow.height}},al);t(ay,q.clientPath+"Maps.png");t(av,q.clientPath+"Maps.png");t(au,q.clientPath+"map-opacity.png");t(T,q.clientPath+"Bars.png");t(S,q.clientPath+"Bars.png");t(R,q.clientPath+"Bars.png");t(Q,q.clientPath+"Bars.png");t(P,q.clientPath+"bar-opacity.png");t(O,q.clientPath+"AlphaBar.png");t(J,q.clientPath+"preview-opacity.png");if(aj.expandable){o=w.next().find(".jPicker_Color").css({backgroundColor:ac&&ac.length==6?"#"+ac:"transparent"});m=w.next().find(".jPicker_Alpha");t(m,q.clientPath+"bar-opacity.png");ad(m,100-K.active.get_A());C=w.next().find(".jPicker_Icon").css({backgroundImage:"url("+q.clientPath+q.picker.file+")"}).bind("click",ag);if(aj.bindToInput){aj.input.bind("keyup",F).bind("change",F);}}aa.add(aA).add(ak).add(am).add(ao).add(I).add(aw).bind("click",D);l.bind("click",ae);ab.bind("click",s);ap.bind("click",p);if(aj.expandable){u=V.find(".jPicker_MoveBar").bind("mousedown",W);}if(K.quickList&&K.quickList.length>0){ai.html("");for(i=0;i<K.quickList.length;i++){if((typeof(K.quickList[i])).toString().toLowerCase()=="string"){K.quickList[i]=new f({hex:K.quickList[i]});}var ax=K.quickList[i].get_Rgba();ai.append('<span class="jPicker_QuickColor" title="'+(ax&&"#"+ax||"")+'">&nbsp;</span>');var N=K.quickList[i].get_Hex();V.find(".jPicker_QuickColor").eq(i).css({backgroundColor:N&&N.length==6?"#"+N:"transparent",backgroundImage:N?"none":"url("+q.clientPath+"NoColor.png)"}).click(H);}}an(K.mode);az.fields.hex.val(K.active.get_Rgba()||"");az.setValuesFromHex();v();ah();if(!aj.expandable){w.show();}c.push(w);});};e.fn.jPicker.defaults={window:{title:null,position:{x:"screenCenter",y:"top"},expandable:false,liveUpdate:true},color:{mode:"h",active:new f({hex:"#ffcc00ff"}),quickList:[new f({h:360,s:33,v:100}),new f({h:360,s:66,v:100}),new f({h:360,s:100,v:100}),new f({h:360,s:100,v:75}),new f({h:360,s:100,v:50}),new f({h:180,s:0,v:100}),new f({h:30,s:33,v:100}),new f({h:30,s:66,v:100}),new f({h:30,s:100,v:100}),new f({h:30,s:100,v:75}),new f({h:30,s:100,v:50}),new f({h:180,s:0,v:90}),new f({h:60,s:33,v:100}),new f({h:60,s:66,v:100}),new f({h:60,s:100,v:100}),new f({h:60,s:100,v:75}),new f({h:60,s:100,v:50}),new f({h:180,s:0,v:80}),new f({h:90,s:33,v:100}),new f({h:90,s:66,v:100}),new f({h:90,s:100,v:100}),new f({h:90,s:100,v:75}),new f({h:90,s:100,v:50}),new f({h:180,s:0,v:70}),new f({h:120,s:33,v:100}),new f({h:120,s:66,v:100}),new f({h:120,s:100,v:100}),new f({h:120,s:100,v:75}),new f({h:120,s:100,v:50}),new f({h:180,s:0,v:60}),new f({h:150,s:33,v:100}),new f({h:150,s:66,v:100}),new f({h:150,s:100,v:100}),new f({h:150,s:100,v:75}),new f({h:150,s:100,v:50}),new f({h:180,s:0,v:50}),new f({h:180,s:33,v:100}),new f({h:180,s:66,v:100}),new f({h:180,s:100,v:100}),new f({h:180,s:100,v:75}),new f({h:180,s:100,v:50}),new f({h:180,s:0,v:40}),new f({h:210,s:33,v:100}),new f({h:210,s:66,v:100}),new f({h:210,s:100,v:100}),new f({h:210,s:100,v:75}),new f({h:210,s:100,v:50}),new f({h:180,s:0,v:30}),new f({h:240,s:33,v:100}),new f({h:240,s:66,v:100}),new f({h:240,s:100,v:100}),new f({h:240,s:100,v:75}),new f({h:240,s:100,v:50}),new f({h:180,s:0,v:20}),new f({h:270,s:33,v:100}),new f({h:270,s:66,v:100}),new f({h:270,s:100,v:100}),new f({h:270,s:100,v:75}),new f({h:270,s:100,v:50}),new f({h:180,s:0,v:10}),new f({h:300,s:33,v:100}),new f({h:300,s:66,v:100}),new f({h:300,s:100,v:100}),new f({h:300,s:100,v:75}),new f({h:300,s:100,v:50}),new f({h:180,s:0,v:0}),new f({h:330,s:33,v:100}),new f({h:330,s:66,v:100}),new f({h:330,s:100,v:100}),new f({h:330,s:100,v:75}),new f({h:330,s:100,v:50}),new f()]},images:{clientPath:"/jPicker/images/",colorMap:{width:256,height:256,arrow:{file:"mappoint.gif",width:15,height:15}},colorBar:{width:20,height:256,arrow:{file:"rangearrows.gif",width:40,height:9}},picker:{file:"picker.gif",width:25,height:24}},localization:{text:{title:"Drag Markers To Pick A Color",newColor:"new",currentColor:"current",ok:"OK",cancel:"Cancel"},tooltips:{colors:{newColor:"New Color - Press &ldquo;OK&rdquo; To Commit",currentColor:"Click To Revert To Original Color"},buttons:{ok:"Commit To This Color Selection",cancel:"Cancel And Revert To Original Color"},hue:{radio:"Set To &ldquo;Hue&rdquo; Color Mode",textbox:"Enter A &ldquo;Hue&rdquo; Value (0-360&deg;)"},saturation:{radio:"Set To &ldquo;Saturation&rdquo; Color Mode",textbox:"Enter A &ldquo;Saturation&rdquo; Value (0-100%)"},brightness:{radio:"Set To &ldquo;Brightness&rdquo; Color Mode",textbox:"Enter A &ldquo;Brightness&rdquo; Value (0-100%)"},red:{radio:"Set To &ldquo;Red&rdquo; Color Mode",textbox:"Enter A &ldquo;Red&rdquo; Value (0-255)"},green:{radio:"Set To &ldquo;Green&rdquo; Color Mode",textbox:"Enter A &ldquo;Green&rdquo; Value (0-255)"},blue:{radio:"Set To &ldquo;Blue&rdquo; Color Mode",textbox:"Enter A &ldquo;Blue&rdquo; Value (0-255)"},alpha:{radio:"Set To &ldquo;Alpha&rdquo; Color Mode",textbox:"Enter A &ldquo;Alpha&rdquo; Value (0-100)"},hex:{textbox:"Enter A &ldquo;Hex&rdquo; Color Value (#000000-#ffffff)"}}}};})(jQuery,"1.0.12");if(typeof eventManager!='undefined'){eventManager.fire('scriptLoaded','vle/node/draw/svg-edit/jgraduate/jpicker-1.0.12.min.js');};;(function($){$.fn.colorPicker=function(){if(this.length>0)buildSelector();return this.each(function(i){buildPicker(this)});};var selectorOwner;var selectorShowing=false;buildPicker=function(element){control=$("<div class='color_picker'>&nbsp;</div>")
control.css('background-color',$(element).val());control.bind("click",toggleSelector);$(element).after(control);$(element).bind("change",function(){selectedValue=toHex($(element).val());$(element).next(".color_picker").css("background-color",selectedValue);});$(element).hide();};buildSelector=function(){selector=$("<div id='color_selector'></div>");$.each($.fn.colorPicker.defaultColors,function(i){swatch=$("<div class='color_swatch'>&nbsp;</div>")
swatch.css("background-color","#"+this);swatch.bind("click",function(e){changeColor($(this).css("background-color"))});swatch.bind("mouseover",function(e){$(this).css("border-color","#598FEF");$("input#color_value").val(toHex($(this).css("background-color")));});swatch.bind("mouseout",function(e){$(this).css("border-color","#000");$("input#color_value").val(toHex($(selectorOwner).css("background-color")));});swatch.appendTo(selector);});hex_field=$("<label for='color_value'>Hex</label><input type='text' size='8' id='color_value'/>");hex_field.bind("keydown",function(event){if(event.keyCode==13){changeColor($(this).val());}
if(event.keyCode==27){toggleSelector()}});$("<div id='color_custom'></div>").append(hex_field).appendTo(selector);$("body").append(selector);selector.hide();};checkMouse=function(event){var selector="div#color_selector";var selectorParent=$(event.target).parents(selector).length;if(event.target==$(selector)[0]||event.target==selectorOwner||selectorParent>0)return
hideSelector();}
hideSelector=function(){var selector=$("div#color_selector");$(document).unbind("mousedown",checkMouse);selector.hide();selectorShowing=false}
showSelector=function(){var selector=$("div#color_selector");selector.css({top:$(selectorOwner).offset().top-($(selector).outerHeight())+($(selectorOwner).outerHeight()),left:$(selectorOwner).offset().left+($(selectorOwner).outerWidth())});hexColor=$(selectorOwner).prev("input").val();$("input#color_value").val(hexColor);selector.show();$(document).bind("mousedown",checkMouse);selectorShowing=true}
toggleSelector=function(event){selectorOwner=this;selectorShowing?hideSelector():showSelector();}
changeColor=function(value){if(selectedValue=toHex(value)){$(selectorOwner).css("background-color",selectedValue);$(selectorOwner).prev("input").val(selectedValue).change();hideSelector();}};toHex=function(color){if(color.match(/[0-9a-fA-F]{3}$/)||color.match(/[0-9a-fA-F]{6}$/)){color=(color.charAt(0)=="#")?color:("#"+color);}
else if(color.match(/^rgb\(([0-9]|[1-9][0-9]|[1][0-9]{2}|[2][0-4][0-9]|[2][5][0-5]),[ ]{0,1}([0-9]|[1-9][0-9]|[1][0-9]{2}|[2][0-4][0-9]|[2][5][0-5]),[ ]{0,1}([0-9]|[1-9][0-9]|[1][0-9]{2}|[2][0-4][0-9]|[2][5][0-5])\)$/)){var c=([parseInt(RegExp.$1),parseInt(RegExp.$2),parseInt(RegExp.$3)]);var pad=function(str){if(str.length<2){for(var i=0,len=2-str.length;i<len;i++){str='0'+str;}}
return str;}
if(c.length==3){var r=pad(c[0].toString(16)),g=pad(c[1].toString(16)),b=pad(c[2].toString(16));color='#'+r+g+b;}}
else color=false;return color}
$.fn.colorPicker.addColors=function(colorArray){$.fn.colorPicker.defaultColors=$.fn.colorPicker.defaultColors.concat(colorArray);};$.fn.colorPicker.defaultColors=['000000','993300','333300','000080','333399','333333','800000','FF6600','808000','008000','008080','0000FF','666699','808080','FF0000','FF9900','99CC00','339966','33CCCC','3366FF','800080','999999','FF00FF','FFCC00','FFFF00','00FF00','00FFFF','00CCFF','993366','C0C0C0','FF99CC','FFCC99','FFFF99','CCFFFF','99CCFF','FFFFFF'];})(jQuery);if(typeof eventManager!='undefined'){eventManager.fire('scriptLoaded','vle/node/draw/svg-edit/extensions/jquery-rscp/jquery.colorPicker.js');};;var LZ77=function(settings){settings=settings||{};var referencePrefix="`";var referenceIntBase=settings.referenceIntBase||96;var referenceIntFloorCode=" ".charCodeAt(0);var referenceIntCeilCode=referenceIntFloorCode+referenceIntBase-1;var maxStringDistance=Math.pow(referenceIntBase,2)-1;var minStringLength=settings.minStringLength||5;var maxStringLength=Math.pow(referenceIntBase,1)-1+minStringLength;var defaultWindowLength=settings.defaultWindowLength||144;var maxWindowLength=maxStringDistance+minStringLength;var encodeReferenceInt=function(value,width){if((value>=0)&&(value<(Math.pow(referenceIntBase,width)-1))){var encoded="";while(value>0){encoded=(String.fromCharCode((value%referenceIntBase)+referenceIntFloorCode))+encoded;value=Math.floor(value/referenceIntBase);}
var missingLength=width-encoded.length;for(var i=0;i<missingLength;i++){encoded=String.fromCharCode(referenceIntFloorCode)+encoded;}
return encoded;}else{throw"Reference int out of range: "+value+" (width = "+width+")";}};var encodeReferenceLength=function(length){return encodeReferenceInt(length-minStringLength,1);};var decodeReferenceInt=function(data,width){var value=0;for(var i=0;i<width;i++){value*=referenceIntBase;var charCode=data.charCodeAt(i);if((charCode>=referenceIntFloorCode)&&(charCode<=referenceIntCeilCode)){value+=charCode-referenceIntFloorCode;}else{throw"Invalid char code in reference int: "+charCode;}}
return value;};var decodeReferenceLength=function(data){return decodeReferenceInt(data,1)+minStringLength;};this.compress=function(data,windowLength){windowLength=windowLength||defaultWindowLength;if(windowLength>maxWindowLength){throw"Window length too large";}
var compressed="";var pos=0;var lastPos=data.length-minStringLength;while(pos<lastPos){var searchStart=Math.max(pos-windowLength,0);var matchLength=minStringLength;var foundMatch=false;var bestMatch={distance:maxStringDistance,length:0};var newCompressed=null;while((searchStart+matchLength)<pos){var isValidMatch=((data.substr(searchStart,matchLength)==data.substr(pos,matchLength))&&(matchLength<maxStringLength));if(isValidMatch){matchLength++;foundMatch=true;}else{var realMatchLength=matchLength-1;if(foundMatch&&(realMatchLength>bestMatch.length)){bestMatch.distance=pos-searchStart-realMatchLength;bestMatch.length=realMatchLength;}
matchLength=minStringLength;searchStart++;foundMatch=false;}}
if(bestMatch.length){newCompressed=referencePrefix+encodeReferenceInt(bestMatch.distance,2)+encodeReferenceLength(bestMatch.length);pos+=bestMatch.length;}else{if(data.charAt(pos)!=referencePrefix){newCompressed=data.charAt(pos);}else{newCompressed=referencePrefix+referencePrefix;}
pos++;}
compressed+=newCompressed;}
return compressed+data.slice(pos).replace(/`/g,"``");};this.decompress=function(data){var decompressed="";var pos=0;while(pos<data.length){var currentChar=data.charAt(pos);if(currentChar!=referencePrefix){decompressed+=currentChar;pos++;}else{var nextChar=data.charAt(pos+1);if(nextChar!=referencePrefix){var distance=decodeReferenceInt(data.substr(pos+1,2),2);var length=decodeReferenceLength(data.charAt(pos+3));decompressed+=decompressed.substr(decompressed.length-distance-length,length);pos+=minStringLength-1;}else{decompressed+=referencePrefix;pos+=2;}}}
return decompressed;};};if(typeof eventManager!='undefined'){eventManager.fire('scriptLoaded','vle/node/draw/svg-edit/lz77.js');};;var Utils={"_keyStr":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=","encode64":function(input){input=Utils.convertToXMLReferences(input);if(window.btoa)return window.btoa(input);var output=new Array(Math.floor((input.length+2)/3)*4);var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0,p=0;do{chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=((chr1&3)<<4)|(chr2>>4);enc3=((chr2&15)<<2)|(chr3>>6);enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64;}else if(isNaN(chr3)){enc4=64;}
output[p++]=this._keyStr.charAt(enc1);output[p++]=this._keyStr.charAt(enc2);output[p++]=this._keyStr.charAt(enc3);output[p++]=this._keyStr.charAt(enc4);}while(i<input.length);return output.join('');},"decode64":function(input){if(window.atob)return window.atob(input);var output="";var chr1,chr2,chr3="";var enc1,enc2,enc3,enc4="";var i=0;input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{enc1=this._keyStr.indexOf(input.charAt(i++));enc2=this._keyStr.indexOf(input.charAt(i++));enc3=this._keyStr.indexOf(input.charAt(i++));enc4=this._keyStr.indexOf(input.charAt(i++));chr1=(enc1<<2)|(enc2>>4);chr2=((enc2&15)<<4)|(enc3>>2);chr3=((enc3&3)<<6)|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2);}
if(enc4!=64){output=output+String.fromCharCode(chr3);}
chr1=chr2=chr3="";enc1=enc2=enc3=enc4="";}while(i<input.length);return unescape(output);},"encodeUTF8":function(input){var output='';for(var n=0;n<input.length;n++){var c=input.charCodeAt(n);if(c<128){output+=input[n];}
else if(c>127){if(c<2048){output+=String.fromCharCode((c>>6)|192);}
else{output+=String.fromCharCode((c>>12)|224)+String.fromCharCode((c>>6)&63|128);}
output+=String.fromCharCode((c&63)|128);}}
return output;},"convertToXMLReferences":function(input){var output='';for(var n=0;n<input.length;n++){var c=input.charCodeAt(n);if(c<128){output+=input[n];}
else if(c>127){output+=("&#"+c+";");}}
return output;},"rectsIntersect":function(r1,r2){return r2.x<(r1.x+r1.width)&&(r2.x+r2.width)>r1.x&&r2.y<(r1.y+r1.height)&&(r2.y+r2.height)>r1.y;},"text2xml":function(sXML){var out;try{var dXML=($.browser.msie)?new ActiveXObject("Microsoft.XMLDOM"):new DOMParser();dXML.async=false;}catch(e){throw new Error("XML Parser could not be instantiated");};try{if($.browser.msie)out=(dXML.loadXML(sXML))?dXML:false;else out=dXML.parseFromString(sXML,"text/xml");}
catch(e){throw new Error("Error parsing XML string");};return out;}};if(typeof eventManager!='undefined'){eventManager.fire('scriptLoaded','vle/node/draw/svg-edit/utils.js');};;jQuery.fn.extend({everyTime:function(interval,label,fn,times){return this.each(function(){jQuery.timer.add(this,interval,label,fn,times);});},oneTime:function(interval,label,fn){return this.each(function(){jQuery.timer.add(this,interval,label,fn,1);});},stopTime:function(label,fn){return this.each(function(){jQuery.timer.remove(this,label,fn);});}});jQuery.extend({timer:{global:[],guid:1,dataKey:"jQuery.timer",regex:/^([0-9]+(?:\.[0-9]*)?)\s*(.*s)?$/,powers:{'ms':1,'cs':10,'ds':100,'s':1000,'das':10000,'hs':100000,'ks':1000000},timeParse:function(value){if(value==undefined||value==null)
return null;var result=this.regex.exec(jQuery.trim(value.toString()));if(result[2]){var num=parseFloat(result[1]);var mult=this.powers[result[2]]||1;return num*mult;}else{return value;}},add:function(element,interval,label,fn,times){var counter=0;if(jQuery.isFunction(label)){if(!times)
times=fn;fn=label;label=interval;}
interval=jQuery.timer.timeParse(interval);if(typeof interval!='number'||isNaN(interval)||interval<0)
return;if(typeof times!='number'||isNaN(times)||times<0)
times=0;times=times||0;var timers=jQuery.data(element,this.dataKey)||jQuery.data(element,this.dataKey,{});if(!timers[label])
timers[label]={};fn.timerID=fn.timerID||this.guid++;var handler=function(){if((++counter>times&&times!==0)||fn.call(element,counter)===false)
jQuery.timer.remove(element,label,fn);};handler.timerID=fn.timerID;if(!timers[label][fn.timerID])
timers[label][fn.timerID]=window.setInterval(handler,interval);this.global.push(element);},remove:function(element,label,fn){var timers=jQuery.data(element,this.dataKey),ret;if(timers){if(!label){for(label in timers)
this.remove(element,label,fn);}else if(timers[label]){if(fn){if(fn.timerID){window.clearInterval(timers[label][fn.timerID]);delete timers[label][fn.timerID];}}else{for(var fn in timers[label]){window.clearInterval(timers[label][fn]);delete timers[label][fn];}}
for(ret in timers[label])break;if(!ret){ret=null;delete timers[label];}}
for(ret in timers)break;if(!ret)
jQuery.removeData(element,this.dataKey);}}}});jQuery(window).bind("unload",function(){jQuery.each(jQuery.timer.global,function(index,item){jQuery.timer.remove(item);});});if(typeof eventManager!='undefined'){eventManager.fire('scriptLoaded','vle/node/draw/svg-edit/jquery.timers-1.2.js');};

//used to notify scriptloader that this script has finished loading
if(typeof eventManager != 'undefined'){
	eventManager.fire('scriptLoaded', 'vle/node/draw/svg-edit/all.js');
};