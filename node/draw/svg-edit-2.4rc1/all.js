jQuery.ui||(function(c){var i=c.fn.remove,d=c.browser.mozilla&&(parseFloat(c.browser.version)<1.9);c.ui={version:"1.7.2",plugin:{add:function(k,l,n){var m=c.ui[k].prototype;for(var j in n){m.plugins[j]=m.plugins[j]||[];m.plugins[j].push([l,n[j]])}},call:function(j,l,k){var n=j.plugins[l];if(!n||!j.element[0].parentNode){return}for(var m=0;m<n.length;m++){if(j.options[n[m][0]]){n[m][1].apply(j.element,k)}}}},contains:function(k,j){return document.compareDocumentPosition?k.compareDocumentPosition(j)&16:k!==j&&k.contains(j)},hasScroll:function(m,k){if(c(m).css("overflow")=="hidden"){return false}var j=(k&&k=="left")?"scrollLeft":"scrollTop",l=false;if(m[j]>0){return true}m[j]=1;l=(m[j]>0);m[j]=0;return l},isOverAxis:function(k,j,l){return(k>j)&&(k<(j+l))},isOver:function(o,k,n,m,j,l){return c.ui.isOverAxis(o,n,j)&&c.ui.isOverAxis(k,m,l)},keyCode:{BACKSPACE:8,CAPS_LOCK:20,COMMA:188,CONTROL:17,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,INSERT:45,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SHIFT:16,SPACE:32,TAB:9,UP:38}};if(d){var f=c.attr,e=c.fn.removeAttr,h="http://www.w3.org/2005/07/aaa",a=/^aria-/,b=/^wairole:/;c.attr=function(k,j,l){var m=l!==undefined;return(j=="role"?(m?f.call(this,k,j,"wairole:"+l):(f.apply(this,arguments)||"").replace(b,"")):(a.test(j)?(m?k.setAttributeNS(h,j.replace(a,"aaa:"),l):f.call(this,k,j.replace(a,"aaa:"))):f.apply(this,arguments)))};c.fn.removeAttr=function(j){return(a.test(j)?this.each(function(){this.removeAttributeNS(h,j.replace(a,""))}):e.call(this,j))}}c.fn.extend({remove:function(){c("*",this).add(this).each(function(){c(this).triggerHandler("remove")});return i.apply(this,arguments)},enableSelection:function(){return this.attr("unselectable","off").css("MozUserSelect","").unbind("selectstart.ui")},disableSelection:function(){return this.attr("unselectable","on").css("MozUserSelect","none").bind("selectstart.ui",function(){return false})},scrollParent:function(){var j;if((c.browser.msie&&(/(static|relative)/).test(this.css("position")))||(/absolute/).test(this.css("position"))){j=this.parents().filter(function(){return(/(relative|absolute|fixed)/).test(c.curCSS(this,"position",1))&&(/(auto|scroll)/).test(c.curCSS(this,"overflow",1)+c.curCSS(this,"overflow-y",1)+c.curCSS(this,"overflow-x",1))}).eq(0)}else{j=this.parents().filter(function(){return(/(auto|scroll)/).test(c.curCSS(this,"overflow",1)+c.curCSS(this,"overflow-y",1)+c.curCSS(this,"overflow-x",1))}).eq(0)}return(/fixed/).test(this.css("position"))||!j.length?c(document):j}});c.extend(c.expr[":"],{data:function(l,k,j){return!!c.data(l,j[3])},focusable:function(k){var l=k.nodeName.toLowerCase(),j=c.attr(k,"tabindex");return(/input|select|textarea|button|object/.test(l)?!k.disabled:"a"==l||"area"==l?k.href||!isNaN(j):!isNaN(j))&&!c(k)["area"==l?"parents":"closest"](":hidden").length},tabbable:function(k){var j=c.attr(k,"tabindex");return(isNaN(j)||j>=0)&&c(k).is(":focusable")}});function g(m,n,o,l){function k(q){var p=c[m][n][q]||[];return(typeof p=="string"?p.split(/,?\s+/):p)}var j=k("getter");if(l.length==1&&typeof l[0]=="string"){j=j.concat(k("getterSetter"))}return(c.inArray(o,j)!=-1)}c.widget=function(k,j){var l=k.split(".")[0];k=k.split(".")[1];c.fn[k]=function(p){var n=(typeof p=="string"),o=Array.prototype.slice.call(arguments,1);if(n&&p.substring(0,1)=="_"){return this}if(n&&g(l,k,p,o)){var m=c.data(this[0],k);return(m?m[p].apply(m,o):undefined)}return this.each(function(){var q=c.data(this,k);(!q&&!n&&c.data(this,k,new c[l][k](this,p))._init());(q&&n&&c.isFunction(q[p])&&q[p].apply(q,o))})};c[l]=c[l]||{};c[l][k]=function(o,n){var m=this;this.namespace=l;this.widgetName=k;this.widgetEventPrefix=c[l][k].eventPrefix||k;this.widgetBaseClass=l+"-"+k;this.options=c.extend({},c.widget.defaults,c[l][k].defaults,c.metadata&&c.metadata.get(o)[k],n);this.element=c(o).bind("setData."+k,function(q,p,r){if(q.target==o){return m._setData(p,r)}}).bind("getData."+k,function(q,p){if(q.target==o){return m._getData(p)}}).bind("remove",function(){return m.destroy()})};c[l][k].prototype=c.extend({},c.widget.prototype,j);c[l][k].getterSetter="option"};c.widget.prototype={_init:function(){},destroy:function(){this.element.removeData(this.widgetName).removeClass(this.widgetBaseClass+"-disabled "+this.namespace+"-state-disabled").removeAttr("aria-disabled")},option:function(l,m){var k=l,j=this;if(typeof l=="string"){if(m===undefined){return this._getData(l)}k={};k[l]=m}c.each(k,function(n,o){j._setData(n,o)})},_getData:function(j){return this.options[j]},_setData:function(j,k){this.options[j]=k;if(j=="disabled"){this.element[k?"addClass":"removeClass"](this.widgetBaseClass+"-disabled "+this.namespace+"-state-disabled").attr("aria-disabled",k)}},enable:function(){this._setData("disabled",false)},disable:function(){this._setData("disabled",true)},_trigger:function(l,m,n){var p=this.options[l],j=(l==this.widgetEventPrefix?l:this.widgetEventPrefix+l);m=c.Event(m);m.type=j;if(m.originalEvent){for(var k=c.event.props.length,o;k;){o=c.event.props[--k];m[o]=m.originalEvent[o]}}this.element.trigger(m,n);return!(c.isFunction(p)&&p.call(this.element[0],m,n)===false||m.isDefaultPrevented())}};c.widget.defaults={disabled:false};c.ui.mouse={_mouseInit:function(){var j=this;this.element.bind("mousedown."+this.widgetName,function(k){return j._mouseDown(k)}).bind("click."+this.widgetName,function(k){if(j._preventClickEvent){j._preventClickEvent=false;k.stopImmediatePropagation();return false}});if(c.browser.msie){this._mouseUnselectable=this.element.attr("unselectable");this.element.attr("unselectable","on")}this.started=false},_mouseDestroy:function(){this.element.unbind("."+this.widgetName);(c.browser.msie&&this.element.attr("unselectable",this._mouseUnselectable))},_mouseDown:function(l){l.originalEvent=l.originalEvent||{};if(l.originalEvent.mouseHandled){return}(this._mouseStarted&&this._mouseUp(l));this._mouseDownEvent=l;var k=this,m=(l.which==1),j=(typeof this.options.cancel=="string"?c(l.target).parents().add(l.target).filter(this.options.cancel).length:false);if(!m||j||!this._mouseCapture(l)){return true}this.mouseDelayMet=!this.options.delay;if(!this.mouseDelayMet){this._mouseDelayTimer=setTimeout(function(){k.mouseDelayMet=true},this.options.delay)}if(this._mouseDistanceMet(l)&&this._mouseDelayMet(l)){this._mouseStarted=(this._mouseStart(l)!==false);if(!this._mouseStarted){l.preventDefault();return true}}this._mouseMoveDelegate=function(n){return k._mouseMove(n)};this._mouseUpDelegate=function(n){return k._mouseUp(n)};c(document).bind("mousemove."+this.widgetName,this._mouseMoveDelegate).bind("mouseup."+this.widgetName,this._mouseUpDelegate);(c.browser.safari||l.preventDefault());l.originalEvent.mouseHandled=true;return true},_mouseMove:function(j){if(c.browser.msie&&!j.button){return this._mouseUp(j)}if(this._mouseStarted){this._mouseDrag(j);return j.preventDefault()}if(this._mouseDistanceMet(j)&&this._mouseDelayMet(j)){this._mouseStarted=(this._mouseStart(this._mouseDownEvent,j)!==false);(this._mouseStarted?this._mouseDrag(j):this._mouseUp(j))}return!this._mouseStarted},_mouseUp:function(j){c(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate);if(this._mouseStarted){this._mouseStarted=false;this._preventClickEvent=(j.target==this._mouseDownEvent.target);this._mouseStop(j)}return false},_mouseDistanceMet:function(j){return(Math.max(Math.abs(this._mouseDownEvent.pageX-j.pageX),Math.abs(this._mouseDownEvent.pageY-j.pageY))>=this.options.distance)},_mouseDelayMet:function(j){return this.mouseDelayMet},_mouseStart:function(j){},_mouseDrag:function(j){},_mouseStop:function(j){},_mouseCapture:function(j){return true}};c.ui.mouse.defaults={cancel:null,distance:1,delay:0}})(jQuery);;(function(a){a.widget("ui.draggable",a.extend({},a.ui.mouse,{_init:function(){if(this.options.helper=="original"&&!(/^(?:r|a|f)/).test(this.element.css("position"))){this.element[0].style.position="relative"}(this.options.addClasses&&this.element.addClass("ui-draggable"));(this.options.disabled&&this.element.addClass("ui-draggable-disabled"));this._mouseInit()},destroy:function(){if(!this.element.data("draggable")){return}this.element.removeData("draggable").unbind(".draggable").removeClass("ui-draggable ui-draggable-dragging ui-draggable-disabled");this._mouseDestroy()},_mouseCapture:function(b){var c=this.options;if(this.helper||c.disabled||a(b.target).is(".ui-resizable-handle")){return false}this.handle=this._getHandle(b);if(!this.handle){return false}return true},_mouseStart:function(b){var c=this.options;this.helper=this._createHelper(b);this._cacheHelperProportions();if(a.ui.ddmanager){a.ui.ddmanager.current=this}this._cacheMargins();this.cssPosition=this.helper.css("position");this.scrollParent=this.helper.scrollParent();this.offset=this.element.offset();this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left};a.extend(this.offset,{click:{left:b.pageX-this.offset.left,top:b.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()});this.originalPosition=this._generatePosition(b);this.originalPageX=b.pageX;this.originalPageY=b.pageY;if(c.cursorAt){this._adjustOffsetFromHelper(c.cursorAt)}if(c.containment){this._setContainment()}this._trigger("start",b);this._cacheHelperProportions();if(a.ui.ddmanager&&!c.dropBehaviour){a.ui.ddmanager.prepareOffsets(this,b)}this.helper.addClass("ui-draggable-dragging");this._mouseDrag(b,true);return true},_mouseDrag:function(b,d){this.position=this._generatePosition(b);this.positionAbs=this._convertPositionTo("absolute");if(!d){var c=this._uiHash();this._trigger("drag",b,c);this.position=c.position}if(!this.options.axis||this.options.axis!="y"){this.helper[0].style.left=this.position.left+"px"}if(!this.options.axis||this.options.axis!="x"){this.helper[0].style.top=this.position.top+"px"}if(a.ui.ddmanager){a.ui.ddmanager.drag(this,b)}return false},_mouseStop:function(c){var d=false;if(a.ui.ddmanager&&!this.options.dropBehaviour){d=a.ui.ddmanager.drop(this,c)}if(this.dropped){d=this.dropped;this.dropped=false}if((this.options.revert=="invalid"&&!d)||(this.options.revert=="valid"&&d)||this.options.revert===true||(a.isFunction(this.options.revert)&&this.options.revert.call(this.element,d))){var b=this;a(this.helper).animate(this.originalPosition,parseInt(this.options.revertDuration,10),function(){b._trigger("stop",c);b._clear()})}else{this._trigger("stop",c);this._clear()}return false},_getHandle:function(b){var c=!this.options.handle||!a(this.options.handle,this.element).length?true:false;a(this.options.handle,this.element).find("*").andSelf().each(function(){if(this==b.target){c=true}});return c},_createHelper:function(c){var d=this.options;var b=a.isFunction(d.helper)?a(d.helper.apply(this.element[0],[c])):(d.helper=="clone"?this.element.clone():this.element);if(!b.parents("body").length){b.appendTo((d.appendTo=="parent"?this.element[0].parentNode:d.appendTo))}if(b[0]!=this.element[0]&&!(/(fixed|absolute)/).test(b.css("position"))){b.css("position","absolute")}return b},_adjustOffsetFromHelper:function(b){if(b.left!=undefined){this.offset.click.left=b.left+this.margins.left}if(b.right!=undefined){this.offset.click.left=this.helperProportions.width-b.right+this.margins.left}if(b.top!=undefined){this.offset.click.top=b.top+this.margins.top}if(b.bottom!=undefined){this.offset.click.top=this.helperProportions.height-b.bottom+this.margins.top}},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var b=this.offsetParent.offset();if(this.cssPosition=="absolute"&&this.scrollParent[0]!=document&&a.ui.contains(this.scrollParent[0],this.offsetParent[0])){b.left+=this.scrollParent.scrollLeft();b.top+=this.scrollParent.scrollTop()}if((this.offsetParent[0]==document.body)||(this.offsetParent[0].tagName&&this.offsetParent[0].tagName.toLowerCase()=="html"&&a.browser.msie)){b={top:0,left:0}}return{top:b.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:b.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if(this.cssPosition=="relative"){var b=this.element.position();return{top:b.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:b.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}else{return{top:0,left:0}}},_cacheMargins:function(){this.margins={left:(parseInt(this.element.css("marginLeft"),10)||0),top:(parseInt(this.element.css("marginTop"),10)||0)}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var e=this.options;if(e.containment=="parent"){e.containment=this.helper[0].parentNode}if(e.containment=="document"||e.containment=="window"){this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,a(e.containment=="document"?document:window).width()-this.helperProportions.width-this.margins.left,(a(e.containment=="document"?document:window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]}if(!(/^(document|window|parent)$/).test(e.containment)&&e.containment.constructor!=Array){var c=a(e.containment)[0];if(!c){return}var d=a(e.containment).offset();var b=(a(c).css("overflow")!="hidden");this.containment=[d.left+(parseInt(a(c).css("borderLeftWidth"),10)||0)+(parseInt(a(c).css("paddingLeft"),10)||0)-this.margins.left,d.top+(parseInt(a(c).css("borderTopWidth"),10)||0)+(parseInt(a(c).css("paddingTop"),10)||0)-this.margins.top,d.left+(b?Math.max(c.scrollWidth,c.offsetWidth):c.offsetWidth)-(parseInt(a(c).css("borderLeftWidth"),10)||0)-(parseInt(a(c).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,d.top+(b?Math.max(c.scrollHeight,c.offsetHeight):c.offsetHeight)-(parseInt(a(c).css("borderTopWidth"),10)||0)-(parseInt(a(c).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top]}else{if(e.containment.constructor==Array){this.containment=e.containment}}},_convertPositionTo:function(f,h){if(!h){h=this.position}var c=f=="absolute"?1:-1;var e=this.options,b=this.cssPosition=="absolute"&&!(this.scrollParent[0]!=document&&a.ui.contains(this.scrollParent[0],this.offsetParent[0]))?this.offsetParent:this.scrollParent,g=(/(html|body)/i).test(b[0].tagName);return{top:(h.top+this.offset.relative.top*c+this.offset.parent.top*c-(a.browser.safari&&this.cssPosition=="fixed"?0:(this.cssPosition=="fixed"?-this.scrollParent.scrollTop():(g?0:b.scrollTop()))*c)),left:(h.left+this.offset.relative.left*c+this.offset.parent.left*c-(a.browser.safari&&this.cssPosition=="fixed"?0:(this.cssPosition=="fixed"?-this.scrollParent.scrollLeft():g?0:b.scrollLeft())*c))}},_generatePosition:function(e){var h=this.options,b=this.cssPosition=="absolute"&&!(this.scrollParent[0]!=document&&a.ui.contains(this.scrollParent[0],this.offsetParent[0]))?this.offsetParent:this.scrollParent,i=(/(html|body)/i).test(b[0].tagName);if(this.cssPosition=="relative"&&!(this.scrollParent[0]!=document&&this.scrollParent[0]!=this.offsetParent[0])){this.offset.relative=this._getRelativeOffset()}var d=e.pageX;var c=e.pageY;if(this.originalPosition){if(this.containment){if(e.pageX-this.offset.click.left<this.containment[0]){d=this.containment[0]+this.offset.click.left}if(e.pageY-this.offset.click.top<this.containment[1]){c=this.containment[1]+this.offset.click.top}if(e.pageX-this.offset.click.left>this.containment[2]){d=this.containment[2]+this.offset.click.left}if(e.pageY-this.offset.click.top>this.containment[3]){c=this.containment[3]+this.offset.click.top}}if(h.grid){var g=this.originalPageY+Math.round((c-this.originalPageY)/h.grid[1])*h.grid[1];c=this.containment?(!(g-this.offset.click.top<this.containment[1]||g-this.offset.click.top>this.containment[3])?g:(!(g-this.offset.click.top<this.containment[1])?g-h.grid[1]:g+h.grid[1])):g;var f=this.originalPageX+Math.round((d-this.originalPageX)/h.grid[0])*h.grid[0];d=this.containment?(!(f-this.offset.click.left<this.containment[0]||f-this.offset.click.left>this.containment[2])?f:(!(f-this.offset.click.left<this.containment[0])?f-h.grid[0]:f+h.grid[0])):f}}return{top:(c-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+(a.browser.safari&&this.cssPosition=="fixed"?0:(this.cssPosition=="fixed"?-this.scrollParent.scrollTop():(i?0:b.scrollTop())))),left:(d-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+(a.browser.safari&&this.cssPosition=="fixed"?0:(this.cssPosition=="fixed"?-this.scrollParent.scrollLeft():i?0:b.scrollLeft())))}},_clear:function(){this.helper.removeClass("ui-draggable-dragging");if(this.helper[0]!=this.element[0]&&!this.cancelHelperRemoval){this.helper.remove()}this.helper=null;this.cancelHelperRemoval=false},_trigger:function(b,c,d){d=d||this._uiHash();a.ui.plugin.call(this,b,[c,d]);if(b=="drag"){this.positionAbs=this._convertPositionTo("absolute")}return a.widget.prototype._trigger.call(this,b,c,d)},plugins:{},_uiHash:function(b){return{helper:this.helper,position:this.position,absolutePosition:this.positionAbs,offset:this.positionAbs}}}));a.extend(a.ui.draggable,{version:"1.7.2",eventPrefix:"drag",defaults:{addClasses:true,appendTo:"parent",axis:false,cancel:":input,option",connectToSortable:false,containment:false,cursor:"auto",cursorAt:false,delay:0,distance:1,grid:false,handle:false,helper:"original",iframeFix:false,opacity:false,refreshPositions:false,revert:false,revertDuration:500,scope:"default",scroll:true,scrollSensitivity:20,scrollSpeed:20,snap:false,snapMode:"both",snapTolerance:20,stack:false,zIndex:false}});a.ui.plugin.add("draggable","connectToSortable",{start:function(c,e){var d=a(this).data("draggable"),f=d.options,b=a.extend({},e,{item:d.element});d.sortables=[];a(f.connectToSortable).each(function(){var g=a.data(this,"sortable");if(g&&!g.options.disabled){d.sortables.push({instance:g,shouldRevert:g.options.revert});g._refreshItems();g._trigger("activate",c,b)}})},stop:function(c,e){var d=a(this).data("draggable"),b=a.extend({},e,{item:d.element});a.each(d.sortables,function(){if(this.instance.isOver){this.instance.isOver=0;d.cancelHelperRemoval=true;this.instance.cancelHelperRemoval=false;if(this.shouldRevert){this.instance.options.revert=true}this.instance._mouseStop(c);this.instance.options.helper=this.instance.options._helper;if(d.options.helper=="original"){this.instance.currentItem.css({top:"auto",left:"auto"})}}else{this.instance.cancelHelperRemoval=false;this.instance._trigger("deactivate",c,b)}})},drag:function(c,f){var e=a(this).data("draggable"),b=this;var d=function(i){var n=this.offset.click.top,m=this.offset.click.left;var g=this.positionAbs.top,k=this.positionAbs.left;var j=i.height,l=i.width;var p=i.top,h=i.left;return a.ui.isOver(g+n,k+m,p,h,j,l)};a.each(e.sortables,function(g){this.instance.positionAbs=e.positionAbs;this.instance.helperProportions=e.helperProportions;this.instance.offset.click=e.offset.click;if(this.instance._intersectsWith(this.instance.containerCache)){if(!this.instance.isOver){this.instance.isOver=1;this.instance.currentItem=a(b).clone().appendTo(this.instance.element).data("sortable-item",true);this.instance.options._helper=this.instance.options.helper;this.instance.options.helper=function(){return f.helper[0]};c.target=this.instance.currentItem[0];this.instance._mouseCapture(c,true);this.instance._mouseStart(c,true,true);this.instance.offset.click.top=e.offset.click.top;this.instance.offset.click.left=e.offset.click.left;this.instance.offset.parent.left-=e.offset.parent.left-this.instance.offset.parent.left;this.instance.offset.parent.top-=e.offset.parent.top-this.instance.offset.parent.top;e._trigger("toSortable",c);e.dropped=this.instance.element;e.currentItem=e.element;this.instance.fromOutside=e}if(this.instance.currentItem){this.instance._mouseDrag(c)}}else{if(this.instance.isOver){this.instance.isOver=0;this.instance.cancelHelperRemoval=true;this.instance.options.revert=false;this.instance._trigger("out",c,this.instance._uiHash(this.instance));this.instance._mouseStop(c,true);this.instance.options.helper=this.instance.options._helper;this.instance.currentItem.remove();if(this.instance.placeholder){this.instance.placeholder.remove()}e._trigger("fromSortable",c);e.dropped=false}}})}});a.ui.plugin.add("draggable","cursor",{start:function(c,d){var b=a("body"),e=a(this).data("draggable").options;if(b.css("cursor")){e._cursor=b.css("cursor")}b.css("cursor",e.cursor)},stop:function(b,c){var d=a(this).data("draggable").options;if(d._cursor){a("body").css("cursor",d._cursor)}}});a.ui.plugin.add("draggable","iframeFix",{start:function(b,c){var d=a(this).data("draggable").options;a(d.iframeFix===true?"iframe":d.iframeFix).each(function(){a('<div class="ui-draggable-iframeFix" style="background: #fff;"></div>').css({width:this.offsetWidth+"px",height:this.offsetHeight+"px",position:"absolute",opacity:"0.001",zIndex:1000}).css(a(this).offset()).appendTo("body")})},stop:function(b,c){a("div.ui-draggable-iframeFix").each(function(){this.parentNode.removeChild(this)})}});a.ui.plugin.add("draggable","opacity",{start:function(c,d){var b=a(d.helper),e=a(this).data("draggable").options;if(b.css("opacity")){e._opacity=b.css("opacity")}b.css("opacity",e.opacity)},stop:function(b,c){var d=a(this).data("draggable").options;if(d._opacity){a(c.helper).css("opacity",d._opacity)}}});a.ui.plugin.add("draggable","scroll",{start:function(c,d){var b=a(this).data("draggable");if(b.scrollParent[0]!=document&&b.scrollParent[0].tagName!="HTML"){b.overflowOffset=b.scrollParent.offset()}},drag:function(d,e){var c=a(this).data("draggable"),f=c.options,b=false;if(c.scrollParent[0]!=document&&c.scrollParent[0].tagName!="HTML"){if(!f.axis||f.axis!="x"){if((c.overflowOffset.top+c.scrollParent[0].offsetHeight)-d.pageY<f.scrollSensitivity){c.scrollParent[0].scrollTop=b=c.scrollParent[0].scrollTop+f.scrollSpeed}else{if(d.pageY-c.overflowOffset.top<f.scrollSensitivity){c.scrollParent[0].scrollTop=b=c.scrollParent[0].scrollTop-f.scrollSpeed}}}if(!f.axis||f.axis!="y"){if((c.overflowOffset.left+c.scrollParent[0].offsetWidth)-d.pageX<f.scrollSensitivity){c.scrollParent[0].scrollLeft=b=c.scrollParent[0].scrollLeft+f.scrollSpeed}else{if(d.pageX-c.overflowOffset.left<f.scrollSensitivity){c.scrollParent[0].scrollLeft=b=c.scrollParent[0].scrollLeft-f.scrollSpeed}}}}else{if(!f.axis||f.axis!="x"){if(d.pageY-a(document).scrollTop()<f.scrollSensitivity){b=a(document).scrollTop(a(document).scrollTop()-f.scrollSpeed)}else{if(a(window).height()-(d.pageY-a(document).scrollTop())<f.scrollSensitivity){b=a(document).scrollTop(a(document).scrollTop()+f.scrollSpeed)}}}if(!f.axis||f.axis!="y"){if(d.pageX-a(document).scrollLeft()<f.scrollSensitivity){b=a(document).scrollLeft(a(document).scrollLeft()-f.scrollSpeed)}else{if(a(window).width()-(d.pageX-a(document).scrollLeft())<f.scrollSensitivity){b=a(document).scrollLeft(a(document).scrollLeft()+f.scrollSpeed)}}}}if(b!==false&&a.ui.ddmanager&&!f.dropBehaviour){a.ui.ddmanager.prepareOffsets(c,d)}}});a.ui.plugin.add("draggable","snap",{start:function(c,d){var b=a(this).data("draggable"),e=b.options;b.snapElements=[];a(e.snap.constructor!=String?(e.snap.items||":data(draggable)"):e.snap).each(function(){var g=a(this);var f=g.offset();if(this!=b.element[0]){b.snapElements.push({item:this,width:g.outerWidth(),height:g.outerHeight(),top:f.top,left:f.left})}})},drag:function(u,p){var g=a(this).data("draggable"),q=g.options;var y=q.snapTolerance;var x=p.offset.left,w=x+g.helperProportions.width,f=p.offset.top,e=f+g.helperProportions.height;for(var v=g.snapElements.length-1;v>=0;v--){var s=g.snapElements[v].left,n=s+g.snapElements[v].width,m=g.snapElements[v].top,A=m+g.snapElements[v].height;if(!((s-y<x&&x<n+y&&m-y<f&&f<A+y)||(s-y<x&&x<n+y&&m-y<e&&e<A+y)||(s-y<w&&w<n+y&&m-y<f&&f<A+y)||(s-y<w&&w<n+y&&m-y<e&&e<A+y))){if(g.snapElements[v].snapping){(g.options.snap.release&&g.options.snap.release.call(g.element,u,a.extend(g._uiHash(),{snapItem:g.snapElements[v].item})))}g.snapElements[v].snapping=false;continue}if(q.snapMode!="inner"){var c=Math.abs(m-e)<=y;var z=Math.abs(A-f)<=y;var j=Math.abs(s-w)<=y;var k=Math.abs(n-x)<=y;if(c){p.position.top=g._convertPositionTo("relative",{top:m-g.helperProportions.height,left:0}).top-g.margins.top}if(z){p.position.top=g._convertPositionTo("relative",{top:A,left:0}).top-g.margins.top}if(j){p.position.left=g._convertPositionTo("relative",{top:0,left:s-g.helperProportions.width}).left-g.margins.left}if(k){p.position.left=g._convertPositionTo("relative",{top:0,left:n}).left-g.margins.left}}var h=(c||z||j||k);if(q.snapMode!="outer"){var c=Math.abs(m-f)<=y;var z=Math.abs(A-e)<=y;var j=Math.abs(s-x)<=y;var k=Math.abs(n-w)<=y;if(c){p.position.top=g._convertPositionTo("relative",{top:m,left:0}).top-g.margins.top}if(z){p.position.top=g._convertPositionTo("relative",{top:A-g.helperProportions.height,left:0}).top-g.margins.top}if(j){p.position.left=g._convertPositionTo("relative",{top:0,left:s}).left-g.margins.left}if(k){p.position.left=g._convertPositionTo("relative",{top:0,left:n-g.helperProportions.width}).left-g.margins.left}}if(!g.snapElements[v].snapping&&(c||z||j||k||h)){(g.options.snap.snap&&g.options.snap.snap.call(g.element,u,a.extend(g._uiHash(),{snapItem:g.snapElements[v].item})))}g.snapElements[v].snapping=(c||z||j||k||h)}}});a.ui.plugin.add("draggable","stack",{start:function(b,c){var e=a(this).data("draggable").options;var d=a.makeArray(a(e.stack.group)).sort(function(g,f){return(parseInt(a(g).css("zIndex"),10)||e.stack.min)-(parseInt(a(f).css("zIndex"),10)||e.stack.min)});a(d).each(function(f){this.style.zIndex=e.stack.min+f});this[0].style.zIndex=e.stack.min+d.length}});a.ui.plugin.add("draggable","zIndex",{start:function(c,d){var b=a(d.helper),e=a(this).data("draggable").options;if(b.css("zIndex")){e._zIndex=b.css("zIndex")}b.css("zIndex",e.zIndex)},stop:function(b,c){var d=a(this).data("draggable").options;if(d._zIndex){a(c.helper).css("zIndex",d._zIndex)}}})})(jQuery);;(function(a){a.widget("ui.droppable",{_init:function(){var c=this.options,b=c.accept;this.isover=0;this.isout=1;this.options.accept=this.options.accept&&a.isFunction(this.options.accept)?this.options.accept:function(e){return e.is(b)};this.proportions={width:this.element[0].offsetWidth,height:this.element[0].offsetHeight};a.ui.ddmanager.droppables[this.options.scope]=a.ui.ddmanager.droppables[this.options.scope]||[];a.ui.ddmanager.droppables[this.options.scope].push(this);(this.options.addClasses&&this.element.addClass("ui-droppable"))},destroy:function(){var b=a.ui.ddmanager.droppables[this.options.scope];for(var c=0;c<b.length;c++){if(b[c]==this){b.splice(c,1)}}this.element.removeClass("ui-droppable ui-droppable-disabled").removeData("droppable").unbind(".droppable")},_setData:function(b,c){if(b=="accept"){this.options.accept=c&&a.isFunction(c)?c:function(e){return e.is(c)}}else{a.widget.prototype._setData.apply(this,arguments)}},_activate:function(c){var b=a.ui.ddmanager.current;if(this.options.activeClass){this.element.addClass(this.options.activeClass)}(b&&this._trigger("activate",c,this.ui(b)))},_deactivate:function(c){var b=a.ui.ddmanager.current;if(this.options.activeClass){this.element.removeClass(this.options.activeClass)}(b&&this._trigger("deactivate",c,this.ui(b)))},_over:function(c){var b=a.ui.ddmanager.current;if(!b||(b.currentItem||b.element)[0]==this.element[0]){return}if(this.options.accept.call(this.element[0],(b.currentItem||b.element))){if(this.options.hoverClass){this.element.addClass(this.options.hoverClass)}this._trigger("over",c,this.ui(b))}},_out:function(c){var b=a.ui.ddmanager.current;if(!b||(b.currentItem||b.element)[0]==this.element[0]){return}if(this.options.accept.call(this.element[0],(b.currentItem||b.element))){if(this.options.hoverClass){this.element.removeClass(this.options.hoverClass)}this._trigger("out",c,this.ui(b))}},_drop:function(c,d){var b=d||a.ui.ddmanager.current;if(!b||(b.currentItem||b.element)[0]==this.element[0]){return false}var e=false;this.element.find(":data(droppable)").not(".ui-draggable-dragging").each(function(){var f=a.data(this,"droppable");if(f.options.greedy&&a.ui.intersect(b,a.extend(f,{offset:f.element.offset()}),f.options.tolerance)){e=true;return false}});if(e){return false}if(this.options.accept.call(this.element[0],(b.currentItem||b.element))){if(this.options.activeClass){this.element.removeClass(this.options.activeClass)}if(this.options.hoverClass){this.element.removeClass(this.options.hoverClass)}this._trigger("drop",c,this.ui(b));return this.element}return false},ui:function(b){return{draggable:(b.currentItem||b.element),helper:b.helper,position:b.position,absolutePosition:b.positionAbs,offset:b.positionAbs}}});a.extend(a.ui.droppable,{version:"1.7.2",eventPrefix:"drop",defaults:{accept:"*",activeClass:false,addClasses:true,greedy:false,hoverClass:false,scope:"default",tolerance:"intersect"}});a.ui.intersect=function(q,j,o){if(!j.offset){return false}var e=(q.positionAbs||q.position.absolute).left,d=e+q.helperProportions.width,n=(q.positionAbs||q.position.absolute).top,m=n+q.helperProportions.height;var g=j.offset.left,c=g+j.proportions.width,p=j.offset.top,k=p+j.proportions.height;switch(o){case"fit":return(g<e&&d<c&&p<n&&m<k);break;case"intersect":return(g<e+(q.helperProportions.width/2)&&d-(q.helperProportions.width/2)<c&&p<n+(q.helperProportions.height/2)&&m-(q.helperProportions.height/2)<k);break;case"pointer":var h=((q.positionAbs||q.position.absolute).left+(q.clickOffset||q.offset.click).left),i=((q.positionAbs||q.position.absolute).top+(q.clickOffset||q.offset.click).top),f=a.ui.isOver(i,h,p,g,j.proportions.height,j.proportions.width);return f;break;case"touch":return((n>=p&&n<=k)||(m>=p&&m<=k)||(n<p&&m>k))&&((e>=g&&e<=c)||(d>=g&&d<=c)||(e<g&&d>c));break;default:return false;break}};a.ui.ddmanager={current:null,droppables:{"default":[]},prepareOffsets:function(e,g){var b=a.ui.ddmanager.droppables[e.options.scope];var f=g?g.type:null;var h=(e.currentItem||e.element).find(":data(droppable)").andSelf();droppablesLoop:for(var d=0;d<b.length;d++){if(b[d].options.disabled||(e&&!b[d].options.accept.call(b[d].element[0],(e.currentItem||e.element)))){continue}for(var c=0;c<h.length;c++){if(h[c]==b[d].element[0]){b[d].proportions.height=0;continue droppablesLoop}}b[d].visible=b[d].element.css("display")!="none";if(!b[d].visible){continue}b[d].offset=b[d].element.offset();b[d].proportions={width:b[d].element[0].offsetWidth,height:b[d].element[0].offsetHeight};if(f=="mousedown"){b[d]._activate.call(b[d],g)}}},drop:function(b,c){var d=false;a.each(a.ui.ddmanager.droppables[b.options.scope],function(){if(!this.options){return}if(!this.options.disabled&&this.visible&&a.ui.intersect(b,this,this.options.tolerance)){d=this._drop.call(this,c)}if(!this.options.disabled&&this.visible&&this.options.accept.call(this.element[0],(b.currentItem||b.element))){this.isout=1;this.isover=0;this._deactivate.call(this,c)}});return d},drag:function(b,c){if(b.options.refreshPositions){a.ui.ddmanager.prepareOffsets(b,c)}a.each(a.ui.ddmanager.droppables[b.options.scope],function(){if(this.options.disabled||this.greedyChild||!this.visible){return}var e=a.ui.intersect(b,this,this.options.tolerance);var g=!e&&this.isover==1?"isout":(e&&this.isover==0?"isover":null);if(!g){return}var f;if(this.options.greedy){var d=this.element.parents(":data(droppable):eq(0)");if(d.length){f=a.data(d[0],"droppable");f.greedyChild=(g=="isover"?1:0)}}if(f&&g=="isover"){f.isover=0;f.isout=1;f._out.call(f,c)}this[g]=1;this[g=="isout"?"isover":"isout"]=0;this[g=="isover"?"_over":"_out"].call(this,c);if(f&&g=="isout"){f.isout=0;f.isover=1;f._over.call(f,c)}})}}})(jQuery);;(function(c){c.widget("ui.resizable",c.extend({},c.ui.mouse,{_init:function(){var e=this,j=this.options;this.element.addClass("ui-resizable");c.extend(this,{_aspectRatio:!!(j.aspectRatio),aspectRatio:j.aspectRatio,originalElement:this.element,_proportionallyResizeElements:[],_helper:j.helper||j.ghost||j.animate?j.helper||"ui-resizable-helper":null});if(this.element[0].nodeName.match(/canvas|textarea|input|select|button|img/i)){if(/relative/.test(this.element.css("position"))&&c.browser.opera){this.element.css({position:"relative",top:"auto",left:"auto"})}this.element.wrap(c('<div class="ui-wrapper" style="overflow: hidden;"></div>').css({position:this.element.css("position"),width:this.element.outerWidth(),height:this.element.outerHeight(),top:this.element.css("top"),left:this.element.css("left")}));this.element=this.element.parent().data("resizable",this.element.data("resizable"));this.elementIsWrapper=true;this.element.css({marginLeft:this.originalElement.css("marginLeft"),marginTop:this.originalElement.css("marginTop"),marginRight:this.originalElement.css("marginRight"),marginBottom:this.originalElement.css("marginBottom")});this.originalElement.css({marginLeft:0,marginTop:0,marginRight:0,marginBottom:0});this.originalResizeStyle=this.originalElement.css("resize");this.originalElement.css("resize","none");this._proportionallyResizeElements.push(this.originalElement.css({position:"static",zoom:1,display:"block"}));this.originalElement.css({margin:this.originalElement.css("margin")});this._proportionallyResize()}this.handles=j.handles||(!c(".ui-resizable-handle",this.element).length?"e,s,se":{n:".ui-resizable-n",e:".ui-resizable-e",s:".ui-resizable-s",w:".ui-resizable-w",se:".ui-resizable-se",sw:".ui-resizable-sw",ne:".ui-resizable-ne",nw:".ui-resizable-nw"});if(this.handles.constructor==String){if(this.handles=="all"){this.handles="n,e,s,w,se,sw,ne,nw"}var k=this.handles.split(",");this.handles={};for(var f=0;f<k.length;f++){var h=c.trim(k[f]),d="ui-resizable-"+h;var g=c('<div class="ui-resizable-handle '+d+'"></div>');if(/sw|se|ne|nw/.test(h)){g.css({zIndex:++j.zIndex})}if("se"==h){g.addClass("ui-icon ui-icon-gripsmall-diagonal-se")}this.handles[h]=".ui-resizable-"+h;this.element.append(g)}}this._renderAxis=function(p){p=p||this.element;for(var m in this.handles){if(this.handles[m].constructor==String){this.handles[m]=c(this.handles[m],this.element).show()}if(this.elementIsWrapper&&this.originalElement[0].nodeName.match(/textarea|input|select|button/i)){var n=c(this.handles[m],this.element),o=0;o=/sw|ne|nw|se|n|s/.test(m)?n.outerHeight():n.outerWidth();var l=["padding",/ne|nw|n/.test(m)?"Top":/se|sw|s/.test(m)?"Bottom":/^e$/.test(m)?"Right":"Left"].join("");p.css(l,o);this._proportionallyResize()}if(!c(this.handles[m]).length){continue}}};this._renderAxis(this.element);this._handles=c(".ui-resizable-handle",this.element).disableSelection();this._handles.mouseover(function(){if(!e.resizing){if(this.className){var i=this.className.match(/ui-resizable-(se|sw|ne|nw|n|e|s|w)/i)}e.axis=i&&i[1]?i[1]:"se"}});if(j.autoHide){this._handles.hide();c(this.element).addClass("ui-resizable-autohide").hover(function(){c(this).removeClass("ui-resizable-autohide");e._handles.show()},function(){if(!e.resizing){c(this).addClass("ui-resizable-autohide");e._handles.hide()}})}this._mouseInit()},destroy:function(){this._mouseDestroy();var d=function(f){c(f).removeClass("ui-resizable ui-resizable-disabled ui-resizable-resizing").removeData("resizable").unbind(".resizable").find(".ui-resizable-handle").remove()};if(this.elementIsWrapper){d(this.element);var e=this.element;e.parent().append(this.originalElement.css({position:e.css("position"),width:e.outerWidth(),height:e.outerHeight(),top:e.css("top"),left:e.css("left")})).end().remove()}this.originalElement.css("resize",this.originalResizeStyle);d(this.originalElement)},_mouseCapture:function(e){var f=false;for(var d in this.handles){if(c(this.handles[d])[0]==e.target){f=true}}return this.options.disabled||!!f},_mouseStart:function(f){var i=this.options,e=this.element.position(),d=this.element;this.resizing=true;this.documentScroll={top:c(document).scrollTop(),left:c(document).scrollLeft()};if(d.is(".ui-draggable")||(/absolute/).test(d.css("position"))){d.css({position:"absolute",top:e.top,left:e.left})}if(c.browser.opera&&(/relative/).test(d.css("position"))){d.css({position:"relative",top:"auto",left:"auto"})}this._renderProxy();var j=b(this.helper.css("left")),g=b(this.helper.css("top"));if(i.containment){j+=c(i.containment).scrollLeft()||0;g+=c(i.containment).scrollTop()||0}this.offset=this.helper.offset();this.position={left:j,top:g};this.size=this._helper?{width:d.outerWidth(),height:d.outerHeight()}:{width:d.width(),height:d.height()};this.originalSize=this._helper?{width:d.outerWidth(),height:d.outerHeight()}:{width:d.width(),height:d.height()};this.originalPosition={left:j,top:g};this.sizeDiff={width:d.outerWidth()-d.width(),height:d.outerHeight()-d.height()};this.originalMousePosition={left:f.pageX,top:f.pageY};this.aspectRatio=(typeof i.aspectRatio=="number")?i.aspectRatio:((this.originalSize.width/this.originalSize.height)||1);var h=c(".ui-resizable-"+this.axis).css("cursor");c("body").css("cursor",h=="auto"?this.axis+"-resize":h);d.addClass("ui-resizable-resizing");this._propagate("start",f);return true},_mouseDrag:function(d){var g=this.helper,f=this.options,l={},p=this,i=this.originalMousePosition,m=this.axis;var q=(d.pageX-i.left)||0,n=(d.pageY-i.top)||0;var h=this._change[m];if(!h){return false}var k=h.apply(this,[d,q,n]),j=c.browser.msie&&c.browser.version<7,e=this.sizeDiff;if(this._aspectRatio||d.shiftKey){k=this._updateRatio(k,d)}k=this._respectSize(k,d);this._propagate("resize",d);g.css({top:this.position.top+"px",left:this.position.left+"px",width:this.size.width+"px",height:this.size.height+"px"});if(!this._helper&&this._proportionallyResizeElements.length){this._proportionallyResize()}this._updateCache(k);this._trigger("resize",d,this.ui());return false},_mouseStop:function(g){this.resizing=false;var h=this.options,l=this;if(this._helper){var f=this._proportionallyResizeElements,d=f.length&&(/textarea/i).test(f[0].nodeName),e=d&&c.ui.hasScroll(f[0],"left")?0:l.sizeDiff.height,j=d?0:l.sizeDiff.width;var m={width:(l.size.width-j),height:(l.size.height-e)},i=(parseInt(l.element.css("left"),10)+(l.position.left-l.originalPosition.left))||null,k=(parseInt(l.element.css("top"),10)+(l.position.top-l.originalPosition.top))||null;if(!h.animate){this.element.css(c.extend(m,{top:k,left:i}))}l.helper.height(l.size.height);l.helper.width(l.size.width);if(this._helper&&!h.animate){this._proportionallyResize()}}c("body").css("cursor","auto");this.element.removeClass("ui-resizable-resizing");this._propagate("stop",g);if(this._helper){this.helper.remove()}return false},_updateCache:function(d){var e=this.options;this.offset=this.helper.offset();if(a(d.left)){this.position.left=d.left}if(a(d.top)){this.position.top=d.top}if(a(d.height)){this.size.height=d.height}if(a(d.width)){this.size.width=d.width}},_updateRatio:function(g,f){var h=this.options,i=this.position,e=this.size,d=this.axis;if(g.height){g.width=(e.height*this.aspectRatio)}else{if(g.width){g.height=(e.width/this.aspectRatio)}}if(d=="sw"){g.left=i.left+(e.width-g.width);g.top=null}if(d=="nw"){g.top=i.top+(e.height-g.height);g.left=i.left+(e.width-g.width)}return g},_respectSize:function(k,f){var i=this.helper,h=this.options,q=this._aspectRatio||f.shiftKey,p=this.axis,s=a(k.width)&&h.maxWidth&&(h.maxWidth<k.width),l=a(k.height)&&h.maxHeight&&(h.maxHeight<k.height),g=a(k.width)&&h.minWidth&&(h.minWidth>k.width),r=a(k.height)&&h.minHeight&&(h.minHeight>k.height);if(g){k.width=h.minWidth}if(r){k.height=h.minHeight}if(s){k.width=h.maxWidth}if(l){k.height=h.maxHeight}var e=this.originalPosition.left+this.originalSize.width,n=this.position.top+this.size.height;var j=/sw|nw|w/.test(p),d=/nw|ne|n/.test(p);if(g&&j){k.left=e-h.minWidth}if(s&&j){k.left=e-h.maxWidth}if(r&&d){k.top=n-h.minHeight}if(l&&d){k.top=n-h.maxHeight}var m=!k.width&&!k.height;if(m&&!k.left&&k.top){k.top=null}else{if(m&&!k.top&&k.left){k.left=null}}return k},_proportionallyResize:function(){var j=this.options;if(!this._proportionallyResizeElements.length){return}var f=this.helper||this.element;for(var e=0;e<this._proportionallyResizeElements.length;e++){var g=this._proportionallyResizeElements[e];if(!this.borderDif){var d=[g.css("borderTopWidth"),g.css("borderRightWidth"),g.css("borderBottomWidth"),g.css("borderLeftWidth")],h=[g.css("paddingTop"),g.css("paddingRight"),g.css("paddingBottom"),g.css("paddingLeft")];this.borderDif=c.map(d,function(k,m){var l=parseInt(k,10)||0,n=parseInt(h[m],10)||0;return l+n})}if(c.browser.msie&&!(!(c(f).is(":hidden")||c(f).parents(":hidden").length))){continue}g.css({height:(f.height()-this.borderDif[0]-this.borderDif[2])||0,width:(f.width()-this.borderDif[1]-this.borderDif[3])||0})}},_renderProxy:function(){var e=this.element,h=this.options;this.elementOffset=e.offset();if(this._helper){this.helper=this.helper||c('<div style="overflow:hidden;"></div>');var d=c.browser.msie&&c.browser.version<7,f=(d?1:0),g=(d?2:-1);this.helper.addClass(this._helper).css({width:this.element.outerWidth()+g,height:this.element.outerHeight()+g,position:"absolute",left:this.elementOffset.left-f+"px",top:this.elementOffset.top-f+"px",zIndex:++h.zIndex});this.helper.appendTo("body").disableSelection()}else{this.helper=this.element}},_change:{e:function(f,e,d){return{width:this.originalSize.width+e}},w:function(g,e,d){var i=this.options,f=this.originalSize,h=this.originalPosition;return{left:h.left+e,width:f.width-e}},n:function(g,e,d){var i=this.options,f=this.originalSize,h=this.originalPosition;return{top:h.top+d,height:f.height-d}},s:function(f,e,d){return{height:this.originalSize.height+d}},se:function(f,e,d){return c.extend(this._change.s.apply(this,arguments),this._change.e.apply(this,[f,e,d]))},sw:function(f,e,d){return c.extend(this._change.s.apply(this,arguments),this._change.w.apply(this,[f,e,d]))},ne:function(f,e,d){return c.extend(this._change.n.apply(this,arguments),this._change.e.apply(this,[f,e,d]))},nw:function(f,e,d){return c.extend(this._change.n.apply(this,arguments),this._change.w.apply(this,[f,e,d]))}},_propagate:function(e,d){c.ui.plugin.call(this,e,[d,this.ui()]);(e!="resize"&&this._trigger(e,d,this.ui()))},plugins:{},ui:function(){return{originalElement:this.originalElement,element:this.element,helper:this.helper,position:this.position,size:this.size,originalSize:this.originalSize,originalPosition:this.originalPosition}}}));c.extend(c.ui.resizable,{version:"1.7.2",eventPrefix:"resize",defaults:{alsoResize:false,animate:false,animateDuration:"slow",animateEasing:"swing",aspectRatio:false,autoHide:false,cancel:":input,option",containment:false,delay:0,distance:1,ghost:false,grid:false,handles:"e,s,se",helper:false,maxHeight:null,maxWidth:null,minHeight:10,minWidth:10,zIndex:1000}});c.ui.plugin.add("resizable","alsoResize",{start:function(e,f){var d=c(this).data("resizable"),g=d.options;_store=function(h){c(h).each(function(){c(this).data("resizable-alsoresize",{width:parseInt(c(this).width(),10),height:parseInt(c(this).height(),10),left:parseInt(c(this).css("left"),10),top:parseInt(c(this).css("top"),10)})})};if(typeof(g.alsoResize)=="object"&&!g.alsoResize.parentNode){if(g.alsoResize.length){g.alsoResize=g.alsoResize[0];_store(g.alsoResize)}else{c.each(g.alsoResize,function(h,i){_store(h)})}}else{_store(g.alsoResize)}},resize:function(f,h){var e=c(this).data("resizable"),i=e.options,g=e.originalSize,k=e.originalPosition;var j={height:(e.size.height-g.height)||0,width:(e.size.width-g.width)||0,top:(e.position.top-k.top)||0,left:(e.position.left-k.left)||0},d=function(l,m){c(l).each(function(){var p=c(this),q=c(this).data("resizable-alsoresize"),o={},n=m&&m.length?m:["width","height","top","left"];c.each(n||["width","height","top","left"],function(r,t){var s=(q[t]||0)+(j[t]||0);if(s&&s>=0){o[t]=s||null}});if(/relative/.test(p.css("position"))&&c.browser.opera){e._revertToRelativePosition=true;p.css({position:"absolute",top:"auto",left:"auto"})}p.css(o)})};if(typeof(i.alsoResize)=="object"&&!i.alsoResize.nodeType){c.each(i.alsoResize,function(l,m){d(l,m)})}else{d(i.alsoResize)}},stop:function(e,f){var d=c(this).data("resizable");if(d._revertToRelativePosition&&c.browser.opera){d._revertToRelativePosition=false;el.css({position:"relative"})}c(this).removeData("resizable-alsoresize-start")}});c.ui.plugin.add("resizable","animate",{stop:function(h,m){var n=c(this).data("resizable"),i=n.options;var g=n._proportionallyResizeElements,d=g.length&&(/textarea/i).test(g[0].nodeName),e=d&&c.ui.hasScroll(g[0],"left")?0:n.sizeDiff.height,k=d?0:n.sizeDiff.width;var f={width:(n.size.width-k),height:(n.size.height-e)},j=(parseInt(n.element.css("left"),10)+(n.position.left-n.originalPosition.left))||null,l=(parseInt(n.element.css("top"),10)+(n.position.top-n.originalPosition.top))||null;n.element.animate(c.extend(f,l&&j?{top:l,left:j}:{}),{duration:i.animateDuration,easing:i.animateEasing,step:function(){var o={width:parseInt(n.element.css("width"),10),height:parseInt(n.element.css("height"),10),top:parseInt(n.element.css("top"),10),left:parseInt(n.element.css("left"),10)};if(g&&g.length){c(g[0]).css({width:o.width,height:o.height})}n._updateCache(o);n._propagate("resize",h)}})}});c.ui.plugin.add("resizable","containment",{start:function(e,q){var s=c(this).data("resizable"),i=s.options,k=s.element;var f=i.containment,j=(f instanceof c)?f.get(0):(/parent/.test(f))?k.parent().get(0):f;if(!j){return}s.containerElement=c(j);if(/document/.test(f)||f==document){s.containerOffset={left:0,top:0};s.containerPosition={left:0,top:0};s.parentData={element:c(document),left:0,top:0,width:c(document).width(),height:c(document).height()||document.body.parentNode.scrollHeight}}else{var m=c(j),h=[];c(["Top","Right","Left","Bottom"]).each(function(p,o){h[p]=b(m.css("padding"+o))});s.containerOffset=m.offset();s.containerPosition=m.position();s.containerSize={height:(m.innerHeight()-h[3]),width:(m.innerWidth()-h[1])};var n=s.containerOffset,d=s.containerSize.height,l=s.containerSize.width,g=(c.ui.hasScroll(j,"left")?j.scrollWidth:l),r=(c.ui.hasScroll(j)?j.scrollHeight:d);s.parentData={element:j,left:n.left,top:n.top,width:g,height:r}}},resize:function(f,p){var s=c(this).data("resizable"),h=s.options,e=s.containerSize,n=s.containerOffset,l=s.size,m=s.position,q=s._aspectRatio||f.shiftKey,d={top:0,left:0},g=s.containerElement;if(g[0]!=document&&(/static/).test(g.css("position"))){d=n}if(m.left<(s._helper?n.left:0)){s.size.width=s.size.width+(s._helper?(s.position.left-n.left):(s.position.left-d.left));if(q){s.size.height=s.size.width/h.aspectRatio}s.position.left=h.helper?n.left:0}if(m.top<(s._helper?n.top:0)){s.size.height=s.size.height+(s._helper?(s.position.top-n.top):s.position.top);if(q){s.size.width=s.size.height*h.aspectRatio}s.position.top=s._helper?n.top:0}s.offset.left=s.parentData.left+s.position.left;s.offset.top=s.parentData.top+s.position.top;var k=Math.abs((s._helper?s.offset.left-d.left:(s.offset.left-d.left))+s.sizeDiff.width),r=Math.abs((s._helper?s.offset.top-d.top:(s.offset.top-n.top))+s.sizeDiff.height);var j=s.containerElement.get(0)==s.element.parent().get(0),i=/relative|absolute/.test(s.containerElement.css("position"));if(j&&i){k-=s.parentData.left}if(k+s.size.width>=s.parentData.width){s.size.width=s.parentData.width-k;if(q){s.size.height=s.size.width/s.aspectRatio}}if(r+s.size.height>=s.parentData.height){s.size.height=s.parentData.height-r;if(q){s.size.width=s.size.height*s.aspectRatio}}},stop:function(e,m){var p=c(this).data("resizable"),f=p.options,k=p.position,l=p.containerOffset,d=p.containerPosition,g=p.containerElement;var i=c(p.helper),q=i.offset(),n=i.outerWidth()-p.sizeDiff.width,j=i.outerHeight()-p.sizeDiff.height;if(p._helper&&!f.animate&&(/relative/).test(g.css("position"))){c(this).css({left:q.left-d.left-l.left,width:n,height:j})}if(p._helper&&!f.animate&&(/static/).test(g.css("position"))){c(this).css({left:q.left-d.left-l.left,width:n,height:j})}}});c.ui.plugin.add("resizable","ghost",{start:function(f,g){var d=c(this).data("resizable"),h=d.options,e=d.size;d.ghost=d.originalElement.clone();d.ghost.css({opacity:0.25,display:"block",position:"relative",height:e.height,width:e.width,margin:0,left:0,top:0}).addClass("ui-resizable-ghost").addClass(typeof h.ghost=="string"?h.ghost:"");d.ghost.appendTo(d.helper)},resize:function(e,f){var d=c(this).data("resizable"),g=d.options;if(d.ghost){d.ghost.css({position:"relative",height:d.size.height,width:d.size.width})}},stop:function(e,f){var d=c(this).data("resizable"),g=d.options;if(d.ghost&&d.helper){d.helper.get(0).removeChild(d.ghost.get(0))}}});c.ui.plugin.add("resizable","grid",{resize:function(d,l){var n=c(this).data("resizable"),g=n.options,j=n.size,h=n.originalSize,i=n.originalPosition,m=n.axis,k=g._aspectRatio||d.shiftKey;g.grid=typeof g.grid=="number"?[g.grid,g.grid]:g.grid;var f=Math.round((j.width-h.width)/(g.grid[0]||1))*(g.grid[0]||1),e=Math.round((j.height-h.height)/(g.grid[1]||1))*(g.grid[1]||1);if(/^(se|s|e)$/.test(m)){n.size.width=h.width+f;n.size.height=h.height+e}else{if(/^(ne)$/.test(m)){n.size.width=h.width+f;n.size.height=h.height+e;n.position.top=i.top-e}else{if(/^(sw)$/.test(m)){n.size.width=h.width+f;n.size.height=h.height+e;n.position.left=i.left-f}else{n.size.width=h.width+f;n.size.height=h.height+e;n.position.top=i.top-e;n.position.left=i.left-f}}}}});var b=function(d){return parseInt(d,10)||0};var a=function(d){return!isNaN(parseInt(d,10))}})(jQuery);;(function(a){a.widget("ui.selectable",a.extend({},a.ui.mouse,{_init:function(){var b=this;this.element.addClass("ui-selectable");this.dragged=false;var c;this.refresh=function(){c=a(b.options.filter,b.element[0]);c.each(function(){var d=a(this);var e=d.offset();a.data(this,"selectable-item",{element:this,$element:d,left:e.left,top:e.top,right:e.left+d.outerWidth(),bottom:e.top+d.outerHeight(),startselected:false,selected:d.hasClass("ui-selected"),selecting:d.hasClass("ui-selecting"),unselecting:d.hasClass("ui-unselecting")})})};this.refresh();this.selectees=c.addClass("ui-selectee");this._mouseInit();this.helper=a(document.createElement("div")).css({border:"1px dotted black"}).addClass("ui-selectable-helper")},destroy:function(){this.element.removeClass("ui-selectable ui-selectable-disabled").removeData("selectable").unbind(".selectable");this._mouseDestroy()},_mouseStart:function(d){var b=this;this.opos=[d.pageX,d.pageY];if(this.options.disabled){return}var c=this.options;this.selectees=a(c.filter,this.element[0]);this._trigger("start",d);a(c.appendTo).append(this.helper);this.helper.css({"z-index":100,position:"absolute",left:d.clientX,top:d.clientY,width:0,height:0});if(c.autoRefresh){this.refresh()}this.selectees.filter(".ui-selected").each(function(){var e=a.data(this,"selectable-item");e.startselected=true;if(!d.metaKey){e.$element.removeClass("ui-selected");e.selected=false;e.$element.addClass("ui-unselecting");e.unselecting=true;b._trigger("unselecting",d,{unselecting:e.element})}});a(d.target).parents().andSelf().each(function(){var e=a.data(this,"selectable-item");if(e){e.$element.removeClass("ui-unselecting").addClass("ui-selecting");e.unselecting=false;e.selecting=true;e.selected=true;b._trigger("selecting",d,{selecting:e.element});return false}})},_mouseDrag:function(i){var c=this;this.dragged=true;if(this.options.disabled){return}var e=this.options;var d=this.opos[0],h=this.opos[1],b=i.pageX,g=i.pageY;if(d>b){var f=b;b=d;d=f}if(h>g){var f=g;g=h;h=f}this.helper.css({left:d,top:h,width:b-d,height:g-h});this.selectees.each(function(){var j=a.data(this,"selectable-item");if(!j||j.element==c.element[0]){return}var k=false;if(e.tolerance=="touch"){k=(!(j.left>b||j.right<d||j.top>g||j.bottom<h))}else{if(e.tolerance=="fit"){k=(j.left>d&&j.right<b&&j.top>h&&j.bottom<g)}}if(k){if(j.selected){j.$element.removeClass("ui-selected");j.selected=false}if(j.unselecting){j.$element.removeClass("ui-unselecting");j.unselecting=false}if(!j.selecting){j.$element.addClass("ui-selecting");j.selecting=true;c._trigger("selecting",i,{selecting:j.element})}}else{if(j.selecting){if(i.metaKey&&j.startselected){j.$element.removeClass("ui-selecting");j.selecting=false;j.$element.addClass("ui-selected");j.selected=true}else{j.$element.removeClass("ui-selecting");j.selecting=false;if(j.startselected){j.$element.addClass("ui-unselecting");j.unselecting=true}c._trigger("unselecting",i,{unselecting:j.element})}}if(j.selected){if(!i.metaKey&&!j.startselected){j.$element.removeClass("ui-selected");j.selected=false;j.$element.addClass("ui-unselecting");j.unselecting=true;c._trigger("unselecting",i,{unselecting:j.element})}}}});return false},_mouseStop:function(d){var b=this;this.dragged=false;var c=this.options;a(".ui-unselecting",this.element[0]).each(function(){var e=a.data(this,"selectable-item");e.$element.removeClass("ui-unselecting");e.unselecting=false;e.startselected=false;b._trigger("unselected",d,{unselected:e.element})});a(".ui-selecting",this.element[0]).each(function(){var e=a.data(this,"selectable-item");e.$element.removeClass("ui-selecting").addClass("ui-selected");e.selecting=false;e.selected=true;e.startselected=true;b._trigger("selected",d,{selected:e.element})});this._trigger("stop",d);this.helper.remove();return false}}));a.extend(a.ui.selectable,{version:"1.7.2",defaults:{appendTo:"body",autoRefresh:true,cancel:":input,option",delay:0,distance:0,filter:"*",tolerance:"touch"}})})(jQuery);;(function(a){a.widget("ui.sortable",a.extend({},a.ui.mouse,{_init:function(){var b=this.options;this.containerCache={};this.element.addClass("ui-sortable");this.refresh();this.floating=this.items.length?(/left|right/).test(this.items[0].item.css("float")):false;this.offset=this.element.offset();this._mouseInit()},destroy:function(){this.element.removeClass("ui-sortable ui-sortable-disabled").removeData("sortable").unbind(".sortable");this._mouseDestroy();for(var b=this.items.length-1;b>=0;b--){this.items[b].item.removeData("sortable-item")}},_mouseCapture:function(e,f){if(this.reverting){return false}if(this.options.disabled||this.options.type=="static"){return false}this._refreshItems(e);var d=null,c=this,b=a(e.target).parents().each(function(){if(a.data(this,"sortable-item")==c){d=a(this);return false}});if(a.data(e.target,"sortable-item")==c){d=a(e.target)}if(!d){return false}if(this.options.handle&&!f){var g=false;a(this.options.handle,d).find("*").andSelf().each(function(){if(this==e.target){g=true}});if(!g){return false}}this.currentItem=d;this._removeCurrentsFromItems();return true},_mouseStart:function(e,f,b){var g=this.options,c=this;this.currentContainer=this;this.refreshPositions();this.helper=this._createHelper(e);this._cacheHelperProportions();this._cacheMargins();this.scrollParent=this.helper.scrollParent();this.offset=this.currentItem.offset();this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left};this.helper.css("position","absolute");this.cssPosition=this.helper.css("position");a.extend(this.offset,{click:{left:e.pageX-this.offset.left,top:e.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()});this.originalPosition=this._generatePosition(e);this.originalPageX=e.pageX;this.originalPageY=e.pageY;if(g.cursorAt){this._adjustOffsetFromHelper(g.cursorAt)}this.domPosition={prev:this.currentItem.prev()[0],parent:this.currentItem.parent()[0]};if(this.helper[0]!=this.currentItem[0]){this.currentItem.hide()}this._createPlaceholder();if(g.containment){this._setContainment()}if(g.cursor){if(a("body").css("cursor")){this._storedCursor=a("body").css("cursor")}a("body").css("cursor",g.cursor)}if(g.opacity){if(this.helper.css("opacity")){this._storedOpacity=this.helper.css("opacity")}this.helper.css("opacity",g.opacity)}if(g.zIndex){if(this.helper.css("zIndex")){this._storedZIndex=this.helper.css("zIndex")}this.helper.css("zIndex",g.zIndex)}if(this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"){this.overflowOffset=this.scrollParent.offset()}this._trigger("start",e,this._uiHash());if(!this._preserveHelperProportions){this._cacheHelperProportions()}if(!b){for(var d=this.containers.length-1;d>=0;d--){this.containers[d]._trigger("activate",e,c._uiHash(this))}}if(a.ui.ddmanager){a.ui.ddmanager.current=this}if(a.ui.ddmanager&&!g.dropBehaviour){a.ui.ddmanager.prepareOffsets(this,e)}this.dragging=true;this.helper.addClass("ui-sortable-helper");this._mouseDrag(e);return true},_mouseDrag:function(f){this.position=this._generatePosition(f);this.positionAbs=this._convertPositionTo("absolute");if(!this.lastPositionAbs){this.lastPositionAbs=this.positionAbs}if(this.options.scroll){var g=this.options,b=false;if(this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"){if((this.overflowOffset.top+this.scrollParent[0].offsetHeight)-f.pageY<g.scrollSensitivity){this.scrollParent[0].scrollTop=b=this.scrollParent[0].scrollTop+g.scrollSpeed}else{if(f.pageY-this.overflowOffset.top<g.scrollSensitivity){this.scrollParent[0].scrollTop=b=this.scrollParent[0].scrollTop-g.scrollSpeed}}if((this.overflowOffset.left+this.scrollParent[0].offsetWidth)-f.pageX<g.scrollSensitivity){this.scrollParent[0].scrollLeft=b=this.scrollParent[0].scrollLeft+g.scrollSpeed}else{if(f.pageX-this.overflowOffset.left<g.scrollSensitivity){this.scrollParent[0].scrollLeft=b=this.scrollParent[0].scrollLeft-g.scrollSpeed}}}else{if(f.pageY-a(document).scrollTop()<g.scrollSensitivity){b=a(document).scrollTop(a(document).scrollTop()-g.scrollSpeed)}else{if(a(window).height()-(f.pageY-a(document).scrollTop())<g.scrollSensitivity){b=a(document).scrollTop(a(document).scrollTop()+g.scrollSpeed)}}if(f.pageX-a(document).scrollLeft()<g.scrollSensitivity){b=a(document).scrollLeft(a(document).scrollLeft()-g.scrollSpeed)}else{if(a(window).width()-(f.pageX-a(document).scrollLeft())<g.scrollSensitivity){b=a(document).scrollLeft(a(document).scrollLeft()+g.scrollSpeed)}}}if(b!==false&&a.ui.ddmanager&&!g.dropBehaviour){a.ui.ddmanager.prepareOffsets(this,f)}}this.positionAbs=this._convertPositionTo("absolute");if(!this.options.axis||this.options.axis!="y"){this.helper[0].style.left=this.position.left+"px"}if(!this.options.axis||this.options.axis!="x"){this.helper[0].style.top=this.position.top+"px"}for(var d=this.items.length-1;d>=0;d--){var e=this.items[d],c=e.item[0],h=this._intersectsWithPointer(e);if(!h){continue}if(c!=this.currentItem[0]&&this.placeholder[h==1?"next":"prev"]()[0]!=c&&!a.ui.contains(this.placeholder[0],c)&&(this.options.type=="semi-dynamic"?!a.ui.contains(this.element[0],c):true)){this.direction=h==1?"down":"up";if(this.options.tolerance=="pointer"||this._intersectsWithSides(e)){this._rearrange(f,e)}else{break}this._trigger("change",f,this._uiHash());break}}this._contactContainers(f);if(a.ui.ddmanager){a.ui.ddmanager.drag(this,f)}this._trigger("sort",f,this._uiHash());this.lastPositionAbs=this.positionAbs;return false},_mouseStop:function(c,d){if(!c){return}if(a.ui.ddmanager&&!this.options.dropBehaviour){a.ui.ddmanager.drop(this,c)}if(this.options.revert){var b=this;var e=b.placeholder.offset();b.reverting=true;a(this.helper).animate({left:e.left-this.offset.parent.left-b.margins.left+(this.offsetParent[0]==document.body?0:this.offsetParent[0].scrollLeft),top:e.top-this.offset.parent.top-b.margins.top+(this.offsetParent[0]==document.body?0:this.offsetParent[0].scrollTop)},parseInt(this.options.revert,10)||500,function(){b._clear(c)})}else{this._clear(c,d)}return false},cancel:function(){var b=this;if(this.dragging){this._mouseUp();if(this.options.helper=="original"){this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else{this.currentItem.show()}for(var c=this.containers.length-1;c>=0;c--){this.containers[c]._trigger("deactivate",null,b._uiHash(this));if(this.containers[c].containerCache.over){this.containers[c]._trigger("out",null,b._uiHash(this));this.containers[c].containerCache.over=0}}}if(this.placeholder[0].parentNode){this.placeholder[0].parentNode.removeChild(this.placeholder[0])}if(this.options.helper!="original"&&this.helper&&this.helper[0].parentNode){this.helper.remove()}a.extend(this,{helper:null,dragging:false,reverting:false,_noFinalSort:null});if(this.domPosition.prev){a(this.domPosition.prev).after(this.currentItem)}else{a(this.domPosition.parent).prepend(this.currentItem)}return true},serialize:function(d){var b=this._getItemsAsjQuery(d&&d.connected);var c=[];d=d||{};a(b).each(function(){var e=(a(d.item||this).attr(d.attribute||"id")||"").match(d.expression||(/(.+)[-=_](.+)/));if(e){c.push((d.key||e[1]+"[]")+"="+(d.key&&d.expression?e[1]:e[2]))}});return c.join("&")},toArray:function(d){var b=this._getItemsAsjQuery(d&&d.connected);var c=[];d=d||{};b.each(function(){c.push(a(d.item||this).attr(d.attribute||"id")||"")});return c},_intersectsWith:function(m){var e=this.positionAbs.left,d=e+this.helperProportions.width,k=this.positionAbs.top,j=k+this.helperProportions.height;var f=m.left,c=f+m.width,n=m.top,i=n+m.height;var o=this.offset.click.top,h=this.offset.click.left;var g=(k+o)>n&&(k+o)<i&&(e+h)>f&&(e+h)<c;if(this.options.tolerance=="pointer"||this.options.forcePointerForContainers||(this.options.tolerance!="pointer"&&this.helperProportions[this.floating?"width":"height"]>m[this.floating?"width":"height"])){return g}else{return(f<e+(this.helperProportions.width/2)&&d-(this.helperProportions.width/2)<c&&n<k+(this.helperProportions.height/2)&&j-(this.helperProportions.height/2)<i)}},_intersectsWithPointer:function(d){var e=a.ui.isOverAxis(this.positionAbs.top+this.offset.click.top,d.top,d.height),c=a.ui.isOverAxis(this.positionAbs.left+this.offset.click.left,d.left,d.width),g=e&&c,b=this._getDragVerticalDirection(),f=this._getDragHorizontalDirection();if(!g){return false}return this.floating?(((f&&f=="right")||b=="down")?2:1):(b&&(b=="down"?2:1))},_intersectsWithSides:function(e){var c=a.ui.isOverAxis(this.positionAbs.top+this.offset.click.top,e.top+(e.height/2),e.height),d=a.ui.isOverAxis(this.positionAbs.left+this.offset.click.left,e.left+(e.width/2),e.width),b=this._getDragVerticalDirection(),f=this._getDragHorizontalDirection();if(this.floating&&f){return((f=="right"&&d)||(f=="left"&&!d))}else{return b&&((b=="down"&&c)||(b=="up"&&!c))}},_getDragVerticalDirection:function(){var b=this.positionAbs.top-this.lastPositionAbs.top;return b!=0&&(b>0?"down":"up")},_getDragHorizontalDirection:function(){var b=this.positionAbs.left-this.lastPositionAbs.left;return b!=0&&(b>0?"right":"left")},refresh:function(b){this._refreshItems(b);this.refreshPositions()},_connectWith:function(){var b=this.options;return b.connectWith.constructor==String?[b.connectWith]:b.connectWith},_getItemsAsjQuery:function(b){var l=this;var g=[];var e=[];var h=this._connectWith();if(h&&b){for(var d=h.length-1;d>=0;d--){var k=a(h[d]);for(var c=k.length-1;c>=0;c--){var f=a.data(k[c],"sortable");if(f&&f!=this&&!f.options.disabled){e.push([a.isFunction(f.options.items)?f.options.items.call(f.element):a(f.options.items,f.element).not(".ui-sortable-helper"),f])}}}}e.push([a.isFunction(this.options.items)?this.options.items.call(this.element,null,{options:this.options,item:this.currentItem}):a(this.options.items,this.element).not(".ui-sortable-helper"),this]);for(var d=e.length-1;d>=0;d--){e[d][0].each(function(){g.push(this)})}return a(g)},_removeCurrentsFromItems:function(){var d=this.currentItem.find(":data(sortable-item)");for(var c=0;c<this.items.length;c++){for(var b=0;b<d.length;b++){if(d[b]==this.items[c].item[0]){this.items.splice(c,1)}}}},_refreshItems:function(b){this.items=[];this.containers=[this];var h=this.items;var p=this;var f=[[a.isFunction(this.options.items)?this.options.items.call(this.element[0],b,{item:this.currentItem}):a(this.options.items,this.element),this]];var l=this._connectWith();if(l){for(var e=l.length-1;e>=0;e--){var m=a(l[e]);for(var d=m.length-1;d>=0;d--){var g=a.data(m[d],"sortable");if(g&&g!=this&&!g.options.disabled){f.push([a.isFunction(g.options.items)?g.options.items.call(g.element[0],b,{item:this.currentItem}):a(g.options.items,g.element),g]);this.containers.push(g)}}}}for(var e=f.length-1;e>=0;e--){var k=f[e][1];var c=f[e][0];for(var d=0,n=c.length;d<n;d++){var o=a(c[d]);o.data("sortable-item",k);h.push({item:o,instance:k,width:0,height:0,left:0,top:0})}}},refreshPositions:function(b){if(this.offsetParent&&this.helper){this.offset.parent=this._getParentOffset()}for(var d=this.items.length-1;d>=0;d--){var e=this.items[d];if(e.instance!=this.currentContainer&&this.currentContainer&&e.item[0]!=this.currentItem[0]){continue}var c=this.options.toleranceElement?a(this.options.toleranceElement,e.item):e.item;if(!b){e.width=c.outerWidth();e.height=c.outerHeight()}var f=c.offset();e.left=f.left;e.top=f.top}if(this.options.custom&&this.options.custom.refreshContainers){this.options.custom.refreshContainers.call(this)}else{for(var d=this.containers.length-1;d>=0;d--){var f=this.containers[d].element.offset();this.containers[d].containerCache.left=f.left;this.containers[d].containerCache.top=f.top;this.containers[d].containerCache.width=this.containers[d].element.outerWidth();this.containers[d].containerCache.height=this.containers[d].element.outerHeight()}}},_createPlaceholder:function(d){var b=d||this,e=b.options;if(!e.placeholder||e.placeholder.constructor==String){var c=e.placeholder;e.placeholder={element:function(){var f=a(document.createElement(b.currentItem[0].nodeName)).addClass(c||b.currentItem[0].className+" ui-sortable-placeholder").removeClass("ui-sortable-helper")[0];if(!c){f.style.visibility="hidden"}return f},update:function(f,g){if(c&&!e.forcePlaceholderSize){return}if(!g.height()){g.height(b.currentItem.innerHeight()-parseInt(b.currentItem.css("paddingTop")||0,10)-parseInt(b.currentItem.css("paddingBottom")||0,10))}if(!g.width()){g.width(b.currentItem.innerWidth()-parseInt(b.currentItem.css("paddingLeft")||0,10)-parseInt(b.currentItem.css("paddingRight")||0,10))}}}}b.placeholder=a(e.placeholder.element.call(b.element,b.currentItem));b.currentItem.after(b.placeholder);e.placeholder.update(b,b.placeholder)},_contactContainers:function(d){for(var c=this.containers.length-1;c>=0;c--){if(this._intersectsWith(this.containers[c].containerCache)){if(!this.containers[c].containerCache.over){if(this.currentContainer!=this.containers[c]){var h=10000;var g=null;var e=this.positionAbs[this.containers[c].floating?"left":"top"];for(var b=this.items.length-1;b>=0;b--){if(!a.ui.contains(this.containers[c].element[0],this.items[b].item[0])){continue}var f=this.items[b][this.containers[c].floating?"left":"top"];if(Math.abs(f-e)<h){h=Math.abs(f-e);g=this.items[b]}}if(!g&&!this.options.dropOnEmpty){continue}this.currentContainer=this.containers[c];g?this._rearrange(d,g,null,true):this._rearrange(d,null,this.containers[c].element,true);this._trigger("change",d,this._uiHash());this.containers[c]._trigger("change",d,this._uiHash(this));this.options.placeholder.update(this.currentContainer,this.placeholder)}this.containers[c]._trigger("over",d,this._uiHash(this));this.containers[c].containerCache.over=1}}else{if(this.containers[c].containerCache.over){this.containers[c]._trigger("out",d,this._uiHash(this));this.containers[c].containerCache.over=0}}}},_createHelper:function(c){var d=this.options;var b=a.isFunction(d.helper)?a(d.helper.apply(this.element[0],[c,this.currentItem])):(d.helper=="clone"?this.currentItem.clone():this.currentItem);if(!b.parents("body").length){a(d.appendTo!="parent"?d.appendTo:this.currentItem[0].parentNode)[0].appendChild(b[0])}if(b[0]==this.currentItem[0]){this._storedCSS={width:this.currentItem[0].style.width,height:this.currentItem[0].style.height,position:this.currentItem.css("position"),top:this.currentItem.css("top"),left:this.currentItem.css("left")}}if(b[0].style.width==""||d.forceHelperSize){b.width(this.currentItem.width())}if(b[0].style.height==""||d.forceHelperSize){b.height(this.currentItem.height())}return b},_adjustOffsetFromHelper:function(b){if(b.left!=undefined){this.offset.click.left=b.left+this.margins.left}if(b.right!=undefined){this.offset.click.left=this.helperProportions.width-b.right+this.margins.left}if(b.top!=undefined){this.offset.click.top=b.top+this.margins.top}if(b.bottom!=undefined){this.offset.click.top=this.helperProportions.height-b.bottom+this.margins.top}},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var b=this.offsetParent.offset();if(this.cssPosition=="absolute"&&this.scrollParent[0]!=document&&a.ui.contains(this.scrollParent[0],this.offsetParent[0])){b.left+=this.scrollParent.scrollLeft();b.top+=this.scrollParent.scrollTop()}if((this.offsetParent[0]==document.body)||(this.offsetParent[0].tagName&&this.offsetParent[0].tagName.toLowerCase()=="html"&&a.browser.msie)){b={top:0,left:0}}return{top:b.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:b.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if(this.cssPosition=="relative"){var b=this.currentItem.position();return{top:b.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:b.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}else{return{top:0,left:0}}},_cacheMargins:function(){this.margins={left:(parseInt(this.currentItem.css("marginLeft"),10)||0),top:(parseInt(this.currentItem.css("marginTop"),10)||0)}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var e=this.options;if(e.containment=="parent"){e.containment=this.helper[0].parentNode}if(e.containment=="document"||e.containment=="window"){this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,a(e.containment=="document"?document:window).width()-this.helperProportions.width-this.margins.left,(a(e.containment=="document"?document:window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]}if(!(/^(document|window|parent)$/).test(e.containment)){var c=a(e.containment)[0];var d=a(e.containment).offset();var b=(a(c).css("overflow")!="hidden");this.containment=[d.left+(parseInt(a(c).css("borderLeftWidth"),10)||0)+(parseInt(a(c).css("paddingLeft"),10)||0)-this.margins.left,d.top+(parseInt(a(c).css("borderTopWidth"),10)||0)+(parseInt(a(c).css("paddingTop"),10)||0)-this.margins.top,d.left+(b?Math.max(c.scrollWidth,c.offsetWidth):c.offsetWidth)-(parseInt(a(c).css("borderLeftWidth"),10)||0)-(parseInt(a(c).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,d.top+(b?Math.max(c.scrollHeight,c.offsetHeight):c.offsetHeight)-(parseInt(a(c).css("borderTopWidth"),10)||0)-(parseInt(a(c).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top]}},_convertPositionTo:function(f,h){if(!h){h=this.position}var c=f=="absolute"?1:-1;var e=this.options,b=this.cssPosition=="absolute"&&!(this.scrollParent[0]!=document&&a.ui.contains(this.scrollParent[0],this.offsetParent[0]))?this.offsetParent:this.scrollParent,g=(/(html|body)/i).test(b[0].tagName);return{top:(h.top+this.offset.relative.top*c+this.offset.parent.top*c-(a.browser.safari&&this.cssPosition=="fixed"?0:(this.cssPosition=="fixed"?-this.scrollParent.scrollTop():(g?0:b.scrollTop()))*c)),left:(h.left+this.offset.relative.left*c+this.offset.parent.left*c-(a.browser.safari&&this.cssPosition=="fixed"?0:(this.cssPosition=="fixed"?-this.scrollParent.scrollLeft():g?0:b.scrollLeft())*c))}},_generatePosition:function(e){var h=this.options,b=this.cssPosition=="absolute"&&!(this.scrollParent[0]!=document&&a.ui.contains(this.scrollParent[0],this.offsetParent[0]))?this.offsetParent:this.scrollParent,i=(/(html|body)/i).test(b[0].tagName);if(this.cssPosition=="relative"&&!(this.scrollParent[0]!=document&&this.scrollParent[0]!=this.offsetParent[0])){this.offset.relative=this._getRelativeOffset()}var d=e.pageX;var c=e.pageY;if(this.originalPosition){if(this.containment){if(e.pageX-this.offset.click.left<this.containment[0]){d=this.containment[0]+this.offset.click.left}if(e.pageY-this.offset.click.top<this.containment[1]){c=this.containment[1]+this.offset.click.top}if(e.pageX-this.offset.click.left>this.containment[2]){d=this.containment[2]+this.offset.click.left}if(e.pageY-this.offset.click.top>this.containment[3]){c=this.containment[3]+this.offset.click.top}}if(h.grid){var g=this.originalPageY+Math.round((c-this.originalPageY)/h.grid[1])*h.grid[1];c=this.containment?(!(g-this.offset.click.top<this.containment[1]||g-this.offset.click.top>this.containment[3])?g:(!(g-this.offset.click.top<this.containment[1])?g-h.grid[1]:g+h.grid[1])):g;var f=this.originalPageX+Math.round((d-this.originalPageX)/h.grid[0])*h.grid[0];d=this.containment?(!(f-this.offset.click.left<this.containment[0]||f-this.offset.click.left>this.containment[2])?f:(!(f-this.offset.click.left<this.containment[0])?f-h.grid[0]:f+h.grid[0])):f}}return{top:(c-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+(a.browser.safari&&this.cssPosition=="fixed"?0:(this.cssPosition=="fixed"?-this.scrollParent.scrollTop():(i?0:b.scrollTop())))),left:(d-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+(a.browser.safari&&this.cssPosition=="fixed"?0:(this.cssPosition=="fixed"?-this.scrollParent.scrollLeft():i?0:b.scrollLeft())))}},_rearrange:function(g,f,c,e){c?c[0].appendChild(this.placeholder[0]):f.item[0].parentNode.insertBefore(this.placeholder[0],(this.direction=="down"?f.item[0]:f.item[0].nextSibling));this.counter=this.counter?++this.counter:1;var d=this,b=this.counter;window.setTimeout(function(){if(b==d.counter){d.refreshPositions(!e)}},0)},_clear:function(d,e){this.reverting=false;var f=[],b=this;if(!this._noFinalSort&&this.currentItem[0].parentNode){this.placeholder.before(this.currentItem)}this._noFinalSort=null;if(this.helper[0]==this.currentItem[0]){for(var c in this._storedCSS){if(this._storedCSS[c]=="auto"||this._storedCSS[c]=="static"){this._storedCSS[c]=""}}this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else{this.currentItem.show()}if(this.fromOutside&&!e){f.push(function(g){this._trigger("receive",g,this._uiHash(this.fromOutside))})}if((this.fromOutside||this.domPosition.prev!=this.currentItem.prev().not(".ui-sortable-helper")[0]||this.domPosition.parent!=this.currentItem.parent()[0])&&!e){f.push(function(g){this._trigger("update",g,this._uiHash())})}if(!a.ui.contains(this.element[0],this.currentItem[0])){if(!e){f.push(function(g){this._trigger("remove",g,this._uiHash())})}for(var c=this.containers.length-1;c>=0;c--){if(a.ui.contains(this.containers[c].element[0],this.currentItem[0])&&!e){f.push((function(g){return function(h){g._trigger("receive",h,this._uiHash(this))}}).call(this,this.containers[c]));f.push((function(g){return function(h){g._trigger("update",h,this._uiHash(this))}}).call(this,this.containers[c]))}}}for(var c=this.containers.length-1;c>=0;c--){if(!e){f.push((function(g){return function(h){g._trigger("deactivate",h,this._uiHash(this))}}).call(this,this.containers[c]))}if(this.containers[c].containerCache.over){f.push((function(g){return function(h){g._trigger("out",h,this._uiHash(this))}}).call(this,this.containers[c]));this.containers[c].containerCache.over=0}}if(this._storedCursor){a("body").css("cursor",this._storedCursor)}if(this._storedOpacity){this.helper.css("opacity",this._storedOpacity)}if(this._storedZIndex){this.helper.css("zIndex",this._storedZIndex=="auto"?"":this._storedZIndex)}this.dragging=false;if(this.cancelHelperRemoval){if(!e){this._trigger("beforeStop",d,this._uiHash());for(var c=0;c<f.length;c++){f[c].call(this,d)}this._trigger("stop",d,this._uiHash())}return false}if(!e){this._trigger("beforeStop",d,this._uiHash())}this.placeholder[0].parentNode.removeChild(this.placeholder[0]);if(this.helper[0]!=this.currentItem[0]){this.helper.remove()}this.helper=null;if(!e){for(var c=0;c<f.length;c++){f[c].call(this,d)}this._trigger("stop",d,this._uiHash())}this.fromOutside=false;return true},_trigger:function(){if(a.widget.prototype._trigger.apply(this,arguments)===false){this.cancel()}},_uiHash:function(c){var b=c||this;return{helper:b.helper,placeholder:b.placeholder||a([]),position:b.position,absolutePosition:b.positionAbs,offset:b.positionAbs,item:b.currentItem,sender:c?c.element:null}}}));a.extend(a.ui.sortable,{getter:"serialize toArray",version:"1.7.2",eventPrefix:"sort",defaults:{appendTo:"parent",axis:false,cancel:":input,option",connectWith:false,containment:false,cursor:"auto",cursorAt:false,delay:0,distance:1,dropOnEmpty:true,forcePlaceholderSize:false,forceHelperSize:false,grid:false,handle:false,helper:"original",items:"> *",opacity:false,placeholder:false,revert:false,scroll:true,scrollSensitivity:20,scrollSpeed:20,scope:"default",tolerance:"intersect",zIndex:1000}})})(jQuery);;(function(c){var b={dragStart:"start.draggable",drag:"drag.draggable",dragStop:"stop.draggable",maxHeight:"maxHeight.resizable",minHeight:"minHeight.resizable",maxWidth:"maxWidth.resizable",minWidth:"minWidth.resizable",resizeStart:"start.resizable",resize:"drag.resizable",resizeStop:"stop.resizable"},a="ui-dialog ui-widget ui-widget-content ui-corner-all ";c.widget("ui.dialog",{_init:function(){this.originalTitle=this.element.attr("title");var l=this,m=this.options,j=m.title||this.originalTitle||"&nbsp;",e=c.ui.dialog.getTitleId(this.element),k=(this.uiDialog=c("<div/>")).appendTo(document.body).hide().addClass(a+m.dialogClass).css({position:"absolute",overflow:"hidden",zIndex:m.zIndex}).attr("tabIndex",-1).css("outline",0).keydown(function(n){(m.closeOnEscape&&n.keyCode&&n.keyCode==c.ui.keyCode.ESCAPE&&l.close(n))}).attr({role:"dialog","aria-labelledby":e}).mousedown(function(n){l.moveToTop(false,n)}),g=this.element.show().removeAttr("title").addClass("ui-dialog-content ui-widget-content").appendTo(k),f=(this.uiDialogTitlebar=c("<div></div>")).addClass("ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix").prependTo(k),i=c('<a href="#"/>').addClass("ui-dialog-titlebar-close ui-corner-all").attr("role","button").hover(function(){i.addClass("ui-state-hover")},function(){i.removeClass("ui-state-hover")}).focus(function(){i.addClass("ui-state-focus")}).blur(function(){i.removeClass("ui-state-focus")}).mousedown(function(n){n.stopPropagation()}).click(function(n){l.close(n);return false}).appendTo(f),h=(this.uiDialogTitlebarCloseText=c("<span/>")).addClass("ui-icon ui-icon-closethick").text(m.closeText).appendTo(i),d=c("<span/>").addClass("ui-dialog-title").attr("id",e).html(j).prependTo(f);f.find("*").add(f).disableSelection();(m.draggable&&c.fn.draggable&&this._makeDraggable());(m.resizable&&c.fn.resizable&&this._makeResizable());this._createButtons(m.buttons);this._isOpen=false;(m.bgiframe&&c.fn.bgiframe&&k.bgiframe());(m.autoOpen&&this.open())},destroy:function(){(this.overlay&&this.overlay.destroy());this.uiDialog.hide();this.element.unbind(".dialog").removeData("dialog").removeClass("ui-dialog-content ui-widget-content").hide().appendTo("body");this.uiDialog.remove();(this.originalTitle&&this.element.attr("title",this.originalTitle))},close:function(f){var d=this;if(false===d._trigger("beforeclose",f)){return}(d.overlay&&d.overlay.destroy());d.uiDialog.unbind("keypress.ui-dialog");(d.options.hide?d.uiDialog.hide(d.options.hide,function(){d._trigger("close",f)}):d.uiDialog.hide()&&d._trigger("close",f));c.ui.dialog.overlay.resize();d._isOpen=false;if(d.options.modal){var e=0;c(".ui-dialog").each(function(){if(this!=d.uiDialog[0]){e=Math.max(e,c(this).css("z-index"))}});c.ui.dialog.maxZ=e}},isOpen:function(){return this._isOpen},moveToTop:function(f,e){if((this.options.modal&&!f)||(!this.options.stack&&!this.options.modal)){return this._trigger("focus",e)}if(this.options.zIndex>c.ui.dialog.maxZ){c.ui.dialog.maxZ=this.options.zIndex}(this.overlay&&this.overlay.$el.css("z-index",c.ui.dialog.overlay.maxZ=++c.ui.dialog.maxZ));var d={scrollTop:this.element.attr("scrollTop"),scrollLeft:this.element.attr("scrollLeft")};this.uiDialog.css("z-index",++c.ui.dialog.maxZ);this.element.attr(d);this._trigger("focus",e)},open:function(){if(this._isOpen){return}var e=this.options,d=this.uiDialog;this.overlay=e.modal?new c.ui.dialog.overlay(this):null;(d.next().length&&d.appendTo("body"));this._size();this._position(e.position);d.show(e.show);this.moveToTop(true);(e.modal&&d.bind("keypress.ui-dialog",function(h){if(h.keyCode!=c.ui.keyCode.TAB){return}var g=c(":tabbable",this),i=g.filter(":first")[0],f=g.filter(":last")[0];if(h.target==f&&!h.shiftKey){setTimeout(function(){i.focus()},1)}else{if(h.target==i&&h.shiftKey){setTimeout(function(){f.focus()},1)}}}));c([]).add(d.find(".ui-dialog-content :tabbable:first")).add(d.find(".ui-dialog-buttonpane :tabbable:first")).add(d).filter(":first").focus();this._trigger("open");this._isOpen=true},_createButtons:function(g){var f=this,d=false,e=c("<div></div>").addClass("ui-dialog-buttonpane ui-widget-content ui-helper-clearfix");this.uiDialog.find(".ui-dialog-buttonpane").remove();(typeof g=="object"&&g!==null&&c.each(g,function(){return!(d=true)}));if(d){c.each(g,function(h,i){c('<button type="button"></button>').addClass("ui-state-default ui-corner-all").text(h).click(function(){i.apply(f.element[0],arguments)}).hover(function(){c(this).addClass("ui-state-hover")},function(){c(this).removeClass("ui-state-hover")}).focus(function(){c(this).addClass("ui-state-focus")}).blur(function(){c(this).removeClass("ui-state-focus")}).appendTo(e)});e.appendTo(this.uiDialog)}},_makeDraggable:function(){var d=this,f=this.options,e;this.uiDialog.draggable({cancel:".ui-dialog-content",handle:".ui-dialog-titlebar",containment:"document",start:function(){e=f.height;c(this).height(c(this).height()).addClass("ui-dialog-dragging");(f.dragStart&&f.dragStart.apply(d.element[0],arguments))},drag:function(){(f.drag&&f.drag.apply(d.element[0],arguments))},stop:function(){c(this).removeClass("ui-dialog-dragging").height(e);(f.dragStop&&f.dragStop.apply(d.element[0],arguments));c.ui.dialog.overlay.resize()}})},_makeResizable:function(g){g=(g===undefined?this.options.resizable:g);var d=this,f=this.options,e=typeof g=="string"?g:"n,e,s,w,se,sw,ne,nw";this.uiDialog.resizable({cancel:".ui-dialog-content",alsoResize:this.element,maxWidth:f.maxWidth,maxHeight:f.maxHeight,minWidth:f.minWidth,minHeight:f.minHeight,start:function(){c(this).addClass("ui-dialog-resizing");(f.resizeStart&&f.resizeStart.apply(d.element[0],arguments))},resize:function(){(f.resize&&f.resize.apply(d.element[0],arguments))},handles:e,stop:function(){c(this).removeClass("ui-dialog-resizing");f.height=c(this).height();f.width=c(this).width();(f.resizeStop&&f.resizeStop.apply(d.element[0],arguments));c.ui.dialog.overlay.resize()}}).find(".ui-resizable-se").addClass("ui-icon ui-icon-grip-diagonal-se")},_position:function(i){var e=c(window),f=c(document),g=f.scrollTop(),d=f.scrollLeft(),h=g;if(c.inArray(i,["center","top","right","bottom","left"])>=0){i=[i=="right"||i=="left"?i:"center",i=="top"||i=="bottom"?i:"middle"]}if(i.constructor!=Array){i=["center","middle"]}if(i[0].constructor==Number){d+=i[0]}else{switch(i[0]){case"left":d+=0;break;case"right":d+=e.width()-this.uiDialog.outerWidth();break;default:case"center":d+=(e.width()-this.uiDialog.outerWidth())/2}}if(i[1].constructor==Number){g+=i[1]}else{switch(i[1]){case"top":g+=0;break;case"bottom":g+=e.height()-this.uiDialog.outerHeight();break;default:case"middle":g+=(e.height()-this.uiDialog.outerHeight())/2}}g=Math.max(g,h);this.uiDialog.css({top:g,left:d})},_setData:function(e,f){(b[e]&&this.uiDialog.data(b[e],f));switch(e){case"buttons":this._createButtons(f);break;case"closeText":this.uiDialogTitlebarCloseText.text(f);break;case"dialogClass":this.uiDialog.removeClass(this.options.dialogClass).addClass(a+f);break;case"draggable":(f?this._makeDraggable():this.uiDialog.draggable("destroy"));break;case"height":this.uiDialog.height(f);break;case"position":this._position(f);break;case"resizable":var d=this.uiDialog,g=this.uiDialog.is(":data(resizable)");(g&&!f&&d.resizable("destroy"));(g&&typeof f=="string"&&d.resizable("option","handles",f));(g||this._makeResizable(f));break;case"title":c(".ui-dialog-title",this.uiDialogTitlebar).html(f||"&nbsp;");break;case"width":this.uiDialog.width(f);break}c.widget.prototype._setData.apply(this,arguments)},_size:function(){var e=this.options;this.element.css({height:0,minHeight:0,width:"auto"});var d=this.uiDialog.css({height:"auto",width:e.width}).height();this.element.css({minHeight:Math.max(e.minHeight-d,0),height:e.height=="auto"?"auto":Math.max(e.height-d,0)})}});c.extend(c.ui.dialog,{version:"1.7.2",defaults:{autoOpen:true,bgiframe:false,buttons:{},closeOnEscape:true,closeText:"close",dialogClass:"",draggable:true,hide:null,height:"auto",maxHeight:false,maxWidth:false,minHeight:150,minWidth:150,modal:false,position:"center",resizable:true,show:null,stack:true,title:"",width:300,zIndex:1000},getter:"isOpen",uuid:0,maxZ:0,getTitleId:function(d){return"ui-dialog-title-"+(d.attr("id")||++this.uuid)},overlay:function(d){this.$el=c.ui.dialog.overlay.create(d)}});c.extend(c.ui.dialog.overlay,{instances:[],maxZ:0,events:c.map("focus,mousedown,mouseup,keydown,keypress,click".split(","),function(d){return d+".dialog-overlay"}).join(" "),create:function(e){if(this.instances.length===0){setTimeout(function(){if(c.ui.dialog.overlay.instances.length){c(document).bind(c.ui.dialog.overlay.events,function(f){var g=c(f.target).parents(".ui-dialog").css("zIndex")||0;return(g>c.ui.dialog.overlay.maxZ)})}},1);c(document).bind("keydown.dialog-overlay",function(f){(e.options.closeOnEscape&&f.keyCode&&f.keyCode==c.ui.keyCode.ESCAPE&&e.close(f))});c(window).bind("resize.dialog-overlay",c.ui.dialog.overlay.resize)}var d=c("<div></div>").appendTo(document.body).addClass("ui-widget-overlay").css({width:this.width(),height:this.height()});(e.options.bgiframe&&c.fn.bgiframe&&d.bgiframe());this.instances.push(d);return d},destroy:function(d){this.instances.splice(c.inArray(this.instances,d),1);if(this.instances.length===0){c([document,window]).unbind(".dialog-overlay")}d.remove();var e=0;c.each(this.instances,function(){e=Math.max(e,this.css("z-index"))});this.maxZ=e},height:function(){if(c.browser.msie&&c.browser.version<7){var e=Math.max(document.documentElement.scrollHeight,document.body.scrollHeight);var d=Math.max(document.documentElement.offsetHeight,document.body.offsetHeight);if(e<d){return c(window).height()+"px"}else{return e+"px"}}else{return c(document).height()+"px"}},width:function(){if(c.browser.msie&&c.browser.version<7){var d=Math.max(document.documentElement.scrollWidth,document.body.scrollWidth);var e=Math.max(document.documentElement.offsetWidth,document.body.offsetWidth);if(d<e){return c(window).width()+"px"}else{return d+"px"}}else{return c(document).width()+"px"}},resize:function(){var d=c([]);c.each(c.ui.dialog.overlay.instances,function(){d=d.add(this)});d.css({width:0,height:0}).css({width:c.ui.dialog.overlay.width(),height:c.ui.dialog.overlay.height()})}});c.extend(c.ui.dialog.overlay.prototype,{destroy:function(){c.ui.dialog.overlay.destroy(this.$el)}})})(jQuery);;(function(a){a.widget("ui.slider",a.extend({},a.ui.mouse,{_init:function(){var b=this,c=this.options;this._keySliding=false;this._handleIndex=null;this._detectOrientation();this._mouseInit();this.element.addClass("ui-slider ui-slider-"+this.orientation+" ui-widget ui-widget-content ui-corner-all");this.range=a([]);if(c.range){if(c.range===true){this.range=a("<div></div>");if(!c.values){c.values=[this._valueMin(),this._valueMin()]}if(c.values.length&&c.values.length!=2){c.values=[c.values[0],c.values[0]]}}else{this.range=a("<div></div>")}this.range.appendTo(this.element).addClass("ui-slider-range");if(c.range=="min"||c.range=="max"){this.range.addClass("ui-slider-range-"+c.range)}this.range.addClass("ui-widget-header")}if(a(".ui-slider-handle",this.element).length==0){a('<a href="#"></a>').appendTo(this.element).addClass("ui-slider-handle")}if(c.values&&c.values.length){while(a(".ui-slider-handle",this.element).length<c.values.length){a('<a href="#"></a>').appendTo(this.element).addClass("ui-slider-handle")}}this.handles=a(".ui-slider-handle",this.element).addClass("ui-state-default ui-corner-all");this.handle=this.handles.eq(0);this.handles.add(this.range).filter("a").click(function(d){d.preventDefault()}).hover(function(){if(!c.disabled){a(this).addClass("ui-state-hover")}},function(){a(this).removeClass("ui-state-hover")}).focus(function(){if(!c.disabled){a(".ui-slider .ui-state-focus").removeClass("ui-state-focus");a(this).addClass("ui-state-focus")}else{a(this).blur()}}).blur(function(){a(this).removeClass("ui-state-focus")});this.handles.each(function(d){a(this).data("index.ui-slider-handle",d)});this.handles.keydown(function(i){var f=true;var e=a(this).data("index.ui-slider-handle");if(b.options.disabled){return}switch(i.keyCode){case a.ui.keyCode.HOME:case a.ui.keyCode.END:case a.ui.keyCode.UP:case a.ui.keyCode.RIGHT:case a.ui.keyCode.DOWN:case a.ui.keyCode.LEFT:f=false;if(!b._keySliding){b._keySliding=true;a(this).addClass("ui-state-active");b._start(i,e)}break}var g,d,h=b._step();if(b.options.values&&b.options.values.length){g=d=b.values(e)}else{g=d=b.value()}switch(i.keyCode){case a.ui.keyCode.HOME:d=b._valueMin();break;case a.ui.keyCode.END:d=b._valueMax();break;case a.ui.keyCode.UP:case a.ui.keyCode.RIGHT:if(g==b._valueMax()){return}d=g+h;break;case a.ui.keyCode.DOWN:case a.ui.keyCode.LEFT:if(g==b._valueMin()){return}d=g-h;break}b._slide(i,e,d);return f}).keyup(function(e){var d=a(this).data("index.ui-slider-handle");if(b._keySliding){b._stop(e,d);b._change(e,d);b._keySliding=false;a(this).removeClass("ui-state-active")}});this._refreshValue()},destroy:function(){this.handles.remove();this.range.remove();this.element.removeClass("ui-slider ui-slider-horizontal ui-slider-vertical ui-slider-disabled ui-widget ui-widget-content ui-corner-all").removeData("slider").unbind(".slider");this._mouseDestroy()},_mouseCapture:function(d){var e=this.options;if(e.disabled){return false}this.elementSize={width:this.element.outerWidth(),height:this.element.outerHeight()};this.elementOffset=this.element.offset();var h={x:d.pageX,y:d.pageY};var j=this._normValueFromMouse(h);var c=this._valueMax()-this._valueMin()+1,f;var k=this,i;this.handles.each(function(l){var m=Math.abs(j-k.values(l));if(c>m){c=m;f=a(this);i=l}});if(e.range==true&&this.values(1)==e.min){f=a(this.handles[++i])}this._start(d,i);k._handleIndex=i;f.addClass("ui-state-active").focus();var g=f.offset();var b=!a(d.target).parents().andSelf().is(".ui-slider-handle");this._clickOffset=b?{left:0,top:0}:{left:d.pageX-g.left-(f.width()/2),top:d.pageY-g.top-(f.height()/2)-(parseInt(f.css("borderTopWidth"),10)||0)-(parseInt(f.css("borderBottomWidth"),10)||0)+(parseInt(f.css("marginTop"),10)||0)};j=this._normValueFromMouse(h);this._slide(d,i,j);return true},_mouseStart:function(b){return true},_mouseDrag:function(d){var b={x:d.pageX,y:d.pageY};var c=this._normValueFromMouse(b);this._slide(d,this._handleIndex,c);return false},_mouseStop:function(b){this.handles.removeClass("ui-state-active");this._stop(b,this._handleIndex);this._change(b,this._handleIndex);this._handleIndex=null;this._clickOffset=null;return false},_detectOrientation:function(){this.orientation=this.options.orientation=="vertical"?"vertical":"horizontal"},_normValueFromMouse:function(d){var c,h;if("horizontal"==this.orientation){c=this.elementSize.width;h=d.x-this.elementOffset.left-(this._clickOffset?this._clickOffset.left:0)}else{c=this.elementSize.height;h=d.y-this.elementOffset.top-(this._clickOffset?this._clickOffset.top:0)}var f=(h/c);if(f>1){f=1}if(f<0){f=0}if("vertical"==this.orientation){f=1-f}var e=this._valueMax()-this._valueMin(),i=f*e,b=i%this.options.step,g=this._valueMin()+i-b;if(b>(this.options.step/2)){g+=this.options.step}return parseFloat(g.toFixed(5))},_start:function(d,c){var b={handle:this.handles[c],value:this.value()};if(this.options.values&&this.options.values.length){b.value=this.values(c);b.values=this.values()}this._trigger("start",d,b)},_slide:function(f,e,d){var g=this.handles[e];if(this.options.values&&this.options.values.length){var b=this.values(e?0:1);if((this.options.values.length==2&&this.options.range===true)&&((e==0&&d>b)||(e==1&&d<b))){d=b}if(d!=this.values(e)){var c=this.values();c[e]=d;var h=this._trigger("slide",f,{handle:this.handles[e],value:d,values:c});var b=this.values(e?0:1);if(h!==false){this.values(e,d,(f.type=="mousedown"&&this.options.animate),true)}}}else{if(d!=this.value()){var h=this._trigger("slide",f,{handle:this.handles[e],value:d});if(h!==false){this._setData("value",d,(f.type=="mousedown"&&this.options.animate))}}}},_stop:function(d,c){var b={handle:this.handles[c],value:this.value()};if(this.options.values&&this.options.values.length){b.value=this.values(c);b.values=this.values()}this._trigger("stop",d,b)},_change:function(d,c){var b={handle:this.handles[c],value:this.value()};if(this.options.values&&this.options.values.length){b.value=this.values(c);b.values=this.values()}this._trigger("change",d,b)},value:function(b){if(arguments.length){this._setData("value",b);this._change(null,0)}return this._value()},values:function(b,e,c,d){if(arguments.length>1){this.options.values[b]=e;this._refreshValue(c);if(!d){this._change(null,b)}}if(arguments.length){if(this.options.values&&this.options.values.length){return this._values(b)}else{return this.value()}}else{return this._values()}},_setData:function(b,d,c){a.widget.prototype._setData.apply(this,arguments);switch(b){case"disabled":if(d){this.handles.filter(".ui-state-focus").blur();this.handles.removeClass("ui-state-hover");this.handles.attr("disabled","disabled")}else{this.handles.removeAttr("disabled")}case"orientation":this._detectOrientation();this.element.removeClass("ui-slider-horizontal ui-slider-vertical").addClass("ui-slider-"+this.orientation);this._refreshValue(c);break;case"value":this._refreshValue(c);break}},_step:function(){var b=this.options.step;return b},_value:function(){var b=this.options.value;if(b<this._valueMin()){b=this._valueMin()}if(b>this._valueMax()){b=this._valueMax()}return b},_values:function(b){if(arguments.length){var c=this.options.values[b];if(c<this._valueMin()){c=this._valueMin()}if(c>this._valueMax()){c=this._valueMax()}return c}else{return this.options.values}},_valueMin:function(){var b=this.options.min;return b},_valueMax:function(){var b=this.options.max;return b},_refreshValue:function(c){var f=this.options.range,d=this.options,l=this;if(this.options.values&&this.options.values.length){var i,h;this.handles.each(function(p,n){var o=(l.values(p)-l._valueMin())/(l._valueMax()-l._valueMin())*100;var m={};m[l.orientation=="horizontal"?"left":"bottom"]=o+"%";a(this).stop(1,1)[c?"animate":"css"](m,d.animate);if(l.options.range===true){if(l.orientation=="horizontal"){(p==0)&&l.range.stop(1,1)[c?"animate":"css"]({left:o+"%"},d.animate);(p==1)&&l.range[c?"animate":"css"]({width:(o-lastValPercent)+"%"},{queue:false,duration:d.animate})}else{(p==0)&&l.range.stop(1,1)[c?"animate":"css"]({bottom:(o)+"%"},d.animate);(p==1)&&l.range[c?"animate":"css"]({height:(o-lastValPercent)+"%"},{queue:false,duration:d.animate})}}lastValPercent=o})}else{var j=this.value(),g=this._valueMin(),k=this._valueMax(),e=k!=g?(j-g)/(k-g)*100:0;var b={};b[l.orientation=="horizontal"?"left":"bottom"]=e+"%";this.handle.stop(1,1)[c?"animate":"css"](b,d.animate);(f=="min")&&(this.orientation=="horizontal")&&this.range.stop(1,1)[c?"animate":"css"]({width:e+"%"},d.animate);(f=="max")&&(this.orientation=="horizontal")&&this.range[c?"animate":"css"]({width:(100-e)+"%"},{queue:false,duration:d.animate});(f=="min")&&(this.orientation=="vertical")&&this.range.stop(1,1)[c?"animate":"css"]({height:e+"%"},d.animate);(f=="max")&&(this.orientation=="vertical")&&this.range[c?"animate":"css"]({height:(100-e)+"%"},{queue:false,duration:d.animate})}}}));a.extend(a.ui.slider,{getter:"value values",version:"1.7.2",eventPrefix:"slide",defaults:{animate:false,delay:0,distance:0,max:100,min:0,orientation:"horizontal",range:false,step:1,value:0,values:null}})})(jQuery);;jQuery.effects||(function(d){d.effects={version:"1.7.2",save:function(g,h){for(var f=0;f<h.length;f++){if(h[f]!==null){g.data("ec.storage."+h[f],g[0].style[h[f]])}}},restore:function(g,h){for(var f=0;f<h.length;f++){if(h[f]!==null){g.css(h[f],g.data("ec.storage."+h[f]))}}},setMode:function(f,g){if(g=="toggle"){g=f.is(":hidden")?"show":"hide"}return g},getBaseline:function(g,h){var i,f;switch(g[0]){case"top":i=0;break;case"middle":i=0.5;break;case"bottom":i=1;break;default:i=g[0]/h.height}switch(g[1]){case"left":f=0;break;case"center":f=0.5;break;case"right":f=1;break;default:f=g[1]/h.width}return{x:f,y:i}},createWrapper:function(f){if(f.parent().is(".ui-effects-wrapper")){return f.parent()}var g={width:f.outerWidth(true),height:f.outerHeight(true),"float":f.css("float")};f.wrap('<div class="ui-effects-wrapper" style="font-size:100%;background:transparent;border:none;margin:0;padding:0"></div>');var j=f.parent();if(f.css("position")=="static"){j.css({position:"relative"});f.css({position:"relative"})}else{var i=f.css("top");if(isNaN(parseInt(i,10))){i="auto"}var h=f.css("left");if(isNaN(parseInt(h,10))){h="auto"}j.css({position:f.css("position"),top:i,left:h,zIndex:f.css("z-index")}).show();f.css({position:"relative",top:0,left:0})}j.css(g);return j},removeWrapper:function(f){if(f.parent().is(".ui-effects-wrapper")){return f.parent().replaceWith(f)}return f},setTransition:function(g,i,f,h){h=h||{};d.each(i,function(k,j){unit=g.cssUnit(j);if(unit[0]>0){h[j]=unit[0]*f+unit[1]}});return h},animateClass:function(h,i,k,j){var f=(typeof k=="function"?k:(j?j:null));var g=(typeof k=="string"?k:null);return this.each(function(){var q={};var o=d(this);var p=o.attr("style")||"";if(typeof p=="object"){p=p.cssText}if(h.toggle){o.hasClass(h.toggle)?h.remove=h.toggle:h.add=h.toggle}var l=d.extend({},(document.defaultView?document.defaultView.getComputedStyle(this,null):this.currentStyle));if(h.add){o.addClass(h.add)}if(h.remove){o.removeClass(h.remove)}var m=d.extend({},(document.defaultView?document.defaultView.getComputedStyle(this,null):this.currentStyle));if(h.add){o.removeClass(h.add)}if(h.remove){o.addClass(h.remove)}for(var r in m){if(typeof m[r]!="function"&&m[r]&&r.indexOf("Moz")==-1&&r.indexOf("length")==-1&&m[r]!=l[r]&&(r.match(/color/i)||(!r.match(/color/i)&&!isNaN(parseInt(m[r],10))))&&(l.position!="static"||(l.position=="static"&&!r.match(/left|top|bottom|right/)))){q[r]=m[r]}}o.animate(q,i,g,function(){if(typeof d(this).attr("style")=="object"){d(this).attr("style")["cssText"]="";d(this).attr("style")["cssText"]=p}else{d(this).attr("style",p)}if(h.add){d(this).addClass(h.add)}if(h.remove){d(this).removeClass(h.remove)}if(f){f.apply(this,arguments)}})})}};function c(g,f){var i=g[1]&&g[1].constructor==Object?g[1]:{};if(f){i.mode=f}var h=g[1]&&g[1].constructor!=Object?g[1]:(i.duration?i.duration:g[2]);h=d.fx.off?0:typeof h==="number"?h:d.fx.speeds[h]||d.fx.speeds._default;var j=i.callback||(d.isFunction(g[1])&&g[1])||(d.isFunction(g[2])&&g[2])||(d.isFunction(g[3])&&g[3]);return[g[0],i,h,j]}d.fn.extend({_show:d.fn.show,_hide:d.fn.hide,__toggle:d.fn.toggle,_addClass:d.fn.addClass,_removeClass:d.fn.removeClass,_toggleClass:d.fn.toggleClass,effect:function(g,f,h,i){return d.effects[g]?d.effects[g].call(this,{method:g,options:f||{},duration:h,callback:i}):null},show:function(){if(!arguments[0]||(arguments[0].constructor==Number||(/(slow|normal|fast)/).test(arguments[0]))){return this._show.apply(this,arguments)}else{return this.effect.apply(this,c(arguments,"show"))}},hide:function(){if(!arguments[0]||(arguments[0].constructor==Number||(/(slow|normal|fast)/).test(arguments[0]))){return this._hide.apply(this,arguments)}else{return this.effect.apply(this,c(arguments,"hide"))}},toggle:function(){if(!arguments[0]||(arguments[0].constructor==Number||(/(slow|normal|fast)/).test(arguments[0]))||(d.isFunction(arguments[0])||typeof arguments[0]=="boolean")){return this.__toggle.apply(this,arguments)}else{return this.effect.apply(this,c(arguments,"toggle"))}},addClass:function(g,f,i,h){return f?d.effects.animateClass.apply(this,[{add:g},f,i,h]):this._addClass(g)},removeClass:function(g,f,i,h){return f?d.effects.animateClass.apply(this,[{remove:g},f,i,h]):this._removeClass(g)},toggleClass:function(g,f,i,h){return((typeof f!=="boolean")&&f)?d.effects.animateClass.apply(this,[{toggle:g},f,i,h]):this._toggleClass(g,f)},morph:function(f,h,g,j,i){return d.effects.animateClass.apply(this,[{add:h,remove:f},g,j,i])},switchClass:function(){return this.morph.apply(this,arguments)},cssUnit:function(f){var g=this.css(f),h=[];d.each(["em","px","%","pt"],function(j,k){if(g.indexOf(k)>0){h=[parseFloat(g),k]}});return h}});d.each(["backgroundColor","borderBottomColor","borderLeftColor","borderRightColor","borderTopColor","color","outlineColor"],function(g,f){d.fx.step[f]=function(h){if(h.state==0){h.start=e(h.elem,f);h.end=b(h.end)}h.elem.style[f]="rgb("+[Math.max(Math.min(parseInt((h.pos*(h.end[0]-h.start[0]))+h.start[0],10),255),0),Math.max(Math.min(parseInt((h.pos*(h.end[1]-h.start[1]))+h.start[1],10),255),0),Math.max(Math.min(parseInt((h.pos*(h.end[2]-h.start[2]))+h.start[2],10),255),0)].join(",")+")"}});function b(g){var f;if(g&&g.constructor==Array&&g.length==3){return g}if(f=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(g)){return[parseInt(f[1],10),parseInt(f[2],10),parseInt(f[3],10)]}if(f=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(g)){return[parseFloat(f[1])*2.55,parseFloat(f[2])*2.55,parseFloat(f[3])*2.55]}if(f=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(g)){return[parseInt(f[1],16),parseInt(f[2],16),parseInt(f[3],16)]}if(f=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(g)){return[parseInt(f[1]+f[1],16),parseInt(f[2]+f[2],16),parseInt(f[3]+f[3],16)]}if(f=/rgba\(0, 0, 0, 0\)/.exec(g)){return a.transparent}return a[d.trim(g).toLowerCase()]}function e(h,f){var g;do{g=d.curCSS(h,f);if(g!=""&&g!="transparent"||d.nodeName(h,"body")){break}f="backgroundColor"}while(h=h.parentNode);return b(g)}var a={aqua:[0,255,255],azure:[240,255,255],beige:[245,245,220],black:[0,0,0],blue:[0,0,255],brown:[165,42,42],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgrey:[169,169,169],darkgreen:[0,100,0],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkviolet:[148,0,211],fuchsia:[255,0,255],gold:[255,215,0],green:[0,128,0],indigo:[75,0,130],khaki:[240,230,140],lightblue:[173,216,230],lightcyan:[224,255,255],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightyellow:[255,255,224],lime:[0,255,0],magenta:[255,0,255],maroon:[128,0,0],navy:[0,0,128],olive:[128,128,0],orange:[255,165,0],pink:[255,192,203],purple:[128,0,128],violet:[128,0,128],red:[255,0,0],silver:[192,192,192],white:[255,255,255],yellow:[255,255,0],transparent:[255,255,255]};d.easing.jswing=d.easing.swing;d.extend(d.easing,{def:"easeOutQuad",swing:function(g,h,f,j,i){return d.easing[d.easing.def](g,h,f,j,i)},easeInQuad:function(g,h,f,j,i){return j*(h/=i)*h+f},easeOutQuad:function(g,h,f,j,i){return-j*(h/=i)*(h-2)+f},easeInOutQuad:function(g,h,f,j,i){if((h/=i/2)<1){return j/2*h*h+f}return-j/2*((--h)*(h-2)-1)+f},easeInCubic:function(g,h,f,j,i){return j*(h/=i)*h*h+f},easeOutCubic:function(g,h,f,j,i){return j*((h=h/i-1)*h*h+1)+f},easeInOutCubic:function(g,h,f,j,i){if((h/=i/2)<1){return j/2*h*h*h+f}return j/2*((h-=2)*h*h+2)+f},easeInQuart:function(g,h,f,j,i){return j*(h/=i)*h*h*h+f},easeOutQuart:function(g,h,f,j,i){return-j*((h=h/i-1)*h*h*h-1)+f},easeInOutQuart:function(g,h,f,j,i){if((h/=i/2)<1){return j/2*h*h*h*h+f}return-j/2*((h-=2)*h*h*h-2)+f},easeInQuint:function(g,h,f,j,i){return j*(h/=i)*h*h*h*h+f},easeOutQuint:function(g,h,f,j,i){return j*((h=h/i-1)*h*h*h*h+1)+f},easeInOutQuint:function(g,h,f,j,i){if((h/=i/2)<1){return j/2*h*h*h*h*h+f}return j/2*((h-=2)*h*h*h*h+2)+f},easeInSine:function(g,h,f,j,i){return-j*Math.cos(h/i*(Math.PI/2))+j+f},easeOutSine:function(g,h,f,j,i){return j*Math.sin(h/i*(Math.PI/2))+f},easeInOutSine:function(g,h,f,j,i){return-j/2*(Math.cos(Math.PI*h/i)-1)+f},easeInExpo:function(g,h,f,j,i){return(h==0)?f:j*Math.pow(2,10*(h/i-1))+f},easeOutExpo:function(g,h,f,j,i){return(h==i)?f+j:j*(-Math.pow(2,-10*h/i)+1)+f},easeInOutExpo:function(g,h,f,j,i){if(h==0){return f}if(h==i){return f+j}if((h/=i/2)<1){return j/2*Math.pow(2,10*(h-1))+f}return j/2*(-Math.pow(2,-10*--h)+2)+f},easeInCirc:function(g,h,f,j,i){return-j*(Math.sqrt(1-(h/=i)*h)-1)+f},easeOutCirc:function(g,h,f,j,i){return j*Math.sqrt(1-(h=h/i-1)*h)+f},easeInOutCirc:function(g,h,f,j,i){if((h/=i/2)<1){return-j/2*(Math.sqrt(1-h*h)-1)+f}return j/2*(Math.sqrt(1-(h-=2)*h)+1)+f},easeInElastic:function(g,i,f,m,l){var j=1.70158;var k=0;var h=m;if(i==0){return f}if((i/=l)==1){return f+m}if(!k){k=l*0.3}if(h<Math.abs(m)){h=m;var j=k/4}else{var j=k/(2*Math.PI)*Math.asin(m/h)}return-(h*Math.pow(2,10*(i-=1))*Math.sin((i*l-j)*(2*Math.PI)/k))+f},easeOutElastic:function(g,i,f,m,l){var j=1.70158;var k=0;var h=m;if(i==0){return f}if((i/=l)==1){return f+m}if(!k){k=l*0.3}if(h<Math.abs(m)){h=m;var j=k/4}else{var j=k/(2*Math.PI)*Math.asin(m/h)}return h*Math.pow(2,-10*i)*Math.sin((i*l-j)*(2*Math.PI)/k)+m+f},easeInOutElastic:function(g,i,f,m,l){var j=1.70158;var k=0;var h=m;if(i==0){return f}if((i/=l/2)==2){return f+m}if(!k){k=l*(0.3*1.5)}if(h<Math.abs(m)){h=m;var j=k/4}else{var j=k/(2*Math.PI)*Math.asin(m/h)}if(i<1){return-0.5*(h*Math.pow(2,10*(i-=1))*Math.sin((i*l-j)*(2*Math.PI)/k))+f}return h*Math.pow(2,-10*(i-=1))*Math.sin((i*l-j)*(2*Math.PI)/k)*0.5+m+f},easeInBack:function(g,h,f,k,j,i){if(i==undefined){i=1.70158}return k*(h/=j)*h*((i+1)*h-i)+f},easeOutBack:function(g,h,f,k,j,i){if(i==undefined){i=1.70158}return k*((h=h/j-1)*h*((i+1)*h+i)+1)+f},easeInOutBack:function(g,h,f,k,j,i){if(i==undefined){i=1.70158}if((h/=j/2)<1){return k/2*(h*h*(((i*=(1.525))+1)*h-i))+f}return k/2*((h-=2)*h*(((i*=(1.525))+1)*h+i)+2)+f},easeInBounce:function(g,h,f,j,i){return j-d.easing.easeOutBounce(g,i-h,0,j,i)+f},easeOutBounce:function(g,h,f,j,i){if((h/=i)<(1/2.75)){return j*(7.5625*h*h)+f}else{if(h<(2/2.75)){return j*(7.5625*(h-=(1.5/2.75))*h+0.75)+f}else{if(h<(2.5/2.75)){return j*(7.5625*(h-=(2.25/2.75))*h+0.9375)+f}else{return j*(7.5625*(h-=(2.625/2.75))*h+0.984375)+f}}}},easeInOutBounce:function(g,h,f,j,i){if(h<i/2){return d.easing.easeInBounce(g,h*2,0,j,i)*0.5+f}return d.easing.easeOutBounce(g,h*2-i,0,j,i)*0.5+j*0.5+f}})})(jQuery);;(function(a){a.effects.highlight=function(b){return this.queue(function(){var e=a(this),d=["backgroundImage","backgroundColor","opacity"];var h=a.effects.setMode(e,b.options.mode||"show");var c=b.options.color||"#ffff99";var g=e.css("backgroundColor");a.effects.save(e,d);e.show();e.css({backgroundImage:"none",backgroundColor:c});var f={backgroundColor:g};if(h=="hide"){f.opacity=0}e.animate(f,{queue:false,duration:b.duration,easing:b.options.easing,complete:function(){if(h=="hide"){e.hide()}a.effects.restore(e,d);if(h=="show"&&a.browser.msie){this.style.removeAttribute("filter")}if(b.callback){b.callback.apply(this,arguments)}e.dequeue()}})})}})(jQuery);;(function(a){a.effects.pulsate=function(b){return this.queue(function(){var d=a(this);var g=a.effects.setMode(d,b.options.mode||"show");var f=b.options.times||5;var e=b.duration?b.duration/2:a.fx.speeds._default/2;if(g=="hide"){f--}if(d.is(":hidden")){d.css("opacity",0);d.show();d.animate({opacity:1},e,b.options.easing);f=f-2}for(var c=0;c<f;c++){d.animate({opacity:0},e,b.options.easing).animate({opacity:1},e,b.options.easing)}if(g=="hide"){d.animate({opacity:0},e,b.options.easing,function(){d.hide();if(b.callback){b.callback.apply(this,arguments)}})}else{d.animate({opacity:0},e,b.options.easing).animate({opacity:1},e,b.options.easing,function(){if(b.callback){b.callback.apply(this,arguments)}})}d.queue("fx",function(){d.dequeue()});d.dequeue()})}})(jQuery);;;(function($){var svg_icons={};$.svgIcons=function(file,opts){var svgns="http://www.w3.org/2000/svg",xlinkns="http://www.w3.org/1999/xlink",icon_w=opts.w?opts.w:24,icon_h=opts.h?opts.h:24,useFallbackImgs=opts.use_fallback?opts.use_fallback:false,elems,svgdoc,testImg,icons_made=false,data_loaded=false,load_attempts=0,ua=navigator.userAgent,isOpera=!!window.opera,isSafari=(ua.indexOf('Safari/')>-1&&ua.indexOf('Chrome/')==-1),data_pre='data:image/svg+xml;charset=utf-8;base64,';if(opts.svgz){var data_el=$('<object data="'+file+'" type=image/svg+xml>').appendTo('body').hide();try{svgdoc=data_el[0].contentDocument;data_el.load(getIcons);getIcons(0,true);}catch(err1){useFallback();}}else{$.ajax({url:file,dataType:'xml',success:function(data){svgdoc=data;getIcons('ajax');},error:function(){useFallback();}});}
function getIcons(evt,no_wait){if(evt!=='ajax'){if(data_loaded)return;svgdoc=data_el[0].contentDocument;var isReady=(svgdoc&&svgdoc.getElementById('svg_eof'));if(!isReady&&!(no_wait&&isReady)){load_attempts++;if(load_attempts<50){setTimeout(getIcons,20);}else{useFallback();data_loaded=true;}
return;}
data_loaded=true;}
$(svgdoc).find('metadata').remove().end().find('*').each(function(i,el){if(el.nodeName.indexOf(':')!=-1){$(el).remove();}
var attrs=$.extend(false,el.attributes,{});for(i in attrs){var attr=attrs[i];var fullattr=attr.prefix?attr.prefix+':'+attr.localName:'';if(attr.prefix){el.removeAttribute(attr.localName);el.removeAttribute(fullattr);}
if(fullattr=='xlink:href'){el.setAttribute('xlink:href',attr.nodeValue);}}});elems=$(svgdoc.firstChild).children();var testSrc=data_pre+'PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNzUiIGhlaWdodD0iMjc1Ij48L3N2Zz4%3D';testImg=$(new Image()).attr({src:testSrc,width:0,height:0}).appendTo('body').load(function(){makeIcons(!isSafari);}).error(function(){makeIcons();});}
function makeIcons(toImage,fallback){if(icons_made)return;if(opts.no_img)toImage=false;var holder;var setIcon=function(target,icon,id,setID){if(isOpera)icon.css('visibility','hidden');if(opts.replace){if(setID)icon.attr('id',id);var cl=target.attr('class');if(cl)icon.attr('class','svg_icon '+cl);target.replaceWith(icon);}else{target.append(icon);}
if(isOpera){setTimeout(function(){icon.attr('style','visibility:visible;');},1);}}
var addIcon=function(icon,id){if(opts.id_match===undefined||opts.id_match!==false){setIcon(holder,icon,id,true);}
svg_icons[id]=icon;}
if(toImage){var temp_holder=$(document.createElement('div'));temp_holder.hide().appendTo('body');}
if(fallback){var path=opts.fallback_path?opts.fallback_path:'';$.each(fallback,function(id,imgsrc){holder=$('#'+id);var icon=$(new Image()).attr({'class':'svg_icon',src:path+imgsrc,'width':icon_w,'height':icon_h,'alt':'icon'});addIcon(icon,id);});}else{$.each(elems,function(i,elem){var id=elem.getAttribute('id');if(id=='svg_eof')return;holder=$('#'+id);var svg=elem.getElementsByTagNameNS(svgns,'svg')[0];var svgroot=svgdoc.createElementNS(svgns,"svg");svgroot.setAttributeNS(svgns,'viewBox',[0,0,icon_w,icon_h].join(' '));$(svgroot).attr({"xmlns":svgns,"width":icon_w,"height":icon_h,"xmlns:xlink":xlinkns,"class":'svg_icon'});if(!isOpera)svg=svg.cloneNode(true);svgroot.appendChild(svg);if(toImage){var svgcontent=isOpera?svgroot:svgroot.cloneNode(true);temp_holder.empty().append(svgroot);var str=data_pre+encode64(temp_holder.html());var icon=$(new Image()).attr({'class':'svg_icon',src:str});}else{var icon=fixIDs($(svgroot),i);}
addIcon(icon,id);});}
if(opts.placement){$.each(opts.placement,function(sel,id){if(!svg_icons[id])return;$(sel).each(function(i){var copy=svg_icons[id].clone();if(i>0&&!toImage)copy=fixIDs(copy,i,true);setIcon($(this),copy,id);})});}
if(!fallback){if(toImage)temp_holder.remove();if(data_el)data_el.remove();testImg.remove();}
if(opts.resize)$.resizeSvgIcons(opts.resize);icons_made=true;if(opts.callback)opts.callback(svg_icons);}
function fixIDs(svg_el,svg_num,force){var defs=svg_el.find('defs');if(!defs.length)return svg_el;defs.find('[id]').each(function(i){var id=this.id;var no_dupes=($(svgdoc).find('#'+id).length<=1);if(isOpera)no_dupes=false;var new_id='x'+id+svg_num+i;$(this).attr('id',new_id);svg_el.find('[fill="url(#'+id+')"]').each(function(){$(this).attr('fill','url(/vlewrapper/vle/node/draw/svg-edit-2.4rc1/images/svg_edit_icons.svg#'+id+')');}).end().find('[stroke="url(#'+id+')"]').each(function(){$(this).attr('stroke','url(/vlewrapper/vle/node/draw/svg-edit-2.4rc1/images/svg_edit_icons.svg#'+id+')');}).end().find('use').each(function(){if(this.getAttribute('xlink:href')=='#'+id){this.setAttributeNS(xlinkns,'href','#'+new_id);}});});return svg_el;}
function useFallback(){if(file.indexOf('.svgz')!=-1){var reg_file=file.replace('.svgz','.svg');if(window.console){console.log('.svgz failed, trying with .svg');}
$.svgIcons(reg_file,opts);}else if(opts.fallback){makeIcons(false,opts.fallback);}}
function encode64(input){if(window.btoa)return window.btoa(input);var _keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var output=new Array(Math.floor((input.length+2)/3)*4);var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0,p=0;do{chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=((chr1&3)<<4)|(chr2>>4);enc3=((chr2&15)<<2)|(chr3>>6);enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64;}else if(isNaN(chr3)){enc4=64;}
output[p++]=_keyStr.charAt(enc1);output[p++]=_keyStr.charAt(enc2);output[p++]=_keyStr.charAt(enc3);output[p++]=_keyStr.charAt(enc4);}while(i<input.length);return output.join('');}}
$.getSvgIcon=function(id){return svg_icons[id];}
$.resizeSvgIcons=function(obj){var change_sel=!$('.svg_icon:first').length;$.each(obj,function(sel,size){var arr=$.isArray(size);var w=arr?size[0]:size,h=arr?size[1]:size;if(change_sel){sel=sel.replace(/\.svg_icon/g,'svg');}
$(sel).each(function(){this.setAttribute('width',w);this.setAttribute('height',h);});});}})(jQuery);;function svg_edit_setup(){var uiStrings={'invalidAttrValGiven':'Invalid value given','noContentToFitTo':'No content to fit to','layer':"Layer",'dupeLayerName':"There is already a layer named that!",'enterUniqueLayerName':"Please enter a unique layer name",'enterNewLayerName':"Please enter the new layer name",'layerHasThatName':"Layer already has that name",'QmoveElemsToLayer':"Move selected elements to layer '%s'?",'QwantToClear':'Do you want to clear the drawing?\nThis will also erase your undo history!','QerrorsRevertToSource':'There were parsing errors in your SVG source.\nRevert back to original SVG source?','QignoreSourceChanges':'Ignore changes made to SVG source?','featNotSupported':'Feature not supported','enterNewImgURL':'Enter the new image URL','ok':'OK','cancel':'Cancel','key_up':'Up','key_down':'Down','key_backspace':'Backspace','key_del':'Del'};var palette=["#ffaaaa","#ff5656","#ff0000","#bf0000","#7f0000","#ffffff","#ffd4aa","#ffaa56","#ff7f00","#bf5f00","#7f3f00","#e5e5e5","#ffffaa","#ffff56","#ffff00","#bfbf00","#7f7f00","#cccccc","#d4ffaa","#aaff56","#7fff00","#5fbf00","#3f7f00","#b2b2b2","#aaffaa","#56ff56","#00ff00","#00bf00","#007f00","#999999","#aaffd4","#56ffaa","#00ff7f","#00bf5f","#007f3f","#7f7f7f","#aaffff","#56aaff","#007fff","#005fbf","#003f7f","#4c4c4c","#aaaaff","#5656ff","#0000ff","#0000bf","#00007f","#333333","#d4aaff","#aa56ff","#7f00ff","#5f00bf","#3f007f","#191919","#ffaaff","#ff56ff","#ff00ff","#bf00bf","#7f007f","#000000","#ffaad4","#ff56aa","#ff007f","#bf005f","#7f003f"];var isMac=false;var modKey="";var svgCanvas=new SvgCanvas(document.getElementById("svgcanvas"));var path=svgCanvas.pathActions;var default_img_url="images/logo.png";$.pref=function(key,val){if(val)curPrefs[key]=val;key='svg-edit-'+key;var host=location.hostname;var onweb=host&&host.indexOf('.')!=-1;var store=(val!=undefined);var storage=false;try{if(window.localStorage&&onweb){storage=localStorage;}}catch(e){}
try{if(window.globalStorage&&onweb){storage=globalStorage[host];}}catch(e){}
if(storage){if(store)storage.setItem(key,val);else return storage.getItem(key);}else if(window.widget){if(store)widget.setPreferenceForKey(val,key);else return widget.preferenceForKey(key);}else{if(store){var d=new Date();d.setTime(d.getTime()+31536000000);val=encodeURIComponent(val);document.cookie=key+'='+val+'; expires='+d.toUTCString();}else{var result=document.cookie.match(new RegExp(key+"=([^;]+)"));return result?decodeURIComponent(result[1]):'';}}}
var curPrefs={lang:'en',iconsize:'m',bg_color:'#FFF',bg_url:'',img_save:'embed'};(function(){$('#dialog_container').draggable({cancel:'#dialog_content, #dialog_buttons *'});var box=$('#dialog_box'),btn_holder=$('#dialog_buttons');var dbox=function(type,msg,callback,defText){$('#dialog_content').html('<p>'+msg.replace(/\n/g,'</p><p>')+'</p>').toggleClass('prompt',(type=='prompt'));btn_holder.empty();var ok=$('<input type="button" value="'+uiStrings.ok+'">').appendTo(btn_holder);if(type!='alert'){$('<input type="button" value="'+uiStrings.cancel+'">').appendTo(btn_holder).click(function(){box.hide();callback(false)});}
if(type=='prompt'){var input=$('<input type="text">').prependTo(btn_holder);input.val(defText||'');input.bind('keydown',{combi:'return'},function(){ok.click();});}
box.show();ok.click(function(){box.hide();var resp=(type=='prompt')?input.val():true;if(callback)callback(resp);}).focus();if(type=='prompt')input.focus();}
$.alert=function(msg,cb){dbox('alert',msg,cb);};$.confirm=function(msg,cb){dbox('confirm',msg,cb);};$.prompt=function(msg,txt,cb){dbox('prompt',msg,cb,txt);};}());var setSelectMode=function(){$('.tool_button_current').removeClass('tool_button_current').addClass('tool_button');$('#tool_select').addClass('tool_button_current');$('#styleoverrides').text('#svgcanvas svg *{cursor:move;pointer-events:all} #svgcanvas svg{cursor:default}');svgCanvas.setMode('select');};var flyoutspeed=1250;var textBeingEntered=false;var selectedElement=null;var multiselected=false;var editingsource=false;var docprops=false;var length_attrs=['x','y','x1','x2','y1','y2','cx','cy','width','height','r','rx','ry','width','height','radius'];var length_types=['em','ex','px','cm','mm','in','pt','pc','%'];var fillPaint=new $.jGraduate.Paint({solidColor:"FF0000"});var strokePaint=new $.jGraduate.Paint({solidColor:"000000"});var picker="fill";var saveHandler=function(window,svg){window.open("data:image/svg+xml;base64,"+Utils.encode64(svg));};var selectedChanged=function(window,elems){selectedElement=(elems.length==1||elems[1]==null?elems[0]:null);multiselected=(elems.length>=2&&elems[1]!=null);var is_node=false;if(selectedElement!=null){is_node=!!(selectedElement.id&&selectedElement.id.indexOf('pathpointgrip')==0);if(svgCanvas.getMode()!="multiselect"&&!is_node){setSelectMode();updateToolbar();}}
$('#path_node_panel').toggle(is_node);$('#tools_bottom_2,#tools_bottom_3').toggle(!is_node);var size=$('#tool_select > svg, #tool_select > img')[0].getAttribute('width');if(is_node){$('.tool_button').removeClass('tool_button_current');$('#tool_select').addClass('tool_button_current').empty().append($.getSvgIcon('select_node'));}else{$('#tool_select').empty().append($.getSvgIcon('select'));}
$.resizeSvgIcons({'#tool_select .svg_icon':size});updateContextPanel();};var elementChanged=function(window,elems){for(var i=0;i<elems.length;++i){var elem=elems[i];if(elem&&elem.tagName=="svg"&&elem.getAttribute("viewBox")){var vb=elem.getAttribute("viewBox").split(' ');changeResolution(parseInt(vb[2]),parseInt(vb[3]));}
else if(elem&&selectedElement&&selectedElement.parentNode==null){selectedElement=elem;}}
updateContextPanel();};var updateBgImage=function(){var bg_img=$('#background_img');if(!bg_img.length)return;var img=bg_img.find('img');var zoomlevel=svgCanvas.getZoom();img.width(zoomlevel*100+'%');}
var zoomChanged=function(window,bbox){var scrbar=15;var res=svgCanvas.getResolution();var w_area=$('#workarea');var canvas_pos=$('#svgcanvas').position();w_area.css('cursor','auto');var z_info=svgCanvas.setBBoxZoom(bbox,w_area.width()-scrbar,w_area.height()-scrbar);if(!z_info)return;var zoomlevel=z_info.zoom;var bb=z_info.bbox;$('#zoom').val(Math.round(zoomlevel*100));setResolution(res.w*zoomlevel,res.h*zoomlevel);var scrLeft=bb.x*zoomlevel;var scrOffX=w_area.width()/2-(bb.width*zoomlevel)/2;w_area[0].scrollLeft=Math.max(0,scrLeft-scrOffX)+Math.max(0,canvas_pos.left);var scrTop=bb.y*zoomlevel;var scrOffY=w_area.height()/2-(bb.height*zoomlevel)/2;w_area[0].scrollTop=Math.max(0,scrTop-scrOffY)+Math.max(0,canvas_pos.top);if(svgCanvas.getMode()=='zoom'&&bb.width){setSelectMode();}
zoomDone();}
var updateToolbar=function(){if(selectedElement!=null&&selectedElement.tagName!="image"&&selectedElement.tagName!="g"){var fillOpacity=parseFloat(selectedElement.getAttribute("fill-opacity"));if(isNaN(fillOpacity)){fillOpacity=1.0;}
var strokeOpacity=parseFloat(selectedElement.getAttribute("stroke-opacity"));if(isNaN(strokeOpacity)){strokeOpacity=1.0;}
var fillColor=selectedElement.getAttribute("fill")||"none";svgCanvas.setFillColor(fillColor,true);svgCanvas.setFillOpacity(fillOpacity,true);var strokeColor=selectedElement.getAttribute("stroke")||"none";svgCanvas.setStrokeColor(strokeColor,true);svgCanvas.setStrokeOpacity(strokeOpacity,true);fillOpacity*=100;strokeOpacity*=100;var getPaint=function(color,opac){var opts=null;if(color.substr(0,5)=="url(#"){opts={alpha:opac,linearGradient:document.getElementById(color.substr(5,color.length-6))};}
else if(color.substr(0,1)=="#"){opts={alpha:opac,solidColor:color.substr(1)};}
return new $.jGraduate.Paint(opts);};fillPaint=getPaint(fillColor,fillOpacity);strokePaint=getPaint(strokeColor,strokeOpacity);fillOpacity="";if(selectedElement.tagName=="text"){strokeOpacity="Not Available";strokeColor="none";}else{strokeOpacity="";}
if(fillColor=="transparent"||fillColor=="initial"){fillColor="none";if(selectedElement.tagName=="line"||selectedElement.tagName=="polyline"){fillOpacity="Not Available";}else{fillOpacity="None";}}
if(strokeColor=="transparent"||strokeColor=="initial"){strokeColor="none";if(selectedElement.tagName=="text"){strokeOpacity="Not Available";}else{strokeOpacity="None";}}
document.getElementById("gradbox_fill").parentNode.firstChild.setAttribute("fill",fillColor);document.getElementById("gradbox_stroke").parentNode.firstChild.setAttribute("fill",strokeColor);$('#fill_opacity').html(fillOpacity);$('#stroke_opacity').html(strokeOpacity);$('#stroke_width').val(selectedElement.getAttribute("stroke-width")||1);$('#stroke_style').val(selectedElement.getAttribute("stroke-dasharray")||"none");}
if(selectedElement!=null){var opac_perc=((selectedElement.getAttribute("opacity")||1.0)*100);$('#group_opacity').val(opac_perc);$('#opac_slider').slider('option','value',opac_perc);if(selectedElement.tagName=="text"||selectedElement.tagName=="image"){$('#stroke_widthLabel').hide();$('#stroke_width').hide();}else{$('#stroke_widthLabel').show();$('#stroke_width').show();}
if(selectedElement.tagName=="image"){var fillOpacity="Not Available";var strokeOpacity="Not Available"
var strokeColor="none";var fillColor="none";document.getElementById("gradbox_fill").parentNode.firstChild.setAttribute("fill",fillColor);document.getElementById("gradbox_stroke").parentNode.firstChild.setAttribute("fill",strokeColor);}}
updateToolButtonState();};var updateContextPanel=function(){var elem=selectedElement;var currentLayer=svgCanvas.getCurrentLayer();var currentMode=svgCanvas.getMode();if(currentMode=='rotate'&&elem!=null){var ang=svgCanvas.getRotationAngle(elem);$('#angle').val(ang);$('#tool_reorient').toggleClass('tool_button_disabled',ang==0);return;}
var is_node=elem?(elem.id&&elem.id.indexOf('pathpointgrip')==0):false;$('#selected_panel, #multiselected_panel, #g_panel, #rect_panel, #circle_panel,\
   #ellipse_panel, #line_panel, #text_panel, #image_panel').hide();if(elem!=null){var elname=elem.nodeName;var angle=svgCanvas.getRotationAngle(elem);$('#angle').val(angle);if(svgCanvas.addedNew){console.log(elname)
if(elname=='image'){}else if(elname=='text'){}}
if(!is_node&&currentMode!='pathedit'){$('#selected_panel').show();if($.inArray(elname,['line','circle','ellipse'])!=-1){$('#xy_panel').hide();}else{var x,y;if($.inArray(elname,['g','polyline','path'])!=-1){var bb=svgCanvas.getStrokedBBox([elem]);if(bb){x=bb.x;y=bb.y;}}else{x=elem.getAttribute('x');y=elem.getAttribute('y');}
$('#selected_x').val(x||0);$('#selected_y').val(y||0);$('#xy_panel').show();}
var no_path=$.inArray(elname,['image','text','path','g'])==-1;$('#tool_topath').toggle(no_path);$('#tool_reorient').toggle(elname=='path');$('#tool_reorient').toggleClass('tool_button_disabled',angle==0);}else{var point=path.getNodePoint();if(point){var seg_type=$('#seg_type');$('#path_node_x').val(point.x);$('#path_node_y').val(point.y);if(point.type){seg_type.val(point.type).removeAttr('disabled');}else{seg_type.val(4).attr('disabled','disabled');}}
return;}
var panels={g:[],rect:['rx','width','height'],image:['width','height'],circle:['cx','cy','r'],ellipse:['cx','cy','rx','ry'],line:['x1','y1','x2','y2'],text:[]};var el_name=elem.tagName;if(panels[el_name]){var cur_panel=panels[el_name];$('#'+el_name+'_panel').show();$.each(cur_panel,function(i,item){$('#'+el_name+'_'+item).val(elem.getAttribute(item)||0);});if(el_name=='text'){$('#text_panel').css("display","inline");if(svgCanvas.getItalic()){$('#tool_italic').addClass('tool_button_current');}
else{$('#tool_italic').removeClass('tool_button_current');}
if(svgCanvas.getBold()){$('#tool_bold').addClass('tool_button_current');}
else{$('#tool_bold').removeClass('tool_button_current');}
$('#font_family').val(elem.getAttribute("font-family"));$('#font_size').val(elem.getAttribute("font-size"));$('#text').val(elem.textContent);if(svgCanvas.addedNew){$('#text').focus().select();}}
else if(el_name=='image'){var xlinkNS="http://www.w3.org/1999/xlink";var href=elem.getAttributeNS(xlinkNS,"href");}}}
else if(multiselected){$('#multiselected_panel').show();}
if(svgCanvas.getUndoStackSize()>0){$('#tool_undo').removeClass('tool_button_disabled');}
else{$('#tool_undo').addClass('tool_button_disabled');}
if(svgCanvas.getRedoStackSize()>0){$('#tool_redo').removeClass('tool_button_disabled');}
else{$('#tool_redo').addClass('tool_button_disabled');}
svgCanvas.addedNew=false;if((elem&&!is_node)||multiselected){$('#selLayerNames').removeAttr('disabled').val(currentLayer);}
else{$('#selLayerNames').attr('disabled','disabled');}};$('#text').focus(function(){textBeingEntered=true;});$('#text').blur(function(){textBeingEntered=false;});svgCanvas.bind("selected",selectedChanged);svgCanvas.bind("changed",elementChanged);svgCanvas.bind("saved",saveHandler);svgCanvas.bind("zoomed",zoomChanged);var str='<div class="palette_item" data-rgb="none"></div>'
$.each(palette,function(i,item){str+='<div class="palette_item" style="background-color: '+item+';" data-rgb="'+item+'"></div>';});$('#palette').append(str);$('#palette .palette_item:first').css({'background':'transparent url("/vlewrapper/vle/node/draw/svg-edit-2.4rc1/images/no-color-item.png") center'});var color_blocks=['#FFF','#888','#000','url(data:image/gif;base64,R0lGODlhEAAQAIAAAP%2F%2F%2F9bW1iH5BAAAAAAALAAAAAAQABAAAAIfjG%2Bgq4jM3IFLJgpswNly%2FXkcBpIiVaInlLJr9FZWAQA7)'];var str='';$.each(color_blocks,function(){str+='<div class="color_block" style="background:'+this+';"></div>';});$('#bg_blocks').append(str);var blocks=$('#bg_blocks div');var cur_bg='cur_background';blocks.each(function(){var blk=$(this);blk.click(function(){blocks.removeClass(cur_bg);$(this).addClass(cur_bg);});});if($.pref('bg_color')){setBackground($.pref('bg_color'),$.pref('bg_url'));}
if($.pref('img_save')){curPrefs.img_save=$.pref('img_save');$('#image_save_opts input').val([curPrefs.img_save]);}
var pos=$('#tools_rect_show').position();$('#tools_rect').css({'left':pos.left+2,'top':pos.top+2});pos=$('#tools_ellipse_show').position();$('#tools_ellipse').css({'left':pos.left+2,'top':pos.top+2});var pos=$('#tool_image').position();$('#tools_stamps').css({'left':pos.left+40,'top':pos.top-38});var changeRectRadius=function(ctl){svgCanvas.setRectRadius(ctl.value);}
var changeFontSize=function(ctl){svgCanvas.setFontSize(ctl.value);}
var changeStrokeWidth=function(ctl){var val=ctl.value;if(val==0&&selectedElement&&$.inArray(selectedElement.nodeName,['line','polyline'])!=-1){val=ctl.value=1;}
svgCanvas.setStrokeWidth(val);}
var changeRotationAngle=function(ctl){svgCanvas.setRotationAngle(ctl.value);$('#tool_reorient').toggleClass('tool_button_disabled',ctl.value==0);}
var changeZoom=function(ctl){var zoomlevel=ctl.value/100;var zoom=svgCanvas.getZoom();var w_area=$('#workarea');zoomChanged(window,{width:0,height:0,x:(w_area[0].scrollLeft+w_area.width()/2)/zoom,y:(w_area[0].scrollTop+w_area.height()/2)/zoom,zoom:zoomlevel});}
$('#tool_snapshot, #close_snapshots').click(function(){var ctl={'value':75};if(!$('#sidepanels').is(':visible')){$('#draw_description').hide();$('#sidepanels').show();$('#snap_description').show();changeZoom(ctl);}else{$('#sidepanels').hide();$('#snap_description').hide();$('#draw_description').show();ctl.value=100;changeZoom(ctl);}});$('#show_description').click(function(){$('#draw_description').show();var ctl={'value':94};changeZoom(ctl);});$('#hide_description').click(function(){var ctl={'value':100};changeZoom(ctl);$('#draw_description').hide();});var changeOpacity=function(ctl,val){if(val==null)val=ctl.value;$('#group_opacity').val(val);if(!ctl||!ctl.handle){$('#opac_slider').slider('option','value',val);}
svgCanvas.setOpacity(val/100);}
$('#stroke_style').change(function(){svgCanvas.setStrokeStyle(this.options[this.selectedIndex].value);});$('select').change(function(){$(this).blur();});var promptMoveLayerOnce=false;$('#selLayerNames').change(function(){var destLayer=this.options[this.selectedIndex].value;var confirm_str=uiStrings.QmoveElemsToLayer.replace('%s',destLayer);var moveToLayer=function(ok){if(!ok)return;promptMoveLayerOnce=true;svgCanvas.moveSelectedToLayer(destLayer);svgCanvas.clearSelection();populateLayers();}
if(destLayer){if(promptMoveLayerOnce){moveToLayer(true);}else{$.confirm(confirm_str,moveToLayer);}}});$('#font_family').change(function(){svgCanvas.setFontFamily(this.value);});$('#seg_type').change(function(){svgCanvas.setSegType($(this).val());});$('#text').keyup(function(){svgCanvas.setTextContent(this.value);});$('#image_url').change(function(){setImageURL(this.value);});$('.attr_changer').change(function(){var attr=this.getAttribute("data-attr");var val=this.value;var valid=false;if($.inArray(attr,length_attrs)!=-1){if(!isNaN(val)){valid=true;}else{}}else valid=true;if(!valid){$.alert(uiStrings.invalidAttrValGiven);this.value=selectedElement.getAttribute(attr);return false;}
svgCanvas.changeSelectedAttribute(attr,val);});$('#palette').mouseover(function(){var inp=$('<input type="hidden">');$(this).append(inp);inp.focus().remove();});$('.palette_item').click(function(evt){var id;if(picker=='fill'){id='#fill_';}else{id='#stroke_';}
var color=$(this).attr('data-rgb');var paint=null;if(color=='transparent'||color=='initial'){color='none';$(id+"opacity").html("None");paint=new $.jGraduate.Paint();}
else{paint=new $.jGraduate.Paint({alpha:100,solidColor:color.substr(1)});}
if(color=='none'){$('#palette_preview').css({'background':'transparent url("/vlewrapper/vle/node/draw/svg-edit-2.4rc1/images/no-color.png") center'});}else{$('#palette_preview').css({'background':color});}
if(picker=='stroke'){strokePaint=paint;}else{fillPaint=paint;}});$('#palette_commit').click(function(){var rectbox=document.getElementById("gradbox_"+picker).parentNode.firstChild;var color=$('#palette_preview').css('background-color');if(picker=="stroke"){if(svgCanvas.getStrokeColor()!=color){svgCanvas.setStrokeColor(color);}
if(color!='none'&&svgCanvas.getStrokeOpacity()!=1){svgCanvas.setStrokeOpacity(1.0);}}else{if(svgCanvas.getFillColor()!=color){svgCanvas.setFillColor(color);}
if(color!='none'&&svgCanvas.getFillOpacity()!=1){svgCanvas.setFillOpacity(1.0);}}
rectbox.setAttribute("fill",color);updateToolButtonState();updateToolbar();$('#palette_holder').hide();});$('#palette_cancel').click(function(){$('#palette_holder').hide();});var toolButtonClick=function(button,fadeFlyouts){if($(button).hasClass('tool_button_disabled'))return false;var fadeFlyouts=fadeFlyouts||'normal';$('.tools_flyout').fadeOut(fadeFlyouts);if($(button).attr('id')!="tool_image"){$('.tools_select').fadeOut(fadeFlyouts);};$('#styleoverrides').text('');$('.tool_button_current').removeClass('tool_button_current').addClass('tool_button');$(button).addClass('tool_button_current');svgCanvas.clearSelection();svgCanvas.setOpacity(1);$('#opac_slider').slider('option','value',1);return true;};var addDropDown=function(elem,callback,dropUp){var button=$(elem).find('button');var list=$(elem).find('ul');var on_button=false;if(dropUp){$(elem).addClass('dropup');}
$(elem).find('li').bind('mouseup',callback);$().mouseup(function(evt){if(!on_button){button.removeClass('down');list.hide();}
on_button=false;});button.bind('mousedown',function(){if(!button.hasClass('down')){button.addClass('down');list.show();on_button=true;}else{button.removeClass('down');list.hide();}}).hover(function(){on_button=true;}).mouseout(function(){on_button=false;});}
addDropDown('#font_family_dropdown',function(){var fam=$(this).text();$('#font_family').val($(this).text()).change();});addDropDown('#opacity_dropdown',function(){if($(this).find('div').length)return;var perc=parseInt($(this).text().split('%')[0]);changeOpacity(false,perc);});$("#opac_slider").slider({start:function(){$('#opacity_dropdown li:not(.special)').hide();},stop:function(){$('#opacity_dropdown li').show();},slide:function(evt,ui){changeOpacity(ui);}});addDropDown('#zoom_dropdown',function(){var item=$(this);var val=item.attr('data-val');if(val){zoomChanged(window,val);}else{changeZoom({value:parseInt(item.text())});}},true);var setIcon=function(holder_sel,id){var icon=$.getSvgIcon(id).clone();var holder=$(holder_sel);icon[0].setAttribute('width',holder.width());icon[0].setAttribute('height',holder.height());holder.empty().append(icon);};var clickSelect=function(){if(toolButtonClick('#tool_select')){svgCanvas.setMode('select');$('#styleoverrides').text('#svgcanvas svg *{cursor:move;pointer-events:all}, #svgcanvas svg{cursor:default}');}};var clickFHPath=function(){if(toolButtonClick('#tool_fhpath')){svgCanvas.setMode('fhpath');}
$('#styleoverrides').text('#svgcanvas svg{cursor:crosshair}');};var clickLine=function(){if(toolButtonClick('#tool_line')){svgCanvas.setMode('line');}
$('#styleoverrides').text('#svgcanvas svg{cursor:crosshair}');};var clickSquare=function(){if(toolButtonClick('#tools_rect_show',flyoutspeed)){flyoutspeed='normal';svgCanvas.setMode('square');}
setIcon('#tools_rect_show','square');$('#styleoverrides').text('#svgcanvas svg{cursor:crosshair}');};var clickRect=function(){if(toolButtonClick('#tools_rect_show')){svgCanvas.setMode('rect');}
setIcon('#tools_rect_show','rect');$('#styleoverrides').text('#svgcanvas svg{cursor:crosshair}');};var clickFHRect=function(){if(toolButtonClick('#tools_rect_show')){svgCanvas.setMode('fhrect');}
setIcon('#tools_rect_show','fh_rect');$('#styleoverrides').text('#svgcanvas svg{cursor:crosshair}');};var clickCircle=function(){if(toolButtonClick('#tools_ellipse_show',flyoutspeed)){flyoutspeed='normal';svgCanvas.setMode('circle');}
setIcon('#tools_ellipse_show','circle');$('#styleoverrides').text('#svgcanvas svg{cursor:crosshair}');};var clickEllipse=function(){if(toolButtonClick('#tools_ellipse_show')){svgCanvas.setMode('ellipse');}
setIcon('#tools_ellipse_show','ellipse');$('#styleoverrides').text('#svgcanvas svg{cursor:crosshair}');};var clickFHEllipse=function(){if(toolButtonClick('#tools_ellipse_show')){svgCanvas.setMode('fhellipse');}
setIcon('#tools_ellipse_show','fh_ellipse');$('#styleoverrides').text('#svgcanvas svg{cursor:crosshair}');};var clickImage=function(){if(toolButtonClick('#tool_image')){svgCanvas.setMode('image');if($('#tools_stamps')){$('#tools_stamps').toggle();}
$('#styleoverrides').text('#svgcanvas svg{cursor:crosshair}');}};var clickZoom=function(){if(toolButtonClick('#tool_zoom')){$('#workarea').css('cursor','crosshair');svgCanvas.setMode('zoom');}};var dblclickZoom=function(){if(toolButtonClick('#tool_zoom')){zoomImage();setSelectMode();}};var clickText=function(){toolButtonClick('#tool_text');svgCanvas.setMode('text');svgCanvas.setOpacity(1);$('#styleoverrides').text('#svgcanvas svg{cursor:text}');};var clickPath=function(){toolButtonClick('#tool_path');svgCanvas.setMode('path');$('#styleoverrides').text('#svgcanvas svg{cursor:crosshair}');};var deleteSelected=function(){if(selectedElement!=null||multiselected){svgCanvas.deleteSelectedElements();}};var moveToTopSelected=function(){if(selectedElement!=null){svgCanvas.moveToTopSelectedElement();}};var moveToBottomSelected=function(){if(selectedElement!=null){svgCanvas.moveToBottomSelectedElement();}};var convertToPath=function(){if(selectedElement!=null){svgCanvas.convertToPath();}}
var reorientPath=function(){if(selectedElement!=null){path.reorient();}}
var moveSelected=function(dx,dy){if(selectedElement!=null||multiselected){svgCanvas.moveSelectedElements(dx,dy);}};var linkControlPoints=function(){$('#tool_node_link').toggleClass('push_button_pressed');var linked=$('#tool_node_link').hasClass('push_button_pressed');path.linkControlPoints(linked);}
var clonePathNode=function(){if(path.getNodePoint()){path.clonePathNode();}};var deletePathNode=function(){if(path.getNodePoint()){path.deletePathNode();}};var selectNext=function(){svgCanvas.cycleElement(1);}
var selectPrev=function(){svgCanvas.cycleElement(0);}
var rotateSelected=function(cw){if(selectedElement==null||multiselected)return;var step=5;if(!cw)step*=-1;var new_angle=$('#angle').val()*1+step;svgCanvas.setRotationAngle(new_angle);updateContextPanel();}
var clickClear=function(){$.confirm(uiStrings.QwantToClear,function(ok){if(!ok)return;svgCanvas.clear();svgCanvas.setResolution(600,450);zoomImage();populateLayers();updateContextPanel();});};var clickBold=function(){svgCanvas.setBold(!svgCanvas.getBold());updateContextPanel();};var clickItalic=function(){svgCanvas.setItalic(!svgCanvas.getItalic());updateContextPanel();};var clickSave=function(){var saveOpts={'images':curPrefs.img_save,'round_digits':6}
svgCanvas.save(saveOpts);};var clickOpen=function(){svgCanvas.open();};var clickUndo=function(){if(svgCanvas.getUndoStackSize()>0){svgCanvas.undo();populateLayers();}};var clickRedo=function(){if(svgCanvas.getRedoStackSize()>0){svgCanvas.redo();populateLayers();}};var clickGroup=function(){if(multiselected){svgCanvas.groupSelectedElements();}
else if(selectedElement&&selectedElement.tagName=='g'){svgCanvas.ungroupSelectedElement();}};var clickClone=function(){svgCanvas.cloneSelectedElements();};var clickAlign=function(){var letter=this.id.replace('tool_align','').charAt(0);svgCanvas.alignSelectedElements(letter,$('#align_relative_to').val());};var zoomImage=function(multiplier){var res=svgCanvas.getResolution();multiplier=multiplier?res.zoom*multiplier:1;setResolution(res.w*multiplier,res.h*multiplier,true);$('#zoom').val(multiplier*100);svgCanvas.setZoom(multiplier);zoomDone();};var zoomDone=function(){updateBgImage();updateWireFrame();};var clickWireframe=function(){$('#tool_wireframe').toggleClass('push_button_pressed');$('#workarea').toggleClass('wireframe');if(supportsNonSS)return;var wf_rules=$('#wireframe_rules');if(!wf_rules.length){wf_rules=$('<style id="wireframe_rules"><\/style>').appendTo('head');}else{wf_rules.empty();}
updateWireFrame();};var updateWireFrame=function(){if(supportsNonSS)return;var rule="#workarea.wireframe #svgcontent * { stroke-width: "+1/svgCanvas.getZoom()+"px; }";$('#wireframe_rules').text($('#workarea').hasClass('wireframe')?rule:"");};var showSourceEditor=function(){if(editingsource)return;editingsource=true;var str=svgCanvas.getSvgString();$('#svg_source_textarea').val(str);$('#svg_source_editor').fadeIn();properlySourceSizeTextArea();$('#svg_source_textarea').focus();};$('#svg_docprops_container').draggable({cancel:'button,fieldset'});var showDocProperties=function(){if(docprops)return;docprops=true;$('#image_save_opts input').val([curPrefs.img_save]);var res=svgCanvas.getResolution();$('#canvas_width').val(res.w);$('#canvas_height').val(res.h);$('#canvas_title').val(svgCanvas.getImageTitle());var blocks=$('#bg_blocks div');var cur_bg='cur_background';var canvas_bg=$('#svgcanvas').css('background');var url=canvas_bg.match(/url\("?(.*?)"?\)/);if(url)url=url[1];blocks.each(function(){var blk=$(this);var is_bg=blk.css('background')==canvas_bg;blk.toggleClass(cur_bg,is_bg);if(is_bg)$('#canvas_bg_url').removeClass(cur_bg);});if(!canvas_bg)blocks.eq(0).addClass(cur_bg);if(!$('#bg_blocks .'+cur_bg).length&&url){$('#canvas_bg_url').val(url);}
$('#svg_docprops').fadeIn();};var properlySourceSizeTextArea=function(){var height=$('#svg_source_container').height()-80;$('#svg_source_textarea').css('height',height);};var saveSourceEditor=function(){if(!editingsource)return;var saveChanges=function(){svgCanvas.clearSelection();hideSourceEditor();zoomImage();populateLayers();setTitle(svgCanvas.getImageTitle());}
if(!svgCanvas.setSvgString($('#svg_source_textarea').val())){$.confirm(uiStrings.QerrorsRevertToSource,function(ok){if(!ok)return false;saveChanges();});}else{saveChanges();}
setSelectMode();};var setTitle=function(title){var editor_title=$('title:first').text().split(':')[0];var new_title=editor_title+(title?': '+title:'');$('title:first').text(new_title);}
var saveDocProperties=function(){var new_title=$('#canvas_title').val();setTitle(new_title);svgCanvas.setImageTitle(new_title);var x=parseInt($('#canvas_width').val());var y=parseInt($('#canvas_height').val());if(isNaN(x)||isNaN(y)){x='fit';}
if(!svgCanvas.setResolution(x,y)){$.alert(uiStrings.noContentToFitTo);return false;}
curPrefs.img_save=$('#image_save_opts :checked').val();$.pref('img_save',curPrefs.img_save);var color=$('#bg_blocks div.cur_background').css('background')||'#FFF';setBackground(color,$('#canvas_bg_url').val());var lang=$('#lang_select').val();if(lang!=curPrefs.lang){put_locale(svgCanvas,lang);}
setIconSize($('#iconsize').val());hideDocProperties();};function setBackground(color,url){if(color==curPrefs.bg_color&&url==curPrefs.bg_url)return;$.pref('bg_color',color);$.pref('bg_url',url);$('#svgcanvas').css('background',color);if(url){if(!$('#background_img').length){$('<div id="background_img"><img src="'+url+'" style="width:100%"></div>').prependTo('#svgcanvas');}else{$('#background_img img').attr('src',url);}}else{$('#background_img').remove();}}
var setIconSize=function(size){if(size==curPrefs.size)return;$.pref('iconsize',size);$('#iconsize').val(size);var icon_sizes={s:16,m:24,l:32,xl:48};var size_num=icon_sizes[size];$('.tool_button, .push_button, .tool_button_current, .tool_button_disabled, .tool_flyout_button, #url_notice').find('> svg, > img').each(function(){this.setAttribute('width',size_num);this.setAttribute('height',size_num);});$.resizeSvgIcons({'.flyout_arrow_horiz svg, .flyout_arrow_horiz img':size_num/3,'#logo a > svg, #logo a > img':size_num*1.3});if(size!='s'){$.resizeSvgIcons({'#layerbuttons svg, #layerbuttons img':size_num*.6});}
var cssResizeRules={".tool_button,\
   .push_button,\
   .tool_button_current,\
   .tool_button_disabled,\
   #tools_rect .tool_flyout_button,\
   #tools_ellipse .tool_flyout_button":{'width':{s:'16px',l:'32px',xl:'48px'},'height':{s:'16px',l:'32px',xl:'48px'},'padding':{s:'1px',l:'2px',xl:'3px'}},".tool_sep":{'height':{s:'16px',l:'32px',xl:'48px'},'margin':{s:'2px 2px',l:'2px 5px',xl:'2px 8px'}},"#tools_top":{'left':{s:'27px',l:'50px',xl:'70px'},'height':{s:'50px',l:'88px',xl:'125px'}},"#tools_left":{'width':{s:'26px',l:'34px',xl:'42px'},'top':{s:'50px',l:'87px',xl:'125px'}},"div#workarea":{'left':{s:'27px',l:'46px',xl:'65px'},'top':{s:'50px',l:'88px',xl:'125px'},'bottom':{s:'51px',l:'68px',xl:'75px'}},"#tools_bottom":{'left':{s:'27px',l:'46px',xl:'65px'},'height':{s:'52px',l:'68px',xl:'75px'}},"#tools_top input, #tools_bottom input":{'margin-top':{s:'2px',l:'4px',xl:'5px'},'height':{s:'auto',l:'auto',xl:'auto'},'border':{s:'1px solid #555',l:'auto',xl:'auto'},'font-size':{s:'.9em',l:'2em',xl:'2.5em'}},"#zoom_panel":{'margin-top':{s:'3px',l:'4px',xl:'5px'}},"#copyright, #tools_bottom .label":{'font-size':{l:'1.5em',xl:'2em'},'line-height':{s:'15px'}},"#tools_bottom_2":{'width':{l:'295px',xl:'355px'}},"#tools_top > div, #tools_top":{'line-height':{s:'17px',l:'34px',xl:'50px'}},"div.toolset":{'height':{s:'25px',l:'43px',xl:'64px'}},".dropdown button":{'height':{s:'18px',l:'34px',xl:'40px'},'line-height':{s:'18px',l:'34px',xl:'40px'},'margin-top':{s:'3px'}},"#tools_top label, #tools_bottom label":{'font-size':{s:'1em',l:'1.5em',xl:'2em'},'margin-top':{s:'1px',l:'3px',xl:'5px'}},"#tool_bold, #tool_italic":{'font-size':{s:'1.5em',l:'3em',xl:'4.5em'}},"#sidepanels":{'top':{s:'50px',l:'88px',xl:'125px'},'bottom':{s:'51px',l:'68px',xl:'65px'}},'#layerbuttons':{'width':{l:'130px',xl:'175px'},'height':{l:'24px',xl:'30px'}},'#layerlist':{'width':{l:'128px',xl:'150px'}},'.layer_button':{'width':{l:'19px',xl:'28px'},'height':{l:'19px',xl:'28px'}},".flyout_arrow_horiz":{'left':{s:'-5px',l:'5px',xl:'14px'},'top':{s:'-13px',l:'-13px',xl:'-20px'}},"input.spin-button":{'background-image':{l:"url('images/spinbtn_updn_big.png')",xl:"url('images/spinbtn_updn_big.png')"},'background-position':{l:'100% -5px',xl:'100% -2px'},'padding-right':{l:'24px',xl:'24px'}},"input.spin-button.up":{'background-position':{l:'100% -45px',xl:'100% -42px'}},"input.spin-button.down":{'background-position':{l:'100% -85px',xl:'100% -82px'}}};var rule_elem=$('#tool_size_rules');if(!rule_elem.length){rule_elem=$('<style id="tool_size_rules"><\/style>').appendTo('head');}else{rule_elem.empty();}
if(size!='m'){var style_str='';$.each(cssResizeRules,function(selector,rules){selector='#svg_editor '+selector.replace(/,/g,', #svg_editor');style_str+=selector+'{';$.each(rules,function(prop,values){if(values[size]){style_str+=(prop+':'+values[size]+';');}});style_str+='}';});rule_elem.text(style_str);}
var pos=$('#tools_rect_show').offset();$('#tools_rect').css({'left':pos.left,'top':pos.top});pos=$('#tools_ellipse_show').offset();$('#tools_ellipse').css({'left':pos.left,'top':pos.top});}
var cancelOverlays=function(){$('#dialog_box').hide();if(!editingsource&&!docprops)return;if(editingsource){var oldString=svgCanvas.getSvgString();if(oldString!=$('#svg_source_textarea').val()){$.confirm(uiStrings.QignoreSourceChanges,function(ok){if(ok)hideSourceEditor();});}else{hideSourceEditor();}}
else if(docprops){hideDocProperties();}};var hideSourceEditor=function(){$('#svg_source_editor').hide();editingsource=false;$('#svg_source_textarea').blur();};var hideDocProperties=function(){$('#svg_docprops').hide();$('#canvas_width,#canvas_height').removeAttr('disabled');$('#resolution')[0].selectedIndex=0;$('#image_save_opts input').val([curPrefs.img_save]);docprops=false;};$(window).resize(function(evt){if(!editingsource)return;properlySourceSizeTextArea();});$('#url_notice').click(function(){$.alert(this.title);});$('#change_image_url').click(promptImgURL);function promptImgURL(){$.prompt(uiStrings.enterNewImgURL,default_img_url,function(url){if(url)setImageURL(url);});}
function setImageURL(url){if(!url)url=default_img_url;svgCanvas.setImageURL(url);$('#image_url').val(url);if(url.indexOf('data:')===0){$('#image_url').hide();$('#change_image_url').show();}else{svgCanvas.embedImage(url,function(datauri){if(!datauri){$('#url_notice').show();}else{$('#url_notice').hide();}
default_img_url=url;});$('#image_url').show();$('#change_image_url').hide();}}
(function(){var toolnames=['clear','open','save','source','delete','delete_multi','paste','clone','clone_multi','move_top','move_bottom'];var all_tools='';var cur_class='tool_button_current';$.each(toolnames,function(i,item){all_tools+='#tool_'+item+(i==toolnames.length-1?',':'');});$(all_tools).mousedown(function(){$(this).addClass(cur_class);}).bind('mousedown mouseout',function(){$(this).removeClass(cur_class);});$('#tool_undo, #tool_redo').mousedown(function(){if(!$(this).hasClass('tool_button_disabled'))$(this).addClass(cur_class);}).bind('mousedown mouseout',function(){$(this).removeClass(cur_class);});}());$('#workarea').bind("mousewheel DOMMouseScroll",function(e){if(!e.shiftKey)return;e.preventDefault();var off=$('#svgcanvas').offset();var zoom=svgCanvas.getZoom();var bbox={'x':(e.pageX-off.left)/zoom,'y':(e.pageY-off.top)/zoom,'width':0,'height':0};if(e.wheelDelta){if(e.wheelDelta>=120){bbox.factor=2;}else if(e.wheelDelta<=-120){bbox.factor=.5;}}else if(e.detail){if(e.detail>0){bbox.factor=.5;}else if(e.detail<0){bbox.factor=2;}}
if(!bbox.factor)return;zoomChanged(window,bbox);});if(isMac){var shortcutButtons=["tool_clear","tool_save","tool_source","tool_undo","tool_redo","tool_clone"];var i=shortcutButtons.length;while(i--){var button=document.getElementById(shortcutButtons[i]);var title=button.title;var index=title.indexOf("Ctrl+");button.title=[title.substr(0,index),"Cmd+",title.substr(index+5)].join('');}}
var colorPicker=function(elem){var picker=elem.attr('id')=='stroke_color'?'stroke':'fill';var opacity=(picker=='stroke'?$('#stroke_opacity'):$('#fill_opacity'));var paint=(picker=='stroke'?strokePaint:fillPaint);var title=(picker=='stroke'?'Pick a Stroke Paint and Opacity':'Pick a Fill Paint and Opacity');var was_none=false;if(paint.type=="none"){paint=new $.jGraduate.Paint({solidColor:'ffffff'});was_none=true;}
var pos=elem.position();$("#color_picker").draggable({cancel:'.jPicker_table,.jGraduate_lgPick'}).css({'left':pos.left,'bottom':50-pos.top}).jGraduate({paint:paint,window:{pickerTitle:title},images:{clientPath:"jgraduate/images/"}},function(p){paint=new $.jGraduate.Paint(p);var oldgrad=document.getElementById("gradbox_"+picker);var svgbox=oldgrad.parentNode;var rectbox=svgbox.firstChild;if(paint.type=="linearGradient"){svgbox.removeChild(oldgrad);var newgrad=svgbox.appendChild(document.importNode(paint.linearGradient,true));svgCanvas.fixOperaXML(newgrad,paint.linearGradient)
newgrad.id="gradbox_"+picker;rectbox.setAttribute("fill","url(#gradbox_"+picker+")");}
else{rectbox.setAttribute("fill","#"+paint.solidColor);}
opacity.html(paint.alpha+" %");if(picker=='stroke'){svgCanvas.setStrokePaint(paint,true);}
else{svgCanvas.setFillPaint(paint,true);}
updateToolbar();$('#color_picker').hide();},function(p){$('#color_picker').hide();});};var updateToolButtonState=function(){var bNoFill=(svgCanvas.getFillColor()=='none');var bNoStroke=(svgCanvas.getStrokeColor()=='none');var buttonsNeedingStroke=['#tool_path','#tool_line'];var buttonsNeedingFillAndStroke=['#tools_rect_show','#tools_ellipse_show','#tool_text'];if(bNoStroke){for(index in buttonsNeedingStroke){var button=buttonsNeedingStroke[index];if($(button).hasClass('tool_button_current')){clickSelect();}
$(button).removeClass('tool_button').addClass('tool_button_disabled');}}
else{for(index in buttonsNeedingStroke){var button=buttonsNeedingStroke[index];$(button).removeClass('tool_button_disabled').addClass('tool_button');}}
if(bNoStroke&&bNoFill){for(index in buttonsNeedingFillAndStroke){var button=buttonsNeedingFillAndStroke[index];if($(button).hasClass('tool_button_current')){clickSelect();}
$(button).removeClass('tool_button').addClass('tool_button_disabled');}}
else{for(index in buttonsNeedingFillAndStroke){var button=buttonsNeedingFillAndStroke[index];$(button).removeClass('tool_button_disabled').addClass('tool_button');}}
if(window.opera){$('<p/>').hide().appendTo('body').remove();}};var svgdocbox=new DOMParser().parseFromString('<svg xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="#FF0000"/>\
  <linearGradient id="gradbox_">\
    <stop stop-color="#000" offset="0.0"/>\
    <stop stop-color="#FF0000" offset="1.0"/>\
  </linearGradient></svg>','text/xml');var boxgrad=svgdocbox.getElementById('gradbox_');boxgrad.id='gradbox_fill';svgdocbox.documentElement.setAttribute('width',26.5);$('#fill_color').append(document.importNode(svgdocbox.documentElement,true));boxgrad.id='gradbox_stroke';svgdocbox.documentElement.setAttribute('width',26.5);$(svgdocbox.documentElement.firstChild).attr('fill','#000000');$('#stroke_color').append(document.importNode(svgdocbox.documentElement,true));var test_el=svgdocbox.documentElement.firstChild;test_el.setAttribute('style','vector-effect:non-scaling-stroke');var supportsNonSS=(test_el.style.vectorEffect=='non-scaling-stroke');test_el.removeAttribute('style');setTimeout(function(){svgCanvas.embedImage('images/logo.png',function(datauri){if(!datauri){$('#image_save_opts [value=embed]').attr('disabled','disabled');$('#image_save_opts input').val(['ref']);curPrefs.img_save='ref';$('#image_opt_embed').css('color','#666').attr('title',uiStrings.featNotSupported);}});},1000);$('#fill_color').click(function(){picker="fill";var color=svgCanvas.getFillColor();$('#palette_preview').css({'background-color':color});var pos=$('#fill_color').position();$('#palette_holder').css({'left':pos.left+26,'top':pos.top-272});$('#palette_holder').show();updateToolButtonState();});$('#stroke_color').click(function(){picker="stroke";var color=svgCanvas.getStrokeColor();$('#palette_preview').css({'background-color':color});var pos=$('#stroke_color').position();$('#palette_holder').css({'left':pos.left+26,'top':pos.top-272});$('#palette_holder').show();updateToolButtonState();});$('#tools_rect_show').mousedown(function(evt){$('#tools_rect').show();evt.preventDefault();});$('#tools_rect').mouseleave(function(){$('#tools_rect').fadeOut();});$('#tool_move_top').mousedown(function(evt){$('#tools_stacking').show();evt.preventDefault();});$('#tools_ellipse_show').mousedown(function(evt){$('#tools_ellipse').show();evt.preventDefault();});$('#tools_ellipse').mouseleave(function(){$('#tools_ellipse').fadeOut();});$('.tool_flyout_button').mouseover(function(){$(this).addClass('tool_flyout_button_current');}).mouseout(function(){$(this).removeClass('tool_flyout_button_current');});$('.layer_button').mousedown(function(){$(this).addClass('layer_buttonpressed');}).mouseout(function(){$(this).removeClass('layer_buttonpressed');}).mouseup(function(){$(this).removeClass('layer_buttonpressed');});$('.push_button').mousedown(function(){if(!$(this).hasClass('tool_button_disabled')){$(this).addClass('push_button_pressed');}}).mouseout(function(){$(this).removeClass('push_button_pressed');}).mouseup(function(){$(this).removeClass('push_button_pressed');});$('#layer_new').click(function(){var curNames=new Array(svgCanvas.getNumLayers());for(var i=0;i<curNames.length;++i){curNames[i]=svgCanvas.getLayer(i);}
var j=(curNames.length+1);var uniqName=uiStrings.layer+" "+j;while($.inArray(uniqName,curNames)!=-1){j++;uniqName=uiStrings.layer+" "+j;}
$.prompt(uiStrings.enterUniqueLayerName,uniqName,function(newName){if(!newName)return;if($.inArray(newName,curNames)!=-1){$.alert(uiStrings.dupeLayerName);return;}
svgCanvas.createLayer(newName);updateContextPanel();populateLayers();$('#layerlist tr.layer').removeClass("layersel");$('#layerlist tr.layer:first').addClass("layersel");});});$('#layer_delete').click(function(){if(svgCanvas.deleteCurrentLayer()){updateContextPanel();populateLayers();$('#layerlist tr.layer').removeClass("layersel");$('#layerlist tr.layer:first').addClass("layersel");}});$('#layer_up').click(function(){var curIndex=$('#layerlist tr.layersel').prevAll().length;if(curIndex>0){var total=$('#layerlist tr.layer').length;curIndex--;svgCanvas.setCurrentLayerPosition(total-curIndex-1);populateLayers();$('#layerlist tr.layer').removeClass("layersel");$('#layerlist tr.layer:eq('+curIndex+')').addClass("layersel");}});$('#layer_down').click(function(){var curIndex=$('#layerlist tr.layersel').prevAll().length;var total=$('#layerlist tr.layer').length;if(curIndex<total-1){curIndex++;svgCanvas.setCurrentLayerPosition(total-curIndex-1);populateLayers();$('#layerlist tr.layer').removeClass("layersel");$('#layerlist tr.layer:eq('+curIndex+')').addClass("layersel");}});$('#layer_rename').click(function(){var curIndex=$('#layerlist tr.layersel').prevAll().length;var oldName=$('#layerlist tr.layersel td.layername').text();$.prompt(uiStrings.enterNewLayerName,"",function(newName){if(!newName)return;if(oldName==newName){$.alert(uiStrings.layerHasThatName);return;}
var curNames=new Array(svgCanvas.getNumLayers());for(var i=0;i<curNames.length;++i){curNames[i]=svgCanvas.getLayer(i);}
if($.inArray(newName,curNames)!=-1){$.alert(uiStrings.layerHasThatName);return;}
svgCanvas.renameCurrentLayer(newName);populateLayers();$('#layerlist tr.layer').removeClass("layersel");$('#layerlist tr.layer:eq('+curIndex+')').addClass("layersel");});});var SIDEPANEL_MAXWIDTH=300;var SIDEPANEL_OPENWIDTH=150;var sidedrag=-1,sidedragging=false;$('#svgcanvas').mousedown(function(){$("#tools_stamps").hide();if(svgCanvas.getMode()=='multiselect'){$('#fill_opacity').html("");$('#stroke_opacity').html("");}});$('#svg_editor').mouseup(function(){sidedrag=-1;}).mouseout(function(evt){if(sidedrag==-1)return;if(evt.pageX>this.clientWidth){sidedrag=-1;toggleSidePanel(true);}}).mousemove(function(evt){if(sidedrag==-1)return;sidedragging=true;var deltax=sidedrag-evt.pageX;var sidepanels=$('#sidepanels');var sidewidth=parseInt(sidepanels.css('width'));if(sidewidth+deltax>SIDEPANEL_MAXWIDTH){deltax=SIDEPANEL_MAXWIDTH-sidewidth;sidewidth=SIDEPANEL_MAXWIDTH;}
else if(sidewidth+deltax<2){deltax=2-sidewidth;sidewidth=2;}
if(deltax==0)return;sidedrag-=deltax;var workarea=$('#workarea');var layerpanel=$('#layerpanel');workarea.css('right',parseInt(workarea.css('right'))+deltax);sidepanels.css('width',parseInt(sidepanels.css('width'))+deltax);layerpanel.css('width',parseInt(layerpanel.css('width'))+deltax);centerCanvasIfNeeded();});var toggleSidePanel=function(close){var w=parseInt($('#sidepanels').css('width'));var deltax=(w>2||close?2:SIDEPANEL_OPENWIDTH)-w;var workarea=$('#workarea');var sidepanels=$('#sidepanels');var layerpanel=$('#layerpanel');workarea.css('right',parseInt(workarea.css('right'))+deltax);sidepanels.css('width',parseInt(sidepanels.css('width'))+deltax);layerpanel.css('width',parseInt(layerpanel.css('width'))+deltax);centerCanvasIfNeeded();};var toggleHighlightLayer=function(layerNameToHighlight){var curNames=new Array(svgCanvas.getNumLayers());for(var i=0;i<curNames.length;++i){curNames[i]=svgCanvas.getLayer(i);}
if(layerNameToHighlight){for(var i=0;i<curNames.length;++i){if(curNames[i]!=layerNameToHighlight){svgCanvas.setLayerOpacity(curNames[i],0.5);}}}
else{for(var i=0;i<curNames.length;++i){svgCanvas.setLayerOpacity(curNames[i],1.0);}}};var populateLayers=function(){var layerlist=$('#layerlist tbody');var selLayerNames=$('#selLayerNames');layerlist.empty();selLayerNames.empty();var currentlayer=svgCanvas.getCurrentLayer();var layer=svgCanvas.getNumLayers();var icon=$.getSvgIcon('eye');while(layer--){var name=svgCanvas.getLayer(layer);var appendstr="<tr class=\"layer";if(name==currentlayer){appendstr+=" layersel"}
appendstr+="\">";if(svgCanvas.getLayerVisibility(name)){appendstr+="<td class=\"layervis\"/><td class=\"layername\" >"+name+"</td></tr>";}
else{appendstr+="<td class=\"layervis layerinvis\"/><td class=\"layername\" >"+name+"</td></tr>";}
layerlist.append(appendstr);selLayerNames.append("<option value=\""+name+"\">"+name+"</option>");}
if(icon!==undefined){var copy=icon.clone();$('td.layervis',layerlist).append(icon.clone());$.resizeSvgIcons({'td.layervis .svg_icon':14});}
$('#layerlist td.layername').click(function(evt){$('#layerlist tr.layer').removeClass("layersel");var row=$(this.parentNode);row.addClass("layersel");svgCanvas.setCurrentLayer(this.textContent);evt.preventDefault();}).mouseover(function(evt){$(this).css({"font-style":"italic","color":"blue"});toggleHighlightLayer(this.textContent);}).mouseout(function(evt){$(this).css({"font-style":"normal","color":"black"});toggleHighlightLayer();});$('#layerlist td.layervis').click(function(evt){var row=$(this.parentNode).prevAll().length;var name=$('#layerlist tr.layer:eq('+row+') td.layername').text();var vis=$(this).hasClass('layerinvis');svgCanvas.setLayerVisibility(name,vis);if(vis){$(this).removeClass('layerinvis');}
else{$(this).addClass('layerinvis');}});var num=5-$('#layerlist tr.layer').size();while(num-->0){layerlist.append("<tr><td style=\"color:white\">_</td><td/></tr>");}};populateLayers();function changeResolution(x,y){var zoom=svgCanvas.getResolution().zoom;setResolution(x*zoom,y*zoom);}
var centerCanvasIfNeeded=function(){var wa={w:parseInt($('#workarea').css('width')),h:parseInt($('#workarea').css('height'))};var ca={w:parseInt($('#svgcanvas').css('width')),h:parseInt($('#svgcanvas').css('height'))};if(wa.w>ca.w){$('#svgcanvas').css({'left':(wa.w-ca.w)/2});}
if(wa.h>ca.h){$('#svgcanvas').css({'top':(wa.h-ca.h)/2});}};$(window).resize(centerCanvasIfNeeded);function stepFontSize(elem,step){var orig_val=elem.value-0;var sug_val=orig_val+step;var increasing=sug_val>=orig_val;if(step===0)return orig_val;if(orig_val>=24){if(increasing){return Math.round(orig_val*1.1);}else{return Math.round(orig_val/1.1);}}else if(orig_val<=1){if(increasing){return orig_val*2;}else{return orig_val/2;}}else{return sug_val;}}
function stepZoom(elem,step){var orig_val=elem.value-0;if(orig_val===0)return 100;var sug_val=orig_val+step;if(step===0)return orig_val;if(orig_val>=100){return sug_val;}else{if(sug_val>=orig_val){return orig_val*2;}else{return orig_val/2;}}}
function setResolution(w,h,center){w-=0;h-=0;$('#svgcanvas').css({'width':w,'height':h});$('#canvas_width').val(w);$('#canvas_height').val(h);centerCanvasIfNeeded();if(center){var w_area=$('#workarea');var scroll_y=h/2-w_area.height()/2;var scroll_x=w/2-w_area.width()/2;w_area[0].scrollTop=scroll_y;w_area[0].scrollLeft=scroll_x;}}
$('#resolution').change(function(){var wh=$('#canvas_width,#canvas_height');if(!this.selectedIndex){if($('#canvas_width').val()=='fit'){wh.removeAttr("disabled").val(100);}}else if(this.value=='content'){wh.val('fit').attr("disabled","disabled");}else{var dims=this.value.split('x');$('#canvas_width').val(dims[0]);$('#canvas_height').val(dims[1]);wh.removeAttr("disabled");}});$('input,select').attr("autocomplete","off");var Actions=function(){var tool_buttons=[{sel:'#tool_select',fn:clickSelect,evt:'click',key:1},{sel:'#tool_fhpath',fn:clickFHPath,evt:'click',key:2},{sel:'#tool_line',fn:clickLine,evt:'click',key:3},{sel:'#tool_square',fn:clickSquare,evt:'mouseup',key:'Shift+4'},{sel:'#tool_rect',fn:clickRect,evt:'mouseup',key:4},{sel:'#tool_circle',fn:clickCircle,evt:'mouseup',key:'Shift+5'},{sel:'#tool_ellipse',fn:clickEllipse,evt:'mouseup',key:5},{sel:'#tool_path',fn:clickPath,evt:'click',key:6},{sel:'#tool_text',fn:clickText,evt:'click',key:7},{sel:'#tool_image',fn:clickImage,evt:'mouseup',key:8},{sel:'#tool_source',fn:showSourceEditor,evt:'click',key:['U',true]},{sel:'#tool_source_cancel,#svg_source_overlay,#tool_docprops_cancel',fn:cancelOverlays,evt:'click',key:['esc',false,false],hidekey:true},{sel:'#tool_delete,#tool_delete_multi',fn:deleteSelected,evt:'click',key:['del/backspace',true]},{sel:'#tool_reorient',fn:reorientPath,evt:'click'},{sel:'#tool_node_link',fn:linkControlPoints,evt:'click'},{sel:'#tool_node_clone',fn:clonePathNode,evt:'click'},{sel:'#tool_node_delete',fn:deletePathNode,evt:'click'},{sel:'#tool_move_top',fn:moveToTopSelected,evt:'click',key:'shift+up'},{sel:'#tool_move_bottom',fn:moveToBottomSelected,evt:'click',key:'shift+down'},{sel:'#tool_topath',fn:convertToPath,evt:'click'},{sel:'#tool_undo',fn:clickUndo,evt:'click'},{sel:'#tool_redo',fn:clickRedo,evt:'click'},{sel:'#tool_clone,#tool_clone_multi',fn:clickClone,evt:'click'},{sel:'#tool_group',fn:clickGroup,evt:'click',key:[modKey+'G',true]},{sel:'#tool_ungroup',fn:clickGroup,evt:'click'},{sel:'[id^=tool_align]',fn:clickAlign,evt:'click'},{sel:'#tools_rect_show',fn:clickRect,evt:'click'},{sel:'#tools_ellipse_show',fn:clickEllipse,evt:'click'},{sel:'#tool_bold',fn:clickBold,evt:'mousedown'},{sel:'#tool_italic',fn:clickItalic,evt:'mousedown'},{key:'shift+left',fn:function(){rotateSelected(0)}},{key:'shift+right',fn:function(){rotateSelected(1)}},{key:'shift+O',fn:selectPrev},{key:'shift+P',fn:selectNext},{key:'shift+M',fn:function(){return;}},{key:['up',true],fn:function(){moveSelected(0,-1);}},{key:['down',true],fn:function(){moveSelected(0,1);}},{key:['left',true],fn:function(){moveSelected(-1,0);}},{key:['right',true],fn:function(){moveSelected(1,0);}}];var key_assocs={'4/Shift+4':'#tools_rect_show','5/Shift+5':'#tools_ellipse_show'};return{setAll:function(){$.each(tool_buttons,function(i,opts){if(opts.sel){var btn=$(opts.sel);if(opts.evt){btn[opts.evt](opts.fn);}}
if(opts.key){var keyval,shortcut='',disInInp=true,fn=opts.fn,pd=false;if($.isArray(opts.key)){keyval=opts.key[0];if(opts.key.length>1)pd=opts.key[1];if(opts.key.length>2)disInInp=opts.key[2];}else{keyval=opts.key;}
keyval+='';$.each(keyval.split('/'),function(i,key){$(document).bind('keydown',{combi:key,disableInInput:disInInp},function(e){fn();if(pd){e.preventDefault();}
return false;});});if(opts.sel&&!opts.hidekey){var new_title=btn.attr('title').split('[')[0]+'['+keyval+']';key_assocs[keyval]=opts.sel;btn.attr('title',new_title);}}});$('.attr_changer, #image_url').bind('keydown',{combi:'return'},function(evt){$(this).change();evt.preventDefault();});$('#tool_zoom').dblclick(dblclickZoom);},setTitles:function(){$.each(key_assocs,function(keyval,sel){$(sel).each(function(){var t=this.title.split(' [')[0];var key_str='';$.each(keyval.split('/'),function(i,key){var mod_bits=key.split('+'),mod='';if(mod_bits.length>1){mod=mod_bits[0]+'+';key=mod_bits[1];}
key_str+=(i?'/':'')+mod+(uiStrings['key_'+key]||key);});this.title=t+' ['+key_str+']';});});}};}();Actions.setAll();$('#rect_rx').SpinButton({min:0,max:1000,step:1,callback:changeRectRadius});$('#stroke_width').SpinButton({min:0,max:99,step:1,callback:changeStrokeWidth});$('#angle').SpinButton({min:-180,max:180,step:5,callback:changeRotationAngle});$('#font_size').SpinButton({step:1,min:0.001,stepfunc:stepFontSize,callback:changeFontSize});$('#group_opacity').SpinButton({step:5,min:0,max:100,callback:changeOpacity});$('#zoom').SpinButton({min:0.001,max:10000,step:50,stepfunc:stepZoom,callback:changeZoom});svgCanvas.setIconSize=setIconSize;svgCanvas.setLang=function(lang,strings){curPrefs.lang=lang;$.pref('lang',lang);$('#lang_select').val(lang);if(strings){var oldLayerName=$('#layerlist tr.layersel td.layername').text();var rename_layer=(oldLayerName==uiStrings.layer+' 1');$.extend(uiStrings,strings);svgCanvas.setUiStrings(strings);Actions.setTitles();if(rename_layer){svgCanvas.renameCurrentLayer(uiStrings.layer+' 1');populateLayers();}}};svgCanvas.setCustomHandlers=function(opts){if(opts.open){$('#tool_open').show();svgCanvas.bind("opened",opts.open);}
if(opts.save){svgCanvas.bind("saved",opts.save);}}
setResolution(600,450);$('#descriptionpanel').draggable({containment:'window'});return svgCanvas;};(function(){$.svgIcons('/vlewrapper/vle/node/draw/svg-edit-2.4rc1/images/svg_edit_icons.svg',{w:24,h:24,id_match:false,no_img:false,fallback_path:'/vlewrapper/vle/node/draw/svg-edit-2.4rc1/images/',fallback:{'new_image':'clear.png','save':'save.png','open':'open.png','source':'source.png','docprops':'document-properties.png','wireframe':'wireframe.png','undo':'undo.png','redo':'redo.png','select':'select.png','select_node':'select_node.png','pencil':'fhpath.png','pen':'line.png','square':'square.png','rect':'rect.png','fh_rect':'freehand-square.png','circle':'circle.png','ellipse':'ellipse.png','fh_ellipse':'freehand-circle.png','path':'path.png','text':'text.png','image':'image.png','zoom':'zoom.png','clone':'clone.png','delete':'delete.png','group':'shape_group.png','ungroup':'shape_ungroup.png','move_top':'move_top.png','move_bottom':'move_bottom.png','to_path':'to_path.png','link_controls':'link_controls.png','reorient':'reorient.png','align_left':'align-left.png','align_center':'align-center.png','align_right':'align-right.png','align_top':'align-top.png','align_middle':'align-middle.png','align_bottom':'align-bottom.png','go_up':'go-up.png','go_down':'go-down.png','ok':'save.png','cancel':'cancel.png','arrow_right':'flyouth.png','arrow_down':'dropdown.gif'},placement:{'#tool_clear,#layer_new':'new_image','#tool_save':'save','#tool_open':'open','#tool_source':'source','#tool_docprops':'docprops','#tool_wireframe':'wireframe','#tool_undo':'undo','#tool_redo':'redo','#tool_select':'select','#tool_fhpath':'pencil','#tool_line':'pen','#tool_rect,#tools_rect_show':'rect','#tool_square':'square','#tool_fhrect':'fh_rect','#tool_ellipse,#tools_ellipse_show':'ellipse','#tool_circle':'circle','#tool_fhellipse':'fh_ellipse','#tool_path':'path','#tool_text,#layer_rename':'text','#tool_image':'image','#tool_zoom':'zoom','#tool_clone,#tool_clone_multi,#tool_node_clone':'clone','#layer_delete,#tool_delete,#tool_delete_multi,#tool_node_delete':'delete','#tool_move_top':'move_top','#tool_move_bottom':'move_bottom','#tool_topath':'to_path','#tool_node_link':'link_controls','#tool_reorient':'reorient','#tool_group':'group','#tool_ungroup':'ungroup','#tool_alignleft':'align_left','#tool_aligncenter':'align_center','#tool_alignright':'align_right','#tool_aligntop':'align_top','#tool_alignmiddle':'align_middle','#tool_alignbottom':'align_bottom','#url_notice':'warning','#layer_up':'go_up','#layer_down':'go_down','#layerlist td.layervis':'eye','#tool_source_save,#tool_docprops_save':'ok','#tool_source_cancel,#tool_docprops_cancel':'cancel','.flyout_arrow_horiz':'arrow_right','.dropdown button':'arrow_down','#palette .palette_item:first, #fill_bg, #stroke_bg':'no_color'},resize:{'.flyout_arrow_horiz .svg_icon':5,'.layer_button .svg_icon, #layerlist td.layervis .svg_icon':14,'.dropdown button .svg_icon':7,'.palette_item:first .svg_icon, #fill_bg .svg_icon, #stroke_bg .svg_icon':27,'.toolbar_button button .svg_icon':16},callback:function(icons){$('.toolbar_button button > svg, .toolbar_button button > img').each(function(){$(this).parent().prepend(this);});var tleft=$('#tools_left');var min_height=tleft.offset().top+tleft.outerHeight();var size=$.pref('iconsize');if(size&&size!='m'){svgCanvas.setIconSize(size);}else if($(window).height()<min_height){svgCanvas.setIconSize('s');}
var loc=document.location.href;if(loc.indexOf('?source=')!=-1){var pre='?source=data:image/svg+xml;base64,';var src=loc.substring(loc.indexOf(pre)+pre.length);svgCanvas.setSvgString(Utils.decode64(src));}}});}());$(function(){try{json_encode=function(obj){if(window.JSON&&JSON.stringify)return JSON.stringify(obj);var enc=arguments.callee;if(typeof obj=="boolean"||typeof obj=="number"){return obj+''}else if(typeof obj=="string"){return'"'+
obj.replace(/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,function(a){return'\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4);})
+'"';}else if(obj.length){for(var i=0;i<obj.length;i++){obj[i]=enc(obj[i]);}
return"["+obj.join(",")+"]";}else{var pairs=[];for(var k in obj){pairs.push(enc(k)+":"+enc(obj[k]));}
return"{"+pairs.join(",")+"}"}}
window.addEventListener("message",function(e){var cbid=parseInt(e.data.substr(0,e.data.indexOf(";")));try{e.source.postMessage("SVGe"+cbid+";"+json_encode(eval(e.data)),e.origin);}catch(err){e.source.postMessage("SVGe"+cbid+";error:"+err.message,e.origin);}},false)}catch(err){window.embed_error=err;}});;if(!window.console){window.console={};window.console.log=function(str){};window.console.dir=function(str){};}
if(window.opera){window.console.log=function(str){opera.postError(str);}}
function SvgCanvas(container)
{var isOpera=!!window.opera;var isWebkit=navigator.userAgent.indexOf("AppleWebKit")!=-1;var support={};var svgWhiteList={"circle":["cx","cy","fill","fill-opacity","fill-rule","id","opacity","r","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","systemLanguage","transform"],"defs":[],"desc":[],"ellipse":["cx","cy","fill","fill-opacity","fill-rule","id","opacity","requiredFeatures","rx","ry","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","systemLanguage","transform"],"g":["id","display","fill","fill-opacity","fill-rule","opacity","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","systemLanguage","transform"],"image":["height","id","opacity","requiredFeatures","systemLanguage","transform","width","x","xlink:href","xlink:title","y"],"line":["fill","fill-opacity","fill-rule","id","opacity","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","systemLanguage","transform","x1","x2","y1","y2"],"linearGradient":["id","gradientTransform","gradientUnits","requiredFeatures","spreadMethod","systemLanguage","x1","x2","y1","y2"],"path":["d","fill","fill-opacity","fill-rule","id","opacity","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","systemLanguage","transform"],"polygon":["id","fill","fill-opacity","fill-rule","id","opacity","points","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","systemLanguage","transform"],"polyline":["id","fill","fill-opacity","fill-rule","opacity","points","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","systemLanguage","transform"],"radialGradient":["id","cx","cy","fx","fy","gradientTransform","gradientUnits","r","requiredFeatures","spreadMethod","systemLanguage"],"rect":["fill","fill-opacity","fill-rule","height","id","opacity","requiredFeatures","rx","ry","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","systemLanguage","transform","width","x","y"],"stop":["id","offset","requiredFeatures","stop-color","stop-opacity","systemLanguage"],"switch":["id","requiredFeatures","systemLanguage"],"svg":["id","height","requiredFeatures","systemLanguage","transform","viewBox","width","xmlns","xmlns:xlink"],"text":["fill","fill-opacity","fill-rule","font-family","font-size","font-style","font-weight","id","opacity","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","systemLanguage","transform","text-anchor","x","xml:space","y"],"title":[]};var uiStrings={"pathNodeTooltip":"Drag node to move it. Double-click node to change segment type","pathCtrlPtTooltip":"Drag control point to adjust curve properties"};var toXml=function(str){return $('<p/>').text(str).html();};var fromXml=function(str){return $('<p/>').html(str).text();};function ChangeElementCommand(elem,attrs,text){this.elem=elem;this.text=text?("Change "+elem.tagName+" "+text):("Change "+elem.tagName);this.newValues={};this.oldValues=attrs;for(var attr in attrs){if(attr=="#text")this.newValues[attr]=elem.textContent;else this.newValues[attr]=elem.getAttribute(attr);}
this.apply=function(){var bChangedTransform=false;for(var attr in this.newValues){if(this.newValues[attr]){if(attr=="#text")this.elem.textContent=this.newValues[attr];else this.elem.setAttribute(attr,this.newValues[attr]);}
else{if(attr=="#text")this.elem.textContent="";else{this.elem.setAttribute(attr,"");this.elem.removeAttribute(attr);}}
if(attr=="transform"){bChangedTransform=true;}}
if(!bChangedTransform){var angle=canvas.getRotationAngle(elem);if(angle){var bbox=elem.getBBox();var cx=bbox.x+bbox.width/2,cy=bbox.y+bbox.height/2;var rotate=["rotate(",angle," ",cx,",",cy,")"].join('');if(rotate!=elem.getAttribute("transform")){elem.setAttribute("transform",rotate);}}}
if(this.elem.tagName=="title"&&this.elem.parentNode.parentNode==svgcontent){identifyLayers();}
return true;};this.unapply=function(){var bChangedTransform=false;for(var attr in this.oldValues){if(this.oldValues[attr]){if(attr=="#text")this.elem.textContent=this.oldValues[attr];else this.elem.setAttribute(attr,this.oldValues[attr]);}
else{if(attr=="#text")this.elem.textContent="";else this.elem.removeAttribute(attr);}
if(attr=="transform"){bChangedTransform=true;}}
if(!bChangedTransform){var angle=canvas.getRotationAngle(elem);if(angle){var bbox=elem.getBBox();var cx=bbox.x+bbox.width/2,cy=bbox.y+bbox.height/2;var rotate=["rotate(",angle," ",cx,",",cy,")"].join('');if(rotate!=elem.getAttribute("transform")){elem.setAttribute("transform",rotate);}}}
if(this.elem.tagName=="title"&&this.elem.parentNode.parentNode==svgcontent){identifyLayers();}
return true;};this.elements=function(){return[this.elem];}}
function InsertElementCommand(elem,text){this.elem=elem;this.text=text||("Create "+elem.tagName);this.parent=elem.parentNode;this.apply=function(){this.elem=this.parent.insertBefore(this.elem,this.elem.nextSibling);if(this.parent==svgcontent){identifyLayers();}};this.unapply=function(){this.parent=this.elem.parentNode;this.elem=this.elem.parentNode.removeChild(this.elem);if(this.parent==svgcontent){identifyLayers();}};this.elements=function(){return[this.elem];};}
function RemoveElementCommand(elem,parent,text){this.elem=elem;this.text=text||("Delete "+elem.tagName);this.parent=parent;this.apply=function(){this.parent=this.elem.parentNode;this.elem=this.parent.removeChild(this.elem);if(this.parent==svgcontent){identifyLayers();}};this.unapply=function(){this.elem=this.parent.insertBefore(this.elem,this.elem.nextSibling);if(this.parent==svgcontent){identifyLayers();}};this.elements=function(){return[this.elem];};if(svgTransformLists[elem.id]){delete svgTransformLists[elem.id];}}
function MoveElementCommand(elem,oldNextSibling,oldParent,text){this.elem=elem;this.text=text?("Move "+elem.tagName+" to "+text):("Move "+elem.tagName);this.oldNextSibling=oldNextSibling;this.oldParent=oldParent;this.newNextSibling=elem.nextSibling;this.newParent=elem.parentNode;this.apply=function(){this.elem=this.newParent.insertBefore(this.elem,this.newNextSibling);if(this.newParent==svgcontent){identifyLayers();}};this.unapply=function(){this.elem=this.oldParent.insertBefore(this.elem,this.oldNextSibling);if(this.oldParent==svgcontent){identifyLayers();}};this.elements=function(){return[this.elem];};}
function BatchCommand(text){this.text=text||"Batch Command";this.stack=[];this.apply=function(){var len=this.stack.length;for(var i=0;i<len;++i){this.stack[i].apply();}};this.unapply=function(){for(var i=this.stack.length-1;i>=0;i--){this.stack[i].unapply();}};this.elements=function(){var elems=[];var cmd=this.stack.length;while(cmd--){var thisElems=this.stack[cmd].elements();var elem=thisElems.length;while(elem--){if(elems.indexOf(thisElems[elem])==-1)elems.push(thisElems[elem]);}}
return elems;};this.addSubCommand=function(cmd){this.stack.push(cmd);};this.isEmpty=function(){return this.stack.length==0;};}
function Selector(id,elem){this.id=id;this.selectedElement=elem;this.locked=true;this.reset=function(e,update){this.locked=true;this.selectedElement=e;this.resize();this.selectorGroup.setAttribute("display","inline");};this.selectorGroup=addSvgElementFromJson({"element":"g","attr":{"id":("selectorGroup"+this.id)}});this.selectorRect=this.selectorGroup.appendChild(addSvgElementFromJson({"element":"path","attr":{"id":("selectedBox"+this.id),"fill":"none","stroke":"blue","stroke-width":"1","stroke-dasharray":"5,5","style":"pointer-events:none"}}));this.selectorGrips={"nw":null,"n":null,"ne":null,"e":null,"se":null,"s":null,"sw":null,"w":null};this.rotateGripConnector=this.selectorGroup.appendChild(addSvgElementFromJson({"element":"line","attr":{"id":("selectorGrip_rotateconnector_"+this.id),"stroke":"blue","stroke-width":"1"}}));this.rotateGrip=this.selectorGroup.appendChild(addSvgElementFromJson({"element":"circle","attr":{"id":("selectorGrip_rotate_"+this.id),"fill":"lime","r":4,"stroke":"blue","stroke-width":2,"style":"cursor:url(/vlewrapper/vle/node/draw/svg-edit-2.4rc1/images/rotate.png) 12 12, url(/vlewrapper/vle/node/draw/svg-edit-2.4rc1/images/rotate.png), pointer"}}));for(var dir in this.selectorGrips){this.selectorGrips[dir]=this.selectorGroup.appendChild(addSvgElementFromJson({"element":"circle","attr":{"id":("selectorGrip_resize_"+dir+"_"+this.id),"fill":"blue","r":4,"style":("cursor:"+dir+"-resize"),"stroke-width":2,"pointer-events":"all","display":"none"}}));}
this.showGrips=function(show){var bShow=show?"inline":"none";this.rotateGrip.setAttribute("display",bShow);this.rotateGripConnector.setAttribute("display",bShow);var elem=this.selectedElement;for(var dir in this.selectorGrips){this.selectorGrips[dir].setAttribute("display",bShow);}
if(elem)this.updateGripCursors(canvas.getRotationAngle(elem));};this.updateGripCursors=function(angle){var dir_arr=[];var steps=Math.round(angle/45);if(steps<0)steps+=8;for(var dir in this.selectorGrips){dir_arr.push(dir);}
while(steps>0){dir_arr.push(dir_arr.shift());steps--;}
var i=0;for(var dir in this.selectorGrips){this.selectorGrips[dir].setAttribute('style',("cursor:"+dir_arr[i]+"-resize"));i++;};};this.resize=function(){var selectedBox=this.selectorRect;var selectedGrips=this.selectorGrips;var selected=this.selectedElement;var sw=round(selected.getAttribute("stroke-width"));var offset=1/canvas.getZoom();if(selected.getAttribute("stroke")!="none"&&!isNaN(sw)){offset+=sw/2;}
if(selected.tagName=="text"){offset+=2/canvas.getZoom();}
var bbox=canvas.getBBox(selected);if(!isWebkit&&selected.tagName=='g'){var stroked_bbox=canvas.getStrokedBBox(selected.childNodes);$.each(bbox,function(key,val){bbox[key]=stroked_bbox[key];});}
var tlist=canvas.getTransformList(selected);var m=transformListToTransform(tlist).matrix;m.e*=current_zoom;m.f*=current_zoom;var l=bbox.x-offset,t=bbox.y-offset,w=bbox.width+(offset<<1),h=bbox.height+(offset<<1);var bbox={x:l,y:t,width:w,height:h};var nbox=transformBox(l*current_zoom,t*current_zoom,w*current_zoom,h*current_zoom,m);var nbax=nbox.aabox.x,nbay=nbox.aabox.y,nbaw=nbox.aabox.width,nbah=nbox.aabox.height;var cx=nbax+nbaw/2;var cy=nbay+nbah/2;var angle=canvas.getRotationAngle(selected);if(angle){var rot=svgroot.createSVGTransform();rot.setRotate(-angle,cx,cy);var rotm=rot.matrix;nbox.tl=transformPoint(nbox.tl.x,nbox.tl.y,rotm);nbox.tr=transformPoint(nbox.tr.x,nbox.tr.y,rotm);nbox.bl=transformPoint(nbox.bl.x,nbox.bl.y,rotm);nbox.br=transformPoint(nbox.br.x,nbox.br.y,rotm);var minx=nbox.tl.x,miny=nbox.tl.y,maxx=nbox.tl.x,maxy=nbox.tl.y;minx=Math.min(minx,Math.min(nbox.tr.x,Math.min(nbox.bl.x,nbox.br.x)));miny=Math.min(miny,Math.min(nbox.tr.y,Math.min(nbox.bl.y,nbox.br.y)));maxx=Math.max(maxx,Math.max(nbox.tr.x,Math.max(nbox.bl.x,nbox.br.x)));maxy=Math.max(maxy,Math.max(nbox.tr.y,Math.max(nbox.bl.y,nbox.br.y)));nbax=minx;nbay=miny;nbaw=(maxx-minx);nbah=(maxy-miny);}
var sr_handle=svgroot.suspendRedraw(100);var dstr="M"+nbax+","+nbay
+" L"+(nbax+nbaw)+","+nbay
+" "+(nbax+nbaw)+","+(nbay+nbah)
+" "+nbax+","+(nbay+nbah)+"z";assignAttributes(selectedBox,{'d':dstr});var gripCoords={nw:[nbax,nbay],ne:[nbax+nbaw,nbay],sw:[nbax,nbay+nbah],se:[nbax+nbaw,nbay+nbah],n:[nbax+(nbaw)/2,nbay],w:[nbax,nbay+(nbah)/2],e:[nbax+nbaw,nbay+(nbah)/2],s:[nbax+(nbaw)/2,nbay+nbah]};if(selected==selectedElements[0]){for(var dir in gripCoords){var coords=gripCoords[dir];assignAttributes(selectedGrips[dir],{cx:coords[0],cy:coords[1]});};}
if(angle){this.selectorGroup.setAttribute("transform","rotate("+[angle,cx,cy].join(",")+")");}
else{this.selectorGroup.setAttribute("transform","");}
assignAttributes(this.rotateGripConnector,{x1:nbax+(nbaw)/2,y1:nbay,x2:nbax+(nbaw)/2,y2:nbay-20});assignAttributes(this.rotateGrip,{cx:nbax+(nbaw)/2,cy:nbay-20});svgroot.unsuspendRedraw(sr_handle);};this.reset(elem);};function SelectorManager(){this.selectorParentGroup=null;this.rubberBandBox=null;this.selectors=[];this.selectorMap={};var mgr=this;this.initGroup=function(){if(mgr.selectorParentGroup&&mgr.selectorParentGroup.parentNode){mgr.selectorParentGroup.parentNode.removeChild(mgr.selectorParentGroup);}
mgr.selectorParentGroup=svgdoc.createElementNS(svgns,"g");mgr.selectorParentGroup.setAttribute("id","selectorParentGroup");svgroot.appendChild(mgr.selectorParentGroup);mgr.selectorMap={};mgr.selectors=[];mgr.rubberBandBox=null;};this.requestSelector=function(elem){if(elem==null)return null;var N=this.selectors.length;if(typeof(this.selectorMap[elem.id])=="object"){this.selectorMap[elem.id].locked=true;return this.selectorMap[elem.id];}
for(var i=0;i<N;++i){if(this.selectors[i]&&!this.selectors[i].locked){this.selectors[i].locked=true;this.selectors[i].reset(elem);this.selectorMap[elem.id]=this.selectors[i];return this.selectors[i];}}
this.selectors[N]=new Selector(N,elem);this.selectorParentGroup.appendChild(this.selectors[N].selectorGroup);this.selectorMap[elem.id]=this.selectors[N];return this.selectors[N];};this.releaseSelector=function(elem){if(elem==null)return;var N=this.selectors.length;var sel=this.selectorMap[elem.id];for(var i=0;i<N;++i){if(this.selectors[i]&&this.selectors[i]==sel){if(sel.locked==false){console.log("WARNING! selector was released but was already unlocked");}
delete this.selectorMap[elem.id];sel.locked=false;sel.selectedElement=null;sel.showGrips(false);try{sel.selectorGroup.setAttribute("display","none");}catch(e){}
break;}}};this.getRubberBandBox=function(){if(this.rubberBandBox==null){this.rubberBandBox=this.selectorParentGroup.appendChild(addSvgElementFromJson({"element":"rect","attr":{"id":"selectorRubberBand","fill":"blue","fill-opacity":0.15,"stroke":"blue","stroke-width":0.5,"display":"none","style":"pointer-events:none"}}));}
return this.rubberBandBox;};this.initGroup();}
var svgTransformLists={};var SVGEditTransformList=function(elem){this._elem=elem||null;this._xforms=[];this._update=function(){var tstr="";var concatMatrix=svgroot.createSVGMatrix();for(var i=0;i<this.numberOfItems;++i){var xform=this._list.getItem(i);tstr+=transformToObj(xform).text+" ";}
this._elem.setAttribute("transform",tstr);};this._list=this;this._init=function(){var str=this._elem.getAttribute("transform");if(!str)return;var re=/\s*((scale|matrix|rotate|translate)\s*\(.*?\))\s*,?\s*/;var arr=[];var m=true;while(m){m=str.match(re);str=str.replace(re,'');if(m&&m[1]){var x=m[1];var bits=x.split(/\s*\(/);var name=bits[0];var val_bits=bits[1].match(/\s*(.*?)\s*\)/);var val_arr=val_bits[1].split(/[, ]+/);var letters='abcdef'.split('');var mtx=svgroot.createSVGMatrix();$.each(val_arr,function(i,item){val_arr[i]=parseFloat(item);if(name=='matrix'){mtx[letters[i]]=val_arr[i];}});var xform=svgroot.createSVGTransform();var fname='set'+name.charAt(0).toUpperCase()+name.slice(1);var values=name=='matrix'?[mtx]:val_arr;xform[fname].apply(xform,values);this._list.appendItem(xform);}}}
this.numberOfItems=0;this.clear=function(){this.numberOfItems=0;this._xforms=[];};this.initialize=function(newItem){this.numberOfItems=1;this._xforms=[newItem];};this.getItem=function(index){if(index<this.numberOfItems&&index>=0){return this._xforms[index];}
return null;};this.insertItemBefore=function(newItem,index){var retValue=null;if(index>=0){if(index<this.numberOfItems){var newxforms=new Array(this.numberOfItems+1);for(var i=0;i<index;++i){newxforms[i]=this._xforms[i];}
newxforms[i]=newItem;for(var j=i+1;i<this.numberOfItems;++j,++i){newxforms[j]=this._xforms[i];}
this.numberOfItems++;this._xforms=newxforms;retValue=newItem;this._list._update();}
else{retValue=this._list.appendItem(newItem);}}
return retValue;};this.replaceItem=function(newItem,index){var retValue=null;if(index<this.numberOfItems&&index>=0){this._xforms[index]=newItem;retValue=newItem;this._list._update();}
return retValue;};this.removeItem=function(index){var retValue=null;if(index<this.numberOfItems&&index>=0){var retValue=this._xforms[index];var newxforms=new Array(this.numberOfItems-1);for(var i=0;i<index;++i){newxforms[i]=this._xforms[i];}
for(var j=i;j<this.numberOfItems-1;++j,++i){newxforms[j]=this._xforms[i+1];}
this.numberOfItems--;this._xforms=newxforms;this._list._update();}
return retValue;};this.appendItem=function(newItem){this._xforms.push(newItem);this.numberOfItems++;this._list._update();return newItem;};};var addSvgElementFromJson=function(data){return canvas.updateElementFromJson(data)};var assignAttributes=function(node,attrs,suspendLength){if(!suspendLength)suspendLength=0;var handle=null;if(!window.opera)svgroot.suspendRedraw(suspendLength);for(var i in attrs){var ns=(i.substr(0,4)=="xml:"?xmlns:i.substr(0,6)=="xlink:"?xlinkns:null);node.setAttributeNS(ns,i,attrs[i]);}
if(!window.opera)svgroot.unsuspendRedraw(handle);};var cleanupElement=function(element){var handle=svgroot.suspendRedraw(60);var defaults={'fill-opacity':1,'opacity':1,'stroke':'none','stroke-dasharray':'none','stroke-opacity':1,'stroke-width':1,'rx':0,'ry':0,'display':'inline'}
for(var attr in defaults){var val=defaults[attr];if(element.getAttribute(attr)==val){element.removeAttribute(attr);}}
svgroot.unsuspendRedraw(handle);};this.updateElementFromJson=function(data){var shape=getElem(data.attr.id);if(shape&&data.element!=shape.tagName){current_layer.removeChild(shape);shape=null;}
if(!shape){shape=svgdoc.createElementNS(svgns,data.element);if(current_layer){current_layer.appendChild(shape);}}
assignAttributes(shape,data.attr,100);cleanupElement(shape);return shape;};var canvas=this;var svgns="http://www.w3.org/2000/svg";var xlinkns="http://www.w3.org/1999/xlink";var xmlns="http://www.w3.org/XML/1998/namespace";var idprefix="svg_";var svgdoc=container.ownerDocument;var svgroot=svgdoc.createElementNS(svgns,"svg");svgroot.setAttribute("width",600);svgroot.setAttribute("height",450);svgroot.setAttribute("id","svgroot");svgroot.setAttribute("xmlns",svgns);svgroot.setAttribute("xmlns:xlink",xlinkns);container.appendChild(svgroot);var svgcontent=svgdoc.createElementNS(svgns,"svg");svgcontent.setAttribute('id','svgcontent');svgcontent.setAttribute('viewBox','0 0 600 450');svgcontent.setAttribute("xmlns",svgns);svgcontent.setAttribute("xmlns:xlink",xlinkns);svgroot.appendChild(svgcontent);(function(){var comment=svgdoc.createComment(" Created with SVG-edit - http://svg-edit.googlecode.com/ ");svgcontent.appendChild(comment);});var all_layers=[];var encodableImages={};var last_good_img_url='images/logo.png';var current_layer=null;var save_options={round_digits:5};var started=false;var obj_num=1;var start_transform=null;var current_mode="select";var current_resize_mode="none";var all_properties={shape:{fill:"#FF0000",fill_paint:null,fill_opacity:1,stroke:"#000000",stroke_paint:null,stroke_opacity:1,stroke_width:5,stroke_style:'none',opacity:1}};all_properties.text=$.extend(true,{},all_properties.shape);$.extend(all_properties.text,{fill:"#000000",stroke_width:0,font_size:24,font_family:'sans-serif'});var cur_shape=all_properties.shape;var cur_text=all_properties.text;var cur_properties=cur_shape;var current_zoom=1;var selectedElements=new Array(1);var selectedBBoxes=new Array(1);var justSelected=null;var selectorManager=new SelectorManager();var rubberBox=null;var events={};var undoStackPointer=0;var undoStack=[];var curBBoxes=[];var images=[];var currStamp=null;var round=function(val){return parseInt(val*current_zoom)/current_zoom;};var getIntersectionList=function(rect){if(rubberBox==null){return null;}
if(!curBBoxes.length){curBBoxes=canvas.getVisibleElements(current_layer,true);}
var resultList=null;try{resultList=current_layer.getIntersectionList(rect,null);}catch(e){}
if(resultList==null||typeof(resultList.item)!="function"){resultList=[];var rubberBBox=rubberBox.getBBox();$.each(rubberBBox,function(key,val){rubberBBox[key]=val/current_zoom;});var i=curBBoxes.length;while(i--){if(Utils.rectsIntersect(rubberBBox,curBBoxes[i].bbox)){resultList.push(curBBoxes[i].elem);}}}
return resultList;};var addCommandToHistory=function(cmd){if(undoStackPointer<undoStack.length&&undoStack.length>0){undoStack=undoStack.splice(0,undoStackPointer);}
undoStack.push(cmd);undoStackPointer=undoStack.length;};var getId=function(){if(events["getid"])return call("getid",obj_num);return idprefix+obj_num;};var getNextId=function(){var id=getId();while(getElem(id)){obj_num++;id=getId();}
return id;};var call=function(event,arg){if(events[event]){return events[event](this,arg);}};var sanitizeSvg=function(node){if(node.nodeType==3){node.nodeValue=node.nodeValue.replace(/^\s+|\s+$/g,"");if(!node.nodeValue.length)node.parentNode.removeChild(node);}
if(node.nodeType!=1)return;var doc=node.ownerDocument;var parent=node.parentNode;if(!doc||!parent)return;var allowedAttrs=svgWhiteList[node.nodeName];if(allowedAttrs!=undefined){var i=node.attributes.length;while(i--){var attrName=node.attributes.item(i).nodeName;if(allowedAttrs.indexOf(attrName)==-1){node.removeAttribute(attrName);}
if(attrName=='d'){node.setAttribute('d',pathActions.convertPath(node));}}
i=node.childNodes.length;while(i--){sanitizeSvg(node.childNodes.item(i));}}
else{var children=[];while(node.hasChildNodes()){children.push(parent.insertBefore(node.firstChild,node));}
parent.removeChild(node);var i=children.length;while(i--){sanitizeSvg(children[i]);}}};var removeUnusedGrads=function(){var defs=svgcontent.getElementsByTagNameNS(svgns,"defs");if(!defs||!defs.length)return;var all_els=svgcontent.getElementsByTagNameNS(svgns,'*');var grad_uses=[];$.each.each(all_els,function(i,el){var fill=el.getAttribute('fill');if(fill&&fill.indexOf('url(#')==0){grad_uses.push(fill);}
var stroke=el.getAttribute('stroke');if(stroke&&stroke.indexOf('url(#')==0){grad_uses.push(stroke);}});var lgrads=svgcontent.getElementsByTagNameNS(svgns,"linearGradient");var grad_ids=[];var i=lgrads.length;while(i--){var grad=lgrads[i];var id=grad.id;var url_id='url(#'+id+')';if($.inArray(url_id,grad_uses)==-1){grad.parentNode.removeChild(grad);}}
var i=defs.length;while(i--){var def=defs[i];if(!def.getElementsByTagNameNS(svgns,'*').length){def.parentNode.removeChild(def);}}}
var svgCanvasToString=function(){removeUnusedGrads();pathActions.clear(true);$.each(svgcontent.childNodes,function(i,node){if(i&&node.nodeType==8&&node.data.indexOf('Created with')!=-1){svgcontent.insertBefore(node,svgcontent.firstChild);}});var output=svgToString(svgcontent,0);return output;}
var svgToString=function(elem,indent){var out=new Array();if(elem){cleanupElement(elem);var attrs=elem.attributes;var attr;var i;var childs=elem.childNodes;for(var i=0;i<indent;i++)out.push(" ");out.push("<");out.push(elem.nodeName);if(elem.id=='svgcontent'){var res=canvas.getResolution();out.push(' width="'+res.w+'" height="'+res.h
+'" xmlns:xlink="'+xlinkns+'" xmlns="'+svgns+'"');}else{for(var i=attrs.length-1;i>=0;i--){attr=attrs.item(i);var attrVal=attr.nodeValue;if(attrVal!=""){if(attrVal.indexOf('pointer-events')==0)continue;out.push(" ");if(attr.localName=='d')attrVal=pathActions.convertPath(elem,true);if(!isNaN(attrVal)){attrVal=shortFloat(attrVal);}
if(save_options.apply&&elem.nodeName=='image'&&attr.localName=='href'&&save_options.images&&save_options.images=='embed'){var img=encodableImages[attrVal];if(img)attrVal=img;}
if(attr.namespaceURI==xlinkns){out.push('xlink:');}
else if(attr.namespaceURI=='http://www.w3.org/2000/xmlns/'&&attr.localName!='xmlns'){out.push('xmlns:');}
else if(attr.namespaceURI==xmlns){out.push('xml:');}
out.push(attr.localName);out.push("=\"");out.push(attrVal);out.push("\"");}}}
if(elem.hasChildNodes()){out.push(">");indent++;var bOneLine=false;for(var i=0;i<childs.length;i++)
{var child=childs.item(i);if(child.id=="selectorParentGroup")continue;switch(child.nodeType){case 1:out.push("\n");out.push(svgToString(childs.item(i),indent));break;case 3:var str=child.nodeValue.replace(/^\s+|\s+$/g,"");if(str!=""){bOneLine=true;out.push(toXml(str)+"");}
break;case 8:out.push("\n");out.push(new Array(indent+1).join(" "));out.push("<!--");out.push(child.data);out.push("-->");break;}}
indent--;if(!bOneLine){out.push("\n");for(var i=0;i<indent;i++)out.push(" ");}
out.push("</");out.push(elem.nodeName);out.push(">");}else{out.push("/>");}}
return out.join('');};this.embedImage=function(val,callback){$(new Image()).load(function(){var canvas=document.createElement("canvas");canvas.width=this.width;canvas.height=this.height;canvas.getContext("2d").drawImage(this,0,0);try{var urldata=';svgedit_url='+encodeURIComponent(val);urldata=canvas.toDataURL().replace(';base64',urldata+';base64');encodableImages[val]=urldata;}catch(e){encodableImages[val]=false;}
last_good_img_url=val;if(callback)callback(encodableImages[val]);}).attr('src',val);}
this.fixOperaXML=function(elem,orig_el){var x_attrs=elem.attributes;$.each(x_attrs,function(i,attr){if(attr.nodeValue.indexOf(',')==-1)return;var ns=attr.prefix=='xlink'?xlinkns:attr.prefix=="xml"?xmlns:null;var good_attrval=orig_el.getAttribute(attr.localName);if(ns){elem.setAttributeNS(ns,attr.nodeName,good_attrval);}else{elem.setAttribute(attr.nodeName,good_attrval);}});var childs=elem.childNodes;var o_childs=orig_el.childNodes;$.each(childs,function(i,child){if(child.nodeType==1){canvas.fixOperaXML(child,o_childs[i]);}});}
var recalculateAllSelectedDimensions=function(){var text=(current_resize_mode=="none"?"position":"size");var batchCmd=new BatchCommand(text);var i=selectedElements.length;while(i--){var cmd=recalculateDimensions(selectedElements[i]);if(cmd){batchCmd.addSubCommand(cmd);}}
if(!batchCmd.isEmpty()){addCommandToHistory(batchCmd);call("changed",selectedElements);}};var pathMap=[0,'z','M','m','L','l','C','c','Q','q','A','a','H','h','V','v','S','s','T','t'];var logMatrix=function(m){console.log([m.a,m.b,m.c,m.d,m.e,m.f]);};var remapElement=function(selected,changes,m){var remap=function(x,y){return transformPoint(x,y,m);};var scalew=function(w){return m.a*w;}
var scaleh=function(h){return m.d*h;}
var box=canvas.getBBox(selected);switch(selected.tagName)
{case"line":var pt1=remap(changes["x1"],changes["y1"]),pt2=remap(changes["x2"],changes["y2"]);changes["x1"]=pt1.x;changes["y1"]=pt1.y;changes["x2"]=pt2.x;changes["y2"]=pt2.y;break;case"circle":var c=remap(changes["cx"],changes["cy"]);changes["cx"]=c.x;changes["cy"]=c.y;var tbox=transformBox(box.x,box.y,box.width,box.height,m);var w=tbox.tr.x-tbox.tl.x,h=tbox.bl.y-tbox.tl.y;changes["r"]=Math.min(w/2,h/2);break;case"ellipse":var c=remap(changes["cx"],changes["cy"]);changes["cx"]=c.x;changes["cy"]=c.y;changes["rx"]=scalew(changes["rx"]);changes["ry"]=scaleh(changes["ry"]);break;case"rect":case"image":var pt1=remap(changes["x"],changes["y"]);changes["x"]=pt1.x;changes["y"]=pt1.y;changes["width"]=scalew(changes["width"]);changes["height"]=scaleh(changes["height"]);break;case"text":var chlist=canvas.getTransformList(selected);var mt=svgroot.createSVGTransform();mt.setMatrix(matrixMultiply(transformListToTransform(chlist).matrix,m));chlist.clear();chlist.appendItem(mt);break;case"polygon":case"polyline":var len=changes["points"].length;for(var i=0;i<len;++i){var pt=changes["points"][i];pt=remap(pt.x,pt.y);changes["points"][i].x=pt.x;changes["points"][i].y=pt.y;}
break;case"path":var segList=selected.pathSegList;var len=segList.numberOfItems;changes.d=new Array(len);for(var i=0;i<len;++i){var seg=segList.getItem(i);changes.d[i]={type:seg.pathSegType,x:seg.x,y:seg.y,x1:seg.x1,y1:seg.y1,x2:seg.x2,y2:seg.y2,r1:seg.r1,r2:seg.r2,angle:seg.angle,largeArcFlag:seg.largeArcFlag,sweepFlag:seg.sweepFlag};}
var len=changes["d"].length;var firstseg=changes["d"][0];var firstpt=remap(firstseg.x,firstseg.y);changes["d"][0].x=firstpt.x;changes["d"][0].y=firstpt.y;for(var i=1;i<len;++i){var seg=changes["d"][i];var type=seg.type;if(type%2==0){var pt=remap(seg.x,seg.y),pt1=remap(seg.x1,seg.y1),pt2=remap(seg.x2,seg.y2);seg.x=pt.x;seg.y=pt.y;seg.x1=pt1.x;seg.y1=pt1.y;seg.x2=pt2.x;seg.y2=pt2.y;seg.r1=scalew(seg.r1),seg.r2=scaleh(seg.r2);}
else{seg.x=scalew(seg.x);seg.y=scaleh(seg.y);seg.x1=scalew(seg.x1);seg.y1=scaleh(seg.y1);seg.x2=scalew(seg.x2);seg.y2=scaleh(seg.y2);seg.r1=scalew(seg.r1),seg.r2=scaleh(seg.r2);}}
break;}
switch(selected.tagName)
{case"rect":case"image":changes.x=changes.x-0+Math.min(0,changes.width);changes.y=changes.y-0+Math.min(0,changes.height);changes.width=Math.abs(changes.width);changes.height=Math.abs(changes.height);assignAttributes(selected,changes,1000);break;case"ellipse":changes.rx=Math.abs(changes.rx);changes.ry=Math.abs(changes.ry);case"circle":if(changes.r)changes.r=Math.abs(changes.r);case"line":case"text":assignAttributes(selected,changes,1000);break;case"polyline":case"polygon":var len=changes["points"].length;var pstr="";for(var i=0;i<len;++i){var pt=changes["points"][i];pstr+=pt.x+","+pt.y+" ";}
selected.setAttribute("points",pstr);break;case"path":var dstr="";var len=changes["d"].length;for(var i=0;i<len;++i){var seg=changes["d"][i];var type=seg.type;dstr+=pathMap[type];switch(type){case 13:case 12:dstr+=seg.x+" ";break;case 15:case 14:dstr+=seg.y+" ";break;case 3:case 5:case 19:case 2:case 4:case 18:dstr+=seg.x+","+seg.y+" ";break;case 7:case 6:dstr+=seg.x1+","+seg.y1+" "+seg.x2+","+seg.y2+" "+
seg.x+","+seg.y+" ";break;case 9:case 8:dstr+=seg.x+","+seg.y+" "+seg.x1+","+seg.y1+" ";break;case 11:case 10:dstr+=seg.r1+","+seg.r2+" "+seg.angle+" "+seg.largeArcFlag+" "+seg.sweepFlag+" "+seg.x+","+seg.y+" ";break;case 17:case 16:dstr+=seg.x+","+seg.y+" "+seg.x2+","+seg.y2+" ";break;}}
selected.setAttribute("d",dstr);break;}};var recalculateDimensions=function(selected){if(selected==null)return null;var tlist=canvas.getTransformList(selected);if(tlist&&tlist.numberOfItems>0){var k=tlist.numberOfItems;while(k--){var xform=tlist.getItem(k);if(xform.type==0){tlist.removeItem(k);}
else if(xform.type==1){if(isIdentity(xform.matrix)){tlist.removeItem(k);}}
else if(xform.type==4){if(xform.angle==0){tlist.removeItem(k);}}}}
if(tlist.numberOfItems==0){selected.removeAttribute("transform");return null;}
var batchCmd=new BatchCommand("Transform");var changes={},initial=null;switch(selected.tagName)
{case"line":changes["x1"]=selected.getAttribute("x1");changes["y1"]=selected.getAttribute("y1");changes["x2"]=selected.getAttribute("x2");changes["y2"]=selected.getAttribute("y2");break;case"circle":changes["cx"]=selected.getAttribute("cx");changes["cy"]=selected.getAttribute("cy");changes["r"]=selected.getAttribute("r");break;case"ellipse":changes["cx"]=selected.getAttribute("cx");changes["cy"]=selected.getAttribute("cy");changes["rx"]=selected.getAttribute("rx");changes["ry"]=selected.getAttribute("ry");break;case"rect":case"image":changes["x"]=selected.getAttribute("x");changes["y"]=selected.getAttribute("y");changes["width"]=selected.getAttribute("width");changes["height"]=selected.getAttribute("height");break;case"text":changes["x"]=selected.getAttribute("x");changes["y"]=selected.getAttribute("y");break;case"polygon":case"polyline":initial={};initial["points"]=selected.getAttribute("points");var list=selected.points;var len=list.numberOfItems;changes["points"]=new Array(len);for(var i=0;i<len;++i){var pt=list.getItem(i);changes["points"][i]={x:pt.x,y:pt.y};}
break;case"path":initial={};initial["d"]=selected.getAttribute("d");changes["d"]=selected.getAttribute("d");break;}
if(initial==null){initial=$.extend(true,{},changes);}
initial["transform"]=start_transform?start_transform:"";if(selected.tagName=="g"){var box=canvas.getBBox(selected);var oldcenter={x:box.x+box.width/2,y:box.y+box.height/2};var newcenter=transformPoint(box.x+box.width/2,box.y+box.height/2,transformListToTransform(tlist).matrix);var m=svgroot.createSVGMatrix();var gangle=canvas.getRotationAngle(selected);if(gangle){for(var i=0;i<tlist.numberOfItems;++i){var xform=tlist.getItem(i);if(xform.type==4){var rm=xform.matrix;var a=gangle*Math.PI/180;oldcenter.y=0.5*(Math.sin(a)*rm.e+(1-Math.cos(a))*rm.f)/(1-Math.cos(a));oldcenter.x=((1-Math.cos(a))*oldcenter.y-rm.f)/Math.sin(a);tlist.removeItem(i);break;}}}
var tx=0,ty=0;var operation=0;var N=tlist.numberOfItems;if(N>=3&&tlist.getItem(N-2).type==3&&tlist.getItem(N-3).type==2&&tlist.getItem(N-1).type==2)
{operation=3;var tm=tlist.getItem(N-3).matrix;var sm=tlist.getItem(N-2).matrix;var tmn=tlist.getItem(N-1).matrix;var children=selected.childNodes;var c=children.length;while(c--){var child=children.item(c);tx=0;ty=0;if(child.nodeType==1){var childTlist=canvas.getTransformList(child);var m=transformListToTransform(childTlist).matrix;var angle=canvas.getRotationAngle(child);var old_start_transform=start_transform;start_transform=child.getAttribute("transform");if(angle||hasMatrixTransform(childTlist)){var e2t=svgroot.createSVGTransform();e2t.setMatrix(matrixMultiply(tm,sm,tmn,m));childTlist.clear();childTlist.appendItem(e2t,0);}
else{var t2n=matrixMultiply(m.inverse(),tmn,m);var t2=svgroot.createSVGMatrix();t2.e=-t2n.e;t2.f=-t2n.f;var s2=matrixMultiply(t2.inverse(),m.inverse(),tm,sm,tmn,m,t2n.inverse());var translateOrigin=svgroot.createSVGTransform(),scale=svgroot.createSVGTransform(),translateBack=svgroot.createSVGTransform();translateOrigin.setTranslate(t2n.e,t2n.f);scale.setScale(s2.a,s2.d);translateBack.setTranslate(t2.e,t2.f);childTlist.appendItem(translateBack);childTlist.appendItem(scale);childTlist.appendItem(translateOrigin);}
batchCmd.addSubCommand(recalculateDimensions(child));start_transform=old_start_transform;}}
tlist.removeItem(N-1);tlist.removeItem(N-2);tlist.removeItem(N-3);}
else if(N>=3&&tlist.getItem(N-1).type==1)
{operation=3;m=transformListToTransform(tlist).matrix;var e2t=svgroot.createSVGTransform();e2t.setMatrix(m);tlist.clear();tlist.appendItem(e2t);}
else if((N==1||(N>1&&tlist.getItem(1).type!=3))&&tlist.getItem(0).type==2)
{operation=2;var T_M=transformListToTransform(tlist).matrix;tlist.removeItem(0);var M_inv=transformListToTransform(tlist).matrix.inverse();var M2=matrixMultiply(M_inv,T_M);tx=M2.e;ty=M2.f;if(tx!=0||ty!=0){var children=selected.childNodes;var c=children.length;while(c--){var child=children.item(c);if(child.nodeType==1){var old_start_transform=start_transform;start_transform=child.getAttribute("transform");var childTlist=canvas.getTransformList(child);var newxlate=svgroot.createSVGTransform();newxlate.setTranslate(tx,ty);childTlist.insertItemBefore(newxlate,0);batchCmd.addSubCommand(recalculateDimensions(child));start_transform=old_start_transform;}}
start_transform=old_start_transform;}}
else if(N==1&&tlist.getItem(0).type==1&&!gangle){operation=1;var m=tlist.getItem(0).matrix;var children=selected.childNodes;var c=children.length;while(c--){var child=children.item(c);if(child.nodeType==1){var old_start_transform=start_transform;start_transform=child.getAttribute("transform");var childTlist=canvas.getTransformList(child);var em=matrixMultiply(m,transformListToTransform(childTlist).matrix);var e2m=svgroot.createSVGTransform();e2m.setMatrix(em);childTlist.clear();childTlist.appendItem(e2m,0);batchCmd.addSubCommand(recalculateDimensions(child));start_transform=old_start_transform;}}
tlist.clear();}
else{if(gangle){var newRot=svgroot.createSVGTransform();newRot.setRotate(gangle,newcenter.x,newcenter.y);tlist.insertItemBefore(newRot,0);}
if(tlist.numberOfItems==0){selected.removeAttribute("transform");}
return null;}
if(operation==2){if(gangle){var newRot=svgroot.createSVGTransform();newRot.setRotate(gangle,newcenter.x,newcenter.y);tlist.insertItemBefore(newRot,0);}}
else if(operation==3){var m=transformListToTransform(tlist).matrix;var roldt=svgroot.createSVGTransform();roldt.setRotate(gangle,oldcenter.x,oldcenter.y);var rold=roldt.matrix;var rnew=svgroot.createSVGTransform();rnew.setRotate(gangle,newcenter.x,newcenter.y);var rnew_inv=rnew.matrix.inverse();var m_inv=m.inverse();var extrat=matrixMultiply(m_inv,rnew_inv,rold,m);tx=extrat.e;ty=extrat.f;if(tx!=0||ty!=0){var children=selected.childNodes;var c=children.length;while(c--){var child=children.item(c);if(child.nodeType==1){var old_start_transform=start_transform;start_transform=child.getAttribute("transform");var childTlist=canvas.getTransformList(child);var newxlate=svgroot.createSVGTransform();newxlate.setTranslate(tx,ty);childTlist.insertItemBefore(newxlate,0);batchCmd.addSubCommand(recalculateDimensions(child));start_transform=old_start_transform;}}}
if(gangle){tlist.insertItemBefore(rnew,0);}}}
else{var box=canvas.getBBox(selected);var oldcenter={x:box.x+box.width/2,y:box.y+box.height/2};var newcenter=transformPoint(box.x+box.width/2,box.y+box.height/2,transformListToTransform(tlist).matrix);var m=svgroot.createSVGMatrix();var angle=canvas.getRotationAngle(selected);if(angle){for(var i=0;i<tlist.numberOfItems;++i){var xform=tlist.getItem(i);if(xform.type==4){var rm=xform.matrix;var a=angle*Math.PI/180;oldcenter.y=0.5*(Math.sin(a)*rm.e+(1-Math.cos(a))*rm.f)/(1-Math.cos(a));oldcenter.x=((1-Math.cos(a))*oldcenter.y-rm.f)/Math.sin(a);tlist.removeItem(i);break;}}}
var operation=0;var N=tlist.numberOfItems;if(N>=3&&tlist.getItem(N-2).type==3&&tlist.getItem(N-3).type==2&&tlist.getItem(N-1).type==2)
{operation=3;m=transformListToTransform(tlist,N-3,N-1).matrix;tlist.removeItem(N-1);tlist.removeItem(N-2);tlist.removeItem(N-3);}
else if(N==4&&tlist.getItem(N-1).type==1){operation=3;m=transformListToTransform(tlist).matrix;var e2t=svgroot.createSVGTransform();e2t.setMatrix(m);tlist.clear();tlist.appendItem(e2t);m=svgroot.createSVGMatrix();}
else if((N==1||(N>1&&tlist.getItem(1).type!=3))&&tlist.getItem(0).type==2)
{operation=2;var oldxlate=tlist.getItem(0).matrix,meq=transformListToTransform(tlist,1).matrix,meq_inv=meq.inverse();m=matrixMultiply(meq_inv,oldxlate,meq);tlist.removeItem(0);}
else if(N==1&&tlist.getItem(0).type==1&&!angle){m=transformListToTransform(tlist).matrix;switch(selected.tagName){case'line':changes.x1=selected.getAttribute("x1");changes.y1=selected.getAttribute("y1");changes.x2=selected.getAttribute("x2");changes.y2=selected.getAttribute("y2");case'polyline':case'polygon':changes.points=selected.getAttribute("points");if(changes.points){var list=selected.points;var len=list.numberOfItems;changes.points=new Array(len);for(var i=0;i<len;++i){var pt=list.getItem(i);changes.points[i]={x:pt.x,y:pt.y};}}
case'path':changes.d=selected.getAttribute("d");operation=1;tlist.clear();break;default:break;}}
else{operation=4;if(angle){var newRot=svgroot.createSVGTransform();newRot.setRotate(angle,newcenter.x,newcenter.y);tlist.insertItemBefore(newRot,0);}
if(tlist.numberOfItems==0){selected.removeAttribute("transform");}
return null;}
if(operation==1||operation==2||operation==3){remapElement(selected,changes,m);}
if(operation==2){if(angle){var newRot=svgroot.createSVGTransform();newRot.setRotate(angle,newcenter.x,newcenter.y);tlist.insertItemBefore(newRot,0);}}
else if(operation==3){var m=transformListToTransform(tlist).matrix;var roldt=svgroot.createSVGTransform();roldt.setRotate(angle,oldcenter.x,oldcenter.y);var rold=roldt.matrix;var rnew=svgroot.createSVGTransform();rnew.setRotate(angle,newcenter.x,newcenter.y);var rnew_inv=rnew.matrix.inverse();var m_inv=m.inverse();var extrat=matrixMultiply(m_inv,rnew_inv,rold,m);remapElement(selected,changes,extrat);if(angle){tlist.insertItemBefore(rnew,0);}}}
if(tlist.numberOfItems==0){selected.removeAttribute("transform");}
batchCmd.addSubCommand(new ChangeElementCommand(selected,initial));return batchCmd;};this.clearSelection=function(){if(selectedElements[0]!=null){var len=selectedElements.length;for(var i=0;i<len;++i){var elem=selectedElements[i];if(elem==null)break;selectorManager.releaseSelector(elem);selectedElements[i]=null;if(i==0)selectedBBoxes[i]=null;}}
call("selected",selectedElements);};this.addToSelection=function(elemsToAdd,showGrips){if(elemsToAdd.length==0){return;}
var j=0;while(j<selectedElements.length){if(selectedElements[j]==null){break;}
++j;}
var i=elemsToAdd.length;while(i--){var elem=elemsToAdd[i];if(!elem||elem.id.substr(0,13)=="selectorGrip_")continue;if(selectedElements.indexOf(elem)==-1){selectedElements[j]=elem;if(j==0)selectedBBoxes[j]=this.getBBox(elem);j++;var sel=selectorManager.requestSelector(elem);if(selectedElements.length>1){sel.showGrips(false);}}}
call("selected",selectedElements);if(showGrips){selectorManager.requestSelector(selectedElements[0]).showGrips(true);}
else if(selectedElements.length>1){selectorManager.requestSelector(selectedElements[0]).showGrips(false);}
selectedElements.sort(function(a,b){if(a&&b&&a.compareDocumentPosition){return 3-(b.compareDocumentPosition(a)&6);}else if(a==null){return 1;}});while(selectedElements[0]==null)selectedElements.shift(0);};this.removeFromSelection=function(elemsToRemove){if(selectedElements[0]==null){return;}
if(elemsToRemove.length==0){return;}
var newSelectedItems=new Array(selectedElements.length);var newSelectedBBoxes=new Array(selectedBBoxes.length);var j=0;var len=selectedElements.length;for(var i=0;i<len;++i){var elem=selectedElements[i];if(elem){if(elemsToRemove.indexOf(elem)==-1){newSelectedItems[j]=elem;if(j==0)newSelectedBBoxes[j]=selectedBBoxes[i];j++;}
else{selectorManager.releaseSelector(elem);}}}
selectedElements=newSelectedItems;selectedBBoxes=newSelectedBBoxes;};var root_sctm=null;var transformPoint=function(x,y,m){return{x:m.a*x+m.c*y+m.e,y:m.b*x+m.d*y+m.f};};var isIdentity=function(m){return(m.a==1&&m.b==0&&m.c==0&&m.d==1&&m.e==0&&m.f==0);}
var matrixMultiply=function(){var multi2=function(m1,m2){var m=svgroot.createSVGMatrix();m.a=m1.a*m2.a+m1.c*m2.b;m.b=m1.b*m2.a+m1.d*m2.b,m.c=m1.a*m2.c+m1.c*m2.d,m.d=m1.b*m2.c+m1.d*m2.d,m.e=m1.a*m2.e+m1.c*m2.f+m1.e,m.f=m1.b*m2.e+m1.d*m2.f+m1.f;return m;}
var args=arguments,i=args.length,m=args[i-1];while(i-->1){var m1=args[i-1];m=multi2(m1,m);}
return m;}
var transformListToTransform=function(tlist,min,max){var min=min==undefined?0:min;var max=max==undefined?(tlist.numberOfItems-1):max;min=parseInt(min);max=parseInt(max);if(min>max){var temp=max;max=min;min=temp;}
var m=svgroot.createSVGMatrix();for(var i=min;i<=max;++i){var mtom=(i>=0&&i<tlist.numberOfItems?tlist.getItem(i).matrix:svgroot.createSVGMatrix());m=matrixMultiply(m,mtom);}
return svgroot.createSVGTransformFromMatrix(m);};var hasMatrixTransform=function(tlist){var num=tlist.numberOfItems;while(num--){var xform=tlist.getItem(num);if(xform.type==1&&!isIdentity(xform.matrix))return true;}
return false;}
var transformToObj=function(xform,mZoom){var m=xform.matrix;var tobj={tx:0,ty:0,sx:1,sy:1,angle:0,cx:0,cy:0,text:""};var z=mZoom?current_zoom:1;switch(xform.type){case 1:tobj.text="matrix("+[m.a,m.b,m.c,m.d,m.e,m.f].join(",")+")";break;case 2:tobj.tx=m.e;tobj.ty=m.f;tobj.text="translate("+m.e*z+","+m.f*z+")";break;case 3:tobj.sx=m.a;tobj.sy=m.d;if(m.a==m.d)tobj.text="scale("+m.a+")";else tobj.text="scale("+m.a+","+m.d+")";break;case 4:tobj.angle=xform.angle;if(xform.angle!=0){var K=1-m.a;tobj.cy=(K*m.f+m.b*m.e)/(K*K+m.b*m.b);tobj.cx=(m.e-m.b*tobj.cy)/K;}
tobj.text="rotate("+xform.angle+" "+tobj.cx*z+","+tobj.cy*z+")";break;}
return tobj;};var transformBox=function(l,t,w,h,m){var topleft={x:l,y:t},topright={x:(l+w),y:t},botright={x:(l+w),y:(t+h)},botleft={x:l,y:(t+h)};topleft=transformPoint(topleft.x,topleft.y,m);var minx=topleft.x,maxx=topleft.x,miny=topleft.y,maxy=topleft.y;topright=transformPoint(topright.x,topright.y,m);minx=Math.min(minx,topright.x);maxx=Math.max(maxx,topright.x);miny=Math.min(miny,topright.y);maxy=Math.max(maxy,topright.y);botleft=transformPoint(botleft.x,botleft.y,m);minx=Math.min(minx,botleft.x);maxx=Math.max(maxx,botleft.x);miny=Math.min(miny,botleft.y);maxy=Math.max(maxy,botleft.y);botright=transformPoint(botright.x,botright.y,m);minx=Math.min(minx,botright.x);maxx=Math.max(maxx,botright.x);miny=Math.min(miny,botright.y);maxy=Math.max(maxy,botright.y);return{tl:topleft,tr:topright,bl:botleft,br:botright,aabox:{x:minx,y:miny,width:(maxx-minx),height:(maxy-miny)}};};(function(){var d_attr=null;var start_x=null;var start_y=null;var init_bbox={};var freehand={minx:null,miny:null,maxx:null,maxy:null};var mouseDown=function(evt)
{root_sctm=svgroot.getScreenCTM().inverse();var pt=transformPoint(evt.pageX,evt.pageY,root_sctm);var mouse_x=pt.x;var mouse_y=pt.y;evt.preventDefault();if($.inArray(current_mode,['select','resize'])==-1){addGradient();}
var x=mouse_x/current_zoom;var y=mouse_y/current_zoom;start_x=x;start_y=y;var mouse_target=evt.target;while(mouse_target.parentNode.parentNode.tagName=="g"){mouse_target=mouse_target.parentNode;}
if(mouse_target.nodeName.toLowerCase()=="div"){mouse_target=svgroot;}
if(mouse_target.parentNode==selectorManager.selectorParentGroup&&selectedElements[0]!=null){var gripid=evt.target.id;var griptype=gripid.substr(0,20);if(griptype=="selectorGrip_rotate_"){current_mode="rotate";}
else if(griptype=="selectorGrip_resize_"){current_mode="resize";current_resize_mode=gripid.substr(20,gripid.indexOf("_",20)-20);}
mouse_target=selectedElements[0];}
start_transform=mouse_target.getAttribute("transform");var tlist=canvas.getTransformList(mouse_target);switch(current_mode){case"select":started=true;current_resize_mode="none";if(mouse_target!=svgroot){if(selectedElements.indexOf(mouse_target)==-1){if(!evt.shiftKey){canvas.clearSelection();}
canvas.addToSelection([mouse_target]);justSelected=mouse_target;pathActions.clear();}
for(var i=0;i<selectedElements.length;++i){if(selectedElements[i]==null)continue;var slist=canvas.getTransformList(selectedElements[i]);slist.insertItemBefore(svgroot.createSVGTransform(),0);}}
else{canvas.clearSelection();current_mode="multiselect";if(rubberBox==null){rubberBox=selectorManager.getRubberBandBox();}
start_x*=current_zoom;start_y*=current_zoom;assignAttributes(rubberBox,{'x':start_x,'y':start_y,'width':0,'height':0,'display':'inline'},100);}
$('#text').blur();break;case"zoom":started=true;start_x=x;start_y=y;if(rubberBox==null){rubberBox=selectorManager.getRubberBandBox();}
assignAttributes(rubberBox,{'x':start_x*current_zoom,'y':start_y*current_zoom,'width':0,'height':0,'display':'inline'},100);break;case"resize":started=true;start_x=x;start_y=y;init_bbox=canvas.getBBox($('#selectedBox0')[0]);$.each(init_bbox,function(key,val){init_bbox[key]=val/current_zoom;});var pos=canvas.getRotationAngle(mouse_target)?1:0;if(hasMatrixTransform(tlist)){tlist.insertItemBefore(svgroot.createSVGTransform(),pos);tlist.insertItemBefore(svgroot.createSVGTransform(),pos);tlist.insertItemBefore(svgroot.createSVGTransform(),pos);}else{tlist.appendItem(svgroot.createSVGTransform());tlist.appendItem(svgroot.createSVGTransform());tlist.appendItem(svgroot.createSVGTransform());}
break;case"fhellipse":case"fhrect":case"fhpath":started=true;start_x=x;start_y=y;d_attr=x+","+y+" ";var stroke_w=cur_shape.stroke_width==0?1:cur_shape.stroke_width;addSvgElementFromJson({"element":"polyline","attr":{"points":d_attr,"id":getNextId(),"fill":"none","stroke":cur_shape.stroke,"stroke-width":stroke_w,"stroke-dasharray":cur_shape.stroke_style,"stroke-opacity":cur_shape.stroke_opacity,"stroke-linecap":"round","stroke-linejoin":"round","opacity":cur_shape.opacity/2,"style":"pointer-events:none"}});freehand.minx=x;freehand.maxx=x;freehand.miny=y;freehand.miny=y;break;case"image":started=true;start_x=x;start_y=y;var newImage=addSvgElementFromJson({"element":"image","attr":{"x":x,"y":y,"id":getNextId(),"opacity":cur_shape.opacity/2,"style":"pointer-events:inherit"}});newImage.setAttributeNS(xlinkns,"href",currStamp.uri);preventClickDefault(newImage);break;case"square":case"rect":started=true;start_x=x;start_y=y;addSvgElementFromJson({"element":"rect","attr":{"x":x,"y":y,"width":0,"height":0,"id":getNextId(),"fill":cur_shape.fill,"stroke":cur_shape.stroke,"stroke-width":cur_shape.stroke_width,"stroke-dasharray":cur_shape.stroke_style,"stroke-opacity":cur_shape.stroke_opacity,"fill-opacity":cur_shape.fill_opacity,"opacity":cur_shape.opacity/2,"style":"pointer-events:inherit"}});break;case"line":started=true;var stroke_w=cur_shape.stroke_width==0?1:cur_shape.stroke_width;addSvgElementFromJson({"element":"line","attr":{"x1":x,"y1":y,"x2":x,"y2":y,"id":getNextId(),"stroke":cur_shape.stroke,"stroke-width":stroke_w,"stroke-dasharray":cur_shape.stroke_style,"stroke-opacity":cur_shape.stroke_opacity,"fill":"none","opacity":cur_shape.opacity/2,"style":"pointer-events:none"}});break;case"circle":started=true;addSvgElementFromJson({"element":"circle","attr":{"cx":x,"cy":y,"r":0,"id":getNextId(),"fill":cur_shape.fill,"stroke":cur_shape.stroke,"stroke-width":cur_shape.stroke_width,"stroke-dasharray":cur_shape.stroke_style,"stroke-opacity":cur_shape.stroke_opacity,"fill-opacity":cur_shape.fill_opacity,"opacity":cur_shape.opacity/2,"style":"pointer-events:inherit"}});break;case"ellipse":started=true;addSvgElementFromJson({"element":"ellipse","attr":{"cx":x,"cy":y,"rx":0,"ry":0,"id":getNextId(),"fill":cur_shape.fill,"stroke":cur_shape.stroke,"stroke-width":cur_shape.stroke_width,"stroke-dasharray":cur_shape.stroke_style,"stroke-opacity":cur_shape.stroke_opacity,"fill-opacity":cur_shape.fill_opacity,"opacity":cur_shape.opacity/2,"style":"pointer-events:inherit"}});break;case"text":started=true;var newText=addSvgElementFromJson({"element":"text","attr":{"x":x,"y":y,"id":getNextId(),"fill":cur_text.fill,"stroke":cur_shape.stroke,"stroke-width":cur_text.stroke_width,"stroke-dasharray":cur_shape.stroke_style,"stroke-opacity":cur_shape.stroke_opacity,"fill-opacity":cur_shape.fill_opacity,"opacity":cur_shape.opacity,"font-size":cur_text.font_size,"font-family":cur_text.font_family,"text-anchor":"middle","style":"pointer-events:inherit","xml:space":"preserve"}});newText.textContent="text";break;case"path":case"pathedit":pathActions.mouseDown(evt,mouse_target,start_x,start_y);started=true;break;case"rotate":started=true;canvas.beginUndoableChange("transform",selectedElements);break;default:console.log("Unknown mode in mousedown: "+current_mode);break;}};var mouseMove=function(evt)
{if(!started)return;var selected=selectedElements[0];var pt=transformPoint(evt.pageX,evt.pageY,root_sctm);var mouse_x=pt.x;var mouse_y=pt.y;var shape=getElem(getId());x=mouse_x/current_zoom;y=mouse_y/current_zoom;evt.preventDefault();switch(current_mode)
{case"select":if(selectedElements[0]!=null){var dx=x-start_x;var dy=y-start_y;if(dx!=0||dy!=0){var len=selectedElements.length;for(var i=0;i<len;++i){var selected=selectedElements[i];if(selected==null)break;if(i==0){var box=canvas.getBBox(selected);selectedBBoxes[i].x=box.x+dx;selectedBBoxes[i].y=box.y+dy;}
var xform=svgroot.createSVGTransform();var tlist=canvas.getTransformList(selected);xform.setTranslate(dx,dy);if(tlist.numberOfItems){tlist.replaceItem(xform,0);}else{tlist.appendItem(xform);}
selectorManager.requestSelector(selected).resize();}}}
break;case"multiselect":x*=current_zoom;y*=current_zoom;assignAttributes(rubberBox,{'x':Math.min(start_x,x),'y':Math.min(start_y,y),'width':Math.abs(x-start_x),'height':Math.abs(y-start_y)},100);var elemsToRemove=[],elemsToAdd=[];var newList=getIntersectionList();var len=selectedElements.length;for(var i=0;i<len;++i){var ind=newList.indexOf(selectedElements[i]);if(ind==-1){elemsToRemove.push(selectedElements[i]);}
else{newList[ind]=null;}}
len=newList.length;for(var i=0;i<len;++i){if(newList[i])elemsToAdd.push(newList[i]);}
if(elemsToRemove.length>0)
canvas.removeFromSelection(elemsToRemove);if(elemsToAdd.length>0)
canvas.addToSelection(elemsToAdd);break;case"resize":var tlist=canvas.getTransformList(selected);var hasMatrix=hasMatrixTransform(tlist);var box=hasMatrix?init_bbox:canvas.getBBox(selected),left=box.x,top=box.y,width=box.width,height=box.height,dx=(x-start_x),dy=(y-start_y);var angle=canvas.getRotationAngle(selected);if(angle){var r=Math.sqrt(dx*dx+dy*dy);var theta=Math.atan2(dy,dx)-angle*Math.PI/180.0;dx=r*Math.cos(theta);dy=r*Math.sin(theta);}
if(current_resize_mode.indexOf("n")==-1&&current_resize_mode.indexOf("s")==-1){dy=0;}
if(current_resize_mode.indexOf("e")==-1&&current_resize_mode.indexOf("w")==-1){dx=0;}
var ts=null;var tx=0,ty=0;var sy=height?(height+dy)/height:1,sx=width?(width+dx)/width:1;if(current_resize_mode.indexOf("n")!=-1){sy=height?(height-dy)/height:1;ty=height;}
if(current_resize_mode.indexOf("w")!=-1){sx=width?(width-dx)/width:1;tx=width;}
var translateOrigin=svgroot.createSVGTransform(),scale=svgroot.createSVGTransform(),translateBack=svgroot.createSVGTransform();translateOrigin.setTranslate(-(left+tx),-(top+ty));if(evt.shiftKey){if(sx==1)sx=sy
else sy=sx;}
scale.setScale(sx,sy);translateBack.setTranslate(left+tx,top+ty);if(hasMatrix){var diff=angle?1:0;tlist.replaceItem(translateOrigin,2+diff);tlist.replaceItem(scale,1+diff);tlist.replaceItem(translateBack,0+diff);}else{var N=tlist.numberOfItems;tlist.replaceItem(translateBack,N-3);tlist.replaceItem(scale,N-2);tlist.replaceItem(translateOrigin,N-1);}
var selectedBBox=selectedBBoxes[0];selectedBBox.x=left;selectedBBox.y=top;if(tx){selectedBBox.x+=dx;}
if(ty){selectedBBox.y+=dy;}
selectorManager.requestSelector(selected).resize();break;case"zoom":x*=current_zoom;y*=current_zoom;assignAttributes(rubberBox,{'x':Math.min(start_x*current_zoom,x),'y':Math.min(start_y*current_zoom,y),'width':Math.abs(x-start_x*current_zoom),'height':Math.abs(y-start_y*current_zoom)},100);break;case"text":assignAttributes(shape,{'x':x,'y':y},1000);break;case"line":var handle=null;if(!window.opera)svgroot.suspendRedraw(1000);shape.setAttributeNS(null,"x2",x);shape.setAttributeNS(null,"y2",y);if(!window.opera)svgroot.unsuspendRedraw(handle);break;case"square":case"rect":var square=(current_mode=='square')||evt.shiftKey;var w=Math.abs(x-start_x),h=Math.abs(y-start_y),new_x,new_y;if(square){w=h=Math.max(w,h);new_x=start_x<x?start_x:start_x-w;new_y=start_y<y?start_y:start_y-h;}else{new_x=Math.min(start_x,x);new_y=Math.min(start_y,y);}
assignAttributes(shape,{'width':w,'height':h,'x':new_x,'y':new_y},1000);case"image":break;case"circle":var cx=shape.getAttributeNS(null,"cx");var cy=shape.getAttributeNS(null,"cy");var rad=Math.sqrt((x-cx)*(x-cx)+(y-cy)*(y-cy));shape.setAttributeNS(null,"r",rad);break;case"ellipse":var cx=shape.getAttributeNS(null,"cx");var cy=shape.getAttributeNS(null,"cy");var handle=null;if(!window.opera)svgroot.suspendRedraw(1000);shape.setAttributeNS(null,"rx",Math.abs(x-cx));var ry=Math.abs(evt.shiftKey?(x-cx):(y-cy));shape.setAttributeNS(null,"ry",ry);if(!window.opera)svgroot.unsuspendRedraw(handle);break;case"fhellipse":case"fhrect":freehand.minx=Math.min(x,freehand.minx);freehand.maxx=Math.max(x,freehand.maxx);freehand.miny=Math.min(y,freehand.miny);freehand.maxy=Math.max(y,freehand.maxy);case"fhpath":start_x=x;start_y=y;d_attr+=+x+","+y+" ";shape.setAttributeNS(null,"points",d_attr);break;case"path":case"pathedit":pathActions.mouseMove(mouse_x,mouse_y);break;case"rotate":var box=canvas.getBBox(selected),cx=box.x+box.width/2,cy=box.y+box.height/2;var m=transformListToTransform(canvas.getTransformList(selected)).matrix;var center=transformPoint(cx,cy,m);cx=center.x;cy=center.y;var angle=((Math.atan2(cy-y,cx-x)*(180/Math.PI))-90)%360;canvas.setRotationAngle(angle<-180?(360+angle):angle,true);call("changed",selectedElements);break;default:break;}};var mouseUp=function(evt)
{var tempJustSelected=justSelected;justSelected=null;if(!started)return;var pt=transformPoint(evt.pageX,evt.pageY,root_sctm);var mouse_x=pt.x;var mouse_y=pt.y;var x=mouse_x/current_zoom;var y=mouse_y/current_zoom;started=false;var element=getElem(getId());var keep=false;switch(current_mode)
{case"resize":case"multiselect":if(rubberBox!=null){rubberBox.setAttribute("display","none");curBBoxes=[];}
current_mode="select";case"select":if(selectedElements[0]!=null){if(selectedElements[1]==null){var selected=selectedElements[0];if(selected.tagName!="g"&&selected.tagName!="image"){cur_properties.fill=selected.getAttribute("fill");cur_properties.fill_opacity=selected.getAttribute("fill-opacity");cur_properties.stroke=selected.getAttribute("stroke");cur_properties.stroke_opacity=selected.getAttribute("stroke-opacity");cur_properties.stroke_width=selected.getAttribute("stroke-width");cur_properties.stroke_style=selected.getAttribute("stroke-dasharray");}
if(selected.tagName=="text"){cur_text.font_size=selected.getAttribute("font-size");cur_text.font_family=selected.getAttribute("font-family");}
selectorManager.requestSelector(selected).showGrips(true);}
recalculateAllSelectedDimensions();if(x!=start_x||y!=start_y){var len=selectedElements.length;for(var i=0;i<len;++i){if(selectedElements[i]==null)break;if(selectedElements[i].tagName!='g'){selectorManager.requestSelector(selectedElements[i]).resize();}}}
else{var t=evt.target;if(selectedElements[0].nodeName=="path"&&selectedElements[1]==null){pathActions.select(t);}
else if(evt.shiftKey){if(tempJustSelected!=t){canvas.removeFromSelection([t]);}}}}
return;break;case"zoom":if(rubberBox!=null){rubberBox.setAttribute("display","none");}
var factor=evt.shiftKey?.5:2;call("zoomed",{'x':Math.min(start_x,x),'y':Math.min(start_y,y),'width':Math.abs(x-start_x),'height':Math.abs(y-start_y),'factor':factor});return;case"fhpath":var coords=element.getAttribute('points');var commaIndex=coords.indexOf(',');if(commaIndex>=0){keep=coords.indexOf(',',commaIndex+1)>=0;}else{keep=coords.indexOf(' ',coords.indexOf(' ')+1)>=0;}
break;case"line":keep=(element.getAttribute('x1')!=element.getAttribute('x2')||element.getAttribute('y1')!=element.getAttribute('y2'));break;case"square":case"rect":keep=(element.getAttribute('width')!=0||element.getAttribute('height')!=0);break;case"image":assignAttributes(element,{'width':currStamp.width,'height':currStamp.height,'x':x-currStamp.width/2,'y':y-currStamp.height/2},1000);keep=true;break;case"circle":keep=(element.getAttribute('r')!=0);break;case"ellipse":keep=(element.getAttribute('rx')!=null||element.getAttribute('ry')!=null);break;case"fhellipse":if((freehand.maxx-freehand.minx)>0&&(freehand.maxy-freehand.miny)>0){element=addSvgElementFromJson({"element":"ellipse","attr":{"cx":(freehand.minx+freehand.maxx)/2,"cy":(freehand.miny+freehand.maxy)/2,"rx":(freehand.maxx-freehand.minx)/2,"ry":(freehand.maxy-freehand.miny)/2,"id":getId(),"fill":cur_shape.fill,"stroke":cur_shape.stroke,"stroke-width":cur_shape.stroke_width,"stroke-dasharray":cur_shape.stroke_style,"opacity":cur_shape.opacity,"stroke-opacity":cur_shape.stroke_opacity,"fill-opacity":cur_shape.fill_opacity,"style":"pointer-events:inherit"}});call("changed",[element]);keep=true;}
break;case"fhrect":if((freehand.maxx-freehand.minx)>0&&(freehand.maxy-freehand.miny)>0){element=addSvgElementFromJson({"element":"rect","attr":{"x":freehand.minx,"y":freehand.miny,"width":(freehand.maxx-freehand.minx),"height":(freehand.maxy-freehand.miny),"id":getId(),"fill":cur_shape.fill,"stroke":cur_shape.stroke,"stroke-width":cur_shape.stroke_width,"stroke-dasharray":cur_shape.stroke_style,"opacity":cur_shape.opacity,"stroke-opacity":cur_shape.stroke_opacity,"fill-opacity":cur_shape.fill_opacity,"style":"pointer-events:inherit"}});call("changed",[element]);keep=true;}
break;case"text":keep=true;canvas.clearSelection();break;case"path":element=null;started=true;var res=pathActions.mouseUp(evt,element,mouse_x,mouse_y);element=res.element;keep=res.keep;break;case"pathedit":keep=true;element=null;pathActions.mouseUp(evt);break;case"rotate":keep=true;element=null;current_mode="select";var batchCmd=canvas.finishUndoableChange();if(!batchCmd.isEmpty()){addCommandToHistory(batchCmd);}
recalculateAllSelectedDimensions();break;default:console.log("Unknown mode in mouseup: "+current_mode);break;}
if(!keep&&element!=null){element.parentNode.removeChild(element);element=null;var t=evt.target;while(t.parentNode.parentNode.tagName=="g"){t=t.parentNode;}
if((current_mode!="path"||current_path_pts.length==0)&&t.parentNode.id!="selectorParentGroup"&&t.id!="svgcanvas"&&t.id!="svgroot")
{canvas.addToSelection([t],true);canvas.setMode("select");}}else if(element!=null){canvas.addedNew=true;element.setAttribute("opacity",cur_shape.opacity);element.setAttribute("style","pointer-events:inherit");cleanupElement(element);if(current_mode=="path"){pathActions.toEditMode(element);}else if(current_mode=="text"){canvas.addToSelection([element],true);}
addCommandToHistory(new InsertElementCommand(element));call("changed",[element]);}
start_transform=null;};$(container).mousedown(mouseDown).mousemove(mouseMove);$(window).mouseup(mouseUp);}());var pathActions=function(){var pathFuncs=[];var current_path=null;var current_path_pts=[];var current_path_pt=-1;var current_path_pt_drag=-1;var current_path_oldd=null;var current_ctrl_pt_drag=-1;var link_control_pts=false;var resetPointGrips=function(){if(!current_path)return;var sr=svgroot.suspendRedraw(100);removeAllPointGripsFromPath();recalcPathPoints();addAllPointGripsToPath();svgroot.unsuspendRedraw(sr);};var setPointContainerTransform=function(value){var conts=$('#pathpointgrip_container,#ctrlpointgrip_container');$.each(conts,function(){if(!value){this.removeAttribute("transform");}else{this.setAttribute("transform",value);}});}
var recalcPathPoints=function(){current_path_pts=[];var segList=current_path.pathSegList;var curx=segList.getItem(0).x,cury=segList.getItem(0).y;current_path_pts.push(curx*current_zoom);current_path_pts.push(cury*current_zoom);var len=segList.numberOfItems;for(var i=1;i<len;++i){var l=segList.getItem(i);var x=l.x,y=l.y;if(l.pathSegType==1){break;}
var type=l.pathSegType;if(type==4){curx=x;cury=y;}
else if(type==5){curx+=x;cury+=y;}
else if(type==6){curx=x;cury=y;}
else if(type==7){curx+=x;cury+=y;}
current_path_pts.push(curx*current_zoom);current_path_pts.push(cury*current_zoom);}}
var removeAllPointGripsFromPath=function(){$('#pathpointgrip_container > *').attr("display","none");var line=getElem("path_stretch_line");if(line)line.setAttribute("display","none");$('#ctrlpointgrip_container *').attr('display','none');};var addNodeToSelection=function(point){var is_closed=pathIsClosed();if(is_closed&&point==current_path_pts.length/2-1){current_path_pt=0;}else{current_path_pt=point;}
$('#pathpointgrip_container circle').attr('stroke','#00F');var grip=$('#pathpointgrip_'+point).attr('stroke','#0FF');$('#ctrlpointgrip_container circle').attr('fill','#EEE');$('#ctrlpointgrip_'+current_path_pt+'c1, #ctrlpointgrip_'+current_path_pt+'c2').attr('fill','#0FF');updateSegLine();updateSegLine(true);call("selected",[grip[0]]);}
var addAllPointGripsToPath=function(pointToSelect){var len=current_path_pts.length;for(var i=0;i<len;i+=2){var grip=getElem("pathpointgrip_"+i/2);if(grip){assignAttributes(grip,{'cx':current_path_pts[i],'cy':current_path_pts[i+1],'display':'inline'});}
else{addPointGripToPath(current_path_pts[i],current_path_pts[i+1],i/2);}
var index=i/2;var item=current_path.pathSegList.getItem(index);if(item.pathSegType==6){index-=1;var cur_x=getPathPoint(index)[0];var cur_y=getPathPoint(index)[1];var next_x=getPathPoint(index+1)[0];var next_y=getPathPoint(index+1)[1];addControlPointGrip(item.x1,item.y1,cur_x,cur_y,index+'c1');addControlPointGrip(item.x2,item.y2,next_x,next_y,index+'c2');}}
var angle=canvas.getRotationAngle(current_path);if(angle){var bbox=canvas.getBBox(current_path);var cx=(bbox.x+bbox.width/2)*current_zoom,cy=(bbox.y+bbox.height/2)*current_zoom;var xform=["rotate(",angle," ",cx,",",cy,")"].join("");setPointContainerTransform(xform);}
if(pointToSelect!=null){addNodeToSelection(pointToSelect);}};var addPointGripToPath=function(x,y,index){var pointGripContainer=getElem("pathpointgrip_container");if(!pointGripContainer){var parent=getElem("selectorParentGroup");pointGripContainer=parent.appendChild(document.createElementNS(svgns,"g"));pointGripContainer.id="pathpointgrip_container";}
var pointGrip=getElem("pathpointgrip_"+index);if(!pointGrip){pointGrip=document.createElementNS(svgns,"circle");assignAttributes(pointGrip,{'id':"pathpointgrip_"+index,'display':"none",'r':4,'fill':"#0FF",'stroke':"#00F",'stroke-width':2,'cursor':'move','style':'pointer-events:all','xlink:title':uiStrings.pathNodeTooltip});pointGrip=pointGripContainer.appendChild(pointGrip);var grip=$('#pathpointgrip_'+index);grip.dblclick(function(){canvas.setSegType();});}
assignAttributes(pointGrip,{'cx':x,'cy':y,'display':"inline"});};var pathIsClosed=function(){if(!current_path)return;return current_path.getAttribute('d').substr(-1,1).toLowerCase()=='z';}
var updateSegLine=function(next_node){var segLine=getElem("segline");if(!segLine){var pointGripContainer=$('#pathpointgrip_container')[0];segLine=document.createElementNS(svgns,"path");assignAttributes(segLine,{'id':"segline",'fill':"none",'stroke':"#0FF",'stroke-width':2,'style':'pointer-events:none'});segLine=pointGripContainer.appendChild(segLine);}
if(!segLine.getAttribute('d')){var pt=getPathPoint(current_path_pt);segLine.setAttribute('d','M'+pt.join(',')+' 0,0');}
segLine.setAttribute('display','inline');if(current_path_pt+1>=current_path.pathSegList.numberOfItems){segLine.setAttribute('display','none');return;}
if(!next_node){replacePathSeg(2,0,getPathPoint(current_path_pt,true),segLine);}else{var seg=current_path.pathSegList.getItem(current_path_pt+1);var points=[seg.x,seg.y];if(seg.x1!=null&&seg.x2!=null){points.splice(2,0,seg.x1,seg.y1,seg.x2,seg.y2);}
points=$.map(points,function(n){return n*current_zoom;});replacePathSeg(seg.pathSegType,1,points,segLine);}}
var updatePath=function(mouse_x,mouse_y,old_path_pts){var x=mouse_x/current_zoom;var y=mouse_y/current_zoom;var is_closed=pathIsClosed();var i=current_path_pt_drag*2;var last_index=current_path_pts.length/2-1;var is_first=current_path_pt_drag==0||(is_closed&&current_path_pt_drag==last_index);var is_last=!is_closed&&current_path_pt_drag==last_index;var angle=canvas.getRotationAngle(current_path,true);if(angle){var box=selectedBBoxes[0];var cx=(box.x+box.width/2)*current_zoom,cy=(box.y+box.height/2)*current_zoom;var dx=mouse_x-cx,dy=mouse_y-cy;var r=Math.sqrt(dx*dx+dy*dy);var theta=Math.atan2(dy,dx)-angle;current_path_pts[i]=mouse_x=cx+r*Math.cos(theta);current_path_pts[i+1]=mouse_y=cy+r*Math.sin(theta);x=mouse_x/current_zoom;y=mouse_y/current_zoom;}
else{current_path_pts[i]=x*current_zoom;current_path_pts[i+1]=y*current_zoom;}
if(is_first&&is_closed){current_path_pts[0]=current_path_pts[i];current_path_pts[1]=current_path_pts[i+1];current_path_pt_drag=0;}
var index=current_path_pt_drag;var abs_x=getPathPoint(index)[0];var abs_y=getPathPoint(index)[1];var item=current_path.pathSegList.getItem(index);var x_diff=x-old_path_pts[index*2];var y_diff=y-old_path_pts[index*2+1];var cur_type=item.pathSegType;var points=[];if(cur_type==6){points=[abs_x,abs_y,item.x1,item.y1,item.x2+x_diff,item.y2+y_diff];}else{if(is_first){points=getPathPoint(0);}else{points=[abs_x,abs_y];}}
replacePathSeg(cur_type,index,points);var setSeg=function(index,first){var points,item=current_path.pathSegList.getItem(index);var type=item.pathSegType;if(first){item.x+=x_diff;item.y+=y_diff;}
switch(type){case 1:points=[];break;case 4:points=[item.x,item.y];break;case 6:if(first){item.x1-=x_diff;item.y1-=y_diff;item.x2+=x_diff;item.y2+=y_diff;}
points=[item.x,item.y,item.x1+x_diff,item.y1+y_diff,item.x2,item.y2];break;default:break;}
replacePathSeg(type,index,points);return type;}
if(is_closed||!is_last){var next_type=setSeg(index+1);}else{var next_type=0;}
if(is_first&&is_closed){var last_type=setSeg(last_index,1);}
var grip=getElem("pathpointgrip_"+current_path_pt_drag);if(grip){grip.setAttribute("cx",mouse_x);grip.setAttribute("cy",mouse_y);if(is_closed&&is_first){var grip=getElem("pathpointgrip_"+last_index);grip.setAttribute("cx",mouse_x);grip.setAttribute("cy",mouse_y);}
call("changed",[grip]);}
if(is_first)cur_type=last_type;if(cur_type!=4){var num=is_first?last_index:index;var id2=(num-1)+'c2';var line=getElem("ctrlLine_"+id2);if(line){if(!(!is_closed&&current_path_pt_drag==0)){var x2=line.getAttribute('x2')-0+x_diff*current_zoom;var y2=line.getAttribute('y2')-0+y_diff*current_zoom;addControlPointGrip(x2,y2,mouse_x,mouse_y,id2,true);}}}
if(next_type!=4){var id1=(current_path_pt_drag)+'c1';var line=getElem("ctrlLine_"+id1);if(line){var x2=line.getAttribute('x2')-0+x_diff*current_zoom;var y2=line.getAttribute('y2')-0+y_diff*current_zoom;addControlPointGrip(x2,y2,mouse_x,mouse_y,id1,true);}}
updateSegLine();if(next_type!=4){updateSegLine(true);}}
var updateCurvedSegment=function(mouse_x,mouse_y,index,ctrl_num){var list=current_path.pathSegList;if(index+1>=list.numberOfItems){index=-1;}
var c_item=list.getItem(index+1);if(c_item.pathSegType!=6)return;ctrl_pt_drag=index+'c'+ctrl_num;var x=mouse_x/current_zoom;var y=mouse_y/current_zoom;var angle=canvas.getRotationAngle(current_path,true);if(angle){var box=selectedBBoxes[0];var cx=(box.x+box.width/2)*current_zoom,cy=(box.y+box.height/2)*current_zoom;var dx=mouse_x-cx,dy=mouse_y-cy;var r=Math.sqrt(dx*dx+dy*dy);var theta=Math.atan2(dy,dx)-angle;mouse_x=cx+r*Math.cos(theta);mouse_y=cy+r*Math.sin(theta);x=mouse_x/current_zoom;y=mouse_y/current_zoom;}
c_item['x'+ctrl_num]=x;c_item['y'+ctrl_num]=y;replacePathSeg(6,index+1,[c_item.x,c_item.y,c_item.x1,c_item.y1,c_item.x2,c_item.y2]);updateSegLine(true);var grip=getElem("ctrlpointgrip_"+ctrl_pt_drag);if(grip){grip.setAttribute("cx",mouse_x);grip.setAttribute("cy",mouse_y);var line=getElem("ctrlLine_"+ctrl_pt_drag);line.setAttribute("x2",mouse_x);line.setAttribute("y2",mouse_y);}}
var getPathPoint=function(index,raw_val){var len=current_path_pts.length;var pt_num=len/2;if(index<0){index+=pt_num;}else if(index>=pt_num){index-=pt_num;}
var z=raw_val?1:current_zoom;return[current_path_pts[index*2]/z,current_path_pts[index*2+1]/z];}
var replacePathSeg=function(type,index,pts,path){if(!path)path=current_path;var func='createSVGPathSeg'+pathFuncs[type];var seg=path[func].apply(path,pts);if(support.pathReplaceItem){path.pathSegList.replaceItem(seg,index);}else{var segList=path.pathSegList;var len=segList.numberOfItems;var arr=[];for(var i=0;i<len;i++){var cur_seg=segList.getItem(i);arr.push(cur_seg)}
segList.clear();for(var i=0;i<len;i++){if(i==index){segList.appendItem(seg);}else{segList.appendItem(arr[i]);}}}}
var addControlPointGrip=function(x,y,source_x,source_y,id,raw_val){if(!raw_val){x*=current_zoom;y*=current_zoom;source_x*=current_zoom;source_y*=current_zoom;}
var ctrlPointGripContainer=getElem("ctrlpointgrip_container");if(!ctrlPointGripContainer){var parent=getElem("selectorParentGroup");ctrlPointGripContainer=parent.appendChild(document.createElementNS(svgns,"g"));ctrlPointGripContainer.id="ctrlpointgrip_container";}
ctrlPointGripContainer.setAttribute("display","inline");var ctrlLine=getElem("ctrlLine_"+id);if(!ctrlLine){ctrlLine=document.createElementNS(svgns,"line");assignAttributes(ctrlLine,{'id':"ctrlLine_"+id,'stroke':"#555",'stroke-width':1,"style":"pointer-events:none"});ctrlLine=ctrlPointGripContainer.appendChild(ctrlLine);}
assignAttributes(ctrlLine,{'x1':source_x,'y1':source_y,'x2':x,'y2':y,'display':"inline"});var pointGrip=getElem("ctrlpointgrip_"+id);if(!pointGrip){pointGrip=document.createElementNS(svgns,"circle");assignAttributes(pointGrip,{'id':"ctrlpointgrip_"+id,'display':"none",'r':4,'fill':"#0FF",'stroke':"#55F",'stroke-width':1,'cursor':'move','style':'pointer-events:all','xlink:title':uiStrings.pathCtrlPtTooltip});pointGrip=ctrlPointGripContainer.appendChild(pointGrip);}
assignAttributes(pointGrip,{'cx':x,'cy':y,'display':"inline"});}
var removeControlPointGrips=function(index){for(var i=1;i<=2;i++){$("#ctrlpointgrip_"+index+"c"+i+",#ctrlLine_"+index+"c"+i).attr("display","none");}}
var recalcRotatedPath=function(){var angle=canvas.getRotationAngle(current_path,true);if(!angle)return;var box=canvas.getBBox(current_path);var oldbox=selectedBBoxes[0];var oldcx=oldbox.x+oldbox.width/2,oldcy=oldbox.y+oldbox.height/2,newcx=box.x+box.width/2,newcy=box.y+box.height/2;var dx=newcx-oldcx,dy=newcy-oldcy;var r=Math.sqrt(dx*dx+dy*dy);var theta=Math.atan2(dy,dx)+angle;newcx=r*Math.cos(theta)+oldcx;newcy=r*Math.sin(theta)+oldcy;var getRotVals=function(x,y){dx=x-oldcx;dy=y-oldcy;r=Math.sqrt(dx*dx+dy*dy);theta=Math.atan2(dy,dx)+angle;dx=r*Math.cos(theta)+oldcx;dy=r*Math.sin(theta)+oldcy;dx-=newcx;dy-=newcy;r=Math.sqrt(dx*dx+dy*dy);theta=Math.atan2(dy,dx)-angle;return{'x':(r*Math.cos(theta)+newcx)/1,'y':(r*Math.sin(theta)+newcy)/1};}
var list=current_path.pathSegList;var i=list.numberOfItems;while(i){i-=1;var seg=list.getItem(i);var type=seg.pathSegType;if(type==1)continue;var rvals=getRotVals(seg.x,seg.y);var points=[rvals.x,rvals.y];if(seg.x1!=null&&seg.x2!=null){c_vals1=getRotVals(seg.x1,seg.y1);c_vals2=getRotVals(seg.x2,seg.y2);points.splice(points.length,0,c_vals1.x,c_vals1.y,c_vals2.x,c_vals2.y);}
replacePathSeg(type,i,points);}
box=canvas.getBBox(current_path);selectedBBoxes[0].x=box.x;selectedBBoxes[0].y=box.y;selectedBBoxes[0].width=box.width;selectedBBoxes[0].height=box.height;var R_nc=svgroot.createSVGTransform();var tlist=canvas.getTransformList(current_path);R_nc.setRotate((angle*180.0/Math.PI),newcx,newcy);tlist.replaceItem(R_nc,0);if(getElem("pathpointgrip_container")){var pcx=newcx*current_zoom,pcy=newcy*current_zoom;var xform=["rotate(",(angle*180.0/Math.PI)," ",pcx,",",pcy,")"].join("");setPointContainerTransform(xform);}
resetPointGrips();updateSegLine(true);updateSegLine();}
return{init:function(){pathFuncs=[0,'ClosePath'];var pathFuncsStrs=['Moveto','Lineto','CurvetoCubic','CurvetoQuadratic','Arc','LinetoHorizontal','LinetoVertical','CurvetoCubicSmooth','CurvetoQuadraticSmooth'];$.each(pathFuncsStrs,function(i,s){pathFuncs.push(s+'Abs');pathFuncs.push(s+'Rel');});},mouseDown:function(evt,mouse_target,start_x,start_y){if(current_mode=="path"){setPointContainerTransform("");return;}
if(!current_path)return;current_path_oldd=current_path.getAttribute("d");var id=evt.target.id;if(id.substr(0,14)=="pathpointgrip_"){current_path_pt_drag=parseInt(id.substr(14));addNodeToSelection(current_path_pt_drag);updateSegLine();}else if(id.indexOf("ctrlpointgrip_")==0){current_ctrl_pt_drag=id.split('_')[1];var node_num=current_ctrl_pt_drag.split('c')[0]-0;addNodeToSelection(node_num);}
if(current_path_pt_drag==-1&&current_ctrl_pt_drag==-1){canvas.clearSelection();if(mouse_target.id!="svgroot"){current_path=null;canvas.addToSelection([mouse_target],true);canvas.setMode("select");var tlist=canvas.getTransformList(mouse_target);tlist.insertItemBefore(svgroot.createSVGTransform(),0);}
else{canvas.setMode("multiselect");if(rubberBox==null){rubberBox=selectorManager.getRubberBandBox();}
assignAttributes(rubberBox,{'x':start_x,'y':start_y,'width':0,'height':0,'display':'inline'},100);}}},mouseMove:function(mouse_x,mouse_y){if(current_mode=="path"){var line=getElem("path_stretch_line");if(line){line.setAttribute("x2",x*=current_zoom);line.setAttribute("y2",y*=current_zoom);}
return;}
if(current_path_pt_drag!=-1&&current_path){var old_path_pts=$.map(current_path_pts,function(n){return n/current_zoom;});updatePath(mouse_x,mouse_y,old_path_pts);}else if(current_ctrl_pt_drag!=-1&&current_path){var data=current_ctrl_pt_drag.split('c');var index=data[0]-0;var ctrl_num=data[1]-0;var pt_index;var pt_count=current_path_pts.length/2;updateCurvedSegment(mouse_x,mouse_y,index,ctrl_num);if(link_control_pts){var is_closed=pathIsClosed();if(ctrl_num==1){ctrl_num=2;index--;pt_index=index+1;if(index<0){index=pt_count-2;if(!is_closed)return;}}else{ctrl_num=1;index++;pt_index=index;if(index>=pt_count-1){index=0;if(!is_closed)return;}}
var pt=getPathPoint(pt_index,true);var new_x=pt[0]-(mouse_x-pt[0]);var new_y=pt[1]-(mouse_y-pt[1]);updateCurvedSegment(new_x,new_y,index,ctrl_num,true);}}},mouseUp:function(evt,element,mouse_x,mouse_y){if(current_mode=="path"){var x=mouse_x/current_zoom;var y=mouse_y/current_zoom;var stretchy=getElem("path_stretch_line");if(!stretchy){stretchy=document.createElementNS(svgns,"line");assignAttributes(stretchy,{'id':"path_stretch_line",'stroke':"blue",'stroke-width':"0.5"});stretchy=getElem("selectorParentGroup").appendChild(stretchy);}
stretchy.setAttribute("display","inline");var keep=null;if(current_path_pts.length==0){current_path_pts.push(x);current_path_pts.push(y);d_attr="M"+x+","+y+" ";addSvgElementFromJson({"element":"path","attr":{"d":d_attr,"id":getNextId(),"fill":cur_shape.fill,"fill-opacity":cur_shape.fill_opacity,"stroke":cur_shape.stroke,"stroke-width":cur_shape.stroke_width,"stroke-dasharray":cur_shape.stroke_style,"stroke-opacity":cur_shape.stroke_opacity,"opacity":cur_shape.opacity/2,"style":"pointer-events:inherit"}});assignAttributes(stretchy,{'x1':mouse_x,'y1':mouse_y,'x2':mouse_x,'y2':mouse_y});addPointGripToPath(mouse_x,mouse_y,0);}
else{var i=current_path_pts.length;var FUZZ=6/current_zoom;var clickOnPoint=false;while(i){i-=2;var px=current_path_pts[i],py=current_path_pts[i+1];if(x>=(px-FUZZ)&&x<=(px+FUZZ)&&y>=(py-FUZZ)&&y<=(py+FUZZ)){clickOnPoint=true;break;}}
var path=getElem(getId());var len=current_path_pts.length;if(clickOnPoint){if(i==0&&len>=6){var abs_x=current_path_pts[0];var abs_y=current_path_pts[1];d_attr+=['L',abs_x,',',abs_y,'z'].join('');path.setAttribute("d",d_attr);}else if(len<3){keep=false;return keep;}
removeAllPointGripsFromPath();element=path;current_path_pts=[];started=false;}
else{var lastx=current_path_pts[len-2],lasty=current_path_pts[len-1];current_path_pts.push(x);current_path_pts.push(y);d_attr+="L"+round(x)+","+round(y)+" ";path.setAttribute("d",d_attr);assignAttributes(stretchy,{'x1':mouse_x,'y1':mouse_y,'x2':mouse_x,'y2':mouse_y});addPointGripToPath(mouse_x,mouse_y,(current_path_pts.length/2-1));}
keep=true;}
return{keep:keep,element:element}}
if(current_path_pt_drag!=-1){current_path_pt_drag=-1;var batchCmd=new BatchCommand("Edit Path");var oldvalues={};oldvalues["d"]=current_path_oldd;recalcRotatedPath();batchCmd.addSubCommand(new ChangeElementCommand(current_path,oldvalues,"path points"));addCommandToHistory(batchCmd);call("changed",[current_path]);if(pathIsClosed()){current_path_pts[current_path_pts.length-2]=getPathPoint(0,true)[0];current_path_pts[current_path_pts.length-1]=getPathPoint(0,true)[1];}}
else if(current_ctrl_pt_drag!=-1){current_ctrl_pt_drag=-1;recalcRotatedPath();var batchCmd=new BatchCommand("Edit Path control points");batchCmd.addSubCommand(new ChangeElementCommand(current_path,{d:current_path_oldd}));addCommandToHistory(batchCmd);call("changed",[current_path]);}
else{current_mode="select";removeAllPointGripsFromPath();canvas.clearSelection();canvas.addToSelection([evt.target]);}},toEditMode:function(element){current_path=element;current_mode="pathedit";var angle=canvas.getRotationAngle(element);if(!angle)setPointContainerTransform();recalcPathPoints();canvas.clearSelection();selectedBBoxes[0]=canvas.getBBox(current_path);addAllPointGripsToPath();addNodeToSelection(0);},select:function(target){if(current_path==target){pathActions.toEditMode(current_path);current_mode="pathedit";}
else{current_path=target;}},reorient:function(){var elem=selectedElements[0];if(!elem)return;var angle=canvas.getRotationAngle(elem);if(angle==0)return;var batchCmd=new BatchCommand("Reorient path");var changes={d:elem.getAttribute('d'),transform:elem.getAttribute('transform')};batchCmd.addSubCommand(new ChangeElementCommand(elem,changes));canvas.clearSelection();this.resetOrientation(elem);addCommandToHistory(batchCmd);current_path=elem;setPointContainerTransform("");resetPointGrips();this.clear();canvas.addToSelection([elem],true);call("changed",selectedElements);},clear:function(remove){if(remove&&current_mode=="path"){var elem=getElem(getId());if(elem)elem.parentNode.removeChild(elem);}
removeAllPointGripsFromPath();current_path_pts=[];current_path_pt=-1;current_path=null;},resetOrientation:function(path){if(path==null||path.nodeName!='path')return false;var tlist=canvas.getTransformList(path);var m=transformListToTransform(tlist).matrix;tlist.clear();path.removeAttribute("transform");var segList=path.pathSegList;try{var len=segList.numberOfItems;}catch(err){var fixed_d=pathActions.convertPath(path);path.setAttribute('d',fixed_d);segList=path.pathSegList;var len=segList.numberOfItems;}
for(var i=0;i<len;++i){var seg=segList.getItem(i);var type=seg.pathSegType;if(type==1)continue;var pts=[];$.each(['',1,2],function(j,n){var x=seg['x'+n],y=seg['y'+n];if(x&&y){var pt=transformPoint(x,y,m);pts.splice(pts.length,0,pt.x,pt.y);}});replacePathSeg(type,i,pts,path);}},zoomChange:function(){if(current_mode=="pathedit"){resetPointGrips();}},modeChange:function(){if(current_mode=="path"&&current_path_pts.length>0){var elem=getElem(getId());elem.parentNode.removeChild(elem);this.clear();canvas.clearSelection();started=false;}
else if(current_mode=="pathedit"){this.clear();}},getNodePoint:function(){if(current_path_pt!=-1){var pt=getPathPoint(current_path_pt,true);var list=current_path.pathSegList;var segtype;if(list.numberOfItems>current_path_pt+1){segtype=list.getItem(current_path_pt+1).pathSegType;}else{segtype=false;}
return{x:pt[0],y:pt[1],type:segtype}}else{return false;}},linkControlPoints:function(linkPoints){link_control_pts=linkPoints;},clonePathNode:function(){var pt=current_path_pt,list=current_path.pathSegList;var next_item=list.getItem(pt+1);if(next_item.pathSegType%2==0){var cur_item=list.getItem(pt);var new_x=(next_item.x+cur_item.x)/2;var new_y=(next_item.y+cur_item.y)/2;}else{var new_x=next_item.x/2;var new_y=next_item.y/2;}
var seg=current_path.createSVGPathSegLinetoAbs(new_x,new_y);if(support.pathInsertItemBefore){list.insertItemBefore(seg,pt+1);}else{var segList=current_path.pathSegList;var len=segList.numberOfItems;var arr=[];for(var i=0;i<len;i++){var cur_seg=segList.getItem(i);arr.push(cur_seg)}
segList.clear();for(var i=0;i<len;i++){if(i==pt+1){segList.appendItem(seg);}
segList.appendItem(arr[i]);}}
var abs_x=(getPathPoint(pt)[0]+new_x)*current_zoom;var abs_y=(getPathPoint(pt)[1]+new_y)*current_zoom;var last_num=current_path_pts.length/2;addPointGripToPath(abs_x,abs_y,last_num);current_path_pts.splice(pt*2+2,0,abs_x,abs_y);resetPointGrips();addNodeToSelection(pt+1);},deletePathNode:function(){var is_closed=pathIsClosed();if(current_path_pts.length<=(is_closed?6:4))return;var last_pt=current_path_pts.length/2-1;var pt=current_path_pt,list=current_path.pathSegList;var cur_item=list.getItem(pt);if(pt==0){var next_x=getPathPoint(1)[0];var next_y=getPathPoint(1)[1];replacePathSeg(2,1,[next_x,next_y]);if(is_closed){var last_item=list.getItem(last_pt);replacePathSeg(4,last_pt,[next_x,next_y]);removeControlPointGrips(last_pt-1);current_path_pts.splice(last_pt*2,2,next_x,next_y);current_path_pts.splice(0,2);}}else{current_path_pts.splice(pt*2,2);}
list.removeItem(pt);resetPointGrips();if(window.opera){var cp=$(current_path);cp.attr('d',cp.attr('d'));}
if(pt==last_pt&&!is_closed){pt--;}
addNodeToSelection(pt);},setPointContainerTransform:setPointContainerTransform,setSegType:function(new_type){var grip=$('#pathpointgrip_'+current_path_pt);var old_d=current_path.getAttribute('d');var index=grip[0].id.split('_')[1]-0;var last_index=current_path_pts.length/2-1;var is_closed=pathIsClosed();if(!is_closed&&index==last_index){return;}else if(index>=last_index&&is_closed){index=0;}
var next_index=index+1;var cur_x=getPathPoint(index)[0];var cur_y=getPathPoint(index)[1];var next_x=getPathPoint(next_index)[0];var next_y=getPathPoint(next_index)[1];if(!new_type){var batchCmd=new BatchCommand("Toggle Path Segment Type");var old_type=current_path.pathSegList.getItem(index+1).pathSegType;new_type=(old_type==6)?4:6;}else{new_type-=0;var batchCmd=new BatchCommand("Change Path Segment Type");}
var points;var bb=current_path.getBBox();switch(new_type){case 6:var diff_x=next_x-cur_x;var diff_y=next_y-cur_y;var ct1_x=cur_x+(diff_y/2);var ct1_y=cur_y-(diff_x/2);var ct2_x=next_x+(diff_y/2);var ct2_y=next_y-(diff_x/2);points=[next_x,next_y,ct1_x,ct1_y,ct2_x,ct2_y];break;case 4:points=[next_x,next_y];removeControlPointGrips(index);break;}
replacePathSeg(new_type,next_index,points);if(isWebkit&&current_path){var fixed_d=pathActions.convertPath(current_path);current_path.setAttribute('d',fixed_d);}
addAllPointGripsToPath();updateSegLine(true);recalcRotatedPath();batchCmd.addSubCommand(new ChangeElementCommand(current_path,{d:old_d}));addCommandToHistory(batchCmd);call("changed",[current_path]);},moveNode:function(attr,newValue){var num=(attr=='x')?0:1;var old_path_pts=$.map(current_path_pts,function(n){return n/current_zoom;});current_path_pts[current_path_pt*2+num]=newValue-0;current_path_pt_drag=current_path_pt;updatePath(current_path_pts[current_path_pt*2],current_path_pts[current_path_pt*2+1],old_path_pts);},convertPath:function(path,toRel){var segList=path.pathSegList;var len=segList.numberOfItems;var curx=0,cury=0;var d="";for(var i=0;i<len;++i){var seg=segList.getItem(i);var x=seg.x||0,y=seg.y||0,x1=seg.x1||0,y1=seg.y1||0,x2=seg.x2||0,y2=seg.y2||0;var type=seg.pathSegType;var letter=pathMap[type]['to'+(toRel?'Lower':'Upper')+'Case']();var addToD=function(pnts,more,last){var str='';var more=more?' '+more.join(' '):'';var last=last?shortFloat(last):'';$.each(pnts,function(i,pnt){pnts[i]=shortFloat(pnt);});d+=letter+pnts.join(' ')+more+last;}
switch(type){case 1:d+="z";break;case 2:case 4:case 12:case 14:case 18:x-=curx;y-=cury;case 3:case 5:case 13:case 15:case 19:if(toRel){curx+=x;cury+=y;}else{x+=curx;y+=cury;curx=x;cury=y;}
addToD([[x,y]]);break;case 6:x-=curx;x1-=curx;x2-=curx;y-=cury;y1-=cury;y2-=cury;case 7:if(toRel){curx+=x;cury+=y;}else{x+=curx;x1+=curx;x2+=curx;y+=cury;y1+=cury;y2+=cury;curx=x;cury=y;}
addToD([[x1,y1],[x2,y2],[x,y]]);break;case 8:x-=curx;x1-=curx;y-=cury;y1-=cury;case 9:if(toRel){curx+=x;cury+=y;}else{x+=curx;x1+=curx;y+=cury;y1+=cury;curx=x;cury=y;}
addToD([[x1,y1],[x,y]]);break;case 10:x-=curx;y-=cury;case 11:if(toRel){curx+=x;cury+=y;}else{x+=curx;y+=cury;curx=x;cury=y;}
addToD([[seg.r1,seg.r2]],[seg.angle,(seg.largeArcFlag?1:0),(seg.sweepFlag?1:0)],[x,y]);break;case 16:x-=curx;x2-=curx;y-=cury;y2-=cury;case 17:if(toRel){curx+=x;cury+=y;}else{x+=curx;x2+=curx;y+=cury;y2+=cury;curx=x;cury=y;}
addToD([[x2,y2],[x,y]]);break;}}
return d;}}}();pathActions.init();this.pathActions=pathActions;var shortFloat=function(val){var digits=save_options.round_digits;if(!isNaN(val)){return Number(Number(val).toFixed(digits));}else if($.isArray(val)){return shortFloat(val[0])+','+shortFloat(val[1]);}}
this.convertToPath=function(elem,getBBox,angle){if(elem==null){var elems=selectedElements;$.each(selectedElements,function(i,elem){if(elem)canvas.convertToPath(elem);});return;}
if(!getBBox){var batchCmd=new BatchCommand("Convert element to Path");}
var attrs=getBBox?{}:{"fill":cur_shape.fill,"fill-opacity":cur_shape.fill_opacity,"stroke":cur_shape.stroke,"stroke-width":cur_shape.stroke_width,"stroke-dasharray":cur_shape.stroke_style,"stroke-opacity":cur_shape.stroke_opacity,"opacity":cur_shape.opacity,"visibility":"hidden"};var path=addSvgElementFromJson({"element":"path","attr":attrs});var eltrans=elem.getAttribute("transform");if(eltrans){path.setAttribute("transform",eltrans);}
var id=elem.id;var parent=elem.parentNode;if(elem.nextSibling){parent.insertBefore(path,elem);}else{parent.appendChild(path);}
var d='';var joinSegs=function(segs){$.each(segs,function(j,seg){var l=seg[0],pts=seg[1];d+=l;for(var i=0;i<pts.length;i+=2){d+=(pts[i]+','+pts[i+1])+' ';}});}
var num=1.81;switch(elem.tagName){case'ellipse':var rx=elem.getAttribute('rx')-0;var ry=elem.getAttribute('ry')-0;case'circle':if(elem.tagName=='circle'){var rx=ry=elem.getAttribute('r')-0;}
var cx=elem.getAttribute('cx')-0;var cy=elem.getAttribute('cy')-0;joinSegs([['M',[(cx-rx),(cy)]],['C',[(cx-rx),(cy-ry/num),(cx-rx/num),(cy-ry),(cx),(cy-ry)]],['C',[(cx+rx/num),(cy-ry),(cx+rx),(cy-ry/num),(cx+rx),(cy)]],['C',[(cx+rx),(cy+ry/num),(cx+rx/num),(cy+ry),(cx),(cy+ry)]],['C',[(cx-rx/num),(cy+ry),(cx-rx),(cy+ry/num),(cx-rx),(cy)]],['Z',[]]]);break;case'path':d=elem.getAttribute('d');break;case'line':var x1=elem.getAttribute('x1');var x2=elem.getAttribute('x2');var y1=elem.getAttribute('y1');var y2=elem.getAttribute('y2');d="M"+x1+","+y1+"L"+x2+","+y2;break;case'polyline':case'polygon':var points=elem.getAttribute('points');d="M"+points;break;case'rect':var rx=elem.getAttribute('rx')-0;var ry=elem.getAttribute('ry')-0;var b=elem.getBBox();var x=b.x,y=b.y,w=b.width,h=b.height;var num=4-num;if(!rx&&!ry){joinSegs([['M',[x,y]],['L',[x+w,y]],['L',[x+w,y+h]],['L',[x,y+h]],['L',[x,y]],['Z',[]]]);}else{joinSegs([['M',[x,y+ry]],['C',[x,y+ry/num,x+rx/num,y,x+rx,y]],['L',[x+w-rx,y]],['C',[x+w-rx/num,y,x+w,y+ry/num,x+w,y+ry]],['L',[x+w,y+h-ry]],['C',[x+w,y+h-ry/num,x+w-rx/num,y+h,x+w-rx,y+h]],['L',[x+rx,y+h]],['C',[x+rx/num,y+h,x,y+h-ry/num,x,y+h-ry]],['L',[x,y+ry]],['Z',[]]]);}
break;default:path.parentNode.removeChild(path);break;}
if(d){path.setAttribute('d',d);}
if(!getBBox){if(eltrans){var tlist=canvas.getTransformList(path);if(hasMatrixTransform(tlist)){pathActions.resetOrientation(path);}}
batchCmd.addSubCommand(new RemoveElementCommand(elem,parent));batchCmd.addSubCommand(new InsertElementCommand(path));canvas.clearSelection();elem.parentNode.removeChild(elem)
path.setAttribute('id',id);path.removeAttribute("visibility");canvas.addToSelection([path],true);addCommandToHistory(batchCmd);}else{pathActions.resetOrientation(path);var bb=false;try{bb=path.getBBox();}catch(e){}
path.parentNode.removeChild(path);return bb;}}
this.open=function(str){call("opened",str);};this.save=function(opts){this.clearSelection();if(opts)$.extend(save_options,opts);save_options.apply=true;var str="<?xml version=\"1.0\" standalone=\"no\"?>\n";str+=svgCanvasToString();call("saved",str);};var walkTree=function(elem,cbFn){if(elem&&elem.nodeType==1){cbFn(elem);var i=elem.childNodes.length;while(i--){walkTree(elem.childNodes.item(i),cbFn);}}};this.getSvgString=function(){save_options.apply=false;return svgCanvasToString();};this.setSvgString=function(xmlString){try{var newDoc=Utils.text2xml(xmlString);sanitizeSvg(newDoc.documentElement);var batchCmd=new BatchCommand("Change Source");var oldzoom=svgroot.removeChild(svgcontent);batchCmd.addSubCommand(new RemoveElementCommand(oldzoom,svgroot));svgcontent=svgroot.appendChild(svgdoc.importNode(newDoc.documentElement,true));$(svgcontent).find('image').each(function(){var image=this;preventClickDefault(image);var val=this.getAttributeNS(xlinkns,"href");if(val.indexOf('data:')===0){var m=val.match(/svgedit_url=(.*?);/);if(m){var url=decodeURIComponent(m[1]);$(new Image()).load(function(){image.setAttributeNS(xlinkns,'href',url);}).attr('src',url);}}
canvas.embedImage(val);});if(!support.goodDecimals){canvas.fixOperaXML(svgcontent,newDoc.documentElement);}
svgcontent.setAttribute('id','svgcontent');var w,h;if(svgcontent.getAttribute("viewBox")){var vb=svgcontent.getAttribute("viewBox").split(' ');w=vb[2];h=vb[3];}
else{w=svgcontent.getAttribute("width");h=svgcontent.getAttribute("height");svgcontent.setAttribute("viewBox",["0","0",w,h].join(" "));}
svgcontent.setAttribute('width','100%');svgcontent.setAttribute('height','100%');batchCmd.addSubCommand(new InsertElementCommand(svgcontent));var changes={};changes['width']=svgroot.getAttribute('width');changes['height']=svgroot.getAttribute('height');svgroot.setAttribute('width',w);svgroot.setAttribute('height',h);batchCmd.addSubCommand(new ChangeElementCommand(svgroot,changes));identifyLayers();svgTransformLists={};canvas.clearSelection();svgroot.appendChild(selectorManager.selectorParentGroup);addCommandToHistory(batchCmd);call("changed",[svgcontent]);}catch(e){console.log(e);return false;}
return true;};this.setStampImages=function(stamps){images=stamps;}
this.setStamp=function(index){currStamp=images[index];};var identifyLayers=function(){all_layers=[];var numchildren=svgcontent.childNodes.length;var orphans=[],layernames=[];for(var i=0;i<numchildren;++i){var child=svgcontent.childNodes.item(i);if(child&&child.nodeType==1){if(child.tagName=="g"){var name=$("title",child).text();if(name){layernames.push(name);all_layers.push([name,child]);current_layer=child;walkTree(child,function(e){e.setAttribute("style","pointer-events:inherit");});current_layer.setAttribute("style","pointer-events:none");}
else{orphans.push(child);}}
else if(canvas.getBBox(child)&&child.nodeName!='defs'){var bb=canvas.getBBox(child);orphans.push(child);}}}
if(orphans.length>0){var i=1;while($.inArray(("Layer "+i),layernames)!=-1){i++;}
var newname="Layer "+i;current_layer=svgdoc.createElementNS(svgns,"g");var layer_title=svgdoc.createElementNS(svgns,"title");layer_title.textContent=newname;current_layer.appendChild(layer_title);for(var j=0;j<orphans.length;++j){current_layer.appendChild(orphans[j]);}
current_layer=svgcontent.appendChild(current_layer);all_layers.push([newname,current_layer]);}
walkTree(current_layer,function(e){e.setAttribute("style","pointer-events:inherit");});current_layer.setAttribute("style","pointer-events:all");};this.createLayer=function(name){var batchCmd=new BatchCommand("Create Layer");var new_layer=svgdoc.createElementNS(svgns,"g");var layer_title=svgdoc.createElementNS(svgns,"title");layer_title.textContent=name;new_layer.appendChild(layer_title);new_layer=svgcontent.appendChild(new_layer);batchCmd.addSubCommand(new InsertElementCommand(new_layer));addCommandToHistory(batchCmd);canvas.clearSelection();identifyLayers();canvas.setCurrentLayer(name);call("changed",[new_layer]);};this.deleteCurrentLayer=function(){if(current_layer&&all_layers.length>1){var batchCmd=new BatchCommand("Delete Layer");var parent=current_layer.parentNode;batchCmd.addSubCommand(new RemoveElementCommand(current_layer,parent));parent.removeChild(current_layer);addCommandToHistory(batchCmd);canvas.clearSelection();identifyLayers();canvas.setCurrentLayer(all_layers[all_layers.length-1][0]);call("changed",[svgcontent]);return true;}
return false;};this.getNumLayers=function(){return all_layers.length;};this.getLayer=function(i){if(i>=0&&i<canvas.getNumLayers()){return all_layers[i][0];}
return"";};this.getCurrentLayer=function(){for(var i=0;i<all_layers.length;++i){if(all_layers[i][1]==current_layer){return all_layers[i][0];}}
return"";};this.setCurrentLayer=function(name){name=toXml(name);for(var i=0;i<all_layers.length;++i){if(name==all_layers[i][0]){if(current_layer!=all_layers[i][1]){canvas.clearSelection();current_layer.setAttribute("style","pointer-events:none");current_layer=all_layers[i][1];current_layer.setAttribute("style","pointer-events:all");}
return true;}}
return false;};this.renameCurrentLayer=function(newname){if(current_layer){var oldLayer=current_layer;if(!canvas.setCurrentLayer(newname)){var batchCmd=new BatchCommand("Rename Layer");for(var i=0;i<all_layers.length;++i){if(all_layers[i][1]==oldLayer)break;}
var oldname=all_layers[i][0];all_layers[i][0]=toXml(newname);var len=oldLayer.childNodes.length;for(var i=0;i<len;++i){var child=oldLayer.childNodes.item(i);if(child&&child.tagName=="title"){while(child.firstChild){child.removeChild(child.firstChild);}
child.textContent=newname;batchCmd.addSubCommand(new ChangeElementCommand(child,{"#text":oldname}));addCommandToHistory(batchCmd);call("changed",[oldLayer]);return true;}}}
current_layer=oldLayer;}
return false;};this.setCurrentLayerPosition=function(newpos){if(current_layer&&newpos>=0&&newpos<all_layers.length){for(var oldpos=0;oldpos<all_layers.length;++oldpos){if(all_layers[oldpos][1]==current_layer)break;}
if(oldpos==all_layers.length){return false;}
if(oldpos!=newpos){var refLayer=null;var oldNextSibling=current_layer.nextSibling;if(newpos>oldpos){if(newpos<all_layers.length-1){refLayer=all_layers[newpos+1][1];}}
else{refLayer=all_layers[newpos][1];}
svgcontent.insertBefore(current_layer,refLayer);addCommandToHistory(new MoveElementCommand(current_layer,oldNextSibling,svgcontent));identifyLayers();canvas.setCurrentLayer(all_layers[newpos][0]);return true;}}
return false;};this.getLayerVisibility=function(layername){var layer=null;for(var i=0;i<all_layers.length;++i){if(all_layers[i][0]==layername){layer=all_layers[i][1];break;}}
if(!layer)return false;return(layer.getAttribute("display")!="none");};this.setLayerVisibility=function(layername,bVisible){var layer=null;for(var i=0;i<all_layers.length;++i){if(all_layers[i][0]==layername){layer=all_layers[i][1];break;}}
if(!layer)return false;var oldDisplay=layer.getAttribute("display");if(!oldDisplay)oldDisplay="inline";layer.setAttribute("display",bVisible?"inline":"none");addCommandToHistory(new ChangeElementCommand(layer,{"display":oldDisplay},"Layer Visibility"));if(layer==current_layer){canvas.clearSelection();}
return true;};this.moveSelectedToLayer=function(layername){var layer=null;for(var i=0;i<all_layers.length;++i){if(all_layers[i][0]==layername){layer=all_layers[i][1];break;}}
if(!layer)return false;var batchCmd=new BatchCommand("Move Elements to Layer");var selElems=selectedElements;var i=selElems.length;while(i--){var elem=selElems[i];if(!elem)continue;var oldNextSibling=elem.nextSibling;var oldLayer=elem.parentNode;layer.appendChild(elem);batchCmd.addSubCommand(new MoveElementCommand(elem,oldNextSibling,oldLayer));}
addCommandToHistory(batchCmd);return true;};this.getLayerOpacity=function(layername){for(var i=0;i<all_layers.length;++i){if(all_layers[i][0]==layername){var g=all_layers[i][1];var opacity=g.getAttribute("opacity");if(!opacity){opacity="1.0";}
return parseFloat(opacity);}}
return null;};this.setLayerOpacity=function(layername,opacity){if(opacity<0.0||opacity>1.0)return;for(var i=0;i<all_layers.length;++i){if(all_layers[i][0]==layername){var g=all_layers[i][1];g.setAttribute("opacity",opacity);break;}}};this.clear=function(){pathActions.clear();var nodes=svgcontent.childNodes;var len=svgcontent.childNodes.length;var i=0;this.clearSelection();for(var rep=0;rep<len;rep++){if(nodes[i].nodeType==1){svgcontent.removeChild(nodes[i]);}else{i++;}}
all_layers=[];canvas.createLayer("Layer 1");resetUndoStack();selectorManager.initGroup();rubberBox=selectorManager.getRubberBandBox();call("cleared");};this.linkControlPoints=function(linkPoints){pathActions.linkControlPoints(linkPoints);}
this.getResolution=function(){var vb=svgcontent.getAttribute("viewBox").split(' ');return{'w':vb[2],'h':vb[3],'zoom':current_zoom};};this.getImageTitle=function(){var childs=svgcontent.childNodes;for(var i=0;i<childs.length;i++){if(childs[i].nodeName=='title'){return childs[i].textContent;}}
return'';}
this.setImageTitle=function(newtitle){var childs=svgcontent.childNodes,doc_title=false,old_title='';var batchCmd=new BatchCommand("Change Image Title");for(var i=0;i<childs.length;i++){if(childs[i].nodeName=='title'){doc_title=childs[i];old_title=doc_title.textContent;break;}}
if(!doc_title){doc_title=svgdoc.createElementNS(svgns,"title");svgcontent.insertBefore(doc_title,svgcontent.firstChild);}
if(newtitle.length){doc_title.textContent=newtitle;}else{doc_title.parentNode.removeChild(doc_title);}
batchCmd.addSubCommand(new ChangeElementCommand(doc_title,{'#text':old_title}));addCommandToHistory(batchCmd);}
this.setResolution=function(x,y){var res=canvas.getResolution();var w=res.w,h=res.h;var batchCmd;if(x=='fit'){var bbox=canvas.getStrokedBBox();if(bbox){batchCmd=new BatchCommand("Fit Canvas to Content");var visEls=canvas.getVisibleElements();canvas.addToSelection(visEls);var dx=[],dy=[];$.each(visEls,function(i,item){dx.push(bbox.x*-1);dy.push(bbox.y*-1);});var cmd=canvas.moveSelectedElements(dx,dy,true);batchCmd.addSubCommand(cmd);canvas.clearSelection();x=Math.round(bbox.width);y=Math.round(bbox.height);}else{return false;}}
x*=current_zoom;y*=current_zoom;if(x!=w||y!=h){var handle=svgroot.suspendRedraw(1000);if(!batchCmd){batchCmd=new BatchCommand("Change Image Dimensions");}
svgroot.setAttribute('width',x);svgroot.setAttribute('height',y);batchCmd.addSubCommand(new ChangeElementCommand(svgroot,{"width":w,"height":h}));svgcontent.setAttribute("viewBox",["0 0",x/current_zoom,y/current_zoom].join(' '));batchCmd.addSubCommand(new ChangeElementCommand(svgcontent,{"viewBox":["0 0",w,h].join(' ')}));addCommandToHistory(batchCmd);svgroot.unsuspendRedraw(handle);call("changed",[svgcontent]);}
return true;};this.setBBoxZoom=function(val,editor_w,editor_h){var spacer=.85;var bb;var calcZoom=function(bb){if(!bb)return false;var w_zoom=Math.round((editor_w/bb.width)*100*spacer)/100;var h_zoom=Math.round((editor_h/bb.height)*100*spacer)/100;var zoomlevel=Math.min(w_zoom,h_zoom);canvas.setZoom(zoomlevel);return{'zoom':zoomlevel,'bbox':bb};}
if(typeof val=='object'){bb=val;if(bb.width==0||bb.height==0){var newzoom=bb.zoom?bb.zoom:current_zoom*bb.factor;canvas.setZoom(newzoom);return{'zoom':current_zoom,'bbox':bb};}
return calcZoom(bb);}
switch(val){case'selection':if(!selectedElements[0])return;var sel_elems=$.map(selectedElements,function(n){if(n)return n;});bb=canvas.getStrokedBBox(sel_elems);break;case'canvas':var res=canvas.getResolution();spacer=.95;bb={width:res.w,height:res.h,x:0,y:0};break;case'content':bb=canvas.getStrokedBBox();break;case'layer':bb=canvas.getStrokedBBox(canvas.getVisibleElements(current_layer));break;default:return;}
return calcZoom(bb);}
this.setZoom=function(zoomlevel){var res=canvas.getResolution();svgroot.setAttribute("width",res.w*zoomlevel);svgroot.setAttribute("height",res.h*zoomlevel);current_zoom=zoomlevel;$.each(selectedElements,function(i,elem){if(!elem)return;selectorManager.requestSelector(elem).resize();});pathActions.zoomChange();}
this.getMode=function(){return current_mode;};this.setMode=function(name){pathActions.modeChange();cur_properties=(selectedElements[0]&&selectedElements[0].nodeName=='text')?cur_text:cur_shape;current_mode=name;};this.getStrokeColor=function(){return cur_properties.stroke;};this.setStrokeColor=function(val,preventUndo){cur_shape.stroke=val;cur_properties.stroke_paint={type:"solidColor"};if(!preventUndo)
this.changeSelectedAttribute("stroke",val);else
this.changeSelectedAttributeNoUndo("stroke",val);};this.getFillColor=function(){return cur_properties.fill;};this.setFillColor=function(val,preventUndo){cur_properties.fill=val;cur_properties.fill_paint={type:"solidColor"};var elems=[];var i=selectedElements.length;while(i--){var elem=selectedElements[i];if(elem&&elem.tagName!="polyline"&&elem.tagName!="line"){elems.push(elem);}}
if(elems.length>0){if(!preventUndo)
this.changeSelectedAttribute("fill",val,elems);else
this.changeSelectedAttributeNoUndo("fill",val,elems);}};var findDefs=function(){var defs=svgcontent.getElementsByTagNameNS(svgns,"defs");if(defs.length>0){defs=defs[0];}
else{defs=svgcontent.insertBefore(svgdoc.createElementNS(svgns,"defs"),svgcontent.firstChild.nextSibling);}
return defs;};var addGradient=function(){$.each(['stroke','fill'],function(i,type){if(!cur_properties[type+'_paint']||cur_properties[type+'_paint'].type=="solidColor")return;var grad=canvas[type+'Grad'];var duplicate_grad=findDuplicateGradient(grad);var defs=findDefs();if(!duplicate_grad){var orig_grad=grad;grad=defs.appendChild(svgdoc.importNode(grad,true));canvas.fixOperaXML(grad,orig_grad);grad.id=getNextId();}
else{grad=duplicate_grad;}
var functype=type=='fill'?'Fill':'Stroke';canvas['set'+functype+'Color']("url(#"+grad.id+")");});}
var findDuplicateGradient=function(grad){var defs=findDefs();var existing_grads=defs.getElementsByTagNameNS(svgns,"linearGradient");var i=existing_grads.length;while(i--){var og=existing_grads.item(i);if(grad.getAttribute('x1')!=og.getAttribute('x1')||grad.getAttribute('y1')!=og.getAttribute('y1')||grad.getAttribute('x2')!=og.getAttribute('x2')||grad.getAttribute('y2')!=og.getAttribute('y2'))
{continue;}
var stops=grad.getElementsByTagNameNS(svgns,"stop");var ostops=og.getElementsByTagNameNS(svgns,"stop");if(stops.length!=ostops.length){continue;}
var j=stops.length;while(j--){var stop=stops.item(j);var ostop=ostops.item(j);if(stop.getAttribute('offset')!=ostop.getAttribute('offset')||stop.getAttribute('stop-opacity')!=ostop.getAttribute('stop-opacity')||stop.getAttribute('stop-color')!=ostop.getAttribute('stop-color'))
{break;}}
if(j==-1){return og;}}
return null;};this.setStrokePaint=function(p,addGrad){var p=new $.jGraduate.Paint(p);this.setStrokeOpacity(p.alpha/100);cur_properties.stroke_paint=p;if(p.type=="solidColor"){this.setStrokeColor("#"+p.solidColor);}
else if(p.type=="linearGradient"){canvas.strokeGrad=p.linearGradient;if(addGrad)addGradient();}
else{}};this.setFillPaint=function(p,addGrad){var p=new $.jGraduate.Paint(p);this.setFillOpacity(p.alpha/100,true);cur_properties.fill_paint=p;if(p.type=="solidColor"){this.setFillColor("#"+p.solidColor);}
else if(p.type=="linearGradient"){canvas.fillGrad=p.linearGradient;if(addGrad)addGradient();}
else{}};this.getStrokeWidth=function(){return cur_properties.stroke_width;};this.setStrokeWidth=function(val){if(val==0&&$.inArray(current_mode,['line','path'])!=-1){canvas.setStrokeWidth(1);return;}
cur_properties.stroke_width=val;this.changeSelectedAttribute("stroke-width",val);};this.getStrokeStyle=function(){return cur_shape.stroke_style;};this.setStrokeStyle=function(val){cur_shape.stroke_style=val;this.changeSelectedAttribute("stroke-dasharray",val);};this.getOpacity=function(){return cur_shape.opacity;};this.setOpacity=function(val){cur_shape.opacity=val;this.changeSelectedAttribute("opacity",val);};this.getFillOpacity=function(){return cur_shape.fill_opacity;};this.setFillOpacity=function(val,preventUndo){cur_shape.fill_opacity=val;if(!preventUndo)
this.changeSelectedAttribute("fill-opacity",val);else
this.changeSelectedAttributeNoUndo("fill-opacity",val);};this.getStrokeOpacity=function(){return cur_shape.stroke_opacity;};this.setStrokeOpacity=function(val,preventUndo){cur_shape.stroke_opacity=val;if(!preventUndo)
this.changeSelectedAttribute("stroke-opacity",val);else
this.changeSelectedAttributeNoUndo("stroke-opacity",val);};this.getTransformList=function(elem){if(isWebkit||!support.goodDecimals){var t=svgTransformLists[elem.id];if(!t){svgTransformLists[elem.id]=new SVGEditTransformList(elem);svgTransformLists[elem.id]._init();t=svgTransformLists[elem.id];}
return t;}
else if(elem.transform){return elem.transform.baseVal;}
return null;};this.getBBox=function(elem){var selected=elem||selectedElements[0];if(elem.nodeType!=1)return null;var ret=null;if(elem.nodeName=='text'&&selected.textContent==''){selected.textContent='a';ret=selected.getBBox();selected.textContent='';}else if(elem.nodeName=='g'&&isOpera){ret=selected.getBBox();var newg=document.createElementNS(svgns,"g");while(selected.firstChild){newg.appendChild(selected.firstChild);}
var i=selected.attributes.length;while(i--){newg.setAttributeNode(selected.attributes.item(i).cloneNode(true));}
selected.parentNode.appendChild(newg);ret=newg.getBBox();while(newg.firstChild){selected.appendChild(newg.firstChild);}
selected.parentNode.removeChild(newg);}else{try{ret=selected.getBBox();}
catch(e){ret=null;}}
return ret;};this.getRotationAngle=function(elem,to_rad){var selected=elem||selectedElements[0];var tlist=canvas.getTransformList(selected);if(!tlist)return 0;var N=tlist.numberOfItems;for(var i=0;i<N;++i){var xform=tlist.getItem(i);if(xform.type==4){return to_rad?xform.angle*Math.PI/180.0:xform.angle;}}
return 0.0;};this.setRotationAngle=function(val,preventUndo){val=parseFloat(val);var elem=selectedElements[0];var oldTransform=elem.getAttribute("transform");var bbox=canvas.getBBox(elem);var cx=bbox.x+bbox.width/2,cy=bbox.y+bbox.height/2;var tlist=canvas.getTransformList(elem);if(tlist.numberOfItems>0){var xform=tlist.getItem(0);if(xform.type==4){tlist.removeItem(0);}}
if(val!=0){var center=transformPoint(cx,cy,transformListToTransform(tlist).matrix);var R_nc=svgroot.createSVGTransform();R_nc.setRotate(val,center.x,center.y);tlist.insertItemBefore(R_nc,0);}
else if(tlist.numberOfItems==0){elem.removeAttribute("transform");}
if(!preventUndo){var newTransform=elem.getAttribute("transform");elem.setAttribute("transform",oldTransform);this.changeSelectedAttribute("transform",newTransform,selectedElements);}
var pointGripContainer=getElem("pathpointgrip_container");if(elem.nodeName=="path"&&pointGripContainer){pathActions.setPointContainerTransform(elem.getAttribute("transform"));}
var selector=selectorManager.requestSelector(selectedElements[0]);selector.resize();selector.updateGripCursors(val);};this.each=function(cb){$(svgroot).children().each(cb);};this.bind=function(event,f){var old=events[event];events[event]=f;return old;};this.setIdPrefix=function(p){idprefix=p;};this.getBold=function(){var selected=selectedElements[0];if(selected!=null&&selected.tagName=="text"&&selectedElements[1]==null)
{return(selected.getAttribute("font-weight")=="bold");}
return false;};this.setBold=function(b){var selected=selectedElements[0];if(selected!=null&&selected.tagName=="text"&&selectedElements[1]==null)
{this.changeSelectedAttribute("font-weight",b?"bold":"normal");}};this.getItalic=function(){var selected=selectedElements[0];if(selected!=null&&selected.tagName=="text"&&selectedElements[1]==null)
{return(selected.getAttribute("font-style")=="italic");}
return false;};this.setItalic=function(i){var selected=selectedElements[0];if(selected!=null&&selected.tagName=="text"&&selectedElements[1]==null)
{this.changeSelectedAttribute("font-style",i?"italic":"normal");}};this.getFontFamily=function(){return cur_text.font_family;};this.setFontFamily=function(val){cur_text.font_family=val;this.changeSelectedAttribute("font-family",val);};this.getFontSize=function(){return cur_text.font_size;};this.setFontSize=function(val){cur_text.font_size=val;this.changeSelectedAttribute("font-size",val);};this.getText=function(){var selected=selectedElements[0];if(selected==null){return"";}
return selected.textContent;};this.setTextContent=function(val){this.changeSelectedAttribute("#text",val);};this.setImageURL=function(val){svgCanvas.changeSelectedAttribute("#href",val);};this.setRectRadius=function(val){var selected=selectedElements[0];if(selected!=null&&selected.tagName=="rect"){var r=selected.getAttribute("rx");if(r!=val){selected.setAttribute("rx",val);selected.setAttribute("ry",val);addCommandToHistory(new ChangeElementCommand(selected,{"rx":r,"ry":r},"Radius"));call("changed",[selected]);}}};this.setSegType=function(new_type){pathActions.setSegType(new_type);}
var ffClone=function(elem){if(navigator.userAgent.indexOf('Gecko/')==-1)return elem;var clone=elem.cloneNode(true)
elem.parentNode.insertBefore(clone,elem);elem.parentNode.removeChild(elem);selectorManager.releaseSelector(elem);selectedElements[0]=clone;selectorManager.requestSelector(clone).showGrips(true);return clone;}
var undoChangeStackPointer=-1;var undoableChangeStack=[];this.beginUndoableChange=function(attrName,elems){var p=++undoChangeStackPointer;var i=elems.length;var oldValues=new Array(i),elements=new Array(i);while(i--){var elem=elems[i];if(elem==null)continue;elements[i]=elem;oldValues[i]=elem.getAttribute(attrName);}
undoableChangeStack[p]={'attrName':attrName,'oldValues':oldValues,'elements':elements};};this.changeSelectedAttributeNoUndo=function(attr,newValue,elems){var handle=svgroot.suspendRedraw(1000);if(current_mode=='pathedit'){pathActions.moveNode(attr,newValue);}
var elems=elems||selectedElements;var i=elems.length;while(i--){var elem=elems[i];if(elem==null)continue;if((attr=='x'||attr=='y')&&$.inArray(elem.tagName,['g','polyline','path'])!=-1){var bbox=canvas.getStrokedBBox([elem]);var diff_x=attr=='x'?newValue-bbox.x:0;var diff_y=attr=='y'?newValue-bbox.y:0;canvas.moveSelectedElements(diff_x*current_zoom,diff_y*current_zoom,true);continue;}
if(elem.tagName=="g"&&(attr!="transform"&&attr!="opacity"))continue;var oldval=attr=="#text"?elem.textContent:elem.getAttribute(attr);if(oldval==null)oldval="";if(oldval!=String(newValue)){if(attr=="#text"){var old_w=canvas.getBBox(elem).width;elem.textContent=newValue;elem=ffClone(elem);}else if(attr=="#href"){elem.setAttributeNS(xlinkns,"href",newValue);}
else elem.setAttribute(attr,newValue);if(i==0)
selectedBBoxes[i]=this.getBBox(elem);if(elem.nodeName=='text'){if((newValue+'').indexOf('url')==0||$.inArray(attr,['font-size','font-family','x','y'])!=-1){elem=ffClone(elem);}}
setTimeout(function(){selectorManager.requestSelector(elem).resize();},0);var angle=canvas.getRotationAngle(elem);if(angle!=0&&attr!="transform"){var tlist=canvas.getTransformList(elem);var n=tlist.numberOfItems;while(n--){var xform=tlist.getItem(n);if(xform.type==4){tlist.removeItem(n);var box=canvas.getBBox(elem);var center=transformPoint(box.x+box.width/2,box.y+box.height/2,transformListToTransform(tlist).matrix);var cx=center.x,cy=center.y;var newrot=svgroot.createSVGTransform();newrot.setRotate(angle,cx,cy);tlist.insertItemBefore(newrot,n);break;}}}}}
svgroot.unsuspendRedraw(handle);};this.finishUndoableChange=function(){var p=undoChangeStackPointer--;var changeset=undoableChangeStack[p];var i=changeset['elements'].length;var attrName=changeset['attrName'];var batchCmd=new BatchCommand("Change "+attrName);while(i--){var elem=changeset['elements'][i];if(elem==null)continue;var changes={};changes[attrName]=changeset['oldValues'][i];if(changes[attrName]!=elem.getAttribute(attrName)){batchCmd.addSubCommand(new ChangeElementCommand(elem,changes,attrName));}}
undoableChangeStack[p]=null;return batchCmd;};this.changeSelectedAttribute=function(attr,val,elems){var elems=elems||selectedElements;canvas.beginUndoableChange(attr,elems);var i=elems.length;canvas.changeSelectedAttributeNoUndo(attr,val,elems);var batchCmd=canvas.finishUndoableChange();if(!batchCmd.isEmpty()){addCommandToHistory(batchCmd);}};this.deleteSelectedElements=function(){var batchCmd=new BatchCommand("Delete Elements");var len=selectedElements.length;var selectedCopy=[];for(var i=0;i<len;++i){var selected=selectedElements[i];if(selected==null)break;var parent=selected.parentNode;var t=selected;selectorManager.releaseSelector(t);var elem=parent.removeChild(t);selectedCopy.push(selected)
selectedElements[i]=null;batchCmd.addSubCommand(new RemoveElementCommand(elem,parent));}
if(!batchCmd.isEmpty())addCommandToHistory(batchCmd);call("changed",selectedCopy);canvas.clearSelection();};this.groupSelectedElements=function(){var batchCmd=new BatchCommand("Group Elements");var g=addSvgElementFromJson({"element":"g","attr":{"id":getNextId()}});batchCmd.addSubCommand(new InsertElementCommand(g));var i=selectedElements.length;while(i--){var elem=selectedElements[i];if(elem==null)continue;var oldNextSibling=elem.nextSibling;var oldParent=elem.parentNode;g.appendChild(elem);batchCmd.addSubCommand(new MoveElementCommand(elem,oldNextSibling,oldParent));}
if(!batchCmd.isEmpty())addCommandToHistory(batchCmd);canvas.clearSelection();canvas.addToSelection([g],true);};this.ungroupSelectedElement=function(){var g=selectedElements[0];if(g.tagName=="g"){var batchCmd=new BatchCommand("Ungroup Elements");var parent=g.parentNode;var anchor=g.previousSibling;var children=new Array(g.childNodes.length);var xform=g.getAttribute("transform");var glist=canvas.getTransformList(g);var m=transformListToTransform(glist).matrix;var i=0;var gangle=canvas.getRotationAngle(g);while(g.firstChild){var elem=g.firstChild;var oldNextSibling=elem.nextSibling;var oldParent=elem.parentNode;children[i++]=elem=parent.insertBefore(elem,anchor);batchCmd.addSubCommand(new MoveElementCommand(elem,oldNextSibling,oldParent));var chtlist=canvas.getTransformList(elem);if(glist.numberOfItems){if(gangle&&glist.numberOfItems==1){var rgm=glist.getItem(0).matrix;var rcm=svgroot.createSVGMatrix();var cangle=canvas.getRotationAngle(elem);if(cangle){rcm=chtlist.getItem(0).matrix;}
var cbox=canvas.getBBox(elem);var ceqm=transformListToTransform(chtlist).matrix;var coldc=transformPoint(cbox.x+cbox.width/2,cbox.y+cbox.height/2,ceqm);var sangle=gangle+cangle;var r2=svgroot.createSVGTransform();r2.setRotate(sangle,coldc.x,coldc.y);var trm=matrixMultiply(rgm,rcm,r2.matrix.inverse());if(cangle){chtlist.removeItem(0);}
if(sangle){chtlist.insertItemBefore(r2,0);}
if(trm.e||trm.f){var tr=svgroot.createSVGTransform();tr.setTranslate(trm.e,trm.f);chtlist.insertItemBefore(tr,0);}}
else{var oldxform=elem.getAttribute("transform");var changes={};changes["transform"]=oldxform?oldxform:"";var newxform=svgroot.createSVGTransform();var chm=transformListToTransform(chtlist).matrix,chm_inv=chm.inverse();var gm=matrixMultiply(chm_inv,m,chm);newxform.setMatrix(gm);chtlist.appendItem(newxform);}
batchCmd.addSubCommand(recalculateDimensions(elem));}}
if(xform){var changes={};changes["transform"]=xform;g.setAttribute("transform","");g.removeAttribute("transform");batchCmd.addSubCommand(new ChangeElementCommand(g,changes));}
canvas.clearSelection();g=parent.removeChild(g);batchCmd.addSubCommand(new RemoveElementCommand(g,parent));if(!batchCmd.isEmpty())addCommandToHistory(batchCmd);canvas.addToSelection(children);}};this.moveToTopSelectedElement=function(){var selected=selectedElements[0];if(selected!=null){var t=selected;var oldParent=t.parentNode;var oldNextSibling=t.nextSibling;if(oldNextSibling==selectorManager.selectorParentGroup)oldNextSibling=null;t=t.parentNode.appendChild(t);addCommandToHistory(new MoveElementCommand(t,oldNextSibling,oldParent,"top"));}};this.moveToBottomSelectedElement=function(){var selected=selectedElements[0];if(selected!=null){var t=selected;var oldParent=t.parentNode;var oldNextSibling=t.nextSibling;if(oldNextSibling==selectorManager.selectorParentGroup)oldNextSibling=null;var firstChild=t.parentNode.firstChild.nextSibling;if(firstChild.tagName=='defs'){firstChild=firstChild.nextSibling;}
t=t.parentNode.insertBefore(t,firstChild);addCommandToHistory(new MoveElementCommand(t,oldNextSibling,oldParent,"bottom"));}};this.moveSelectedElements=function(dx,dy,undoable){if(dx.constructor!=Array){dx/=current_zoom;dy/=current_zoom;}
var undoable=undoable||true;var batchCmd=new BatchCommand("position");var i=selectedElements.length;while(i--){var selected=selectedElements[i];if(selected!=null){if(i==0)
selectedBBoxes[i]=this.getBBox(selected);var xform=svgroot.createSVGTransform();var tlist=canvas.getTransformList(selected);if(dx.constructor==Array){if(i==0){selectedBBoxes[i].x+=dx[i];selectedBBoxes[i].y+=dy[i];}
xform.setTranslate(dx[i],dy[i]);}else{if(i==0){selectedBBoxes[i].x+=dx;selectedBBoxes[i].y+=dy;}
xform.setTranslate(dx,dy);}
tlist.insertItemBefore(xform,0);var cmd=recalculateDimensions(selected);if(cmd){batchCmd.addSubCommand(cmd);}
selectorManager.requestSelector(selected).resize();}}
if(!batchCmd.isEmpty()){if(undoable)
addCommandToHistory(batchCmd);call("changed",selectedElements);return batchCmd;}};this.getStrokedBBox=function(elems){if(!elems)elems=canvas.getVisibleElements();if(!elems.length)return false;var getCheckedBBox=function(elem){try{var bb=elem.getBBox();var angle=canvas.getRotationAngle(elem);if((angle&&angle%90)||hasMatrixTransform(canvas.getTransformList(elem))){var good_bb=false;var elemNames=['ellipse','path','line','polyline','polygon'];if($.inArray(elem.tagName,elemNames)!=-1){bb=good_bb=canvas.convertToPath(elem,true,angle);}else if(elem.tagName=='rect'){var rx=elem.getAttribute('rx');var ry=elem.getAttribute('ry');if(rx||ry){bb=good_bb=canvas.convertToPath(elem,true,angle);}}
if(!good_bb){var g=document.createElementNS(svgns,"g");var parent=elem.parentNode;parent.replaceChild(g,elem);g.appendChild(elem);bb=g.getBBox();parent.insertBefore(elem,g);parent.removeChild(g);}}
return bb;}catch(e){return null;}}
var full_bb;$.each(elems,function(){if(full_bb)return;full_bb=getCheckedBBox(this);});if(full_bb==null)return null;if(elems.length==1)return full_bb;var max_x=full_bb.x+full_bb.width;var max_y=full_bb.y+full_bb.height;var min_x=full_bb.x;var min_y=full_bb.y;var getOffset=function(elem){var sw=elem.getAttribute("stroke-width");var offset=0;if(elem.getAttribute("stroke")!="none"&&!isNaN(sw)){offset+=sw/2;}
return offset;}
$.each(elems,function(i,elem){var cur_bb=getCheckedBBox(elem);if(!cur_bb)return;var offset=getOffset(elem);min_x=Math.min(min_x,cur_bb.x-offset);min_y=Math.min(min_y,cur_bb.y-offset);});full_bb.x=min_x;full_bb.y=min_y;$.each(elems,function(i,elem){var cur_bb=getCheckedBBox(elem);if(!cur_bb)return;var offset=getOffset(elem);max_x=Math.max(max_x,cur_bb.x+cur_bb.width+offset);max_y=Math.max(max_y,cur_bb.y+cur_bb.height+offset);});full_bb.width=max_x-min_x;full_bb.height=max_y-min_y;return full_bb;}
this.getVisibleElements=function(parent,includeBBox){if(!parent)parent=$(svgcontent).children();var contentElems=[];$(parent).children().each(function(i,elem){try{var box=elem.getBBox();if(box){var item=includeBBox?{'elem':elem,'bbox':canvas.getStrokedBBox([elem])}:elem;contentElems.push(item);}}catch(e){}});return contentElems.reverse();}
this.cycleElement=function(next){var cur_elem=selectedElements[0];var elem=false;var all_elems=this.getVisibleElements(current_layer);if(cur_elem==null){var num=next?all_elems.length-1:0;elem=all_elems[num];}else{var i=all_elems.length;while(i--){if(all_elems[i]==cur_elem){var num=next?i-1:i+1;if(num>=all_elems.length){num=0;}else if(num<0){num=all_elems.length-1;}
elem=all_elems[num];break;}}}
canvas.clearSelection();canvas.addToSelection([elem],true);call("selected",selectedElements);}
var resetUndoStack=function(){undoStack=[];undoStackPointer=0;};this.resetUndo=function(){undoStack=[];undoStackPointer=0;};this.getUndoStackSize=function(){return undoStackPointer;};this.getRedoStackSize=function(){return undoStack.length-undoStackPointer;};this.getNextUndoCommandText=function(){if(undoStackPointer>0)
return undoStack[undoStackPointer-1].text;return"";};this.getNextRedoCommandText=function(){if(undoStackPointer<undoStack.length)
return undoStack[undoStackPointer].text;return"";};this.undo=function(){if(undoStackPointer>0){this.clearSelection();pathActions.clear();var cmd=undoStack[--undoStackPointer];cmd.unapply();call("changed",cmd.elements());}};this.redo=function(){if(undoStackPointer<undoStack.length&&undoStack.length>0){this.clearSelection();var cmd=undoStack[undoStackPointer++];cmd.apply();call("changed",cmd.elements());}};var copyElem=function(el){var new_el=document.createElementNS(svgns,el.nodeName);$.each(el.attributes,function(i,attr){var ns=attr.nodeName=='href'?xlinkns:attr.prefix=="xml"?xmlns:null;new_el.setAttributeNS(ns,attr.nodeName,attr.nodeValue);});new_el.removeAttribute("id");new_el.id=getNextId();obj_num++;if(!support.goodDecimals&&el.nodeName=='path'){var fixed_d=pathActions.convertPath(el);new_el.setAttribute('d',fixed_d);}
$.each(el.childNodes,function(i,child){switch(child.nodeType){case 1:new_el.appendChild(copyElem(child));break;case 3:new_el.textContent=child.nodeValue;break;default:break;}});if(new_el.tagName=='image'){preventClickDefault(new_el);}
return new_el;};var preventClickDefault=function(img){$(img).click(function(e){e.preventDefault()});}
this.cloneSelectedElements=function(){var batchCmd=new BatchCommand("Clone Elements");var len=selectedElements.length;for(var i=0;i<len;++i){var elem=selectedElements[i];if(elem==null)break;}
var copiedElements=selectedElements.slice(0,i);this.clearSelection();var i=copiedElements.length;while(i--){var elem=copiedElements[i]=copyElem(copiedElements[i]);current_layer.appendChild(elem);batchCmd.addSubCommand(new InsertElementCommand(elem));}
if(!batchCmd.isEmpty()){this.addToSelection(copiedElements.reverse());this.moveSelectedElements(20,20,false);addCommandToHistory(batchCmd);call("selected",selectedElements);}};this.alignSelectedElements=function(type,relative_to){var bboxes=[],angles=[];var minx=Number.MAX_VALUE,maxx=Number.MIN_VALUE,miny=Number.MAX_VALUE,maxy=Number.MIN_VALUE;var curwidth=Number.MIN_VALUE,curheight=Number.MIN_VALUE;var len=selectedElements.length;if(!len)return;for(var i=0;i<len;++i){if(selectedElements[i]==null)break;var elem=selectedElements[i];bboxes[i]=canvas.getStrokedBBox([elem]);switch(relative_to){case'smallest':if((type=='l'||type=='c'||type=='r')&&(curwidth==Number.MIN_VALUE||curwidth>bboxes[i].width)||(type=='t'||type=='m'||type=='b')&&(curheight==Number.MIN_VALUE||curheight>bboxes[i].height)){minx=bboxes[i].x;miny=bboxes[i].y;maxx=bboxes[i].x+bboxes[i].width;maxy=bboxes[i].y+bboxes[i].height;curwidth=bboxes[i].width;curheight=bboxes[i].height;}
break;case'largest':if((type=='l'||type=='c'||type=='r')&&(curwidth==Number.MIN_VALUE||curwidth<bboxes[i].width)||(type=='t'||type=='m'||type=='b')&&(curheight==Number.MIN_VALUE||curheight<bboxes[i].height)){minx=bboxes[i].x;miny=bboxes[i].y;maxx=bboxes[i].x+bboxes[i].width;maxy=bboxes[i].y+bboxes[i].height;curwidth=bboxes[i].width;curheight=bboxes[i].height;}
break;default:if(bboxes[i].x<minx)minx=bboxes[i].x;if(bboxes[i].y<miny)miny=bboxes[i].y;if(bboxes[i].x+bboxes[i].width>maxx)maxx=bboxes[i].x+bboxes[i].width;if(bboxes[i].y+bboxes[i].height>maxy)maxy=bboxes[i].y+bboxes[i].height;break;}}
if(relative_to=='page'){minx=0;miny=0;maxx=svgroot.getAttribute('width');maxy=svgroot.getAttribute('height');}
var dx=new Array(len);var dy=new Array(len);for(var i=0;i<len;++i){if(selectedElements[i]==null)break;var elem=selectedElements[i];var bbox=bboxes[i];dx[i]=0;dy[i]=0;switch(type){case'l':dx[i]=minx-bbox.x;break;case'c':dx[i]=(minx+maxx)/2-(bbox.x+bbox.width/2);break;case'r':dx[i]=maxx-(bbox.x+bbox.width);break;case't':dy[i]=miny-bbox.y;break;case'm':dy[i]=(miny+maxy)/2-(bbox.y+bbox.height/2);break;case'b':dy[i]=maxy-(bbox.y+bbox.height);break;}}
this.moveSelectedElements(dx,dy);};this.getZoom=function(){return current_zoom;};this.getVersion=function(){return"svgcanvas.js ($Rev: 1141 $)";};this.setUiStrings=function(strs){$.extend(uiStrings,strs);}
this.clear();function getElem(id){if(svgroot.querySelector){return svgroot.querySelector('#'+id);}else if(svgdoc.evaluate){return svgdoc.evaluate('svg:svg[@id="svgroot"]//svg:*[@id="'+id+'"]',container,function(){return"http://www.w3.org/2000/svg";},9,null).singleNodeValue;}else{return $(svgroot).find('[id='+id+']')[0];}}
(function(){var path=document.createElementNS(svgns,'path');path.setAttribute('d','M0,0 10,10');var seglist=path.pathSegList;var seg=path.createSVGPathSegLinetoAbs(5,5);try{seglist.replaceItem(seg,0);support.pathReplaceItem=true;}catch(err){support.pathReplaceItem=false;}
try{seglist.insertItemBefore(seg,0);support.pathInsertItemBefore=true;}catch(err){support.pathInsertItemBefore=false;}
var rect=document.createElementNS(svgns,'rect');rect.setAttribute('x',.1);var crect=rect.cloneNode(false);support.goodDecimals=(crect.getAttribute('x').indexOf(',')==-1);}());}
var Utils={"_keyStr":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=","encode64":function(input){input=Utils.convertToXMLReferences(input);if(window.btoa)return window.btoa(input);var output=new Array(Math.floor((input.length+2)/3)*4);var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0,p=0;do{chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=((chr1&3)<<4)|(chr2>>4);enc3=((chr2&15)<<2)|(chr3>>6);enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64;}else if(isNaN(chr3)){enc4=64;}
output[p++]=this._keyStr.charAt(enc1);output[p++]=this._keyStr.charAt(enc2);output[p++]=this._keyStr.charAt(enc3);output[p++]=this._keyStr.charAt(enc4);}while(i<input.length);return output.join('');},"decode64":function(input){if(window.atob)return window.atob(input);var output="";var chr1,chr2,chr3="";var enc1,enc2,enc3,enc4="";var i=0;input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{enc1=this._keyStr.indexOf(input.charAt(i++));enc2=this._keyStr.indexOf(input.charAt(i++));enc3=this._keyStr.indexOf(input.charAt(i++));enc4=this._keyStr.indexOf(input.charAt(i++));chr1=(enc1<<2)|(enc2>>4);chr2=((enc2&15)<<4)|(enc3>>2);chr3=((enc3&3)<<6)|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2);}
if(enc4!=64){output=output+String.fromCharCode(chr3);}
chr1=chr2=chr3="";enc1=enc2=enc3=enc4="";}while(i<input.length);return unescape(output);},"encodeUTF8":function(input){var output='';for(var n=0;n<input.length;n++){var c=input.charCodeAt(n);if(c<128){output+=input[n];}
else if(c>127){if(c<2048){output+=String.fromCharCode((c>>6)|192);}
else{output+=String.fromCharCode((c>>12)|224)+String.fromCharCode((c>>6)&63|128);}
output+=String.fromCharCode((c&63)|128);}}
return output;},"convertToXMLReferences":function(input){var output='';for(var n=0;n<input.length;n++){var c=input.charCodeAt(n);if(c<128){output+=input[n];}
else if(c>127){output+=("&#"+c+";");}}
return output;},"rectsIntersect":function(r1,r2){return r2.x<(r1.x+r1.width)&&(r2.x+r2.width)>r1.x&&r2.y<(r1.y+r1.height)&&(r2.y+r2.height)>r1.y;},"text2xml":function(sXML){var out;try{var dXML=($.browser.msie)?new ActiveXObject("Microsoft.XMLDOM"):new DOMParser();dXML.async=false;}catch(e){throw new Error("XML Parser could not be instantiated");};try{if($.browser.msie)out=(dXML.loadXML(sXML))?dXML:false;else out=dXML.parseFromString(sXML,"text/xml");}
catch(e){throw new Error("Error parsing XML string");};return out;}};;function SVGDRAW(node){this.node=node;this.content=node.getContent().getContentJSON();this.svgCanvas=null;this.teacherAnnotation="";this.defaultImage="";this.stamps=[];this.snapshotsActive=false;this.snapshots=[];this.snapsAllowed=10;this.descriptionActive=false;this.description="";this.defaultDescription="";this.instructions="";this.active=-1;this.index=null;this.warningStackSize=0;this.selected=false;this.warning=false;this.snapTotal=0;this.playback="pause";this.lz77=new LZ77();this.studentData={"svgString":"","description":"","snapshots":[],"snapTotal":0,"selected":null};this.init(node.getContent().getContentUrl());}
function Snapshot(svg,id,context){this.svg=svg;this.id=id;this.description=context.defaultDescription;}
SVGDRAW.prototype.init=function(jsonURL){this.svgCanvas=svg_edit_setup();put_locale(this.svgCanvas);this.loadModules(jsonURL,this);};SVGDRAW.prototype.loadModules=function(jsonfilename,context){$.getJSON(jsonfilename,function(data){if(data.stamps){for(var item in data.stamps){context.stamps.push(data.stamps[item]);};}
if(data.snapshots_active){context.snapshotsActive=data.snapshots_active;}
if(data.description_active){context.descriptionActive=data.description_active;}
if(data.description_default){context.defaultDescription=data.description_default;}
if(data.prompt){context.instructions=data.prompt;}
if(data.svg_background){context.defaultImage=data.svg_background;}
var myDataService=new VleDS(vle);context.setDataService(myDataService);context.load();});};SVGDRAW.prototype.setDataService=function(dataService){this.dataService=dataService;};SVGDRAW.prototype.loadCallback=function(studentWorkJSON,context){var annotationValue;var svgString;if(studentWorkJSON){try{svgString=studentWorkJSON.svgString;}catch(err){svgString=studentWorkJSON;}
if(svgString.match(/^--lz77--/)){svgString=svgString.replace(/^--lz77--/,"");svgString=context.lz77.decompress(svgString);}
context.svgCanvas.setSvgString(svgString);if(context.dataService.vle.getConfig().getConfigParam('mode')=='run'){if(context.dataService.vle.annotations!=null){var annotation=context.dataService.vle.annotations.getLatestAnnotationForNodeId(context.dataService.vle.getCurrentNode().id);if(annotation!=null){var annotationValue=annotation.value;this.teacherAnnotation=annotationValue;context.svgCanvas.setSvgString(svgString.replace("</svg>",this.teacherAnnotation+"</svg>"));context.svgCanvas.setCurrentLayer('Layer 1');}}
var processGetDrawAnnotationResponse=function(responseText,responseXML){var annotation=annotations.getLatestAnnotationForNodeId(context.dataService.vle.getCurrentNode().id);vle.annotations;var annotationValue=annotation.value;context.svgCanvas.setSvgString(svgString.replace("</svg>",annotationValue+"</svg>"));context.svgCanvas.setCurrentLayer('Layer 1');};var getAnnotationsParams={runId:context.dataService.vle.getConfig().getConfigParam('runId'),toWorkgroup:context.dataService.vle.getUserAndClassInfo().getWorkgroupId(),fromWorkgroup:context.dataService.vle.getUserAndClassInfo().getTeacherWorkgroupId(),periodId:context.dataService.vle.getUserAndClassInfo().getPeriodId()};}}else if(context.defaultImage){var svgString=context.defaultImage.replace("</svg>","<g><title>student</title></g></svg>");context.svgCanvas.setSvgString(svgString);}
context.initDisplay(studentWorkJSON,context);};SVGDRAW.prototype.saveToVLE=function(){this.studentData.svgString="--lz77--"+this.lz77.compress(this.svgCanvas.getSvgString());this.studentData.description=this.description;this.studentData.snapshots=this.snapshots;this.studentData.snapTotal=this.snapTotal;if(this.selected==true){this.studentData.selected=this.active;}else{this.studentData.selected=-1;}
var data=this.studentData;this.dataService.save(data);};SVGDRAW.prototype.load=function(){this.dataService.load(this,this.loadCallback);};SVGDRAW.prototype.initDisplay=function(data,context){if(data.snapTotal){context.snapTotal=data.snapTotal;}
if(context.instructions&&context.instructions!=""){$('#prompt_text').html(context.instructions);$('#prompt_dialog').dialog({bgiframe:true,resizable:false,modal:true,autoOpen:false,width:400,buttons:{'OK':function(){$(this).dialog('close');}}});$('#tool_prompt').click(function(){$('#prompt_dialog').dialog('open');});$('#tool_prompt').attr("style","display:inline");if(!vle.getLatestStateForCurrentNode()){$('#prompt_dialog').dialog('open');}}
if(context.snapshotsActive==true){$('#tool_snapshot').attr("style","display:inline");if(data.snapshots&&data.snapshots.length>0){for(var i=0;i<data.snapshots.length;i++){context.snapshots.push(data.snapshots[i]);var current=context.snapshots[i].svg;if(current.match(/^--lz77--/)){current=current.replace(/^--lz77--/,"");current=context.lz77.decompress(current);}
context.addSnapshot(current,i,context);};if(data.selected>-1){context.active=data.selected;context.selected=true;for(var i=0;i<data.snapshots.length;i++){if(data.snapshots[i].id==context.active){context.index=i;context.snapCheck(context);var page=Math.floor(context.index/3);$("#snap_images").attr({scrollTop:page*375});}}}else{context.warning=true;}}
if(context.descriptionActive=='false'){$('#snap_description_wrapper').hide();}
$('#new_snap_dialog').dialog({bgiframe:true,resizable:false,modal:true,autoOpen:false,buttons:{'Yes':function(){context.newSnapshot(context);$(this).dialog('close');},Cancel:function(){$(this).dialog('close');}}});$('.snapshot_new').click(function(){context.checkSnapshots(context);});$('#snapwarning_dialog').dialog({bgiframe:true,resizable:false,modal:true,autoOpen:false,width:490,buttons:{'Continue':function(){context.openSnapshot(context.index,true,context);$(this).dialog('close');},Cancel:function(){$(this).dialog('close');}}});$('#snapnumber_dialog').dialog({bgiframe:true,resizable:false,modal:true,autoOpen:false,width:420,buttons:{'OK':function(){$(this).dialog('close');}}});$('#deletesnap_dialog').dialog({bgiframe:true,resizable:false,modal:true,autoOpen:false,width:350,buttons:{'Yes':function(){if($(".snap:eq("+context.index+")").hasClass("hover")){context.warning=true;$('#snap_description_wrapper').hide();}
context.snapshots.splice(context.index,1);$(".snap:eq("+context.index+")").fadeOut(1000,function(){$(this).remove()});$(this).dialog('close');setTimeout(function(){context.snapCheck(context);context.updateNumbers();if(context.snapshots.length<2){$('#playback').hide();}},1100);},Cancel:function(){$(this).dialog('close');context.snapCheck(context);$(".snap:eq("+context.index+")").click(function(){context.snapClick(this,context);},300);}}});$('#play_speed').slider({max:10,min:1,step:1,value:1,slide:function(event,ui){context.changeSpeed(ui.value,context);}});context.changeSpeed($('#play_speed').slider('value'),context);$('img.snap_controls').click(function(){var mode=$(this).attr('id');var speed=1000/$('#play_speed').slider('value');context.snapPlayback(mode,speed,context);});context.warningStackSize=0;$("#tools_top,#tools_left,#svgcanvas,#close_snapshots,#tools_bottom").mouseup(function(){setTimeout(function(){context.snapCheck(context);},50);});}
if(context.descriptionActive==true){if(context.snapshotsActive==true){if(data.selected>-1){for(var i=0;i<data.snapshots.length;i++){if(data.snapshots[i].id==data.selected){context.description=data.snapshots[i].description;}}}else{$('#snap_description_wrapper').hide();$('#draw_description_wrapper').hide();}
$('#snap_description_content').keyup(function(){$('#snap_description_commit').removeAttr("disabled");});$('#snap_description_commit').click(function(){var value=$('#snap_description_content').val();$('#draw_description_content').html(value);for(var i=0;i<context.snapshots.length;i++){if(context.snapshots[i].id==context.active){context.snapshots[i].description=value;$(this).attr("disabled","disabled");}}});$('#edit_description').click(function(){$('#tool_snapshot').click();$('#snap_description_content').focus();});$('#draw_description_header').text('Snapshot Description:');$('#draw_description_content').css('width',440);$('#snap_description_commit').attr("disabled","disabled");}else{$('#snap_description_wrapper').hide();if(data.description&&data.description!=""){context.description=data.description;$('#draw_description_content').html(data.description);$('#show_description').click();$('#draw_description_content').ellipsis();}else if(context.defaultDescription!=""){context.description=context.defaultDescription;$('#draw_description_content').html(context.defaultDescription);}
$('#tool_description, #edit_description').click(function(){if(!$('#descriptionpanel').is(':visible')){$('#description_commit').attr("disabled","disabled");$('#description_close').attr("disabled","disabled");$('#description_content').val(context.description);var height=$('#descriptionpanel').height();var width=$('#descriptionpanel').width();$('#descriptionpanel').css({top:$(window).height()/2-height/2,left:$(window).width()/2-width/2});$("#overlay").show();$('#descriptionpanel').show();}});$('#edit_description').click(function(){$('#description_content').focus();});$('#description_commit').click(function(){var value=$('#description_content').val();context.description=value;$('#draw_description_content').html(value);$('#show_description').click();$('#draw_description_content').ellipsis();$(this).attr("disabled","disabled");});$('#description_close').click(function(){var value=$('#description_content').val();context.description=value;$('#draw_description_content').html(value);$('#show_description').click();$('#draw_description_content').ellipsis();$('#descriptionpanel').hide();$("#overlay").hide();});$('#description_content').keyup(function(){$('#description_commit').removeAttr("disabled");$('#description_close').removeAttr("disabled");});$('#close_description').click(function(){$('#descriptionpanel').hide();$("#overlay").hide();});$('#tool_description').attr("style","display:inline");}}else if(context.descriptionActive==false){$('#snap_description_wrapper').hide();$('#draw_description_wrapper').hide();}
if(context.stamps.length>0){this.svgCanvas.setStampImages(context.stamps);var stamptxt="";for(var i=0;i<context.stamps.length;i++){var num=i*1+1;stamptxt+="<img id='"+i+"' class='tool_image' title='"+context.stamps[i].title+"' src="+context.stamps[i].uri+" alt='Stamp "+num+"' />";}
$('#stamp_images').append(stamptxt);this.svgCanvas.setStamp(0);context.setStampPreview(0,context);$("#stamp_images > #0").addClass("tool_image_current");$('.tool_image').click(function(){var index=$(this).attr('id');context.svgCanvas.setStamp(index);$('.tool_image').each(function(i){if($(this).attr("id")==index){$(this).addClass("tool_image_current");}else{$(this).removeClass("tool_image_current");};});context.setStampPreview(index,context);$('#tools_stamps').fadeOut("slow");});}else{$('#tool_image').hide();}
$('#drawlimit_dialog').dialog({bgiframe:true,resizable:false,modal:true,autoOpen:false,width:420,buttons:{'OK':function(){$(this).dialog('close');}}});$("#svgcanvas").mouseup(function(){setTimeout(function(){var mode=context.svgCanvas.getMode();if(mode!="select"&&mode!="multiselect"&&mode!="zoom"&&mode!="path"){context.checkDrawSize(context);}},60);});this.svgCanvas.resetUndo();$("#tool_undo").addClass("tool_button_disabled");};SVGDRAW.prototype.checkDrawSize=function(context){var current=context.svgCanvas.getSvgString();var compressed=context.lz77.compress(current);if(compressed.length*2>20480){$('#drawlimit_dialog').dialog('open');$('#tool_undo').click();}};SVGDRAW.prototype.checkSnapshots=function(context){if(context.snapshots.length>=context.snapsAllowed){$('#snapnumber_dialog').dialog('open');return;}
$('#new_snap_dialog').dialog('open');};SVGDRAW.prototype.newSnapshot=function(context){var current=context.svgCanvas.getSvgString();var compressed="--lz77--"+context.lz77.compress(current);var id=context.snapTotal;var newSnap=new Snapshot(compressed,context.snapTotal,context);context.snapshots.push(newSnap);context.snapTotal=id*1+1;var num=context.snapshots.length-1;context.warningStackSize=context.svgCanvas.getUndoStackSize();context.active=id;context.index=num;context.selected=true;context.warning=false;context.addSnapshot(current,num,context);context.description=context.descriptionDefault;setTimeout(function(){context.snapCheck(context);},100);$('#snap_description_commit').attr("disabled","disabled");};SVGDRAW.prototype.addSnapshot=function(svgString,num,context){context.warningStackSize=context.svgCanvas.getUndoStackSize();var res=context.svgCanvas.getResolution();var multiplier=150/res.w;var snapHeight=res.h*multiplier;var snapWidth=150;var snapNum=num*1+1;var snapHolder='<div class="snap" title="Click to Open; Click and Drag to Reorder">'+'<div class="snap_wrapper"></div>'+'<div class="snap_delete" title="Delete Snapshot"><span>X</span></div>'+'<div class="snap_num"><span>'+snapNum+'</span></div>'+'</div>';$("#snap_images").append(snapHolder);var snapshot=svgString.replace('<svg width="600" height="450"','<svg width="'+snapWidth+'" height="'+snapHeight+'"');snapshot=snapshot.replace(/<g>/gi,'<g transform="scale('+multiplier+')">');var snapSvgXml=text2xml(snapshot);var $snap=$("div.snap:eq("+num+")");context.bindSnapshot($snap,context);document.getElementsByClassName("snap_wrapper")[num].appendChild(document.importNode(snapSvgXml.documentElement,true));$("#snap_images").attr({scrollTop:$("#snap_images").attr("scrollHeight")});$(".snap:eq("+num+")").effect("pulsate",{times:1},800);if(context.snapshots.length>1){$('#playback').show();}};SVGDRAW.prototype.openSnapshot=function(index,pulsate,context){$('#svgcanvas').stop(true,true);$('#snap_description_content').blur();var snap=context.snapshots[index].svg;if(context.snapshots[index].svg.match(/^--lz77--/)){snap=context.snapshots[index].svg.replace(/^--lz77--/,"");snap=context.lz77.decompress(snap);}else{snap=context.snapshots[index].svg;context.snapshots[index].svg="--lz77--"+context.lz77.compress(context.snapshots[index].svg);}
context.svgCanvas.setSvgString(snap);if($('#sidepanels').is(':visible')){context.svgCanvas.setZoom(.75);}
context.svgCanvas.resetUndo();context.warningStackSize=0;$("#tool_undo").addClass("tool_button_disabled");if(pulsate==true){$('#svgcanvas').effect("pulsate",{times:'1'},700);}
context.selected=true;context.index=index;context.active=context.snapshots[index].id;if(context.descriptionActive==true){context.description=context.snapshots[index].description;$('#snap_description_content').val(context.description);if(context.playback=='pause'){$('#snap_description_wrapper').show();$('#draw_description_wrapper').show();}}
context.updateClass(context.index,context);context.warning=false;$('#snap_description_commit').attr("disabled","disabled");};SVGDRAW.prototype.bindSnapshot=function(item,context){$(item).click(function(){context.snapClick(this,context);});$(item).hover(function(){if(!$(this).hasClass("active")){$(this).addClass('hover');$(this).children('.snap_delete').css("opacity",".75");$(this).children('.snap_num').css("opacity",".75");}},function(){if(!$(this).hasClass("active")){$(this).children('.snap_delete').css("opacity",".5");$(this).children('.snap_num').css("opacity",".5");$(this).removeClass('hover');}});$(item).children(".snap_delete").click(function(){context.deleteClick(this,context);});$("#snap_images").sortable({start:function(event,ui){context.index=$(".snap").index(ui.item);ui.item.unbind("click");$("#svgcanvas").stopTime('play');},stop:function(event,ui){setTimeout(function(){ui.item.click(function(){context.snapClick(this,context);});},300);},update:function(event,ui){var newIndex=$(".snap").index(ui.item);var current=context.snapshots.splice(context.index,1);context.snapshots.splice(newIndex,0,current[0]);setTimeout(function(){context.updateNumbers();},400);},opacity:.6,placeholder:'placeholder'});};SVGDRAW.prototype.deleteClick=function(item,context){$(item).parent().unbind("click");var index=$(".snap_delete").index(item);context.index=index;$("#deletesnap_dialog").dialog('open');};SVGDRAW.prototype.snapClick=function(item,context){context.index=$("div.snap").index(item);if(context.warningStackSize==context.svgCanvas.getUndoStackSize()&&context.warning==false){context.openSnapshot(context.index,true,context);}else{$('#snapwarning_dialog').dialog("open");}};SVGDRAW.prototype.updateClass=function(num,context){$(".snap").each(function(index){if(index!=num){$(this).removeClass("hover active");$(this).children(".snap_delete").css("opacity",".5");$(this).children(".snap_num").css("opacity",".5");}else{$(this).addClass("hover active");$(this).children(".snap_delete").css("opacity","1");$(this).children(".snap_num").css("opacity","1");}});};SVGDRAW.prototype.snapCheck=function(context){if(context.playback=="pause"){if(context.warningStackSize==context.svgCanvas.getUndoStackSize()){for(var i=0;i<context.snapshots.length;i++){if(context.snapshots[i].id==context.active){context.index=i;if(context.descriptionActive==true){$('#snap_description_content').val(context.snapshots[i].description);$('#draw_description_content').html(context.snapshots[i].description);$('#snap_description_wrapper').show();$('#draw_description_wrapper').show();if(!$('#sidepanels').is(':visible')){$('#show_description').click();}}
break;}
else{context.index=-1;}}
context.selected=true;context.updateClass(context.index,context);}else{context.selected=false;if(context.descriptionActive==true){if(!$('#sidepanels').is(':visible')){$('#hide_description').click();}
$('#snap_description_wrapper').hide();$('#draw_description_wrapper').hide();}
context.updateClass(-1,context);}}};SVGDRAW.prototype.snapPlayback=function(mode,speed,context){var index=0;if(context.selected==true){for(var i=0;i<context.snapshots.length;i++){if(context.snapshots[i].id==context.active){index=i*1+1;}}
if(index>context.snapshots.length-1){index=0;}}
if(mode=='play'||mode=='loop'){if(mode=='play'){context.playback='play';}else{context.playback='loop';}
$('.snap').unbind('click');$('.snap_delete').unbind('click');$('#snap_images').sortable('disable');$('#play').hide();$('#loop').hide();if(context.descriptionActive==true){$('#snap_description_wrapper').hide();$('#draw_description_wrapper').hide();}
$('#pause').attr("style","display:inline !important");$("#svgcanvas").everyTime(speed,'play',function(){context.openSnapshot(index,false,context);var page=Math.floor(index/3);$("#snap_images").attr({scrollTop:page*375});index=index+1;if(index>context.snapshots.length-1){if(mode=="loop"){index=0;}else{context.snapPlayback("pause",speed,context);}}},0);}else if(mode=="pause"){$("#svgcanvas").stopTime('play');context.playback='pause';context.snapCheck(context);$('#pause').attr("style","display:none !important");$('#play').attr("style","display:inline");$('#loop').attr("style","display:inline");setTimeout(function(){$('.snap').click(function(){context.snapClick(this,context);});$('.snap_delete').click(function(){context.deleteClick(this,context);});$('#snap_images').sortable('enable');},300);}};SVGDRAW.prototype.changeSpeed=function(value,context){var speed=1000/value;if(value==1){var label=value+" snap/sec";}else{var label=value+" snaps/sec";}
$('#current_speed').text(label);if(context.playback!='pause'){$("#svgcanvas").stopTime('play');if(context.playback=='play'){context.snapPlayback('play',speed,context);}else if(context.playback=='loop'){context.snapPlayback('loop',speed,context);}}};SVGDRAW.prototype.updateNumbers=function(){$(".snap_num > span").each(function(index){var num=""+(index*1+1);$(this).text(num);});};SVGDRAW.prototype.setStampPreview=function(index,context){var height=context.stamps[index].height;var width=context.stamps[index].width;$('#stamp_preview').attr('src',context.stamps[index].uri);$('#svgcanvas').mousemove(function(e){if(context.svgCanvas.getMode()=='image'){if($('#sidepanels').is(':visible')){$('#stamp_preview').height(height*.75).width(width*.75);$('#stamp_preview').css({'left':e.pageX-height*.75/2,'top':e.pageY-width*.75/2});}else{$('#stamp_preview').height(height).width(width);$('#stamp_preview').css({'left':e.pageX-height/2,'top':e.pageY-width/2});}
if(e.pageY<this.offsetTop||e.pageX<this.offsetLeft||e.pageX>$('#svgcanvas').width()+this.offsetLeft||e.pageY>$('#svgcanvas').height()+this.offsetTop){$('#stamp_preview').hide();}
else{$('#stamp_preview').show();}
$('#tools_top, #tools_left, #tools_bottom, #sidepanels').mouseenter(function(){$('#stamp_preview').hide();});}});};var text2xml=function(sXML){var out;try{var dXML=($.browser.msie)?new ActiveXObject("Microsoft.XMLDOM"):new DOMParser();dXML.async=false;}catch(e){throw new Error("XML Parser could not be instantiated");};try{if($.browser.msie)out=(dXML.loadXML(sXML))?dXML:false;else out=dXML.parseFromString(sXML,"text/xml");}
catch(e){throw new Error("Error parsing XML string");};return out;};(function(){VleDS=function(_vle){this.data="";this.annotations="";this.vle=_vle;this.vleNode=_vle.getCurrentNode();this.lz77=new LZ77();};VleDS.prototype={save:function(_data){this.vle.saveState(_data,this.vleNode);this.data=_data;},load:function(context,callback){var data=this.vle.getLatestStateForCurrentNode();if(typeof data=="string"){if(data.match(/^--lz77--/)){data=data.replace(/^--lz77--/,"");data=$.parseJSON(this.lz77.decompress(data));}}
this.data=data;callback(this.data,context);},loadAnnotations:function(context,callback){},toString:function(){return"VLE Data Service ("+this.vle+")";},};})();;var ns={svg:'http://www.w3.org/2000/svg',xlink:'http://www.w3.org/1999/xlink'};if(!window.console){window.console=new function(){this.log=function(str){};this.dir=function(str){};};}
$.cloneNode=function(el){if(!window.opera)return el.cloneNode(true);opera.postError(ns.svg,el.nodeName);var new_el=document.createElementNS(ns.svg,el.nodeName);$.each(el.attributes,function(i,attr){new_el.setAttributeNS(ns.svg,attr.nodeName,attr.nodeValue);});$.each(el.childNodes,function(i,child){if(child.nodeType==1){new_el.appendChild($.cloneNode(child));}});return new_el;}
$.jGraduate={Paint:function(opt){var options=opt||{};this.alpha=options.alpha||100;if(options.copy){this.type=options.copy.type;this.alpha=options.copy.alpha;switch(this.type){case"none":this.solidColor=null;this.linearGradient=null;break;case"solidColor":this.solidColor=options.copy.solidColor;this.linearGradient=null;break;case"linearGradient":this.solidColor=null;this.linearGradient=$.cloneNode(options.copy.linearGradient);break;}}
else if(options.linearGradient){this.type="linearGradient";this.solidColor=null;this.linearGradient=$.cloneNode(options.linearGradient);}
else if(options.solidColor){this.type="solidColor";this.solidColor=options.solidColor;}
else{this.type="none";this.solidColor=null;this.linearGradient=null;}}};jQuery.fn.jGraduateDefaults={paint:new $.jGraduate.Paint(),window:{pickerTitle:"Drag markers to pick a paint"},images:{clientPath:"images/"}};jQuery.fn.jGraduate=function(options){var $arguments=arguments;return this.each(function(){var $this=$(this),$settings=$.extend(true,{},jQuery.fn.jGraduateDefaults,options),id=$this.attr('id'),idref='#'+$this.attr('id')+' ';if(!idref)
{alert('Container element must have an id attribute to maintain unique id strings for sub-elements.');return;}
var okClicked=function(){$.isFunction($this.okCallback)&&$this.okCallback($this.paint);$this.hide();},cancelClicked=function(){$.isFunction($this.cancelCallback)&&$this.cancelCallback();$this.hide();};$.extend(true,$this,{paint:new $.jGraduate.Paint({copy:$settings.paint}),okCallback:$.isFunction($arguments[1])&&$arguments[1]||null,cancelCallback:$.isFunction($arguments[2])&&$arguments[2]||null});var pos=$this.position(),color=null;if($this.paint.type=="none"){$this.paint=$.jGraduate.Paint({solidColor:'ffffff'});}
$this.addClass('jGraduate_Picker');$this.html('<ul class="jGraduate_tabs">'+'<li class="jGraduate_tab_color jGraduate_tab_current">Solid Color</li>'+'<li class="jGraduate_tab_lingrad">Linear Gradient</li>'+'</ul>'+'<div class="jGraduate_colPick"></div>'+'<div class="jGraduate_lgPick"></div>');var colPicker=$(idref+'> .jGraduate_colPick');var lgPicker=$(idref+'> .jGraduate_lgPick');lgPicker.html('<div id="'+id+'_jGraduate_Swatch" class="jGraduate_Swatch">'+'<h2 class="jGraduate_Title">'+$settings.window.pickerTitle+'</h2>'+'<div id="'+id+'_jGraduate_GradContainer" class="jGraduate_GradContainer"></div>'+'<div id="'+id+'_jGraduate_Opacity" class="jGraduate_Opacity" title="Click to set overall opacity of the gradient paint">'+'<img id="'+id+'_jGraduate_AlphaArrows" class="jGraduate_AlphaArrows" src="'+$settings.images.clientPath+'rangearrows2.gif"></img>'+'</div>'+'</div>'+'<div class="jGraduate_Form">'+'<div class="jGraduate_StopSection">'+'<label class="jGraduate_Form_Heading">Begin Stop</label>'+'<div class="jGraduate_Form_Section">'+'<label>x:</label>'+'<input type="text" id="'+id+'_jGraduate_x1" size="3" title="Enter starting x value between 0.0 and 1.0"/>'+'<label> y:</label>'+'<input type="text" id="'+id+'_jGraduate_y1" size="3" title="Enter starting y value between 0.0 and 1.0"/>'+'<div id="'+id+'_jGraduate_colorBoxBegin" class="colorBox"></div>'+'<label id="'+id+'_jGraduate_beginOpacity"> 100%</label>'+'</div>'+'</div>'+'<div class="jGraduate_StopSection">'+'<label class="jGraduate_Form_Heading">End Stop</label>'+'<div class="jGraduate_Form_Section">'+'<label>x:</label>'+'<input type="text" id="'+id+'_jGraduate_x2" size="3" title="Enter ending x value between 0.0 and 1.0"/>'+'<label> y:</label>'+'<input type="text" id="'+id+'_jGraduate_y2" size="3" title="Enter ending y value between 0.0 and 1.0"/>'+'<div id="'+id+'_jGraduate_colorBoxEnd" class="colorBox"></div>'+'<label id="'+id+'_jGraduate_endOpacity">100%</label>'+'</div>'+'</div>'+'<div class="jGraduate_OpacityField">'+'<label class="jGraduate_OpacityLabel">A: </label>'+'<input type="text" id="'+id+'_jGraduate_OpacityInput" class="jGraduate_OpacityInput" size="3" value="100"/>%'+'</div>'+'</div>'+'<div class="jGraduate_OkCancel">'+'<input type="button" id="'+id+'_jGraduate_Ok" class="jGraduate_Ok" value="OK"/>'+'<input type="button" id="'+id+'_jGraduate_Cancel" class="jGraduate_Cancel" value="Cancel"/>'+'</div>'+'<div class="jGraduate_LightBox"></div>'+'<div id="'+id+'_jGraduate_stopPicker" class="jGraduate_stopPicker"></div>');var MAX=256,MARGINX=0,MARGINY=0,STOP_RADIUS=15/2,SIZEX=MAX-2*MARGINX,SIZEY=MAX-2*MARGINY;var container=document.getElementById(id+'_jGraduate_GradContainer');var svg=container.appendChild(document.createElementNS(ns.svg,'svg'));svg.id=id+'_jgraduate_svg';svg.setAttribute('width',MAX);svg.setAttribute('height',MAX);svg.setAttribute("xmlns",ns.svg);if($this.paint.type=="linearGradient"){$this.paint.linearGradient.id=id+'_jgraduate_grad';$this.paint.linearGradient=svg.appendChild($.cloneNode($this.paint.linearGradient));}
else{var grad=svg.appendChild(document.createElementNS(ns.svg,'linearGradient'));grad.id=id+'_jgraduate_grad';grad.setAttribute('x1','0.0');grad.setAttribute('y1','0.0');grad.setAttribute('x2','1.0');grad.setAttribute('y2','1.0');var begin=grad.appendChild(document.createElementNS(ns.svg,'stop'));begin.setAttribute('offset','0.0');begin.setAttribute('stop-color','#ff0000');var end=grad.appendChild(document.createElementNS(ns.svg,'stop'));end.setAttribute('offset','1.0');end.setAttribute('stop-color','#ffff00');$this.paint.linearGradient=grad;}
var gradalpha=$this.paint.alpha;$('#'+id+'_jGraduate_OpacityInput').val(gradalpha);var posx=parseInt(255*(gradalpha/100))-4.5;$('#'+id+'_jGraduate_AlphaArrows').css({'margin-left':posx});$('#'+id+'_jgraduate_rect').attr('fill-opacity',gradalpha/100);var x1=parseFloat($this.paint.linearGradient.getAttribute('x1')||0.0);var y1=parseFloat($this.paint.linearGradient.getAttribute('y1')||0.0);var x2=parseFloat($this.paint.linearGradient.getAttribute('x2')||1.0);var y2=parseFloat($this.paint.linearGradient.getAttribute('y2')||0.0);var rect=document.createElementNS(ns.svg,'rect');rect.id=id+'_jgraduate_rect';rect.setAttribute('x',MARGINX);rect.setAttribute('y',MARGINY);rect.setAttribute('width',SIZEY);rect.setAttribute('height',SIZEY);rect.setAttribute('fill','url(#'+id+'_jgraduate_grad)');rect.setAttribute('fill-opacity','1.0');rect=svg.appendChild(rect);var beginStop=document.createElementNS(ns.svg,'image');beginStop.id=id+"_stop1";beginStop.setAttribute('class','stop');beginStop.setAttributeNS(ns.xlink,'href',$settings.images.clientPath+'mappoint.gif');beginStop.setAttributeNS(ns.xlink,"title","Begin Stop");beginStop.appendChild(document.createElementNS(ns.svg,'title')).appendChild(document.createTextNode("Begin Stop"));beginStop.setAttribute('width',18);beginStop.setAttribute('height',18);beginStop.setAttribute('x',MARGINX+SIZEX*x1-STOP_RADIUS);beginStop.setAttribute('y',MARGINY+SIZEY*y1-STOP_RADIUS);beginStop.setAttribute('cursor','move');beginStop=svg.appendChild(beginStop);var endStop=document.createElementNS(ns.svg,'image');endStop.id=id+"_stop2";endStop.setAttribute('class','stop');endStop.setAttributeNS(ns.xlink,'href',$settings.images.clientPath+'mappoint.gif');endStop.setAttributeNS(ns.xlink,"title","End Stop");endStop.appendChild(document.createElementNS(ns.svg,'title')).appendChild(document.createTextNode("End Stop"));endStop.setAttribute('width',18);endStop.setAttribute('height',18);endStop.setAttribute('x',MARGINX+SIZEX*x2-STOP_RADIUS);endStop.setAttribute('y',MARGINY+SIZEY*y2-STOP_RADIUS);endStop.setAttribute('cursor','move');endStop=svg.appendChild(endStop);$('#'+id+'_jGraduate_Ok').bind('click',function(){$this.paint.type="linearGradient";$this.paint.solidColor=null;okClicked();});$('#'+id+'_jGraduate_Cancel').bind('click',function(paint){cancelClicked();});var x1=$this.paint.linearGradient.getAttribute('x1');if(!x1)x1="0.0";x1Input=$('#'+id+'_jGraduate_x1');x1Input.val(x1);x1Input.change(function(){if(isNaN(parseFloat(this.value))||this.value<0.0||this.value>1.0){this.value=0.0;}
$this.paint.linearGradient.setAttribute('x1',this.value);beginStop.setAttribute('x',MARGINX+SIZEX*this.value-STOP_RADIUS);});var y1=$this.paint.linearGradient.getAttribute('y1');if(!y1)y1="0.0";y1Input=$('#'+id+'_jGraduate_y1');y1Input.val(y1);y1Input.change(function(){if(isNaN(parseFloat(this.value))||this.value<0.0||this.value>1.0){this.value=0.0;}
$this.paint.linearGradient.setAttribute('y1',this.value);beginStop.setAttribute('y',MARGINY+SIZEY*this.value-STOP_RADIUS);});var x2=$this.paint.linearGradient.getAttribute('x2');if(!x2)x2="1.0";x2Input=$('#'+id+'_jGraduate_x2');x2Input.val(x2);x2Input.change(function(){if(isNaN(parseFloat(this.value))||this.value<0.0||this.value>1.0){this.value=1.0;}
$this.paint.linearGradient.setAttribute('x2',this.value);endStop.setAttribute('x',MARGINX+SIZEX*this.value-STOP_RADIUS);});var y2=$this.paint.linearGradient.getAttribute('y2');if(!y2)y2="0.0";y2Input=$('#'+id+'_jGraduate_y2');y2Input.val(y2);y2Input.change(function(){if(isNaN(parseFloat(this.value))||this.value<0.0||this.value>1.0){this.value=0.0;}
$this.paint.linearGradient.setAttribute('y2',this.value);endStop.setAttribute('y',MARGINY+SIZEY*this.value-STOP_RADIUS);});var stops=$this.paint.linearGradient.getElementsByTagNameNS(ns.svg,'stop');var numstops=stops.length;if(numstops<2){while(numstops<2){$this.paint.linearGradient.appendChild(document.createElementNS(ns.svg,'stop'));++numstops;}
stops=$this.paint.linearGradient.getElementsByTagNameNS(ns.svg,'stop');}
var setOpacitySlider=function(e,div){var offset=div.offset();var x=(e.pageX-offset.left-parseInt(div.css('border-left-width')));if(x>255)x=255;if(x<0)x=0;var posx=x-4.5;x/=255;$('#'+id+'_jGraduate_AlphaArrows').css({'margin-left':posx});$('#'+id+'_jgraduate_rect').attr('fill-opacity',x);x=parseInt(x*100);$('#'+id+'_jGraduate_OpacityInput').val(x);$this.paint.alpha=x;};var bSlidingOpacity=false;$('.jGraduate_Opacity').mousedown(function(evt){setOpacitySlider(evt,$(this));bSlidingOpacity=true;evt.preventDefault();});$('.jGraduate_Opacity').mousemove(function(evt){if(bSlidingOpacity){setOpacitySlider(evt,$(this));evt.preventDefault();}});$('.jGraduate_Opacity').mouseup(function(evt){setOpacitySlider(evt,$(this));bSlidingOpacity=false;evt.preventDefault();});var draggingStop=null;var startx=-1,starty=-1;$('.stop, #color_picker_jGraduate_GradContainer image').mousedown(function(evt){draggingStop=this;startx=evt.clientX;starty=evt.clientY;evt.preventDefault();});$('#'+id+'_jgraduate_svg').mousemove(function(evt){if(null!=draggingStop){var dx=evt.clientX-startx;var dy=evt.clientY-starty;startx+=dx;starty+=dy;var x=parseFloat(draggingStop.getAttribute('x'))+dx;var y=parseFloat(draggingStop.getAttribute('y'))+dy;if(x<MARGINX-STOP_RADIUS)x=MARGINX-STOP_RADIUS;if(y<MARGINY-STOP_RADIUS)y=MARGINY-STOP_RADIUS;if(x>MARGINX+SIZEX-STOP_RADIUS)x=MARGINX+SIZEX-STOP_RADIUS;if(y>MARGINY+SIZEY-STOP_RADIUS)y=MARGINY+SIZEY-STOP_RADIUS;draggingStop.setAttribute('x',x);draggingStop.setAttribute('y',y);var fracx=(x-MARGINX+STOP_RADIUS)/SIZEX;var fracy=(y-MARGINY+STOP_RADIUS)/SIZEY;if(draggingStop.id==(id+'_stop1')){x1Input.val(fracx);y1Input.val(fracy);$this.paint.linearGradient.setAttribute('x1',fracx);$this.paint.linearGradient.setAttribute('y1',fracy);}
else{x2Input.val(fracx);y2Input.val(fracy);$this.paint.linearGradient.setAttribute('x2',fracx);$this.paint.linearGradient.setAttribute('y2',fracy);}
evt.preventDefault();}});$('#'+id+'_jgraduate_svg').mouseup(function(evt){draggingStop=null;});var beginColor=stops[0].getAttribute('stop-color');if(!beginColor)beginColor='#000';beginColorBox=$('#'+id+'_jGraduate_colorBoxBegin');beginColorBox.css({'background-color':beginColor});var beginOpacity=stops[0].getAttribute('stop-opacity');if(!beginOpacity)beginOpacity='1.0';$('#'+id+'jGraduate_beginOpacity').html((beginOpacity*100)+'%');var endColor=stops[stops.length-1].getAttribute('stop-color');if(!endColor)endColor='#000';endColorBox=$('#'+id+'_jGraduate_colorBoxEnd');endColorBox.css({'background-color':endColor});var endOpacity=stops[stops.length-1].getAttribute('stop-opacity');if(!endOpacity)endOpacity='1.0';$('#'+id+'jGraduate_endOpacity').html((endOpacity*100)+'%');$('#'+id+'_jGraduate_colorBoxBegin').click(function(){$('div.jGraduate_LightBox').show();var colorbox=$(this);color=new $.jPicker.Color({hex:beginColor.substr(1),a:(parseFloat(beginOpacity)*100)});$('#'+id+'_jGraduate_stopPicker').css({'left':100,'bottom':15}).jPicker({window:{title:"Pick the start color and opacity for the gradient"},images:{clientPath:$settings.images.clientPath},color:{active:color,alphaSupport:true}},function(color){beginColor='#'+this.settings.color.active.hex;beginOpacity=this.settings.color.active.a/100;colorbox.css('background',beginColor);$('#'+id+'_jGraduate_beginOpacity').html(parseInt(beginOpacity*100)+'%');stops[0].setAttribute('stop-color',beginColor);stops[0].setAttribute('stop-opacity',beginOpacity);$('div.jGraduate_LightBox').hide();$('#'+id+'_jGraduate_stopPicker').hide();},null,function(){$('div.jGraduate_LightBox').hide();$('#'+id+'_jGraduate_stopPicker').hide();});});$('#'+id+'_jGraduate_colorBoxEnd').click(function(){$('div.jGraduate_LightBox').show();var colorbox=$(this);color=new $.jPicker.Color({hex:endColor.substr(1),a:(parseFloat(endOpacity)*100)});$('#'+id+'_jGraduate_stopPicker').css({'left':100,'top':15}).jPicker({window:{title:"Pick the end color and opacity for the gradient"},images:{clientPath:$settings.images.clientPath},color:{active:color,alphaSupport:true}},function(color){endColor='#'+this.settings.color.active.hex;endOpacity=this.settings.color.active.a/100;colorbox.css('background',endColor);$('#'+id+'_jGraduate_endOpacity').html(parseInt(endOpacity*100)+'%');stops[1].setAttribute('stop-color',endColor);stops[1].setAttribute('stop-opacity',endOpacity);$('div.jGraduate_LightBox').hide();$('#'+id+'_jGraduate_stopPicker').hide();},null,function(){$('div.jGraduate_LightBox').hide();$('#'+id+'_jGraduate_stopPicker').hide();});});colPicker.jPicker({window:{title:$settings.window.pickerTitle},images:{clientPath:$settings.images.clientPath},color:{active:new $.jPicker.Color({hex:$this.paint.solidColor,a:$this.paint.alpha}),alphaSupport:true}},function(color){$this.paint.type="solidColor";$this.paint.alpha=color.a;$this.paint.solidColor=color.hex;$this.paint.linearGradient=null;okClicked();},null,function(){cancelClicked();});$(idref+' .jGraduate_tab_color').click(function(){$(idref+' .jGraduate_tab_lingrad').removeClass('jGraduate_tab_current');$(idref+' .jGraduate_tab_color').addClass('jGraduate_tab_current');lgPicker.hide();colPicker.show();});$(idref+' .jGraduate_tab_lingrad').click(function(){$(idref+' .jGraduate_tab_color').removeClass('jGraduate_tab_current');$(idref+' .jGraduate_tab_lingrad').addClass('jGraduate_tab_current');colPicker.hide();lgPicker.show();});if($this.paint.type=="linearGradient"){lgPicker.show();colPicker.hide();$(idref+' .jGraduate_tab_color').removeClass('jGraduate_tab_current');$(idref+' .jGraduate_tab_lingrad').addClass('jGraduate_tab_current');}
else{colPicker.show();lgPicker.hide();$(idref+' .jGraduate_tab_color').addClass('jGraduate_tab_current');$(idref+' .jGraduate_tab_lingrad').removeClass('jGraduate_tab_current');}
$this.show();});};;(function(e,a){var d=function(n,k){var p=this,o=e("img",n),l=function(q){h(q);e(document).bind("mousemove",m).bind("mouseup",j);q.stopPropagation();q.preventDefault();return false;},m=function(q){h(q);q.stopPropagation();q.preventDefault();return false;},j=function(q){e(document).unbind("mouseup",j).unbind("mousemove",m);q.stopPropagation();q.preventDefault();return false;},h=function(u){var w=n.offset(),q=u.pageX-w.left-parseInt(n.css("border-left-width")),z=u.pageY-w.top-parseInt(n.css("border-top-width")),t=n.w,r=n.h,v,s;if(q<0){q=0;}else{if(q>t){q=t;}}if(z<0){z=0;}else{if(z>r){z=r;}}v=Math.floor(q/t*p.mxX);s=Math.floor(z/r*p.mxY);p.x=v;p.y=s;if(p.mxX==p.mnX){q=0;}if(p.mxY==p.mnY){z=0;}p.setArrowPosition(q,z);e.isFunction(p.valuesChanged)&&p.valuesChanged(p);};e.extend(true,p,{settings:k,x:0,y:0,mnX:0,mxX:0,mnY:100,mxY:100,valuesChanged:e.isFunction(arguments[2])&&arguments[2]||null,setPositioningVariables:function(r){var q=p.settings.map;n.w=q&&q.width||n.width();n.h=q&&q.height||n.height();p.MinX=0;p.MinY=0;p.MaxX=n.w;p.MaxY=n.h;},setArrowPositionFromValues:function(t){p.setPositioningVariables();var w=0,v=0,u=p.mnX,r=p.mxX,s=p.mnY,q=p.mxY,A=p.x,z=p.y;if(u!=r){if(A==u){w=0;}else{if(A==r){w=n.w;}else{if(u<1){r+=Math.abs(u)+1;}if(A<1){A+=1;}w=A/r*n.w;if(parseInt(w)==(r-1)){w=r;}else{w=parseInt(w);}if(u<1){w-=Math.abs(u)-1;}}}}if(s!=q){if(z==s){v=0;}else{if(z==q){v=n.h;}else{if(s<1){q+=Math.abs(s)+1;}if(z<1){z+=1;}v=z/q*n.h;if(parseInt(v)==(q-1)){v=q;}else{v=parseInt(v);}if(s<1){v-=Math.abs(s)-1;}}}}p.setArrowPosition(w,v);},setArrowPosition:function(q,v){var u=n.w,s=n.h,t=o.w,r=o.h;if(q<0){q=0;}else{if(q>u){q=u;}}if(v<0){v=0;}else{if(v>s){v=s;}}if(t>u){q=(u>>1)-(t>>1);}else{q-=t>>1;}if(r>s){v=(s>>1)-(r>>1);}else{v-=r>>1;}o.css({left:q+"px",top:v+"px"});},destroy:function(){e(document).unbind("mouseup",j).unbind("mousemove",m);n.unbind("mousedown",l);n=null;o=null;p.valuesChanged=null;}});o.src=p.settings.arrow&&p.settings.arrow.image;o.w=p.settings.arrow&&p.settings.arrow.width||o.width();o.h=p.settings.arrow&&p.settings.arrow.height||o.height();p.setPositioningVariables();n.bind("mousedown",l);p.setArrowPositionFromValues();e.isFunction(p.valuesChanged)&&p.valuesChanged(p);},b=function(n){var m=this,y=function(A){if(A.target.value==""){return;}t(A);m.setValuesFromHsv();e.isFunction(m.valuesChanged)&&m.valuesChanged(m);},s=function(A){if(A.target.value==""){return;}q(A);m.setValuesFromRgb();e.isFunction(m.valuesChanged)&&m.valuesChanged(m);},r=function(A){if(A.target.value==""){return;}l(A);w.a=A.target.value;e.isFunction(m.valuesChanged)&&m.valuesChanged(m);},v=function(A){if(A.target.value==""){m.setValuesFromRgb();}},k=function(A){if(A.target.value==""){m.setValuesFromHsv();}},o=function(A){if(A.target.value==""){u.alpha.val(100);}},z=function(A){if(A.target.value==""){return;}x(A);m.setValuesFromHex();e.isFunction(m.valuesChanged)&&m.valuesChanged(m);},j=function(A){if(A.target.value==""){m.setValuesFromHsv();}},q=function(A){if(!p(A)){return A;}u.red.val(h(u.red.val(),0,255));u.green.val(h(u.green.val(),0,255));u.blue.val(h(u.blue.val(),0,255));},l=function(A){if(!p(A)){return A;}u.alpha.val(h(u.alpha.val(),0,100));},t=function(A){if(!p(A)){return A;}u.hue.val(h(u.hue.val(),0,360));u.saturation.val(h(u.saturation.val(),0,100));u.value.val(h(u.value.val(),0,100));},x=function(A){if(!p(A)){return A;}u.hex.val(u.hex.val().replace(/[^a-fA-F0-9]/g,"0").toLowerCase().substring(0,6));},p=function(A){switch(A.keyCode){case 9:case 16:case 29:case 37:case 38:case 40:return false;case"c".charCodeAt():case"v".charCodeAt():if(A.ctrlKey){return false;}}return true;},h=function(C,B,A){if(C==""||isNaN(C)){return B;}C=parseInt(C);if(C>A){return A;}if(C<B){return B;}return C;};e.extend(true,m,{color:new f(),fields:{hue:e(".jPicker_HueText",n),saturation:e(".jPicker_SaturationText",n),value:e(".jPicker_BrightnessText",n),red:e(".jPicker_RedText",n),green:e(".jPicker_GreenText",n),blue:e(".jPicker_BlueText",n),hex:e(".jPicker_HexText",n),alpha:e(".jPicker_AlphaText",n)},valuesChanged:e.isFunction(arguments[1])&&arguments[1]||null,bindedHexKeyUp:function(A){z(A);},setValuesFromRgb:function(){w.fromRgb(u.red.val(),u.green.val(),u.blue.val());u.hex.val(w.hex);u.hue.val(w.h);u.saturation.val(w.s);u.value.val(w.v);},setValuesFromHsv:function(){w.fromHsv(u.hue.val(),u.saturation.val(),u.value.val());u.hex.val(w.hex);u.red.val(w.r);u.green.val(w.g);u.blue.val(w.b);},setValuesFromHex:function(){w.fromHex(u.hex.val());u.red.val(w.r);u.green.val(w.g);u.blue.val(w.b);u.hue.val(w.h);u.saturation.val(w.s);u.value.val(w.v);},setAlphaFromValue:function(){w.a=u.alpha.val();},destroy:function(){u.hue.add(u.saturation).add(u.value).unbind("keyup",events.hsvKeyUp).unbind("blur",v);u.red.add(u.green).add(u.blue).unbind("keyup",events.rgbKeyUp).unbind("blur",k);u.alpha.unbind("keyup",r).unbind("blur",o);u.hex.unbind("keyup",z);u=null;w=null;m.valuesChanged=null;}});var u=m.fields,w=m.color;u.hue.add(u.saturation).add(u.value).bind("keyup",y).bind("blur",v);u.red.add(u.green).add(u.blue).bind("keyup",s).bind("blur",k);u.alpha.bind("keyup",r).bind("blur",o);u.hex.bind("keyup",z).bind("blur",j);if(u.hex.val()!=""){w.fromHex(u.hex.val());m.setValuesFromHex();}};e.jPicker={List:[],Color:function(j){var h=this;e.extend(true,h,{r:0,g:0,b:0,h:0,s:0,v:0,a:100,hex:"",fromRgb:function(m,l,k){var o=this;o.r=m;o.g=l;o.b=k;var n=g.rgbToHsv(o);o.h=n.h;o.s=n.s;o.v=n.v;o.hex=g.rgbToHex(o);},fromHsv:function(m,l,k){var o=this;o.h=m;o.s=l;o.v=k;var n=g.hsvToRgb(o);o.r=n.r;o.g=n.g;o.b=n.b;o.hex=g.rgbToHex(n);},fromHex:function(k){var n=this;n.hex=k;var m=g.hexToRgb(k);n.r=m.r;n.g=m.g;n.b=m.b;var l=g.rgbToHsv(m);n.h=l.h;n.s=l.s;n.v=l.v;n.hex=g.rgbToHex(m);}});if(j){if(j.hex){h.fromHex(j.hex);}else{if(!isNaN(j.r)){h.fromRgb(j.r,j.g,j.b);}else{if(!isNaN(j.h)){h.fromHsv(j.h,j.s,j.v);}}}if(!isNaN(j.a)){h.a=j.a;}}},ColorMethods:{hexToRgb:function(l){l=this.validateHex(l);var k="00",j="00",h="00";if(l.length==6){k=l.substring(0,2);j=l.substring(2,4);h=l.substring(4,6);}else{if(l.length>4){k=l.substring(4,l.length);l=l.substring(0,4);}if(l.length>2){j=l.substring(2,l.length);l=l.substring(0,2);}if(l.length>0){h=l.substring(0,l.length);}}return{r:this.hexToInt(k),g:this.hexToInt(j),b:this.hexToInt(h)};},validateHex:function(h){h=h.toLowerCase().replace(/[^a-f0-9]/g,"0");if(h.length>6){h=h.substring(0,6);}return h;},rgbToHex:function(h){return this.intToHex(h.r)+this.intToHex(h.g)+this.intToHex(h.b);},intToHex:function(j){var h=parseInt(j).toString(16);if(h.length==1){h=("0"+h);}return h.toLowerCase();},hexToInt:function(h){return parseInt(h,16);},rgbToHsv:function(l){var o=l.r/255,n=l.g/255,j=l.b/255,k={h:0,s:0,v:0},m=0,h=0,p;if(o>=n&&o>=j){h=o;m=n>j?j:n;}else{if(n>=j&&n>=o){h=n;m=o>j?j:o;}else{h=j;m=n>o?o:n;}}k.v=h;k.s=h?(h-m)/h:0;if(!k.s){k.h=0;}else{p=h-m;if(o==h){k.h=(n-j)/p;}else{if(n==h){k.h=2+(j-o)/p;}else{k.h=4+(o-n)/p;}}k.h=parseInt(k.h*60);if(k.h<0){k.h+=360;}}k.s=parseInt(k.s*100);k.v=parseInt(k.v*100);return k;},hsvToRgb:function(n){var r={r:0,g:0,b:0},m=n.h,x=n.s,u=n.v;if(x==0){if(u==0){r.r=r.g=r.b=0;}else{r.r=r.g=r.b=parseInt(u*255/100);}}else{if(m==360){m=0;}m/=60;x=x/100;u=u/100;var l=parseInt(m),o=m-l,k=u*(1-x),j=u*(1-(x*o)),w=u*(1-(x*(1-o)));switch(l){case 0:r.r=u;r.g=w;r.b=k;break;case 1:r.r=j;r.g=u;r.b=k;break;case 2:r.r=k;r.g=u;r.b=w;break;case 3:r.r=k;r.g=j;r.b=u;break;case 4:r.r=w;r.g=k;r.b=u;break;case 5:r.r=u;r.g=k;r.b=j;break;}r.r=parseInt(r.r*255);r.g=parseInt(r.g*255);r.b=parseInt(r.b*255);}return r;}}};var f=e.jPicker.Color,c=e.jPicker.List,g=e.jPicker.ColorMethods;e.fn.jPicker=function(j){var h=arguments;return this.each(function(){var w=e(this),y=e.extend(true,{},e.fn.jPicker.defaults,j);if(w.get(0).nodeName.toLowerCase()=="input"){e.extend(true,y,{window:{bindToInput:true,expandable:true,input:w}});if(g.validateHex(w.val())){y.color.active=new f({hex:w.val(),a:y.color.active.a});y.color.current=new f({hex:w.val(),a:y.color.active.a});}}if(y.window.expandable){w.after('<span class="jPicker_Picker"><span class="jPicker_Color">&nbsp;</span><span class="jPicker_Icon" title="Click To Open Color Picker">&nbsp;</span><span class="jPicker_Container">&nbsp;</span></span>');}else{y.window.liveUpdate=false;}var W=parseFloat(navigator.appVersion.split("MSIE")[1])<7&&document.body.filters,ax=null,aw=null,av=null,U=null,T=null,S=null,R=null,Q=null,aC=null,V=null,au=null,J=null,I=null,X=null,ac=null,az=null,ak=null,am=null,ao=null,K=null,G=null,aa=null,L=null,ay=null,P=null,O=null,at=null,aq=null,A=null,l=null,M=null,ap=null,ad=null,ai=null,n=null,C=null,u=null,an=function(aE){N.active=ay.color;var aF=N.active,aG=p.clientPath,aD=function(aH){ae(aH,100);aH.css({backgroundColor:"",backgroundPosition:"0px 0px",filter:""});};aD(ax);aD(aw);aD(U);aD(T);aD(S);aD(R);ac.add(az).add(ak).add(am).add(ao).add(K).removeAttr("checked");switch(aE){case"h":ac.attr("checked",true);ax.css({backgroundColor:"#"+aF.hex});aw.css({backgroundColor:"transparent"});x(aw,-256);ae(aw,100);x(R,-256);G.mxX=100;G.mxY=100;aa.mxY=360;break;case"s":az.attr("checked",true);x(ax,-512);x(aw,-768);ae(aw,0);z(S,aF.hex);x(R,-512);G.mxX=360;G.mxY=100;aa.mxY=100;break;case"v":ak.attr("checked",true);z(ax,"000");x(aw,-1024);S.css({backgroundColor:"#"+aF.hex});x(R,-768);G.mxX=360;G.mxY=100;aa.mxY=100;break;case"r":am.attr("checked",true);x(aw,-1536);x(ax,-1280);x(R,-1024);x(S,-1280);x(T,-1536);x(U,-1792);break;case"g":ao.attr("checked",true);x(aw,-2048);x(ax,-1792);x(R,-2048);x(S,-2304);x(T,-2560);x(U,-2816);break;case"b":K.attr("checked",true);x(aw,-2560);x(ax,-2304);x(R,-3072);x(S,-3328);x(T,-3584);x(U,-3840);break;default:throw("Invalid Mode");break;}switch(aE){case"h":case"s":case"v":G.mnX=1;G.mnY=1;aa.mnY=1;break;case"r":case"g":case"b":G.mnX=0;G.mnY=0;aa.mnY=0;G.mxX=255;G.mxY=255;aa.mxY=255;break;}N.mode=aE;v();ar();ab();if(aj.expandable&&aj.liveUpdate){n.css({backgroundColor:"#"+aF.hex});if(aj.bindToInput){aj.input.val(aF.hex).css({backgroundColor:"#"+aF.hex,color:aF.v>75?"#000000":"#ffffff"});}}e.isFunction(w.liveCallback)&&w.liveCallback(aF);},m=function(){v();ah();N.active=ay.color;var aD=N.active;if(aj.expandable&&aj.liveUpdate){n.css({backgroundColor:"#"+aD.hex});if(aj.bindToInput){aj.input.val(ay.fields.hex.val()).css({backgroundColor:"#"+aD.hex,color:aD.v>75?"#000000":"#ffffff"});}}e.isFunction(w.liveCallback)&&w.liveCallback(aD);},B=function(){if(!ay||!G||!aa||!L){return;}N.active=ay.color;var aD=ay.fields,aE=N.active;switch(N.mode){case"h":aD.saturation.val(G.x);aD.value.val(100-G.y);break;case"s":aD.hue.val(G.x);aD.value.val(100-G.y);break;case"v":aD.hue.val(G.x);aD.saturation.val(100-G.y);break;case"r":aD.blue.val(G.x);aD.green.val(255-G.y);break;case"g":aD.blue.val(G.x);aD.red.val(255-G.y);break;case"b":aD.red.val(G.x);aD.green.val(255-G.y);break;}switch(N.mode){case"h":case"s":case"v":ay.setValuesFromHsv();break;case"r":case"g":case"b":ay.setValuesFromRgb();break;}ah();if(aj.expandable&&aj.liveUpdate){n.css({backgroundColor:"#"+aE.hex});if(aj.bindToInput){aj.input.val(aE.hex).css({backgroundColor:"#"+aE.hex,color:aE.v>75?"#000000":"#ffffff"});}}e.isFunction(w.liveCallback)&&w.liveCallback(aE);},al=function(){if(!ay||!G||!aa||!L){return;}N.active=ay.color;var aD=ay.fields,aE=N.active;switch(N.mode){case"h":aD.hue.val(360-aa.y);break;case"s":aD.saturation.val(100-aa.y);break;case"v":aD.value.val(100-aa.y);break;case"r":aD.red.val(255-aa.y);break;case"g":aD.green.val(255-aa.y);break;case"b":aD.blue.val(255-aa.y);break;}switch(N.mode){case"h":case"s":case"v":ay.setValuesFromHsv();break;case"r":case"g":case"b":ay.setValuesFromRgb();break;}ah();if(aj.expandable&&aj.liveUpdate){n.css({backgroundColor:"#"+aE.hex});if(aj.bindToInput){aj.input.val(aE.hex).css({backgroundColor:"#"+aE.hex,color:aE.v>75?"#000000":"#ffffff"});}}e.isFunction(w.liveCallback)&&w.liveCallback(aE);},s=function(){if(!ay||!G||!aa||!L){return;}N.active=ay.color;var aD=ay.fields,aE=N.active;aD.alpha.val(L.x);ay.setAlphaFromValue();ah();e.isFunction(w.liveCallback)&&w.liveCallback(N.active);},v=function(){N.active=ay.color;var aG=0,aF=N.active;switch(w.settings.color.mode){case"h":aG=360-aF.h;break;case"s":aG=100-aF.s;break;case"v":aG=100-aF.v;break;case"r":aG=255-aF.r;break;case"g":aG=255-aF.g;break;case"b":aG=255-aF.b;break;}aa.y=aG;L.x=aF.a;aa.setArrowPositionFromValues();L.setArrowPositionFromValues();var aE=0,aD=0;switch(w.settings.color.mode){case"h":aE=aF.s;aD=100-aF.v;break;case"s":aE=aF.h;aD=100-aF.v;break;case"v":aE=aF.h;aD=100-aF.s;break;case"r":aE=aF.b;aD=256-aF.g;break;case"g":aE=aF.b;aD=256-aF.r;break;case"b":aE=aF.r;aD=256-aF.g;break;}G.x=aE;G.y=aD;G.setArrowPositionFromValues();},ah=function(){aB();ar();ab();aA();},aB=function(){try{A.css({backgroundColor:"#"+ay.color.hex});ae(A,ay.color.a);}catch(aD){}},ar=function(){if(!N||!ay){return;}N.active=ay.color;var aD=N.active;switch(N.mode){case"h":z(ax,new f({h:aD.h,s:100,v:100}).hex);break;case"s":ae(aw,100-aD.s);break;case"v":ae(aw,aD.v);break;case"r":ae(aw,aD.r/256*100);break;case"g":ae(aw,aD.g/256*100);break;case"b":ae(aw,aD.b/256*100);break;}ae(av,100-aD.a);},ab=function(){if(!N||!ay){return;}N.active=ay.color;var aH=N.active,aK=N.mode,aM=ay.fields;switch(aK){case"h":break;case"s":var aI=new f({h:aH.h,s:100,v:aH.v});z(S,aI.hex);break;case"v":var aL=new f({h:aH.h,s:aH.s,v:100});z(S,aL.hex);break;case"r":case"g":case"b":var aJ=0,aN=0;if(aK=="r"){aJ=aM.blue.val();aN=aM.green.val();}else{if(aK=="g"){aJ=aM.blue.val();aN=aM.red.val();}else{if(aK=="b"){aJ=aM.red.val();aN=aM.green.val();}}}var aD=aJ/256*100,aG=aN/256*100,aF=(256-aJ)/256*100,aE=(256-aN)/256*100;ae(R,aG>aF?aF:aG);ae(S,aG>aD?aD:aG);ae(T,aE>aD?aD:aE);ae(U,aE>aF?aF:aE);break;}ae(Q,100-aH.a);},aA=function(){z(J,ay.color.hex);},z=function(aD,aF){try{aD.css({backgroundColor:"#"+aF});}catch(aE){}},t=function(aD,aE){if(aE.indexOf("png")&&this.isLessThanIE7){aD.attr("pngSrc",aE);aD.css({backgroundImage:"none",filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+aE+"')"});}else{aD.css({backgroundImage:"url("+aE+")"});}},x=function(aD,aE){aD.css({backgroundPosition:"0px "+aE+"px"});},ae=function(aE,aD){if(aD<100){if(this.isLessThanIE7){var aF=aE.attr("pngSrc");if(aF!=null&&aF.indexOf("map-hue")==-1){aE.css({filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+aF+"') progid:DXImageTransform.Microsoft.Alpha(opacity="+aD+")"});}}else{aE.css({opacity:aD/100});}}else{if(aD==100){if(this.isLessThanIE7){var aF=aE.attr("pngSrc");if(aF!=null&&aF.indexOf("map-hue")==-1){aE.css({filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+aF+"')"});}}else{aE.css({opacity:""});}}}},E=function(){ay.fields.hex.val(N.current.hex);ay.fields.alpha.val(N.current.a);ay.setValuesFromHex();ay.setAlphaFromValue();e.isFunction(ay.valuesChanged)&&ay.valuesChanged(ay);},D=function(aD){an(aD.target.value);},af=function(){E();},r=function(){E();aj.expandable&&w.hide();e.isFunction(w.cancelCallback)&&w.cancelCallback();},Z=function(){var aD=N.active;N.current=new f({hex:aD.hex});N.current.a=aD.a;l.css({backgroundColor:"#"+aD.hex});ae(l,ay.color.a);if(aj.expandable){n.css({backgroundColor:"#"+aD.hex});if(aj.bindToInput){aj.input.val(aD.hex).css({backgroundColor:"#"+aD.hex,color:aD.v>75?"#000000":"#ffffff"});}}e.isFunction(w.commitCallback)&&w.commitCallback(aD);},o=function(){Z();aj.expandable&&w.hide();},ag=function(){w.show();},Y=function(aF){var aD=aj.element,aE=aj.page;P=parseInt(X.css("left"));O=parseInt(X.css("top"));at=aF.pageX;aq=aF.pageY;e(document).bind("mousemove",k).bind("mouseup",q);aF.stopPropagation();aF.preventDefault();return false;},k=function(aD){X.css({left:P-(at-aD.pageX)+"px",top:O-(aq-aD.pageY)+"px"});aD.stopPropagation();aD.preventDefault();return false;},q=function(aD){e(document).unbind("mousemove",k).unbind("mouseup",q);aD.stopPropagation();aD.preventDefault();return false;},F=function(aD){ay.fields.hex.val(w.settings.window.input.val());ay.bindedHexKeyUp(aD);},H=function(aD){ay.fields.hex.val(N.quickList[aD.data.i].hex);ay.fields.alpha.val(N.quickList[aD.data.i].a);ay.setValuesFromHex();ay.setAlphaFromValue();e.isFunction(ay.valuesChanged)&&ay.valuesChanged(ay);};e.extend(true,w,{id:w.attr("id"),settings:y,color:null,icon:null,commitCallback:e.isFunction(h[1])&&h[1]||null,liveCallback:e.isFunction(h[2])&&h[2]||null,cancelCallback:e.isFunction(h[3])&&h[3]||null,show:function(){if(document.all){var aD=false;for(i=0;i<c.length;i++){if(aD){c[i].color.add(c[i].icon).css({display:"none"});}if(c[i].id==w.id){aD=true;}}}N.current=new f({hex:N.active.hex,a:N.active.a});l.css({backgroundColor:"#"+N.active.hex});ae(l,N.active.a);X.css({display:"block"});G.setPositioningVariables();aa.setPositioningVariables();v();},hide:function(){if(document.all){var aD=false;for(i=0;i<c.length;i++){if(aD){c[i].color.add(c[i].icon).css({display:"block"});}if(c[i].id==w.id){aD=true;}}}X.css({display:"none"});},destroy:function(){if(aj.expandable){C=e(".jPicker_Icon",X).unbind("click",ag);}if(aj.bindToInput){aj.input.unbind("keyup",F).unbind("change",F);}ac.add(az).add(ak).add(am).add(ao).add(K).unbind("click",D);l.unbind("click",af);ad.unbind("click",r);ap.unbind("click",o);if(aj.expandable){u.unbind("mousedown",Y);}e(".jPicker_QuickColor",X).unbind("click",H);ac=null;az=null;ak=null;am=null;ao=null;K=null;ax=null;aw=null;av=null;U=null;T=null;S=null;R=null;Q=null;aC=null;V=null;au=null;J=null;I=null;M=null;A=null;l=null;ap=null;ad=null;ai=null;w.color=null;w.icon=null;G.destroy();G=null;aa.destroy();aa=null;L.destroy();L=null;ay.destroy();ay=null;w.commitCallback=null;w.cancelCallback=null;w.liveCallback=null;X.html("");for(i=0;i<c.length;i++){if(c[i].id==w.id){c.splice(i,1);}}}});var p=w.settings.images,aj=w.settings.window,N=w.settings.color;X=aj.expandable?e(".jPicker_Container",w.next()):w;if(aj.expandable){X.css({left:aj.position.x=="left"?"-526px":aj.position.x=="center"?"-259px":aj.position.x=="right"?"0px":aj.position.x=="screenCenter"?((e(document).width()>>1)-259)-w.next().offset().left+"px":aj.position.x,position:"absolute",top:aj.position.y=="top"?"-340px":aj.position.y=="center"?"-153px":aj.position.y=="bottom"?"25px":aj.position.y});}if((typeof(N.active)).toString().toLowerCase()=="string"){N.active=new f({hex:N.active.substring(1)});}if(!N.alphaSupport){N.active.a=100;}X.html('<table class="jPicker_table"><tbody>'+(aj.expandable?'<tr><td class="jPicker_MoveBar" colspan="6">&nbsp;</td></tr>':"")+'<tr><td rowspan="8"><h2 class="jPicker_Title">'+(aj.title||"Drag Markers To Pick A Color")+'</h2><div class="jPicker_ColorMap"><span class="jPicker_ColorMap_l1">&nbsp;</span><span class="jPicker_ColorMap_l2">&nbsp;</span><span class="jPicker_ColorMap_l3">&nbsp;</span><img src="'+p.clientPath+p.colorMap.arrow.file+'" class="jPicker_ColorMap_Arrow"/></div></td><td rowspan="8"><div class="jPicker_ColorBar"><span class="jPicker_ColorBar_l1">&nbsp;</span><span class="jPicker_ColorBar_l2">&nbsp;</span><span class="jPicker_ColorBar_l3">&nbsp;</span><span class="jPicker_ColorBar_l4">&nbsp;</span><span class="jPicker_ColorBar_l5">&nbsp;</span><img src="'+p.clientPath+p.colorBar.arrow.file+'" class="jPicker_ColorBar_Arrow"/></div></td><td colspan="3" class="jPicker_Preview">new<div class="jPicker_NewCurrent"><span class="jPicker_Active" title="New Color - Press &ldquo;OK&rdquo; To Commit">&nbsp;</span><span class="jPicker_Current" title="Click To Revert To Original Color">&nbsp;</span></div>current</td><td rowspan="9" class="jPicker_OkCancel"><input type="button" class="jPicker_Ok" value="OK" title="Commit To This Color Selection"/><input type="button" class="jPicker_Cancel" value="Cancel" title="Cancel And Revert To Original Color"/><hr/><div class="jPicker_Grid">&nbsp;</div></td></tr><tr><td><input type="radio" class="jPicker_HueRadio" id="jPicker_Hue_'+c.length+'" name="jPicker_Mode_'+c.length+'" value="h" title="Set To &ldquo;Hue&rdquo; Color Mode"/></td><td><label for="jPicker_Hue_'+c.length+'" title="Set To &ldquo;Hue&rdquo; Color Mode">H:</label></td><td><input type="text" class="jPicker_HueText" value="'+N.active.h+'" title="Enter A &ldquo;Hue&rdquo; Value (0-360&deg;)"/> &deg;</td</tr><tr><td><input type="radio" class="jPicker_SaturationRadio" id="jPicker_Saturation_'+c.length+'" name="jPicker_Mode_'+c.length+'" value="s" title="Set To &ldquo;Saturation&rdquo; Color Mode"/></td><td><label for="jPicker_Saturation_'+c.length+'" title="Set To &ldquo;Saturation&rdquo; Color Mode">S:</label></td><td><input type="text" class="jPicker_SaturationText" value="'+N.active.s+'" title="Enter A &ldquo;Saturation&rdquo; Value (0-100%)"/> %</td></tr><tr><td><input type="radio" class="jPicker_BrightnessRadio" id="jPicker_Brightness_'+c.length+'" name="jPicker_Mode_'+c.length+'" value="v" title="Set To &ldquo;Brightness&rdquo; Color Mode"/></td><td><label for="jPicker_Brightness_'+c.length+'" title="Set To &ldquo;Brightness&rdquo; Color Mode">B:</label></td><td><input type="text" class="jPicker_BrightnessText" value="'+N.active.v+'" title="Enter A &ldquo;Brightness&rdquo; Value (0-100%)"/> %</td></tr><tr><td colspan="3" class="jPicker_Spacer">&nbsp;</td></tr><tr><td><input type="radio" class="jPicker_RedRadio" id="jPicker_Red_'+c.length+'" name="jPicker_Mode_'+c.length+'" value="r" title="Set To &ldquo;Red&rdquo; Color Mode"/></td><td><label for="jPicker_Red_'+c.length+'" title="Set To &ldquo;Red&rdquo; Color Mode">R:</label></td><td><input type="text" class="jPicker_RedText" value="'+N.active.r+'" title="Enter A &ldquo;Red&rdquo; Value (0-255)"/></td></tr><tr><td><input type="radio" class="jPicker_GreenRadio" id="jPicker_Green_'+c.length+'" name="jPicker_Mode_'+c.length+'" value="g" title="Set To &ldquo;Green&rdquo; Color Mode"/></td><td><label for="jPicker_Green_'+c.length+'" title="Set To &ldquo;Green&rdquo; Color Mode">G:</label></td><td><input type="text" class="jPicker_GreenText" value="'+N.active.g+'" title="Enter A &ldquo;Green&rdquo; Value (0-255)"/></td></tr><tr><td><input type="radio" class="jPicker_BlueRadio" id="jPicker_Blue_'+c.length+'" name="jPicker_Mode_'+c.length+'" value="b" title="Set To &ldquo;Blue&rdquo; Color Mode"/></td><td><label for="jPicker_Blue_'+c.length+'" title="Set To &ldquo;Blue&rdquo; Color Mode">B:</label></td><td><input type="text" class="jPicker_BlueText" value="'+N.active.b+'" title="Enter A &ldquo;Blue&rdquo; Value (0-255)"/></td></tr><tr><td><div class="jPicker_EnableAlpha"><input type="checkbox" class="jPicker_AlphaCheckbox" id="jPicker_AlphaCheckbox_'+c.length+'" title="Enable Alpha (Transparency) Support"/><label for="jPicker_AlphaCheckbox_'+c.length+'" title="Enabled Alpha (Transparency) Support">Enable Alpha (Transparency) Support</label></div><div class="jPicker_AlphaBar"><span class="jPicker_AlphaBar_l1">&nbsp;</span><span class="jPicker_AlphaBar_l2">&nbsp;</span><img src="'+p.clientPath+p.alphaBar.arrow.file+'" class="jPicker_AlphaBar_Arrow"/></div></td><td colspan="2" class="jPicker_OpacityCol"><label for="jPicker_Alpha_'+c.length+'" title="Enter An &ldquo;Alpha&rdquo; Value (0-100%)">A:</label><input type="text" class="jPicker_AlphaText" id="jPicker_Alpha_'+c.length+'" value="'+N.active.a+'" title="Enter An &ldquo;Alpha&rdquo; Value (0-100%)"/><span>%</span></td><td colspan="3" class="jPicker_HexCol"><label for="jPicker_Hex_'+c.length+'" title="Enter A &ldquo;Hex&rdquo; Color Value (#000000-#ffffff)">#:</label><input type="text" class="jPicker_HexText" id="jPicker_Hex_'+c.length+'" value="'+N.active.hex+'" title="Enter A &ldquo;Hex&rdquo; Color Value (#000000-#ffffff)"/></td><td colspan="2" class="jPicker_EnterHex"></td><td>&nbsp;</td></tr></tbody></table>');ac=e(".jPicker_HueRadio",X);az=e(".jPicker_SaturationRadio",X);ak=e(".jPicker_BrightnessRadio",X);am=e(".jPicker_RedRadio",X);ao=e(".jPicker_GreenRadio",X);K=e(".jPicker_BlueRadio",X);ax=e(".jPicker_ColorMap_l1",X);aw=e(".jPicker_ColorMap_l2",X);av=e(".jPicker_ColorMap_l3",X);U=e(".jPicker_ColorBar_l1",X);T=e(".jPicker_ColorBar_l2",X);S=e(".jPicker_ColorBar_l3",X);R=e(".jPicker_ColorBar_l4",X);Q=e(".jPicker_ColorBar_l5",X);J=e(".jPicker_AlphaBar_l1",X);I=e(".jPicker_AlphaBar_l2",X);aC=e(".jPicker_EnableAlpha",X);V=e(".jPicker_AlphaCheckbox",X);au=e(".jPicker_AlphaBar",X);M=e(".jPicker_NewCurrent",X);A=e(".jPicker_Active",X).css({backgroundColor:"#"+N.active.hex});l=e(".jPicker_Current",X).css({backgroundColor:"#"+N.active.hex});ap=e(".jPicker_Ok",X);ad=e(".jPicker_Cancel",X);ai=e(".jPicker_Grid",X);w.color=e(".Picker_Color");w.icon=e(".jPicker_Icon");ay=new b(X,m);G=new d(e(".jPicker_ColorMap",X),{map:{width:p.colorMap.width,height:p.colorMap.height},arrow:{image:p.clientPath+p.colorMap.arrow.file,width:p.colorMap.arrow.width,height:p.colorMap.arrow.height}},B);aa=new d(e(".jPicker_ColorBar",X),{map:{width:p.colorBar.width,height:p.colorBar.height},arrow:{image:p.clientPath+p.colorBar.arrow.file,width:p.colorBar.arrow.width,height:p.colorBar.arrow.height}},al);L=new d(e(".jPicker_AlphaBar",X),{map:{width:p.alphaBar.width,height:p.alphaBar.height},arrow:{image:p.clientPath+p.alphaBar.arrow.file,width:p.alphaBar.arrow.width,height:p.alphaBar.arrow.height}},s);L.mnX=0;L.mxX=100;t(ax,p.clientPath+"Maps.png");t(aw,p.clientPath+"Maps.png");t(av,p.clientPath+"map-opacity.png");t(U,p.clientPath+"Bars.png");t(T,p.clientPath+"Bars.png");t(S,p.clientPath+"Bars.png");t(R,p.clientPath+"Bars.png");t(Q,p.clientPath+"bar-opacity.png");t(I,p.clientPath+"Maps.png");x(I,-2816);t(M,p.clientPath+"preview-opacity.png");M.css({backgroundPosition:"1px 1px"});if(N.alphaSupport){aC.hide();au.show();e("td.jPicker_OpacityCol *",X).show();}else{V.bind("click",function(){aC.hide();au.show();e("td.jPicker_OpacityCol *",X).show();});}if(aj.expandable){n=e(".jPicker_Color",w.next()).css({backgroundColor:"#"+N.active.hex});C=e(".jPicker_Icon",w.next()).css({backgroundImage:"url("+p.clientPath+p.picker.file+")"}).bind("click",ag);if(aj.bindToInput){aj.input.bind("keyup",F).bind("change",F);}}ac.add(az).add(ak).add(am).add(ao).add(K).bind("click",D);l.bind("click",af);ad.bind("click",r);ap.bind("click",o);if(aj.expandable){u=e(".jPicker_MoveBar",X).bind("mousedown",Y);}if(N.quickList&&N.quickList.length>0){ai.html("");for(i=0;i<N.quickList.length;i++){if((typeof(N.quickList[i])).toString().toLowerCase()=="string"){N.quickList[i]=new f({hex:N.quickList[i].substring(1)});}ai.append('<span class="jPicker_QuickColor" title="#'+N.quickList[i].hex+'">&nbsp;</span>');e(".jPicker_QuickColor",X).eq(i).css({backgroundColor:"#"+N.quickList[i].hex}).bind("click",{i:i},H);}}an(N.mode);ay.fields.hex.val(aa.hex);ay.setValuesFromHex();ay.setAlphaFromValue();v();ah();if(!aj.expandable){w.show();}c.push(w);});};e.fn.jPicker.defaults={window:{title:null,position:{x:"screenCenter",y:"top"},expandable:false,liveUpdate:true},color:{mode:"h",active:new f({hex:"ffc000"}),alphaSupport:false,quickList:[new f({h:360,s:33,v:100}),new f({h:360,s:66,v:100}),new f({h:360,s:100,v:100}),new f({h:360,s:100,v:75}),new f({h:360,s:100,v:50}),new f({h:180,s:0,v:100}),new f({h:30,s:33,v:100}),new f({h:30,s:66,v:100}),new f({h:30,s:100,v:100}),new f({h:30,s:100,v:75}),new f({h:30,s:100,v:50}),new f({h:180,s:0,v:90}),new f({h:60,s:33,v:100}),new f({h:60,s:66,v:100}),new f({h:60,s:100,v:100}),new f({h:60,s:100,v:75}),new f({h:60,s:100,v:50}),new f({h:180,s:0,v:80}),new f({h:90,s:33,v:100}),new f({h:90,s:66,v:100}),new f({h:90,s:100,v:100}),new f({h:90,s:100,v:75}),new f({h:90,s:100,v:50}),new f({h:180,s:0,v:70}),new f({h:120,s:33,v:100}),new f({h:120,s:66,v:100}),new f({h:120,s:100,v:100}),new f({h:120,s:100,v:75}),new f({h:120,s:100,v:50}),new f({h:180,s:0,v:60}),new f({h:150,s:33,v:100}),new f({h:150,s:66,v:100}),new f({h:150,s:100,v:100}),new f({h:150,s:100,v:75}),new f({h:150,s:100,v:50}),new f({h:180,s:0,v:50}),new f({h:180,s:33,v:100}),new f({h:180,s:66,v:100}),new f({h:180,s:100,v:100}),new f({h:180,s:100,v:75}),new f({h:180,s:100,v:50}),new f({h:180,s:0,v:40}),new f({h:210,s:33,v:100}),new f({h:210,s:66,v:100}),new f({h:210,s:100,v:100}),new f({h:210,s:100,v:75}),new f({h:210,s:100,v:50}),new f({h:180,s:0,v:30}),new f({h:240,s:33,v:100}),new f({h:240,s:66,v:100}),new f({h:240,s:100,v:100}),new f({h:240,s:100,v:75}),new f({h:240,s:100,v:50}),new f({h:180,s:0,v:20}),new f({h:270,s:33,v:100}),new f({h:270,s:66,v:100}),new f({h:270,s:100,v:100}),new f({h:270,s:100,v:75}),new f({h:270,s:100,v:50}),new f({h:180,s:0,v:10}),new f({h:300,s:33,v:100}),new f({h:300,s:66,v:100}),new f({h:300,s:100,v:100}),new f({h:300,s:100,v:75}),new f({h:300,s:100,v:50}),new f({h:180,s:0,v:0}),new f({h:330,s:33,v:100}),new f({h:330,s:66,v:100}),new f({h:330,s:100,v:100}),new f({h:330,s:100,v:75}),new f({h:330,s:100,v:50})]},images:{clientPath:"/jPicker/images/",colorMap:{width:256,height:256,arrow:{file:"mappoint.gif",width:15,height:15}},colorBar:{width:20,height:256,arrow:{file:"rangearrows.gif",width:40,height:9}},alphaBar:{width:256,height:20,arrow:{file:"rangearrows2.gif",width:9,height:40}},picker:{file:"picker.gif",width:25,height:24}}};})(jQuery,"1.0.9");;(function(jQuery){jQuery.fn.__bind__=jQuery.fn.bind;jQuery.fn.__unbind__=jQuery.fn.unbind;jQuery.fn.__find__=jQuery.fn.find;var hotkeys={version:'0.7.9',override:/keypress|keydown|keyup/g,triggersMap:{},specialKeys:{27:'esc',9:'tab',32:'space',13:'return',8:'backspace',145:'scroll',20:'capslock',144:'numlock',19:'pause',45:'insert',36:'home',46:'del',35:'end',33:'pageup',34:'pagedown',37:'left',38:'up',39:'right',40:'down',109:'-',112:'f1',113:'f2',114:'f3',115:'f4',116:'f5',117:'f6',118:'f7',119:'f8',120:'f9',121:'f10',122:'f11',123:'f12',191:'/'},shiftNums:{"`":"~","1":"!","2":"@","3":"#","4":"$","5":"%","6":"^","7":"&","8":"*","9":"(","0":")","-":"_","=":"+",";":":","'":"\"",",":"<",".":">","/":"?","\\":"|"},newTrigger:function(type,combi,callback){var result={};result[type]={};result[type][combi]={cb:callback,disableInInput:false};return result;}};hotkeys.specialKeys=jQuery.extend(hotkeys.specialKeys,{96:'0',97:'1',98:'2',99:'3',100:'4',101:'5',102:'6',103:'7',104:'8',105:'9',106:'*',107:'+',109:'-',110:'.',111:'/'});jQuery.fn.find=function(selector){this.query=selector;return jQuery.fn.__find__.apply(this,arguments);};jQuery.fn.unbind=function(type,combi,fn){if(jQuery.isFunction(combi)){fn=combi;combi=null;}
if(combi&&typeof combi==='string'){var selectorId=((this.prevObject&&this.prevObject.query)||(this[0].id&&this[0].id)||this[0]).toString();var hkTypes=type.split(' ');for(var x=0;x<hkTypes.length;x++){delete hotkeys.triggersMap[selectorId][hkTypes[x]][combi];}}
return this.__unbind__(type,fn);};jQuery.fn.bind=function(type,data,fn){var handle=type.match(hotkeys.override);if(jQuery.isFunction(data)||!handle){return this.__bind__(type,data,fn);}
else{var result=null,pass2jq=jQuery.trim(type.replace(hotkeys.override,''));if(pass2jq){result=this.__bind__(pass2jq,data,fn);}
if(typeof data==="string"){data={'combi':data};}
if(data.combi){for(var x=0;x<handle.length;x++){var eventType=handle[x];var combi=data.combi.toLowerCase(),trigger=hotkeys.newTrigger(eventType,combi,fn),selectorId=((this.prevObject&&this.prevObject.query)||(this[0].id&&this[0].id)||this[0]).toString();trigger[eventType][combi].disableInInput=data.disableInInput;if(!hotkeys.triggersMap[selectorId]){hotkeys.triggersMap[selectorId]=trigger;}
else if(!hotkeys.triggersMap[selectorId][eventType]){hotkeys.triggersMap[selectorId][eventType]=trigger[eventType];}
var mapPoint=hotkeys.triggersMap[selectorId][eventType][combi];if(!mapPoint){hotkeys.triggersMap[selectorId][eventType][combi]=[trigger[eventType][combi]];}
else if(mapPoint.constructor!==Array){hotkeys.triggersMap[selectorId][eventType][combi]=[mapPoint];}
else{hotkeys.triggersMap[selectorId][eventType][combi][mapPoint.length]=trigger[eventType][combi];}
this.each(function(){var jqElem=jQuery(this);if(jqElem.attr('hkId')&&jqElem.attr('hkId')!==selectorId){selectorId=jqElem.attr('hkId')+";"+selectorId;}
jqElem.attr('hkId',selectorId);});result=this.__bind__(handle.join(' '),data,hotkeys.handler)}}
return result;}};hotkeys.findElement=function(elem){if(!jQuery(elem).attr('hkId')){if(jQuery.browser.opera||jQuery.browser.safari){while(!jQuery(elem).attr('hkId')&&elem.parentNode){elem=elem.parentNode;}}}
return elem;};hotkeys.handler=function(event){var target=hotkeys.findElement(event.currentTarget),jTarget=jQuery(target),ids=jTarget.attr('hkId');if(ids){ids=ids.split(';');var code=event.which,type=event.type,special=hotkeys.specialKeys[code],character=!special&&String.fromCharCode(code).toLowerCase(),shift=event.shiftKey,ctrl=event.ctrlKey,alt=event.altKey||event.originalEvent.altKey,mapPoint=null;for(var x=0;x<ids.length;x++){if(hotkeys.triggersMap[ids[x]][type]){mapPoint=hotkeys.triggersMap[ids[x]][type];break;}}
if(mapPoint){var trigger;if(!shift&&!ctrl&&!alt){trigger=mapPoint[special]||(character&&mapPoint[character]);}
else{var modif='';if(alt)modif+='alt+';if(ctrl)modif+='ctrl+';if(shift)modif+='shift+';trigger=mapPoint[modif+special];if(!trigger){if(character){trigger=mapPoint[modif+character]||mapPoint[modif+hotkeys.shiftNums[character]]||(modif==='shift+'&&mapPoint[hotkeys.shiftNums[character]]);}}}
if(trigger){var result=false;for(var x=0;x<trigger.length;x++){if(trigger[x].disableInInput){var elem=jQuery(event.target);if(jTarget.is("input")||jTarget.is("textarea")||jTarget.is("select")||elem.is("input")||elem.is("textarea")||elem.is("select")){return true;}}
result=result||trigger[x].cb.apply(this,[event]);}
return result;}}}};window.hotkeys=hotkeys;return jQuery;})(jQuery);;var put_locale=function(svgCanvas,given_param){var lang_param;var good_langs=['cs','de','en','es','fr','nl','ro','sk'];if(given_param){lang_param=given_param;}else{lang_param=$.pref('lang');if(!lang_param){if(navigator.userLanguage)
lang_param=navigator.userLanguage;else if(navigator.language)
lang_param=navigator.language;if(lang_param=="")
return;}
lang_param=String(lang_param);if($.inArray(lang_param,good_langs)==-1){lang_param="en";}
if(lang_param.indexOf("en")==0)return;}
var url="locale/lang."+lang_param+".js";$.get(url,function(data){var LangData=eval(data),js_strings;$.each(LangData,function(i,data){if(data.id){var elem=$('#'+data.id)[0];if(elem){if(data.title)
elem.title=data.title;if(data.textContent){$.each(elem.childNodes,function(j,node){if(node.nodeType==3){node.textContent=data.textContent;}});}}}else if(data.js_strings){js_strings=data.js_strings;}});svgCanvas.setLang(lang_param,js_strings);},"json");};;$.fn.SpinButton=function(cfg){return this.each(function(){this.repeating=false;this.spinCfg={min:cfg&&!isNaN(parseFloat(cfg.min))?Number(cfg.min):null,max:cfg&&!isNaN(parseFloat(cfg.max))?Number(cfg.max):null,step:cfg&&cfg.step?Number(cfg.step):1,stepfunc:cfg&&cfg.stepfunc?cfg.stepfunc:false,page:cfg&&cfg.page?Number(cfg.page):10,upClass:cfg&&cfg.upClass?cfg.upClass:'up',downClass:cfg&&cfg.downClass?cfg.downClass:'down',reset:cfg&&cfg.reset?cfg.reset:this.value,delay:cfg&&cfg.delay?Number(cfg.delay):500,interval:cfg&&cfg.interval?Number(cfg.interval):100,_btn_width:20,_direction:null,_delay:null,_repeat:null,callback:cfg&&cfg.callback?cfg.callback:null};this.adjustValue=function(i){var v;if(isNaN(this.value)){v=this.spinCfg.reset;}else if($.isFunction(this.spinCfg.stepfunc)){v=this.spinCfg.stepfunc(this,i);}else{v=Number(this.value)+Number(i);}
if(this.spinCfg.min!==null)v=Math.max(v,this.spinCfg.min);if(this.spinCfg.max!==null)v=Math.min(v,this.spinCfg.max);this.value=v;if($.isFunction(this.spinCfg.callback))this.spinCfg.callback(this);};$(this).addClass(cfg&&cfg.spinClass?cfg.spinClass:'spin-button').mousemove(function(e){var x=e.pageX||e.x;var y=e.pageY||e.y;var el=e.target||e.srcElement;var height=$(el).outerHeight()/2;var direction=(x>coord(el,'offsetLeft')+el.offsetWidth-this.spinCfg._btn_width)?((y<coord(el,'offsetTop')+height)?1:-1):0;if(direction!==this.spinCfg._direction){switch(direction){case 1:$(this).removeClass(this.spinCfg.downClass).addClass(this.spinCfg.upClass);break;case-1:$(this).removeClass(this.spinCfg.upClass).addClass(this.spinCfg.downClass);break;default:$(this).removeClass(this.spinCfg.upClass).removeClass(this.spinCfg.downClass);}
this.spinCfg._direction=direction;}}).mouseout(function(){$(this).removeClass(this.spinCfg.upClass).removeClass(this.spinCfg.downClass);this.spinCfg._direction=null;}).mousedown(function(e){if(this.spinCfg._direction!=0){var self=this;var adjust=function(){self.adjustValue(self.spinCfg._direction*self.spinCfg.step);};adjust();self.spinCfg._delay=window.setTimeout(function(){adjust();self.spinCfg._repeat=window.setInterval(adjust,self.spinCfg.interval);},self.spinCfg.delay);}}).mouseup(function(e){window.clearInterval(this.spinCfg._repeat);window.clearTimeout(this.spinCfg._delay);}).dblclick(function(e){if($.browser.msie)
this.adjustValue(this.spinCfg._direction*this.spinCfg.step);}).keydown(function(e){switch(e.keyCode){case 38:this.adjustValue(this.spinCfg.step);break;case 40:this.adjustValue(-this.spinCfg.step);break;case 33:this.adjustValue(this.spinCfg.page);break;case 34:this.adjustValue(-this.spinCfg.page);break;}}).keypress(function(e){if(this.repeating){switch(e.keyCode){case 38:this.adjustValue(this.spinCfg.step);break;case 40:this.adjustValue(-this.spinCfg.step);break;case 33:this.adjustValue(this.spinCfg.page);break;case 34:this.adjustValue(-this.spinCfg.page);break;}}
else{this.repeating=true;}}).keyup(function(e){this.repeating=false;switch(e.keyCode){case 38:case 40:case 33:case 34:case 13:this.adjustValue(0);break;}}).bind("mousewheel",function(e){if(e.wheelDelta>=120)
this.adjustValue(this.spinCfg.step);else if(e.wheelDelta<=-120)
this.adjustValue(-this.spinCfg.step);e.preventDefault();}).change(function(e){this.adjustValue(0);});if(this.addEventListener){this.addEventListener('DOMMouseScroll',function(e){if(e.detail>0)
this.adjustValue(-this.spinCfg.step);else if(e.detail<0)
this.adjustValue(this.spinCfg.step);e.preventDefault();},false);}});function coord(el,prop){var c=el[prop],b=document.body;while((el=el.offsetParent)&&(el!=b)){if(!$.browser.msie||(el.currentStyle.position!='relative'))
c+=el[prop];}
return c;}};;jQuery.fn.extend({everyTime:function(interval,label,fn,times){return this.each(function(){jQuery.timer.add(this,interval,label,fn,times);});},oneTime:function(interval,label,fn){return this.each(function(){jQuery.timer.add(this,interval,label,fn,1);});},stopTime:function(label,fn){return this.each(function(){jQuery.timer.remove(this,label,fn);});}});jQuery.extend({timer:{global:[],guid:1,dataKey:"jQuery.timer",regex:/^([0-9]+(?:\.[0-9]*)?)\s*(.*s)?$/,powers:{'ms':1,'cs':10,'ds':100,'s':1000,'das':10000,'hs':100000,'ks':1000000},timeParse:function(value){if(value==undefined||value==null)
return null;var result=this.regex.exec(jQuery.trim(value.toString()));if(result[2]){var num=parseFloat(result[1]);var mult=this.powers[result[2]]||1;return num*mult;}else{return value;}},add:function(element,interval,label,fn,times){var counter=0;if(jQuery.isFunction(label)){if(!times)
times=fn;fn=label;label=interval;}
interval=jQuery.timer.timeParse(interval);if(typeof interval!='number'||isNaN(interval)||interval<0)
return;if(typeof times!='number'||isNaN(times)||times<0)
times=0;times=times||0;var timers=jQuery.data(element,this.dataKey)||jQuery.data(element,this.dataKey,{});if(!timers[label])
timers[label]={};fn.timerID=fn.timerID||this.guid++;var handler=function(){if((++counter>times&&times!==0)||fn.call(element,counter)===false)
jQuery.timer.remove(element,label,fn);};handler.timerID=fn.timerID;if(!timers[label][fn.timerID])
timers[label][fn.timerID]=window.setInterval(handler,interval);this.global.push(element);},remove:function(element,label,fn){var timers=jQuery.data(element,this.dataKey),ret;if(timers){if(!label){for(label in timers)
this.remove(element,label,fn);}else if(timers[label]){if(fn){if(fn.timerID){window.clearInterval(timers[label][fn.timerID]);delete timers[label][fn.timerID];}}else{for(var fn in timers[label]){window.clearInterval(timers[label][fn]);delete timers[label][fn];}}
for(ret in timers[label])break;if(!ret){ret=null;delete timers[label];}}
for(ret in timers)break;if(!ret)
jQuery.removeData(element,this.dataKey);}}}});jQuery(window).bind("unload",function(){jQuery.each(jQuery.timer.global,function(index,item){jQuery.timer.remove(item);});});;(function($){$.fn.ellipsis=function(enableUpdating){var s=document.documentElement.style;if(!('textOverflow'in s||'OTextOverflow'in s)){return this.each(function(){var el=$(this);if(el.css("overflow")=="hidden"){var originalText=el.html();var w=el.width();var t=$(this.cloneNode(true)).hide().css({'position':'absolute','width':'auto','overflow':'visible','max-width':'inherit'});el.after(t);var text=originalText;while(text.length>0&&t.width()>el.width()){text=text.substr(0,text.length-1);t.html(text+"...");}
el.html(t.html());t.remove();if(enableUpdating==true){var oldW=el.width();setInterval(function(){if(el.width()!=oldW){oldW=el.width();el.html(originalText);el.ellipsis();}},200);}}});}else return this;};})(jQuery);

//used to notify scriptloader that this script has finished loading
if(typeof eventManager != 'undefined'){
	eventManager.fire('scriptLoaded', 'vle/node/draw/svg-edit-2.4rc1/all.js');
};